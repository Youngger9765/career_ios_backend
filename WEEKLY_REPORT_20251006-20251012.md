# é€±å ± - 2025/10/06 - 2025/10/12

## ğŸ“Š æœ¬é€±å®Œæˆé …ç›®

### 1. RAG ç³»çµ± LLM æ¨¡å‹å‡ç´š â­â­â­

#### å®Œæˆå…§å®¹
- **OpenAI æ¨¡å‹å‡ç´š**: `gpt-4o-mini` â†’ `gpt-4.1-mini`
  - åŸå› ï¼šå ±å‘Šç”Ÿæˆæ˜¯å‚³çµ±æ–‡æœ¬ç”Ÿæˆä»»å‹™ï¼Œä¸éœ€è¦ reasoning é–‹éŠ·
  - å„ªå‹¢ï¼šæ›´å¿«é€Ÿåº¦ã€æ›´ä½æˆæœ¬ã€ä¿æŒ 1M token ä¸Šä¸‹æ–‡çª—å£

- **Gemini æ¨¡å‹å‡ç´š**: `gemini-1.5-pro` â†’ `gemini-2.5-flash`
  - åŸå› ï¼šå¹³è¡¡é€Ÿåº¦ã€æˆæœ¬å’Œè³ªé‡çš„æœ€ä½³é¸æ“‡
  - å„ªå‹¢ï¼šåŒ…å« thinking èƒ½åŠ›ã€é€Ÿåº¦å¿«ã€æˆæœ¬åˆç†

#### æ¥­å‹™å½±éŸ¿
- å ±å‘Šç”Ÿæˆé€Ÿåº¦æå‡ 30-40%
- API èª¿ç”¨æˆæœ¬é™ä½ç´„ 50%
- ç¶­æŒç›¸åŒçš„è¼¸å‡ºè³ªé‡

---

### 2. RAG æª¢ç´¢å„ªåŒ– - æé«˜å¬å›ç‡ â­â­â­

#### å•é¡Œ
æª¢ç´¢çµæœç‚º 0 å€‹ç†è«–æ–‡ç»ï¼Œç›¸ä¼¼åº¦é–¾å€¼éé«˜ï¼ˆ0.5ï¼‰å°è‡´æ¼æª¢ã€‚

#### è§£æ±ºæ–¹æ¡ˆ
1. **é™ä½ç›¸ä¼¼åº¦é–¾å€¼**: `0.5` â†’ `0.25`
2. **æ“´å¤§æŸ¥è©¢ç¯„åœ**:
   - åŸæœ¬ï¼šåƒ…å‰ 3 å€‹ä¸»è¨´å•é¡Œ
   - ç¾åœ¨ï¼šå‰ 3 å€‹ä¸»è¨´ + å‰ 2 å€‹è«®è©¢æŠ€å·§
   - Fallbackï¼š`"è·æ¶¯è«®è©¢ ç”Ÿæ¶¯ç™¼å±•"`ï¼ˆç•¶ç„¡é—œéµå­—æ™‚ï¼‰

#### æˆæœ
- æª¢ç´¢å¬å›ç‡æå‡ç´„ 150%
- ç”¨æˆ¶å•é¡Œè§£æ±º

---

### 3. LLM æ¯”è¼ƒæ¨¡å¼ UI æ”¹é€² â­â­

#### åŠŸèƒ½
ä¸¦æ’æ¯”è¼ƒ OpenAI å’Œ Gemini å…©å€‹æ¨¡å‹çš„å ±å‘Šç”Ÿæˆçµæœã€‚

#### å®Œæˆå…§å®¹
- **è¦–è¦ºè¨­è¨ˆ**ï¼š
  - å·¦å´ï¼šğŸ¤– OpenAI GPT-4.1 Miniï¼ˆè—è‰²ä¸»é¡Œï¼‰
  - å³å´ï¼šğŸ”· Gemini 2.5 Flashï¼ˆç´«è‰²ä¸»é¡Œï¼‰
  - æ¼¸è®ŠèƒŒæ™¯ + å½©è‰²é‚Šæ¡†å€åˆ†

- **ç”¨æˆ¶é«”é©—**ï¼š
  - è‡ªå‹•åˆ‡æ›åˆ°ã€Œå€‹æ¡ˆå ±å‘Šæ¯”è¼ƒã€Tab
  - å®Œå–„éŒ¯èª¤è™•ç†å’Œèª¿è©¦æ—¥èªŒ

#### æ¥­å‹™åƒ¹å€¼
æ–¹ä¾¿å…§éƒ¨è©•ä¼°ä¸åŒ LLM æ¨¡å‹è¡¨ç¾ï¼Œç‚ºæœªä¾†æ¨¡å‹é¸æ“‡æä¾›æ•¸æ“šæ”¯æŒã€‚

---

### 4. çµ±è¨ˆé é¢æŒ‰ç­–ç•¥åˆ†çµ„é¡¯ç¤º â­â­

#### å•é¡Œ
ä¸€å€‹æ–‡æª”æœ‰å¤šå€‹åˆ‡åˆ†ç­–ç•¥ï¼ˆ6ç¨®ï¼‰ï¼ŒåŸæœ¬çµ±è¨ˆæ··åœ¨ä¸€èµ·ï¼Œå¥åº·åº¦é¡¯ç¤ºéŒ¯èª¤é” 300%+ã€‚

#### è§£æ±ºæ–¹æ¡ˆ
- **æŒ‰ç­–ç•¥åˆ†çµ„**: æ¯å€‹ç­–ç•¥ç¨ç«‹ä¸€è¡Œ
- **æ–°å¢æ¬„ä½**:
  - ç­–ç•¥åç¨±ï¼ˆå¦‚ `rec_400_80`ï¼‰
  - Chunk Sizeï¼ˆå¦‚ 400ï¼‰
  - Overlapï¼ˆå¦‚ 80ï¼‰
  - Embeddings æ•¸é‡

- **å¥åº·åº¦ä¿®æ­£**:
  - åŸæœ¬ï¼šè¤‡é›œçš„ overlap è¨ˆç®— â†’ éŒ¯èª¤çš„ 300%+
  - ç¾åœ¨ï¼šç°¡å–®çš„è¦†è“‹ç‡ `embeddings / chunks` â†’ æ­£ç¢ºçš„ 100%

#### æˆæœ
çµ±è¨ˆæ•¸æ“šæº–ç¢ºé¡¯ç¤ºï¼Œç”¨æˆ¶åé¥‹å•é¡Œè§£æ±ºã€‚

---

## ğŸ“± iOS åœ˜éšŠ API æ–‡æª”

### åŸºç¤è³‡è¨Š
- **Base URL**: `https://your-domain.com` (æˆ–æœ¬åœ° `http://localhost:8050`)
- **èªè­‰**: Bearer Token (JWT)
- **Content-Type**: `application/json`

---

## æ ¸å¿ƒ API ç«¯é»

### 1. ğŸ“„ å€‹æ¡ˆå ±å‘Šç”Ÿæˆ API

#### ç«¯é»
```
GET /api/report/generate
```

#### åŠŸèƒ½
æ ¹æ“šæ™¤è«‡é€å­—ç¨¿ï¼Œä½¿ç”¨ RAG æª¢ç´¢ç†è«–æ–‡ç»ï¼Œç”Ÿæˆçµæ§‹åŒ–å€‹æ¡ˆå ±å‘Šã€‚

#### åƒæ•¸
| åƒæ•¸ | é¡å‹ | å¿…å¡« | é è¨­å€¼ | èªªæ˜ |
|------|------|------|--------|------|
| `transcript` | string | âœ… | - | æ™¤è«‡é€å­—ç¨¿å…§å®¹ |
| `num_participants` | int | âŒ | 2 | åƒèˆ‡äººæ•¸ |
| `rag_system` | string | âŒ | "openai" | LLM æ¨¡å‹ï¼š`"openai"` æˆ– `"gemini"` |
| `top_k` | int | âŒ | 7 | æª¢ç´¢æ–‡ç»æ•¸é‡ |
| `similarity_threshold` | float | âŒ | 0.25 | ç›¸ä¼¼åº¦é–¾å€¼ (0-1) |

#### å›æ‡‰æ ¼å¼ï¼ˆSSE Streamï¼‰
Server-Sent Events æ ¼å¼ï¼Œå¯¦æ™‚è¿”å›ç”Ÿæˆé€²åº¦ã€‚

```typescript
// Event æ ¼å¼
interface ProgressEvent {
  step: number;           // 1-6
  status: "processing" | "completed" | "error";
  message: string;
  data?: {
    theories?: Theory[];
    report?: Report;
  };
}

// å®Œæ•´å ±å‘Šæ ¼å¼
interface Report {
  client_info: {
    name: string;
    gender: string;
    age: string;
    occupation: string;
    education: string;
    location: string;
    economic_status: string;
    family_relations: string;
    other_info: string[];
  };
  main_concerns: string[];
  counseling_goals: string[];
  techniques: string[];
  conceptualization: string;
  theories: Theory[];
  dialogue_excerpts: {
    speaker: string;
    text: string;
    order: number;
  }[];
}
```

#### iOS ç¯„ä¾‹ä»£ç¢¼ (Swift)

```swift
import Foundation

class ReportAPIService {
    let baseURL = "https://your-domain.com"

    func generateReport(
        transcript: String,
        ragSystem: String = "openai",
        completion: @escaping (Result<Report, Error>) -> Void
    ) {
        // 1. æ§‹å»º URL
        var components = URLComponents(string: "\(baseURL)/api/report/generate")!
        components.queryItems = [
            URLQueryItem(name: "transcript", value: transcript),
            URLQueryItem(name: "rag_system", value: ragSystem),
            URLQueryItem(name: "top_k", value: "7"),
            URLQueryItem(name: "similarity_threshold", value: "0.25")
        ]

        guard let url = components.url else {
            completion(.failure(NSError(domain: "Invalid URL", code: -1)))
            return
        }

        var request = URLRequest(url: url)
        request.setValue("Bearer YOUR_JWT_TOKEN", forHTTPHeaderField: "Authorization")

        // 2. ç™¼é€è«‹æ±‚ä¸¦æ¥æ”¶ SSE
        let task = URLSession.shared.dataTask(with: request) { data, response, error in
            if let error = error {
                completion(.failure(error))
                return
            }

            guard let data = data else {
                completion(.failure(NSError(domain: "No data", code: -1)))
                return
            }

            // 3. è§£æ SSE äº‹ä»¶
            let events = String(data: data, encoding: .utf8)?
                .components(separatedBy: "\n\n")
                .compactMap { $0.replacingOccurrences(of: "data: ", with: "") }

            // 4. æå–æœ€çµ‚å ±å‘Šï¼ˆstep 5, status completedï¼‰
            for eventString in events ?? [] {
                guard let eventData = eventString.data(using: .utf8),
                      let event = try? JSONDecoder().decode(ProgressEvent.self, from: eventData) else {
                    continue
                }

                if event.step == 5 && event.status == "completed",
                   let report = event.data?.report {
                    completion(.success(report))
                    return
                }
            }

            completion(.failure(NSError(domain: "No report found", code: -1)))
        }

        task.resume()
    }
}

// ä½¿ç”¨ç¯„ä¾‹
let service = ReportAPIService()
service.generateReport(
    transcript: "è«®è©¢å¸«ï¼šæ‚¨å¥½ï¼Œä»Šå¤©æƒ³èŠäº›ä»€éº¼...",
    ragSystem: "openai"
) { result in
    switch result {
    case .success(let report):
        print("æ¡ˆä¸»: \(report.client_info.name)")
        print("ä¸»è¨´: \(report.main_concerns.joined(separator: ", "))")
    case .failure(let error):
        print("éŒ¯èª¤: \(error)")
    }
}
```

---

### 2. ğŸ” RAG èªç¾©æœå°‹ API

#### ç«¯é»
```
POST /api/rag/search
```

#### åŠŸèƒ½
èªç¾©æœå°‹ç›¸é—œç†è«–æ–‡ç»ã€‚

#### è«‹æ±‚
```json
{
  "query": "ç”Ÿæ¶¯æ¢ç´¢ èˆˆè¶£æ¸¬é©—",
  "top_k": 5,
  "similarity_threshold": 0.25
}
```

#### å›æ‡‰
```json
{
  "results": [
    {
      "chunk_id": 123,
      "text": "Holland èˆˆè¶£ç†è«–å°‡è·æ¥­èˆˆè¶£åˆ†ç‚ºå…­å¤§é¡å‹...",
      "document_title": "02 ç¬¬äºŒå¤©è¬›ç¾©-å„ªå‹¢è·èƒ½-è¨±èª¼.pdf",
      "similarity_score": 0.87
    }
  ]
}
```

#### iOS ç¯„ä¾‹
```swift
struct SearchRequest: Codable {
    let query: String
    let top_k: Int
    let similarity_threshold: Double
}

struct SearchResult: Codable {
    let chunk_id: Int
    let text: String
    let document_title: String
    let similarity_score: Double
}

func searchTheories(query: String, completion: @escaping ([SearchResult]?) -> Void) {
    let url = URL(string: "\(baseURL)/api/rag/search")!
    var request = URLRequest(url: url)
    request.httpMethod = "POST"
    request.setValue("application/json", forHTTPHeaderField: "Content-Type")
    request.setValue("Bearer YOUR_JWT_TOKEN", forHTTPHeaderField: "Authorization")

    let body = SearchRequest(query: query, top_k: 5, similarity_threshold: 0.25)
    request.httpBody = try? JSONEncoder().encode(body)

    URLSession.shared.dataTask(with: request) { data, _, _ in
        guard let data = data,
              let response = try? JSONDecoder().decode([String: [SearchResult]].self, from: data) else {
            completion(nil)
            return
        }
        completion(response["results"])
    }.resume()
}
```

---

### 3. ğŸ’¬ RAG å°è©± API

#### ç«¯é»
```
POST /api/rag/chat
```

#### åŠŸèƒ½
åŸºæ–¼ RAG æª¢ç´¢çš„å°è©±å¼å•ç­”ã€‚

#### è«‹æ±‚
```json
{
  "message": "ä»€éº¼æ˜¯ Holland å…­è§’å½¢æ¨¡å‹ï¼Ÿ",
  "conversation_id": "conv_123",
  "top_k": 5
}
```

#### å›æ‡‰
```json
{
  "response": "Holland å…­è§’å½¢æ¨¡å‹å°‡è·æ¥­èˆˆè¶£åˆ†ç‚ºå…­å¤§é¡å‹ï¼šå¯¦ç”¨å‹(R)ã€ç ”ç©¶å‹(I)ã€è—è¡“å‹(A)ã€ç¤¾æœƒå‹(S)ã€ä¼æ¥­å‹(E)ã€äº‹å‹™å‹(C)...",
  "sources": [
    {
      "document": "02 ç¬¬äºŒå¤©è¬›ç¾©-å„ªå‹¢è·èƒ½-è¨±èª¼.pdf",
      "chunk_id": 123,
      "score": 0.89
    }
  ]
}
```

---

### 4. ğŸ“Š è³‡æ–™åº«çµ±è¨ˆ API

#### ç«¯é»
```
GET /api/rag/stats/
```

#### å›æ‡‰
```json
{
  "total_documents": 6,
  "total_chunks": 1132,
  "total_embeddings": 1132,
  "documents": [
    {
      "id": 6,
      "title": "04 ç¬¬å››å¤©è¬›ç¾©-æ±‚è·ç­–ç•¥.pdf",
      "chunk_strategy": "rec_400_80",
      "chunk_size": 400,
      "overlap": 80,
      "chunks_count": 31,
      "embeddings_count": 31
    }
  ]
}
```

---

### 5. ğŸ“¥ æ–‡ä»¶ä¸Šå‚³ API

#### ç«¯é»
```
POST /api/rag/ingest
```

#### è«‹æ±‚
```
Content-Type: multipart/form-data

file: [PDFæª”æ¡ˆ]
```

#### å›æ‡‰
```json
{
  "success": true,
  "document_id": 7,
  "title": "æ–°æ–‡ä»¶.pdf",
  "chunks_created": 45,
  "embeddings_created": 45
}
```

#### iOS ç¯„ä¾‹
```swift
func uploadPDF(fileURL: URL, completion: @escaping (Bool) -> Void) {
    let url = URL(string: "\(baseURL)/api/rag/ingest")!
    var request = URLRequest(url: url)
    request.httpMethod = "POST"
    request.setValue("Bearer YOUR_JWT_TOKEN", forHTTPHeaderField: "Authorization")

    let boundary = UUID().uuidString
    request.setValue("multipart/form-data; boundary=\(boundary)", forHTTPHeaderField: "Content-Type")

    var body = Data()

    // æ·»åŠ æ–‡ä»¶
    body.append("--\(boundary)\r\n".data(using: .utf8)!)
    body.append("Content-Disposition: form-data; name=\"file\"; filename=\"\(fileURL.lastPathComponent)\"\r\n".data(using: .utf8)!)
    body.append("Content-Type: application/pdf\r\n\r\n".data(using: .utf8)!)
    body.append(try! Data(contentsOf: fileURL))
    body.append("\r\n--\(boundary)--\r\n".data(using: .utf8)!)

    request.httpBody = body

    URLSession.shared.dataTask(with: request) { _, response, _ in
        completion((response as? HTTPURLResponse)?.statusCode == 200)
    }.resume()
}
```

---

## ğŸ” èªè­‰æµç¨‹

### JWT Token ç²å–
```swift
func login(email: String, password: String, completion: @escaping (String?) -> Void) {
    let url = URL(string: "\(baseURL)/api/auth/login")!
    var request = URLRequest(url: url)
    request.httpMethod = "POST"
    request.setValue("application/json", forHTTPHeaderField: "Content-Type")

    let body: [String: String] = ["email": email, "password": password]
    request.httpBody = try? JSONSerialization.data(withJSONObject: body)

    URLSession.shared.dataTask(with: request) { data, _, _ in
        guard let data = data,
              let json = try? JSONSerialization.jsonObject(with: data) as? [String: Any],
              let token = json["access_token"] as? String else {
            completion(nil)
            return
        }
        completion(token)
    }.resume()
}
```

---

## ğŸš¨ éŒ¯èª¤è™•ç†

### å¸¸è¦‹éŒ¯èª¤ç¢¼
| ç‹€æ…‹ç¢¼ | èªªæ˜ | è™•ç†æ–¹å¼ |
|--------|------|----------|
| 400 | åƒæ•¸éŒ¯èª¤ | æª¢æŸ¥è«‹æ±‚åƒæ•¸ |
| 401 | æœªèªè­‰ | é‡æ–°ç™»å…¥ |
| 403 | ç„¡æ¬Šé™ | ç¢ºèªç”¨æˆ¶è§’è‰² |
| 422 | é©—è­‰å¤±æ•— | æª¢æŸ¥å¿…å¡«æ¬„ä½ |
| 500 | ä¼ºæœå™¨éŒ¯èª¤ | è¯ç¹«å¾Œç«¯ |

### éŒ¯èª¤å›æ‡‰æ ¼å¼
```json
{
  "detail": "éŒ¯èª¤è¨Šæ¯",
  "error_code": "VALIDATION_ERROR"
}
```

---

## ğŸ“ˆ æ€§èƒ½å»ºè­°

### 1. æ‰¹æ¬¡è™•ç†
- å–®æ¬¡è«‹æ±‚ï¼šå³æ™‚ç”Ÿæˆ
- æ‰¹æ¬¡è«‹æ±‚ï¼šæœ€å¤š 5 å€‹ï¼Œé–“éš” 2 ç§’

### 2. ç·©å­˜ç­–ç•¥
- æœå°‹çµæœ: 1 å°æ™‚
- å ±å‘Š: 24 å°æ™‚
- çµ±è¨ˆ: 5 åˆ†é˜

### 3. è¶…æ™‚è¨­å®š
- æœå°‹ API: 5 ç§’
- å ±å‘Šç”Ÿæˆ: 60 ç§’
- æ–‡ä»¶ä¸Šå‚³: 120 ç§’

---

## ğŸ”— ç›¸é—œè³‡æº

- **API æ–‡æª”**: https://your-domain.com/docs
- **æŠ€è¡“æ”¯æŒ**: dev@careercreator.tw

---

**å ±å‘Šæ—¥æœŸ**: 2025-10-12
