{% extends "base.html" %}

{% block title %}個案管理 - 諮商前台{% endblock %}

{% block nav_title %}諮商前台{% endblock %}

{% block nav_items %}
<a href="/console/cases" class="border-indigo-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
    個案管理
</a>
<a href="/console/reports" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
    報告管理
</a>
<a href="/console/reminders" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
    提醒事項
</a>
{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900">個案管理</h2>
        <button onclick="createCase()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
            + 建立個案
        </button>
    </div>

    <!-- Cases List -->
    <div id="casesList" class="bg-white shadow overflow-hidden sm:rounded-md">
        <div class="p-6 text-center text-gray-500">載入中...</div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
async function loadCases() {
    try {
        const response = await fetch('/api/v1/cases');
        const data = await response.json();

        const casesList = document.getElementById('casesList');

        if (data && data.length > 0) {
            casesList.innerHTML = `
                <ul class="divide-y divide-gray-200">
                    ${data.map(c => `
                        <li class="p-4 hover:bg-gray-50 cursor-pointer" onclick="viewCase('${c.id}')">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <h3 class="text-lg font-medium text-gray-900">${c.visitor_name || '來訪者'}</h3>
                                    <p class="text-sm text-gray-500">諮商師: ${c.counselor_name || 'N/A'}</p>
                                    <div class="mt-2 flex items-center gap-4 text-sm">
                                        <span class="text-gray-600">會談次數: ${c.session_count || 0}</span>
                                        <span class="${c.status === 'active' ? 'text-green-600' : 'text-gray-600'}">
                                            狀態: ${c.status || 'active'}
                                        </span>
                                        <span class="text-gray-400">${new Date(c.created_at).toLocaleDateString('zh-TW')}</span>
                                    </div>
                                </div>
                                <div>
                                    <button onclick="event.stopPropagation(); viewSessions('${c.id}')" class="text-indigo-600 hover:text-indigo-900 text-sm mr-2">
                                        查看會談
                                    </button>
                                </div>
                            </div>
                        </li>
                    `).join('')}
                </ul>
            `;
        } else {
            casesList.innerHTML = '<div class="p-6 text-center text-gray-500">尚無個案</div>';
        }
    } catch (error) {
        document.getElementById('casesList').innerHTML = `<div class="p-6 text-center text-red-500">載入失敗: ${error.message}</div>`;
    }
}

function createCase() {
    window.location.href = '/console/cases/new';
}

function viewCase(caseId) {
    window.location.href = `/console/cases/${caseId}`;
}

function viewSessions(caseId) {
    window.location.href = `/console/sessions?case_id=${caseId}`;
}

// Load on page load
loadCases();
</script>
{% endblock %}
