<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å ±å‘Šç”Ÿæˆå°æ¯” - èˆŠç‰ˆ vs å¢å¼·ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f7;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            color: #1d1d1f;
        }

        .header p {
            color: #6e6e73;
            font-size: 16px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab:hover {
            background: #f5f5f7;
        }

        .tab.active {
            background: #0071e3;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .split-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f5f5f7;
        }

        .panel-title {
            font-size: 20px;
            font-weight: 600;
            color: #1d1d1f;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.old {
            background: #fff3cd;
            color: #856404;
        }

        .badge.new {
            background: #d1ecf1;
            color: #0c5460;
        }

        .report-preview {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            max-height: 600px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.8;
            white-space: pre-wrap;
            font-family: "SF Mono", Monaco, monospace;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .comparison-table th,
        .comparison-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid #f5f5f7;
        }

        .comparison-table th {
            background: #f5f5f7;
            font-weight: 600;
            color: #1d1d1f;
        }

        .comparison-table tr:last-child td {
            border-bottom: none;
        }

        .metric-old {
            color: #d1453b;
        }

        .metric-new {
            color: #28a745;
            font-weight: 600;
        }

        .improvement {
            color: #28a745;
            font-size: 12px;
        }

        .generate-btn {
            background: #0071e3;
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 20px;
        }

        .generate-btn:hover {
            background: #0077ed;
        }

        .generate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 150px;
        }

        .quality-score {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 16px 0;
        }

        .score-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
        }

        .score-excellent { background: #d1ecf1; color: #0c5460; }
        .score-good { background: #d4edda; color: #155724; }
        .score-pass { background: #fff3cd; color: #856404; }
        .score-fail { background: #f8d7da; color: #721c24; }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6e6e73;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0071e3;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .highlight {
            background: #fff9e6;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .missing {
            color: #d1453b;
            text-decoration: line-through;
        }

        .added {
            color: #28a745;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š å ±å‘Šç”Ÿæˆå°æ¯”æ¸¬è©¦</h1>
            <p>èˆŠç‰ˆï¼ˆStagingï¼‰vs å¢å¼·ç‰ˆï¼ˆFeatureï¼‰- ä¸€éµå°æ¯”å“è³ªå·®ç•°</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('input')">ğŸ“ è¼¸å…¥é€å­—ç¨¿</button>
            <button class="tab" onclick="switchTab('comparison')">ğŸ” å ±å‘Šå°æ¯”</button>
            <button class="tab" onclick="switchTab('metrics')">ğŸ“ˆ å“è³ªæŒ‡æ¨™</button>
        </div>

        <!-- Tab 1: è¼¸å…¥ -->
        <div id="tab-input" class="tab-content active">
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">æ¸¬è©¦é€å­—ç¨¿</span>
                </div>
                <textarea id="transcript" class="textarea" placeholder="è«‹è²¼ä¸Šé€å­—ç¨¿...">è«®è©¢å¸«ï¼šæ—©å®‰ï¼Œä»Šå¤©æƒ³èŠä»€éº¼ï¼Ÿ
å€‹æ¡ˆï¼šè€å¸«æ‚¨å¥½ï¼Œæˆ‘æ˜¯å°ç¾ï¼Œ28æ­²ï¼Œç¢©å£«ç•¢æ¥­ï¼Œç¾åœ¨åœ¨ç§‘æŠ€å…¬å¸ç•¶è»Ÿé«”å·¥ç¨‹å¸«ã€‚
æœ€è¿‘å·¥ä½œæ„Ÿåˆ°å¾ˆè¿·èŒ«ï¼Œä¸çŸ¥é“æœªä¾†è¦åšä»€éº¼ã€‚æ¯å¤©å¯«codeå¾ˆç„¡èŠï¼Œçœ‹ä¸åˆ°æ„ç¾©ã€‚

è«®è©¢å¸«ï¼šä»€éº¼æ™‚å€™é–‹å§‹æœ‰é€™ç¨®æ„Ÿè¦ºï¼Ÿ
å€‹æ¡ˆï¼šå¤§æ¦‚3å€‹æœˆå‰å‡é·å¤±æ•—ä¹‹å¾Œã€‚æˆ‘ç™¼ç¾è‡ªå·±å¥½åƒä¸é©åˆç•¶ä¸»ç®¡ï¼Œä½†ç¹¼çºŒç•¶å·¥ç¨‹å¸«åˆè¦ºå¾—æ²’å‰é€”ã€‚
æˆ‘çˆ¸åª½ä¸€ç›´å¸Œæœ›æˆ‘ç©©å®šï¼Œä½†æˆ‘è‡ªå·±ä¹Ÿä¸çŸ¥é“æƒ³è¦ä»€éº¼ã€‚

è«®è©¢å¸«ï¼šè½èµ·ä¾†ä½ åœ¨è·æ¶¯ç™¼å±•ä¸Šé‡åˆ°ç“¶é ¸ï¼Œä¹Ÿåœ¨æ€è€ƒè‡ªå·±çš„åƒ¹å€¼è§€ã€‚
å€‹æ¡ˆï¼šå°ï¼Œæˆ‘è¦ºå¾—æˆ‘ç¼ºä¹æ–¹å‘ï¼Œä¹Ÿä¸çŸ¥é“è‡ªå·±çš„å„ªå‹¢åœ¨å“ªã€‚æœ‰æ™‚å€™æœƒæ‡·ç–‘è‡ªå·±çš„èƒ½åŠ›ã€‚

è«®è©¢å¸«ï¼šä»Šå¤©çš„è«®è©¢ä½ å¸Œæœ›å¾—åˆ°ä»€éº¼ï¼Ÿ
å€‹æ¡ˆï¼šå¸Œæœ›èƒ½æ‰¾åˆ°è·æ¶¯æ–¹å‘ï¼ŒçŸ¥é“è‡ªå·±é©åˆåšä»€éº¼ï¼Œé‚„æœ‰æå‡å·¥ä½œå‹•æ©Ÿã€‚

è«®è©¢å¸«ï¼šå¥½çš„ï¼Œæˆ‘å€‘ä»Šå¤©å¯ä»¥å…ˆç”¨å¡ç‰‡æ’åºä¾†é‡æ¸…ä½ çš„åƒ¹å€¼è§€ï¼Œå†ç”¨ç”Ÿæ¶¯å¹»éŠæ¢ç´¢å¯èƒ½çš„æ–¹å‘ã€‚
å€‹æ¡ˆï¼šå¥½çš„ï¼Œè¬è¬è€å¸«ã€‚</textarea>

                <button class="generate-btn" onclick="generateReports()">ğŸš€ ç”Ÿæˆå ±å‘Šå°æ¯”</button>

                <div style="background: #f5f5f7; padding: 16px; border-radius: 8px; margin-top: 16px;">
                    <strong>èªªæ˜ï¼š</strong>
                    <ul style="margin-left: 20px; margin-top: 8px; line-height: 2;">
                        <li><span class="badge old">èˆŠç‰ˆ</span> ä½¿ç”¨ staging åˆ†æ”¯çš„é‚è¼¯ï¼ˆç°¡å–®æ‹¼æ¥ã€ç„¡çµæ§‹é©—è­‰ï¼‰</li>
                        <li><span class="badge new">å¢å¼·ç‰ˆ</span> ä½¿ç”¨ feature åˆ†æ”¯çš„é‚è¼¯ï¼ˆçµæ§‹åŒ–ã€ç†è«–èªªæ˜ã€å“è³ªè©•åˆ†ï¼‰</li>
                        <li>é»æ“ŠæŒ‰éˆ•å¾Œæœƒå‘¼å«å…©å€‹ç‰ˆæœ¬çš„ APIï¼Œå¯¦éš›å°æ¯”çµæœ</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Tab 2: å ±å‘Šå°æ¯” -->
        <div id="tab-comparison" class="tab-content">
            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>æ­£åœ¨ç”Ÿæˆå ±å‘Š...</p>
            </div>

            <div id="reports" class="split-view" style="display: none;">
                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">èˆŠç‰ˆå ±å‘Š</span>
                        <span class="badge old">Staging</span>
                    </div>
                    <div id="old-report" class="report-preview"></div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title">å¢å¼·ç‰ˆå ±å‘Š</span>
                        <span class="badge new">Feature</span>
                    </div>
                    <div id="new-report" class="report-preview"></div>
                </div>
            </div>
        </div>

        <!-- Tab 3: å“è³ªæŒ‡æ¨™ -->
        <div id="tab-metrics" class="tab-content">
            <div id="metrics-loading" class="loading" style="display: none;">
                <p>è«‹å…ˆç”Ÿæˆå ±å‘Š...</p>
            </div>

            <div id="metrics-content" style="display: none;">
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>å“è³ªæŒ‡æ¨™</th>
                            <th>èˆŠç‰ˆï¼ˆStagingï¼‰</th>
                            <th>å¢å¼·ç‰ˆï¼ˆFeatureï¼‰</th>
                            <th>æ”¹å–„</th>
                        </tr>
                    </thead>
                    <tbody id="metrics-table">
                    </tbody>
                </table>

                <div class="split-view" style="margin-top: 20px;">
                    <div class="panel">
                        <div class="panel-header">
                            <span class="panel-title">èˆŠç‰ˆå“è³ªåˆ†æ•¸</span>
                        </div>
                        <div id="old-quality" class="quality-score"></div>
                    </div>

                    <div class="panel">
                        <div class="panel-header">
                            <span class="panel-title">å¢å¼·ç‰ˆå“è³ªåˆ†æ•¸</span>
                        </div>
                        <div id="new-quality" class="quality-score"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let oldReportData = null;
        let newReportData = null;

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

            // Show selected tab
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }

        async function generateReports() {
            const transcript = document.getElementById('transcript').value;
            if (!transcript.trim()) {
                alert('è«‹è¼¸å…¥é€å­—ç¨¿');
                return;
            }

            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('reports').style.display = 'none';
            switchTab('comparison');

            try {
                // æ³¨æ„ï¼šé€™è£¡éœ€è¦å¯¦éš›éƒ¨ç½²å…©å€‹ç‰ˆæœ¬çš„ API
                // æˆ–è€…ç”¨ query parameter åˆ‡æ›ç‰ˆæœ¬

                // èˆŠç‰ˆ API (å‡è¨­æœ‰ use_legacy=true åƒæ•¸)
                const oldResponse = await fetch('/api/rag/report/generate?use_legacy=true', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ transcript, rag_system: 'openai' })
                });
                oldReportData = await oldResponse.json();

                // æ–°ç‰ˆ API
                const newResponse = await fetch('/api/rag/report/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ transcript, rag_system: 'openai' })
                });
                newReportData = await newResponse.json();

                // Display reports
                displayReports();
                displayMetrics();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('reports').style.display = 'grid';

            } catch (error) {
                console.error('Error:', error);
                alert('ç”Ÿæˆå¤±æ•—ï¼š' + error.message);
                document.getElementById('loading').style.display = 'none';
            }
        }

        function displayReports() {
            document.getElementById('old-report').textContent = oldReportData.conceptualization;
            document.getElementById('new-report').textContent = newReportData.conceptualization;
        }

        function displayMetrics() {
            // å‡è¨­æ–°ç‰ˆæœ‰ quality_summary
            const newQuality = newReportData.quality_summary;

            // å°èˆŠç‰ˆå ±å‘ŠåŸ·è¡Œé©—è­‰ï¼ˆå‰ç«¯æ¨¡æ“¬ï¼‰
            const oldMetrics = simulateOldValidation(oldReportData.conceptualization);
            const newMetrics = {
                structure: newQuality.structure_quality.completeness,
                citations: newQuality.citation_quality.total_citations,
                score: newQuality.overall_score,
                grade: newQuality.grade
            };

            // å¡«å……è¡¨æ ¼
            const tbody = document.getElementById('metrics-table');
            tbody.innerHTML = `
                <tr>
                    <td><strong>çµæ§‹å®Œæ•´æ€§</strong></td>
                    <td class="metric-old">${oldMetrics.structure}%</td>
                    <td class="metric-new">${newMetrics.structure}%</td>
                    <td class="improvement">+${(newMetrics.structure - oldMetrics.structure).toFixed(0)}%</td>
                </tr>
                <tr>
                    <td><strong>ç†è«–å¼•ç”¨æ•¸</strong></td>
                    <td class="metric-old">${oldMetrics.citations} å€‹</td>
                    <td class="metric-new">${newMetrics.citations} å€‹</td>
                    <td class="improvement">+${newMetrics.citations - oldMetrics.citations} å€‹</td>
                </tr>
                <tr>
                    <td><strong>å“è³ªåˆ†æ•¸</strong></td>
                    <td class="metric-old">${oldMetrics.score.toFixed(1)} åˆ†</td>
                    <td class="metric-new">${newMetrics.score.toFixed(1)} åˆ†</td>
                    <td class="improvement">+${(newMetrics.score - oldMetrics.score).toFixed(1)} åˆ†</td>
                </tr>
                <tr>
                    <td><strong>ç­‰ç´š</strong></td>
                    <td class="metric-old">${oldMetrics.grade}</td>
                    <td class="metric-new">${newMetrics.grade}</td>
                    <td class="improvement">${oldMetrics.grade} â†’ ${newMetrics.grade}</td>
                </tr>
            `;

            // é¡¯ç¤ºåˆ†æ•¸åœ“åœˆ
            displayScoreCircle('old-quality', oldMetrics.score, oldMetrics.grade);
            displayScoreCircle('new-quality', newMetrics.score, newMetrics.grade);

            document.getElementById('metrics-loading').style.display = 'none';
            document.getElementById('metrics-content').style.display = 'block';
        }

        function simulateOldValidation(text) {
            // ç°¡å–®æ¨¡æ“¬é©—è­‰é‚è¼¯
            const sections = ['ã€ä¸€ã€', 'ã€äºŒã€', 'ã€ä¸‰ã€', 'ã€å››ã€', 'ã€äº”ã€', 'ã€å…­ã€', 'ã€ä¸ƒã€', 'ã€å…«ã€', 'ã€ä¹ã€', 'ã€åã€'];
            const presentSections = sections.filter(s => text.includes(s)).length;
            const structure = (presentSections / 10) * 100;

            const citations = (text.match(/\[\d+\]/g) || []).length;

            // ç°¡åŒ–è©•åˆ†
            const score = structure * 0.4 + Math.min(citations / 7, 1) * 60;

            let grade = 'éœ€æ”¹é€²';
            if (score >= 90) grade = 'å„ªç§€';
            else if (score >= 75) grade = 'è‰¯å¥½';
            else if (score >= 60) grade = 'åŠæ ¼';

            return { structure, citations, score, grade };
        }

        function displayScoreCircle(elementId, score, grade) {
            const el = document.getElementById(elementId);
            let className = 'score-fail';
            if (score >= 90) className = 'score-excellent';
            else if (score >= 75) className = 'score-good';
            else if (score >= 60) className = 'score-pass';

            el.innerHTML = `
                <div class="score-circle ${className}">${score.toFixed(0)}</div>
                <div>
                    <div style="font-size: 24px; font-weight: 600;">${grade}</div>
                    <div style="color: #6e6e73; font-size: 14px;">${score.toFixed(1)} / 100</div>
                </div>
            `;
        }
    </script>
</body>
</html>
