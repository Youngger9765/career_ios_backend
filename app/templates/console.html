<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOS API Test Console</title>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Left Sidebar - Flow */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h2 {
            font-size: 18px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .flow-group-title {
            font-size: 14px;
            font-weight: 700;
            color: #ffffff;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-top: 24px;
            margin-bottom: 12px;
            padding: 14px 12px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.18));
            border-radius: 10px;
            border-left: 4px solid #10b981;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .flow-group-title:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.32), rgba(255, 255, 255, 0.25));
            transform: translateX(2px);
        }

        .flow-group-title:first-of-type {
            margin-top: 0;
        }

        .flow-group-title::after {
            content: 'â–¼';
            font-size: 12px;
            transition: transform 0.3s;
        }

        .flow-group-title.collapsed::after {
            transform: rotate(-90deg);
        }

        .flow-group-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s;
            opacity: 1;
            margin-bottom: 8px;
            padding-left: 8px;
        }

        .flow-group-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .flow-step {
            margin-bottom: 8px;
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            background: rgba(255, 255, 255, 0.05);
        }

        .flow-step:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .flow-step.active {
            background: rgba(255, 255, 255, 0.15);
            border-left-color: #10b981;
        }

        .flow-step.completed {
            background: rgba(16, 185, 129, 0.2);
            border-left-color: #10b981;
        }

        .flow-step.error {
            background: rgba(239, 68, 68, 0.2);
            border-left-color: #ef4444;
        }

        .step-number {
            display: inline-block;
            width: 28px;
            height: 28px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            font-size: 13px;
            font-weight: 600;
            margin-right: 10px;
            color: rgba(255, 255, 255, 0.9);
        }

        .flow-step.completed .step-number {
            background: #10b981;
        }

        .flow-step.error .step-number {
            background: #ef4444;
        }

        .step-title {
            font-size: 14px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.95);
        }

        .step-subtitle {
            font-size: 11px;
            opacity: 0.6;
            margin-top: 2px;
            font-family: 'Courier New', monospace;
        }

        /* Center Panel - Preview */
        .preview-panel {
            flex: 1;
            background: #f9fafb;
            padding: 30px;
            overflow-y: auto;
        }

        .preview-header {
            margin-bottom: 20px;
        }

        .preview-header h1 {
            font-size: 24px;
            color: #111827;
            margin-bottom: 8px;
        }

        .preview-header p {
            color: #6b7280;
            font-size: 14px;
        }

        .preview-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            min-height: 400px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        /* Right Panel - Actions & Response */
        .action-panel {
            width: 420px;
            background: white;
            border-left: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
        }

        .action-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .action-header h3 {
            font-size: 16px;
            color: #111827;
            margin-bottom: 4px;
        }

        .action-header p {
            font-size: 12px;
            color: #6b7280;
        }

        .action-form {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            width: 100%;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .response-section {
            border-top: 1px solid #e5e7eb;
            padding: 20px;
            background: #f9fafb;
            max-height: 300px;
            overflow-y: auto;
        }

        .response-title {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 10px;
        }

        .response-content {
            background: #1f2937;
            color: #e5e7eb;
            padding: 12px;
            border-radius: 6px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        /* Report Preview Styles */
        .report-section {
            margin-bottom: 24px;
        }

        .report-section h3 {
            font-size: 18px;
            color: #111827;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb;
        }

        .report-section h4 {
            font-size: 14px;
            color: #374151;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .report-section p {
            font-size: 14px;
            color: #4b5563;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .theory-item {
            background: #f0f9ff;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            border-left: 3px solid #3b82f6;
        }

        .theory-meta {
            font-size: 12px;
            color: #6b7280;
            margin-top: 6px;
        }

        .dialogue-item {
            margin-bottom: 16px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
        }

        .dialogue-speaker {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 4px;
            font-size: 13px;
        }

        .dialogue-content {
            font-size: 14px;
            color: #374151;
            line-height: 1.5;
        }

        .quality-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .quality-grade {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .quality-score {
            font-size: 14px;
            opacity: 0.9;
        }

        .info-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-size: 13px;
            color: #6b7280;
        }

        .info-value {
            font-size: 13px;
            color: #111827;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Sidebar: Flow Steps -->
        <div class="sidebar">
            <h2>ğŸ“± iOS API æ¸¬è©¦æµç¨‹</h2>

            <!-- è«®å•†å¸«ç®¡ç† -->
            <div class="flow-group-title" data-group="auth">ğŸ‘¤ èªè­‰ç®¡ç† Auth</div>
            <div class="flow-group-content" data-group-content="auth">
                <div class="flow-step" data-step="login">
                    <div>
                        <span class="step-number">1</span>
                        <span class="step-title">ç™»å…¥é©—è­‰</span>
                    </div>
                    <div class="step-subtitle">POST /auth/login</div>
                </div>

                <div class="flow-step" data-step="me">
                    <div>
                        <span class="step-number">2</span>
                        <span class="step-title">å–å¾—è«®å•†å¸«è³‡è¨Š</span>
                    </div>
                    <div class="step-subtitle">GET /auth/me</div>
                </div>

                <div class="flow-step" data-step="update-counselor">
                    <div>
                        <span class="step-number">3</span>
                        <span class="step-title">æ›´æ–°è«®å•†å¸«è³‡è¨Š</span>
                    </div>
                    <div class="step-subtitle">PATCH /auth/me</div>
                </div>
            </div>

            <!-- å®¢æˆ¶ç®¡ç† -->
            <div class="flow-group-title" data-group="client">ğŸ‘¥ å®¢æˆ¶ç®¡ç† Client</div>
            <div class="flow-group-content" data-group-content="client">

            <div class="flow-step" data-step="get-client-field-schema">
                <div>
                    <span class="step-number">4</span>
                    <span class="step-title">å–å¾— Client æ¬„ä½é…ç½®</span>
                </div>
                <div class="step-subtitle">GET /api/v1/field-schemas/client</div>
            </div>

            <div class="flow-step" data-step="list-clients">
                <div>
                    <span class="step-number">5</span>
                    <span class="step-title">åˆ—å‡ºå®¢æˆ¶</span>
                </div>
                <div class="step-subtitle">GET /api/v1/clients</div>
            </div>

            <div class="flow-step" data-step="create-client">
                <div>
                    <span class="step-number">6</span>
                    <span class="step-title">å»ºç«‹å®¢æˆ¶</span>
                </div>
                <div class="step-subtitle">POST /api/v1/clients</div>
            </div>

            <div class="flow-step" data-step="view-client">
                <div>
                    <span class="step-number">7</span>
                    <span class="step-title">æŸ¥çœ‹å®¢æˆ¶</span>
                </div>
                <div class="step-subtitle">GET /api/v1/clients/{id}</div>
            </div>

            <div class="flow-step" data-step="update-client">
                <div>
                    <span class="step-number">8</span>
                    <span class="step-title">æ›´æ–°å®¢æˆ¶</span>
                </div>
                <div class="step-subtitle">PATCH /api/v1/clients/{id}</div>
            </div>

            <div class="flow-step" data-step="delete-client">
                <div>
                    <span class="step-number">9</span>
                    <span class="step-title">åˆªé™¤å®¢æˆ¶</span>
                </div>
                <div class="step-subtitle">DELETE /api/v1/clients/{id}</div>
            </div>
            </div>

            <!-- å€‹æ¡ˆç®¡ç† -->
            <div class="flow-group-title" data-group="case">ğŸ“‹ å€‹æ¡ˆç®¡ç† Case</div>
            <div class="flow-group-content" data-group-content="case">

            <div class="flow-step" data-step="get-case-field-schema">
                <div>
                    <span class="step-number">10</span>
                    <span class="step-title">å–å¾— Case æ¬„ä½é…ç½®</span>
                </div>
                <div class="step-subtitle">GET /api/v1/field-schemas/case</div>
            </div>

            <div class="flow-step" data-step="list-cases">
                <div>
                    <span class="step-number">11</span>
                    <span class="step-title">åˆ—å‡ºå€‹æ¡ˆ</span>
                </div>
                <div class="step-subtitle">GET /api/v1/cases</div>
            </div>

            <div class="flow-step" data-step="create-case">
                <div>
                    <span class="step-number">12</span>
                    <span class="step-title">å»ºç«‹å€‹æ¡ˆ</span>
                </div>
                <div class="step-subtitle">POST /api/v1/cases</div>
            </div>

            <div class="flow-step" data-step="view-case">
                <div>
                    <span class="step-number">13</span>
                    <span class="step-title">æŸ¥çœ‹å€‹æ¡ˆ</span>
                </div>
                <div class="step-subtitle">GET /api/v1/cases/{id}</div>
            </div>

            <div class="flow-step" data-step="update-case">
                <div>
                    <span class="step-number">14</span>
                    <span class="step-title">æ›´æ–°å€‹æ¡ˆ</span>
                </div>
                <div class="step-subtitle">PATCH /api/v1/cases/{id}</div>
            </div>

            <div class="flow-step" data-step="delete-case">
                <div>
                    <span class="step-number">15</span>
                    <span class="step-title">åˆªé™¤å€‹æ¡ˆ</span>
                </div>
                <div class="step-subtitle">DELETE /api/v1/cases/{id}</div>
            </div>
            </div>

            <!-- æœƒè«‡ç®¡ç† -->
            <div class="flow-group-title" data-group="session">ğŸ“ æœƒè«‡ç®¡ç† Session</div>
            <div class="flow-group-content" data-group-content="session">

            <div class="flow-step" data-step="create-session">
                <div>
                    <span class="step-number">9</span>
                    <span class="step-title">å»ºç«‹æœƒè«‡è¨˜éŒ„</span>
                </div>
                <div class="step-subtitle">POST /api/v1/sessions</div>
            </div>

            <div class="flow-step" data-step="list-sessions">
                <div>
                    <span class="step-number">10</span>
                    <span class="step-title">åˆ—å‡ºæœƒè«‡è¨˜éŒ„</span>
                </div>
                <div class="step-subtitle">GET /api/v1/sessions</div>
            </div>

            <div class="flow-step" data-step="view-session">
                <div>
                    <span class="step-number">11</span>
                    <span class="step-title">æŸ¥çœ‹æœƒè«‡è©³æƒ…</span>
                </div>
                <div class="step-subtitle">GET /api/v1/sessions/{id}</div>
            </div>

            <div class="flow-step" data-step="update-session">
                <div>
                    <span class="step-number">12</span>
                    <span class="step-title">æ›´æ–°æœƒè«‡è¨˜éŒ„</span>
                </div>
                <div class="step-subtitle">PATCH /api/v1/sessions/{id}</div>
            </div>

            <div class="flow-step" data-step="delete-session">
                <div>
                    <span class="step-number">13</span>
                    <span class="step-title">åˆªé™¤æœƒè«‡è¨˜éŒ„</span>
                </div>
                <div class="step-subtitle">DELETE /api/v1/sessions/{id}</div>
            </div>

            <div class="flow-step" data-step="client-timeline">
                <div>
                    <span class="step-number">14</span>
                    <span class="step-title">æŸ¥çœ‹å€‹æ¡ˆæ­·ç¨‹</span>
                </div>
                <div class="step-subtitle">GET /api/v1/sessions/timeline</div>
            </div>

            <div class="flow-step" data-step="get-reflection">
                <div>
                    <span class="step-number">15</span>
                    <span class="step-title">æŸ¥çœ‹åæ€</span>
                </div>
                <div class="step-subtitle">GET /api/v1/sessions/{id}/reflection</div>
            </div>

            <div class="flow-step" data-step="update-reflection">
                <div>
                    <span class="step-number">16</span>
                    <span class="step-title">æ›´æ–°åæ€</span>
                </div>
                <div class="step-subtitle">PUT /api/v1/sessions/{id}/reflection</div>
            </div>

            <div class="flow-step" data-step="append-recording">
                <div>
                    <span class="step-number">17</span>
                    <span class="step-title">ğŸ™ï¸ Append éŒ„éŸ³ç‰‡æ®µ (iOS)</span>
                </div>
                <div class="step-subtitle">POST /api/v1/sessions/{id}/recordings/append</div>
            </div>
            </div>

            <!-- å ±å‘Šç®¡ç† -->
            <div class="flow-group-title" data-group="report">ğŸ“„ å ±å‘Šç®¡ç† Report</div>
            <div class="flow-group-content" data-group-content="report">

            <div class="flow-step" data-step="generate-report">
                <div>
                    <span class="step-number">17</span>
                    <span class="step-title">ç”Ÿæˆå ±å‘Š</span>
                </div>
                <div class="step-subtitle">POST /api/v1/reports/generate</div>
            </div>

            <div class="flow-step" data-step="list-reports">
                <div>
                    <span class="step-number">18</span>
                    <span class="step-title">åˆ—å‡ºå ±å‘Š</span>
                </div>
                <div class="step-subtitle">GET /api/v1/reports</div>
            </div>

            <div class="flow-step" data-step="view-report">
                <div>
                    <span class="step-number">19</span>
                    <span class="step-title">æŸ¥çœ‹å ±å‘Š</span>
                </div>
                <div class="step-subtitle">GET /api/v1/reports/{id}</div>
            </div>

            <div class="flow-step" data-step="update-report">
                <div>
                    <span class="step-number">20</span>
                    <span class="step-title">æ›´æ–°å ±å‘Š</span>
                </div>
                <div class="step-subtitle">PATCH /api/v1/reports/{id}</div>
            </div>
            </div>

            <!-- 1. ç™»å…¥è¨»å†Š -->
            <div class="flow-group-title" data-group="auth-ui">ğŸ” 1. ç™»å…¥è¨»å†Š</div>
            <div class="flow-group-content" data-group-content="auth-ui">

            <div class="flow-step" data-step="ui-mobile-login">
                <div>
                    <span class="step-number">UI-0</span>
                    <span class="step-title">ç™»å…¥é é¢ (æ‰‹æ©Ÿæ¨¡æ“¬)</span>
                </div>
                <div class="step-subtitle">POST /api/auth/login</div>
            </div>

            </div>

            <!-- 2. å€‹æ¡ˆåˆ—è¡¨ & CRUD å€‹æ¡ˆ -->
            <div class="flow-group-title" data-group="case-ui">ğŸ“± 2. å€‹æ¡ˆåˆ—è¡¨ & CRUD å€‹æ¡ˆ</div>
            <div class="flow-group-content" data-group-content="case-ui">

            <div class="flow-step" data-step="ui-client-case-list">
                <div>
                    <span class="step-number">UI-1</span>
                    <span class="step-title">å®¢æˆ¶å€‹æ¡ˆåˆ—è¡¨ (æ‰‹æ©Ÿæ¨¡æ“¬)</span>
                </div>
                <div class="step-subtitle">GET /client-case-list</div>
            </div>

            <div class="flow-step" data-step="ui-create-client-case">
                <div>
                    <span class="step-number">UI-2</span>
                    <span class="step-title">å»ºç«‹æ–°å€‹æ¡ˆ (æ‰‹æ©Ÿæ¨¡æ“¬)</span>
                </div>
                <div class="step-subtitle">GET /create-client-case</div>
            </div>

            <div class="flow-step" data-step="list-client-cases">
                <div>
                    <span class="step-number">UI-3</span>
                    <span class="step-title">åˆ—å‡ºå®¢æˆ¶å€‹æ¡ˆ API</span>
                </div>
                <div class="step-subtitle">GET /api/v1/ui/client-case-list</div>
            </div>

            <div class="flow-step" data-step="create-client-case">
                <div>
                    <span class="step-number">UI-4</span>
                    <span class="step-title">å»ºç«‹å®¢æˆ¶å€‹æ¡ˆ API</span>
                </div>
                <div class="step-subtitle">POST /api/v1/ui/client-case</div>
            </div>

            <div class="flow-step" data-step="update-client-case">
                <div>
                    <span class="step-number">UI-5</span>
                    <span class="step-title">æ›´æ–°å®¢æˆ¶å€‹æ¡ˆ API</span>
                </div>
                <div class="step-subtitle">PATCH /api/v1/ui/client-case/{id}</div>
            </div>

            <div class="flow-step" data-step="delete-client-case">
                <div>
                    <span class="step-number">UI-6</span>
                    <span class="step-title">åˆªé™¤å®¢æˆ¶å€‹æ¡ˆ API</span>
                </div>
                <div class="step-subtitle">DELETE /api/v1/ui/client-case/{id}</div>
            </div>
            </div>

        </div>

        <!-- Center Panel: Preview -->
        <div class="preview-panel">
            <div class="preview-header">
                <h1 id="preview-title">iOS API æ¸¬è©¦æ§åˆ¶å°</h1>
                <p id="preview-subtitle">é¸æ“‡å·¦å´æµç¨‹æ­¥é©Ÿé–‹å§‹æ¸¬è©¦</p>
            </div>
            <div class="preview-content" id="preview-content">
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <p>è«‹å¾å·¦å´é¸æ“‡ API æ­¥é©Ÿ</p>
                </div>
            </div>
        </div>

        <!-- Right Panel: Actions & Response -->
        <div class="action-panel">
            <div class="action-header">
                <h3 id="action-title">è«‹é¸æ“‡æ­¥é©Ÿ</h3>
                <p id="action-subtitle">å¡«å¯«åƒæ•¸ä¸¦åŸ·è¡Œ API å‘¼å«</p>
            </div>

            <div class="action-form" id="action-form">
                <div class="empty-state">
                    <p>è«‹å¾å·¦å´é¸æ“‡æ­¥é©Ÿ</p>
                </div>
            </div>

            <div class="response-section" id="response-section" style="display: none;">
                <div class="response-title">Response</div>
                <div id="response-status"></div>
                <div class="response-content" id="response-content"></div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let state = {
            token: localStorage.getItem('token') || '',
            currentUser: null,
            clients: [],
            cases: [],
            sessions: [],
            reports: [],
            clientCases: [],  // For UI client-case CRUD
            currentClient: null,
            currentSession: null,
            currentReport: null
        };

        const BASE_URL = window.location.origin;

        // Helper function to render tenant info banner
        const renderTenantBanner = () => {
            const tenantName = state.currentUser?.tenant_id || 'unknown';
            return `<div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 6px; padding: 12px; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 18px;">ğŸ¢</span>
                <span style="color: #0369a1; font-weight: 600;">ç•¶å‰ç§Ÿæˆ¶ï¼š${tenantName}</span>
            </div>`;
        };

        // Step configurations
        const steps = {
            login: {
                title: 'ç™»å…¥é©—è­‰',
                subtitle: 'POST /auth/login',
                renderForm: () => `
                    <div class="form-group">
                        <label>Tenant ID</label>
                        <select id="tenant_id" onchange="document.getElementById('email').value = this.value === 'career' ? 'admin@career.com' : 'admin@island.com'">
                            <option value="career">career</option>
                            <option value="island">island</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="email" value="admin@career.com" />
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="password" value="password123" />
                    </div>
                    <button class="btn btn-primary" onclick="executeLogin()">ç™»å…¥</button>
                `,
                execute: async () => {
                    const tenant_id = document.getElementById('tenant_id').value;
                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;

                    const response = await fetch(`${BASE_URL}/api/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tenant_id, email, password })
                    });

                    const data = await response.json();
                    if (response.ok) {
                        state.token = data.access_token;
                        localStorage.setItem('token', state.token);

                        // è‡ªå‹•ç²å–ç•¶å‰ç”¨æˆ¶è³‡è¨Š
                        try {
                            const meResponse = await fetch(`${BASE_URL}/api/auth/me`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (meResponse.ok) {
                                const userData = await meResponse.json();
                                state.currentUser = userData;
                            }
                        } catch (error) {
                            console.error('Failed to fetch user info:', error);
                        }
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>ğŸ” ç™»å…¥æˆåŠŸ</h3>
                        <div class="info-row">
                            <span class="info-label">Token Type</span>
                            <span class="info-value">${data.token_type}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Expires In</span>
                            <span class="info-value">${data.expires_in}s</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Access Token</span>
                            <span class="info-value" style="font-size: 11px; word-break: break-all;">${data.access_token.substring(0, 40)}...</span>
                        </div>
                    </div>
                `
            },
            me: {
                title: 'å–å¾—ç•¶å‰ç”¨æˆ¶',
                subtitle: 'GET /auth/me',
                renderForm: () => `
                    <div class="info-card">
                        <p style="font-size: 13px; color: #6b7280;">éœ€è¦å…ˆç™»å…¥å–å¾— Token</p>
                    </div>
                    <button class="btn btn-primary" onclick="executeMe()" ${!state.token ? 'disabled' : ''}>å–å¾—ç”¨æˆ¶è³‡è¨Š</button>
                `,
                execute: async () => {
                    const response = await fetch(`${BASE_URL}/api/auth/me`, {
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.currentUser = data;
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>ğŸ‘¤ ç”¨æˆ¶è³‡è¨Š</h3>
                        <div class="info-row">
                            <span class="info-label">å§“å</span>
                            <span class="info-value">${data.full_name}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Email</span>
                            <span class="info-value">${data.email}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">è§’è‰²</span>
                            <span class="info-value">${data.role}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç§Ÿæˆ¶</span>
                            <span class="info-value">${data.tenant_id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç‹€æ…‹</span>
                            <span class="info-value">${data.is_active ? 'âœ… å•Ÿç”¨' : 'âŒ åœç”¨'}</span>
                        </div>
                    </div>
                `
            },
            'get-client-field-schema': {
                title: 'å–å¾— Client æ¬„ä½é…ç½®',
                subtitle: 'GET /api/v1/field-schemas/client',
                renderForm: () => `
                    ${renderTenantBanner()}
                    <p>å–å¾—ç•¶å‰ç§Ÿæˆ¶çš„ Client è¡¨å–®æ¬„ä½é…ç½®ï¼Œç”¨æ–¼å‹•æ…‹ç”Ÿæˆè¡¨å–®</p>
                    <button class="btn btn-primary" onclick="executeGetClientFieldSchema()" ${!state.token ? 'disabled' : ''}>å–å¾—é…ç½®</button>
                `,
                execute: async () => {
                    const response = await fetch(`${BASE_URL}/api/v1/field-schemas/client`, {
                        headers: {
                            'Authorization': `Bearer ${state.token}`
                        }
                    });

                    const data = await response.json();
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="response-card">
                        <h4>ğŸ“‹ ${data.tenant_id.toUpperCase()} - ${data.form_type.toUpperCase()} è¡¨å–®é…ç½®</h4>
                        ${data.sections.map(section => `
                            <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                <h5 style="margin: 0 0 10px 0; color: #1e40af;">ğŸ“Œ ${section.title}</h5>
                                ${section.description ? `<p style="color: #6b7280; margin: 0 0 15px 0;">${section.description}</p>` : ''}
                                <div style="display: grid; gap: 12px;">
                                    ${section.fields.map(field => `
                                        <div style="padding: 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                                <div>
                                                    <strong style="color: #111827;">${field.label}</strong>
                                                    ${field.required ? '<span style="color: #ef4444; margin-left: 4px;">*</span>' : ''}
                                                </div>
                                                <span style="background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${field.type}</span>
                                            </div>
                                            <div style="font-size: 13px; color: #6b7280;">
                                                <div><strong>Key:</strong> ${field.key}</div>
                                                ${field.placeholder ? `<div><strong>Placeholder:</strong> ${field.placeholder}</div>` : ''}
                                                ${field.help_text ? `<div><strong>èªªæ˜:</strong> ${field.help_text}</div>` : ''}
                                                ${field.options ? `<div><strong>é¸é …:</strong> ${field.options.join(', ')}</div>` : ''}
                                                ${field.default_value ? `<div><strong>é è¨­å€¼:</strong> ${field.default_value}</div>` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `,
                renderResponse: (data) => `
                    <div class="response-card">
                        <h4>ğŸ“‹ ${data.tenant_id.toUpperCase()} - ${data.form_type.toUpperCase()} è¡¨å–®é…ç½®</h4>
                        ${data.sections.map(section => `
                            <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                <h5 style="margin: 0 0 10px 0; color: #1e40af;">ğŸ“Œ ${section.title}</h5>
                                ${section.description ? `<p style="color: #6b7280; margin: 0 0 15px 0;">${section.description}</p>` : ''}
                                <div style="display: grid; gap: 12px;">
                                    ${section.fields.map(field => `
                                        <div style="padding: 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                                <div>
                                                    <strong style="color: #111827;">${field.label}</strong>
                                                    ${field.required ? '<span style="color: #ef4444; margin-left: 4px;">*</span>' : ''}
                                                </div>
                                                <span style="background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${field.type}</span>
                                            </div>
                                            <div style="font-size: 13px; color: #6b7280;">
                                                <div><strong>Key:</strong> ${field.key}</div>
                                                ${field.placeholder ? `<div><strong>Placeholder:</strong> ${field.placeholder}</div>` : ''}
                                                ${field.help_text ? `<div><strong>èªªæ˜:</strong> ${field.help_text}</div>` : ''}
                                                ${field.options ? `<div><strong>é¸é …:</strong> ${field.options.join(', ')}</div>` : ''}
                                                ${field.default_value ? `<div><strong>é è¨­å€¼:</strong> ${field.default_value}</div>` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `
            },
            'get-case-field-schema': {
                title: 'å–å¾— Case æ¬„ä½é…ç½®',
                subtitle: 'GET /api/v1/field-schemas/case',
                renderForm: () => `
                    ${renderTenantBanner()}
                    <p>å–å¾—ç•¶å‰ç§Ÿæˆ¶çš„å€‹æ¡ˆ (Case) è¡¨å–®æ¬„ä½é…ç½®ï¼Œç”¨æ–¼å‹•æ…‹ç”Ÿæˆè¡¨å–®</p>
                    <button class="btn btn-primary" onclick="executeGetCaseFieldSchema()" ${!state.token ? 'disabled' : ''}>å–å¾—é…ç½®</button>
                `,
                execute: async () => {
                    const response = await fetch(`${BASE_URL}/api/v1/field-schemas/case`, {
                        headers: {
                            'Authorization': `Bearer ${state.token}`
                        }
                    });

                    const data = await response.json();
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="response-card">
                        <h4>ğŸ“‹ ${data.tenant_id.toUpperCase()} - ${data.form_type.toUpperCase()} è¡¨å–®é…ç½®</h4>
                        ${data.sections.map(section => `
                            <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #10b981;">
                                <h5 style="margin: 0 0 10px 0; color: #059669;">ğŸ“Œ ${section.title}</h5>
                                ${section.description ? `<p style="color: #6b7280; margin: 0 0 15px 0;">${section.description}</p>` : ''}
                                <div style="display: grid; gap: 12px;">
                                    ${section.fields.map(field => `
                                        <div style="padding: 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                                <div>
                                                    <strong style="color: #111827;">${field.label}</strong>
                                                    ${field.required ? '<span style="color: #ef4444; margin-left: 4px;">*</span>' : ''}
                                                </div>
                                                <span style="background: #d1fae5; color: #059669; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${field.type}</span>
                                            </div>
                                            <div style="font-size: 13px; color: #6b7280;">
                                                <div><strong>Key:</strong> ${field.key}</div>
                                                ${field.placeholder ? `<div><strong>Placeholder:</strong> ${field.placeholder}</div>` : ''}
                                                ${field.help_text ? `<div><strong>èªªæ˜:</strong> ${field.help_text}</div>` : ''}
                                                ${field.options ? `<div><strong>é¸é …:</strong> ${field.options.join(', ')}</div>` : ''}
                                                ${field.default_value ? `<div><strong>é è¨­å€¼:</strong> ${field.default_value}</div>` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `,
                renderResponse: (data) => `
                    <div class="response-card">
                        <h4>ğŸ“‹ ${data.tenant_id.toUpperCase()} - ${data.form_type.toUpperCase()} è¡¨å–®é…ç½®</h4>
                        ${data.sections.map(section => `
                            <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #10b981;">
                                <h5 style="margin: 0 0 10px 0; color: #059669;">ğŸ“Œ ${section.title}</h5>
                                ${section.description ? `<p style="color: #6b7280; margin: 0 0 15px 0;">${section.description}</p>` : ''}
                                <div style="display: grid; gap: 12px;">
                                    ${section.fields.map(field => `
                                        <div style="padding: 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                                <div>
                                                    <strong style="color: #111827;">${field.label}</strong>
                                                    ${field.required ? '<span style="color: #ef4444; margin-left: 4px;">*</span>' : ''}
                                                </div>
                                                <span style="background: #d1fae5; color: #059669; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${field.type}</span>
                                            </div>
                                            <div style="font-size: 13px; color: #6b7280;">
                                                <div><strong>Key:</strong> ${field.key}</div>
                                                ${field.placeholder ? `<div><strong>Placeholder:</strong> ${field.placeholder}</div>` : ''}
                                                ${field.help_text ? `<div><strong>èªªæ˜:</strong> ${field.help_text}</div>` : ''}
                                                ${field.options ? `<div><strong>é¸é …:</strong> ${field.options.join(', ')}</div>` : ''}
                                                ${field.default_value ? `<div><strong>é è¨­å€¼:</strong> ${field.default_value}</div>` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `
            },
            'list-clients': {
                title: 'åˆ—å‡ºå€‹æ¡ˆ',
                subtitle: 'GET /api/v1/clients',
                renderForm: () => `
                    ${renderTenantBanner()}
                    <div class="form-group">
                        <label>Search (optional)</label>
                        <input type="text" id="search" placeholder="æœå°‹å§“åã€ä»£ç¢¼..." />
                    </div>
                    <button class="btn btn-primary" onclick="executeListClients()" ${!state.token ? 'disabled' : ''}>æŸ¥è©¢å€‹æ¡ˆ</button>
                `,
                execute: async () => {
                    const search = document.getElementById('search').value;
                    const params = new URLSearchParams();
                    if (search) params.append('search', search);

                    const response = await fetch(`${BASE_URL}/api/v1/clients?${params}`, {
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.clients = data.items;
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <h3>ğŸ“‹ å€‹æ¡ˆåˆ—è¡¨ (å…± ${data.total} ç­†)</h3>
                    ${data.items.map(client => `
                        <div class="info-card">
                            <div class="info-row">
                                <span class="info-label">å§“å</span>
                                <span class="info-value">${client.name}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ä»£ç¢¼</span>
                                <span class="info-value">${client.code}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">å¹´é½¡</span>
                                <span class="info-value">${client.age || 'N/A'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">å»ºç«‹æ™‚é–“</span>
                                <span class="info-value">${new Date(client.created_at).toLocaleString('zh-TW')}</span>
                            </div>
                        </div>
                    `).join('')}
                `
            },
            'create-client': {
                title: 'å»ºç«‹å®¢æˆ¶',
                subtitle: 'POST /api/v1/clients',
                init: async function() {
                    // Fetch client field schema
                    if (!state.clientFieldSchema) {
                        try {
                            const clientRes = await fetch(`${BASE_URL}/api/v1/field-schemas/client`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });

                            if (clientRes.ok) {
                                state.clientFieldSchema = await clientRes.json();
                            }
                        } catch (error) {
                            console.error('Failed to fetch client schema:', error);
                        }
                    }
                },
                renderForm: () => {
                    if (!state.clientFieldSchema) {
                        return `<p>è¼‰å…¥æ¬„ä½é…ç½®ä¸­...</p>`;
                    }

                    let formHtml = renderTenantBanner();

                    // Render Client fields dynamically
                    const clientSchema = state.clientFieldSchema;

                    clientSchema.sections.forEach(section => {
                        formHtml += `<h4 style="margin: 20px 0 10px 0; color: #1e40af; border-bottom: 1px solid #dbeafe; padding-bottom: 6px;">${section.title}</h4>`;
                        if (section.description) {
                            formHtml += `<p style="color: #6b7280; font-size: 13px; margin-bottom: 15px;">${section.description}</p>`;
                        }

                        section.fields.forEach(field => {
                            const required = field.required ? ' *' : '';
                            const inputId = `client-${field.key}`;

                            formHtml += `<div class="form-group">`;
                            formHtml += `<label>${field.label}${required}</label>`;

                            if (field.type === 'textarea') {
                                formHtml += `<textarea id="${inputId}" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''}></textarea>`;
                            } else if (field.type === 'single_select') {
                                formHtml += `<select id="${inputId}" ${field.required ? 'required' : ''}>`;
                                formHtml += `<option value="">è«‹é¸æ“‡</option>`;
                                field.options.forEach(opt => {
                                    formHtml += `<option value="${opt}">${opt}</option>`;
                                });
                                formHtml += `</select>`;
                            } else if (field.type === 'date') {
                                formHtml += `<input type="date" id="${inputId}" ${field.required ? 'required' : ''} />`;
                            } else if (field.type === 'email') {
                                formHtml += `<input type="email" id="${inputId}" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''} />`;
                            } else if (field.type === 'phone') {
                                formHtml += `<input type="tel" id="${inputId}" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''} />`;
                            } else {
                                formHtml += `<input type="text" id="${inputId}" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''} />`;
                            }

                            if (field.help_text) {
                                formHtml += `<small style="color: #6b7280; font-size: 12px;">${field.help_text}</small>`;
                            }
                            formHtml += `</div>`;
                        });
                    });

                    formHtml += `<div style="display: flex; gap: 10px; margin-top: 24px;">`;
                    formHtml += `<button class="btn btn-primary" onclick="executeCreateClient()" ${!state.token ? 'disabled' : ''}>å»ºç«‹å®¢æˆ¶</button>`;
                    formHtml += `<button class="btn btn-secondary" onclick="quickFillClient()" ${!state.token ? 'disabled' : ''} style="background: #6366f1;">ğŸ² å¿«é€Ÿå¡«å…¥æ¸¬è©¦è³‡æ–™</button>`;
                    formHtml += `</div>`;

                    return formHtml;
                },
                renderForm_old: () => `
                    <div class="form-group">
                        <label>å§“å *</label>
                        <input type="text" id="client-name" placeholder="è«‹è¼¸å…¥å§“å" required />
                    </div>
                    <div class="form-group">
                        <label>æš±ç¨±</label>
                        <input type="text" id="client-nickname" placeholder="è«‹è¼¸å…¥æš±ç¨±" />
                    </div>
                    <div class="form-group">
                        <label>å‡ºç”Ÿæ—¥æœŸ (å¿…å¡«ï¼Œç”¨æ–¼è‡ªå‹•è¨ˆç®—å¹´é½¡)</label>
                        <input type="date" id="client-birth-date" required />
                    </div>
                    <div class="form-group">
                        <label>æ€§åˆ¥</label>
                        <select id="client-gender">
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="male">ç”·æ€§</option>
                            <option value="female">å¥³æ€§</option>
                            <option value="other">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>è·æ¥­</label>
                        <input type="text" id="client-occupation" placeholder="è«‹è¼¸å…¥è·æ¥­" />
                    </div>
                    <div class="form-group">
                        <label>å­¸æ­·</label>
                        <input type="text" id="client-education" placeholder="ä¾‹å¦‚ï¼šåœ‹ç«‹OOå¤§å­¸" />
                    </div>
                    <div class="form-group">
                        <label>ç¾å±…åœ°</label>
                        <input type="text" id="client-location" placeholder="ä¾‹å¦‚ï¼šå°åŒ—å¸‚" />
                    </div>
                    <div class="form-group">
                        <label>ç¶“æ¿Ÿç‹€æ³</label>
                        <input type="text" id="client-economic-status" placeholder="ä¾‹å¦‚ï¼šå¯è² æ“”æ—¥å¸¸åŠé€²ä¿®" />
                    </div>
                    <div class="form-group">
                        <label>å®¶åº­é—œä¿‚</label>
                        <textarea id="client-family-relations" rows="2" placeholder="ä¾‹å¦‚ï¼šçˆ¶æ¯æ”¯æŒå‡å­¸ï¼›èˆ‡å“¥å“¥åŒä½"></textarea>
                    </div>
                    <div class="form-group">
                        <label>å…¶ä»–é‡è¦è³‡è¨Š</label>
                        <textarea id="client-other-info" rows="2" placeholder="ä¾‹å¦‚ï¼šè¿‘åŠå¹´è€ƒæ…®è½‰è·ï¼›å°è·æ¶¯æ–¹å‘æ„Ÿåˆ°è¿·æƒ˜"></textarea>
                    </div>
                    <div class="form-group">
                        <label>å‚™è¨» (ç§äºº)</label>
                        <textarea id="client-notes" rows="2" placeholder="è«®å•†å¸«ç§äººå‚™è¨»"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="executeCreateClient()" ${!state.token ? 'disabled' : ''}>å»ºç«‹å€‹æ¡ˆ</button>
                        <button class="btn btn-secondary" onclick="quickFillRandomClient()" ${!state.token ? 'disabled' : ''} style="background: #6366f1;">ğŸ² å¿«é€Ÿå¡«å…¥æ¸¬è©¦è³‡æ–™</button>
                    </div>
                `,
                execute: async () => {
                    if (!state.clientFieldSchema) {
                        throw new Error('Client schema not loaded');
                    }

                    // Collect Client data from form
                    const clientData = {};
                    state.clientFieldSchema.sections.forEach(section => {
                        section.fields.forEach(field => {
                            const inputId = `client-${field.key}`;
                            const element = document.getElementById(inputId);
                            if (element && element.value) {
                                clientData[field.key] = element.value;
                            }
                        });
                    });

                    // Remove empty values
                    Object.keys(clientData).forEach(key => {
                        if (clientData[key] === '' || clientData[key] === undefined) {
                            delete clientData[key];
                        }
                    });

                    // Create Client
                    const response = await fetch(`${BASE_URL}/api/v1/clients`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(clientData)
                    });
                    const data = await response.json();

                    if (response.ok) {
                        state.currentClient = data;
                        // Add to clients list
                        state.clients = state.clients || [];
                        state.clients.push(data);
                    }

                    return { response, data };
                },
                renderPreview: (data) => {
                    return `
                    <div class="info-card">
                        <h3>âœ… å®¢æˆ¶å»ºç«‹æˆåŠŸ</h3>
                        <div class="info-row">
                            <span class="info-label">å®¢æˆ¶ ID</span>
                            <span class="info-value" style="font-size: 11px;">${data.id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å§“å</span>
                            <span class="info-value">${data.name}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ä»£ç¢¼</span>
                            <span class="info-value">${data.code}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Email</span>
                            <span class="info-value">${data.email || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">é›»è©±</span>
                            <span class="info-value">${data.phone || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å»ºç«‹æ™‚é–“</span>
                            <span class="info-value">${new Date(data.created_at).toLocaleString('zh-TW')}</span>
                        </div>
                    </div>
                `;
                }
            },
            'view-client': {
                title: 'æŸ¥çœ‹å€‹æ¡ˆ',
                subtitle: 'GET /api/v1/clients/{id}',
                init: async () => {
                    // Load field schemas if not already loaded
                    if (!state.clientFieldSchema || !state.caseFieldSchema) {
                        const [clientRes, caseRes] = await Promise.all([
                            fetch(`${BASE_URL}/api/v1/field-schemas/client`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            }),
                            fetch(`${BASE_URL}/api/v1/field-schemas/case`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            })
                        ]);
                        if (clientRes.ok) state.clientFieldSchema = await clientRes.json();
                        if (caseRes.ok) state.caseFieldSchema = await caseRes.json();
                    }

                    // Refresh client list before showing view form
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/clients`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.clients = data.items;
                                // Re-render form with updated list
                                document.getElementById('action-form').innerHTML = steps['view-client'].renderForm();
                            }
                        } catch (error) {
                            console.error('Failed to refresh client list:', error);
                        }
                    }
                },
                renderForm: () => {
                    const clientOptions = state.clients.map(c =>
                        `<option value="${c.id}">${c.name} (${c.code})</option>`
                    ).join('');

                    return `
                        ${renderTenantBanner()}
                        <div class="form-group">
                            <label>é¸æ“‡å€‹æ¡ˆ *</label>
                            <select id="view-client-id">
                                ${state.currentClient ? `<option value="${state.currentClient.id}" selected>${state.currentClient.name} (${state.currentClient.code})</option>` : ''}
                                ${clientOptions}
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="executeViewClient()" ${!state.token || state.clients.length === 0 ? 'disabled' : ''}>æŸ¥çœ‹å€‹æ¡ˆ</button>
                    `;
                },
                execute: async () => {
                    const clientId = document.getElementById('view-client-id').value;

                    // Fetch client data and their cases in parallel
                    const [clientResponse, casesResponse] = await Promise.all([
                        fetch(`${BASE_URL}/api/v1/clients/${clientId}`, {
                            method: 'GET',
                            headers: { 'Authorization': `Bearer ${state.token}` }
                        }),
                        fetch(`${BASE_URL}/api/v1/cases?client_id=${clientId}`, {
                            method: 'GET',
                            headers: { 'Authorization': `Bearer ${state.token}` }
                        })
                    ]);

                    const clientData = await clientResponse.json();
                    let casesData = null;

                    if (casesResponse.ok) {
                        casesData = await casesResponse.json();
                    }

                    if (clientResponse.ok) {
                        state.currentClient = clientData;
                    }

                    return {
                        response: clientResponse,
                        data: {
                            client: clientData,
                            cases: casesData
                        }
                    };
                },
                renderPreview: (data) => {
                    if (!state.clientFieldSchema || !state.caseFieldSchema) {
                        return '<div class="info-card"><p>è¼‰å…¥æ¬„ä½é…ç½®ä¸­...</p></div>';
                    }

                    const client = data.client;
                    const cases = data.cases;

                    let html = '<div class="info-card">';

                    // Render client sections dynamically
                    state.clientFieldSchema.sections.forEach(section => {
                        html += `
                            <h3 style="color: #3b82f6; margin-top: ${section.order > 1 ? '20px' : '0'}; margin-bottom: 12px;">
                                ğŸ‘¤ ${section.title}
                            </h3>
                        `;

                        section.fields.forEach(field => {
                            let value = client[field.key];

                            // Format value based on type
                            if (value === null || value === undefined || value === '') {
                                value = 'N/A';
                            } else if (field.type === 'date' && value) {
                                value = new Date(value).toLocaleDateString('zh-TW');
                            } else if (Array.isArray(value)) {
                                value = value.join(', ');
                            } else if (typeof value === 'object') {
                                value = JSON.stringify(value);
                            }

                            html += `
                                <div class="info-row">
                                    <span class="info-label">${field.label}</span>
                                    <span class="info-value">${value}</span>
                                </div>
                            `;
                        });
                    });

                    // Show metadata
                    html += `
                        <h3 style="color: #6b7280; margin-top: 20px; margin-bottom: 12px;">â„¹ï¸ ç³»çµ±è³‡è¨Š</h3>
                        <div class="info-row">
                            <span class="info-label">å®¢æˆ¶ ID</span>
                            <span class="info-value" style="font-size: 11px;">${client.id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ä»£ç¢¼</span>
                            <span class="info-value">${client.code}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å»ºç«‹æ™‚é–“</span>
                            <span class="info-value">${new Date(client.created_at).toLocaleString('zh-TW')}</span>
                        </div>
                    `;

                    html += '</div>';

                    // Render cases if available
                    if (cases && cases.items && cases.items.length > 0) {
                        cases.items.forEach((caseItem, index) => {
                            html += '<div class="info-card" style="margin-top: 16px;">';

                            state.caseFieldSchema.sections.forEach(section => {
                                html += `
                                    <h3 style="color: #10b981; margin-top: ${section.order > 1 ? '20px' : '0'}; margin-bottom: 12px;">
                                        ğŸ“‹ ${section.title} ${cases.items.length > 1 ? `#${index + 1}` : ''}
                                    </h3>
                                `;

                                section.fields.forEach(field => {
                                    let value = caseItem[field.key];

                                    // Format value based on type
                                    if (value === null || value === undefined || value === '') {
                                        value = 'N/A';
                                    } else if (field.type === 'date' && value) {
                                        value = new Date(value).toLocaleDateString('zh-TW');
                                    } else if (Array.isArray(value)) {
                                        value = value.join(', ');
                                    } else if (typeof value === 'object') {
                                        value = JSON.stringify(value);
                                    }

                                    html += `
                                        <div class="info-row">
                                            <span class="info-label">${field.label}</span>
                                            <span class="info-value">${value}</span>
                                        </div>
                                    `;
                                });
                            });

                            // Case metadata
                            html += `
                                <h3 style="color: #6b7280; margin-top: 20px; margin-bottom: 12px;">â„¹ï¸ Case ç³»çµ±è³‡è¨Š</h3>
                                <div class="info-row">
                                    <span class="info-label">Case ID</span>
                                    <span class="info-value" style="font-size: 11px;">${caseItem.id}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">å»ºç«‹æ™‚é–“</span>
                                    <span class="info-value">${new Date(caseItem.created_at).toLocaleString('zh-TW')}</span>
                                </div>
                            `;

                            html += '</div>';
                        });
                    } else {
                        html += `
                            <div class="info-card" style="margin-top: 16px;">
                                <h3 style="color: #6b7280;">ğŸ“‹ é—œè¯çš„ Cases</h3>
                                <p style="color: #6b7280; font-size: 14px; margin-top: 12px;">æ­¤å®¢æˆ¶å°šç„¡ Case è¨˜éŒ„</p>
                            </div>
                        `;
                    }

                    return html;
                }
            },
            'client-timeline': {
                title: 'æŸ¥çœ‹å€‹æ¡ˆæ­·ç¨‹',
                subtitle: 'GET /api/v1/sessions/timeline',
                init: async () => {
                    // Refresh client list before showing timeline form
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/clients`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.clients = data.items;
                                // Re-render form with updated list
                                document.getElementById('action-form').innerHTML = steps['client-timeline'].renderForm();
                            }
                        } catch (error) {
                            console.error('Failed to refresh client list:', error);
                        }
                    }
                },
                renderForm: () => {
                    const clientOptions = state.clients.map(c =>
                        `<option value="${c.id}">${c.name} (${c.code})</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>é¸æ“‡å€‹æ¡ˆ *</label>
                            <select id="timeline-client-id">
                                ${state.currentClient ? `<option value="${state.currentClient.id}" selected>${state.currentClient.name} (${state.currentClient.code})</option>` : ''}
                                ${clientOptions}
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="executeClientTimeline()" ${!state.token || state.clients.length === 0 ? 'disabled' : ''}>æŸ¥çœ‹æ­·ç¨‹</button>
                    `;
                },
                execute: async () => {
                    const clientId = document.getElementById('timeline-client-id').value;

                    const response = await fetch(`${BASE_URL}/api/v1/sessions/timeline?client_id=${clientId}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${state.token}`
                        }
                    });
                    const data = await response.json();
                    return { response, data };
                },
                renderPreview: (data) => {
                    if (!data.sessions || data.sessions.length === 0) {
                        return `
                            <div class="info-card">
                                <h3>ğŸ“… å€‹æ¡ˆæ­·ç¨‹</h3>
                                <p style="color: #6b7280; font-size: 14px; margin-top: 12px;">æ­¤å€‹æ¡ˆå°šç„¡è«®å•†è¨˜éŒ„</p>
                            </div>
                        `;
                    }

                    return `
                        <div class="info-card">
                            <h3>ğŸ“… å€‹æ¡ˆæ­·ç¨‹ - ${data.client_name} (${data.client_code})</h3>
                            <div style="margin-top: 16px;">
                                <p style="color: #374151; font-size: 14px; margin-bottom: 12px;">å…± ${data.total_sessions} æ¬¡è«®å•†</p>
                                ${data.sessions.map(session => {
                                    // Remove surrounding quotes from summary if present
                                    let cleanSummary = session.summary;
                                    if (cleanSummary && cleanSummary.startsWith('"') && cleanSummary.endsWith('"')) {
                                        cleanSummary = cleanSummary.slice(1, -1);
                                    }
                                    // Also handle escaped quotes
                                    if (cleanSummary) {
                                        cleanSummary = cleanSummary.replace(/\\"/g, '"');
                                    }

                                    return `
                                    <div style="border-left: 3px solid #3b82f6; padding-left: 12px; margin-bottom: 20px;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                            <div style="font-weight: 600; color: #1f2937; font-size: 15px;">
                                                â— ç¬¬${session.session_number}æ¬¡ | ${session.date} ${session.time_range || ''}
                                            </div>
                                            ${session.has_report ? `
                                                <span style="background: #10b981; color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px; white-space: nowrap;">
                                                    å·²å‡ºå ±å‘Š
                                                </span>
                                            ` : `
                                                <span style="background: #9ca3af; color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px; white-space: nowrap;">
                                                    æœªå‡ºå ±å‘Š
                                                </span>
                                            `}
                                        </div>
                                        ${cleanSummary ? `
                                            <div style="font-size: 14px; color: #374151; line-height: 1.6;">
                                                ${cleanSummary}
                                            </div>
                                        ` : ''}
                                    </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
            },
            'get-reflection': {
                title: 'æŸ¥çœ‹åæ€',
                subtitle: 'GET /api/v1/sessions/{id}/reflection',
                init: async () => {
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/sessions`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.sessions = data.items;
                                document.getElementById('action-form').innerHTML = steps['get-reflection'].renderForm();
                            }
                        } catch (error) {
                            console.error('Failed to refresh session list:', error);
                        }
                    }
                },
                renderForm: () => {
                    const sessionOptions = (state.sessions || []).map(s =>
                        `<option value="${s.id}">${s.client_name || 'æœªçŸ¥'} - ç¬¬ ${s.session_number} æ¬¡ (${new Date(s.session_date).toLocaleDateString('zh-TW')})</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>é¸æ“‡æœƒè«‡è¨˜éŒ„ *</label>
                            <select id="reflection-session-id">
                                ${sessionOptions}
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="executeGetReflection()" ${!state.token || !state.sessions?.length ? 'disabled' : ''}>æŸ¥çœ‹åæ€</button>
                    `;
                },
                execute: async () => {
                    const sessionId = document.getElementById('reflection-session-id').value;
                    const response = await fetch(`${BASE_URL}/api/v1/sessions/${sessionId}/reflection`, {
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });
                    const data = await response.json();
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>ğŸ’­ è«®å•†å¸«åæ€</h3>
                        <div class="info-row">
                            <span class="info-label">Session ID</span>
                            <span class="info-value" style="font-size: 11px;">${data.session_id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æ›´æ–°æ™‚é–“</span>
                            <span class="info-value">${new Date(data.updated_at).toLocaleString('zh-TW')}</span>
                        </div>
                    </div>
                    ${data.reflection && Object.keys(data.reflection).length > 0 ? `
                        <div class="info-card">
                            <h4>åæ€å…§å®¹</h4>
                            ${data.reflection.working_with_client ? `
                                <div style="margin-bottom: 12px;">
                                    <strong style="color: #2563eb;">æˆ‘å’Œé€™å€‹äººå·¥ä½œçš„æ„Ÿå—æ˜¯ï¼Ÿ</strong>
                                    <p style="font-size: 13px; margin-top: 4px; line-height: 1.6;">${data.reflection.working_with_client}</p>
                                </div>
                            ` : ''}
                            ${data.reflection.feeling_source ? `
                                <div style="margin-bottom: 12px;">
                                    <strong style="color: #2563eb;">é€™å€‹æ„Ÿå—çš„åŸå› æ˜¯ï¼Ÿ</strong>
                                    <p style="font-size: 13px; margin-top: 4px; line-height: 1.6;">${data.reflection.feeling_source}</p>
                                </div>
                            ` : ''}
                            ${data.reflection.current_challenges ? `
                                <div style="margin-bottom: 12px;">
                                    <strong style="color: #2563eb;">ç›®å‰çš„å›°é›£ï¼æƒ³æ›´æ·±å…¥çš„åœ°æ–¹æ˜¯ï¼Ÿ</strong>
                                    <p style="font-size: 13px; margin-top: 4px; line-height: 1.6;">${data.reflection.current_challenges}</p>
                                </div>
                            ` : ''}
                            ${data.reflection.supervision_topics ? `
                                <div style="margin-bottom: 12px;">
                                    <strong style="color: #2563eb;">æˆ‘æœƒæƒ³æ‰¾ç£å°è¨è«–çš„å•é¡Œæ˜¯ï¼Ÿ</strong>
                                    <p style="font-size: 13px; margin-top: 4px; line-height: 1.6;">${data.reflection.supervision_topics}</p>
                                </div>
                            ` : ''}
                        </div>
                    ` : '<div class="info-card"><p style="color: #6b7280;">æ­¤æœƒè«‡å°šç„¡åæ€è¨˜éŒ„</p></div>'}
                `
            },
            'update-reflection': {
                title: 'æ›´æ–°åæ€',
                subtitle: 'PUT /api/v1/sessions/{id}/reflection',
                init: async () => {
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/sessions`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.sessions = data.items;
                                document.getElementById('action-form').innerHTML = steps['update-reflection'].renderForm();
                                setTimeout(() => loadReflectionForUpdate(), 100);
                            }
                        } catch (error) {
                            console.error('Failed to refresh session list:', error);
                        }
                    }
                },
                renderForm: () => {
                    const sessionOptions = (state.sessions || []).map(s =>
                        `<option value="${s.id}">${s.client_name || 'æœªçŸ¥'} - ç¬¬ ${s.session_number} æ¬¡ (${new Date(s.session_date).toLocaleDateString('zh-TW')})</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>é¸æ“‡æœƒè«‡è¨˜éŒ„ *</label>
                            <select id="update-reflection-session-id" onchange="loadReflectionForUpdate()">
                                ${sessionOptions}
                            </select>
                        </div>
                        <div class="info-card" style="background: #eff6ff; border-color: #3b82f6;">
                            <h4 style="color: #1e40af; margin-bottom: 12px;">è«®å•†å¸«åæ€</h4>
                            <div class="form-group">
                                <label>æˆ‘å’Œé€™å€‹äººå·¥ä½œçš„æ„Ÿå—æ˜¯ï¼Ÿ</label>
                                <textarea id="put-reflection-working" placeholder="ä¾‹å¦‚ï¼šæ•´é«”éç¨‹æµæš¢è¼•é¬†ï¼Œé€æ¼¸è´å¾—ä¿¡ä»»..." rows="2"></textarea>
                            </div>
                            <div class="form-group">
                                <label>é€™å€‹æ„Ÿå—çš„åŸå› æ˜¯ï¼Ÿ</label>
                                <textarea id="put-reflection-source" placeholder="ä¾‹å¦‚ï¼šå€‹æ¡ˆå¾ç·Šå¼µåˆ°é€æ­¥æ”¾é¬†ï¼Œé¡˜æ„é–‹æ”¾å¿ƒæ…‹åˆ†äº«æ›´å¤š..." rows="2"></textarea>
                            </div>
                            <div class="form-group">
                                <label>ç›®å‰çš„å›°é›£ï¼æƒ³æ›´æ·±å…¥çš„åœ°æ–¹æ˜¯ï¼Ÿ</label>
                                <textarea id="put-reflection-challenges" placeholder="ä¾‹å¦‚ï¼šç•¶è‚¯å®šå€‹æ¡ˆæ™‚ï¼Œä»æœƒæœ‰è‡ªæˆ‘æ‡·ç–‘åæ‡‰..." rows="2"></textarea>
                            </div>
                            <div class="form-group">
                                <label>æˆ‘æœƒæƒ³æ‰¾ç£å°è¨è«–çš„å•é¡Œæ˜¯ï¼Ÿ</label>
                                <textarea id="put-reflection-supervision" placeholder="ä¾‹å¦‚ï¼šå¦‚ä½•åœ¨æ”¯æŒèˆ‡æŒ‘æˆ°é–“æ‹¿æç¯€å¥..." rows="2"></textarea>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="executeUpdateReflection()" ${!state.token || !state.sessions?.length ? 'disabled' : ''}>æ›´æ–°åæ€</button>
                    `;
                },
                execute: async () => {
                    const sessionId = document.getElementById('update-reflection-session-id').value;
                    const requestBody = {};

                    const working = document.getElementById('put-reflection-working').value;
                    const source = document.getElementById('put-reflection-source').value;
                    const challenges = document.getElementById('put-reflection-challenges').value;
                    const supervision = document.getElementById('put-reflection-supervision').value;

                    if (working) requestBody.working_with_client = working;
                    if (source) requestBody.feeling_source = source;
                    if (challenges) requestBody.current_challenges = challenges;
                    if (supervision) requestBody.supervision_topics = supervision;

                    const response = await fetch(`${BASE_URL}/api/v1/sessions/${sessionId}/reflection`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });
                    const data = await response.json();
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card" style="border-color: #10b981;">
                        <h3 style="color: #10b981;">âœ… åæ€æ›´æ–°æˆåŠŸ</h3>
                        <div class="info-row">
                            <span class="info-label">Session ID</span>
                            <span class="info-value" style="font-size: 11px;">${data.session_id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æ›´æ–°æ™‚é–“</span>
                            <span class="info-value">${new Date(data.updated_at).toLocaleString('zh-TW')}</span>
                        </div>
                    </div>
                `
            },
            'append-recording': {
                title: 'ğŸ™ï¸ Append éŒ„éŸ³ç‰‡æ®µ (iOS)',
                subtitle: 'POST /api/v1/sessions/{id}/recordings/append',
                init: async () => {
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/sessions`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.sessions = data.items;
                                document.getElementById('action-form').innerHTML = steps['append-recording'].renderForm();
                            }
                        } catch (error) {
                            console.error('Failed to refresh session list:', error);
                        }
                    }
                },
                renderForm: () => {
                    const sessionOptions = (state.sessions || []).map(s =>
                        `<option value="${s.id}">${s.client_name || 'æœªçŸ¥'} - ç¬¬ ${s.session_number} æ¬¡ (${new Date(s.session_date).toLocaleDateString('zh-TW')})</option>`
                    ).join('');

                    return `
                        <div class="info-card" style="background: #fef3c7; border-color: #f59e0b;">
                            <h4 style="color: #92400e; margin: 0 0 8px 0;">ğŸ“± iOS å‹å–„ API</h4>
                            <p style="font-size: 13px; color: #92400e; line-height: 1.5;">
                                æ­¤ API ç‚º iOS è¨­è¨ˆï¼Œç°¡åŒ–éŒ„éŸ³ç‰‡æ®µæ·»åŠ æµç¨‹ï¼š<br>
                                â€¢ è‡ªå‹•è¨ˆç®— segment_number<br>
                                â€¢ è‡ªå‹•èšåˆæ‰€æœ‰ç‰‡æ®µçš„ transcript_text<br>
                                â€¢ æ”¯æŒæœƒè«‡ä¸­æ–·å¾Œç¹¼çºŒéŒ„éŸ³
                            </p>
                        </div>
                        <div class="form-group">
                            <label>é¸æ“‡æœƒè«‡è¨˜éŒ„ *</label>
                            <select id="append-session-id">
                                ${sessionOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>é–‹å§‹æ™‚é–“ *</label>
                            <input type="text" id="append-start-time" placeholder="2025-01-15 10:00 æˆ– 2025-01-15T10:00:00" />
                            <small style="color: #6b7280; font-size: 12px;">æ ¼å¼ï¼šYYYY-MM-DD HH:MM æˆ– ISO format</small>
                        </div>
                        <div class="form-group">
                            <label>çµæŸæ™‚é–“ *</label>
                            <input type="text" id="append-end-time" placeholder="2025-01-15 10:30 æˆ– 2025-01-15T10:30:00" />
                            <small style="color: #6b7280; font-size: 12px;">æ ¼å¼ï¼šYYYY-MM-DD HH:MM æˆ– ISO format</small>
                        </div>
                        <div class="form-group">
                            <label>éŒ„éŸ³æ™‚é•·ï¼ˆç§’ï¼‰ *</label>
                            <input type="number" id="append-duration" placeholder="1800" />
                            <small style="color: #6b7280; font-size: 12px;">ä¾‹å¦‚ï¼š30åˆ†é˜ = 1800ç§’</small>
                        </div>
                        <div class="form-group">
                            <label>é€å­—ç¨¿å…§å®¹ *</label>
                            <textarea id="append-transcript" placeholder="æ­¤ç‰‡æ®µçš„é€å­—ç¨¿å…§å®¹..." rows="8"></textarea>
                        </div>
                        <div class="form-group">
                            <label>è„«æ•é€å­—ç¨¿ï¼ˆé¸å¡«ï¼‰</label>
                            <textarea id="append-transcript-sanitized" placeholder="å¦‚ä¸å¡«ï¼Œç³»çµ±å°‡ä½¿ç”¨åŸå§‹é€å­—ç¨¿..." rows="5"></textarea>
                            <small style="color: #6b7280; font-size: 12px;">ğŸ’¡ è‹¥éœ€éš±è—å€‹äººè³‡è¨Šï¼Œè«‹æä¾›è„«æ•ç‰ˆæœ¬</small>
                        </div>
                        <button class="btn btn-primary" onclick="executeAppendRecording()" ${!state.token || !state.sessions?.length ? 'disabled' : ''}>
                            ğŸ™ï¸ Append éŒ„éŸ³ç‰‡æ®µ
                        </button>
                        <button class="btn btn-secondary" onclick="quickFillAppendRecording()" ${!state.token || !state.sessions?.length ? 'disabled' : ''} style="background: #6366f1; margin-top: 8px;">
                            ğŸ² å¿«é€Ÿå¡«å…¥æ¸¬è©¦è³‡æ–™
                        </button>
                    `;
                },
                execute: async () => {
                    const sessionId = document.getElementById('append-session-id').value;
                    const requestBody = {
                        start_time: document.getElementById('append-start-time').value,
                        end_time: document.getElementById('append-end-time').value,
                        duration_seconds: parseInt(document.getElementById('append-duration').value),
                        transcript_text: document.getElementById('append-transcript').value
                    };

                    const sanitized = document.getElementById('append-transcript-sanitized').value;
                    if (sanitized) {
                        requestBody.transcript_sanitized = sanitized;
                    }

                    const response = await fetch(`${BASE_URL}/api/v1/sessions/${sessionId}/recordings/append`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });
                    const data = await response.json();
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card" style="border-color: #10b981;">
                        <h3 style="color: #10b981;">âœ… éŒ„éŸ³ç‰‡æ®µå·²æˆåŠŸ Append</h3>
                        <div class="info-row">
                            <span class="info-label">Session ID</span>
                            <span class="info-value" style="font-size: 11px;">${data.session_id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Segment Number</span>
                            <span class="info-value" style="color: #10b981; font-weight: 600;">#${data.recording_added.segment_number}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç¸½ç‰‡æ®µæ•¸</span>
                            <span class="info-value">${data.total_recordings} å€‹</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">éŒ„éŸ³æ™‚é•·</span>
                            <span class="info-value">${data.recording_added.duration_seconds} ç§’ (${Math.round(data.recording_added.duration_seconds / 60)} åˆ†é˜)</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æ›´æ–°æ™‚é–“</span>
                            <span class="info-value">${new Date(data.updated_at).toLocaleString('zh-TW')}</span>
                        </div>
                    </div>
                    <div class="info-card">
                        <h4>ğŸ“ æ–°å¢ç‰‡æ®µå…§å®¹</h4>
                        <div style="background: #f3f4f6; padding: 12px; border-radius: 6px; margin-top: 8px;">
                            <p style="font-size: 13px; line-height: 1.6; white-space: pre-wrap;">${data.recording_added.transcript_text}</p>
                        </div>
                    </div>
                    <div class="info-card">
                        <h4>ğŸ“„ å®Œæ•´é€å­—ç¨¿ï¼ˆå·²è‡ªå‹•èšåˆï¼‰</h4>
                        <small style="color: #6b7280; font-size: 12px;">åŒ…å«æ‰€æœ‰ ${data.total_recordings} å€‹ç‰‡æ®µ</small>
                        <div style="background: #f3f4f6; padding: 12px; border-radius: 6px; margin-top: 8px; max-height: 300px; overflow-y: auto;">
                            <p style="font-size: 13px; line-height: 1.6; white-space: pre-wrap;">${data.transcript_text}</p>
                        </div>
                    </div>
                `
            },
            'update-client': {
                title: 'æ›´æ–°å€‹æ¡ˆ',
                subtitle: 'PATCH /api/v1/clients/{id} + PATCH /api/v1/cases/{id}',
                init: async () => {
                    // Load field schemas if not already loaded
                    if (!state.clientFieldSchema || !state.caseFieldSchema) {
                        const [clientRes, caseRes] = await Promise.all([
                            fetch(`${BASE_URL}/api/v1/field-schemas/client`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            }),
                            fetch(`${BASE_URL}/api/v1/field-schemas/case`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            })
                        ]);
                        if (clientRes.ok) state.clientFieldSchema = await clientRes.json();
                        if (caseRes.ok) state.caseFieldSchema = await caseRes.json();
                    }

                    // Refresh client list before showing update form
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/clients`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.clients = data.items;
                                // Re-render form with updated list
                                document.getElementById('action-form').innerHTML = steps['update-client'].renderForm();
                                // Load data for first/current client
                                setTimeout(() => loadClientDataForUpdate(), 100);
                            }
                        } catch (error) {
                            console.error('Failed to refresh client list:', error);
                        }
                    }
                },
                renderForm: () => {
                    if (!state.clientFieldSchema) {
                        return `${renderTenantBanner()}<p>è¼‰å…¥æ¬„ä½é…ç½®ä¸­...</p>`;
                    }

                    // Filter out currentClient from the list to avoid duplicates
                    const filteredClients = state.currentClient
                        ? state.clients.filter(c => c.id !== state.currentClient.id)
                        : state.clients;

                    const clientOptions = filteredClients.map(c =>
                        `<option value="${c.id}">${c.name} (${c.code})</option>`
                    ).join('');

                    let formHtml = `
                        ${renderTenantBanner()}
                        <div class="form-group">
                            <label>é¸æ“‡å€‹æ¡ˆ *</label>
                            <select id="update-client-id" onchange="loadClientDataForUpdate()">
                                ${state.currentClient ? `<option value="${state.currentClient.id}" selected>${state.currentClient.name} (${state.currentClient.code})</option>` : ''}
                                ${clientOptions}
                            </select>
                        </div>
                    `;

                    // Render dynamic fields from schema
                    state.clientFieldSchema.sections.forEach(section => {
                        formHtml += `<h4 style="margin: 20px 0 10px 0; color: #1e40af; border-bottom: 1px solid #dbeafe; padding-bottom: 6px;">${section.title}</h4>`;

                        section.fields.forEach(field => {
                            const inputId = `update-client-${field.key}`;
                            formHtml += `<div class="form-group">`;
                            formHtml += `<label>${field.label}</label>`;

                            if (field.type === 'textarea') {
                                formHtml += `<textarea id="${inputId}" placeholder="${field.placeholder || ''}"></textarea>`;
                            } else if (field.type === 'single_select') {
                                formHtml += `<select id="${inputId}">`;
                                formHtml += `<option value="">è«‹é¸æ“‡</option>`;
                                field.options.forEach(opt => {
                                    formHtml += `<option value="${opt}">${opt}</option>`;
                                });
                                formHtml += `</select>`;
                            } else if (field.type === 'date') {
                                formHtml += `<input type="date" id="${inputId}" />`;
                            } else if (field.type === 'email') {
                                formHtml += `<input type="email" id="${inputId}" placeholder="${field.placeholder || ''}" />`;
                            } else if (field.type === 'phone') {
                                formHtml += `<input type="tel" id="${inputId}" placeholder="${field.placeholder || ''}" />`;
                            } else {
                                formHtml += `<input type="text" id="${inputId}" placeholder="${field.placeholder || ''}" />`;
                            }

                            if (field.help_text) {
                                formHtml += `<small style="color: #6b7280; font-size: 12px;">${field.help_text}</small>`;
                            }
                            formHtml += `</div>`;
                        });
                    });

                    formHtml += `<button class="btn btn-primary" onclick="executeUpdateClient()" ${!state.token || (!state.currentClient && state.clients.length === 0) ? 'disabled' : ''}>æ›´æ–°å€‹æ¡ˆ</button>`;

                    return formHtml;
                },
                execute: async () => {
                    if (!state.clientFieldSchema) {
                        throw new Error('Client schema not loaded');
                    }

                    const clientId = document.getElementById('update-client-id').value;
                    const updateData = {};

                    // Collect data from dynamic fields
                    state.clientFieldSchema.sections.forEach(section => {
                        section.fields.forEach(field => {
                            const inputId = `update-client-${field.key}`;
                            const element = document.getElementById(inputId);
                            if (element && element.value) {
                                updateData[field.key] = element.value;
                            }
                        });
                    });

                    // Remove empty values
                    Object.keys(updateData).forEach(key => {
                        if (updateData[key] === '' || updateData[key] === undefined) {
                            delete updateData[key];
                        }
                    });

                    const response = await fetch(`${BASE_URL}/api/v1/clients/${clientId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.currentClient = data;
                    }
                    return { response, data };
                },
                renderPreview: (data) => {
                    if (!state.clientFieldSchema) {
                        return `<div class="info-card"><h3>âœ… å€‹æ¡ˆæ›´æ–°æˆåŠŸ</h3></div>`;
                    }

                    let html = `<div class="info-card"><h3>âœ… å€‹æ¡ˆæ›´æ–°æˆåŠŸ</h3>`;

                    // Display basic info
                    html += `
                        <div class="info-row">
                            <span class="info-label">ID</span>
                            <span class="info-value" style="font-size: 11px;">${data.id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ä»£ç¢¼</span>
                            <span class="info-value">${data.code}</span>
                        </div>
                    `;

                    // Dynamically display fields from schema
                    state.clientFieldSchema.sections.forEach(section => {
                        section.fields.forEach(field => {
                            const value = data[field.key];
                            if (value !== undefined && value !== null && value !== '') {
                                const displayValue = Array.isArray(value) ? value.join(', ') : value;
                                html += `
                                    <div class="info-row">
                                        <span class="info-label">${field.label}</span>
                                        <span class="info-value">${displayValue}</span>
                                    </div>
                                `;
                            }
                        });
                    });

                    html += `
                        <div class="info-row">
                            <span class="info-label">æ›´æ–°æ™‚é–“</span>
                            <span class="info-value">${new Date(data.updated_at).toLocaleString('zh-TW')}</span>
                        </div>
                    `;

                    html += `</div>`;
                    return html;
                }
            },
            'delete-client': {
                title: 'åˆªé™¤å€‹æ¡ˆ',
                subtitle: 'DELETE /api/v1/clients/{id}',
                init: async () => {
                    // Refresh client list before showing delete form
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/clients`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.clients = data.items;
                                // Re-render form with updated list
                                document.getElementById('action-form').innerHTML = steps['delete-client'].renderForm();
                            }
                        } catch (error) {
                            console.error('Failed to refresh client list:', error);
                        }
                    }
                },
                renderForm: () => {
                    const clientOptions = state.clients.map(c =>
                        `<option value="${c.id}">${c.name} (${c.code})</option>`
                    ).join('');

                    return `
                        ${renderTenantBanner()}
                        <div class="form-group">
                            <label>é¸æ“‡è¦åˆªé™¤çš„å€‹æ¡ˆ *</label>
                            <select id="delete-client-id">
                                ${clientOptions}
                            </select>
                        </div>
                        <div class="info-card" style="background: #fee2e2; border-color: #ef4444;">
                            <p style="color: #991b1b; font-size: 13px;">âš ï¸ è­¦å‘Šï¼šåˆªé™¤å€‹æ¡ˆå¾Œç„¡æ³•å¾©åŸ!</p>
                        </div>
                        <button class="btn btn-primary" onclick="executeDeleteClient()" ${!state.token || state.clients.length === 0 ? 'disabled' : ''} style="background: #ef4444;">åˆªé™¤å€‹æ¡ˆ</button>
                    `;
                },
                execute: async () => {
                    const clientId = document.getElementById('delete-client-id').value;

                    const response = await fetch(`${BASE_URL}/api/v1/clients/${clientId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${state.token}`
                        }
                    });

                    // DELETE returns 204 No Content, no JSON to parse
                    const data = response.status === 204 ? { success: true, message: 'å€‹æ¡ˆå·²åˆªé™¤' } : await response.json();

                    // Remove deleted client from state
                    if (response.status === 204) {
                        state.clients = state.clients.filter(c => c.id !== clientId);
                        if (state.currentClient?.id === clientId) {
                            state.currentClient = null;
                        }
                        // Refresh the dropdown list
                        document.getElementById('action-form').innerHTML = steps['delete-client'].renderForm();
                    }

                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card" style="border-color: #10b981;">
                        <h3 style="color: #10b981;">âœ… å€‹æ¡ˆåˆªé™¤æˆåŠŸ</h3>
                        <p style="color: #065f46; font-size: 14px; margin-top: 12px;">è©²å€‹æ¡ˆå·²å¾ç³»çµ±ä¸­ç§»é™¤</p>
                    </div>
                `
            },
            'list-cases': {
                title: 'åˆ—å‡ºå€‹æ¡ˆ',
                subtitle: 'GET /api/v1/cases',
                init: async () => {
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/cases`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.cases = data.items;
                            }
                        } catch (error) {
                            console.error('Failed to fetch cases:', error);
                        }
                    }
                },
                renderForm: () => `
                    ${renderTenantBanner()}
                    <div class="form-group">
                        <label>ç¯©é¸å€‹æ¡ˆ IDï¼ˆé¸å¡«ï¼‰</label>
                        <select id="list-cases-client-id">
                            <option value="">å…¨éƒ¨å€‹æ¡ˆ</option>
                            ${state.clients.map(c => `<option value="${c.id}">${c.name} (${c.code})</option>`).join('')}
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="executeStep('list-cases')" ${!state.token ? 'disabled' : ''}>æŸ¥è©¢å€‹æ¡ˆåˆ—è¡¨</button>
                `,
                execute: async () => {
                    const clientId = document.getElementById('list-cases-client-id').value;
                    const url = clientId
                        ? `${BASE_URL}/api/v1/cases?client_id=${clientId}`
                        : `${BASE_URL}/api/v1/cases`;

                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.cases = data.items;
                    }
                    return { response, data };
                },
                renderPreview: (data) => {
                    let html = `<div class="info-card"><h3>ğŸ“‹ å…± ${data.total} å€‹å€‹æ¡ˆ</h3>`;
                    data.items.forEach(caseItem => {
                        html += `
                            <div class="info-row">
                                <span class="info-label">å€‹æ¡ˆç·¨è™Ÿ</span>
                                <span class="info-value">${caseItem.case_number}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ç‹€æ…‹</span>
                                <span class="info-value">${caseItem.status}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">æ‘˜è¦</span>
                                <span class="info-value">${caseItem.summary || 'ç„¡'}</span>
                            </div>
                            <hr style="margin: 12px 0; border: none; border-top: 1px solid #e5e7eb;">
                        `;
                    });
                    html += `</div>`;
                    return html;
                }
            },
            'create-case': {
                title: 'å»ºç«‹å€‹æ¡ˆ',
                subtitle: 'POST /api/v1/cases',
                init: async () => {
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/clients`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.clients = data.items;
                            }
                        } catch (error) {
                            console.error('Failed to fetch clients:', error);
                        }
                    }
                },
                renderForm: () => `
                    ${renderTenantBanner()}
                    <div class="form-group">
                        <label>é¸æ“‡å®¢æˆ¶ *</label>
                        <select id="create-case-client-id">
                            ${state.clients.map(c => `<option value="${c.id}">${c.name} (${c.code})</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ç‹€æ…‹</label>
                        <select id="create-case-status">
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                            <option value="suspended">Suspended</option>
                            <option value="referred">Referred</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ‘˜è¦</label>
                        <textarea id="create-case-summary" rows="3" placeholder="å€‹æ¡ˆæ‘˜è¦"></textarea>
                    </div>
                    <div class="form-group">
                        <label>ç›®æ¨™</label>
                        <textarea id="create-case-goals" rows="3" placeholder="è«®è©¢ç›®æ¨™"></textarea>
                    </div>
                    <div class="form-group">
                        <label>å•é¡Œæè¿°</label>
                        <textarea id="create-case-problem" rows="3" placeholder="è«®è©¢ç›®çš„æˆ–å•é¡Œæ•˜è¿°"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 24px;">
                        <button class="btn btn-primary" onclick="executeStep('create-case')" ${!state.token || state.clients.length === 0 ? 'disabled' : ''}>å»ºç«‹å€‹æ¡ˆ</button>
                        <button class="btn btn-secondary" onclick="quickFillCase()" ${!state.token || state.clients.length === 0 ? 'disabled' : ''} style="background: #6366f1;">ğŸ² å¿«é€Ÿå¡«å…¥æ¸¬è©¦è³‡æ–™</button>
                    </div>
                `,
                execute: async () => {
                    const caseData = {
                        client_id: document.getElementById('create-case-client-id').value,
                        status: document.getElementById('create-case-status').value,
                        summary: document.getElementById('create-case-summary').value || null,
                        goals: document.getElementById('create-case-goals').value || null,
                        problem_description: document.getElementById('create-case-problem').value || null
                    };

                    const response = await fetch(`${BASE_URL}/api/v1/cases`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(caseData)
                    });
                    const data = await response.json();
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>âœ… å€‹æ¡ˆå»ºç«‹æˆåŠŸ</h3>
                        <div class="info-row">
                            <span class="info-label">å€‹æ¡ˆç·¨è™Ÿ</span>
                            <span class="info-value">${data.case_number}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ID</span>
                            <span class="info-value" style="font-size: 11px;">${data.id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç‹€æ…‹</span>
                            <span class="info-value">${data.status}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æ‘˜è¦</span>
                            <span class="info-value">${data.summary || 'ç„¡'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç›®æ¨™</span>
                            <span class="info-value">${data.goals || 'ç„¡'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å•é¡Œæè¿°</span>
                            <span class="info-value">${data.problem_description || 'ç„¡'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å»ºç«‹æ™‚é–“</span>
                            <span class="info-value">${new Date(data.created_at).toLocaleString('zh-TW')}</span>
                        </div>
                    </div>
                `
            },
            'view-case': {
                title: 'æŸ¥çœ‹å€‹æ¡ˆ',
                subtitle: 'GET /api/v1/cases/{id}',
                init: async () => {
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/cases`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.cases = data.items;
                            }
                        } catch (error) {
                            console.error('Failed to fetch cases:', error);
                        }
                    }
                },
                renderForm: () => `
                    ${renderTenantBanner()}
                    <div class="form-group">
                        <label>é¸æ“‡å€‹æ¡ˆ *</label>
                        <select id="view-case-id">
                            ${state.cases.map(c => `<option value="${c.id}">${c.case_number} - ${c.status}</option>`).join('')}
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="executeStep('view-case')" ${!state.token || state.cases.length === 0 ? 'disabled' : ''}>æŸ¥çœ‹å€‹æ¡ˆ</button>
                `,
                execute: async () => {
                    const caseId = document.getElementById('view-case-id').value;
                    const response = await fetch(`${BASE_URL}/api/v1/cases/${caseId}`, {
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });
                    const data = await response.json();
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>ğŸ“‹ å€‹æ¡ˆè©³æƒ…</h3>
                        <div class="info-row">
                            <span class="info-label">å€‹æ¡ˆç·¨è™Ÿ</span>
                            <span class="info-value">${data.case_number}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ID</span>
                            <span class="info-value" style="font-size: 11px;">${data.id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç‹€æ…‹</span>
                            <span class="info-value">${data.status}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å®¢æˆ¶ ID</span>
                            <span class="info-value" style="font-size: 11px;">${data.client_id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">è«®å•†å¸« ID</span>
                            <span class="info-value" style="font-size: 11px;">${data.counselor_id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æ‘˜è¦</span>
                            <span class="info-value">${data.summary || 'ç„¡'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç›®æ¨™</span>
                            <span class="info-value">${data.goals || 'ç„¡'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å•é¡Œæè¿°</span>
                            <span class="info-value">${data.problem_description || 'ç„¡'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å»ºç«‹æ™‚é–“</span>
                            <span class="info-value">${new Date(data.created_at).toLocaleString('zh-TW')}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æ›´æ–°æ™‚é–“</span>
                            <span class="info-value">${new Date(data.updated_at).toLocaleString('zh-TW')}</span>
                        </div>
                    </div>
                `
            },
            'update-case': {
                title: 'æ›´æ–°å€‹æ¡ˆ',
                subtitle: 'PATCH /api/v1/cases/{id}',
                init: async () => {
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/cases`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.cases = data.items;
                                // Re-render form with updated list
                                document.getElementById('action-form').innerHTML = steps['update-case'].renderForm();
                                // Load data for first case
                                setTimeout(() => loadCaseDataForUpdate(), 100);
                            }
                        } catch (error) {
                            console.error('Failed to fetch cases:', error);
                        }
                    }
                },
                renderForm: () => `
                    ${renderTenantBanner()}
                    <div class="form-group">
                        <label>é¸æ“‡å€‹æ¡ˆ *</label>
                        <select id="update-case-id" onchange="loadCaseDataForUpdate()">
                            ${state.cases.map(c => `<option value="${c.id}">${c.case_number} - ${c.status}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ç‹€æ…‹</label>
                        <select id="update-case-status">
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                            <option value="suspended">Suspended</option>
                            <option value="referred">Referred</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ‘˜è¦</label>
                        <textarea id="update-case-summary" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>ç›®æ¨™</label>
                        <textarea id="update-case-goals" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>å•é¡Œæè¿°</label>
                        <textarea id="update-case-problem" rows="3"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="executeUpdateCase()" ${!state.token || state.cases.length === 0 ? 'disabled' : ''}>æ›´æ–°å€‹æ¡ˆ</button>
                `,
                execute: async () => {
                    const caseId = document.getElementById('update-case-id').value;
                    const updateData = {};

                    const status = document.getElementById('update-case-status').value;
                    const summary = document.getElementById('update-case-summary').value;
                    const goals = document.getElementById('update-case-goals').value;
                    const problem = document.getElementById('update-case-problem').value;

                    if (status) updateData.status = status;
                    if (summary) updateData.summary = summary;
                    if (goals) updateData.goals = goals;
                    if (problem) updateData.problem_description = problem;

                    const response = await fetch(`${BASE_URL}/api/v1/cases/${caseId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    });
                    const data = await response.json();
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>âœ… å€‹æ¡ˆæ›´æ–°æˆåŠŸ</h3>
                        <div class="info-row">
                            <span class="info-label">å€‹æ¡ˆç·¨è™Ÿ</span>
                            <span class="info-value">${data.case_number}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç‹€æ…‹</span>
                            <span class="info-value">${data.status}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æ‘˜è¦</span>
                            <span class="info-value">${data.summary || 'ç„¡'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç›®æ¨™</span>
                            <span class="info-value">${data.goals || 'ç„¡'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å•é¡Œæè¿°</span>
                            <span class="info-value">${data.problem_description || 'ç„¡'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æ›´æ–°æ™‚é–“</span>
                            <span class="info-value">${new Date(data.updated_at).toLocaleString('zh-TW')}</span>
                        </div>
                    </div>
                `
            },
            'delete-case': {
                title: 'åˆªé™¤å€‹æ¡ˆ',
                subtitle: 'DELETE /api/v1/cases/{id}',
                init: async () => {
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/cases`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.cases = data.items;
                            }
                        } catch (error) {
                            console.error('Failed to fetch cases:', error);
                        }
                    }
                },
                renderForm: () => `
                    ${renderTenantBanner()}
                    <div class="form-group">
                        <label>é¸æ“‡è¦åˆªé™¤çš„å€‹æ¡ˆ *</label>
                        <select id="delete-case-id">
                            ${state.cases.map(c => `<option value="${c.id}">${c.case_number} - ${c.status}</option>`).join('')}
                        </select>
                    </div>
                    <div class="info-card" style="background: #fee2e2; border-color: #ef4444;">
                        <p style="color: #991b1b; font-size: 13px;">âš ï¸ è­¦å‘Šï¼šåˆªé™¤å€‹æ¡ˆç‚ºè»Ÿåˆªé™¤ï¼ˆè¨­ç½® deleted_atï¼‰ï¼Œä¸å½±éŸ¿è³‡æ–™å®Œæ•´æ€§</p>
                    </div>
                    <button class="btn btn-primary" onclick="executeStep('delete-case')" ${!state.token || state.cases.length === 0 ? 'disabled' : ''} style="background: #ef4444;">åˆªé™¤å€‹æ¡ˆ</button>
                `,
                execute: async () => {
                    const caseId = document.getElementById('delete-case-id').value;
                    const response = await fetch(`${BASE_URL}/api/v1/cases/${caseId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${state.token}`
                        }
                    });

                    const data = response.status === 204 ? { success: true, message: 'å€‹æ¡ˆå·²åˆªé™¤' } : await response.json();

                    if (response.status === 204) {
                        state.cases = state.cases.filter(c => c.id !== caseId);
                    }

                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card" style="border-color: #10b981;">
                        <h3 style="color: #10b981;">âœ… å€‹æ¡ˆåˆªé™¤æˆåŠŸ</h3>
                        <p style="color: #065f46; font-size: 14px; margin-top: 12px;">è©²å€‹æ¡ˆå·²è»Ÿåˆªé™¤ï¼ˆè¨­ç½® deleted_at æ™‚é–“æˆ³ï¼‰</p>
                    </div>
                `
            },
            'create-session': {
                title: 'å»ºç«‹æœƒè«‡è¨˜éŒ„',
                subtitle: 'POST /api/v1/sessions',
                init: async () => {
                    if (state.token) {
                        try {
                            // Fetch both clients and cases
                            const [clientsRes, casesRes] = await Promise.all([
                                fetch(`${BASE_URL}/api/v1/clients`, {
                                    headers: { 'Authorization': `Bearer ${state.token}` }
                                }),
                                fetch(`${BASE_URL}/api/v1/cases`, {
                                    headers: { 'Authorization': `Bearer ${state.token}` }
                                })
                            ]);
                            if (clientsRes.ok) {
                                const clientsData = await clientsRes.json();
                                state.clients = clientsData.items;
                            }
                            if (casesRes.ok) {
                                const casesData = await casesRes.json();
                                state.cases = casesData.items;
                            }
                        } catch (error) {
                            console.error('Failed to fetch data:', error);
                        }
                    }
                },
                renderForm: () => {
                    // Create a map of client info by ID for quick lookup
                    const clientMap = {};
                    state.clients.forEach(c => {
                        clientMap[c.id] = c;
                    });

                    // Build case options with client name + case number
                    const caseOptions = state.cases.map(caseItem => {
                        const client = clientMap[caseItem.client_id];
                        const clientName = client ? `${client.name} (${client.code})` : 'Unknown Client';
                        return `<option value="${caseItem.id}">${clientName} + ${caseItem.case_number}</option>`;
                    }).join('');

                    return `
                        ${renderTenantBanner()}
                        <div class="form-group">
                            <label>é¸æ“‡å€‹æ¡ˆ *</label>
                            <select id="session-case-id">
                                ${caseOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æœƒè«‡æ—¥æœŸ *</label>
                            <input type="date" id="session-date" value="${new Date().toISOString().split('T')[0]}" />
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label>é–‹å§‹æ™‚é–“</label>
                                <input type="time" id="session-start-time" />
                            </div>
                            <div class="form-group">
                                <label>çµæŸæ™‚é–“</label>
                                <input type="time" id="session-end-time" />
                            </div>
                        </div>

                        <div class="info-card" style="background: #f0fdf4; border-color: #10b981; margin-top: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h4 style="color: #047857; margin: 0;">ğŸ™ï¸ éŒ„éŸ³ç‰‡æ®µ Recordingsï¼ˆæ”¯æ´æœƒè«‡ä¸­æ–·å¾Œç¹¼çºŒï¼‰</h4>
                                <button type="button" class="btn btn-secondary" onclick="addRecordingSegment()" style="background: #10b981; padding: 6px 12px; font-size: 13px;">+ æ–°å¢ç‰‡æ®µ</button>
                            </div>
                            <div id="recordings-container"></div>
                        </div>

                        <div class="form-group">
                            <label>é€å­—ç¨¿å…§å®¹ï¼ˆå®Œæ•´ï¼Œè‡ªå‹•å¾ recordings åŒ¯èšï¼‰</label>
                            <textarea id="session-transcript" placeholder="è¼¸å…¥æœƒè«‡é€å­—ç¨¿..." rows="10"></textarea>
                            <small style="color: #6b7280; font-size: 12px;">ğŸ’¡ è‹¥æœ‰ä½¿ç”¨ Recordingsï¼Œæ­¤æ¬„ä½æœƒè‡ªå‹•åŒ¯èšæ‰€æœ‰ç‰‡æ®µçš„é€å­—ç¨¿</small>
                        </div>
                        <div class="form-group">
                            <label>å‚™è¨»</label>
                            <textarea id="session-notes" placeholder="é¸å¡«" rows="3"></textarea>
                        </div>
                        <div class="info-card" style="background: #eff6ff; border-color: #3b82f6;">
                            <h4 style="color: #1e40af; margin-bottom: 12px;">è«®å•†å¸«åæ€ï¼ˆé¸å¡«ï¼‰</h4>
                            <div class="form-group">
                                <label>æˆ‘å’Œé€™å€‹äººå·¥ä½œçš„æ„Ÿå—æ˜¯ï¼Ÿ</label>
                                <textarea id="reflection-working" placeholder="ä¾‹å¦‚ï¼šæ•´é«”éç¨‹æµæš¢è¼•é¬†ï¼Œé€æ¼¸è´å¾—ä¿¡ä»»..." rows="2"></textarea>
                            </div>
                            <div class="form-group">
                                <label>é€™å€‹æ„Ÿå—çš„åŸå› æ˜¯ï¼Ÿ</label>
                                <textarea id="reflection-source" placeholder="ä¾‹å¦‚ï¼šå€‹æ¡ˆå¾ç·Šå¼µåˆ°é€æ­¥æ”¾é¬†ï¼Œé¡˜æ„é–‹æ”¾å¿ƒæ…‹åˆ†äº«æ›´å¤š..." rows="2"></textarea>
                            </div>
                            <div class="form-group">
                                <label>ç›®å‰çš„å›°é›£ï¼æƒ³æ›´æ·±å…¥çš„åœ°æ–¹æ˜¯ï¼Ÿ</label>
                                <textarea id="reflection-challenges" placeholder="ä¾‹å¦‚ï¼šç•¶è‚¯å®šå€‹æ¡ˆæ™‚ï¼Œä»æœƒæœ‰è‡ªæˆ‘æ‡·ç–‘åæ‡‰..." rows="2"></textarea>
                            </div>
                            <div class="form-group">
                                <label>æˆ‘æœƒæƒ³æ‰¾ç£å°è¨è«–çš„å•é¡Œæ˜¯ï¼Ÿ</label>
                                <textarea id="reflection-supervision" placeholder="ä¾‹å¦‚ï¼šå¦‚ä½•åœ¨æ”¯æŒèˆ‡æŒ‘æˆ°é–“æ‹¿æç¯€å¥..." rows="2"></textarea>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="executeCreateSession()" ${!state.token || state.cases.length === 0 ? 'disabled' : ''}>å»ºç«‹æœƒè«‡è¨˜éŒ„</button>
                            <button class="btn btn-secondary" onclick="quickFillSessionData()" ${!state.token ? 'disabled' : ''} style="background: #6366f1;">ğŸ² å¿«é€Ÿå¡«å…¥æ¸¬è©¦è³‡æ–™</button>
                        </div>
                    `;
                },
                execute: async () => {
                    const sessionDate = document.getElementById('session-date').value;
                    const startTime = document.getElementById('session-start-time').value;
                    const endTime = document.getElementById('session-end-time').value;

                    // Validate session_date is not empty
                    if (!sessionDate) {
                        throw new Error('æœƒè«‡æ—¥æœŸç‚ºå¿…å¡«æ¬„ä½');
                    }

                    const requestBody = {
                        case_id: document.getElementById('session-case-id').value,
                        session_date: sessionDate,  // Should be in YYYY-MM-DD format from input[type=date]
                        transcript: document.getElementById('session-transcript').value,
                        notes: document.getElementById('session-notes').value || null
                    };

                    // Add start_time and end_time if provided (non-empty)
                    if (startTime && startTime.trim()) {
                        requestBody.start_time = `${sessionDate} ${startTime}`;
                    }
                    if (endTime && endTime.trim()) {
                        requestBody.end_time = `${sessionDate} ${endTime}`;
                    }

                    // Add reflection if any field is filled
                    const reflectionWorking = document.getElementById('reflection-working').value;
                    const reflectionSource = document.getElementById('reflection-source').value;
                    const reflectionChallenges = document.getElementById('reflection-challenges').value;
                    const reflectionSupervision = document.getElementById('reflection-supervision').value;

                    if (reflectionWorking || reflectionSource || reflectionChallenges || reflectionSupervision) {
                        requestBody.reflection = {};
                        if (reflectionWorking) requestBody.reflection.working_with_client = reflectionWorking;
                        if (reflectionSource) requestBody.reflection.feeling_source = reflectionSource;
                        if (reflectionChallenges) requestBody.reflection.current_challenges = reflectionChallenges;
                        if (reflectionSupervision) requestBody.reflection.supervision_topics = reflectionSupervision;
                    }

                    // Add recordings if any segments exist
                    const recordings = collectRecordings();
                    if (recordings.length > 0) {
                        requestBody.recordings = recordings;
                    }

                    const response = await fetch(`${BASE_URL}/api/v1/sessions`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.sessions = state.sessions || [];
                        state.sessions.push(data);
                        state.currentSession = data;
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>ğŸ“ é€å­—ç¨¿å·²å„²å­˜</h3>
                        <div class="info-row">
                            <span class="info-label">Session ID</span>
                            <span class="info-value">${data.id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æœƒè«‡ç·¨è™Ÿ</span>
                            <span class="info-value">ç¬¬ ${data.session_number} æ¬¡</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æœƒè«‡æ—¥æœŸ</span>
                            <span class="info-value">${new Date(data.session_date).toLocaleDateString('zh-TW')}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å·²ç”Ÿæˆå ±å‘Š</span>
                            <span class="info-value">${data.has_report ? 'æ˜¯' : 'å¦'}</span>
                        </div>
                    </div>
                `
            },
            'list-sessions': {
                title: 'åˆ—å‡ºæœƒè«‡è¨˜éŒ„',
                subtitle: 'GET /api/v1/sessions',
                init: async () => {
                    // Refresh client list before showing form
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/clients`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.clients = data.items;
                                // Re-render form with updated list
                                document.getElementById('action-form').innerHTML = steps['list-sessions'].renderForm();
                            }
                        } catch (error) {
                            console.error('Failed to refresh client list:', error);
                        }
                    }
                },
                renderForm: () => {
                    const clientOptions = state.clients.map(c =>
                        `<option value="${c.id}">${c.name} (${c.code})</option>`
                    ).join('');

                    return `
                        ${renderTenantBanner()}
                        <div class="form-group">
                            <label>ç¯©é¸å€‹æ¡ˆ (å¯é¸)</label>
                            <select id="filter-session-client-id">
                                <option value="">å…¨éƒ¨</option>
                                ${clientOptions}
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="executeListSessions()" ${!state.token ? 'disabled' : ''}>åˆ—å‡ºé€å­—ç¨¿</button>
                    `;
                },
                execute: async () => {
                    const clientId = document.getElementById('filter-session-client-id').value;
                    const url = clientId
                        ? `${BASE_URL}/api/v1/sessions?client_id=${clientId}`
                        : `${BASE_URL}/api/v1/sessions`;

                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.sessions = data.items;
                    }
                    return { response, data };
                },
                renderPreview: (data) => {
                    if (data.total === 0) {
                        return `<div class="empty-state"><p>å°šç„¡é€å­—ç¨¿è¨˜éŒ„</p></div>`;
                    }
                    return `
                        <div class="info-card">
                            <h3>ğŸ“ é€å­—ç¨¿åˆ—è¡¨ (${data.total})</h3>
                        </div>
                        ${data.items.map(s => `
                            <div class="info-card" style="cursor: pointer;" onclick="state.currentSession = ${JSON.stringify(s).replace(/"/g, '&quot;')}; showStep('view-session');">
                                <div class="info-row">
                                    <span class="info-label">å€‹æ¡ˆå§“å</span>
                                    <span class="info-value">${s.client_name || 'N/A'}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">æœƒè«‡æ—¥æœŸ</span>
                                    <span class="info-value">${new Date(s.session_date).toLocaleDateString('zh-TW')}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">æœƒè«‡ç·¨è™Ÿ</span>
                                    <span class="info-value">ç¬¬ ${s.session_number} æ¬¡</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">å·²ç”Ÿæˆå ±å‘Š</span>
                                    <span class="info-value">${s.has_report ? 'âœ… æ˜¯' : 'âŒ å¦'}</span>
                                </div>
                            </div>
                        `).join('')}
                    `;
                }
            },
            'view-session': {
                title: 'æŸ¥çœ‹æœƒè«‡è©³æƒ…',
                subtitle: 'GET /api/v1/sessions/{id}',
                init: async () => {
                    // Refresh session list before showing view form
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/sessions`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.sessions = data.items;
                                // Re-render form with updated list
                                document.getElementById('action-form').innerHTML = steps['view-session'].renderForm();
                            }
                        } catch (error) {
                            console.error('Failed to refresh session list:', error);
                        }
                    }
                },
                renderForm: () => {
                    const sessionOptions = (state.sessions || []).map(s =>
                        `<option value="${s.id}">${s.client_name || 'æœªçŸ¥'} - ç¬¬ ${s.session_number} æ¬¡ (${new Date(s.session_date).toLocaleDateString('zh-TW')})</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>é¸æ“‡æœƒè«‡è¨˜éŒ„ *</label>
                            <select id="view-session-id">
                                ${sessionOptions}
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="executeViewSession()" ${!state.token || !state.sessions?.length ? 'disabled' : ''}>æŸ¥çœ‹æœƒè«‡è©³æƒ…</button>
                    `;
                },
                execute: async () => {
                    const sessionId = document.getElementById('view-session-id').value;

                    const response = await fetch(`${BASE_URL}/api/v1/sessions/${sessionId}`, {
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.currentSession = data;
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>ğŸ“ æœƒè«‡è©³æƒ…</h3>
                        <div class="info-row">
                            <span class="info-label">å€‹æ¡ˆå§“å</span>
                            <span class="info-value">${data.client_name || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æœƒè«‡æ—¥æœŸ</span>
                            <span class="info-value">${new Date(data.session_date).toLocaleDateString('zh-TW')}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æœƒè«‡ç·¨è™Ÿ</span>
                            <span class="info-value">ç¬¬ ${data.session_number} æ¬¡</span>
                        </div>
                        ${data.start_time ? `
                        <div class="info-row">
                            <span class="info-label">é–‹å§‹æ™‚é–“</span>
                            <span class="info-value">${new Date(data.start_time).toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'})}</span>
                        </div>
                        ` : ''}
                        ${data.end_time ? `
                        <div class="info-row">
                            <span class="info-label">çµæŸæ™‚é–“</span>
                            <span class="info-value">${new Date(data.end_time).toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'})}</span>
                        </div>
                        ` : ''}
                        <div class="info-row">
                            <span class="info-label">å·²ç”Ÿæˆå ±å‘Š</span>
                            <span class="info-value">${data.has_report ? 'âœ… æ˜¯' : 'âŒ å¦'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å»ºç«‹æ™‚é–“</span>
                            <span class="info-value">${new Date(data.created_at).toLocaleString('zh-TW')}</span>
                        </div>
                        ${data.updated_at ? `
                        <div class="info-row">
                            <span class="info-label">æ›´æ–°æ™‚é–“</span>
                            <span class="info-value">${new Date(data.updated_at).toLocaleString('zh-TW')}</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="info-card">
                        <h4>é€å­—ç¨¿å…§å®¹</h4>
                        <p style="white-space: pre-wrap; font-size: 13px; line-height: 1.6;">${data.transcript_text}</p>
                    </div>
                    ${data.summary ? `
                        <div class="info-card">
                            <h4>æœƒè«‡æ‘˜è¦ï¼ˆAI ç”Ÿæˆï¼‰</h4>
                            <p style="font-size: 13px; line-height: 1.6;">${data.summary}</p>
                        </div>
                    ` : ''}
                    ${data.notes ? `
                        <div class="info-card">
                            <h4>å‚™è¨»ï¼ˆäººé¡æ’°å¯«ï¼‰</h4>
                            <p style="font-size: 13px;">${data.notes}</p>
                        </div>
                    ` : ''}
                    ${data.reflection && Object.keys(data.reflection).length > 0 ? `
                        <div class="info-card">
                            <h4>è«®å•†å¸«åæ€ï¼ˆäººé¡æ’°å¯«ï¼‰</h4>
                            ${data.reflection.working_with_client ? `
                                <div style="margin-bottom: 12px;">
                                    <strong style="color: #2563eb;">æˆ‘å’Œé€™å€‹äººå·¥ä½œçš„æ„Ÿå—æ˜¯ï¼Ÿ</strong>
                                    <p style="font-size: 13px; margin-top: 4px; line-height: 1.6;">${data.reflection.working_with_client}</p>
                                </div>
                            ` : ''}
                            ${data.reflection.feeling_source ? `
                                <div style="margin-bottom: 12px;">
                                    <strong style="color: #2563eb;">é€™å€‹æ„Ÿå—çš„åŸå› æ˜¯ï¼Ÿ</strong>
                                    <p style="font-size: 13px; margin-top: 4px; line-height: 1.6;">${data.reflection.feeling_source}</p>
                                </div>
                            ` : ''}
                            ${data.reflection.current_challenges ? `
                                <div style="margin-bottom: 12px;">
                                    <strong style="color: #2563eb;">ç›®å‰çš„å›°é›£ï¼æƒ³æ›´æ·±å…¥çš„åœ°æ–¹æ˜¯ï¼Ÿ</strong>
                                    <p style="font-size: 13px; margin-top: 4px; line-height: 1.6;">${data.reflection.current_challenges}</p>
                                </div>
                            ` : ''}
                            ${data.reflection.supervision_topics ? `
                                <div style="margin-bottom: 12px;">
                                    <strong style="color: #2563eb;">æˆ‘æœƒæƒ³æ‰¾ç£å°è¨è«–çš„å•é¡Œæ˜¯ï¼Ÿ</strong>
                                    <p style="font-size: 13px; margin-top: 4px; line-height: 1.6;">${data.reflection.supervision_topics}</p>
                                </div>
                            ` : ''}
                            ${!data.reflection.working_with_client && !data.reflection.feeling_source && !data.reflection.current_challenges && !data.reflection.supervision_topics ? `
                                <p style="font-size: 13px; color: #6b7280;">ï¼ˆè‡ªè¨‚æ ¼å¼åæ€è³‡æ–™ï¼‰</p>
                                <pre style="font-size: 12px; background: #f3f4f6; padding: 12px; border-radius: 4px; overflow-x: auto;">${JSON.stringify(data.reflection, null, 2)}</pre>
                            ` : ''}
                        </div>
                    ` : ''}
                `
            },
            'update-session': {
                title: 'æ›´æ–°æœƒè«‡è¨˜éŒ„',
                subtitle: 'PATCH /api/v1/sessions/{id}',
                init: async () => {
                    // Refresh session list before showing update form
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/sessions`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.sessions = data.items;
                                // Re-render form with updated list
                                document.getElementById('action-form').innerHTML = steps['update-session'].renderForm();
                                // Load data for first session
                                setTimeout(() => loadSessionForUpdate(), 100);
                            }
                        } catch (error) {
                            console.error('Failed to refresh session list:', error);
                        }
                    }
                },
                renderForm: () => {
                    const sessionOptions = (state.sessions || []).map(s =>
                        `<option value="${s.id}">${s.client_name || 'æœªçŸ¥'} - ç¬¬ ${s.session_number} æ¬¡ (${new Date(s.session_date).toLocaleDateString('zh-TW')})</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>é¸æ“‡æœƒè«‡è¨˜éŒ„ *</label>
                            <select id="update-session-id" onchange="loadSessionForUpdate()">
                                ${sessionOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æœƒè«‡æ—¥æœŸ</label>
                            <input type="date" id="update-session-date" />
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label>é–‹å§‹æ™‚é–“</label>
                                <input type="time" id="update-session-start-time" />
                            </div>
                            <div class="form-group">
                                <label>çµæŸæ™‚é–“</label>
                                <input type="time" id="update-session-end-time" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label>é€å­—ç¨¿å…§å®¹</label>
                            <textarea id="update-session-transcript" placeholder="æ›´æ–°é€å­—ç¨¿..." rows="10"></textarea>
                        </div>
                        <div class="form-group">
                            <label>å‚™è¨»</label>
                            <textarea id="update-session-notes" placeholder="æ›´æ–°å‚™è¨»" rows="3"></textarea>
                        </div>
                        <div class="info-card" style="background: #eff6ff; border-color: #3b82f6;">
                            <h4 style="color: #1e40af; margin-bottom: 12px;">è«®å•†å¸«åæ€ï¼ˆé¸å¡«ï¼‰</h4>
                            <div class="form-group">
                                <label>æˆ‘å’Œé€™å€‹äººå·¥ä½œçš„æ„Ÿå—æ˜¯ï¼Ÿ</label>
                                <textarea id="update-reflection-working" placeholder="ä¾‹å¦‚ï¼šæ•´é«”éç¨‹æµæš¢è¼•é¬†ï¼Œé€æ¼¸è´å¾—ä¿¡ä»»..." rows="2"></textarea>
                            </div>
                            <div class="form-group">
                                <label>é€™å€‹æ„Ÿå—çš„åŸå› æ˜¯ï¼Ÿ</label>
                                <textarea id="update-reflection-source" placeholder="ä¾‹å¦‚ï¼šå€‹æ¡ˆå¾ç·Šå¼µåˆ°é€æ­¥æ”¾é¬†ï¼Œé¡˜æ„é–‹æ”¾å¿ƒæ…‹åˆ†äº«æ›´å¤š..." rows="2"></textarea>
                            </div>
                            <div class="form-group">
                                <label>ç›®å‰çš„å›°é›£ï¼æƒ³æ›´æ·±å…¥çš„åœ°æ–¹æ˜¯ï¼Ÿ</label>
                                <textarea id="update-reflection-challenges" placeholder="ä¾‹å¦‚ï¼šç•¶è‚¯å®šå€‹æ¡ˆæ™‚ï¼Œä»æœƒæœ‰è‡ªæˆ‘æ‡·ç–‘åæ‡‰..." rows="2"></textarea>
                            </div>
                            <div class="form-group">
                                <label>æˆ‘æœƒæƒ³æ‰¾ç£å°è¨è«–çš„å•é¡Œæ˜¯ï¼Ÿ</label>
                                <textarea id="update-reflection-supervision" placeholder="ä¾‹å¦‚ï¼šå¦‚ä½•åœ¨æ”¯æŒèˆ‡æŒ‘æˆ°é–“æ‹¿æç¯€å¥..." rows="2"></textarea>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="executeUpdateSession()" ${!state.token || !state.sessions?.length ? 'disabled' : ''}>æ›´æ–°æœƒè«‡è¨˜éŒ„</button>
                    `;
                },
                execute: async () => {
                    const sessionId = document.getElementById('update-session-id').value;
                    const updateData = {};

                    const sessionDate = document.getElementById('update-session-date').value;
                    const startTime = document.getElementById('update-session-start-time').value;
                    const endTime = document.getElementById('update-session-end-time').value;
                    const transcript = document.getElementById('update-session-transcript').value;
                    const notes = document.getElementById('update-session-notes').value;

                    if (sessionDate) updateData.session_date = sessionDate;
                    if (startTime && sessionDate) updateData.start_time = `${sessionDate} ${startTime}`;
                    if (endTime && sessionDate) updateData.end_time = `${sessionDate} ${endTime}`;
                    if (transcript) updateData.transcript = transcript;
                    if (notes) updateData.notes = notes;

                    // Add reflection if any field is filled
                    const reflectionWorking = document.getElementById('update-reflection-working').value;
                    const reflectionSource = document.getElementById('update-reflection-source').value;
                    const reflectionChallenges = document.getElementById('update-reflection-challenges').value;
                    const reflectionSupervision = document.getElementById('update-reflection-supervision').value;

                    if (reflectionWorking || reflectionSource || reflectionChallenges || reflectionSupervision) {
                        updateData.reflection = {};
                        if (reflectionWorking) updateData.reflection.working_with_client = reflectionWorking;
                        if (reflectionSource) updateData.reflection.feeling_source = reflectionSource;
                        if (reflectionChallenges) updateData.reflection.current_challenges = reflectionChallenges;
                        if (reflectionSupervision) updateData.reflection.supervision_topics = reflectionSupervision;
                    }

                    const response = await fetch(`${BASE_URL}/api/v1/sessions/${sessionId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.currentSession = data;
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card" style="border-color: #10b981;">
                        <h3 style="color: #10b981;">âœ… æœƒè«‡è¨˜éŒ„æ›´æ–°æˆåŠŸ</h3>
                        <div class="info-row">
                            <span class="info-label">æœƒè«‡æ—¥æœŸ</span>
                            <span class="info-value">${new Date(data.session_date).toLocaleDateString('zh-TW')}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æ›´æ–°æ™‚é–“</span>
                            <span class="info-value">${new Date(data.updated_at).toLocaleString('zh-TW')}</span>
                        </div>
                    </div>
                `
            },
            'delete-session': {
                title: 'åˆªé™¤æœƒè«‡è¨˜éŒ„',
                subtitle: 'DELETE /api/v1/sessions/{id}',
                init: async () => {
                    // Refresh session list before showing delete form
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/sessions`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.sessions = data.items;
                                // Re-render form with updated list
                                document.getElementById('action-form').innerHTML = steps['delete-session'].renderForm();
                            }
                        } catch (error) {
                            console.error('Failed to refresh session list:', error);
                        }
                    }
                },
                renderForm: () => {
                    const sessionOptions = (state.sessions || []).map(s =>
                        `<option value="${s.id}">${s.client_name || 'æœªçŸ¥'} - ç¬¬ ${s.session_number} æ¬¡ (${new Date(s.session_date).toLocaleDateString('zh-TW')})</option>`
                    ).join('');

                    return `
                        ${renderTenantBanner()}
                        <div class="form-group">
                            <label>é¸æ“‡æœƒè«‡è¨˜éŒ„ *</label>
                            <select id="delete-session-id">
                                ${sessionOptions}
                            </select>
                        </div>
                        <div class="info-card" style="background: #fee2e2; border-color: #ef4444;">
                            <p style="color: #991b1b; font-size: 13px;">âš ï¸ è­¦å‘Šï¼šç„¡æ³•åˆªé™¤å·²ç”Ÿæˆå ±å‘Šçš„æœƒè«‡è¨˜éŒ„!</p>
                        </div>
                        <button class="btn btn-primary" onclick="executeDeleteSession()" ${!state.token || !state.sessions?.length ? 'disabled' : ''} style="background: #ef4444;">åˆªé™¤æœƒè«‡è¨˜éŒ„</button>
                    `;
                },
                execute: async () => {
                    const sessionId = document.getElementById('delete-session-id').value;

                    const response = await fetch(`${BASE_URL}/api/v1/sessions/${sessionId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });

                    const data = response.status === 204 ? { success: true, message: 'é€å­—ç¨¿å·²åˆªé™¤' } : await response.json();
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card" style="border-color: #10b981;">
                        <h3 style="color: #10b981;">âœ… é€å­—ç¨¿åˆªé™¤æˆåŠŸ</h3>
                        <p style="color: #065f46; font-size: 14px; margin-top: 12px;">è©²é€å­—ç¨¿å·²å¾ç³»çµ±ä¸­ç§»é™¤</p>
                    </div>
                `
            },
            'update-counselor': {
                title: 'æ›´æ–°è«®å•†å¸«è³‡è¨Š',
                subtitle: 'PATCH /api/auth/me',
                renderForm: () => `
                    <div class="info-card">
                        <p style="font-size: 13px; color: #6b7280;">ç•¶å‰ç”¨æˆ¶: ${state.currentUser?.full_name || 'N/A'}</p>
                    </div>
                    <div class="form-group">
                        <label>å…¨å</label>
                        <input type="text" id="update-counselor-fullname" placeholder="æ›´æ–°å…¨å" value="${state.currentUser?.full_name || ''}" />
                    </div>
                    <div class="form-group">
                        <label>ç”¨æˆ¶å</label>
                        <input type="text" id="update-counselor-username" placeholder="æ›´æ–°ç”¨æˆ¶å" value="${state.currentUser?.username || ''}" />
                    </div>
                    <button class="btn btn-primary" onclick="executeUpdateCounselor()" ${!state.token || !state.currentUser ? 'disabled' : ''}>æ›´æ–°è³‡è¨Š</button>
                `,
                execute: async () => {
                    const updateData = {};

                    const fullName = document.getElementById('update-counselor-fullname').value;
                    const username = document.getElementById('update-counselor-username').value;

                    if (fullName) updateData.full_name = fullName;
                    if (username) updateData.username = username;

                    const response = await fetch(`${BASE_URL}/api/auth/me`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.currentUser = data;
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>âœ… è«®å•†å¸«è³‡è¨Šæ›´æ–°æˆåŠŸ</h3>
                        <div class="info-row">
                            <span class="info-label">å…¨å</span>
                            <span class="info-value">${data.full_name}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç”¨æˆ¶å</span>
                            <span class="info-value">${data.username}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Email</span>
                            <span class="info-value">${data.email}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">è§’è‰²</span>
                            <span class="info-value">${data.role}</span>
                        </div>
                    </div>
                `
            },
            'generate-report': {
                title: 'ç”Ÿæˆå ±å‘Š',
                subtitle: 'POST /api/v1/reports/generate',
                init: async () => {
                    // Refresh sessions list to get latest data with has_report status
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/sessions`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.sessions = data.items;
                                // Re-render form with updated list
                                document.getElementById('action-form').innerHTML = steps['generate-report'].renderForm();
                            }
                        } catch (error) {
                            console.error('Failed to refresh session list:', error);
                        }
                    }
                },
                renderForm: () => {
                    // Filter sessions that don't have reports yet
                    const sessionsWithoutReports = (state.sessions || []).filter(s => !s.has_report);

                    if (sessionsWithoutReports.length === 0) {
                        return `
                            ${renderTenantBanner()}
                            <div class="info-card" style="background: #fef3c7; border-color: #f59e0b;">
                                <p style="color: #92400e;">âš ï¸ æ²’æœ‰æœªç”Ÿæˆå ±å‘Šçš„é€å­—ç¨¿ã€‚è«‹å…ˆå„²å­˜é€å­—ç¨¿ã€‚</p>
                            </div>
                        `;
                    }

                    const sessionOptions = sessionsWithoutReports.map(s =>
                        `<option value="${s.id}">${s.client_name} - ç¬¬${s.session_number}æ¬¡ (${new Date(s.session_date).toLocaleDateString('zh-TW')})</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>é¸æ“‡æœƒè«‡è¨˜éŒ„ * (åƒ…é¡¯ç¤ºæœªç”Ÿæˆå ±å‘Šçš„è¨˜éŒ„)</label>
                            <select id="report-session-id">
                                ${sessionOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>å ±å‘Šé¡å‹</label>
                            <select id="report-type">
                                <option value="enhanced">Enhanced (10æ®µå¼)</option>
                                <option value="legacy">Legacy (5æ®µå¼)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>RAG ç³»çµ±</label>
                            <select id="report-rag">
                                <option value="openai">OpenAI (GPT-4.1 Mini)</option>
                                <option value="gemini">Gemini 2.5 Flash</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="executeGenerateReport()" ${!state.token ? 'disabled' : ''}>ç”Ÿæˆå ±å‘Š</button>
                    `;
                },
                execute: async () => {
                    const reportData = {
                        session_id: document.getElementById('report-session-id').value,
                        report_type: document.getElementById('report-type').value,
                        rag_system: document.getElementById('report-rag').value
                    };

                    const response = await fetch(`${BASE_URL}/api/v1/reports/generate`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(reportData)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.currentReport = data;
                    }
                    return { response, data };
                },
                renderPreview: (data) => {
                    // æª¢æŸ¥æ˜¯å¦æ˜¯ processing ç‹€æ…‹
                    if (data.report?.status === 'processing') {
                        // é–‹å§‹è¼ªè©¢
                        setTimeout(() => pollReportStatus(data.report_id), 3000);

                        return `
                            <div class="info-card" style="background: #fef3c7; border-color: #f59e0b;">
                                <h3>â³ å ±å‘Šç”Ÿæˆä¸­...</h3>
                                <p style="color: #92400e; margin-top: 12px;">é€å­—ç¨¿å·²ä¿å­˜ï¼Œå ±å‘Šæ­£åœ¨èƒŒæ™¯ç”Ÿæˆä¸­ï¼Œè«‹ç¨å€™</p>
                                <div class="info-row">
                                    <span class="info-label">Report ID</span>
                                    <span class="info-value" style="font-size: 11px;">${data.report_id}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Session ID</span>
                                    <span class="info-value" style="font-size: 11px;">${data.session_id}</span>
                                </div>
                                <div id="polling-status" style="margin-top: 16px; padding: 12px; background: white; border-radius: 6px;">
                                    <p style="font-size: 13px; color: #6b7280;">æ­£åœ¨æŸ¥è©¢ç‹€æ…‹...</p>
                                </div>
                            </div>
                        `;
                    }

                    const report = data.report?.report || {};
                    const quality = data.quality_summary || {};

                    return `
                        ${quality.grade ? `
                            <div class="quality-summary">
                                <div class="quality-grade">${quality.grade}</div>
                                <div class="quality-score">è©•åˆ†ï¼š${quality.overall_score} / 100</div>
                            </div>
                        ` : ''}

                        <div class="info-card">
                            <h3>ğŸ“Š å ±å‘ŠåŸºæœ¬è³‡è¨Š</h3>
                            <div class="info-row">
                                <span class="info-label">Report ID</span>
                                <span class="info-value" style="font-size: 11px;">${data.report_id}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Session ID</span>
                                <span class="info-value" style="font-size: 11px;">${data.session_id}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">æ¨¡å¼</span>
                                <span class="info-value">${data.report?.mode || 'N/A'}</span>
                            </div>
                        </div>

                        ${report.client_info ? `
                            <div class="report-section">
                                <h3>ğŸ‘¤ æ¡ˆä¸»è³‡æ–™</h3>
                                <div class="info-card">
                                    <div class="info-row">
                                        <span class="info-label">å§“å</span>
                                        <span class="info-value">${report.client_info.name || 'N/A'}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">æ€§åˆ¥</span>
                                        <span class="info-value">${report.client_info.gender || 'N/A'}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">å¹´é½¡</span>
                                        <span class="info-value">${report.client_info.age || 'N/A'}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">è·æ¥­</span>
                                        <span class="info-value">${report.client_info.occupation || 'N/A'}</span>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        ${report.main_concerns?.length ? `
                            <div class="report-section">
                                <h3>ğŸ¯ ä¸»è¦è­°é¡Œ</h3>
                                <ul>
                                    ${report.main_concerns.map(c => `<li>${c}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}

                        ${report.conceptualization ? `
                            <div class="report-section">
                                <h3>ğŸ’¡ å€‹æ¡ˆæ¦‚å¿µåŒ–</h3>
                                <p>${report.conceptualization}</p>
                            </div>
                        ` : ''}

                        ${report.theories?.length ? `
                            <div class="report-section">
                                <h3>ğŸ“š ç†è«–å¼•ç”¨</h3>
                                ${report.theories.slice(0, 3).map(t => `
                                    <div class="theory-item">
                                        <p>${t.text}</p>
                                        <div class="theory-meta">
                                            ç›¸ä¼¼åº¦: ${(t.score * 100).toFixed(1)}% | ä¾†æº: ${t.document}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    `;
                }
            },
            'list-reports': {
                title: 'åˆ—å‡ºå ±å‘Š',
                subtitle: 'GET /api/v1/reports',
                renderForm: () => {
                    const hasClients = state.clients.length > 0;
                    const clientOptions = state.clients.map(c =>
                        `<option value="${c.id}">${c.name} (${c.code})</option>`
                    ).join('');
                    return `
                        ${renderTenantBanner()}
                        ${!hasClients ? '<div class="alert alert-warning" style="background: #fff3cd; border: 1px solid #ffc107; padding: 12px; border-radius: 6px; margin-bottom: 16px; color: #856404;"><strong>âš ï¸ æç¤ºï¼š</strong> è«‹å…ˆåŸ·è¡Œã€Œåˆ—å‡ºå€‹æ¡ˆã€æ­¥é©Ÿä»¥è¼‰å…¥å€‹æ¡ˆæ¸…å–®ï¼Œæ‰èƒ½ä½¿ç”¨ç¯©é¸åŠŸèƒ½</div>' : ''}
                        <div class="form-group">
                            <label>ç¯©é¸å€‹æ¡ˆ (é¸å¡«)</label>
                            <select id="filter-client-id" ${!hasClients ? 'disabled' : ''}>
                                <option value="">å…¨éƒ¨å€‹æ¡ˆ</option>
                                ${clientOptions}
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="executeListReports()" ${!state.token ? 'disabled' : ''}>æŸ¥è©¢å ±å‘Š</button>
                    `;
                },
                execute: async () => {
                    const clientId = document.getElementById('filter-client-id')?.value;
                    const url = clientId
                        ? `${BASE_URL}/api/v1/reports?client_id=${clientId}`
                        : `${BASE_URL}/api/v1/reports`;

                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.reports = data.items;
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <h3>ğŸ“‹ å ±å‘Šåˆ—è¡¨ (å…± ${data.total} ç­†)</h3>
                    ${data.items.map(report => `
                        <div class="info-card">
                            <div class="info-row">
                                <span class="info-label">å€‹æ¡ˆ/æ¬¡æ•¸</span>
                                <span class="info-value">${report.client_name || 'N/A'} - ç¬¬ ${report.session_number || '?'} æ¬¡</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ID</span>
                                <span class="info-value" style="font-size: 11px;">${report.id}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">æ¨¡å¼</span>
                                <span class="info-value">${report.mode}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ç‹€æ…‹</span>
                                <span class="info-value">${report.status}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">è©•åˆ†</span>
                                <span class="info-value">${report.quality_grade || 'N/A'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">å»ºç«‹æ™‚é–“</span>
                                <span class="info-value">${new Date(report.created_at).toLocaleString('zh-TW')}</span>
                            </div>
                        </div>
                    `).join('')}
                `
            },
            'view-report': {
                title: 'æŸ¥çœ‹å ±å‘Š',
                subtitle: 'GET /api/v1/reports/{id}',
                renderForm: () => {
                    const reportOptions = state.reports.map(r =>
                        `<option value="${r.id}">${r.client_name || 'Client'} - ç¬¬${r.session_number || '?'}æ¬¡ (${new Date(r.created_at).toLocaleDateString('zh-TW')})</option>`
                    ).join('');

                    return `
                        <div class="info-card" style="background: #e0f2fe; border-color: #3b82f6; margin-bottom: 16px;">
                            <p style="color: #1e40af; font-size: 12px;">
                                ğŸ’¡ æ”¯æ´å¤šç¨®è¼¸å‡ºæ ¼å¼ï¼šä¸å‚³åƒæ•¸è¿”å›å®Œæ•´ metadataï¼Œæˆ–ä½¿ç”¨ format åƒæ•¸è¼¸å‡º Markdown/HTML
                            </p>
                        </div>
                        <div class="form-group">
                            <label>é¸æ“‡å ±å‘Š</label>
                            <select id="view-report-id">
                                ${state.currentReport ? `<option value="${state.currentReport.report_id}" selected>Current Report</option>` : ''}
                                ${reportOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>è¼¸å‡ºæ ¼å¼</label>
                            <select id="view-report-format">
                                <option value="">JSON metadata (é è¨­)</option>
                                <option value="markdown">Markdown</option>
                                <option value="html">HTML</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ç‰ˆæœ¬é¸æ“‡</label>
                            <select id="view-report-use-edited">
                                <option value="true">ç·¨è¼¯ç‰ˆ (å„ªå…ˆ)</option>
                                <option value="false">AI åŸå§‹ç‰ˆ</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="executeViewReport()" ${!state.token || (!state.currentReport && state.reports.length === 0) ? 'disabled' : ''}>æŸ¥çœ‹å ±å‘Š</button>
                    `;
                },
                execute: async () => {
                    const reportId = document.getElementById('view-report-id').value;
                    const format = document.getElementById('view-report-format').value;
                    const useEdited = document.getElementById('view-report-use-edited').value;

                    let url = `${BASE_URL}/api/v1/reports/${reportId}`;
                    const params = new URLSearchParams();
                    if (format) params.append('format', format);
                    params.append('use_edited', useEdited);

                    if (params.toString()) {
                        url += `?${params.toString()}`;
                    }

                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });
                    const data = await response.json();
                    return { response, data, format: format || 'json' };
                },
                renderPreview: (result) => {
                    // Handle error response
                    if (!result || !result.data) {
                        return '<div class="info-card" style="background: #fee2e2; border-color: #ef4444;"><p style="color: #991b1b;">ç„¡æ³•è¼‰å…¥å ±å‘Š</p></div>';
                    }

                    const { data, format } = result;

                    if (format === 'json') {
                        const content = data.content_json?.report || data.content_json || {};
                        return `
                            <div class="info-card">
                                <h3>ğŸ“„ å ±å‘Šè©³æƒ… (JSON)</h3>
                                <div class="info-row">
                                    <span class="info-label">ID</span>
                                    <span class="info-value" style="font-size: 11px;">${data.id}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">ç‹€æ…‹</span>
                                    <span class="info-value">${data.status}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">è©•åˆ†</span>
                                    <span class="info-value">${data.quality_grade || 'N/A'} (${data.quality_score || 'N/A'})</span>
                                </div>
                            </div>
                            <div style="background: #1e293b; border-radius: 8px; padding: 20px; max-height: 600px; overflow-y: auto;">
                                <pre style="margin: 0; color: #e2e8f0; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">${JSON.stringify(content, null, 2)}</pre>
                            </div>
                        `;
                    }

                    // Markdown or HTML format - Render nicely
                    const isEdited = (data.is_edited === true) ? 'âœï¸ ç·¨è¼¯ç‰ˆ' : 'ğŸ¤– AI åŸå§‹ç‰ˆ';
                    const formattedContent = data.formatted_content || '';

                    if (format === 'markdown') {
                        // Use marked.js to render Markdown to HTML
                        const htmlContent = marked.parse(formattedContent);

                        return `
                            <div class="info-card">
                                <h3>ğŸ“„ å ±å‘Šå…§å®¹ (${isEdited})</h3>
                                <div class="info-row">
                                    <span class="info-label">æ ¼å¼</span>
                                    <span class="info-value">Markdown (æ¸²æŸ“)</span>
                                </div>
                                ${data.edited_at ? `
                                <div class="info-row">
                                    <span class="info-label">æœ€å¾Œç·¨è¼¯</span>
                                    <span class="info-value">${new Date(data.edited_at).toLocaleString('zh-TW')}</span>
                                </div>
                                ` : ''}
                            </div>
                            <div class="markdown-content" style="max-height: 600px; overflow-y: auto; padding: 24px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; color: #1f2937;">
                                ${htmlContent}
                            </div>
                            <style>
                                .markdown-content h1 { color: #1e40af; margin: 28px 0 14px; font-size: 28px; }
                                .markdown-content h2 { color: #1e40af; margin: 24px 0 12px; font-size: 24px; }
                                .markdown-content h3 { color: #1e40af; margin: 20px 0 10px; font-size: 20px; }
                                .markdown-content p { margin: 12px 0; line-height: 1.8; }
                                .markdown-content ul, .markdown-content ol { margin: 12px 0; padding-left: 24px; }
                                .markdown-content li { margin: 4px 0; }
                                .markdown-content strong { font-weight: 600; }
                                .markdown-content code { background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: 'Courier New', monospace; }
                                .markdown-content pre { background: #1e293b; color: #e2e8f0; padding: 16px; border-radius: 8px; overflow-x: auto; }
                                .markdown-content blockquote { border-left: 4px solid #3b82f6; padding-left: 16px; color: #6b7280; margin: 12px 0; }
                            </style>
                        `;
                    } else if (format === 'html') {
                        // HTML format - render as HTML
                        return `
                            <div class="info-card">
                                <h3>ğŸ“„ å ±å‘Šå…§å®¹ (${isEdited})</h3>
                                <div class="info-row">
                                    <span class="info-label">æ ¼å¼</span>
                                    <span class="info-value">HTML</span>
                                </div>
                                ${data.edited_at ? `
                                <div class="info-row">
                                    <span class="info-label">æœ€å¾Œç·¨è¼¯</span>
                                    <span class="info-value">${new Date(data.edited_at).toLocaleString('zh-TW')}</span>
                                </div>
                                ` : ''}
                            </div>
                            <div style="max-height: 600px; overflow-y: auto; padding: 24px; background: white; border: 1px solid #e5e7eb; border-radius: 8px;">
                                ${formattedContent}
                            </div>
                        `;
                    } else {
                        // Unknown format
                        return `
                            <div class="info-card">
                                <h3>ğŸ“„ å ±å‘Šå…§å®¹ (${isEdited})</h3>
                            </div>
                            <div style="background: #1e293b; border-radius: 8px; padding: 20px; max-height: 600px; overflow-y: auto;">
                                <pre style="margin: 0; color: #e2e8f0; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">${formattedContent}</pre>
                            </div>
                        `;
                    }
                }
            },
            'update-report': {
                title: 'æ›´æ–°å ±å‘Š',
                subtitle: 'PATCH /api/v1/reports/{id} (åƒ…ä¾› iOS ä½¿ç”¨)',
                renderForm: () => {
                    return `
                        <div class="info-card" style="background: #fef3c7; border-color: #f59e0b;">
                            <p style="color: #92400e; font-size: 12px;">
                                âš ï¸ æ­¤ API åƒ…ä¾› iOS App ä½¿ç”¨ï¼Œç”¨æ–¼æäº¤è«®å•†å¸«ç·¨è¼¯å¾Œçš„å ±å‘Šå…§å®¹ã€‚<br>
                                Web Console ä¸æä¾›ç·¨è¼¯åŠŸèƒ½ã€‚
                            </p>
                        </div>
                        <button class="btn btn-secondary" disabled>æ­¤åŠŸèƒ½åƒ…ä¾› iOS ä½¿ç”¨</button>
                    `;
                },
                execute: async () => {
                    const reportId = document.getElementById('update-report-id').value;
                    const contentText = document.getElementById('update-report-content').value;

                    let editedContent;
                    try {
                        editedContent = JSON.parse(contentText);
                    } catch (e) {
                        throw new Error('Invalid JSON format');
                    }

                    const response = await fetch(`${BASE_URL}/api/v1/reports/${reportId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ edited_content_json: editedContent })
                    });
                    const data = await response.json();
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>âœ… å ±å‘Šæ›´æ–°æˆåŠŸ</h3>
                        <div class="info-row">
                            <span class="info-label">Report ID</span>
                            <span class="info-value" style="font-size: 11px;">${data.id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç·¨è¼¯æ™‚é–“</span>
                            <span class="info-value">${new Date(data.edited_at).toLocaleString('zh-TW')}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç·¨è¼¯æ¬¡æ•¸</span>
                            <span class="info-value">${data.edit_count}</span>
                        </div>
                    </div>
                    <div class="report-section">
                        <h3>ğŸ“ æ ¼å¼åŒ– Markdown</h3>
                        <div class="response-content" style="max-height: 400px; white-space: pre-wrap;">${data.formatted_markdown}</div>
                    </div>
                `
            },

            // ================== UI-0: Mobile Login ==================
            'ui-mobile-login': {
                title: 'ğŸ“± ç™»å…¥é é¢ (æ‰‹æ©Ÿæ¨¡æ“¬)',
                subtitle: 'POST /api/auth/login',
                renderForm: () => {
                    return `
                        <div class="info-card">
                            <p>ğŸ“± æ‰‹æ©Ÿé¢¨æ ¼çš„ç™»å…¥é é¢</p>
                            <p style="color: #86868b; font-size: 14px; margin-top: 8px;">â€¢ ä½¿ç”¨æ—¢æœ‰çš„ /api/auth/login API</p>
                            <p style="color: #86868b; font-size: 14px;">â€¢ é»æ“Šå³å´é è¦½æŸ¥çœ‹</p>
                        </div>
                        <div class="form-group">
                            <label>æ¸¬è©¦å¸³è™Ÿ Email</label>
                            <input type="email" id="ui-login-email" value="counselor1@example.com" />
                        </div>
                        <div class="form-group">
                            <label>æ¸¬è©¦å¸³è™Ÿå¯†ç¢¼</label>
                            <input type="password" id="ui-login-password" value="password123" />
                        </div>
                        <div class="form-group">
                            <label>Tenant ID</label>
                            <input type="text" id="ui-login-tenant" value="career" />
                        </div>
                        <button class="btn btn-primary" onclick="executeStep('ui-mobile-login')">è¼‰å…¥é è¦½ + æ¸¬è©¦ç™»å…¥</button>
                    `;
                },
                execute: async () => {
                    const email = document.getElementById('ui-login-email').value;
                    const password = document.getElementById('ui-login-password').value;
                    const tenant_id = document.getElementById('ui-login-tenant').value;

                    const response = await fetch(`${BASE_URL}/api/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password, tenant_id })
                    });
                    const data = await response.json();

                    // Store token if login successful
                    if (response.ok && data.access_token) {
                        state.token = data.access_token;
                    }

                    return { response, data };
                },
                renderPreview: (data) => {
                    if (data.access_token) {
                        // Show success message
                        return `
                            <div class="iphone-preview" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center;">
                                <div style="text-align: center; color: white;">
                                    <div style="font-size: 72px; margin-bottom: 20px;">âœ…</div>
                                    <h2 style="margin: 0; font-size: 32px; font-weight: 600;">ç™»å…¥æˆåŠŸï¼</h2>
                                    <p style="margin-top: 12px; font-size: 18px; opacity: 0.9;">Token å·²å„²å­˜</p>
                                    <div style="margin-top: 30px; padding: 20px; background: rgba(255,255,255,0.2); border-radius: 16px; font-size: 12px; font-family: monospace; word-break: break-all;">
                                        ${data.access_token.substring(0, 50)}...
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    // Show login form preview
                    return `
                        <div class="iphone-preview">
                            <!-- Status Bar -->
                            <div style="padding: 12px 24px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; font-weight: 500;">
                                <span>9:41</span>
                                <div style="display: flex; gap: 6px; align-items: center;">
                                    <span>ğŸ“¶</span>
                                    <span>ğŸ“¡</span>
                                    <span>ğŸ”‹</span>
                                </div>
                            </div>

                            <!-- Login Form -->
                            <div style="flex: 1; display: flex; flex-direction: column; padding: 40px 32px; background: #f5f5f7;">
                                <div style="flex: 1;">
                                    <h1 style="font-size: 48px; font-weight: 700; margin: 0; color: #1d1d1f;">Welcome</h1>

                                    <div style="margin-top: 60px;">
                                        <!-- Email Input -->
                                        <div style="background: #e8e8ed; border-radius: 12px; padding: 16px 20px; margin-bottom: 16px;">
                                            <input type="email"
                                                   placeholder="é›»å­ä¿¡ç®±"
                                                   value="counselor1@example.com"
                                                   readonly
                                                   style="width: 100%; border: none; background: transparent; font-size: 16px; color: #1d1d1f; outline: none;" />
                                        </div>

                                        <!-- Password Input -->
                                        <div style="background: #e8e8ed; border-radius: 12px; padding: 16px 20px;">
                                            <input type="password"
                                                   placeholder="å¯†ç¢¼"
                                                   value="password123"
                                                   readonly
                                                   style="width: 100%; border: none; background: transparent; font-size: 16px; color: #1d1d1f; outline: none;" />
                                        </div>
                                    </div>
                                </div>

                                <!-- Login Button -->
                                <div>
                                    <button style="
                                        width: 100%;
                                        background: #8e8e93;
                                        color: white;
                                        border: none;
                                        border-radius: 12px;
                                        padding: 18px;
                                        font-size: 18px;
                                        font-weight: 600;
                                        margin-bottom: 20px;
                                        cursor: not-allowed;
                                    ">Login</button>

                                    <div style="text-align: center;">
                                        <a href="#" style="color: #8e8e93; font-size: 14px; text-decoration: none;">å¿˜è¨˜å¯†ç¢¼</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            },

            'ui-client-case-list': {
                title: 'ğŸ“± å®¢æˆ¶å€‹æ¡ˆåˆ—è¡¨ (æ‰‹æ©Ÿæ¨¡æ“¬)',
                subtitle: 'GET /api/v1/ui/client-case-list (åµŒå…¥å¼)',
                renderForm: () => {
                    return `
                        <div class="info-card">
                            <p>ğŸ“± æ‰‹æ©Ÿé¢¨æ ¼çš„å®¢æˆ¶å€‹æ¡ˆåˆ—è¡¨é é¢</p>
                            <p style="color: #86868b; font-size: 14px; margin-top: 8px;">â€¢ è‡ªå‹•è¼‰å…¥çœŸå¯¦æ•¸æ“š</p>
                            <p style="color: #86868b; font-size: 14px;">â€¢ é»æ“Šå³å´é è¦½æŸ¥çœ‹</p>
                        </div>
                        <button class="btn btn-primary" onclick="executeStep('ui-client-case-list')">è¼‰å…¥é è¦½</button>
                    `;
                },
                execute: async () => {
                    // Fetch real data from API
                    const response = await fetch(`${BASE_URL}/api/v1/ui/client-case-list?skip=0&limit=100`, {
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });
                    const data = await response.json();
                    return { response, data };
                },
                renderPreview: (data) => {
                    const items = data.items || [];

                    const caseCardsHtml = items.length === 0 ? `
                        <div class="empty-state">
                            <svg fill="currentColor" viewBox="0 0 24 24" style="width: 80px; height: 80px; margin-bottom: 16px; opacity: 0.3;">
                                <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
                            </svg>
                            <div>å°šç„¡å€‹æ¡ˆ</div>
                            <div style="font-size: 12px; margin-top: 8px;">é»æ“Šå³ä¸Šè§’ + æ–°å¢å€‹æ¡ˆ</div>
                        </div>
                    ` : items.map(item => {
                        const statusClass = item.case_status === 'completed' ? 'completed' :
                                          item.case_status === 'active' ? 'in-progress' : 'not-started';
                        return `
                            <div class="case-card" style="background: #fff; border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                    <div>
                                        <div style="font-size: 18px; font-weight: 600; color: #1d1d1f;">${item.client_name}</div>
                                        <p style="margin: 4px 0; font-size: 12px; color: #6e6e73;">${item.client_email}</p>
                                    </div>
                                    <div style="color: #86868b; font-size: 20px; cursor: pointer;">â‹¯</div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 14px; color: #6e6e73;">
                                    <svg fill="currentColor" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                                        <path d="M20,6C20.58,6 21.05,6.2 21.42,6.59C21.8,7 22,7.45 22,8V19C22,19.55 21.8,20 21.42,20.41C21.05,20.8 20.58,21 20,21H4C3.42,21 2.95,20.8 2.58,20.41C2.2,20 2,19.55 2,19V8C2,7.45 2.2,7 2.58,6.59C2.95,6.2 3.42,6 4,6H8V4C8,3.42 8.2,2.95 8.58,2.58C8.95,2.2 9.42,2 10,2H14C14.58,2 15.05,2.2 15.42,2.58C15.8,2.95 16,3.42 16,4V6H20M4,8V19H20V8H4M10,4V6H14V4H10Z"/>
                                    </svg>
                                    <span>${item.identity_option}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 14px; color: #6e6e73;">
                                    <svg fill="currentColor" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                                        <path d="M9,10H7V12H9V10M13,10H11V12H13V10M17,10H15V12H17V10M19,3H18V1H16V3H8V1H6V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M19,19H5V8H19V19Z"/>
                                    </svg>
                                    <span>æœ€å¾Œè«®è©¢ï¼š${item.last_session_date_display || 'æœªé–‹å§‹'}</span>
                                </div>
                                <span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; margin-top: 8px; background: ${
                                    statusClass === 'completed' ? '#d1f4e0' :
                                    statusClass === 'in-progress' ? '#fff4e6' : '#e0f0ff'
                                }; color: ${
                                    statusClass === 'completed' ? '#0d894f' :
                                    statusClass === 'in-progress' ? '#f5a623' : '#0071e3'
                                };">${item.case_status_label}</span>
                            </div>
                        `;
                    }).join('');

                    return `
                        <style>
                            .iphone-preview {
                                width: 390px;
                                height: 844px;
                                background: #000;
                                border-radius: 50px;
                                padding: 12px;
                                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                                position: relative;
                                margin: 0 auto;
                            }
                            .iphone-preview .notch {
                                position: absolute;
                                top: 0;
                                left: 50%;
                                transform: translateX(-50%);
                                width: 120px;
                                height: 30px;
                                background: #000;
                                border-radius: 0 0 20px 20px;
                                z-index: 10;
                            }
                            .iphone-preview .screen {
                                width: 100%;
                                height: 100%;
                                background: #fff;
                                border-radius: 40px;
                                overflow: hidden;
                            }
                            .iphone-preview .status-bar {
                                display: flex;
                                justify-content: space-between;
                                padding: 0 20px;
                                height: 44px;
                                align-items: center;
                                font-size: 15px;
                                font-weight: 600;
                            }
                            .iphone-preview .status-bar .time {
                                margin-left: 60px;
                            }
                            .iphone-preview .nav-bar {
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                padding: 16px 20px;
                                border-bottom: 1px solid #e5e5e7;
                            }
                            .iphone-preview .nav-bar .title {
                                font-size: 17px;
                                font-weight: 600;
                                flex: 1;
                                text-align: center;
                            }
                            .iphone-preview .nav-bar .add-btn {
                                width: 36px;
                                height: 36px;
                                background: #5ac8fa;
                                border-radius: 50%;
                                display: flex;
                                justify-content: center;
                                align-items: center;
                                color: #fff;
                                font-size: 24px;
                            }
                            .iphone-preview .content {
                                height: calc(100% - 44px - 60px - 50px);
                                overflow-y: auto;
                                padding: 12px 16px;
                                background: #f9f9f9;
                            }
                        </style>
                        <div class="iphone-preview">
                            <div class="notch"></div>
                            <div class="screen">
                                <div class="status-bar">
                                    <span class="time">9:41</span>
                                    <div>âš¡ï¸ ğŸ“¶ ğŸ”‹</div>
                                </div>
                                <div class="nav-bar">
                                    <div>â€¹</div>
                                    <div class="title">å€‹æ¡ˆåˆ—è¡¨</div>
                                    <div class="add-btn">+</div>
                                </div>
                                <div class="content">
                                    ${caseCardsHtml}
                                </div>
                            </div>
                        </div>
                    `;
                }
            },
            'ui-create-client-case': {
                title: 'ğŸ“ å»ºç«‹æ–°å€‹æ¡ˆ (æ‰‹æ©Ÿæ¨¡æ“¬)',
                subtitle: 'POST /api/v1/ui/client-case (åµŒå…¥å¼è¡¨å–®)',
                renderForm: () => {
                    return `
                        <div class="info-card">
                            <p>ğŸ“± æ‰‹æ©Ÿé¢¨æ ¼çš„å»ºç«‹æ–°å€‹æ¡ˆè¡¨å–®é é¢</p>
                            <p style="color: #86868b; font-size: 14px; margin-top: 8px;">â€¢ åŒæ™‚å»ºç«‹ Client + Case</p>
                            <p style="color: #86868b; font-size: 14px;">â€¢ é»æ“Šå³å´é è¦½æŸ¥çœ‹è¡¨å–®</p>
                        </div>
                        <button class="btn btn-primary" onclick="executeStep('ui-create-client-case')">è¼‰å…¥è¡¨å–®</button>
                    `;
                },
                execute: async () => {
                    // Just return success to render the form
                    return { response: { ok: true }, data: { message: 'è¡¨å–®å·²è¼‰å…¥' } };
                },
                renderPreview: (data) => `
                    <style>
                        .create-form-preview {
                            width: 390px;
                            height: 844px;
                            background: #000;
                            border-radius: 50px;
                            padding: 12px;
                            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                            position: relative;
                            margin: 0 auto;
                        }
                        .create-form-preview .screen {
                            width: 100%;
                            height: 100%;
                            background: #fff;
                            border-radius: 40px;
                            overflow: hidden;
                            display: flex;
                            flex-direction: column;
                        }
                        .create-form-preview .form-content {
                            flex: 1;
                            overflow-y: auto;
                            padding: 20px;
                            background: #f9f9f9;
                        }
                        .create-form-preview input,
                        .create-form-preview select,
                        .create-form-preview textarea {
                            width: 100%;
                            padding: 12px;
                            border: 1px solid #e5e5e7;
                            border-radius: 8px;
                            font-size: 16px;
                            margin-bottom: 12px;
                        }
                        .create-form-preview .submit-btn {
                            width: 100%;
                            padding: 16px;
                            background: #5ac8fa;
                            color: #fff;
                            border: none;
                            border-radius: 12px;
                            font-size: 17px;
                            font-weight: 600;
                            cursor: pointer;
                        }
                        .create-form-preview .submit-btn:hover {
                            background: #2ab7f3;
                        }
                    </style>
                    <div class="create-form-preview">
                        <div class="notch" style="position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 120px; height: 30px; background: #000; border-radius: 0 0 20px 20px; z-index: 10;"></div>
                        <div class="screen">
                            <div class="status-bar" style="display: flex; justify-content: space-between; padding: 0 20px; height: 44px; align-items: center; font-size: 15px; font-weight: 600;">
                                <span style="margin-left: 60px;">9:41</span>
                                <div>âš¡ï¸ ğŸ“¶ ğŸ”‹</div>
                            </div>
                            <div class="nav-bar" style="display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid #e5e5e7;">
                                <div>â€¹</div>
                                <div style="font-size: 17px; font-weight: 600; flex: 1; text-align: center;">å»ºç«‹æ–°å€‹æ¡ˆ</div>
                                <div style="width: 36px;"></div>
                            </div>
                            <div class="form-content">
                                <div style="background: #fff; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                                    <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600;">ğŸ“ åŸºæœ¬è³‡æ–™</h3>
                                    <input type="text" placeholder="å§“å *" id="preview-name" value="å¼µå°æ˜" />
                                    <input type="email" placeholder="Email *" id="preview-email" value="test@example.com" />
                                    <select id="preview-gender">
                                        <option>ç”·</option>
                                        <option>å¥³</option>
                                        <option>å…¶ä»–</option>
                                    </select>
                                    <input type="date" id="preview-birth" value="1995-01-01" />
                                    <input type="tel" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼ *" id="preview-phone" value="0912345678" />
                                </div>

                                <div style="background: #fff; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                                    <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600;">ğŸ’¼ è·æ¶¯è³‡è¨Š</h3>
                                    <select id="preview-identity">
                                        <option>å­¸ç”Ÿ</option>
                                        <option>ç¤¾æœƒæ–°é®®äºº</option>
                                        <option selected>è½‰è·è€…</option>
                                        <option>åœ¨è·è€…</option>
                                    </select>
                                    <input type="text" placeholder="ç›®å‰ç¾æ³ *" value="æ­£åœ¨è€ƒæ…®è½‰è·" />
                                    <input type="text" placeholder="è·æ¥­ï¼ˆé¸å¡«ï¼‰" value="å·¥ç¨‹å¸«" />
                                    <input type="text" placeholder="å­¸æ­·ï¼ˆé¸å¡«ï¼‰" value="å¤§å­¸" />
                                </div>

                                <div style="background: #fff; border-radius: 12px; padding: 16px; margin-bottom: 80px;">
                                    <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600;">ğŸ“‹ å€‹æ¡ˆè³‡è¨Š</h3>
                                    <textarea rows="4" placeholder="å€‹æ¡ˆæ‘˜è¦ï¼ˆé¸å¡«ï¼‰">è·æ¶¯è½‰æ›è«®è©¢</textarea>
                                </div>

                                <div style="position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); width: calc(100% - 40px); max-width: 350px;">
                                    <button class="submit-btn" onclick="alert('é€™æ˜¯ç¤ºæ„åœ–ï¼Œè«‹ä½¿ç”¨ä¸Šæ–¹çš„ UI-4 å»ºç«‹å®¢æˆ¶å€‹æ¡ˆ API å¯¦éš›å»ºç«‹')">
                                        å»ºç«‹å€‹æ¡ˆ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },

            // ================== å®¢æˆ¶å€‹æ¡ˆç®¡ç† CRUD ==================
            'list-client-cases': {
                title: 'åˆ—å‡ºå®¢æˆ¶å€‹æ¡ˆ',
                subtitle: 'GET /api/v1/ui/client-case-list',
                renderForm: () => `
                    ${renderTenantBanner()}
                    <div class="info-card">
                        <p>ğŸ“Š æŸ¥è©¢æ‰€æœ‰å®¢æˆ¶å€‹æ¡ˆ (Client + Case + Session)</p>
                        <p style="color: #86868b; font-size: 14px; margin-top: 8px;">â€¢ ä¸€æ¬¡å–å¾— Client åŸºæœ¬è³‡æ–™ã€ç¬¬ä¸€å€‹ Caseã€æœ€å¾Œè«®è©¢æ—¥æœŸ</p>
                    </div>
                    <div class="form-group">
                        <label>Skip (è·³éç­†æ•¸)</label>
                        <input type="number" id="cc-list-skip" value="0" min="0" />
                    </div>
                    <div class="form-group">
                        <label>Limit (æ¯é ç­†æ•¸)</label>
                        <input type="number" id="cc-list-limit" value="20" min="1" max="100" />
                    </div>
                    <button class="btn btn-primary" onclick="executeListClientCases()">æŸ¥è©¢</button>
                `,
                execute: async () => {
                    const skip = document.getElementById('cc-list-skip').value || 0;
                    const limit = document.getElementById('cc-list-limit').value || 20;

                    const response = await fetch(`${BASE_URL}/api/v1/ui/client-case-list?skip=${skip}&limit=${limit}`, {
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });
                    const data = await response.json();

                    // Store for later use
                    state.clientCases = data.items || [];

                    return { response, data };
                },
                renderPreview: (data) => {
                    if (!data.items || data.items.length === 0) {
                        return `
                            <div class="info-card">
                                <h3>ğŸ“Š æŸ¥è©¢çµæœ</h3>
                                <p>å°šç„¡å®¢æˆ¶å€‹æ¡ˆè³‡æ–™</p>
                            </div>
                        `;
                    }

                    const itemsHtml = data.items.map(item => `
                        <div class="info-card" style="margin-bottom: 12px; cursor: pointer;" onclick="selectClientCase('${item.case_id}')">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <h4 style="margin: 0; color: #1d1d1f;">${item.client_name}</h4>
                                    <p style="margin: 4px 0; font-size: 12px; color: #6e6e73;">${item.client_email}</p>
                                </div>
                                <span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; background: ${
                                    item.case_status === 'active' ? '#fff4e6' :
                                    item.case_status === 'completed' ? '#d1f4e0' : '#e0f0ff'
                                }; color: ${
                                    item.case_status === 'active' ? '#f5a623' :
                                    item.case_status === 'completed' ? '#0d894f' : '#0071e3'
                                };">${item.case_status_label}</span>
                            </div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e5e7;">
                                <div class="info-row">
                                    <span class="info-label">èº«ä»½</span>
                                    <span class="info-value">${item.identity_option}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">å€‹æ¡ˆç·¨è™Ÿ</span>
                                    <span class="info-value" style="font-size: 11px;">${item.case_number}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">æœ€å¾Œè«®è©¢</span>
                                    <span class="info-value">${item.last_session_date_display || 'æœªé–‹å§‹'}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">ç¸½æœƒè«‡æ¬¡æ•¸</span>
                                    <span class="info-value">${item.total_sessions}</span>
                                </div>
                            </div>
                        </div>
                    `).join('');

                    return `
                        <div class="info-card">
                            <h3>ğŸ“Š å®¢æˆ¶å€‹æ¡ˆåˆ—è¡¨ (å…± ${data.total} ç­†)</h3>
                        </div>
                        ${itemsHtml}
                    `;
                }
            },

            'create-client-case': {
                title: 'å»ºç«‹å®¢æˆ¶å€‹æ¡ˆ',
                subtitle: 'POST /api/v1/ui/client-case',
                renderForm: () => `
                    ${renderTenantBanner()}
                    <div class="info-card">
                        <p>â• åŒæ™‚å»ºç«‹ Client + Case</p>
                        <p style="color: #86868b; font-size: 14px; margin-top: 8px;">â€¢ Client Code å’Œ Case Number è‡ªå‹•ç”Ÿæˆ</p>
                    </div>

                    <h4 style="margin: 20px 0 12px;">ğŸ“ Client å¿…å¡«æ¬„ä½</h4>
                    <div class="form-group">
                        <label>å§“å *</label>
                        <input type="text" id="cc-name" value="å¼µå°æ˜" required />
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="cc-email" value="test@example.com" required />
                    </div>
                    <div class="form-group">
                        <label>æ€§åˆ¥ *</label>
                        <select id="cc-gender">
                            <option value="ç”·">ç”·</option>
                            <option value="å¥³">å¥³</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                            <option value="ä¸ä¾¿é€éœ²">ä¸ä¾¿é€éœ²</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ç”Ÿæ—¥ *</label>
                        <input type="date" id="cc-birth-date" value="1995-01-01" required />
                    </div>
                    <div class="form-group">
                        <label>æ‰‹æ©Ÿè™Ÿç¢¼ *</label>
                        <input type="tel" id="cc-phone" value="0912345678" required />
                    </div>
                    <div class="form-group">
                        <label>èº«ä»½é¸é … *</label>
                        <select id="cc-identity">
                            <option value="å­¸ç”Ÿ">å­¸ç”Ÿ</option>
                            <option value="ç¤¾æœƒæ–°é®®äºº">ç¤¾æœƒæ–°é®®äºº</option>
                            <option value="è½‰è·è€…" selected>è½‰è·è€…</option>
                            <option value="åœ¨è·è€…">åœ¨è·è€…</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ç›®å‰ç¾æ³ *</label>
                        <input type="text" id="cc-status" value="æ­£åœ¨è€ƒæ…®è½‰è·" required />
                    </div>

                    <h4 style="margin: 20px 0 12px;">ğŸ“‹ é¸å¡«æ¬„ä½</h4>
                    <div class="form-group">
                        <label>æš±ç¨±</label>
                        <input type="text" id="cc-nickname" value="å°æ˜" />
                    </div>
                    <div class="form-group">
                        <label>å­¸æ­·</label>
                        <input type="text" id="cc-education" value="å¤§å­¸" />
                    </div>
                    <div class="form-group">
                        <label>è·æ¥­</label>
                        <input type="text" id="cc-occupation" value="å·¥ç¨‹å¸«" />
                    </div>
                    <div class="form-group">
                        <label>åœ°é»</label>
                        <input type="text" id="cc-location" value="å°åŒ—å¸‚" />
                    </div>
                    <div class="form-group">
                        <label>å€‹æ¡ˆæ‘˜è¦</label>
                        <textarea id="cc-case-summary" rows="3">è·æ¶¯è½‰æ›è«®è©¢</textarea>
                    </div>

                    <button class="btn btn-primary" onclick="executeCreateClientCase()">å»ºç«‹</button>
                `,
                execute: async () => {
                    const requestBody = {
                        name: document.getElementById('cc-name').value,
                        email: document.getElementById('cc-email').value,
                        gender: document.getElementById('cc-gender').value,
                        birth_date: document.getElementById('cc-birth-date').value,
                        phone: document.getElementById('cc-phone').value,
                        identity_option: document.getElementById('cc-identity').value,
                        current_status: document.getElementById('cc-status').value,
                        nickname: document.getElementById('cc-nickname').value || undefined,
                        education: document.getElementById('cc-education').value || undefined,
                        occupation: document.getElementById('cc-occupation').value || undefined,
                        location: document.getElementById('cc-location').value || undefined,
                        case_summary: document.getElementById('cc-case-summary').value || undefined,
                    };

                    const response = await fetch(`${BASE_URL}/api/v1/ui/client-case`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });
                    const data = await response.json();
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>âœ… å®¢æˆ¶å€‹æ¡ˆå»ºç«‹æˆåŠŸ</h3>
                        <div class="info-row">
                            <span class="info-label">Client å§“å</span>
                            <span class="info-value">${data.client_name}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Client Code</span>
                            <span class="info-value" style="font-weight: 600; color: #007aff;">${data.client_code}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Client Email</span>
                            <span class="info-value">${data.client_email}</span>
                        </div>
                    </div>
                    <div class="info-card">
                        <h3>ğŸ“‹ Case è³‡è¨Š</h3>
                        <div class="info-row">
                            <span class="info-label">Case Number</span>
                            <span class="info-value" style="font-weight: 600; color: #34c759;">${data.case_number}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Case Status</span>
                            <span class="info-value">${data.case_status}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å»ºç«‹æ™‚é–“</span>
                            <span class="info-value">${new Date(data.created_at).toLocaleString('zh-TW')}</span>
                        </div>
                    </div>
                    <div class="info-card" style="background: #f0f9ff; border-color: #0ea5e9;">
                        <p style="color: #0369a1; font-size: 14px;">ğŸ’¡ ${data.message}</p>
                    </div>
                `
            },

            'update-client-case': {
                title: 'æ›´æ–°å®¢æˆ¶å€‹æ¡ˆ',
                subtitle: 'PATCH /api/v1/ui/client-case/{id}',
                renderForm: () => {
                    // Generate dropdown from state.clientCases
                    const caseOptions = (state.clientCases || []).map(c =>
                        `<option value="${c.case_id}">${c.client_name} - ${c.case_number}</option>`
                    ).join('');

                    return `
                        ${renderTenantBanner()}
                        <div class="info-card">
                            <p>âœï¸ æ›´æ–°å®¢æˆ¶èˆ‡å€‹æ¡ˆè³‡æ–™</p>
                            <p style="color: #86868b; font-size: 14px; margin-top: 8px;">â€¢ æ‰€æœ‰æ¬„ä½éƒ½æ˜¯é¸å¡«ï¼Œåªæ›´æ–°æä¾›çš„æ¬„ä½</p>
                        </div>

                        <div class="form-group">
                            <label>é¸æ“‡å€‹æ¡ˆ *</label>
                            <select id="cc-update-id" onchange="loadClientCaseForUpdate(this.value)">
                                <option value="">-- è«‹å…ˆåŸ·è¡Œã€Œåˆ—å‡ºå®¢æˆ¶å€‹æ¡ˆã€--</option>
                                ${caseOptions}
                            </select>
                        </div>

                        <h4 style="margin: 20px 0 12px;">ğŸ“ Client æ¬„ä½ (é¸å¡«)</h4>
                        <div class="form-group">
                            <label>å§“å</label>
                            <input type="text" id="cc-update-name" placeholder="ä¸æ›´æ–°å‰‡ç•™ç©º" />
                        </div>
                        <div class="form-group">
                            <label>æ‰‹æ©Ÿè™Ÿç¢¼</label>
                            <input type="tel" id="cc-update-phone" placeholder="ä¸æ›´æ–°å‰‡ç•™ç©º" />
                        </div>
                        <div class="form-group">
                            <label>ç›®å‰ç¾æ³</label>
                            <input type="text" id="cc-update-status" placeholder="ä¸æ›´æ–°å‰‡ç•™ç©º" />
                        </div>

                        <h4 style="margin: 20px 0 12px;">ğŸ“‹ Case æ¬„ä½ (é¸å¡«)</h4>
                        <div class="form-group">
                            <label>Case ç‹€æ…‹</label>
                            <select id="cc-update-case-status">
                                <option value="">ä¸æ›´æ–°</option>
                                <option value="active">é€²è¡Œä¸­ (active)</option>
                                <option value="completed">å·²å®Œæˆ (completed)</option>
                                <option value="suspended">æš«åœä¸­ (suspended)</option>
                                <option value="referred">å·²è½‰ä»‹ (referred)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>å€‹æ¡ˆæ‘˜è¦</label>
                            <textarea id="cc-update-summary" rows="3" placeholder="ä¸æ›´æ–°å‰‡ç•™ç©º"></textarea>
                        </div>

                        <button class="btn btn-primary" onclick="executeUpdateClientCase()">æ›´æ–°</button>
                    `;
                },
                execute: async () => {
                    const caseId = document.getElementById('cc-update-id').value;
                    if (!caseId) {
                        throw new Error('Please select a case to update');
                    }

                    const requestBody = {};

                    // Only include fields that are not empty
                    const name = document.getElementById('cc-update-name').value;
                    if (name) requestBody.name = name;

                    const phone = document.getElementById('cc-update-phone').value;
                    if (phone) requestBody.phone = phone;

                    const status = document.getElementById('cc-update-status').value;
                    if (status) requestBody.current_status = status;

                    const caseStatus = document.getElementById('cc-update-case-status').value;
                    if (caseStatus) requestBody.case_status = caseStatus;

                    const summary = document.getElementById('cc-update-summary').value;
                    if (summary) requestBody.case_summary = summary;

                    const response = await fetch(`${BASE_URL}/api/v1/ui/client-case/${caseId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });
                    const data = await response.json();
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>âœ… ${data.message}</h3>
                        <div class="info-row">
                            <span class="info-label">Client å§“å</span>
                            <span class="info-value">${data.client_name}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Client Code</span>
                            <span class="info-value">${data.client_code}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Case Number</span>
                            <span class="info-value">${data.case_number}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Case Status</span>
                            <span class="info-value">${data.case_status}</span>
                        </div>
                    </div>
                `
            },

            'delete-client-case': {
                title: 'åˆªé™¤å®¢æˆ¶å€‹æ¡ˆ',
                subtitle: 'DELETE /api/v1/ui/client-case/{id}',
                renderForm: () => {
                    const caseOptions = (state.clientCases || []).map(c =>
                        `<option value="${c.case_id}">${c.client_name} - ${c.case_number}</option>`
                    ).join('');

                    return `
                        ${renderTenantBanner()}
                        <div class="info-card" style="background: #fef2f2; border-color: #ef4444;">
                            <p style="color: #991b1b;">âš ï¸ åˆªé™¤å€‹æ¡ˆï¼ˆè»Ÿåˆªé™¤ï¼‰</p>
                            <p style="color: #991b1b; font-size: 14px; margin-top: 8px;">
                                â€¢ åªåˆªé™¤ Caseï¼Œä¸åˆªé™¤ Client<br>
                                â€¢ è»Ÿåˆªé™¤ï¼Œè³‡æ–™ä¸æœƒçœŸæ­£æ¶ˆå¤±
                            </p>
                        </div>

                        <div class="form-group">
                            <label>é¸æ“‡è¦åˆªé™¤çš„å€‹æ¡ˆ *</label>
                            <select id="cc-delete-id">
                                <option value="">-- è«‹å…ˆåŸ·è¡Œã€Œåˆ—å‡ºå®¢æˆ¶å€‹æ¡ˆã€--</option>
                                ${caseOptions}
                            </select>
                        </div>

                        <button class="btn btn-danger" onclick="executeDeleteClientCase()"
                                style="background: #ef4444;">åˆªé™¤</button>
                    `;
                },
                execute: async () => {
                    const caseId = document.getElementById('cc-delete-id').value;
                    if (!caseId) {
                        throw new Error('Please select a case to delete');
                    }

                    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å€‹æ¡ˆå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                        throw new Error('Operation cancelled');
                    }

                    const response = await fetch(`${BASE_URL}/api/v1/ui/client-case/${caseId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });
                    const data = await response.json();
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card" style="background: #d1f4e0; border-color: #0d894f;">
                        <h3 style="color: #0d894f;">âœ… ${data.message}</h3>
                        <div class="info-row">
                            <span class="info-label">Case Number</span>
                            <span class="info-value">${data.case_number}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">åˆªé™¤æ™‚é–“</span>
                            <span class="info-value">${new Date(data.deleted_at).toLocaleString('zh-TW')}</span>
                        </div>
                    </div>
                `
            }
        };

        // Event handlers
        document.querySelectorAll('.flow-step').forEach(step => {
            step.addEventListener('click', () => {
                const stepKey = step.dataset.step;
                selectStep(stepKey);
            });
        });

        async function selectStep(stepKey) {
            // Update active state
            document.querySelectorAll('.flow-step').forEach(s => s.classList.remove('active'));
            document.querySelector(`[data-step="${stepKey}"]`).classList.add('active');

            // Update UI
            const stepConfig = steps[stepKey];
            document.getElementById('action-title').textContent = stepConfig.title;
            document.getElementById('action-subtitle').textContent = stepConfig.subtitle;

            // Call init function if exists (await if async)
            if (stepConfig.init) {
                await stepConfig.init();
            }

            // Render form after init completes
            document.getElementById('action-form').innerHTML = stepConfig.renderForm();

            document.getElementById('preview-title').textContent = stepConfig.title;
            document.getElementById('preview-subtitle').textContent = stepConfig.subtitle;

            // Clear preview content when switching steps
            document.getElementById('preview-content').innerHTML = `
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <p>å¡«å¯«åƒæ•¸ä¸¦åŸ·è¡Œ API</p>
                </div>
            `;

            // Hide response initially
            document.getElementById('response-section').style.display = 'none';
        }

        async function executeStep(stepKey) {
            const stepConfig = steps[stepKey];
            const stepElement = document.querySelector(`[data-step="${stepKey}"]`);

            // Find the button in the action form and disable it with loading state
            const button = document.querySelector('#action-form .btn-primary');
            const originalText = button?.textContent;

            try {
                stepElement.classList.remove('completed', 'error');

                // Set loading state
                if (button) {
                    button.disabled = true;
                    button.textContent = 'è™•ç†ä¸­...';
                }

                const result = await stepConfig.execute();
                const { response, data } = result;

                // Show response
                const responseSection = document.getElementById('response-section');
                const responseStatus = document.getElementById('response-status');
                const responseContent = document.getElementById('response-content');

                responseSection.style.display = 'block';
                responseStatus.innerHTML = `<span class="status-badge status-${response.ok ? 'success' : 'error'}">${response.status} ${response.statusText}</span>`;
                responseContent.textContent = JSON.stringify(data, null, 2);

                if (response.ok) {
                    stepElement.classList.add('completed');
                    // Update preview
                    if (stepConfig.renderPreview) {
                        // Pass the entire result object for steps that need it (like view-report)
                        // Otherwise just pass data for backwards compatibility
                        const previewArg = (stepKey === 'view-report') ? result : data;
                        document.getElementById('preview-content').innerHTML = stepConfig.renderPreview(previewArg);
                    }
                } else {
                    stepElement.classList.add('error');
                    document.getElementById('preview-content').innerHTML = `
                        <div class="info-card" style="border-color: #ef4444;">
                            <h3 style="color: #ef4444;">âŒ éŒ¯èª¤</h3>
                            <p style="color: #991b1b;">${data.detail || 'è«‹æ±‚å¤±æ•—'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                stepElement.classList.add('error');
                document.getElementById('response-section').style.display = 'block';
                document.getElementById('response-status').innerHTML = `<span class="status-badge status-error">Error</span>`;
                document.getElementById('response-content').textContent = error.message;
            } finally {
                // Restore button state
                if (button) {
                    button.disabled = false;
                    button.textContent = originalText;
                }
            }
        }

        // è¼ªè©¢å ±å‘Šç‹€æ…‹
        async function pollReportStatus(reportId) {
            try {
                const response = await fetch(`${BASE_URL}/api/v1/reports/${reportId}`, {
                    headers: { 'Authorization': `Bearer ${state.token}` }
                });
                const data = await response.json();

                const pollingDiv = document.getElementById('polling-status');
                if (!pollingDiv) return;

                if (data.status === 'processing') {
                    pollingDiv.innerHTML = `<p style="font-size: 13px; color: #f59e0b;">â³ è™•ç†ä¸­... (${new Date().toLocaleTimeString('zh-TW')})</p>`;
                    setTimeout(() => pollReportStatus(reportId), 3000);
                } else if (data.status === 'draft') {
                    pollingDiv.innerHTML = `<p style="font-size: 13px; color: #10b981;">âœ… å ±å‘Šç”Ÿæˆå®Œæˆ!</p>`;
                    // è‡ªå‹•é‡æ–°è¼‰å…¥æŸ¥çœ‹å ±å‘Š
                    setTimeout(() => {
                        document.getElementById('preview-content').innerHTML = steps['generate-report'].renderPreview({
                            report_id: data.id,
                            session_id: data.session_id,
                            report: { report: data.content_json.report || data.content_json },
                            quality_summary: {
                                grade: data.quality_grade,
                                overall_score: data.quality_score,
                                strengths: data.quality_strengths,
                                improvements_needed: data.quality_weaknesses
                            }
                        });
                    }, 1000);
                } else if (data.status === 'failed') {
                    pollingDiv.innerHTML = `
                        <p style="font-size: 13px; color: #ef4444;">âŒ ç”Ÿæˆå¤±æ•—</p>
                        <p style="font-size: 12px; color: #991b1b; margin-top: 8px;">${data.error_message || 'æœªçŸ¥éŒ¯èª¤'}</p>
                    `;
                }
            } catch (error) {
                console.error('Polling error:', error);
            }
        }

        // Helper: Load session data when selecting for update
        window.loadSessionForUpdate = function() {
            const sessionId = document.getElementById('update-session-id').value;
            const session = state.sessions.find(s => s.id === sessionId);
            if (session) {
                // Set date
                const sessionDate = new Date(session.session_date);
                document.getElementById('update-session-date').value = sessionDate.toISOString().split('T')[0];

                // Set times
                if (session.start_time) {
                    const startTime = new Date(session.start_time);
                    document.getElementById('update-session-start-time').value =
                        `${String(startTime.getHours()).padStart(2, '0')}:${String(startTime.getMinutes()).padStart(2, '0')}`;
                }
                if (session.end_time) {
                    const endTime = new Date(session.end_time);
                    document.getElementById('update-session-end-time').value =
                        `${String(endTime.getHours()).padStart(2, '0')}:${String(endTime.getMinutes()).padStart(2, '0')}`;
                }

                document.getElementById('update-session-transcript').value = session.transcript_text || '';
                document.getElementById('update-session-notes').value = session.notes || '';

                // Load reflection data if exists
                if (session.reflection) {
                    document.getElementById('update-reflection-working').value = session.reflection.working_with_client || '';
                    document.getElementById('update-reflection-source').value = session.reflection.feeling_source || '';
                    document.getElementById('update-reflection-challenges').value = session.reflection.current_challenges || '';
                    document.getElementById('update-reflection-supervision').value = session.reflection.supervision_topics || '';
                } else {
                    document.getElementById('update-reflection-working').value = '';
                    document.getElementById('update-reflection-source').value = '';
                    document.getElementById('update-reflection-challenges').value = '';
                    document.getElementById('update-reflection-supervision').value = '';
                }
            }
        };

        // Load reflection data for update form
        window.loadReflectionForUpdate = function() {
            const sessionId = document.getElementById('update-reflection-session-id').value;
            const session = state.sessions.find(s => s.id === sessionId);
            if (session && session.reflection) {
                document.getElementById('put-reflection-working').value = session.reflection.working_with_client || '';
                document.getElementById('put-reflection-source').value = session.reflection.feeling_source || '';
                document.getElementById('put-reflection-challenges').value = session.reflection.current_challenges || '';
                document.getElementById('put-reflection-supervision').value = session.reflection.supervision_topics || '';
            } else {
                document.getElementById('put-reflection-working').value = '';
                document.getElementById('put-reflection-source').value = '';
                document.getElementById('put-reflection-challenges').value = '';
                document.getElementById('put-reflection-supervision').value = '';
            }
        };

        // Load client data for update form
        window.loadClientDataForUpdate = async () => {
            const clientId = document.getElementById('update-client-id')?.value;
            if (!clientId || !state.clientFieldSchema) return;

            try {
                const response = await fetch(`${BASE_URL}/api/v1/clients/${clientId}`, {
                    headers: { 'Authorization': `Bearer ${state.token}` }
                });

                if (response.ok) {
                    const client = await response.json();

                    // Dynamically populate fields based on schema
                    state.clientFieldSchema.sections.forEach(section => {
                        section.fields.forEach(field => {
                            const inputId = `update-client-${field.key}`;
                            const element = document.getElementById(inputId);
                            if (element && client[field.key] !== undefined) {
                                element.value = client[field.key] || '';
                            }
                        });
                    });
                }
            } catch (error) {
                console.error('Failed to load client data:', error);
            }
        };

        // Load case data for update form
        window.loadCaseDataForUpdate = async () => {
            const caseId = document.getElementById('update-case-id')?.value;
            if (!caseId) return;

            try {
                const response = await fetch(`${BASE_URL}/api/v1/cases/${caseId}`, {
                    headers: { 'Authorization': `Bearer ${state.token}` }
                });

                if (response.ok) {
                    const caseData = await response.json();

                    // Populate fields
                    const statusEl = document.getElementById('update-case-status');
                    const summaryEl = document.getElementById('update-case-summary');
                    const goalsEl = document.getElementById('update-case-goals');
                    const problemEl = document.getElementById('update-case-problem');

                    if (statusEl) statusEl.value = caseData.status || '';
                    if (summaryEl) summaryEl.value = caseData.summary || '';
                    if (goalsEl) goalsEl.value = caseData.goals || '';
                    if (problemEl) problemEl.value = caseData.problem_description || '';
                }
            } catch (error) {
                console.error('Failed to load case data:', error);
            }
        };

        // Load client-case data for update form (UI-5)
        window.loadClientCaseForUpdate = function(caseId) {
            if (!caseId || !state.clientCases) {
                // Clear all fields
                document.getElementById('cc-update-name').value = '';
                document.getElementById('cc-update-phone').value = '';
                document.getElementById('cc-update-status').value = '';
                document.getElementById('cc-update-case-status').value = '';
                document.getElementById('cc-update-summary').value = '';
                return;
            }

            // Find the selected case from state.clientCases
            const selectedCase = state.clientCases.find(c => c.case_id === caseId);
            if (!selectedCase) {
                console.error('Case not found in state.clientCases:', caseId);
                return;
            }

            // Populate Client fields with current values
            const nameEl = document.getElementById('cc-update-name');
            const phoneEl = document.getElementById('cc-update-phone');
            const statusEl = document.getElementById('cc-update-status');
            const caseStatusEl = document.getElementById('cc-update-case-status');
            const summaryEl = document.getElementById('cc-update-summary');

            if (nameEl) nameEl.value = selectedCase.client_name || '';
            if (phoneEl) phoneEl.value = ''; // Phone not in list response, leave empty
            if (statusEl) statusEl.value = selectedCase.current_status || '';
            if (caseStatusEl) caseStatusEl.value = selectedCase.case_status || '';
            if (summaryEl) summaryEl.value = ''; // Summary not in list response, leave empty

            console.log('Loaded client-case data:', selectedCase);
        };

        // Recording segments management
        let recordingSegmentCounter = 0;

        window.addRecordingSegment = () => {
            recordingSegmentCounter++;
            const segmentNumber = recordingSegmentCounter;
            const container = document.getElementById('recordings-container');

            const segmentHtml = `
                <div class="recording-segment" id="recording-segment-${segmentNumber}" style="background: white; border: 1px solid #d1d5db; border-radius: 6px; padding: 16px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h5 style="color: #047857; margin: 0;">ğŸ“ ç‰‡æ®µ ${segmentNumber}</h5>
                        <button type="button" onclick="removeRecordingSegment(${segmentNumber})" style="background: #ef4444; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ—‘ï¸ åˆªé™¤</button>
                    </div>
                    <input type="hidden" id="recording-${segmentNumber}-segment-number" value="${segmentNumber}" />
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 13px;">é–‹å§‹æ™‚é–“</label>
                            <input type="time" id="recording-${segmentNumber}-start" style="font-size: 13px; padding: 6px;" />
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 13px;">çµæŸæ™‚é–“</label>
                            <input type="time" id="recording-${segmentNumber}-end" style="font-size: 13px; padding: 6px;" />
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 13px;">æ™‚é•·ï¼ˆç§’ï¼‰</label>
                            <input type="number" id="recording-${segmentNumber}-duration" placeholder="è‡ªå‹•è¨ˆç®—æˆ–æ‰‹å‹•å¡«" style="font-size: 13px; padding: 6px;" />
                        </div>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 13px;">é€å­—ç¨¿å…§å®¹</label>
                        <textarea id="recording-${segmentNumber}-transcript" rows="4" placeholder="æ­¤ç‰‡æ®µçš„é€å­—ç¨¿..." style="font-size: 13px;"></textarea>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', segmentHtml);
        };

        window.removeRecordingSegment = (segmentNumber) => {
            const segment = document.getElementById(`recording-segment-${segmentNumber}`);
            if (segment) {
                segment.remove();
            }
        };

        window.collectRecordings = () => {
            const recordings = [];
            const segments = document.querySelectorAll('.recording-segment');

            segments.forEach((segment) => {
                const segmentId = segment.id.replace('recording-segment-', '');
                const segmentNumber = document.getElementById(`recording-${segmentId}-segment-number`)?.value;
                const startTime = document.getElementById(`recording-${segmentId}-start`)?.value;
                const endTime = document.getElementById(`recording-${segmentId}-end`)?.value;
                const duration = document.getElementById(`recording-${segmentId}-duration`)?.value;
                const transcript = document.getElementById(`recording-${segmentId}-transcript`)?.value;

                if (transcript) {  // Only include if transcript is provided
                    const sessionDate = document.getElementById('session-date')?.value;
                    const recording = {
                        segment_number: parseInt(segmentNumber),
                        transcript_text: transcript
                    };

                    if (startTime) recording.start_time = `${sessionDate} ${startTime}`;
                    if (endTime) recording.end_time = `${sessionDate} ${endTime}`;
                    if (duration) recording.duration_seconds = parseInt(duration);

                    recordings.push(recording);
                }
            });

            return recordings;
        };

        // Quick fill session test data
        window.quickFillSessionData = () => {
            const sampleTranscripts = [
                `Co: ä½ å¥½ï¼Œä»Šå¤©æƒ³èŠäº›ä»€éº¼å‘¢ï¼Ÿ
Cl: æœ€è¿‘å·¥ä½œå£“åŠ›å¾ˆå¤§ï¼Œè¦ºå¾—å¿«è¦æ’ä¸ä¸‹å»äº†ã€‚
Co: å¯ä»¥å¤šèªªä¸€äº›å—ï¼Ÿæ˜¯ä»€éº¼æ¨£çš„å£“åŠ›ï¼Ÿ
Cl: ä¸»ç®¡ç¸½æ˜¯å°æˆ‘çš„å·¥ä½œä¸æ»¿æ„ï¼Œä¸ç®¡æˆ‘æ€éº¼åšéƒ½è¦ºå¾—ä¸å¤ å¥½ã€‚
Co: è½èµ·ä¾†ä½ æ„Ÿåˆ°å¾ˆæŒ«æŠ˜ï¼Œå¯ä»¥åˆ†äº«ä¸€å€‹å…·é«”çš„ä¾‹å­å—ï¼Ÿ
Cl: ä¸Šé€±æˆ‘åšäº†ä¸€ä»½ä¼åŠƒæ¡ˆï¼ŒèŠ±äº†å¾ˆå¤šå¿ƒåŠ›ï¼Œä½†ä¸»ç®¡åªçœ‹äº†ä¸€çœ¼å°±èªªé€™ä¸æ˜¯ä»–è¦çš„ã€‚`,
                `Co: ä¸Šæ¬¡æåˆ°çš„è·æ¶¯æ–¹å‘ï¼Œæœ‰æ–°çš„æƒ³æ³•å—ï¼Ÿ
Cl: æˆ‘ä¸€ç›´åœ¨æ€è€ƒï¼Œä½†é‚„æ˜¯å¾ˆè¿·èŒ«ã€‚
Co: è¿·èŒ«çš„æ„Ÿè¦ºæ˜¯ä»€éº¼ï¼Ÿ
Cl: ä¸çŸ¥é“è‡ªå·±é©åˆåšä»€éº¼ï¼Œä¹Ÿä¸ç¢ºå®šç¾åœ¨çš„å·¥ä½œæ˜¯ä¸æ˜¯å°çš„é¸æ“‡ã€‚
Co: è®“æˆ‘å€‘å…ˆå¾ä½ çš„èˆˆè¶£é–‹å§‹èŠèµ·å§ã€‚`,
                `Co: ä»Šå¤©çœ‹èµ·ä¾†å¿ƒæƒ…ä¸éŒ¯ï¼Ÿ
Cl: å°å•Šï¼Œé€™é€±å·¥ä½œé †åˆ©å¾ˆå¤šï¼Œä¸»ç®¡ä¹Ÿç¨±è®šäº†æˆ‘ã€‚
Co: å¾ˆé«˜èˆˆè½åˆ°é€™å€‹æ¶ˆæ¯ï¼æ˜¯ä»€éº¼æ”¹è®Šäº†ï¼Ÿ
Cl: æˆ‘é–‹å§‹ç”¨ä½ ä¸Šæ¬¡å»ºè­°çš„æ–¹æ³•ï¼Œå…ˆç¢ºèªä¸»ç®¡çš„éœ€æ±‚å†é–‹å§‹åšã€‚
Co: è½èµ·ä¾†é€™å€‹ç­–ç•¥å¾ˆæœ‰æ•ˆï¼Œç¹¼çºŒä¿æŒï¼`
            ];

            const sampleReflections = [
                {
                    working: 'æ•´é«”éç¨‹æµæš¢è¼•é¬†ï¼Œé€æ¼¸è´å¾—ä¿¡ä»»ã€‚é¦–æ¬¡é¢å°è·å ´PUAæ¡ˆä¾‹ï¼Œç²å¾—æ–°çš„è¼”å°ç¶“é©—ã€‚',
                    source: 'å€‹æ¡ˆå¾ç·Šå¼µåˆ°é€æ­¥æ”¾é¬†ï¼Œé¡˜æ„é–‹æ”¾å¿ƒæ…‹åˆ†äº«æ›´å¤šã€‚èƒ½å¤ å»ºç«‹è‰¯å¥½çš„æ²»ç™‚åŒç›Ÿã€‚',
                    challenges: 'ç•¶è‚¯å®šå€‹æ¡ˆæ™‚ï¼Œä»æœƒæœ‰è‡ªæˆ‘æ‡·ç–‘åæ‡‰ï¼›ä½†å·²é€æ¼¸èƒ½æ¥å—è®šè³ã€‚éœ€è¦æ›´å¤šæ™‚é–“æ¢ç´¢å…¶å…§åœ¨èªçŸ¥æ¨¡å¼ã€‚',
                    supervision: 'å¦‚ä½•åœ¨æ”¯æŒèˆ‡æŒ‘æˆ°é–“æ‹¿æç¯€å¥ï¼Œä»¥åŠé‡è¡¨èˆ‡è³ªåŒ–ç´€éŒ„æ•´åˆæ–¹å¼ã€‚ç‰¹åˆ¥æ˜¯å¦‚ä½•è™•ç†è·å ´å‰µå‚·ã€‚'
                },
                {
                    working: 'å€‹æ¡ˆå±•ç¾å‡ºå¼·çƒˆçš„æ”¹è®Šå‹•æ©Ÿï¼Œå·¥ä½œé…åˆåº¦é«˜ï¼Œè®“æœƒè«‡é€²å±•é †åˆ©ã€‚',
                    source: 'å€‹æ¡ˆå°è‡ªå·±çš„å›°å¢ƒæœ‰æ¸…æ¥šçš„èªçŸ¥ï¼Œä¹Ÿé¡˜æ„å˜—è©¦æ–°çš„æ–¹æ³•ï¼Œé€™è®“è«®å•†éç¨‹æ›´æœ‰æ•ˆç‡ã€‚',
                    challenges: 'å€‹æ¡ˆæœ‰æ™‚æœƒéåº¦ç†æ€§åŒ–è‡ªå·±çš„æƒ…ç·’ï¼Œéœ€è¦å¼•å°å…¶æ›´æ·±å…¥åœ°è¦ºå¯Ÿæ„Ÿå—ã€‚',
                    supervision: 'å¦‚ä½•å¹«åŠ©å€‹æ¡ˆåœ¨ç†æ€§æ€è€ƒèˆ‡æƒ…ç·’è¦ºå¯Ÿé–“å–å¾—å¹³è¡¡ï¼Ÿæ˜¯å¦éœ€è¦å¼•å…¥æ›´å¤šæƒ…ç·’ç„¦é»æŠ€è¡“ï¼Ÿ'
                },
                {
                    working: 'ä»Šå¤©çš„æœƒè«‡å……æ»¿æ­£å‘èƒ½é‡ï¼Œçœ‹åˆ°å€‹æ¡ˆçš„é€²æ­¥æ„Ÿåˆ°å¾ˆæ¬£æ…°ã€‚',
                    source: 'å€‹æ¡ˆèƒ½å¤ ä¸»å‹•åˆ†äº«æˆåŠŸç¶“é©—ï¼Œå±•ç¾å‡ºæ›´å¤šçš„è‡ªä¿¡å’Œè‡ªæˆ‘æ•ˆèƒ½æ„Ÿã€‚',
                    challenges: 'éœ€è¦å”åŠ©å€‹æ¡ˆå°‡é€™æ¬¡çš„æˆåŠŸç¶“é©—å…§åŒ–ï¼Œé¿å…æœªä¾†é‡åˆ°æŒ«æŠ˜æ™‚å›åˆ°åŸé»ã€‚',
                    supervision: 'å¦‚ä½•å¼·åŒ–å€‹æ¡ˆçš„æˆåŠŸç¶“é©—ï¼Œå»ºç«‹é•·æœŸçš„å› æ‡‰ç­–ç•¥ï¼Ÿä¸‹ä¸€æ­¥çš„ä»‹å…¥é‡é»æ‡‰è©²æ”¾åœ¨å“ªè£¡ï¼Ÿ'
                }
            ];

            const randomIndex = Math.floor(Math.random() * sampleTranscripts.length);
            const randomTranscript = sampleTranscripts[randomIndex];
            const randomReflection = sampleReflections[randomIndex];
            const today = new Date();
            const startHour = 14 + Math.floor(Math.random() * 3); // 14-16é»
            const endHour = startHour + 1;

            document.getElementById('session-date').value = today.toISOString().split('T')[0];
            document.getElementById('session-start-time').value = `${startHour}:00`;
            document.getElementById('session-end-time').value = `${endHour}:00`;
            // transcript å°‡å¾ recordings è‡ªå‹•èšåˆï¼Œæš«ä¸å¡«å……
            document.getElementById('session-transcript').value = '';
            document.getElementById('session-notes').value = 'æ¸¬è©¦æœƒè«‡è¨˜éŒ„';

            // Fill reflection fields
            document.getElementById('reflection-working').value = randomReflection.working;
            document.getElementById('reflection-source').value = randomReflection.source;
            document.getElementById('reflection-challenges').value = randomReflection.challenges;
            document.getElementById('reflection-supervision').value = randomReflection.supervision;

            // Clear existing recordings and add 3 sample segments
            document.getElementById('recordings-container').innerHTML = '';
            recordingSegmentCounter = 0;

            const sampleRecordingTranscripts = [
                // ç‰‡æ®µ 1: é–‹å ´èˆ‡å»ºç«‹é—œä¿‚
                `Co: ä½ å¥½ï¼Œæ­¡è¿ä½ ä¾†ã€‚ä»Šå¤©æƒ³èŠäº›ä»€éº¼å‘¢ï¼Ÿ
Cl: å—¯...æœ€è¿‘å·¥ä½œå£“åŠ›å¾ˆå¤§ï¼Œè¦ºå¾—å¿«è¦æ’ä¸ä¸‹å»äº†ã€‚
Co: è½èµ·ä¾†å¾ˆè¾›è‹¦ã€‚å¯ä»¥å¤šèªªä¸€äº›å—ï¼Ÿæ˜¯ä»€éº¼æ¨£çš„å£“åŠ›ï¼Ÿ
Cl: ä¸»ç®¡ç¸½æ˜¯å°æˆ‘çš„å·¥ä½œä¸æ»¿æ„ï¼Œä¸ç®¡æˆ‘æ€éº¼åšéƒ½è¦ºå¾—ä¸å¤ å¥½ã€‚
Co: è½èµ·ä¾†ä½ æ„Ÿåˆ°å¾ˆæŒ«æŠ˜ï¼Œå¯ä»¥åˆ†äº«ä¸€å€‹å…·é«”çš„ä¾‹å­å—ï¼Ÿ
Cl: ä¸Šé€±æˆ‘åšäº†ä¸€ä»½ä¼åŠƒæ¡ˆï¼ŒèŠ±äº†å¾ˆå¤šå¿ƒåŠ›ï¼Œä½†ä¸»ç®¡åªçœ‹äº†ä¸€çœ¼å°±èªªé€™ä¸æ˜¯ä»–è¦çš„ã€‚`,
                // ç‰‡æ®µ 2: æ·±å…¥æ¢ç´¢
                `Co: å‰›æ‰æåˆ°ä¸»ç®¡çš„åæ‡‰ï¼Œä½ ç•¶æ™‚çš„æ„Ÿå—æ˜¯ä»€éº¼ï¼Ÿ
Cl: æˆ‘è¦ºå¾—å¾ˆå›°æƒ‘ï¼Œä¹Ÿå¾ˆå—å‚·ã€‚æˆ‘æ˜æ˜å¾ˆåŠªåŠ›äº†...
Co: é€™ç¨®å›°æƒ‘å’Œå—å‚·çš„æ„Ÿè¦ºï¼Œèƒ½å†å…·é«”æè¿°å—ï¼Ÿ
Cl: å°±åƒ...ä¸ç®¡æˆ‘æ€éº¼åŠªåŠ›éƒ½å¾—ä¸åˆ°èªå¯ï¼Œé–‹å§‹æ‡·ç–‘è‡ªå·±æ˜¯ä¸æ˜¯çœŸçš„ä¸é©åˆé€™ä»½å·¥ä½œã€‚
Co: ä½ é–‹å§‹æ‡·ç–‘è‡ªå·±çš„èƒ½åŠ›äº†ï¼Ÿ
Cl: å°ï¼Œæˆ‘é–‹å§‹æƒ³ï¼Œä¹Ÿè¨±æˆ‘çœŸçš„åšä¸å¥½é€™å€‹è·ä½ã€‚`,
                // ç‰‡æ®µ 3: ç¸½çµèˆ‡ä¸‹æ¬¡æ–¹å‘
                `Co: é‚£æˆ‘å€‘ä¾†ç¸½çµä¸€ä¸‹ä»Šå¤©è«‡åˆ°çš„é‡é»ã€‚
Cl: å¥½çš„ï¼Œæˆ‘è¦ºå¾—ä»Šå¤©æ”¶ç©«å¾ˆå¤šã€‚
Co: ä½ æåˆ°äº†å·¥ä½œä¸Šçš„æŒ«æŠ˜æ„Ÿï¼Œä»¥åŠå°è‡ªå·±èƒ½åŠ›çš„æ‡·ç–‘ã€‚ä¸‹æ¬¡æˆ‘å€‘å¯ä»¥æ›´æ·±å…¥æ¢è¨é€™äº›è‡ªæˆ‘æ‡·ç–‘çš„ä¾†æºã€‚
Cl: å¥½çš„ï¼Œè¬è¬ä½ ã€‚æˆ‘æœƒè©¦è‘—è¨˜éŒ„é€™é€±çš„æƒ…ç·’è®ŠåŒ–ã€‚
Co: å¾ˆå¥½ï¼é‚£æˆ‘å€‘ä¸‹æ¬¡è¦‹ã€‚è¨˜å¾—è¦å¥½å¥½ç…§é¡§è‡ªå·±ã€‚
Cl: è¬è¬ï¼Œæˆ‘æœƒçš„ã€‚`
            ];

            // Add exactly 3 recording segments
            const numSegments = 3;

            // Create all segments first, then fill them
            for (let i = 0; i < numSegments; i++) {
                addRecordingSegment();
            }

            // Wait a bit for DOM to be ready, then fill all segments
            setTimeout(() => {
                for (let i = 0; i < numSegments; i++) {
                    const segmentId = i + 1; // segment IDs are 1, 2, 3
                    const segmentStartMinute = i * 20; // Each segment is ~20 minutes apart
                    const segmentDuration = 15 + Math.floor(Math.random() * 5); // 15-19 minutes duration
                    const segmentEndMinute = segmentStartMinute + segmentDuration;
                    const startHourSegment = startHour + Math.floor(segmentStartMinute / 60);
                    const startMinuteSegment = segmentStartMinute % 60;
                    const endHourSegment = startHour + Math.floor(segmentEndMinute / 60);
                    const endMinuteSegment = segmentEndMinute % 60;
                    const durationSeconds = segmentDuration * 60;

                    const startEl = document.getElementById(`recording-${segmentId}-start`);
                    const endEl = document.getElementById(`recording-${segmentId}-end`);
                    const durationEl = document.getElementById(`recording-${segmentId}-duration`);
                    const transcriptEl = document.getElementById(`recording-${segmentId}-transcript`);

                    if (startEl) startEl.value = `${String(startHourSegment).padStart(2, '0')}:${String(startMinuteSegment).padStart(2, '0')}`;
                    if (endEl) endEl.value = `${String(endHourSegment).padStart(2, '0')}:${String(endMinuteSegment).padStart(2, '0')}`;
                    if (durationEl) durationEl.value = durationSeconds;
                    if (transcriptEl) transcriptEl.value = sampleRecordingTranscripts[i];
                }

                // è‡ªå‹•èšåˆæ‰€æœ‰ recordings çš„ transcript_text åˆ°å®Œæ•´é€å­—ç¨¿
                const aggregatedTranscript = sampleRecordingTranscripts.join('\n\n');
                document.getElementById('session-transcript').value = aggregatedTranscript;
            }, 150); // Wait 150ms for all segments to be created
        };

        // Quick fill random client data
        window.quickFillRandomClient = () => {
            const names = ['ç‹å°æ˜', 'æå°è¯', 'é™³å¤§åŒ', 'å¼µç¾ç²', 'æ—å¿—å¼·', 'é»ƒæ·‘èŠ¬', 'åŠ‰å»ºåœ‹', 'å³ä½³ç©'];
            const nicknames = ['å°æ˜', 'å°è¯', 'å¤§åŒ', 'ç¾ç²', 'é˜¿å¼·', 'èŠ¬èŠ¬', 'å»ºåœ‹', 'ä½³ä½³'];
            const occupations = ['å·¥ç¨‹å¸«', 'è¨­è¨ˆå¸«', 'æ•™å¸«', 'é†«ç”Ÿ', 'è­·ç†å¸«', 'æœƒè¨ˆå¸«', 'æ¥­å‹™', 'è¡Œæ”¿'];
            const genders = ['male', 'female'];
            const educations = ['é«˜ä¸­ç•¢æ¥­', 'åœ‹ç«‹å°ç£å¤§å­¸', 'ç§ç«‹æ±å³å¤§å­¸', 'åœ‹ç«‹æ”¿æ²»å¤§å­¸', 'ç§ç«‹è¼”ä»å¤§å­¸', 'åœ‹ç«‹æˆåŠŸå¤§å­¸'];
            const locations = ['å°åŒ—å¸‚', 'æ–°åŒ—å¸‚', 'å°ä¸­å¸‚', 'å°å—å¸‚', 'é«˜é›„å¸‚', 'æ¡ƒåœ’å¸‚'];
            const economicStatuses = ['å¯è² æ“”æ—¥å¸¸åŠé€²ä¿®', 'ç¶“æ¿Ÿç©©å®š', 'éœ€å®¶äººæ”¯æŒ', 'ç¨ç«‹è‡ªä¸»', 'æ”¶å…¥ç©©å®š'];
            const familyRelations = [
                'çˆ¶æ¯æ”¯æŒï¼›èˆ‡å“¥å“¥åŒä½',
                'å–®è¦ªå®¶åº­ï¼›æ¯è¦ªç‚ºä¸»è¦æ”¯æŒ',
                'å·²å©šï¼›é…å¶é—œä¿‚è‰¯å¥½',
                'èˆ‡çˆ¶æ¯åŒä½ï¼›é—œä¿‚èæ´½',
                'ç¨å±…ï¼›èˆ‡å®¶äººä¿æŒè¯ç¹«',
                'èˆ‡ä¼´ä¾¶åŒå±…ï¼›å®¶äººçŸ¥æƒ…'
            ];
            const notes = [
                'åˆæ¬¡è«®å•†ï¼Œå°è·æ¶¯ç™¼å±•æœ‰ç–‘å•',
                'æ›¾æœ‰è½‰è·ç¶“é©—ï¼Œå¸Œæœ›ç¢ºèªæ–¹å‘',
                'å°æœªä¾†æ„Ÿåˆ°ç„¦æ…®ï¼Œéœ€è¦å¼•å°',
                'ç©æ¥µä¸»å‹•ï¼Œç›®æ¨™æ˜ç¢º',
                'éœ€è¦å»ºç«‹ä¿¡ä»»é—œä¿‚'
            ];
            const otherInfos = [
                'è¿‘åŠå¹´è€ƒæ…®è½‰è·ï¼›å°è·æ¶¯æ–¹å‘æ„Ÿåˆ°è¿·æƒ˜',
                'æ›¾åœ¨ç§‘æŠ€æ¥­å·¥ä½œä¸‰å¹´ï¼›å¸Œæœ›è½‰æ›è·‘é“',
                'å°ç›®å‰å·¥ä½œæ„Ÿåˆ°å€¦æ€ ï¼›æƒ³æ¢ç´¢æ–°å¯èƒ½',
                'æº–å‚™å‡ºåœ‹é€²ä¿®ï¼›éœ€è¦é‡æ¸…è·æ¶¯è¦åŠƒ',
                'å‰›ç•¢æ¥­ä¸€å¹´ï¼›å°æœªä¾†æ„Ÿåˆ°ä¸ç¢ºå®š'
            ];

            const randomIndex = Math.floor(Math.random() * names.length);

            // Generate random birth date (20-50 years old)
            const today = new Date();
            const age = Math.floor(Math.random() * 30) + 20;
            const birthYear = today.getFullYear() - age;
            const birthMonth = String(Math.floor(Math.random() * 12) + 1).padStart(2, '0');
            const birthDay = String(Math.floor(Math.random() * 28) + 1).padStart(2, '0');
            const birthDate = `${birthYear}-${birthMonth}-${birthDay}`;

            try {
                const fields = [
                    { id: 'client-name', value: names[randomIndex] },
                    { id: 'client-nickname', value: nicknames[randomIndex] },
                    { id: 'client-birth-date', value: birthDate },
                    { id: 'client-gender', value: genders[Math.floor(Math.random() * genders.length)] },
                    { id: 'client-occupation', value: occupations[Math.floor(Math.random() * occupations.length)] },
                    { id: 'client-education', value: educations[Math.floor(Math.random() * educations.length)] },
                    { id: 'client-location', value: locations[Math.floor(Math.random() * locations.length)] },
                    { id: 'client-economic-status', value: economicStatuses[Math.floor(Math.random() * economicStatuses.length)] },
                    { id: 'client-family-relations', value: familyRelations[Math.floor(Math.random() * familyRelations.length)] },
                    { id: 'client-other-info', value: otherInfos[Math.floor(Math.random() * otherInfos.length)] },
                    { id: 'client-notes', value: notes[Math.floor(Math.random() * notes.length)] }
                ];

                fields.forEach(field => {
                    const element = document.getElementById(field.id);
                    if (element) {
                        element.value = field.value;
                    } else {
                        console.warn(`Element not found: ${field.id}`);
                    }
                });
            } catch (error) {
                console.error('Error filling form:', error);
                alert('å¡«å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¢ºèªå·²åœ¨ã€Œå»ºç«‹å€‹æ¡ˆã€é é¢');
            }
        };

        // Quick fill function for dynamic client form
        window.quickFillClient = () => {
            if (!state.clientFieldSchema) {
                alert('æ¬„ä½é…ç½®æœªè¼‰å…¥');
                return;
            }

            const randomNames = ['ç‹å¤§æ˜', 'æå°è¯', 'å¼µç¾éº—', 'é™³å»ºåœ‹', 'æ—é›…å©·', 'å³å¿—å‰'];
            const randomEmails = ['test1@example.com', 'test2@example.com', 'user@test.com'];
            const randomPhones = ['0912345678', '0987654321', '0923456789'];

            // Fill Client fields
            state.clientFieldSchema.sections.forEach(section => {
                section.fields.forEach(field => {
                    const inputId = `client-${field.key}`;
                    const element = document.getElementById(inputId);
                    if (!element) return;

                    switch (field.type) {
                        case 'text':
                            if (field.key === 'name') {
                                element.value = randomNames[Math.floor(Math.random() * randomNames.length)];
                            } else if (field.key === 'location') {
                                element.value = ['å°åŒ—å¸‚', 'æ–°åŒ—å¸‚', 'å°ä¸­å¸‚', 'é«˜é›„å¸‚'][Math.floor(Math.random() * 4)];
                            } else if (field.key === 'current_job') {
                                element.value = 'è»Ÿé«”å·¥ç¨‹å¸« / 3å¹´';
                            } else if (field.key === 'current_status') {
                                element.value = 'æ¢ç´¢ä¸­';
                            } else {
                                element.value = 'æ¸¬è©¦è³‡æ–™';
                            }
                            break;
                        case 'email':
                            element.value = randomEmails[Math.floor(Math.random() * randomEmails.length)];
                            break;
                        case 'phone':
                            element.value = randomPhones[Math.floor(Math.random() * randomPhones.length)];
                            break;
                        case 'date':
                            element.value = '1990-01-15';
                            break;
                        case 'single_select':
                            if (field.options && field.options.length > 0) {
                                const randomIndex = Math.floor(Math.random() * field.options.length);
                                element.value = field.options[randomIndex];
                            }
                            break;
                        case 'textarea':
                            element.value = 'é€™æ˜¯æ¸¬è©¦è³‡æ–™';
                            break;
                    }
                });
            });

            // Fill Case fields
            state.caseFieldSchema.sections.forEach(section => {
                section.fields.forEach(field => {
                    if (field.key === 'case_number') return; // Skip auto-generated
                    const inputId = `case-${field.key}`;
                    const element = document.getElementById(inputId);
                    if (!element) return;

                    switch (field.type) {
                        case 'single_select':
                            if (field.options && field.options.length > 0) {
                                // Use default value if available, otherwise random
                                element.value = field.default_value || field.options[0];
                            }
                            break;
                        case 'textarea':
                            if (field.key === 'problem_description') {
                                element.value = 'å¸Œæœ›é‡æ¸…è·æ¶¯æ–¹å‘ï¼Œæ¢ç´¢é©åˆçš„ç™¼å±•è·¯å¾‘';
                            } else if (field.key === 'goals') {
                                element.value = 'å”åŠ©å€‹æ¡ˆæ¢ç´¢è·æ¶¯æ–¹å‘ã€æº–å‚™é¢è©¦æŠ€å·§';
                            } else if (field.key === 'summary') {
                                element.value = 'å€‹æ¡ˆå°æœªä¾†æ„Ÿåˆ°è¿·æƒ˜ï¼Œå¸Œæœ›é€éè«®è©¢æ‰¾åˆ°æ–¹å‘';
                            } else {
                                element.value = 'æ¸¬è©¦è³‡æ–™';
                            }
                            break;
                    }
                });
            });
        };

        // Quick fill function for append recording
        window.quickFillAppendRecording = () => {
            const now = new Date();
            const startTime = new Date(now.getTime() - 30 * 60000); // 30 minutes ago
            const endTime = new Date(now.getTime() - 10 * 60000); // 10 minutes ago

            const sampleTranscripts = [
                `Co: ä»Šå¤©æƒ³èŠäº›ä»€éº¼å‘¢ï¼Ÿ
Cl: æœ€è¿‘å·¥ä½œå£“åŠ›å¾ˆå¤§ï¼Œè¦ºå¾—å¿«è¦æ’ä¸ä¸‹å»äº†ã€‚
Co: å¯ä»¥å¤šèªªä¸€äº›å—ï¼Ÿæ˜¯ä»€éº¼æ¨£çš„å£“åŠ›ï¼Ÿ
Cl: ä¸»ç®¡ç¸½æ˜¯å°æˆ‘çš„å·¥ä½œä¸æ»¿æ„ï¼Œä¸ç®¡æˆ‘æ€éº¼åšéƒ½è¦ºå¾—ä¸å¤ å¥½ã€‚`,
                `Co: ä¸Šæ¬¡æåˆ°çš„è·æ¶¯æ–¹å‘ï¼Œæœ‰æ–°çš„æƒ³æ³•å—ï¼Ÿ
Cl: æˆ‘ä¸€ç›´åœ¨æ€è€ƒï¼Œä½†é‚„æ˜¯å¾ˆè¿·èŒ«ã€‚
Co: è¿·èŒ«çš„æ„Ÿè¦ºæ˜¯ä»€éº¼ï¼Ÿ
Cl: ä¸çŸ¥é“è‡ªå·±é©åˆåšä»€éº¼ï¼Œä¹Ÿä¸ç¢ºå®šç¾åœ¨çš„å·¥ä½œæ˜¯ä¸æ˜¯å°çš„é¸æ“‡ã€‚`,
                `Co: ä»Šå¤©çœ‹èµ·ä¾†å¿ƒæƒ…ä¸éŒ¯ï¼Ÿ
Cl: å°å•Šï¼Œé€™é€±å·¥ä½œé †åˆ©å¾ˆå¤šï¼Œä¸»ç®¡ä¹Ÿç¨±è®šäº†æˆ‘ã€‚
Co: å¾ˆé«˜èˆˆè½åˆ°é€™å€‹æ¶ˆæ¯ï¼æ˜¯ä»€éº¼æ”¹è®Šäº†ï¼Ÿ
Cl: æˆ‘é–‹å§‹ç”¨ä½ ä¸Šæ¬¡å»ºè­°çš„æ–¹æ³•ï¼Œå…ˆç¢ºèªä¸»ç®¡çš„éœ€æ±‚å†é–‹å§‹åšã€‚`
            ];

            const randomTranscript = sampleTranscripts[Math.floor(Math.random() * sampleTranscripts.length)];
            const durationSeconds = 1200; // 20 minutes

            // Format times as "YYYY-MM-DD HH:MM"
            const formatTime = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day} ${hours}:${minutes}`;
            };

            document.getElementById('append-start-time').value = formatTime(startTime);
            document.getElementById('append-end-time').value = formatTime(endTime);
            document.getElementById('append-duration').value = durationSeconds;
            document.getElementById('append-transcript').value = randomTranscript;
            document.getElementById('append-transcript-sanitized').value = ''; // Leave empty for auto-fill
        };

        // Quick fill function for case creation
        window.quickFillCase = () => {
            const summaryEl = document.getElementById('create-case-summary');
            const goalsEl = document.getElementById('create-case-goals');
            const problemEl = document.getElementById('create-case-problem');
            const statusEl = document.getElementById('create-case-status');

            const sampleData = [
                {
                    summary: 'å€‹æ¡ˆå°æœªä¾†æ„Ÿåˆ°è¿·æƒ˜ï¼Œå¸Œæœ›é€éè«®è©¢æ‰¾åˆ°æ–¹å‘',
                    goals: 'å”åŠ©å€‹æ¡ˆæ¢ç´¢è·æ¶¯æ–¹å‘ã€æº–å‚™é¢è©¦æŠ€å·§',
                    problem: 'å¸Œæœ›é‡æ¸…è·æ¶¯æ–¹å‘ï¼Œæ¢ç´¢é©åˆçš„ç™¼å±•è·¯å¾‘'
                },
                {
                    summary: 'è·å ´é©æ‡‰å›°é›£ï¼Œèˆ‡ä¸»ç®¡é—œä¿‚ç·Šå¼µ',
                    goals: 'æ”¹å–„è·å ´äººéš›é—œä¿‚ã€æå‡æºé€šæŠ€å·§',
                    problem: 'åœ¨å·¥ä½œä¸­æ„Ÿåˆ°å£“åŠ›å¤§ï¼Œèˆ‡ä¸»ç®¡æºé€šä¸è‰¯'
                },
                {
                    summary: 'è½‰è·æº–å‚™éšæ®µï¼Œéœ€è¦å±¥æ­·èˆ‡é¢è©¦æŒ‡å°',
                    goals: 'å„ªåŒ–å±¥æ­·ã€æå‡é¢è©¦è¡¨ç¾ã€å»ºç«‹æ±‚è·ä¿¡å¿ƒ',
                    problem: 'æƒ³è½‰æ›è·æ¶¯è·‘é“ï¼Œä½†ä¸çŸ¥å¦‚ä½•æº–å‚™'
                }
            ];

            const randomData = sampleData[Math.floor(Math.random() * sampleData.length)];

            if (summaryEl) summaryEl.value = randomData.summary;
            if (goalsEl) goalsEl.value = randomData.goals;
            if (problemEl) problemEl.value = randomData.problem;
            if (statusEl) statusEl.value = 'active';
        };

        // Step execution functions
        window.executeLogin = () => executeStep('login');
        window.executeMe = () => executeStep('me');
        window.executeGetClientFieldSchema = () => executeStep('get-client-field-schema');
        window.executeGetCaseFieldSchema = () => executeStep('get-case-field-schema');
        window.executeListClients = () => executeStep('list-clients');
        window.executeCreateClient = () => executeStep('create-client');
        window.executeViewClient = () => executeStep('view-client');
        window.executeClientTimeline = () => executeStep('client-timeline');
        window.executeUpdateClient = () => executeStep('update-client');
        window.executeDeleteClient = () => executeStep('delete-client');
        window.executeListCases = () => executeStep('list-cases');
        window.executeCreateCase = () => executeStep('create-case');
        window.executeViewCase = () => executeStep('view-case');
        window.executeUpdateCase = () => executeStep('update-case');
        window.executeDeleteCase = () => executeStep('delete-case');
        window.executeCreateSession = () => executeStep('create-session');
        window.executeListSessions = () => executeStep('list-sessions');
        window.executeViewSession = () => executeStep('view-session');
        window.executeUpdateSession = () => executeStep('update-session');
        window.executeDeleteSession = () => executeStep('delete-session');
        window.executeGetReflection = () => executeStep('get-reflection');
        window.executeUpdateReflection = () => executeStep('update-reflection');
        window.executeAppendRecording = () => executeStep('append-recording');
        window.executeUpdateCounselor = () => executeStep('update-counselor');
        window.executeGenerateReport = () => executeStep('generate-report');
        window.executeListReports = () => executeStep('list-reports');
        window.executeViewReport = () => executeStep('view-report');
        window.executeUpdateReport = () => executeStep('update-report');

        // Client-Case CRUD functions
        window.executeListClientCases = () => executeStep('list-client-cases');
        window.executeCreateClientCase = () => executeStep('create-client-case');
        window.executeUpdateClientCase = () => executeStep('update-client-case');
        window.executeDeleteClientCase = () => executeStep('delete-client-case');

        // Auto-select first step
        selectStep('login');

        // Load token from localStorage on startup
        if (state.token) {
            fetch(`${BASE_URL}/api/auth/me`, {
                headers: { 'Authorization': `Bearer ${state.token}` }
            }).then(r => r.json()).then(data => {
                if (data.email) {
                    state.currentUser = data;
                    console.log('Token valid, user:', data.email);
                }
            }).catch(() => {
                localStorage.removeItem('token');
                state.token = '';
            });
        }

        // Group collapse functionality
        document.querySelectorAll('.flow-group-title').forEach(title => {
            title.addEventListener('click', () => {
                const groupName = title.dataset.group;
                const content = document.querySelector(`[data-group-content="${groupName}"]`);
                title.classList.toggle('collapsed');
                content.classList.toggle('collapsed');
            });
        });
    </script>
</body>
</html>
