<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOS API Test Console</title>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Left Sidebar - Flow */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h2 {
            font-size: 18px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .flow-group-title {
            font-size: 14px;
            font-weight: 700;
            color: #ffffff;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-top: 24px;
            margin-bottom: 12px;
            padding: 14px 12px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.18));
            border-radius: 10px;
            border-left: 4px solid #10b981;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .flow-group-title:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.32), rgba(255, 255, 255, 0.25));
            transform: translateX(2px);
        }

        .flow-group-title:first-of-type {
            margin-top: 0;
        }

        .flow-group-title::after {
            content: 'â–¼';
            font-size: 12px;
            transition: transform 0.3s;
        }

        .flow-group-title.collapsed::after {
            transform: rotate(-90deg);
        }

        .flow-group-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s;
            opacity: 1;
            margin-bottom: 8px;
            padding-left: 8px;
        }

        .flow-group-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .flow-step {
            margin-bottom: 8px;
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            background: rgba(255, 255, 255, 0.05);
        }

        .flow-step:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .flow-step.active {
            background: rgba(255, 255, 255, 0.15);
            border-left-color: #10b981;
        }

        .flow-step.completed {
            background: rgba(16, 185, 129, 0.2);
            border-left-color: #10b981;
        }

        .flow-step.error {
            background: rgba(239, 68, 68, 0.2);
            border-left-color: #ef4444;
        }

        .step-number {
            display: inline-block;
            width: 28px;
            height: 28px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            font-size: 13px;
            font-weight: 600;
            margin-right: 10px;
            color: rgba(255, 255, 255, 0.9);
        }

        .flow-step.completed .step-number {
            background: #10b981;
        }

        .flow-step.error .step-number {
            background: #ef4444;
        }

        .step-title {
            font-size: 14px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.95);
        }

        .step-subtitle {
            font-size: 11px;
            opacity: 0.6;
            margin-top: 2px;
            font-family: 'Courier New', monospace;
        }

        /* Center Panel - Preview */
        .preview-panel {
            flex: 1;
            background: #f9fafb;
            padding: 30px;
            overflow-y: auto;
        }

        .preview-header {
            margin-bottom: 20px;
        }

        .preview-header h1 {
            font-size: 24px;
            color: #111827;
            margin-bottom: 8px;
        }

        .preview-header p {
            color: #6b7280;
            font-size: 14px;
        }

        .preview-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            min-height: 400px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        /* Right Panel - Actions & Response */
        .action-panel {
            width: 420px;
            background: white;
            border-left: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
        }

        .action-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .action-header h3 {
            font-size: 16px;
            color: #111827;
            margin-bottom: 4px;
        }

        .action-header p {
            font-size: 12px;
            color: #6b7280;
        }

        .action-form {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            width: 100%;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .response-section {
            border-top: 1px solid #e5e7eb;
            padding: 20px;
            background: #f9fafb;
            max-height: 300px;
            overflow-y: auto;
        }

        .response-title {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 10px;
        }

        .response-content {
            background: #1f2937;
            color: #e5e7eb;
            padding: 12px;
            border-radius: 6px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        /* Report Preview Styles */
        .report-section {
            margin-bottom: 24px;
        }

        .report-section h3 {
            font-size: 18px;
            color: #111827;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb;
        }

        .report-section h4 {
            font-size: 14px;
            color: #374151;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .report-section p {
            font-size: 14px;
            color: #4b5563;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .theory-item {
            background: #f0f9ff;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            border-left: 3px solid #3b82f6;
        }

        .theory-meta {
            font-size: 12px;
            color: #6b7280;
            margin-top: 6px;
        }

        .dialogue-item {
            margin-bottom: 16px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
        }

        .dialogue-speaker {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 4px;
            font-size: 13px;
        }

        .dialogue-content {
            font-size: 14px;
            color: #374151;
            line-height: 1.5;
        }

        .quality-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .quality-grade {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .quality-score {
            font-size: 14px;
            opacity: 0.9;
        }

        .info-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-size: 13px;
            color: #6b7280;
        }

        .info-value {
            font-size: 13px;
            color: #111827;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Sidebar: Flow Steps -->
        <div class="sidebar">
            <h2>ğŸ“± iOS API æ¸¬è©¦æµç¨‹</h2>

            <!-- è«®å•†å¸«ç®¡ç† -->
            <div class="flow-group-title" data-group="auth">ğŸ‘¤ èªè­‰ç®¡ç† Auth</div>
            <div class="flow-group-content" data-group-content="auth">
                <div class="flow-step" data-step="login">
                    <div>
                        <span class="step-number">1</span>
                        <span class="step-title">ç™»å…¥é©—è­‰</span>
                    </div>
                    <div class="step-subtitle">POST /auth/login</div>
                </div>

                <div class="flow-step" data-step="me">
                    <div>
                        <span class="step-number">2</span>
                        <span class="step-title">å–å¾—è«®å•†å¸«è³‡è¨Š</span>
                    </div>
                    <div class="step-subtitle">GET /auth/me</div>
                </div>

                <div class="flow-step" data-step="update-counselor">
                    <div>
                        <span class="step-number">3</span>
                        <span class="step-title">æ›´æ–°è«®å•†å¸«è³‡è¨Š</span>
                    </div>
                    <div class="step-subtitle">PATCH /auth/me</div>
                </div>
            </div>

            <!-- å€‹æ¡ˆç®¡ç† -->
            <div class="flow-group-title" data-group="client">ğŸ‘¥ å€‹æ¡ˆç®¡ç† Client</div>
            <div class="flow-group-content" data-group-content="client">

            <div class="flow-step" data-step="list-clients">
                <div>
                    <span class="step-number">4</span>
                    <span class="step-title">åˆ—å‡ºå€‹æ¡ˆ</span>
                </div>
                <div class="step-subtitle">GET /api/v1/clients</div>
            </div>

            <div class="flow-step" data-step="create-client">
                <div>
                    <span class="step-number">5</span>
                    <span class="step-title">å»ºç«‹å€‹æ¡ˆ</span>
                </div>
                <div class="step-subtitle">POST /api/v1/clients</div>
            </div>

            <div class="flow-step" data-step="view-client">
                <div>
                    <span class="step-number">6</span>
                    <span class="step-title">æŸ¥çœ‹å€‹æ¡ˆ</span>
                </div>
                <div class="step-subtitle">GET /api/v1/clients/{id}</div>
            </div>

            <div class="flow-step" data-step="update-client">
                <div>
                    <span class="step-number">7</span>
                    <span class="step-title">æ›´æ–°å€‹æ¡ˆ</span>
                </div>
                <div class="step-subtitle">PATCH /api/v1/clients/{id}</div>
            </div>

            <div class="flow-step" data-step="delete-client">
                <div>
                    <span class="step-number">8</span>
                    <span class="step-title">åˆªé™¤å€‹æ¡ˆ</span>
                </div>
                <div class="step-subtitle">DELETE /api/v1/clients/{id}</div>
            </div>
            </div>

            <!-- æœƒè«‡ç®¡ç† -->
            <div class="flow-group-title" data-group="session">ğŸ“ æœƒè«‡ç®¡ç† Session</div>
            <div class="flow-group-content" data-group-content="session">

            <div class="flow-step" data-step="create-session">
                <div>
                    <span class="step-number">9</span>
                    <span class="step-title">å»ºç«‹æœƒè«‡è¨˜éŒ„</span>
                </div>
                <div class="step-subtitle">POST /api/v1/sessions</div>
            </div>

            <div class="flow-step" data-step="list-sessions">
                <div>
                    <span class="step-number">10</span>
                    <span class="step-title">åˆ—å‡ºæœƒè«‡è¨˜éŒ„</span>
                </div>
                <div class="step-subtitle">GET /api/v1/sessions</div>
            </div>

            <div class="flow-step" data-step="view-session">
                <div>
                    <span class="step-number">11</span>
                    <span class="step-title">æŸ¥çœ‹æœƒè«‡è©³æƒ…</span>
                </div>
                <div class="step-subtitle">GET /api/v1/sessions/{id}</div>
            </div>

            <div class="flow-step" data-step="update-session">
                <div>
                    <span class="step-number">12</span>
                    <span class="step-title">æ›´æ–°æœƒè«‡è¨˜éŒ„</span>
                </div>
                <div class="step-subtitle">PATCH /api/v1/sessions/{id}</div>
            </div>

            <div class="flow-step" data-step="delete-session">
                <div>
                    <span class="step-number">13</span>
                    <span class="step-title">åˆªé™¤æœƒè«‡è¨˜éŒ„</span>
                </div>
                <div class="step-subtitle">DELETE /api/v1/sessions/{id}</div>
            </div>

            <div class="flow-step" data-step="client-timeline">
                <div>
                    <span class="step-number">14</span>
                    <span class="step-title">æŸ¥çœ‹å€‹æ¡ˆæ­·ç¨‹</span>
                </div>
                <div class="step-subtitle">GET /api/v1/sessions/timeline</div>
            </div>

            <div class="flow-step" data-step="get-reflection">
                <div>
                    <span class="step-number">15</span>
                    <span class="step-title">æŸ¥çœ‹åæ€</span>
                </div>
                <div class="step-subtitle">GET /api/v1/sessions/{id}/reflection</div>
            </div>

            <div class="flow-step" data-step="update-reflection">
                <div>
                    <span class="step-number">16</span>
                    <span class="step-title">æ›´æ–°åæ€</span>
                </div>
                <div class="step-subtitle">PUT /api/v1/sessions/{id}/reflection</div>
            </div>
            </div>

            <!-- å ±å‘Šç®¡ç† -->
            <div class="flow-group-title" data-group="report">ğŸ“„ å ±å‘Šç®¡ç† Report</div>
            <div class="flow-group-content" data-group-content="report">

            <div class="flow-step" data-step="generate-report">
                <div>
                    <span class="step-number">17</span>
                    <span class="step-title">ç”Ÿæˆå ±å‘Š</span>
                </div>
                <div class="step-subtitle">POST /api/v1/reports/generate</div>
            </div>

            <div class="flow-step" data-step="list-reports">
                <div>
                    <span class="step-number">18</span>
                    <span class="step-title">åˆ—å‡ºå ±å‘Š</span>
                </div>
                <div class="step-subtitle">GET /api/v1/reports</div>
            </div>

            <div class="flow-step" data-step="view-report">
                <div>
                    <span class="step-number">19</span>
                    <span class="step-title">æŸ¥çœ‹å ±å‘Š</span>
                </div>
                <div class="step-subtitle">GET /api/v1/reports/{id}</div>
            </div>

            <div class="flow-step" data-step="update-report">
                <div>
                    <span class="step-number">20</span>
                    <span class="step-title">æ›´æ–°å ±å‘Š</span>
                </div>
                <div class="step-subtitle">PATCH /api/v1/reports/{id}</div>
            </div>
            </div>

        </div>

        <!-- Center Panel: Preview -->
        <div class="preview-panel">
            <div class="preview-header">
                <h1 id="preview-title">iOS API æ¸¬è©¦æ§åˆ¶å°</h1>
                <p id="preview-subtitle">é¸æ“‡å·¦å´æµç¨‹æ­¥é©Ÿé–‹å§‹æ¸¬è©¦</p>
            </div>
            <div class="preview-content" id="preview-content">
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <p>è«‹å¾å·¦å´é¸æ“‡ API æ­¥é©Ÿ</p>
                </div>
            </div>
        </div>

        <!-- Right Panel: Actions & Response -->
        <div class="action-panel">
            <div class="action-header">
                <h3 id="action-title">è«‹é¸æ“‡æ­¥é©Ÿ</h3>
                <p id="action-subtitle">å¡«å¯«åƒæ•¸ä¸¦åŸ·è¡Œ API å‘¼å«</p>
            </div>

            <div class="action-form" id="action-form">
                <div class="empty-state">
                    <p>è«‹å¾å·¦å´é¸æ“‡æ­¥é©Ÿ</p>
                </div>
            </div>

            <div class="response-section" id="response-section" style="display: none;">
                <div class="response-title">Response</div>
                <div id="response-status"></div>
                <div class="response-content" id="response-content"></div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let state = {
            token: localStorage.getItem('token') || '',
            currentUser: null,
            clients: [],
            sessions: [],
            reports: [],
            currentClient: null,
            currentSession: null,
            currentReport: null
        };

        const BASE_URL = window.location.origin;

        // Step configurations
        const steps = {
            login: {
                title: 'ç™»å…¥é©—è­‰',
                subtitle: 'POST /auth/login',
                renderForm: () => `
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="email" value="test@career.com" />
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="password" value="password123" />
                    </div>
                    <button class="btn btn-primary" onclick="executeLogin()">ç™»å…¥</button>
                `,
                execute: async () => {
                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;

                    const response = await fetch(`${BASE_URL}/api/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });

                    const data = await response.json();
                    if (response.ok) {
                        state.token = data.access_token;
                        localStorage.setItem('token', state.token);
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>ğŸ” ç™»å…¥æˆåŠŸ</h3>
                        <div class="info-row">
                            <span class="info-label">Token Type</span>
                            <span class="info-value">${data.token_type}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Expires In</span>
                            <span class="info-value">${data.expires_in}s</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Access Token</span>
                            <span class="info-value" style="font-size: 11px; word-break: break-all;">${data.access_token.substring(0, 40)}...</span>
                        </div>
                    </div>
                `
            },
            me: {
                title: 'å–å¾—ç•¶å‰ç”¨æˆ¶',
                subtitle: 'GET /auth/me',
                renderForm: () => `
                    <div class="info-card">
                        <p style="font-size: 13px; color: #6b7280;">éœ€è¦å…ˆç™»å…¥å–å¾— Token</p>
                    </div>
                    <button class="btn btn-primary" onclick="executeMe()" ${!state.token ? 'disabled' : ''}>å–å¾—ç”¨æˆ¶è³‡è¨Š</button>
                `,
                execute: async () => {
                    const response = await fetch(`${BASE_URL}/api/auth/me`, {
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.currentUser = data;
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>ğŸ‘¤ ç”¨æˆ¶è³‡è¨Š</h3>
                        <div class="info-row">
                            <span class="info-label">å§“å</span>
                            <span class="info-value">${data.full_name}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Email</span>
                            <span class="info-value">${data.email}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">è§’è‰²</span>
                            <span class="info-value">${data.role}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç§Ÿæˆ¶</span>
                            <span class="info-value">${data.tenant_id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç‹€æ…‹</span>
                            <span class="info-value">${data.is_active ? 'âœ… å•Ÿç”¨' : 'âŒ åœç”¨'}</span>
                        </div>
                    </div>
                `
            },
            'list-clients': {
                title: 'åˆ—å‡ºå€‹æ¡ˆ',
                subtitle: 'GET /api/v1/clients',
                renderForm: () => `
                    <div class="form-group">
                        <label>Search (optional)</label>
                        <input type="text" id="search" placeholder="æœå°‹å§“åã€ä»£ç¢¼..." />
                    </div>
                    <button class="btn btn-primary" onclick="executeListClients()" ${!state.token ? 'disabled' : ''}>æŸ¥è©¢å€‹æ¡ˆ</button>
                `,
                execute: async () => {
                    const search = document.getElementById('search').value;
                    const params = new URLSearchParams();
                    if (search) params.append('search', search);

                    const response = await fetch(`${BASE_URL}/api/v1/clients?${params}`, {
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.clients = data.items;
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <h3>ğŸ“‹ å€‹æ¡ˆåˆ—è¡¨ (å…± ${data.total} ç­†)</h3>
                    ${data.items.map(client => `
                        <div class="info-card">
                            <div class="info-row">
                                <span class="info-label">å§“å</span>
                                <span class="info-value">${client.name}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ä»£ç¢¼</span>
                                <span class="info-value">${client.code}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">å¹´é½¡</span>
                                <span class="info-value">${client.age || 'N/A'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">å»ºç«‹æ™‚é–“</span>
                                <span class="info-value">${new Date(client.created_at).toLocaleString('zh-TW')}</span>
                            </div>
                        </div>
                    `).join('')}
                `
            },
            'create-client': {
                title: 'å»ºç«‹å€‹æ¡ˆ',
                subtitle: 'POST /api/v1/clients',
                renderForm: () => `
                    <div class="form-group">
                        <label>å§“å *</label>
                        <input type="text" id="client-name" placeholder="è«‹è¼¸å…¥å§“å" required />
                    </div>
                    <div class="form-group">
                        <label>æš±ç¨±</label>
                        <input type="text" id="client-nickname" placeholder="è«‹è¼¸å…¥æš±ç¨±" />
                    </div>
                    <div class="form-group">
                        <label>å‡ºç”Ÿæ—¥æœŸ (å¿…å¡«ï¼Œç”¨æ–¼è‡ªå‹•è¨ˆç®—å¹´é½¡)</label>
                        <input type="date" id="client-birth-date" required />
                    </div>
                    <div class="form-group">
                        <label>æ€§åˆ¥</label>
                        <select id="client-gender">
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="male">ç”·æ€§</option>
                            <option value="female">å¥³æ€§</option>
                            <option value="other">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>è·æ¥­</label>
                        <input type="text" id="client-occupation" placeholder="è«‹è¼¸å…¥è·æ¥­" />
                    </div>
                    <div class="form-group">
                        <label>å­¸æ­·</label>
                        <input type="text" id="client-education" placeholder="ä¾‹å¦‚ï¼šåœ‹ç«‹OOå¤§å­¸" />
                    </div>
                    <div class="form-group">
                        <label>ç¾å±…åœ°</label>
                        <input type="text" id="client-location" placeholder="ä¾‹å¦‚ï¼šå°åŒ—å¸‚" />
                    </div>
                    <div class="form-group">
                        <label>ç¶“æ¿Ÿç‹€æ³</label>
                        <input type="text" id="client-economic-status" placeholder="ä¾‹å¦‚ï¼šå¯è² æ“”æ—¥å¸¸åŠé€²ä¿®" />
                    </div>
                    <div class="form-group">
                        <label>å®¶åº­é—œä¿‚</label>
                        <textarea id="client-family-relations" rows="2" placeholder="ä¾‹å¦‚ï¼šçˆ¶æ¯æ”¯æŒå‡å­¸ï¼›èˆ‡å“¥å“¥åŒä½"></textarea>
                    </div>
                    <div class="form-group">
                        <label>å…¶ä»–é‡è¦è³‡è¨Š</label>
                        <textarea id="client-other-info" rows="2" placeholder="ä¾‹å¦‚ï¼šè¿‘åŠå¹´è€ƒæ…®è½‰è·ï¼›å°è·æ¶¯æ–¹å‘æ„Ÿåˆ°è¿·æƒ˜"></textarea>
                    </div>
                    <div class="form-group">
                        <label>å‚™è¨» (ç§äºº)</label>
                        <textarea id="client-notes" rows="2" placeholder="è«®å•†å¸«ç§äººå‚™è¨»"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="executeCreateClient()" ${!state.token ? 'disabled' : ''}>å»ºç«‹å€‹æ¡ˆ</button>
                        <button class="btn btn-secondary" onclick="quickFillRandomClient()" ${!state.token ? 'disabled' : ''} style="background: #6366f1;">ğŸ² å¿«é€Ÿå¡«å…¥æ¸¬è©¦è³‡æ–™</button>
                    </div>
                `,
                execute: async () => {
                    const clientData = {
                        name: document.getElementById('client-name').value,
                        nickname: document.getElementById('client-nickname').value || undefined,
                        birth_date: document.getElementById('client-birth-date').value || undefined,
                        gender: document.getElementById('client-gender').value || undefined,
                        occupation: document.getElementById('client-occupation').value || undefined,
                        education: document.getElementById('client-education').value || undefined,
                        location: document.getElementById('client-location').value || undefined,
                        economic_status: document.getElementById('client-economic-status').value || undefined,
                        family_relations: document.getElementById('client-family-relations').value || undefined,
                        notes: document.getElementById('client-notes').value || undefined
                    };

                    // Handle other_info as JSON string
                    const otherInfoText = document.getElementById('client-other-info').value.trim();
                    if (otherInfoText) {
                        clientData.other_info = { description: otherInfoText };
                    }

                    // Code is always auto-generated, don't send it

                    // Remove undefined values
                    Object.keys(clientData).forEach(key => clientData[key] === undefined && delete clientData[key]);

                    const response = await fetch(`${BASE_URL}/api/v1/clients`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(clientData)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.currentClient = data;
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>âœ… å€‹æ¡ˆå»ºç«‹æˆåŠŸ</h3>
                        <div class="info-row">
                            <span class="info-label">ID</span>
                            <span class="info-value" style="font-size: 11px;">${data.id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å§“å</span>
                            <span class="info-value">${data.name}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ä»£ç¢¼</span>
                            <span class="info-value">${data.code}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å¹´é½¡</span>
                            <span class="info-value">${data.age}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æ€§åˆ¥</span>
                            <span class="info-value">${data.gender}</span>
                        </div>
                    </div>
                `
            },
            'view-client': {
                title: 'æŸ¥çœ‹å€‹æ¡ˆ',
                subtitle: 'GET /api/v1/clients/{id}',
                init: async () => {
                    // Refresh client list before showing view form
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/clients`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.clients = data.items;
                                // Re-render form with updated list
                                document.getElementById('action-form').innerHTML = steps['view-client'].renderForm();
                            }
                        } catch (error) {
                            console.error('Failed to refresh client list:', error);
                        }
                    }
                },
                renderForm: () => {
                    const clientOptions = state.clients.map(c =>
                        `<option value="${c.id}">${c.name} (${c.code})</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>é¸æ“‡å€‹æ¡ˆ *</label>
                            <select id="view-client-id">
                                ${state.currentClient ? `<option value="${state.currentClient.id}" selected>${state.currentClient.name} (${state.currentClient.code})</option>` : ''}
                                ${clientOptions}
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="executeViewClient()" ${!state.token || state.clients.length === 0 ? 'disabled' : ''}>æŸ¥çœ‹å€‹æ¡ˆ</button>
                    `;
                },
                execute: async () => {
                    const clientId = document.getElementById('view-client-id').value;

                    const response = await fetch(`${BASE_URL}/api/v1/clients/${clientId}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${state.token}`
                        }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.currentClient = data;
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>ğŸ‘¤ å€‹æ¡ˆè³‡è¨Š</h3>
                        <div class="info-row">
                            <span class="info-label">ID</span>
                            <span class="info-value" style="font-size: 11px;">${data.id || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å§“å</span>
                            <span class="info-value">${data.name || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ä»£ç¢¼</span>
                            <span class="info-value">${data.code || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æš±ç¨±</span>
                            <span class="info-value">${data.nickname || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å‡ºç”Ÿæ—¥æœŸ</span>
                            <span class="info-value">${data.birth_date || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å¹´é½¡</span>
                            <span class="info-value">${data.age || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æ€§åˆ¥</span>
                            <span class="info-value">${data.gender || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">è·æ¥­</span>
                            <span class="info-value">${data.occupation || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å­¸æ­·</span>
                            <span class="info-value">${data.education || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç¾å±…åœ°</span>
                            <span class="info-value">${data.location || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç¶“æ­·ç‹€æ³</span>
                            <span class="info-value">${data.economic_status || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å®¶åº­é—œä¿‚</span>
                            <span class="info-value">${data.family_relations || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å…¶ä»–é‡è¦è³‡è¨Š</span>
                            <span class="info-value">${data.other_info && data.other_info.description ? data.other_info.description : (data.other_info && Object.keys(data.other_info).length > 0 ? JSON.stringify(data.other_info) : 'N/A')}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æ¨™ç±¤</span>
                            <span class="info-value">${data.tags && data.tags.length > 0 ? data.tags.join(', ') : 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å‚™è¨»</span>
                            <span class="info-value">${data.notes || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å»ºç«‹æ™‚é–“</span>
                            <span class="info-value">${new Date(data.created_at).toLocaleString('zh-TW')}</span>
                        </div>
                    </div>
                `
            },
            'client-timeline': {
                title: 'æŸ¥çœ‹å€‹æ¡ˆæ­·ç¨‹',
                subtitle: 'GET /api/v1/sessions/timeline',
                init: async () => {
                    // Refresh client list before showing timeline form
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/clients`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.clients = data.items;
                                // Re-render form with updated list
                                document.getElementById('action-form').innerHTML = steps['client-timeline'].renderForm();
                            }
                        } catch (error) {
                            console.error('Failed to refresh client list:', error);
                        }
                    }
                },
                renderForm: () => {
                    const clientOptions = state.clients.map(c =>
                        `<option value="${c.id}">${c.name} (${c.code})</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>é¸æ“‡å€‹æ¡ˆ *</label>
                            <select id="timeline-client-id">
                                ${state.currentClient ? `<option value="${state.currentClient.id}" selected>${state.currentClient.name} (${state.currentClient.code})</option>` : ''}
                                ${clientOptions}
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="executeClientTimeline()" ${!state.token || state.clients.length === 0 ? 'disabled' : ''}>æŸ¥çœ‹æ­·ç¨‹</button>
                    `;
                },
                execute: async () => {
                    const clientId = document.getElementById('timeline-client-id').value;

                    const response = await fetch(`${BASE_URL}/api/v1/sessions/timeline?client_id=${clientId}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${state.token}`
                        }
                    });
                    const data = await response.json();
                    return { response, data };
                },
                renderPreview: (data) => {
                    if (!data.sessions || data.sessions.length === 0) {
                        return `
                            <div class="info-card">
                                <h3>ğŸ“… å€‹æ¡ˆæ­·ç¨‹</h3>
                                <p style="color: #6b7280; font-size: 14px; margin-top: 12px;">æ­¤å€‹æ¡ˆå°šç„¡è«®å•†è¨˜éŒ„</p>
                            </div>
                        `;
                    }

                    return `
                        <div class="info-card">
                            <h3>ğŸ“… å€‹æ¡ˆæ­·ç¨‹ - ${data.client_name} (${data.client_code})</h3>
                            <div style="margin-top: 16px;">
                                <p style="color: #374151; font-size: 14px; margin-bottom: 12px;">å…± ${data.total_sessions} æ¬¡è«®å•†</p>
                                ${data.sessions.map(session => {
                                    // Remove surrounding quotes from summary if present
                                    let cleanSummary = session.summary;
                                    if (cleanSummary && cleanSummary.startsWith('"') && cleanSummary.endsWith('"')) {
                                        cleanSummary = cleanSummary.slice(1, -1);
                                    }
                                    // Also handle escaped quotes
                                    if (cleanSummary) {
                                        cleanSummary = cleanSummary.replace(/\\"/g, '"');
                                    }

                                    return `
                                    <div style="border-left: 3px solid #3b82f6; padding-left: 12px; margin-bottom: 20px;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                            <div style="font-weight: 600; color: #1f2937; font-size: 15px;">
                                                â— ç¬¬${session.session_number}æ¬¡ | ${session.date} ${session.time_range || ''}
                                            </div>
                                            ${session.has_report ? `
                                                <span style="background: #10b981; color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px; white-space: nowrap;">
                                                    å·²å‡ºå ±å‘Š
                                                </span>
                                            ` : `
                                                <span style="background: #9ca3af; color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px; white-space: nowrap;">
                                                    æœªå‡ºå ±å‘Š
                                                </span>
                                            `}
                                        </div>
                                        ${cleanSummary ? `
                                            <div style="font-size: 14px; color: #374151; line-height: 1.6;">
                                                ${cleanSummary}
                                            </div>
                                        ` : ''}
                                    </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
            },
            'get-reflection': {
                title: 'æŸ¥çœ‹åæ€',
                subtitle: 'GET /api/v1/sessions/{id}/reflection',
                init: async () => {
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/sessions`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.sessions = data.items;
                                document.getElementById('action-form').innerHTML = steps['get-reflection'].renderForm();
                            }
                        } catch (error) {
                            console.error('Failed to refresh session list:', error);
                        }
                    }
                },
                renderForm: () => {
                    const sessionOptions = (state.sessions || []).map(s =>
                        `<option value="${s.id}">${s.client_name || 'æœªçŸ¥'} - ç¬¬ ${s.session_number} æ¬¡ (${new Date(s.session_date).toLocaleDateString('zh-TW')})</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>é¸æ“‡æœƒè«‡è¨˜éŒ„ *</label>
                            <select id="reflection-session-id">
                                ${sessionOptions}
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="executeGetReflection()" ${!state.token || !state.sessions?.length ? 'disabled' : ''}>æŸ¥çœ‹åæ€</button>
                    `;
                },
                execute: async () => {
                    const sessionId = document.getElementById('reflection-session-id').value;
                    const response = await fetch(`${BASE_URL}/api/v1/sessions/${sessionId}/reflection`, {
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });
                    const data = await response.json();
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>ğŸ’­ è«®å•†å¸«åæ€</h3>
                        <div class="info-row">
                            <span class="info-label">Session ID</span>
                            <span class="info-value" style="font-size: 11px;">${data.session_id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æ›´æ–°æ™‚é–“</span>
                            <span class="info-value">${new Date(data.updated_at).toLocaleString('zh-TW')}</span>
                        </div>
                    </div>
                    ${data.reflection && Object.keys(data.reflection).length > 0 ? `
                        <div class="info-card">
                            <h4>åæ€å…§å®¹</h4>
                            ${data.reflection.working_with_client ? `
                                <div style="margin-bottom: 12px;">
                                    <strong style="color: #2563eb;">æˆ‘å’Œé€™å€‹äººå·¥ä½œçš„æ„Ÿå—æ˜¯ï¼Ÿ</strong>
                                    <p style="font-size: 13px; margin-top: 4px; line-height: 1.6;">${data.reflection.working_with_client}</p>
                                </div>
                            ` : ''}
                            ${data.reflection.feeling_source ? `
                                <div style="margin-bottom: 12px;">
                                    <strong style="color: #2563eb;">é€™å€‹æ„Ÿå—çš„åŸå› æ˜¯ï¼Ÿ</strong>
                                    <p style="font-size: 13px; margin-top: 4px; line-height: 1.6;">${data.reflection.feeling_source}</p>
                                </div>
                            ` : ''}
                            ${data.reflection.current_challenges ? `
                                <div style="margin-bottom: 12px;">
                                    <strong style="color: #2563eb;">ç›®å‰çš„å›°é›£ï¼æƒ³æ›´æ·±å…¥çš„åœ°æ–¹æ˜¯ï¼Ÿ</strong>
                                    <p style="font-size: 13px; margin-top: 4px; line-height: 1.6;">${data.reflection.current_challenges}</p>
                                </div>
                            ` : ''}
                            ${data.reflection.supervision_topics ? `
                                <div style="margin-bottom: 12px;">
                                    <strong style="color: #2563eb;">æˆ‘æœƒæƒ³æ‰¾ç£å°è¨è«–çš„å•é¡Œæ˜¯ï¼Ÿ</strong>
                                    <p style="font-size: 13px; margin-top: 4px; line-height: 1.6;">${data.reflection.supervision_topics}</p>
                                </div>
                            ` : ''}
                        </div>
                    ` : '<div class="info-card"><p style="color: #6b7280;">æ­¤æœƒè«‡å°šç„¡åæ€è¨˜éŒ„</p></div>'}
                `
            },
            'update-reflection': {
                title: 'æ›´æ–°åæ€',
                subtitle: 'PUT /api/v1/sessions/{id}/reflection',
                init: async () => {
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/sessions`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.sessions = data.items;
                                document.getElementById('action-form').innerHTML = steps['update-reflection'].renderForm();
                                setTimeout(() => loadReflectionForUpdate(), 100);
                            }
                        } catch (error) {
                            console.error('Failed to refresh session list:', error);
                        }
                    }
                },
                renderForm: () => {
                    const sessionOptions = (state.sessions || []).map(s =>
                        `<option value="${s.id}">${s.client_name || 'æœªçŸ¥'} - ç¬¬ ${s.session_number} æ¬¡ (${new Date(s.session_date).toLocaleDateString('zh-TW')})</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>é¸æ“‡æœƒè«‡è¨˜éŒ„ *</label>
                            <select id="update-reflection-session-id" onchange="loadReflectionForUpdate()">
                                ${sessionOptions}
                            </select>
                        </div>
                        <div class="info-card" style="background: #eff6ff; border-color: #3b82f6;">
                            <h4 style="color: #1e40af; margin-bottom: 12px;">è«®å•†å¸«åæ€</h4>
                            <div class="form-group">
                                <label>æˆ‘å’Œé€™å€‹äººå·¥ä½œçš„æ„Ÿå—æ˜¯ï¼Ÿ</label>
                                <textarea id="put-reflection-working" placeholder="ä¾‹å¦‚ï¼šæ•´é«”éç¨‹æµæš¢è¼•é¬†ï¼Œé€æ¼¸è´å¾—ä¿¡ä»»..." rows="2"></textarea>
                            </div>
                            <div class="form-group">
                                <label>é€™å€‹æ„Ÿå—çš„åŸå› æ˜¯ï¼Ÿ</label>
                                <textarea id="put-reflection-source" placeholder="ä¾‹å¦‚ï¼šå€‹æ¡ˆå¾ç·Šå¼µåˆ°é€æ­¥æ”¾é¬†ï¼Œé¡˜æ„é–‹æ”¾å¿ƒæ…‹åˆ†äº«æ›´å¤š..." rows="2"></textarea>
                            </div>
                            <div class="form-group">
                                <label>ç›®å‰çš„å›°é›£ï¼æƒ³æ›´æ·±å…¥çš„åœ°æ–¹æ˜¯ï¼Ÿ</label>
                                <textarea id="put-reflection-challenges" placeholder="ä¾‹å¦‚ï¼šç•¶è‚¯å®šå€‹æ¡ˆæ™‚ï¼Œä»æœƒæœ‰è‡ªæˆ‘æ‡·ç–‘åæ‡‰..." rows="2"></textarea>
                            </div>
                            <div class="form-group">
                                <label>æˆ‘æœƒæƒ³æ‰¾ç£å°è¨è«–çš„å•é¡Œæ˜¯ï¼Ÿ</label>
                                <textarea id="put-reflection-supervision" placeholder="ä¾‹å¦‚ï¼šå¦‚ä½•åœ¨æ”¯æŒèˆ‡æŒ‘æˆ°é–“æ‹¿æç¯€å¥..." rows="2"></textarea>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="executeUpdateReflection()" ${!state.token || !state.sessions?.length ? 'disabled' : ''}>æ›´æ–°åæ€</button>
                    `;
                },
                execute: async () => {
                    const sessionId = document.getElementById('update-reflection-session-id').value;
                    const requestBody = {};

                    const working = document.getElementById('put-reflection-working').value;
                    const source = document.getElementById('put-reflection-source').value;
                    const challenges = document.getElementById('put-reflection-challenges').value;
                    const supervision = document.getElementById('put-reflection-supervision').value;

                    if (working) requestBody.working_with_client = working;
                    if (source) requestBody.feeling_source = source;
                    if (challenges) requestBody.current_challenges = challenges;
                    if (supervision) requestBody.supervision_topics = supervision;

                    const response = await fetch(`${BASE_URL}/api/v1/sessions/${sessionId}/reflection`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });
                    const data = await response.json();
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card" style="border-color: #10b981;">
                        <h3 style="color: #10b981;">âœ… åæ€æ›´æ–°æˆåŠŸ</h3>
                        <div class="info-row">
                            <span class="info-label">Session ID</span>
                            <span class="info-value" style="font-size: 11px;">${data.session_id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æ›´æ–°æ™‚é–“</span>
                            <span class="info-value">${new Date(data.updated_at).toLocaleString('zh-TW')}</span>
                        </div>
                    </div>
                `
            },
            'update-client': {
                title: 'æ›´æ–°å€‹æ¡ˆ',
                subtitle: 'PATCH /api/v1/clients/{id}',
                init: async () => {
                    // Refresh client list before showing update form
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/clients`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.clients = data.items;
                                // Re-render form with updated list
                                document.getElementById('action-form').innerHTML = steps['update-client'].renderForm();
                                // Load data for first/current client
                                setTimeout(() => loadClientDataForUpdate(), 100);
                            }
                        } catch (error) {
                            console.error('Failed to refresh client list:', error);
                        }
                    }
                },
                renderForm: () => {
                    // Filter out currentClient from the list to avoid duplicates
                    const filteredClients = state.currentClient
                        ? state.clients.filter(c => c.id !== state.currentClient.id)
                        : state.clients;

                    const clientOptions = filteredClients.map(c =>
                        `<option value="${c.id}">${c.name} (${c.code})</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>é¸æ“‡å€‹æ¡ˆ *</label>
                            <select id="update-client-id" onchange="loadClientDataForUpdate()">
                                ${state.currentClient ? `<option value="${state.currentClient.id}" selected>${state.currentClient.name} (${state.currentClient.code})</option>` : ''}
                                ${clientOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æš±ç¨±</label>
                            <input type="text" id="update-client-nickname" placeholder="æ›´æ–°æš±ç¨±" />
                        </div>
                        <div class="form-group">
                            <label>å‡ºç”Ÿæ—¥æœŸ (æ›´æ–°å¾Œå°‡è‡ªå‹•é‡æ–°è¨ˆç®—å¹´é½¡)</label>
                            <input type="date" id="update-client-birth-date" />
                        </div>
                        <div class="form-group">
                            <label>è·æ¥­</label>
                            <input type="text" id="update-client-occupation" placeholder="æ›´æ–°è·æ¥­" />
                        </div>
                        <div class="form-group">
                            <label>æ¨™ç±¤ (é€—è™Ÿåˆ†éš”)</label>
                            <input type="text" id="update-client-tags" placeholder="ä¾‹: è·æ¶¯è«®è©¢,è½‰è·" />
                        </div>
                        <button class="btn btn-primary" onclick="executeUpdateClient()" ${!state.token || (!state.currentClient && state.clients.length === 0) ? 'disabled' : ''}>æ›´æ–°å€‹æ¡ˆ</button>
                    `;
                },
                execute: async () => {
                    const clientId = document.getElementById('update-client-id').value;
                    const updateData = {};

                    const nickname = document.getElementById('update-client-nickname').value;
                    const birthDate = document.getElementById('update-client-birth-date').value;
                    const occupation = document.getElementById('update-client-occupation').value;
                    const tags = document.getElementById('update-client-tags').value;

                    if (nickname) updateData.nickname = nickname;
                    if (birthDate) updateData.birth_date = birthDate;
                    if (occupation) updateData.occupation = occupation;
                    if (tags) updateData.tags = tags.split(',').map(t => t.trim());

                    const response = await fetch(`${BASE_URL}/api/v1/clients/${clientId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.currentClient = data;
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>âœ… å€‹æ¡ˆæ›´æ–°æˆåŠŸ</h3>
                        <div class="info-row">
                            <span class="info-label">å§“å</span>
                            <span class="info-value">${data.name}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æš±ç¨±</span>
                            <span class="info-value">${data.nickname || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å¹´é½¡</span>
                            <span class="info-value">${data.age || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">è·æ¥­</span>
                            <span class="info-value">${data.occupation || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æ¨™ç±¤</span>
                            <span class="info-value">${data.tags?.join(', ') || 'N/A'}</span>
                        </div>
                    </div>
                `
            },
            'delete-client': {
                title: 'åˆªé™¤å€‹æ¡ˆ',
                subtitle: 'DELETE /api/v1/clients/{id}',
                init: async () => {
                    // Refresh client list before showing delete form
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/clients`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.clients = data.items;
                                // Re-render form with updated list
                                document.getElementById('action-form').innerHTML = steps['delete-client'].renderForm();
                            }
                        } catch (error) {
                            console.error('Failed to refresh client list:', error);
                        }
                    }
                },
                renderForm: () => {
                    const clientOptions = state.clients.map(c =>
                        `<option value="${c.id}">${c.name} (${c.code})</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>é¸æ“‡è¦åˆªé™¤çš„å€‹æ¡ˆ *</label>
                            <select id="delete-client-id">
                                ${clientOptions}
                            </select>
                        </div>
                        <div class="info-card" style="background: #fee2e2; border-color: #ef4444;">
                            <p style="color: #991b1b; font-size: 13px;">âš ï¸ è­¦å‘Šï¼šåˆªé™¤å€‹æ¡ˆå¾Œç„¡æ³•å¾©åŸ!</p>
                        </div>
                        <button class="btn btn-primary" onclick="executeDeleteClient()" ${!state.token || state.clients.length === 0 ? 'disabled' : ''} style="background: #ef4444;">åˆªé™¤å€‹æ¡ˆ</button>
                    `;
                },
                execute: async () => {
                    const clientId = document.getElementById('delete-client-id').value;

                    const response = await fetch(`${BASE_URL}/api/v1/clients/${clientId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${state.token}`
                        }
                    });

                    // DELETE returns 204 No Content, no JSON to parse
                    const data = response.status === 204 ? { success: true, message: 'å€‹æ¡ˆå·²åˆªé™¤' } : await response.json();

                    // Remove deleted client from state
                    if (response.status === 204) {
                        state.clients = state.clients.filter(c => c.id !== clientId);
                        if (state.currentClient?.id === clientId) {
                            state.currentClient = null;
                        }
                        // Refresh the dropdown list
                        document.getElementById('action-form').innerHTML = steps['delete-client'].renderForm();
                    }

                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card" style="border-color: #10b981;">
                        <h3 style="color: #10b981;">âœ… å€‹æ¡ˆåˆªé™¤æˆåŠŸ</h3>
                        <p style="color: #065f46; font-size: 14px; margin-top: 12px;">è©²å€‹æ¡ˆå·²å¾ç³»çµ±ä¸­ç§»é™¤</p>
                    </div>
                `
            },
            'create-session': {
                title: 'å»ºç«‹æœƒè«‡è¨˜éŒ„',
                subtitle: 'POST /api/v1/sessions',
                renderForm: () => {
                    const clientOptions = state.clients.map(c =>
                        `<option value="${c.id}">${c.name} (${c.code})</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>é¸æ“‡å€‹æ¡ˆ *</label>
                            <select id="session-client-id">
                                ${clientOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æœƒè«‡æ—¥æœŸ *</label>
                            <input type="date" id="session-date" value="${new Date().toISOString().split('T')[0]}" />
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label>é–‹å§‹æ™‚é–“</label>
                                <input type="time" id="session-start-time" />
                            </div>
                            <div class="form-group">
                                <label>çµæŸæ™‚é–“</label>
                                <input type="time" id="session-end-time" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label>é€å­—ç¨¿å…§å®¹ *</label>
                            <textarea id="session-transcript" placeholder="è¼¸å…¥æœƒè«‡é€å­—ç¨¿..." rows="10"></textarea>
                        </div>
                        <div class="form-group">
                            <label>å‚™è¨»</label>
                            <textarea id="session-notes" placeholder="é¸å¡«" rows="3"></textarea>
                        </div>
                        <div class="info-card" style="background: #eff6ff; border-color: #3b82f6;">
                            <h4 style="color: #1e40af; margin-bottom: 12px;">è«®å•†å¸«åæ€ï¼ˆé¸å¡«ï¼‰</h4>
                            <div class="form-group">
                                <label>æˆ‘å’Œé€™å€‹äººå·¥ä½œçš„æ„Ÿå—æ˜¯ï¼Ÿ</label>
                                <textarea id="reflection-working" placeholder="ä¾‹å¦‚ï¼šæ•´é«”éç¨‹æµæš¢è¼•é¬†ï¼Œé€æ¼¸è´å¾—ä¿¡ä»»..." rows="2"></textarea>
                            </div>
                            <div class="form-group">
                                <label>é€™å€‹æ„Ÿå—çš„åŸå› æ˜¯ï¼Ÿ</label>
                                <textarea id="reflection-source" placeholder="ä¾‹å¦‚ï¼šå€‹æ¡ˆå¾ç·Šå¼µåˆ°é€æ­¥æ”¾é¬†ï¼Œé¡˜æ„é–‹æ”¾å¿ƒæ…‹åˆ†äº«æ›´å¤š..." rows="2"></textarea>
                            </div>
                            <div class="form-group">
                                <label>ç›®å‰çš„å›°é›£ï¼æƒ³æ›´æ·±å…¥çš„åœ°æ–¹æ˜¯ï¼Ÿ</label>
                                <textarea id="reflection-challenges" placeholder="ä¾‹å¦‚ï¼šç•¶è‚¯å®šå€‹æ¡ˆæ™‚ï¼Œä»æœƒæœ‰è‡ªæˆ‘æ‡·ç–‘åæ‡‰..." rows="2"></textarea>
                            </div>
                            <div class="form-group">
                                <label>æˆ‘æœƒæƒ³æ‰¾ç£å°è¨è«–çš„å•é¡Œæ˜¯ï¼Ÿ</label>
                                <textarea id="reflection-supervision" placeholder="ä¾‹å¦‚ï¼šå¦‚ä½•åœ¨æ”¯æŒèˆ‡æŒ‘æˆ°é–“æ‹¿æç¯€å¥..." rows="2"></textarea>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="executeCreateSession()" ${!state.token || state.clients.length === 0 ? 'disabled' : ''}>å»ºç«‹æœƒè«‡è¨˜éŒ„</button>
                            <button class="btn btn-secondary" onclick="quickFillSessionData()" ${!state.token ? 'disabled' : ''} style="background: #6366f1;">ğŸ² å¿«é€Ÿå¡«å…¥æ¸¬è©¦è³‡æ–™</button>
                        </div>
                    `;
                },
                execute: async () => {
                    const sessionDate = document.getElementById('session-date').value;
                    const startTime = document.getElementById('session-start-time').value;
                    const endTime = document.getElementById('session-end-time').value;

                    // Validate session_date is not empty
                    if (!sessionDate) {
                        throw new Error('æœƒè«‡æ—¥æœŸç‚ºå¿…å¡«æ¬„ä½');
                    }

                    const requestBody = {
                        client_id: document.getElementById('session-client-id').value,
                        session_date: sessionDate,  // Should be in YYYY-MM-DD format from input[type=date]
                        transcript: document.getElementById('session-transcript').value,
                        notes: document.getElementById('session-notes').value || null
                    };

                    // Add start_time and end_time if provided (non-empty)
                    if (startTime && startTime.trim()) {
                        requestBody.start_time = `${sessionDate} ${startTime}`;
                    }
                    if (endTime && endTime.trim()) {
                        requestBody.end_time = `${sessionDate} ${endTime}`;
                    }

                    // Add reflection if any field is filled
                    const reflectionWorking = document.getElementById('reflection-working').value;
                    const reflectionSource = document.getElementById('reflection-source').value;
                    const reflectionChallenges = document.getElementById('reflection-challenges').value;
                    const reflectionSupervision = document.getElementById('reflection-supervision').value;

                    if (reflectionWorking || reflectionSource || reflectionChallenges || reflectionSupervision) {
                        requestBody.reflection = {};
                        if (reflectionWorking) requestBody.reflection.working_with_client = reflectionWorking;
                        if (reflectionSource) requestBody.reflection.feeling_source = reflectionSource;
                        if (reflectionChallenges) requestBody.reflection.current_challenges = reflectionChallenges;
                        if (reflectionSupervision) requestBody.reflection.supervision_topics = reflectionSupervision;
                    }

                    const response = await fetch(`${BASE_URL}/api/v1/sessions`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.sessions = state.sessions || [];
                        state.sessions.push(data);
                        state.currentSession = data;
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>ğŸ“ é€å­—ç¨¿å·²å„²å­˜</h3>
                        <div class="info-row">
                            <span class="info-label">Session ID</span>
                            <span class="info-value">${data.id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æœƒè«‡ç·¨è™Ÿ</span>
                            <span class="info-value">ç¬¬ ${data.session_number} æ¬¡</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æœƒè«‡æ—¥æœŸ</span>
                            <span class="info-value">${new Date(data.session_date).toLocaleDateString('zh-TW')}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å·²ç”Ÿæˆå ±å‘Š</span>
                            <span class="info-value">${data.has_report ? 'æ˜¯' : 'å¦'}</span>
                        </div>
                    </div>
                `
            },
            'list-sessions': {
                title: 'åˆ—å‡ºæœƒè«‡è¨˜éŒ„',
                subtitle: 'GET /api/v1/sessions',
                init: async () => {
                    // Refresh client list before showing form
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/clients`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.clients = data.items;
                                // Re-render form with updated list
                                document.getElementById('action-form').innerHTML = steps['list-sessions'].renderForm();
                            }
                        } catch (error) {
                            console.error('Failed to refresh client list:', error);
                        }
                    }
                },
                renderForm: () => {
                    const clientOptions = state.clients.map(c =>
                        `<option value="${c.id}">${c.name} (${c.code})</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>ç¯©é¸å€‹æ¡ˆ (å¯é¸)</label>
                            <select id="filter-session-client-id">
                                <option value="">å…¨éƒ¨</option>
                                ${clientOptions}
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="executeListSessions()" ${!state.token ? 'disabled' : ''}>åˆ—å‡ºé€å­—ç¨¿</button>
                    `;
                },
                execute: async () => {
                    const clientId = document.getElementById('filter-session-client-id').value;
                    const url = clientId
                        ? `${BASE_URL}/api/v1/sessions?client_id=${clientId}`
                        : `${BASE_URL}/api/v1/sessions`;

                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.sessions = data.items;
                    }
                    return { response, data };
                },
                renderPreview: (data) => {
                    if (data.total === 0) {
                        return `<div class="empty-state"><p>å°šç„¡é€å­—ç¨¿è¨˜éŒ„</p></div>`;
                    }
                    return `
                        <div class="info-card">
                            <h3>ğŸ“ é€å­—ç¨¿åˆ—è¡¨ (${data.total})</h3>
                        </div>
                        ${data.items.map(s => `
                            <div class="info-card" style="cursor: pointer;" onclick="state.currentSession = ${JSON.stringify(s).replace(/"/g, '&quot;')}; showStep('view-session');">
                                <div class="info-row">
                                    <span class="info-label">å€‹æ¡ˆå§“å</span>
                                    <span class="info-value">${s.client_name || 'N/A'}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">æœƒè«‡æ—¥æœŸ</span>
                                    <span class="info-value">${new Date(s.session_date).toLocaleDateString('zh-TW')}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">æœƒè«‡ç·¨è™Ÿ</span>
                                    <span class="info-value">ç¬¬ ${s.session_number} æ¬¡</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">å·²ç”Ÿæˆå ±å‘Š</span>
                                    <span class="info-value">${s.has_report ? 'âœ… æ˜¯' : 'âŒ å¦'}</span>
                                </div>
                            </div>
                        `).join('')}
                    `;
                }
            },
            'view-session': {
                title: 'æŸ¥çœ‹æœƒè«‡è©³æƒ…',
                subtitle: 'GET /api/v1/sessions/{id}',
                init: async () => {
                    // Refresh session list before showing view form
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/sessions`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.sessions = data.items;
                                // Re-render form with updated list
                                document.getElementById('action-form').innerHTML = steps['view-session'].renderForm();
                            }
                        } catch (error) {
                            console.error('Failed to refresh session list:', error);
                        }
                    }
                },
                renderForm: () => {
                    const sessionOptions = (state.sessions || []).map(s =>
                        `<option value="${s.id}">${s.client_name || 'æœªçŸ¥'} - ç¬¬ ${s.session_number} æ¬¡ (${new Date(s.session_date).toLocaleDateString('zh-TW')})</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>é¸æ“‡æœƒè«‡è¨˜éŒ„ *</label>
                            <select id="view-session-id">
                                ${sessionOptions}
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="executeViewSession()" ${!state.token || !state.sessions?.length ? 'disabled' : ''}>æŸ¥çœ‹æœƒè«‡è©³æƒ…</button>
                    `;
                },
                execute: async () => {
                    const sessionId = document.getElementById('view-session-id').value;

                    const response = await fetch(`${BASE_URL}/api/v1/sessions/${sessionId}`, {
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.currentSession = data;
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>ğŸ“ æœƒè«‡è©³æƒ…</h3>
                        <div class="info-row">
                            <span class="info-label">å€‹æ¡ˆå§“å</span>
                            <span class="info-value">${data.client_name || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æœƒè«‡æ—¥æœŸ</span>
                            <span class="info-value">${new Date(data.session_date).toLocaleDateString('zh-TW')}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æœƒè«‡ç·¨è™Ÿ</span>
                            <span class="info-value">ç¬¬ ${data.session_number} æ¬¡</span>
                        </div>
                        ${data.start_time ? `
                        <div class="info-row">
                            <span class="info-label">é–‹å§‹æ™‚é–“</span>
                            <span class="info-value">${new Date(data.start_time).toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'})}</span>
                        </div>
                        ` : ''}
                        ${data.end_time ? `
                        <div class="info-row">
                            <span class="info-label">çµæŸæ™‚é–“</span>
                            <span class="info-value">${new Date(data.end_time).toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'})}</span>
                        </div>
                        ` : ''}
                        <div class="info-row">
                            <span class="info-label">å·²ç”Ÿæˆå ±å‘Š</span>
                            <span class="info-value">${data.has_report ? 'âœ… æ˜¯' : 'âŒ å¦'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å»ºç«‹æ™‚é–“</span>
                            <span class="info-value">${new Date(data.created_at).toLocaleString('zh-TW')}</span>
                        </div>
                        ${data.updated_at ? `
                        <div class="info-row">
                            <span class="info-label">æ›´æ–°æ™‚é–“</span>
                            <span class="info-value">${new Date(data.updated_at).toLocaleString('zh-TW')}</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="info-card">
                        <h4>é€å­—ç¨¿å…§å®¹</h4>
                        <p style="white-space: pre-wrap; font-size: 13px; line-height: 1.6;">${data.transcript_text}</p>
                    </div>
                    ${data.summary ? `
                        <div class="info-card">
                            <h4>æœƒè«‡æ‘˜è¦ï¼ˆAI ç”Ÿæˆï¼‰</h4>
                            <p style="font-size: 13px; line-height: 1.6;">${data.summary}</p>
                        </div>
                    ` : ''}
                    ${data.notes ? `
                        <div class="info-card">
                            <h4>å‚™è¨»ï¼ˆäººé¡æ’°å¯«ï¼‰</h4>
                            <p style="font-size: 13px;">${data.notes}</p>
                        </div>
                    ` : ''}
                    ${data.reflection && Object.keys(data.reflection).length > 0 ? `
                        <div class="info-card">
                            <h4>è«®å•†å¸«åæ€ï¼ˆäººé¡æ’°å¯«ï¼‰</h4>
                            ${data.reflection.working_with_client ? `
                                <div style="margin-bottom: 12px;">
                                    <strong style="color: #2563eb;">æˆ‘å’Œé€™å€‹äººå·¥ä½œçš„æ„Ÿå—æ˜¯ï¼Ÿ</strong>
                                    <p style="font-size: 13px; margin-top: 4px; line-height: 1.6;">${data.reflection.working_with_client}</p>
                                </div>
                            ` : ''}
                            ${data.reflection.feeling_source ? `
                                <div style="margin-bottom: 12px;">
                                    <strong style="color: #2563eb;">é€™å€‹æ„Ÿå—çš„åŸå› æ˜¯ï¼Ÿ</strong>
                                    <p style="font-size: 13px; margin-top: 4px; line-height: 1.6;">${data.reflection.feeling_source}</p>
                                </div>
                            ` : ''}
                            ${data.reflection.current_challenges ? `
                                <div style="margin-bottom: 12px;">
                                    <strong style="color: #2563eb;">ç›®å‰çš„å›°é›£ï¼æƒ³æ›´æ·±å…¥çš„åœ°æ–¹æ˜¯ï¼Ÿ</strong>
                                    <p style="font-size: 13px; margin-top: 4px; line-height: 1.6;">${data.reflection.current_challenges}</p>
                                </div>
                            ` : ''}
                            ${data.reflection.supervision_topics ? `
                                <div style="margin-bottom: 12px;">
                                    <strong style="color: #2563eb;">æˆ‘æœƒæƒ³æ‰¾ç£å°è¨è«–çš„å•é¡Œæ˜¯ï¼Ÿ</strong>
                                    <p style="font-size: 13px; margin-top: 4px; line-height: 1.6;">${data.reflection.supervision_topics}</p>
                                </div>
                            ` : ''}
                            ${!data.reflection.working_with_client && !data.reflection.feeling_source && !data.reflection.current_challenges && !data.reflection.supervision_topics ? `
                                <p style="font-size: 13px; color: #6b7280;">ï¼ˆè‡ªè¨‚æ ¼å¼åæ€è³‡æ–™ï¼‰</p>
                                <pre style="font-size: 12px; background: #f3f4f6; padding: 12px; border-radius: 4px; overflow-x: auto;">${JSON.stringify(data.reflection, null, 2)}</pre>
                            ` : ''}
                        </div>
                    ` : ''}
                `
            },
            'update-session': {
                title: 'æ›´æ–°æœƒè«‡è¨˜éŒ„',
                subtitle: 'PATCH /api/v1/sessions/{id}',
                init: async () => {
                    // Refresh session list before showing update form
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/sessions`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.sessions = data.items;
                                // Re-render form with updated list
                                document.getElementById('action-form').innerHTML = steps['update-session'].renderForm();
                                // Load data for first session
                                setTimeout(() => loadSessionForUpdate(), 100);
                            }
                        } catch (error) {
                            console.error('Failed to refresh session list:', error);
                        }
                    }
                },
                renderForm: () => {
                    const sessionOptions = (state.sessions || []).map(s =>
                        `<option value="${s.id}">${s.client_name || 'æœªçŸ¥'} - ç¬¬ ${s.session_number} æ¬¡ (${new Date(s.session_date).toLocaleDateString('zh-TW')})</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>é¸æ“‡æœƒè«‡è¨˜éŒ„ *</label>
                            <select id="update-session-id" onchange="loadSessionForUpdate()">
                                ${sessionOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æœƒè«‡æ—¥æœŸ</label>
                            <input type="date" id="update-session-date" />
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label>é–‹å§‹æ™‚é–“</label>
                                <input type="time" id="update-session-start-time" />
                            </div>
                            <div class="form-group">
                                <label>çµæŸæ™‚é–“</label>
                                <input type="time" id="update-session-end-time" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label>é€å­—ç¨¿å…§å®¹</label>
                            <textarea id="update-session-transcript" placeholder="æ›´æ–°é€å­—ç¨¿..." rows="10"></textarea>
                        </div>
                        <div class="form-group">
                            <label>å‚™è¨»</label>
                            <textarea id="update-session-notes" placeholder="æ›´æ–°å‚™è¨»" rows="3"></textarea>
                        </div>
                        <div class="info-card" style="background: #eff6ff; border-color: #3b82f6;">
                            <h4 style="color: #1e40af; margin-bottom: 12px;">è«®å•†å¸«åæ€ï¼ˆé¸å¡«ï¼‰</h4>
                            <div class="form-group">
                                <label>æˆ‘å’Œé€™å€‹äººå·¥ä½œçš„æ„Ÿå—æ˜¯ï¼Ÿ</label>
                                <textarea id="update-reflection-working" placeholder="ä¾‹å¦‚ï¼šæ•´é«”éç¨‹æµæš¢è¼•é¬†ï¼Œé€æ¼¸è´å¾—ä¿¡ä»»..." rows="2"></textarea>
                            </div>
                            <div class="form-group">
                                <label>é€™å€‹æ„Ÿå—çš„åŸå› æ˜¯ï¼Ÿ</label>
                                <textarea id="update-reflection-source" placeholder="ä¾‹å¦‚ï¼šå€‹æ¡ˆå¾ç·Šå¼µåˆ°é€æ­¥æ”¾é¬†ï¼Œé¡˜æ„é–‹æ”¾å¿ƒæ…‹åˆ†äº«æ›´å¤š..." rows="2"></textarea>
                            </div>
                            <div class="form-group">
                                <label>ç›®å‰çš„å›°é›£ï¼æƒ³æ›´æ·±å…¥çš„åœ°æ–¹æ˜¯ï¼Ÿ</label>
                                <textarea id="update-reflection-challenges" placeholder="ä¾‹å¦‚ï¼šç•¶è‚¯å®šå€‹æ¡ˆæ™‚ï¼Œä»æœƒæœ‰è‡ªæˆ‘æ‡·ç–‘åæ‡‰..." rows="2"></textarea>
                            </div>
                            <div class="form-group">
                                <label>æˆ‘æœƒæƒ³æ‰¾ç£å°è¨è«–çš„å•é¡Œæ˜¯ï¼Ÿ</label>
                                <textarea id="update-reflection-supervision" placeholder="ä¾‹å¦‚ï¼šå¦‚ä½•åœ¨æ”¯æŒèˆ‡æŒ‘æˆ°é–“æ‹¿æç¯€å¥..." rows="2"></textarea>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="executeUpdateSession()" ${!state.token || !state.sessions?.length ? 'disabled' : ''}>æ›´æ–°æœƒè«‡è¨˜éŒ„</button>
                    `;
                },
                execute: async () => {
                    const sessionId = document.getElementById('update-session-id').value;
                    const updateData = {};

                    const sessionDate = document.getElementById('update-session-date').value;
                    const startTime = document.getElementById('update-session-start-time').value;
                    const endTime = document.getElementById('update-session-end-time').value;
                    const transcript = document.getElementById('update-session-transcript').value;
                    const notes = document.getElementById('update-session-notes').value;

                    if (sessionDate) updateData.session_date = sessionDate;
                    if (startTime && sessionDate) updateData.start_time = `${sessionDate} ${startTime}`;
                    if (endTime && sessionDate) updateData.end_time = `${sessionDate} ${endTime}`;
                    if (transcript) updateData.transcript = transcript;
                    if (notes) updateData.notes = notes;

                    // Add reflection if any field is filled
                    const reflectionWorking = document.getElementById('update-reflection-working').value;
                    const reflectionSource = document.getElementById('update-reflection-source').value;
                    const reflectionChallenges = document.getElementById('update-reflection-challenges').value;
                    const reflectionSupervision = document.getElementById('update-reflection-supervision').value;

                    if (reflectionWorking || reflectionSource || reflectionChallenges || reflectionSupervision) {
                        updateData.reflection = {};
                        if (reflectionWorking) updateData.reflection.working_with_client = reflectionWorking;
                        if (reflectionSource) updateData.reflection.feeling_source = reflectionSource;
                        if (reflectionChallenges) updateData.reflection.current_challenges = reflectionChallenges;
                        if (reflectionSupervision) updateData.reflection.supervision_topics = reflectionSupervision;
                    }

                    const response = await fetch(`${BASE_URL}/api/v1/sessions/${sessionId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.currentSession = data;
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card" style="border-color: #10b981;">
                        <h3 style="color: #10b981;">âœ… æœƒè«‡è¨˜éŒ„æ›´æ–°æˆåŠŸ</h3>
                        <div class="info-row">
                            <span class="info-label">æœƒè«‡æ—¥æœŸ</span>
                            <span class="info-value">${new Date(data.session_date).toLocaleDateString('zh-TW')}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æ›´æ–°æ™‚é–“</span>
                            <span class="info-value">${new Date(data.updated_at).toLocaleString('zh-TW')}</span>
                        </div>
                    </div>
                `
            },
            'delete-session': {
                title: 'åˆªé™¤æœƒè«‡è¨˜éŒ„',
                subtitle: 'DELETE /api/v1/sessions/{id}',
                init: async () => {
                    // Refresh session list before showing delete form
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/sessions`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.sessions = data.items;
                                // Re-render form with updated list
                                document.getElementById('action-form').innerHTML = steps['delete-session'].renderForm();
                            }
                        } catch (error) {
                            console.error('Failed to refresh session list:', error);
                        }
                    }
                },
                renderForm: () => {
                    const sessionOptions = (state.sessions || []).map(s =>
                        `<option value="${s.id}">${s.client_name || 'æœªçŸ¥'} - ç¬¬ ${s.session_number} æ¬¡ (${new Date(s.session_date).toLocaleDateString('zh-TW')})</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>é¸æ“‡æœƒè«‡è¨˜éŒ„ *</label>
                            <select id="delete-session-id">
                                ${sessionOptions}
                            </select>
                        </div>
                        <div class="info-card" style="background: #fee2e2; border-color: #ef4444;">
                            <p style="color: #991b1b; font-size: 13px;">âš ï¸ è­¦å‘Šï¼šç„¡æ³•åˆªé™¤å·²ç”Ÿæˆå ±å‘Šçš„æœƒè«‡è¨˜éŒ„!</p>
                        </div>
                        <button class="btn btn-primary" onclick="executeDeleteSession()" ${!state.token || !state.sessions?.length ? 'disabled' : ''} style="background: #ef4444;">åˆªé™¤æœƒè«‡è¨˜éŒ„</button>
                    `;
                },
                execute: async () => {
                    const sessionId = document.getElementById('delete-session-id').value;

                    const response = await fetch(`${BASE_URL}/api/v1/sessions/${sessionId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });

                    const data = response.status === 204 ? { success: true, message: 'é€å­—ç¨¿å·²åˆªé™¤' } : await response.json();
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card" style="border-color: #10b981;">
                        <h3 style="color: #10b981;">âœ… é€å­—ç¨¿åˆªé™¤æˆåŠŸ</h3>
                        <p style="color: #065f46; font-size: 14px; margin-top: 12px;">è©²é€å­—ç¨¿å·²å¾ç³»çµ±ä¸­ç§»é™¤</p>
                    </div>
                `
            },
            'update-counselor': {
                title: 'æ›´æ–°è«®å•†å¸«è³‡è¨Š',
                subtitle: 'PATCH /api/auth/me',
                renderForm: () => `
                    <div class="info-card">
                        <p style="font-size: 13px; color: #6b7280;">ç•¶å‰ç”¨æˆ¶: ${state.currentUser?.full_name || 'N/A'}</p>
                    </div>
                    <div class="form-group">
                        <label>å…¨å</label>
                        <input type="text" id="update-counselor-fullname" placeholder="æ›´æ–°å…¨å" value="${state.currentUser?.full_name || ''}" />
                    </div>
                    <div class="form-group">
                        <label>ç”¨æˆ¶å</label>
                        <input type="text" id="update-counselor-username" placeholder="æ›´æ–°ç”¨æˆ¶å" value="${state.currentUser?.username || ''}" />
                    </div>
                    <button class="btn btn-primary" onclick="executeUpdateCounselor()" ${!state.token || !state.currentUser ? 'disabled' : ''}>æ›´æ–°è³‡è¨Š</button>
                `,
                execute: async () => {
                    const updateData = {};

                    const fullName = document.getElementById('update-counselor-fullname').value;
                    const username = document.getElementById('update-counselor-username').value;

                    if (fullName) updateData.full_name = fullName;
                    if (username) updateData.username = username;

                    const response = await fetch(`${BASE_URL}/api/auth/me`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.currentUser = data;
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>âœ… è«®å•†å¸«è³‡è¨Šæ›´æ–°æˆåŠŸ</h3>
                        <div class="info-row">
                            <span class="info-label">å…¨å</span>
                            <span class="info-value">${data.full_name}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç”¨æˆ¶å</span>
                            <span class="info-value">${data.username}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Email</span>
                            <span class="info-value">${data.email}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">è§’è‰²</span>
                            <span class="info-value">${data.role}</span>
                        </div>
                    </div>
                `
            },
            'generate-report': {
                title: 'ç”Ÿæˆå ±å‘Š',
                subtitle: 'POST /api/v1/reports/generate',
                init: async () => {
                    // Refresh sessions list to get latest data with has_report status
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/sessions`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.sessions = data.items;
                                // Re-render form with updated list
                                document.getElementById('action-form').innerHTML = steps['generate-report'].renderForm();
                            }
                        } catch (error) {
                            console.error('Failed to refresh session list:', error);
                        }
                    }
                },
                renderForm: () => {
                    // Filter sessions that don't have reports yet
                    const sessionsWithoutReports = (state.sessions || []).filter(s => !s.has_report);

                    if (sessionsWithoutReports.length === 0) {
                        return `
                            <div class="info-card" style="background: #fef3c7; border-color: #f59e0b;">
                                <p style="color: #92400e;">âš ï¸ æ²’æœ‰æœªç”Ÿæˆå ±å‘Šçš„é€å­—ç¨¿ã€‚è«‹å…ˆå„²å­˜é€å­—ç¨¿ã€‚</p>
                            </div>
                        `;
                    }

                    const sessionOptions = sessionsWithoutReports.map(s =>
                        `<option value="${s.id}">${s.client_name} - ç¬¬${s.session_number}æ¬¡ (${new Date(s.session_date).toLocaleDateString('zh-TW')})</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>é¸æ“‡æœƒè«‡è¨˜éŒ„ * (åƒ…é¡¯ç¤ºæœªç”Ÿæˆå ±å‘Šçš„è¨˜éŒ„)</label>
                            <select id="report-session-id">
                                ${sessionOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>å ±å‘Šé¡å‹</label>
                            <select id="report-type">
                                <option value="enhanced">Enhanced (10æ®µå¼)</option>
                                <option value="legacy">Legacy (5æ®µå¼)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>RAG ç³»çµ±</label>
                            <select id="report-rag">
                                <option value="openai">OpenAI (GPT-4.1 Mini)</option>
                                <option value="gemini">Gemini 2.5 Flash</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="executeGenerateReport()" ${!state.token ? 'disabled' : ''}>ç”Ÿæˆå ±å‘Š</button>
                    `;
                },
                execute: async () => {
                    const reportData = {
                        session_id: document.getElementById('report-session-id').value,
                        report_type: document.getElementById('report-type').value,
                        rag_system: document.getElementById('report-rag').value
                    };

                    const response = await fetch(`${BASE_URL}/api/v1/reports/generate`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(reportData)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.currentReport = data;
                    }
                    return { response, data };
                },
                renderPreview: (data) => {
                    // æª¢æŸ¥æ˜¯å¦æ˜¯ processing ç‹€æ…‹
                    if (data.report?.status === 'processing') {
                        // é–‹å§‹è¼ªè©¢
                        setTimeout(() => pollReportStatus(data.report_id), 3000);

                        return `
                            <div class="info-card" style="background: #fef3c7; border-color: #f59e0b;">
                                <h3>â³ å ±å‘Šç”Ÿæˆä¸­...</h3>
                                <p style="color: #92400e; margin-top: 12px;">é€å­—ç¨¿å·²ä¿å­˜ï¼Œå ±å‘Šæ­£åœ¨èƒŒæ™¯ç”Ÿæˆä¸­ï¼Œè«‹ç¨å€™</p>
                                <div class="info-row">
                                    <span class="info-label">Report ID</span>
                                    <span class="info-value" style="font-size: 11px;">${data.report_id}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Session ID</span>
                                    <span class="info-value" style="font-size: 11px;">${data.session_id}</span>
                                </div>
                                <div id="polling-status" style="margin-top: 16px; padding: 12px; background: white; border-radius: 6px;">
                                    <p style="font-size: 13px; color: #6b7280;">æ­£åœ¨æŸ¥è©¢ç‹€æ…‹...</p>
                                </div>
                            </div>
                        `;
                    }

                    const report = data.report?.report || {};
                    const quality = data.quality_summary || {};

                    return `
                        ${quality.grade ? `
                            <div class="quality-summary">
                                <div class="quality-grade">${quality.grade}</div>
                                <div class="quality-score">è©•åˆ†ï¼š${quality.overall_score} / 100</div>
                            </div>
                        ` : ''}

                        <div class="info-card">
                            <h3>ğŸ“Š å ±å‘ŠåŸºæœ¬è³‡è¨Š</h3>
                            <div class="info-row">
                                <span class="info-label">Report ID</span>
                                <span class="info-value" style="font-size: 11px;">${data.report_id}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Session ID</span>
                                <span class="info-value" style="font-size: 11px;">${data.session_id}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">æ¨¡å¼</span>
                                <span class="info-value">${data.report?.mode || 'N/A'}</span>
                            </div>
                        </div>

                        ${report.client_info ? `
                            <div class="report-section">
                                <h3>ğŸ‘¤ æ¡ˆä¸»è³‡æ–™</h3>
                                <div class="info-card">
                                    <div class="info-row">
                                        <span class="info-label">å§“å</span>
                                        <span class="info-value">${report.client_info.name || 'N/A'}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">æ€§åˆ¥</span>
                                        <span class="info-value">${report.client_info.gender || 'N/A'}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">å¹´é½¡</span>
                                        <span class="info-value">${report.client_info.age || 'N/A'}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">è·æ¥­</span>
                                        <span class="info-value">${report.client_info.occupation || 'N/A'}</span>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        ${report.main_concerns?.length ? `
                            <div class="report-section">
                                <h3>ğŸ¯ ä¸»è¦è­°é¡Œ</h3>
                                <ul>
                                    ${report.main_concerns.map(c => `<li>${c}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}

                        ${report.conceptualization ? `
                            <div class="report-section">
                                <h3>ğŸ’¡ å€‹æ¡ˆæ¦‚å¿µåŒ–</h3>
                                <p>${report.conceptualization}</p>
                            </div>
                        ` : ''}

                        ${report.theories?.length ? `
                            <div class="report-section">
                                <h3>ğŸ“š ç†è«–å¼•ç”¨</h3>
                                ${report.theories.slice(0, 3).map(t => `
                                    <div class="theory-item">
                                        <p>${t.text}</p>
                                        <div class="theory-meta">
                                            ç›¸ä¼¼åº¦: ${(t.score * 100).toFixed(1)}% | ä¾†æº: ${t.document}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    `;
                }
            },
            'list-reports': {
                title: 'åˆ—å‡ºå ±å‘Š',
                subtitle: 'GET /api/v1/reports',
                renderForm: () => {
                    const hasClients = state.clients.length > 0;
                    const clientOptions = state.clients.map(c =>
                        `<option value="${c.id}">${c.name} (${c.code})</option>`
                    ).join('');
                    return `
                        ${!hasClients ? '<div class="alert alert-warning" style="background: #fff3cd; border: 1px solid #ffc107; padding: 12px; border-radius: 6px; margin-bottom: 16px; color: #856404;"><strong>âš ï¸ æç¤ºï¼š</strong> è«‹å…ˆåŸ·è¡Œã€Œåˆ—å‡ºå€‹æ¡ˆã€æ­¥é©Ÿä»¥è¼‰å…¥å€‹æ¡ˆæ¸…å–®ï¼Œæ‰èƒ½ä½¿ç”¨ç¯©é¸åŠŸèƒ½</div>' : ''}
                        <div class="form-group">
                            <label>ç¯©é¸å€‹æ¡ˆ (é¸å¡«)</label>
                            <select id="filter-client-id" ${!hasClients ? 'disabled' : ''}>
                                <option value="">å…¨éƒ¨å€‹æ¡ˆ</option>
                                ${clientOptions}
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="executeListReports()" ${!state.token ? 'disabled' : ''}>æŸ¥è©¢å ±å‘Š</button>
                    `;
                },
                execute: async () => {
                    const clientId = document.getElementById('filter-client-id')?.value;
                    const url = clientId
                        ? `${BASE_URL}/api/v1/reports?client_id=${clientId}`
                        : `${BASE_URL}/api/v1/reports`;

                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.reports = data.items;
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <h3>ğŸ“‹ å ±å‘Šåˆ—è¡¨ (å…± ${data.total} ç­†)</h3>
                    ${data.items.map(report => `
                        <div class="info-card">
                            <div class="info-row">
                                <span class="info-label">å€‹æ¡ˆ/æ¬¡æ•¸</span>
                                <span class="info-value">${report.client_name || 'N/A'} - ç¬¬ ${report.session_number || '?'} æ¬¡</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ID</span>
                                <span class="info-value" style="font-size: 11px;">${report.id}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">æ¨¡å¼</span>
                                <span class="info-value">${report.mode}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ç‹€æ…‹</span>
                                <span class="info-value">${report.status}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">è©•åˆ†</span>
                                <span class="info-value">${report.quality_grade || 'N/A'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">å»ºç«‹æ™‚é–“</span>
                                <span class="info-value">${new Date(report.created_at).toLocaleString('zh-TW')}</span>
                            </div>
                        </div>
                    `).join('')}
                `
            },
            'view-report': {
                title: 'æŸ¥çœ‹å ±å‘Š',
                subtitle: 'GET /api/v1/reports/{id}',
                renderForm: () => {
                    const reportOptions = state.reports.map(r =>
                        `<option value="${r.id}">${r.client_name || 'Client'} - ç¬¬${r.session_number || '?'}æ¬¡ (${new Date(r.created_at).toLocaleDateString('zh-TW')})</option>`
                    ).join('');

                    return `
                        <div class="info-card" style="background: #e0f2fe; border-color: #3b82f6; margin-bottom: 16px;">
                            <p style="color: #1e40af; font-size: 12px;">
                                ğŸ’¡ æ”¯æ´å¤šç¨®è¼¸å‡ºæ ¼å¼ï¼šä¸å‚³åƒæ•¸è¿”å›å®Œæ•´ metadataï¼Œæˆ–ä½¿ç”¨ format åƒæ•¸è¼¸å‡º Markdown/HTML
                            </p>
                        </div>
                        <div class="form-group">
                            <label>é¸æ“‡å ±å‘Š</label>
                            <select id="view-report-id">
                                ${state.currentReport ? `<option value="${state.currentReport.report_id}" selected>Current Report</option>` : ''}
                                ${reportOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>è¼¸å‡ºæ ¼å¼</label>
                            <select id="view-report-format">
                                <option value="">JSON metadata (é è¨­)</option>
                                <option value="markdown">Markdown</option>
                                <option value="html">HTML</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ç‰ˆæœ¬é¸æ“‡</label>
                            <select id="view-report-use-edited">
                                <option value="true">ç·¨è¼¯ç‰ˆ (å„ªå…ˆ)</option>
                                <option value="false">AI åŸå§‹ç‰ˆ</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="executeViewReport()" ${!state.token || (!state.currentReport && state.reports.length === 0) ? 'disabled' : ''}>æŸ¥çœ‹å ±å‘Š</button>
                    `;
                },
                execute: async () => {
                    const reportId = document.getElementById('view-report-id').value;
                    const format = document.getElementById('view-report-format').value;
                    const useEdited = document.getElementById('view-report-use-edited').value;

                    let url = `${BASE_URL}/api/v1/reports/${reportId}`;
                    const params = new URLSearchParams();
                    if (format) params.append('format', format);
                    params.append('use_edited', useEdited);

                    if (params.toString()) {
                        url += `?${params.toString()}`;
                    }

                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });
                    const data = await response.json();
                    return { response, data, format: format || 'json' };
                },
                renderPreview: (result) => {
                    // Handle error response
                    if (!result || !result.data) {
                        return '<div class="info-card" style="background: #fee2e2; border-color: #ef4444;"><p style="color: #991b1b;">ç„¡æ³•è¼‰å…¥å ±å‘Š</p></div>';
                    }

                    const { data, format } = result;

                    if (format === 'json') {
                        const content = data.content_json?.report || data.content_json || {};
                        return `
                            <div class="info-card">
                                <h3>ğŸ“„ å ±å‘Šè©³æƒ… (JSON)</h3>
                                <div class="info-row">
                                    <span class="info-label">ID</span>
                                    <span class="info-value" style="font-size: 11px;">${data.id}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">ç‹€æ…‹</span>
                                    <span class="info-value">${data.status}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">è©•åˆ†</span>
                                    <span class="info-value">${data.quality_grade || 'N/A'} (${data.quality_score || 'N/A'})</span>
                                </div>
                            </div>
                            <div style="background: #1e293b; border-radius: 8px; padding: 20px; max-height: 600px; overflow-y: auto;">
                                <pre style="margin: 0; color: #e2e8f0; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">${JSON.stringify(content, null, 2)}</pre>
                            </div>
                        `;
                    }

                    // Markdown or HTML format - Render nicely
                    const isEdited = (data.is_edited === true) ? 'âœï¸ ç·¨è¼¯ç‰ˆ' : 'ğŸ¤– AI åŸå§‹ç‰ˆ';
                    const formattedContent = data.formatted_content || '';

                    if (format === 'markdown') {
                        // Use marked.js to render Markdown to HTML
                        const htmlContent = marked.parse(formattedContent);

                        return `
                            <div class="info-card">
                                <h3>ğŸ“„ å ±å‘Šå…§å®¹ (${isEdited})</h3>
                                <div class="info-row">
                                    <span class="info-label">æ ¼å¼</span>
                                    <span class="info-value">Markdown (æ¸²æŸ“)</span>
                                </div>
                                ${data.edited_at ? `
                                <div class="info-row">
                                    <span class="info-label">æœ€å¾Œç·¨è¼¯</span>
                                    <span class="info-value">${new Date(data.edited_at).toLocaleString('zh-TW')}</span>
                                </div>
                                ` : ''}
                            </div>
                            <div class="markdown-content" style="max-height: 600px; overflow-y: auto; padding: 24px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; color: #1f2937;">
                                ${htmlContent}
                            </div>
                            <style>
                                .markdown-content h1 { color: #1e40af; margin: 28px 0 14px; font-size: 28px; }
                                .markdown-content h2 { color: #1e40af; margin: 24px 0 12px; font-size: 24px; }
                                .markdown-content h3 { color: #1e40af; margin: 20px 0 10px; font-size: 20px; }
                                .markdown-content p { margin: 12px 0; line-height: 1.8; }
                                .markdown-content ul, .markdown-content ol { margin: 12px 0; padding-left: 24px; }
                                .markdown-content li { margin: 4px 0; }
                                .markdown-content strong { font-weight: 600; }
                                .markdown-content code { background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: 'Courier New', monospace; }
                                .markdown-content pre { background: #1e293b; color: #e2e8f0; padding: 16px; border-radius: 8px; overflow-x: auto; }
                                .markdown-content blockquote { border-left: 4px solid #3b82f6; padding-left: 16px; color: #6b7280; margin: 12px 0; }
                            </style>
                        `;
                    } else if (format === 'html') {
                        // HTML format - render as HTML
                        return `
                            <div class="info-card">
                                <h3>ğŸ“„ å ±å‘Šå…§å®¹ (${isEdited})</h3>
                                <div class="info-row">
                                    <span class="info-label">æ ¼å¼</span>
                                    <span class="info-value">HTML</span>
                                </div>
                                ${data.edited_at ? `
                                <div class="info-row">
                                    <span class="info-label">æœ€å¾Œç·¨è¼¯</span>
                                    <span class="info-value">${new Date(data.edited_at).toLocaleString('zh-TW')}</span>
                                </div>
                                ` : ''}
                            </div>
                            <div style="max-height: 600px; overflow-y: auto; padding: 24px; background: white; border: 1px solid #e5e7eb; border-radius: 8px;">
                                ${formattedContent}
                            </div>
                        `;
                    } else {
                        // Unknown format
                        return `
                            <div class="info-card">
                                <h3>ğŸ“„ å ±å‘Šå…§å®¹ (${isEdited})</h3>
                            </div>
                            <div style="background: #1e293b; border-radius: 8px; padding: 20px; max-height: 600px; overflow-y: auto;">
                                <pre style="margin: 0; color: #e2e8f0; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">${formattedContent}</pre>
                            </div>
                        `;
                    }
                }
            },
            'update-report': {
                title: 'æ›´æ–°å ±å‘Š',
                subtitle: 'PATCH /api/v1/reports/{id} (åƒ…ä¾› iOS ä½¿ç”¨)',
                renderForm: () => {
                    return `
                        <div class="info-card" style="background: #fef3c7; border-color: #f59e0b;">
                            <p style="color: #92400e; font-size: 12px;">
                                âš ï¸ æ­¤ API åƒ…ä¾› iOS App ä½¿ç”¨ï¼Œç”¨æ–¼æäº¤è«®å•†å¸«ç·¨è¼¯å¾Œçš„å ±å‘Šå…§å®¹ã€‚<br>
                                Web Console ä¸æä¾›ç·¨è¼¯åŠŸèƒ½ã€‚
                            </p>
                        </div>
                        <button class="btn btn-secondary" disabled>æ­¤åŠŸèƒ½åƒ…ä¾› iOS ä½¿ç”¨</button>
                    `;
                },
                execute: async () => {
                    const reportId = document.getElementById('update-report-id').value;
                    const contentText = document.getElementById('update-report-content').value;

                    let editedContent;
                    try {
                        editedContent = JSON.parse(contentText);
                    } catch (e) {
                        throw new Error('Invalid JSON format');
                    }

                    const response = await fetch(`${BASE_URL}/api/v1/reports/${reportId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ edited_content_json: editedContent })
                    });
                    const data = await response.json();
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>âœ… å ±å‘Šæ›´æ–°æˆåŠŸ</h3>
                        <div class="info-row">
                            <span class="info-label">Report ID</span>
                            <span class="info-value" style="font-size: 11px;">${data.id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç·¨è¼¯æ™‚é–“</span>
                            <span class="info-value">${new Date(data.edited_at).toLocaleString('zh-TW')}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç·¨è¼¯æ¬¡æ•¸</span>
                            <span class="info-value">${data.edit_count}</span>
                        </div>
                    </div>
                    <div class="report-section">
                        <h3>ğŸ“ æ ¼å¼åŒ– Markdown</h3>
                        <div class="response-content" style="max-height: 400px; white-space: pre-wrap;">${data.formatted_markdown}</div>
                    </div>
                `
            }
        };

        // Event handlers
        document.querySelectorAll('.flow-step').forEach(step => {
            step.addEventListener('click', () => {
                const stepKey = step.dataset.step;
                selectStep(stepKey);
            });
        });

        function selectStep(stepKey) {
            // Update active state
            document.querySelectorAll('.flow-step').forEach(s => s.classList.remove('active'));
            document.querySelector(`[data-step="${stepKey}"]`).classList.add('active');

            // Update UI
            const stepConfig = steps[stepKey];
            document.getElementById('action-title').textContent = stepConfig.title;
            document.getElementById('action-subtitle').textContent = stepConfig.subtitle;
            document.getElementById('action-form').innerHTML = stepConfig.renderForm();

            // Call init function if exists
            if (stepConfig.init) {
                stepConfig.init();
            }

            document.getElementById('preview-title').textContent = stepConfig.title;
            document.getElementById('preview-subtitle').textContent = stepConfig.subtitle;

            // Clear preview content when switching steps
            document.getElementById('preview-content').innerHTML = `
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <p>å¡«å¯«åƒæ•¸ä¸¦åŸ·è¡Œ API</p>
                </div>
            `;

            // Hide response initially
            document.getElementById('response-section').style.display = 'none';
        }

        async function executeStep(stepKey) {
            const stepConfig = steps[stepKey];
            const stepElement = document.querySelector(`[data-step="${stepKey}"]`);

            // Find the button in the action form and disable it with loading state
            const button = document.querySelector('#action-form .btn-primary');
            const originalText = button?.textContent;

            try {
                stepElement.classList.remove('completed', 'error');

                // Set loading state
                if (button) {
                    button.disabled = true;
                    button.textContent = 'è™•ç†ä¸­...';
                }

                const result = await stepConfig.execute();
                const { response, data } = result;

                // Show response
                const responseSection = document.getElementById('response-section');
                const responseStatus = document.getElementById('response-status');
                const responseContent = document.getElementById('response-content');

                responseSection.style.display = 'block';
                responseStatus.innerHTML = `<span class="status-badge status-${response.ok ? 'success' : 'error'}">${response.status} ${response.statusText}</span>`;
                responseContent.textContent = JSON.stringify(data, null, 2);

                if (response.ok) {
                    stepElement.classList.add('completed');
                    // Update preview
                    if (stepConfig.renderPreview) {
                        // Pass the entire result object for steps that need it (like view-report)
                        // Otherwise just pass data for backwards compatibility
                        const previewArg = (stepKey === 'view-report') ? result : data;
                        document.getElementById('preview-content').innerHTML = stepConfig.renderPreview(previewArg);
                    }
                } else {
                    stepElement.classList.add('error');
                    document.getElementById('preview-content').innerHTML = `
                        <div class="info-card" style="border-color: #ef4444;">
                            <h3 style="color: #ef4444;">âŒ éŒ¯èª¤</h3>
                            <p style="color: #991b1b;">${data.detail || 'è«‹æ±‚å¤±æ•—'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                stepElement.classList.add('error');
                document.getElementById('response-section').style.display = 'block';
                document.getElementById('response-status').innerHTML = `<span class="status-badge status-error">Error</span>`;
                document.getElementById('response-content').textContent = error.message;
            } finally {
                // Restore button state
                if (button) {
                    button.disabled = false;
                    button.textContent = originalText;
                }
            }
        }

        // è¼ªè©¢å ±å‘Šç‹€æ…‹
        async function pollReportStatus(reportId) {
            try {
                const response = await fetch(`${BASE_URL}/api/v1/reports/${reportId}`, {
                    headers: { 'Authorization': `Bearer ${state.token}` }
                });
                const data = await response.json();

                const pollingDiv = document.getElementById('polling-status');
                if (!pollingDiv) return;

                if (data.status === 'processing') {
                    pollingDiv.innerHTML = `<p style="font-size: 13px; color: #f59e0b;">â³ è™•ç†ä¸­... (${new Date().toLocaleTimeString('zh-TW')})</p>`;
                    setTimeout(() => pollReportStatus(reportId), 3000);
                } else if (data.status === 'draft') {
                    pollingDiv.innerHTML = `<p style="font-size: 13px; color: #10b981;">âœ… å ±å‘Šç”Ÿæˆå®Œæˆ!</p>`;
                    // è‡ªå‹•é‡æ–°è¼‰å…¥æŸ¥çœ‹å ±å‘Š
                    setTimeout(() => {
                        document.getElementById('preview-content').innerHTML = steps['generate-report'].renderPreview({
                            report_id: data.id,
                            session_id: data.session_id,
                            report: { report: data.content_json.report || data.content_json },
                            quality_summary: {
                                grade: data.quality_grade,
                                overall_score: data.quality_score,
                                strengths: data.quality_strengths,
                                improvements_needed: data.quality_weaknesses
                            }
                        });
                    }, 1000);
                } else if (data.status === 'failed') {
                    pollingDiv.innerHTML = `
                        <p style="font-size: 13px; color: #ef4444;">âŒ ç”Ÿæˆå¤±æ•—</p>
                        <p style="font-size: 12px; color: #991b1b; margin-top: 8px;">${data.error_message || 'æœªçŸ¥éŒ¯èª¤'}</p>
                    `;
                }
            } catch (error) {
                console.error('Polling error:', error);
            }
        }

        // Helper: Load session data when selecting for update
        window.loadSessionForUpdate = function() {
            const sessionId = document.getElementById('update-session-id').value;
            const session = state.sessions.find(s => s.id === sessionId);
            if (session) {
                // Set date
                const sessionDate = new Date(session.session_date);
                document.getElementById('update-session-date').value = sessionDate.toISOString().split('T')[0];

                // Set times
                if (session.start_time) {
                    const startTime = new Date(session.start_time);
                    document.getElementById('update-session-start-time').value =
                        `${String(startTime.getHours()).padStart(2, '0')}:${String(startTime.getMinutes()).padStart(2, '0')}`;
                }
                if (session.end_time) {
                    const endTime = new Date(session.end_time);
                    document.getElementById('update-session-end-time').value =
                        `${String(endTime.getHours()).padStart(2, '0')}:${String(endTime.getMinutes()).padStart(2, '0')}`;
                }

                document.getElementById('update-session-transcript').value = session.transcript_text || '';
                document.getElementById('update-session-notes').value = session.notes || '';

                // Load reflection data if exists
                if (session.reflection) {
                    document.getElementById('update-reflection-working').value = session.reflection.working_with_client || '';
                    document.getElementById('update-reflection-source').value = session.reflection.feeling_source || '';
                    document.getElementById('update-reflection-challenges').value = session.reflection.current_challenges || '';
                    document.getElementById('update-reflection-supervision').value = session.reflection.supervision_topics || '';
                } else {
                    document.getElementById('update-reflection-working').value = '';
                    document.getElementById('update-reflection-source').value = '';
                    document.getElementById('update-reflection-challenges').value = '';
                    document.getElementById('update-reflection-supervision').value = '';
                }
            }
        };

        // Load reflection data for update form
        window.loadReflectionForUpdate = function() {
            const sessionId = document.getElementById('update-reflection-session-id').value;
            const session = state.sessions.find(s => s.id === sessionId);
            if (session && session.reflection) {
                document.getElementById('put-reflection-working').value = session.reflection.working_with_client || '';
                document.getElementById('put-reflection-source').value = session.reflection.feeling_source || '';
                document.getElementById('put-reflection-challenges').value = session.reflection.current_challenges || '';
                document.getElementById('put-reflection-supervision').value = session.reflection.supervision_topics || '';
            } else {
                document.getElementById('put-reflection-working').value = '';
                document.getElementById('put-reflection-source').value = '';
                document.getElementById('put-reflection-challenges').value = '';
                document.getElementById('put-reflection-supervision').value = '';
            }
        };

        // Load client data for update form
        window.loadClientDataForUpdate = async () => {
            const clientId = document.getElementById('update-client-id')?.value;
            if (!clientId) return;

            try {
                const response = await fetch(`${BASE_URL}/api/v1/clients/${clientId}`, {
                    headers: { 'Authorization': `Bearer ${state.token}` }
                });

                if (response.ok) {
                    const client = await response.json();
                    document.getElementById('update-client-nickname').value = client.nickname || '';
                    document.getElementById('update-client-birth-date').value = client.birth_date || '';
                    document.getElementById('update-client-occupation').value = client.occupation || '';
                    document.getElementById('update-client-tags').value = client.tags?.join(', ') || '';
                }
            } catch (error) {
                console.error('Failed to load client data:', error);
            }
        };

        // Quick fill session test data
        window.quickFillSessionData = () => {
            const sampleTranscripts = [
                `Co: ä½ å¥½ï¼Œä»Šå¤©æƒ³èŠäº›ä»€éº¼å‘¢ï¼Ÿ
Cl: æœ€è¿‘å·¥ä½œå£“åŠ›å¾ˆå¤§ï¼Œè¦ºå¾—å¿«è¦æ’ä¸ä¸‹å»äº†ã€‚
Co: å¯ä»¥å¤šèªªä¸€äº›å—ï¼Ÿæ˜¯ä»€éº¼æ¨£çš„å£“åŠ›ï¼Ÿ
Cl: ä¸»ç®¡ç¸½æ˜¯å°æˆ‘çš„å·¥ä½œä¸æ»¿æ„ï¼Œä¸ç®¡æˆ‘æ€éº¼åšéƒ½è¦ºå¾—ä¸å¤ å¥½ã€‚
Co: è½èµ·ä¾†ä½ æ„Ÿåˆ°å¾ˆæŒ«æŠ˜ï¼Œå¯ä»¥åˆ†äº«ä¸€å€‹å…·é«”çš„ä¾‹å­å—ï¼Ÿ
Cl: ä¸Šé€±æˆ‘åšäº†ä¸€ä»½ä¼åŠƒæ¡ˆï¼ŒèŠ±äº†å¾ˆå¤šå¿ƒåŠ›ï¼Œä½†ä¸»ç®¡åªçœ‹äº†ä¸€çœ¼å°±èªªé€™ä¸æ˜¯ä»–è¦çš„ã€‚`,
                `Co: ä¸Šæ¬¡æåˆ°çš„è·æ¶¯æ–¹å‘ï¼Œæœ‰æ–°çš„æƒ³æ³•å—ï¼Ÿ
Cl: æˆ‘ä¸€ç›´åœ¨æ€è€ƒï¼Œä½†é‚„æ˜¯å¾ˆè¿·èŒ«ã€‚
Co: è¿·èŒ«çš„æ„Ÿè¦ºæ˜¯ä»€éº¼ï¼Ÿ
Cl: ä¸çŸ¥é“è‡ªå·±é©åˆåšä»€éº¼ï¼Œä¹Ÿä¸ç¢ºå®šç¾åœ¨çš„å·¥ä½œæ˜¯ä¸æ˜¯å°çš„é¸æ“‡ã€‚
Co: è®“æˆ‘å€‘å…ˆå¾ä½ çš„èˆˆè¶£é–‹å§‹èŠèµ·å§ã€‚`,
                `Co: ä»Šå¤©çœ‹èµ·ä¾†å¿ƒæƒ…ä¸éŒ¯ï¼Ÿ
Cl: å°å•Šï¼Œé€™é€±å·¥ä½œé †åˆ©å¾ˆå¤šï¼Œä¸»ç®¡ä¹Ÿç¨±è®šäº†æˆ‘ã€‚
Co: å¾ˆé«˜èˆˆè½åˆ°é€™å€‹æ¶ˆæ¯ï¼æ˜¯ä»€éº¼æ”¹è®Šäº†ï¼Ÿ
Cl: æˆ‘é–‹å§‹ç”¨ä½ ä¸Šæ¬¡å»ºè­°çš„æ–¹æ³•ï¼Œå…ˆç¢ºèªä¸»ç®¡çš„éœ€æ±‚å†é–‹å§‹åšã€‚
Co: è½èµ·ä¾†é€™å€‹ç­–ç•¥å¾ˆæœ‰æ•ˆï¼Œç¹¼çºŒä¿æŒï¼`
            ];

            const sampleReflections = [
                {
                    working: 'æ•´é«”éç¨‹æµæš¢è¼•é¬†ï¼Œé€æ¼¸è´å¾—ä¿¡ä»»ã€‚é¦–æ¬¡é¢å°è·å ´PUAæ¡ˆä¾‹ï¼Œç²å¾—æ–°çš„è¼”å°ç¶“é©—ã€‚',
                    source: 'å€‹æ¡ˆå¾ç·Šå¼µåˆ°é€æ­¥æ”¾é¬†ï¼Œé¡˜æ„é–‹æ”¾å¿ƒæ…‹åˆ†äº«æ›´å¤šã€‚èƒ½å¤ å»ºç«‹è‰¯å¥½çš„æ²»ç™‚åŒç›Ÿã€‚',
                    challenges: 'ç•¶è‚¯å®šå€‹æ¡ˆæ™‚ï¼Œä»æœƒæœ‰è‡ªæˆ‘æ‡·ç–‘åæ‡‰ï¼›ä½†å·²é€æ¼¸èƒ½æ¥å—è®šè³ã€‚éœ€è¦æ›´å¤šæ™‚é–“æ¢ç´¢å…¶å…§åœ¨èªçŸ¥æ¨¡å¼ã€‚',
                    supervision: 'å¦‚ä½•åœ¨æ”¯æŒèˆ‡æŒ‘æˆ°é–“æ‹¿æç¯€å¥ï¼Œä»¥åŠé‡è¡¨èˆ‡è³ªåŒ–ç´€éŒ„æ•´åˆæ–¹å¼ã€‚ç‰¹åˆ¥æ˜¯å¦‚ä½•è™•ç†è·å ´å‰µå‚·ã€‚'
                },
                {
                    working: 'å€‹æ¡ˆå±•ç¾å‡ºå¼·çƒˆçš„æ”¹è®Šå‹•æ©Ÿï¼Œå·¥ä½œé…åˆåº¦é«˜ï¼Œè®“æœƒè«‡é€²å±•é †åˆ©ã€‚',
                    source: 'å€‹æ¡ˆå°è‡ªå·±çš„å›°å¢ƒæœ‰æ¸…æ¥šçš„èªçŸ¥ï¼Œä¹Ÿé¡˜æ„å˜—è©¦æ–°çš„æ–¹æ³•ï¼Œé€™è®“è«®å•†éç¨‹æ›´æœ‰æ•ˆç‡ã€‚',
                    challenges: 'å€‹æ¡ˆæœ‰æ™‚æœƒéåº¦ç†æ€§åŒ–è‡ªå·±çš„æƒ…ç·’ï¼Œéœ€è¦å¼•å°å…¶æ›´æ·±å…¥åœ°è¦ºå¯Ÿæ„Ÿå—ã€‚',
                    supervision: 'å¦‚ä½•å¹«åŠ©å€‹æ¡ˆåœ¨ç†æ€§æ€è€ƒèˆ‡æƒ…ç·’è¦ºå¯Ÿé–“å–å¾—å¹³è¡¡ï¼Ÿæ˜¯å¦éœ€è¦å¼•å…¥æ›´å¤šæƒ…ç·’ç„¦é»æŠ€è¡“ï¼Ÿ'
                },
                {
                    working: 'ä»Šå¤©çš„æœƒè«‡å……æ»¿æ­£å‘èƒ½é‡ï¼Œçœ‹åˆ°å€‹æ¡ˆçš„é€²æ­¥æ„Ÿåˆ°å¾ˆæ¬£æ…°ã€‚',
                    source: 'å€‹æ¡ˆèƒ½å¤ ä¸»å‹•åˆ†äº«æˆåŠŸç¶“é©—ï¼Œå±•ç¾å‡ºæ›´å¤šçš„è‡ªä¿¡å’Œè‡ªæˆ‘æ•ˆèƒ½æ„Ÿã€‚',
                    challenges: 'éœ€è¦å”åŠ©å€‹æ¡ˆå°‡é€™æ¬¡çš„æˆåŠŸç¶“é©—å…§åŒ–ï¼Œé¿å…æœªä¾†é‡åˆ°æŒ«æŠ˜æ™‚å›åˆ°åŸé»ã€‚',
                    supervision: 'å¦‚ä½•å¼·åŒ–å€‹æ¡ˆçš„æˆåŠŸç¶“é©—ï¼Œå»ºç«‹é•·æœŸçš„å› æ‡‰ç­–ç•¥ï¼Ÿä¸‹ä¸€æ­¥çš„ä»‹å…¥é‡é»æ‡‰è©²æ”¾åœ¨å“ªè£¡ï¼Ÿ'
                }
            ];

            const randomIndex = Math.floor(Math.random() * sampleTranscripts.length);
            const randomTranscript = sampleTranscripts[randomIndex];
            const randomReflection = sampleReflections[randomIndex];
            const today = new Date();
            const startHour = 14 + Math.floor(Math.random() * 3); // 14-16é»
            const endHour = startHour + 1;

            document.getElementById('session-date').value = today.toISOString().split('T')[0];
            document.getElementById('session-start-time').value = `${startHour}:00`;
            document.getElementById('session-end-time').value = `${endHour}:00`;
            document.getElementById('session-transcript').value = randomTranscript;
            document.getElementById('session-notes').value = 'æ¸¬è©¦æœƒè«‡è¨˜éŒ„';

            // Fill reflection fields
            document.getElementById('reflection-working').value = randomReflection.working;
            document.getElementById('reflection-source').value = randomReflection.source;
            document.getElementById('reflection-challenges').value = randomReflection.challenges;
            document.getElementById('reflection-supervision').value = randomReflection.supervision;
        };

        // Quick fill random client data
        window.quickFillRandomClient = () => {
            const names = ['ç‹å°æ˜', 'æå°è¯', 'é™³å¤§åŒ', 'å¼µç¾ç²', 'æ—å¿—å¼·', 'é»ƒæ·‘èŠ¬', 'åŠ‰å»ºåœ‹', 'å³ä½³ç©'];
            const nicknames = ['å°æ˜', 'å°è¯', 'å¤§åŒ', 'ç¾ç²', 'é˜¿å¼·', 'èŠ¬èŠ¬', 'å»ºåœ‹', 'ä½³ä½³'];
            const occupations = ['å·¥ç¨‹å¸«', 'è¨­è¨ˆå¸«', 'æ•™å¸«', 'é†«ç”Ÿ', 'è­·ç†å¸«', 'æœƒè¨ˆå¸«', 'æ¥­å‹™', 'è¡Œæ”¿'];
            const genders = ['male', 'female'];
            const educations = ['é«˜ä¸­ç•¢æ¥­', 'åœ‹ç«‹å°ç£å¤§å­¸', 'ç§ç«‹æ±å³å¤§å­¸', 'åœ‹ç«‹æ”¿æ²»å¤§å­¸', 'ç§ç«‹è¼”ä»å¤§å­¸', 'åœ‹ç«‹æˆåŠŸå¤§å­¸'];
            const locations = ['å°åŒ—å¸‚', 'æ–°åŒ—å¸‚', 'å°ä¸­å¸‚', 'å°å—å¸‚', 'é«˜é›„å¸‚', 'æ¡ƒåœ’å¸‚'];
            const economicStatuses = ['å¯è² æ“”æ—¥å¸¸åŠé€²ä¿®', 'ç¶“æ¿Ÿç©©å®š', 'éœ€å®¶äººæ”¯æŒ', 'ç¨ç«‹è‡ªä¸»', 'æ”¶å…¥ç©©å®š'];
            const familyRelations = [
                'çˆ¶æ¯æ”¯æŒï¼›èˆ‡å“¥å“¥åŒä½',
                'å–®è¦ªå®¶åº­ï¼›æ¯è¦ªç‚ºä¸»è¦æ”¯æŒ',
                'å·²å©šï¼›é…å¶é—œä¿‚è‰¯å¥½',
                'èˆ‡çˆ¶æ¯åŒä½ï¼›é—œä¿‚èæ´½',
                'ç¨å±…ï¼›èˆ‡å®¶äººä¿æŒè¯ç¹«',
                'èˆ‡ä¼´ä¾¶åŒå±…ï¼›å®¶äººçŸ¥æƒ…'
            ];
            const notes = [
                'åˆæ¬¡è«®å•†ï¼Œå°è·æ¶¯ç™¼å±•æœ‰ç–‘å•',
                'æ›¾æœ‰è½‰è·ç¶“é©—ï¼Œå¸Œæœ›ç¢ºèªæ–¹å‘',
                'å°æœªä¾†æ„Ÿåˆ°ç„¦æ…®ï¼Œéœ€è¦å¼•å°',
                'ç©æ¥µä¸»å‹•ï¼Œç›®æ¨™æ˜ç¢º',
                'éœ€è¦å»ºç«‹ä¿¡ä»»é—œä¿‚'
            ];
            const otherInfos = [
                'è¿‘åŠå¹´è€ƒæ…®è½‰è·ï¼›å°è·æ¶¯æ–¹å‘æ„Ÿåˆ°è¿·æƒ˜',
                'æ›¾åœ¨ç§‘æŠ€æ¥­å·¥ä½œä¸‰å¹´ï¼›å¸Œæœ›è½‰æ›è·‘é“',
                'å°ç›®å‰å·¥ä½œæ„Ÿåˆ°å€¦æ€ ï¼›æƒ³æ¢ç´¢æ–°å¯èƒ½',
                'æº–å‚™å‡ºåœ‹é€²ä¿®ï¼›éœ€è¦é‡æ¸…è·æ¶¯è¦åŠƒ',
                'å‰›ç•¢æ¥­ä¸€å¹´ï¼›å°æœªä¾†æ„Ÿåˆ°ä¸ç¢ºå®š'
            ];

            const randomIndex = Math.floor(Math.random() * names.length);

            // Generate random birth date (20-50 years old)
            const today = new Date();
            const age = Math.floor(Math.random() * 30) + 20;
            const birthYear = today.getFullYear() - age;
            const birthMonth = String(Math.floor(Math.random() * 12) + 1).padStart(2, '0');
            const birthDay = String(Math.floor(Math.random() * 28) + 1).padStart(2, '0');
            const birthDate = `${birthYear}-${birthMonth}-${birthDay}`;

            try {
                const fields = [
                    { id: 'client-name', value: names[randomIndex] },
                    { id: 'client-nickname', value: nicknames[randomIndex] },
                    { id: 'client-birth-date', value: birthDate },
                    { id: 'client-gender', value: genders[Math.floor(Math.random() * genders.length)] },
                    { id: 'client-occupation', value: occupations[Math.floor(Math.random() * occupations.length)] },
                    { id: 'client-education', value: educations[Math.floor(Math.random() * educations.length)] },
                    { id: 'client-location', value: locations[Math.floor(Math.random() * locations.length)] },
                    { id: 'client-economic-status', value: economicStatuses[Math.floor(Math.random() * economicStatuses.length)] },
                    { id: 'client-family-relations', value: familyRelations[Math.floor(Math.random() * familyRelations.length)] },
                    { id: 'client-other-info', value: otherInfos[Math.floor(Math.random() * otherInfos.length)] },
                    { id: 'client-notes', value: notes[Math.floor(Math.random() * notes.length)] }
                ];

                fields.forEach(field => {
                    const element = document.getElementById(field.id);
                    if (element) {
                        element.value = field.value;
                    } else {
                        console.warn(`Element not found: ${field.id}`);
                    }
                });
            } catch (error) {
                console.error('Error filling form:', error);
                alert('å¡«å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¢ºèªå·²åœ¨ã€Œå»ºç«‹å€‹æ¡ˆã€é é¢');
            }
        };

        // Step execution functions
        window.executeLogin = () => executeStep('login');
        window.executeMe = () => executeStep('me');
        window.executeListClients = () => executeStep('list-clients');
        window.executeCreateClient = () => executeStep('create-client');
        window.executeViewClient = () => executeStep('view-client');
        window.executeClientTimeline = () => executeStep('client-timeline');
        window.executeUpdateClient = () => executeStep('update-client');
        window.executeDeleteClient = () => executeStep('delete-client');
        window.executeCreateSession = () => executeStep('create-session');
        window.executeListSessions = () => executeStep('list-sessions');
        window.executeViewSession = () => executeStep('view-session');
        window.executeUpdateSession = () => executeStep('update-session');
        window.executeDeleteSession = () => executeStep('delete-session');
        window.executeGetReflection = () => executeStep('get-reflection');
        window.executeUpdateReflection = () => executeStep('update-reflection');
        window.executeUpdateCounselor = () => executeStep('update-counselor');
        window.executeGenerateReport = () => executeStep('generate-report');
        window.executeListReports = () => executeStep('list-reports');
        window.executeViewReport = () => executeStep('view-report');
        window.executeUpdateReport = () => executeStep('update-report');

        // Auto-select first step
        selectStep('login');

        // Load token from localStorage on startup
        if (state.token) {
            fetch(`${BASE_URL}/api/auth/me`, {
                headers: { 'Authorization': `Bearer ${state.token}` }
            }).then(r => r.json()).then(data => {
                if (data.email) {
                    state.currentUser = data;
                    console.log('Token valid, user:', data.email);
                }
            }).catch(() => {
                localStorage.removeItem('token');
                state.token = '';
            });
        }

        // Group collapse functionality
        document.querySelectorAll('.flow-group-title').forEach(title => {
            title.addEventListener('click', () => {
                const groupName = title.dataset.group;
                const content = document.querySelector(`[data-group-content="${groupName}"]`);
                title.classList.toggle('collapsed');
                content.classList.toggle('collapsed');
            });
        });
    </script>
</body>
</html>
