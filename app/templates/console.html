<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOS API Test Console</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Left Sidebar - Flow */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h2 {
            font-size: 18px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .flow-group-title {
            font-size: 13px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 20px;
            margin-bottom: 10px;
            padding-left: 4px;
        }

        .flow-group-title:first-of-type {
            margin-top: 0;
        }

        .flow-step {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        .flow-step:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .flow-step.active {
            background: rgba(255, 255, 255, 0.15);
            border-left-color: #10b981;
        }

        .flow-step.completed {
            background: rgba(16, 185, 129, 0.2);
            border-left-color: #10b981;
        }

        .flow-step.error {
            background: rgba(239, 68, 68, 0.2);
            border-left-color: #ef4444;
        }

        .step-number {
            display: inline-block;
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            font-size: 12px;
            margin-right: 8px;
        }

        .flow-step.completed .step-number {
            background: #10b981;
        }

        .flow-step.error .step-number {
            background: #ef4444;
        }

        .step-title {
            font-size: 14px;
            font-weight: 500;
        }

        .step-subtitle {
            font-size: 11px;
            opacity: 0.8;
            margin-top: 4px;
        }

        /* Center Panel - Preview */
        .preview-panel {
            flex: 1;
            background: #f9fafb;
            padding: 30px;
            overflow-y: auto;
        }

        .preview-header {
            margin-bottom: 20px;
        }

        .preview-header h1 {
            font-size: 24px;
            color: #111827;
            margin-bottom: 8px;
        }

        .preview-header p {
            color: #6b7280;
            font-size: 14px;
        }

        .preview-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            min-height: 400px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        /* Right Panel - Actions & Response */
        .action-panel {
            width: 420px;
            background: white;
            border-left: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
        }

        .action-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .action-header h3 {
            font-size: 16px;
            color: #111827;
            margin-bottom: 4px;
        }

        .action-header p {
            font-size: 12px;
            color: #6b7280;
        }

        .action-form {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            width: 100%;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .response-section {
            border-top: 1px solid #e5e7eb;
            padding: 20px;
            background: #f9fafb;
            max-height: 300px;
            overflow-y: auto;
        }

        .response-title {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 10px;
        }

        .response-content {
            background: #1f2937;
            color: #e5e7eb;
            padding: 12px;
            border-radius: 6px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        /* Report Preview Styles */
        .report-section {
            margin-bottom: 24px;
        }

        .report-section h3 {
            font-size: 18px;
            color: #111827;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb;
        }

        .report-section h4 {
            font-size: 14px;
            color: #374151;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .report-section p {
            font-size: 14px;
            color: #4b5563;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .theory-item {
            background: #f0f9ff;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            border-left: 3px solid #3b82f6;
        }

        .theory-meta {
            font-size: 12px;
            color: #6b7280;
            margin-top: 6px;
        }

        .dialogue-item {
            margin-bottom: 16px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
        }

        .dialogue-speaker {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 4px;
            font-size: 13px;
        }

        .dialogue-content {
            font-size: 14px;
            color: #374151;
            line-height: 1.5;
        }

        .quality-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .quality-grade {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .quality-score {
            font-size: 14px;
            opacity: 0.9;
        }

        .info-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-size: 13px;
            color: #6b7280;
        }

        .info-value {
            font-size: 13px;
            color: #111827;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Sidebar: Flow Steps -->
        <div class="sidebar">
            <h2>ğŸ“± iOS API æ¸¬è©¦æµç¨‹</h2>

            <!-- è«®å•†å¸«ç®¡ç† -->
            <div class="flow-group-title">ğŸ‘¤ è«®å•†å¸«ç®¡ç†</div>

            <div class="flow-step" data-step="login">
                <div>
                    <span class="step-number">1</span>
                    <span class="step-title">ç™»å…¥é©—è­‰</span>
                </div>
                <div class="step-subtitle">POST /auth/login</div>
            </div>

            <div class="flow-step" data-step="me">
                <div>
                    <span class="step-number">2</span>
                    <span class="step-title">å–å¾—è«®å•†å¸«è³‡è¨Š</span>
                </div>
                <div class="step-subtitle">GET /auth/me</div>
            </div>

            <div class="flow-step" data-step="update-counselor">
                <div>
                    <span class="step-number">3</span>
                    <span class="step-title">æ›´æ–°è«®å•†å¸«è³‡è¨Š</span>
                </div>
                <div class="step-subtitle">PATCH /auth/me</div>
            </div>

            <!-- å€‹æ¡ˆç®¡ç† -->
            <div class="flow-group-title">ğŸ‘¥ å€‹æ¡ˆç®¡ç†</div>

            <div class="flow-step" data-step="list-clients">
                <div>
                    <span class="step-number">4</span>
                    <span class="step-title">åˆ—å‡ºå€‹æ¡ˆ</span>
                </div>
                <div class="step-subtitle">GET /api/v1/clients</div>
            </div>

            <div class="flow-step" data-step="create-client">
                <div>
                    <span class="step-number">5</span>
                    <span class="step-title">å»ºç«‹å€‹æ¡ˆ</span>
                </div>
                <div class="step-subtitle">POST /api/v1/clients</div>
            </div>

            <div class="flow-step" data-step="update-client">
                <div>
                    <span class="step-number">6</span>
                    <span class="step-title">æ›´æ–°å€‹æ¡ˆ</span>
                </div>
                <div class="step-subtitle">PATCH /api/v1/clients/{id}</div>
            </div>

            <div class="flow-step" data-step="delete-client">
                <div>
                    <span class="step-number">7</span>
                    <span class="step-title">åˆªé™¤å€‹æ¡ˆ</span>
                </div>
                <div class="step-subtitle">DELETE /api/v1/clients/{id}</div>
            </div>

            <!-- é€å­—ç¨¿ç®¡ç† -->
            <div class="flow-group-title">ğŸ“ é€å­—ç¨¿ç®¡ç†</div>

            <div class="flow-step" data-step="create-session">
                <div>
                    <span class="step-number">8</span>
                    <span class="step-title">å„²å­˜é€å­—ç¨¿</span>
                </div>
                <div class="step-subtitle">POST /api/v1/sessions</div>
            </div>

            <div class="flow-step" data-step="list-sessions">
                <div>
                    <span class="step-number">9</span>
                    <span class="step-title">åˆ—å‡ºé€å­—ç¨¿</span>
                </div>
                <div class="step-subtitle">GET /api/v1/sessions</div>
            </div>

            <div class="flow-step" data-step="view-session">
                <div>
                    <span class="step-number">10</span>
                    <span class="step-title">æŸ¥çœ‹é€å­—ç¨¿</span>
                </div>
                <div class="step-subtitle">GET /api/v1/sessions/{id}</div>
            </div>

            <div class="flow-step" data-step="update-session">
                <div>
                    <span class="step-number">11</span>
                    <span class="step-title">æ›´æ–°é€å­—ç¨¿</span>
                </div>
                <div class="step-subtitle">PATCH /api/v1/sessions/{id}</div>
            </div>

            <div class="flow-step" data-step="delete-session">
                <div>
                    <span class="step-number">12</span>
                    <span class="step-title">åˆªé™¤é€å­—ç¨¿</span>
                </div>
                <div class="step-subtitle">DELETE /api/v1/sessions/{id}</div>
            </div>

            <!-- å ±å‘Šç®¡ç† -->
            <div class="flow-group-title">ğŸ“„ å ±å‘Šç®¡ç†</div>

            <div class="flow-step" data-step="generate-report">
                <div>
                    <span class="step-number">13</span>
                    <span class="step-title">ç”Ÿæˆå ±å‘Š</span>
                </div>
                <div class="step-subtitle">POST /api/v1/reports/generate</div>
            </div>

            <div class="flow-step" data-step="list-reports">
                <div>
                    <span class="step-number">14</span>
                    <span class="step-title">åˆ—å‡ºå ±å‘Š</span>
                </div>
                <div class="step-subtitle">GET /api/v1/reports</div>
            </div>

            <div class="flow-step" data-step="view-report">
                <div>
                    <span class="step-number">15</span>
                    <span class="step-title">æŸ¥çœ‹å ±å‘Š</span>
                </div>
                <div class="step-subtitle">GET /api/v1/reports/{id}</div>
            </div>

            <div class="flow-step" data-step="update-report">
                <div>
                    <span class="step-number">16</span>
                    <span class="step-title">æ›´æ–°å ±å‘Š</span>
                </div>
                <div class="step-subtitle">PATCH /api/v1/reports/{id}</div>
            </div>

            <div class="flow-step" data-step="formatted-report">
                <div>
                    <span class="step-number">17</span>
                    <span class="step-title">æ ¼å¼åŒ–å ±å‘Š</span>
                </div>
                <div class="step-subtitle">GET /api/v1/reports/{id}/formatted</div>
            </div>
        </div>

        <!-- Center Panel: Preview -->
        <div class="preview-panel">
            <div class="preview-header">
                <h1 id="preview-title">iOS API æ¸¬è©¦æ§åˆ¶å°</h1>
                <p id="preview-subtitle">é¸æ“‡å·¦å´æµç¨‹æ­¥é©Ÿé–‹å§‹æ¸¬è©¦</p>
            </div>
            <div class="preview-content" id="preview-content">
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <p>è«‹å¾å·¦å´é¸æ“‡ API æ­¥é©Ÿ</p>
                </div>
            </div>
        </div>

        <!-- Right Panel: Actions & Response -->
        <div class="action-panel">
            <div class="action-header">
                <h3 id="action-title">è«‹é¸æ“‡æ­¥é©Ÿ</h3>
                <p id="action-subtitle">å¡«å¯«åƒæ•¸ä¸¦åŸ·è¡Œ API å‘¼å«</p>
            </div>

            <div class="action-form" id="action-form">
                <div class="empty-state">
                    <p>è«‹å¾å·¦å´é¸æ“‡æ­¥é©Ÿ</p>
                </div>
            </div>

            <div class="response-section" id="response-section" style="display: none;">
                <div class="response-title">Response</div>
                <div id="response-status"></div>
                <div class="response-content" id="response-content"></div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let state = {
            token: localStorage.getItem('token') || '',
            currentUser: null,
            clients: [],
            sessions: [],
            reports: [],
            currentClient: null,
            currentSession: null,
            currentReport: null
        };

        const BASE_URL = window.location.origin;

        // Step configurations
        const steps = {
            login: {
                title: 'ç™»å…¥é©—è­‰',
                subtitle: 'POST /auth/login',
                renderForm: () => `
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="email" value="test@career.com" />
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="password" value="password123" />
                    </div>
                    <button class="btn btn-primary" onclick="executeLogin()">ç™»å…¥</button>
                `,
                execute: async () => {
                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;

                    const response = await fetch(`${BASE_URL}/api/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });

                    const data = await response.json();
                    if (response.ok) {
                        state.token = data.access_token;
                        localStorage.setItem('token', state.token);
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>ğŸ” ç™»å…¥æˆåŠŸ</h3>
                        <div class="info-row">
                            <span class="info-label">Token Type</span>
                            <span class="info-value">${data.token_type}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Expires In</span>
                            <span class="info-value">${data.expires_in}s</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Access Token</span>
                            <span class="info-value" style="font-size: 11px; word-break: break-all;">${data.access_token.substring(0, 40)}...</span>
                        </div>
                    </div>
                `
            },
            me: {
                title: 'å–å¾—ç•¶å‰ç”¨æˆ¶',
                subtitle: 'GET /auth/me',
                renderForm: () => `
                    <div class="info-card">
                        <p style="font-size: 13px; color: #6b7280;">éœ€è¦å…ˆç™»å…¥å–å¾— Token</p>
                    </div>
                    <button class="btn btn-primary" onclick="executeMe()" ${!state.token ? 'disabled' : ''}>å–å¾—ç”¨æˆ¶è³‡è¨Š</button>
                `,
                execute: async () => {
                    const response = await fetch(`${BASE_URL}/api/auth/me`, {
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.currentUser = data;
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>ğŸ‘¤ ç”¨æˆ¶è³‡è¨Š</h3>
                        <div class="info-row">
                            <span class="info-label">å§“å</span>
                            <span class="info-value">${data.full_name}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Email</span>
                            <span class="info-value">${data.email}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">è§’è‰²</span>
                            <span class="info-value">${data.role}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç§Ÿæˆ¶</span>
                            <span class="info-value">${data.tenant_id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç‹€æ…‹</span>
                            <span class="info-value">${data.is_active ? 'âœ… å•Ÿç”¨' : 'âŒ åœç”¨'}</span>
                        </div>
                    </div>
                `
            },
            'list-clients': {
                title: 'åˆ—å‡ºå€‹æ¡ˆ',
                subtitle: 'GET /api/v1/clients',
                renderForm: () => `
                    <div class="form-group">
                        <label>Search (optional)</label>
                        <input type="text" id="search" placeholder="æœå°‹å§“åã€ä»£ç¢¼..." />
                    </div>
                    <button class="btn btn-primary" onclick="executeListClients()" ${!state.token ? 'disabled' : ''}>æŸ¥è©¢å€‹æ¡ˆ</button>
                `,
                execute: async () => {
                    const search = document.getElementById('search').value;
                    const params = new URLSearchParams();
                    if (search) params.append('search', search);

                    const response = await fetch(`${BASE_URL}/api/v1/clients?${params}`, {
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.clients = data.items;
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <h3>ğŸ“‹ å€‹æ¡ˆåˆ—è¡¨ (å…± ${data.total} ç­†)</h3>
                    ${data.items.map(client => `
                        <div class="info-card">
                            <div class="info-row">
                                <span class="info-label">å§“å</span>
                                <span class="info-value">${client.name}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ä»£ç¢¼</span>
                                <span class="info-value">${client.code}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">å¹´é½¡</span>
                                <span class="info-value">${client.age || 'N/A'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">å»ºç«‹æ™‚é–“</span>
                                <span class="info-value">${new Date(client.created_at).toLocaleString('zh-TW')}</span>
                            </div>
                        </div>
                    `).join('')}
                `
            },
            'create-client': {
                title: 'å»ºç«‹å€‹æ¡ˆ',
                subtitle: 'POST /api/v1/clients',
                renderForm: () => `
                    <div class="form-group">
                        <label>å§“å *</label>
                        <input type="text" id="client-name" placeholder="è«‹è¼¸å…¥å§“å" />
                    </div>
                    <div class="form-group">
                        <label>ä»£ç¢¼ (é¸å¡«ï¼Œä¸å¡«è‡ªå‹•ç”Ÿæˆ C0001...)</label>
                        <input type="text" id="client-code" placeholder="ç•™ç©ºè‡ªå‹•ç”Ÿæˆï¼Œæˆ–æ‰‹å‹•è¼¸å…¥å¦‚ C001" />
                    </div>
                    <div class="form-group">
                        <label>æš±ç¨±</label>
                        <input type="text" id="client-nickname" placeholder="è«‹è¼¸å…¥æš±ç¨±" />
                    </div>
                    <div class="form-group">
                        <label>å¹´é½¡</label>
                        <input type="number" id="client-age" placeholder="è«‹è¼¸å…¥å¹´é½¡" />
                    </div>
                    <div class="form-group">
                        <label>æ€§åˆ¥</label>
                        <select id="client-gender">
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="male">ç”·æ€§</option>
                            <option value="female">å¥³æ€§</option>
                            <option value="other">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>è·æ¥­</label>
                        <input type="text" id="client-occupation" placeholder="è«‹è¼¸å…¥è·æ¥­" />
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="executeCreateClient()" ${!state.token ? 'disabled' : ''}>å»ºç«‹å€‹æ¡ˆ</button>
                        <button class="btn btn-secondary" onclick="quickFillRandomClient()" ${!state.token ? 'disabled' : ''} style="background: #6366f1;">ğŸ² å¿«é€Ÿå¡«å…¥æ¸¬è©¦è³‡æ–™</button>
                    </div>
                `,
                execute: async () => {
                    const clientData = {
                        name: document.getElementById('client-name').value,
                        nickname: document.getElementById('client-nickname').value,
                        age: parseInt(document.getElementById('client-age').value),
                        gender: document.getElementById('client-gender').value,
                        occupation: document.getElementById('client-occupation').value
                    };

                    // Only include code if user provided one
                    const code = document.getElementById('client-code').value.trim();
                    if (code) {
                        clientData.code = code;
                    }

                    const response = await fetch(`${BASE_URL}/api/v1/clients`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(clientData)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.currentClient = data;
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>âœ… å€‹æ¡ˆå»ºç«‹æˆåŠŸ</h3>
                        <div class="info-row">
                            <span class="info-label">ID</span>
                            <span class="info-value" style="font-size: 11px;">${data.id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å§“å</span>
                            <span class="info-value">${data.name}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ä»£ç¢¼</span>
                            <span class="info-value">${data.code}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å¹´é½¡</span>
                            <span class="info-value">${data.age}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æ€§åˆ¥</span>
                            <span class="info-value">${data.gender}</span>
                        </div>
                    </div>
                `
            },
            'update-client': {
                title: 'æ›´æ–°å€‹æ¡ˆ',
                subtitle: 'PATCH /api/v1/clients/{id}',
                init: async () => {
                    // Refresh client list before showing update form
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/clients`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.clients = data.items;
                                // Re-render form with updated list
                                document.getElementById('action-form').innerHTML = steps['update-client'].renderForm();
                                // Load data for first/current client
                                setTimeout(() => loadClientDataForUpdate(), 100);
                            }
                        } catch (error) {
                            console.error('Failed to refresh client list:', error);
                        }
                    }
                },
                renderForm: () => {
                    // Filter out currentClient from the list to avoid duplicates
                    const filteredClients = state.currentClient
                        ? state.clients.filter(c => c.id !== state.currentClient.id)
                        : state.clients;

                    const clientOptions = filteredClients.map(c =>
                        `<option value="${c.id}">${c.name} (${c.code})</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>é¸æ“‡å€‹æ¡ˆ *</label>
                            <select id="update-client-id" onchange="loadClientDataForUpdate()">
                                ${state.currentClient ? `<option value="${state.currentClient.id}" selected>${state.currentClient.name} (${state.currentClient.code})</option>` : ''}
                                ${clientOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æš±ç¨±</label>
                            <input type="text" id="update-client-nickname" placeholder="æ›´æ–°æš±ç¨±" />
                        </div>
                        <div class="form-group">
                            <label>å¹´é½¡</label>
                            <input type="number" id="update-client-age" placeholder="æ›´æ–°å¹´é½¡" />
                        </div>
                        <div class="form-group">
                            <label>è·æ¥­</label>
                            <input type="text" id="update-client-occupation" placeholder="æ›´æ–°è·æ¥­" />
                        </div>
                        <div class="form-group">
                            <label>æ¨™ç±¤ (é€—è™Ÿåˆ†éš”)</label>
                            <input type="text" id="update-client-tags" placeholder="ä¾‹: è·æ¶¯è«®è©¢,è½‰è·" />
                        </div>
                        <button class="btn btn-primary" onclick="executeUpdateClient()" ${!state.token || (!state.currentClient && state.clients.length === 0) ? 'disabled' : ''}>æ›´æ–°å€‹æ¡ˆ</button>
                    `;
                },
                execute: async () => {
                    const clientId = document.getElementById('update-client-id').value;
                    const updateData = {};

                    const nickname = document.getElementById('update-client-nickname').value;
                    const age = document.getElementById('update-client-age').value;
                    const occupation = document.getElementById('update-client-occupation').value;
                    const tags = document.getElementById('update-client-tags').value;

                    if (nickname) updateData.nickname = nickname;
                    if (age) updateData.age = parseInt(age);
                    if (occupation) updateData.occupation = occupation;
                    if (tags) updateData.tags = tags.split(',').map(t => t.trim());

                    const response = await fetch(`${BASE_URL}/api/v1/clients/${clientId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.currentClient = data;
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>âœ… å€‹æ¡ˆæ›´æ–°æˆåŠŸ</h3>
                        <div class="info-row">
                            <span class="info-label">å§“å</span>
                            <span class="info-value">${data.name}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æš±ç¨±</span>
                            <span class="info-value">${data.nickname || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å¹´é½¡</span>
                            <span class="info-value">${data.age || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">è·æ¥­</span>
                            <span class="info-value">${data.occupation || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æ¨™ç±¤</span>
                            <span class="info-value">${data.tags?.join(', ') || 'N/A'}</span>
                        </div>
                    </div>
                `
            },
            'delete-client': {
                title: 'åˆªé™¤å€‹æ¡ˆ',
                subtitle: 'DELETE /api/v1/clients/{id}',
                init: async () => {
                    // Refresh client list before showing delete form
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/clients`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.clients = data.items;
                                // Re-render form with updated list
                                document.getElementById('action-form').innerHTML = steps['delete-client'].renderForm();
                            }
                        } catch (error) {
                            console.error('Failed to refresh client list:', error);
                        }
                    }
                },
                renderForm: () => {
                    const clientOptions = state.clients.map(c =>
                        `<option value="${c.id}">${c.name} (${c.code})</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>é¸æ“‡è¦åˆªé™¤çš„å€‹æ¡ˆ *</label>
                            <select id="delete-client-id">
                                ${clientOptions}
                            </select>
                        </div>
                        <div class="info-card" style="background: #fee2e2; border-color: #ef4444;">
                            <p style="color: #991b1b; font-size: 13px;">âš ï¸ è­¦å‘Šï¼šåˆªé™¤å€‹æ¡ˆå¾Œç„¡æ³•å¾©åŸ!</p>
                        </div>
                        <button class="btn btn-primary" onclick="executeDeleteClient()" ${!state.token || state.clients.length === 0 ? 'disabled' : ''} style="background: #ef4444;">åˆªé™¤å€‹æ¡ˆ</button>
                    `;
                },
                execute: async () => {
                    const clientId = document.getElementById('delete-client-id').value;

                    const response = await fetch(`${BASE_URL}/api/v1/clients/${clientId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${state.token}`
                        }
                    });

                    // DELETE returns 204 No Content, no JSON to parse
                    const data = response.status === 204 ? { success: true, message: 'å€‹æ¡ˆå·²åˆªé™¤' } : await response.json();

                    // Remove deleted client from state
                    if (response.status === 204) {
                        state.clients = state.clients.filter(c => c.id !== clientId);
                        if (state.currentClient?.id === clientId) {
                            state.currentClient = null;
                        }
                        // Refresh the dropdown list
                        document.getElementById('action-form').innerHTML = steps['delete-client'].renderForm();
                    }

                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card" style="border-color: #10b981;">
                        <h3 style="color: #10b981;">âœ… å€‹æ¡ˆåˆªé™¤æˆåŠŸ</h3>
                        <p style="color: #065f46; font-size: 14px; margin-top: 12px;">è©²å€‹æ¡ˆå·²å¾ç³»çµ±ä¸­ç§»é™¤</p>
                    </div>
                `
            },
            'create-session': {
                title: 'å„²å­˜é€å­—ç¨¿',
                subtitle: 'POST /api/v1/sessions',
                renderForm: () => {
                    const clientOptions = state.clients.map(c =>
                        `<option value="${c.id}">${c.name} (${c.code})</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>é¸æ“‡å€‹æ¡ˆ *</label>
                            <select id="session-client-id">
                                ${clientOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æœƒè«‡æ—¥æœŸ *</label>
                            <input type="date" id="session-date" value="${new Date().toISOString().split('T')[0]}" />
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label>é–‹å§‹æ™‚é–“</label>
                                <input type="time" id="session-start-time" />
                            </div>
                            <div class="form-group">
                                <label>çµæŸæ™‚é–“</label>
                                <input type="time" id="session-end-time" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label>é€å­—ç¨¿å…§å®¹ *</label>
                            <textarea id="session-transcript" placeholder="è¼¸å…¥æœƒè«‡é€å­—ç¨¿..." rows="10"></textarea>
                        </div>
                        <div class="form-group">
                            <label>å‚™è¨»</label>
                            <textarea id="session-notes" placeholder="é¸å¡«" rows="3"></textarea>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="executeCreateSession()" ${!state.token || state.clients.length === 0 ? 'disabled' : ''}>å„²å­˜é€å­—ç¨¿</button>
                            <button class="btn btn-secondary" onclick="quickFillSessionData()" ${!state.token ? 'disabled' : ''} style="background: #6366f1;">ğŸ² å¿«é€Ÿå¡«å…¥æ¸¬è©¦é€å­—ç¨¿</button>
                        </div>
                    `;
                },
                execute: async () => {
                    const sessionDate = document.getElementById('session-date').value;
                    const startTime = document.getElementById('session-start-time').value;
                    const endTime = document.getElementById('session-end-time').value;

                    // Validate session_date is not empty
                    if (!sessionDate) {
                        throw new Error('æœƒè«‡æ—¥æœŸç‚ºå¿…å¡«æ¬„ä½');
                    }

                    const requestBody = {
                        client_id: document.getElementById('session-client-id').value,
                        session_date: sessionDate,  // Should be in YYYY-MM-DD format from input[type=date]
                        transcript: document.getElementById('session-transcript').value,
                        notes: document.getElementById('session-notes').value || null
                    };

                    // Add start_time and end_time if provided (non-empty)
                    if (startTime && startTime.trim()) {
                        requestBody.start_time = `${sessionDate} ${startTime}`;
                    }
                    if (endTime && endTime.trim()) {
                        requestBody.end_time = `${sessionDate} ${endTime}`;
                    }

                    const response = await fetch(`${BASE_URL}/api/v1/sessions`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.sessions = state.sessions || [];
                        state.sessions.push(data);
                        state.currentSession = data;
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>ğŸ“ é€å­—ç¨¿å·²å„²å­˜</h3>
                        <div class="info-row">
                            <span class="info-label">Session ID</span>
                            <span class="info-value">${data.id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æœƒè«‡ç·¨è™Ÿ</span>
                            <span class="info-value">ç¬¬ ${data.session_number} æ¬¡</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æœƒè«‡æ—¥æœŸ</span>
                            <span class="info-value">${new Date(data.session_date).toLocaleDateString('zh-TW')}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å·²ç”Ÿæˆå ±å‘Š</span>
                            <span class="info-value">${data.has_report ? 'æ˜¯' : 'å¦'}</span>
                        </div>
                    </div>
                `
            },
            'list-sessions': {
                title: 'åˆ—å‡ºé€å­—ç¨¿',
                subtitle: 'GET /api/v1/sessions',
                init: async () => {
                    // Refresh client list before showing form
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/clients`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.clients = data.items;
                                // Re-render form with updated list
                                document.getElementById('action-form').innerHTML = steps['list-sessions'].renderForm();
                            }
                        } catch (error) {
                            console.error('Failed to refresh client list:', error);
                        }
                    }
                },
                renderForm: () => {
                    const clientOptions = state.clients.map(c =>
                        `<option value="${c.id}">${c.name} (${c.code})</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>ç¯©é¸å€‹æ¡ˆ (å¯é¸)</label>
                            <select id="filter-session-client-id">
                                <option value="">å…¨éƒ¨</option>
                                ${clientOptions}
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="executeListSessions()" ${!state.token ? 'disabled' : ''}>åˆ—å‡ºé€å­—ç¨¿</button>
                    `;
                },
                execute: async () => {
                    const clientId = document.getElementById('filter-session-client-id').value;
                    const url = clientId
                        ? `${BASE_URL}/api/v1/sessions?client_id=${clientId}`
                        : `${BASE_URL}/api/v1/sessions`;

                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.sessions = data.items;
                    }
                    return { response, data };
                },
                renderPreview: (data) => {
                    if (data.total === 0) {
                        return `<div class="empty-state"><p>å°šç„¡é€å­—ç¨¿è¨˜éŒ„</p></div>`;
                    }
                    return `
                        <div class="info-card">
                            <h3>ğŸ“ é€å­—ç¨¿åˆ—è¡¨ (${data.total})</h3>
                        </div>
                        ${data.items.map(s => `
                            <div class="info-card" style="cursor: pointer;" onclick="state.currentSession = ${JSON.stringify(s).replace(/"/g, '&quot;')}; showStep('view-session');">
                                <div class="info-row">
                                    <span class="info-label">å€‹æ¡ˆå§“å</span>
                                    <span class="info-value">${s.client_name || 'N/A'}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">æœƒè«‡æ—¥æœŸ</span>
                                    <span class="info-value">${new Date(s.session_date).toLocaleDateString('zh-TW')}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">æœƒè«‡ç·¨è™Ÿ</span>
                                    <span class="info-value">ç¬¬ ${s.session_number} æ¬¡</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">å·²ç”Ÿæˆå ±å‘Š</span>
                                    <span class="info-value">${s.has_report ? 'âœ… æ˜¯' : 'âŒ å¦'}</span>
                                </div>
                            </div>
                        `).join('')}
                    `;
                }
            },
            'view-session': {
                title: 'æŸ¥çœ‹é€å­—ç¨¿',
                subtitle: 'GET /api/v1/sessions/{id}',
                init: async () => {
                    // Refresh session list before showing view form
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/sessions`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.sessions = data.items;
                                // Re-render form with updated list
                                document.getElementById('action-form').innerHTML = steps['view-session'].renderForm();
                            }
                        } catch (error) {
                            console.error('Failed to refresh session list:', error);
                        }
                    }
                },
                renderForm: () => {
                    const sessionOptions = (state.sessions || []).map(s =>
                        `<option value="${s.id}">${s.client_name || 'æœªçŸ¥'} - ç¬¬ ${s.session_number} æ¬¡ (${new Date(s.session_date).toLocaleDateString('zh-TW')})</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>é¸æ“‡é€å­—ç¨¿ *</label>
                            <select id="view-session-id">
                                ${sessionOptions}
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="executeViewSession()" ${!state.token || !state.sessions?.length ? 'disabled' : ''}>æŸ¥çœ‹é€å­—ç¨¿</button>
                    `;
                },
                execute: async () => {
                    const sessionId = document.getElementById('view-session-id').value;

                    const response = await fetch(`${BASE_URL}/api/v1/sessions/${sessionId}`, {
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.currentSession = data;
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>ğŸ“ é€å­—ç¨¿è©³æƒ…</h3>
                        <div class="info-row">
                            <span class="info-label">å€‹æ¡ˆå§“å</span>
                            <span class="info-value">${data.client_name || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æœƒè«‡æ—¥æœŸ</span>
                            <span class="info-value">${new Date(data.session_date).toLocaleDateString('zh-TW')}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æœƒè«‡ç·¨è™Ÿ</span>
                            <span class="info-value">ç¬¬ ${data.session_number} æ¬¡</span>
                        </div>
                        ${data.start_time ? `
                        <div class="info-row">
                            <span class="info-label">é–‹å§‹æ™‚é–“</span>
                            <span class="info-value">${new Date(data.start_time).toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'})}</span>
                        </div>
                        ` : ''}
                        ${data.end_time ? `
                        <div class="info-row">
                            <span class="info-label">çµæŸæ™‚é–“</span>
                            <span class="info-value">${new Date(data.end_time).toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'})}</span>
                        </div>
                        ` : ''}
                        <div class="info-row">
                            <span class="info-label">å·²ç”Ÿæˆå ±å‘Š</span>
                            <span class="info-value">${data.has_report ? 'âœ… æ˜¯' : 'âŒ å¦'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å»ºç«‹æ™‚é–“</span>
                            <span class="info-value">${new Date(data.created_at).toLocaleString('zh-TW')}</span>
                        </div>
                        ${data.updated_at ? `
                        <div class="info-row">
                            <span class="info-label">æ›´æ–°æ™‚é–“</span>
                            <span class="info-value">${new Date(data.updated_at).toLocaleString('zh-TW')}</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="info-card">
                        <h4>é€å­—ç¨¿å…§å®¹</h4>
                        <p style="white-space: pre-wrap; font-size: 13px; line-height: 1.6;">${data.transcript_text}</p>
                    </div>
                    ${data.notes ? `
                        <div class="info-card">
                            <h4>å‚™è¨»</h4>
                            <p style="font-size: 13px;">${data.notes}</p>
                        </div>
                    ` : ''}
                `
            },
            'update-session': {
                title: 'æ›´æ–°é€å­—ç¨¿',
                subtitle: 'PATCH /api/v1/sessions/{id}',
                init: async () => {
                    // Refresh session list before showing update form
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/sessions`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.sessions = data.items;
                                // Re-render form with updated list
                                document.getElementById('action-form').innerHTML = steps['update-session'].renderForm();
                                // Load data for first session
                                setTimeout(() => loadSessionForUpdate(), 100);
                            }
                        } catch (error) {
                            console.error('Failed to refresh session list:', error);
                        }
                    }
                },
                renderForm: () => {
                    const sessionOptions = (state.sessions || []).map(s =>
                        `<option value="${s.id}">${s.client_name || 'æœªçŸ¥'} - ç¬¬ ${s.session_number} æ¬¡ (${new Date(s.session_date).toLocaleDateString('zh-TW')})</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>é¸æ“‡é€å­—ç¨¿ *</label>
                            <select id="update-session-id" onchange="loadSessionForUpdate()">
                                ${sessionOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æœƒè«‡æ—¥æœŸ</label>
                            <input type="date" id="update-session-date" />
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label>é–‹å§‹æ™‚é–“</label>
                                <input type="time" id="update-session-start-time" />
                            </div>
                            <div class="form-group">
                                <label>çµæŸæ™‚é–“</label>
                                <input type="time" id="update-session-end-time" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label>é€å­—ç¨¿å…§å®¹</label>
                            <textarea id="update-session-transcript" placeholder="æ›´æ–°é€å­—ç¨¿..." rows="10"></textarea>
                        </div>
                        <div class="form-group">
                            <label>å‚™è¨»</label>
                            <textarea id="update-session-notes" placeholder="æ›´æ–°å‚™è¨»" rows="3"></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="executeUpdateSession()" ${!state.token || !state.sessions?.length ? 'disabled' : ''}>æ›´æ–°é€å­—ç¨¿</button>
                    `;
                },
                execute: async () => {
                    const sessionId = document.getElementById('update-session-id').value;
                    const updateData = {};

                    const sessionDate = document.getElementById('update-session-date').value;
                    const startTime = document.getElementById('update-session-start-time').value;
                    const endTime = document.getElementById('update-session-end-time').value;
                    const transcript = document.getElementById('update-session-transcript').value;
                    const notes = document.getElementById('update-session-notes').value;

                    if (sessionDate) updateData.session_date = sessionDate;
                    if (startTime && sessionDate) updateData.start_time = `${sessionDate} ${startTime}`;
                    if (endTime && sessionDate) updateData.end_time = `${sessionDate} ${endTime}`;
                    if (transcript) updateData.transcript = transcript;
                    if (notes) updateData.notes = notes;

                    const response = await fetch(`${BASE_URL}/api/v1/sessions/${sessionId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.currentSession = data;
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card" style="border-color: #10b981;">
                        <h3 style="color: #10b981;">âœ… é€å­—ç¨¿æ›´æ–°æˆåŠŸ</h3>
                        <div class="info-row">
                            <span class="info-label">æœƒè«‡æ—¥æœŸ</span>
                            <span class="info-value">${new Date(data.session_date).toLocaleDateString('zh-TW')}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æ›´æ–°æ™‚é–“</span>
                            <span class="info-value">${new Date(data.updated_at).toLocaleString('zh-TW')}</span>
                        </div>
                    </div>
                `
            },
            'delete-session': {
                title: 'åˆªé™¤é€å­—ç¨¿',
                subtitle: 'DELETE /api/v1/sessions/{id}',
                init: async () => {
                    // Refresh session list before showing delete form
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/sessions`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.sessions = data.items;
                                // Re-render form with updated list
                                document.getElementById('action-form').innerHTML = steps['delete-session'].renderForm();
                            }
                        } catch (error) {
                            console.error('Failed to refresh session list:', error);
                        }
                    }
                },
                renderForm: () => {
                    const sessionOptions = (state.sessions || []).map(s =>
                        `<option value="${s.id}">${s.client_name || 'æœªçŸ¥'} - ç¬¬ ${s.session_number} æ¬¡ (${new Date(s.session_date).toLocaleDateString('zh-TW')})</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>é¸æ“‡é€å­—ç¨¿ *</label>
                            <select id="delete-session-id">
                                ${sessionOptions}
                            </select>
                        </div>
                        <div class="info-card" style="background: #fee2e2; border-color: #ef4444;">
                            <p style="color: #991b1b; font-size: 13px;">âš ï¸ è­¦å‘Šï¼šç„¡æ³•åˆªé™¤å·²ç”Ÿæˆå ±å‘Šçš„é€å­—ç¨¿!</p>
                        </div>
                        <button class="btn btn-primary" onclick="executeDeleteSession()" ${!state.token || !state.sessions?.length ? 'disabled' : ''} style="background: #ef4444;">åˆªé™¤é€å­—ç¨¿</button>
                    `;
                },
                execute: async () => {
                    const sessionId = document.getElementById('delete-session-id').value;

                    const response = await fetch(`${BASE_URL}/api/v1/sessions/${sessionId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });

                    const data = response.status === 204 ? { success: true, message: 'é€å­—ç¨¿å·²åˆªé™¤' } : await response.json();
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card" style="border-color: #10b981;">
                        <h3 style="color: #10b981;">âœ… é€å­—ç¨¿åˆªé™¤æˆåŠŸ</h3>
                        <p style="color: #065f46; font-size: 14px; margin-top: 12px;">è©²é€å­—ç¨¿å·²å¾ç³»çµ±ä¸­ç§»é™¤</p>
                    </div>
                `
            },
            'update-counselor': {
                title: 'æ›´æ–°è«®å•†å¸«è³‡è¨Š',
                subtitle: 'PATCH /api/auth/me',
                renderForm: () => `
                    <div class="info-card">
                        <p style="font-size: 13px; color: #6b7280;">ç•¶å‰ç”¨æˆ¶: ${state.currentUser?.full_name || 'N/A'}</p>
                    </div>
                    <div class="form-group">
                        <label>å…¨å</label>
                        <input type="text" id="update-counselor-fullname" placeholder="æ›´æ–°å…¨å" value="${state.currentUser?.full_name || ''}" />
                    </div>
                    <div class="form-group">
                        <label>ç”¨æˆ¶å</label>
                        <input type="text" id="update-counselor-username" placeholder="æ›´æ–°ç”¨æˆ¶å" value="${state.currentUser?.username || ''}" />
                    </div>
                    <button class="btn btn-primary" onclick="executeUpdateCounselor()" ${!state.token || !state.currentUser ? 'disabled' : ''}>æ›´æ–°è³‡è¨Š</button>
                `,
                execute: async () => {
                    const updateData = {};

                    const fullName = document.getElementById('update-counselor-fullname').value;
                    const username = document.getElementById('update-counselor-username').value;

                    if (fullName) updateData.full_name = fullName;
                    if (username) updateData.username = username;

                    const response = await fetch(`${BASE_URL}/api/auth/me`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.currentUser = data;
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>âœ… è«®å•†å¸«è³‡è¨Šæ›´æ–°æˆåŠŸ</h3>
                        <div class="info-row">
                            <span class="info-label">å…¨å</span>
                            <span class="info-value">${data.full_name}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç”¨æˆ¶å</span>
                            <span class="info-value">${data.username}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Email</span>
                            <span class="info-value">${data.email}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">è§’è‰²</span>
                            <span class="info-value">${data.role}</span>
                        </div>
                    </div>
                `
            },
            'generate-report': {
                title: 'ç”Ÿæˆå ±å‘Š',
                subtitle: 'POST /api/v1/reports/generate',
                init: async () => {
                    // Refresh sessions list to get latest data with has_report status
                    if (state.token) {
                        try {
                            const response = await fetch(`${BASE_URL}/api/v1/sessions`, {
                                headers: { 'Authorization': `Bearer ${state.token}` }
                            });
                            if (response.ok) {
                                const data = await response.json();
                                state.sessions = data.items;
                                // Re-render form with updated list
                                document.getElementById('action-form').innerHTML = steps['generate-report'].renderForm();
                            }
                        } catch (error) {
                            console.error('Failed to refresh session list:', error);
                        }
                    }
                },
                renderForm: () => {
                    // Filter sessions that don't have reports yet
                    const sessionsWithoutReports = (state.sessions || []).filter(s => !s.has_report);

                    if (sessionsWithoutReports.length === 0) {
                        return `
                            <div class="info-card" style="background: #fef3c7; border-color: #f59e0b;">
                                <p style="color: #92400e;">âš ï¸ æ²’æœ‰æœªç”Ÿæˆå ±å‘Šçš„é€å­—ç¨¿ã€‚è«‹å…ˆå„²å­˜é€å­—ç¨¿ã€‚</p>
                            </div>
                        `;
                    }

                    const sessionOptions = sessionsWithoutReports.map(s =>
                        `<option value="${s.id}">${s.client_name} - ç¬¬${s.session_number}æ¬¡ (${new Date(s.session_date).toLocaleDateString('zh-TW')})</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>é¸æ“‡é€å­—ç¨¿ * (åƒ…é¡¯ç¤ºæœªç”Ÿæˆå ±å‘Šçš„è¨˜éŒ„)</label>
                            <select id="report-session-id">
                                ${sessionOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>å ±å‘Šé¡å‹</label>
                            <select id="report-type">
                                <option value="enhanced">Enhanced (10æ®µå¼)</option>
                                <option value="legacy">Legacy (5æ®µå¼)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>RAG ç³»çµ±</label>
                            <select id="report-rag">
                                <option value="openai">OpenAI (GPT-4.1 Mini)</option>
                                <option value="gemini">Gemini 2.5 Flash</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="executeGenerateReport()" ${!state.token ? 'disabled' : ''}>ç”Ÿæˆå ±å‘Š</button>
                    `;
                },
                execute: async () => {
                    const reportData = {
                        session_id: document.getElementById('report-session-id').value,
                        report_type: document.getElementById('report-type').value,
                        rag_system: document.getElementById('report-rag').value
                    };

                    const response = await fetch(`${BASE_URL}/api/v1/reports/generate`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(reportData)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.currentReport = data;
                    }
                    return { response, data };
                },
                renderPreview: (data) => {
                    // æª¢æŸ¥æ˜¯å¦æ˜¯ processing ç‹€æ…‹
                    if (data.report?.status === 'processing') {
                        // é–‹å§‹è¼ªè©¢
                        setTimeout(() => pollReportStatus(data.report_id), 3000);

                        return `
                            <div class="info-card" style="background: #fef3c7; border-color: #f59e0b;">
                                <h3>â³ å ±å‘Šç”Ÿæˆä¸­...</h3>
                                <p style="color: #92400e; margin-top: 12px;">é€å­—ç¨¿å·²ä¿å­˜ï¼Œå ±å‘Šæ­£åœ¨èƒŒæ™¯ç”Ÿæˆä¸­ï¼Œè«‹ç¨å€™</p>
                                <div class="info-row">
                                    <span class="info-label">Report ID</span>
                                    <span class="info-value" style="font-size: 11px;">${data.report_id}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Session ID</span>
                                    <span class="info-value" style="font-size: 11px;">${data.session_id}</span>
                                </div>
                                <div id="polling-status" style="margin-top: 16px; padding: 12px; background: white; border-radius: 6px;">
                                    <p style="font-size: 13px; color: #6b7280;">æ­£åœ¨æŸ¥è©¢ç‹€æ…‹...</p>
                                </div>
                            </div>
                        `;
                    }

                    const report = data.report?.report || {};
                    const quality = data.quality_summary || {};

                    return `
                        ${quality.grade ? `
                            <div class="quality-summary">
                                <div class="quality-grade">${quality.grade}</div>
                                <div class="quality-score">è©•åˆ†ï¼š${quality.overall_score} / 100</div>
                            </div>
                        ` : ''}

                        <div class="info-card">
                            <h3>ğŸ“Š å ±å‘ŠåŸºæœ¬è³‡è¨Š</h3>
                            <div class="info-row">
                                <span class="info-label">Report ID</span>
                                <span class="info-value" style="font-size: 11px;">${data.report_id}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Session ID</span>
                                <span class="info-value" style="font-size: 11px;">${data.session_id}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">æ¨¡å¼</span>
                                <span class="info-value">${data.report?.mode || 'N/A'}</span>
                            </div>
                        </div>

                        ${report.client_info ? `
                            <div class="report-section">
                                <h3>ğŸ‘¤ æ¡ˆä¸»è³‡æ–™</h3>
                                <div class="info-card">
                                    <div class="info-row">
                                        <span class="info-label">å§“å</span>
                                        <span class="info-value">${report.client_info.name || 'N/A'}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">æ€§åˆ¥</span>
                                        <span class="info-value">${report.client_info.gender || 'N/A'}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">å¹´é½¡</span>
                                        <span class="info-value">${report.client_info.age || 'N/A'}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">è·æ¥­</span>
                                        <span class="info-value">${report.client_info.occupation || 'N/A'}</span>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        ${report.main_concerns?.length ? `
                            <div class="report-section">
                                <h3>ğŸ¯ ä¸»è¦è­°é¡Œ</h3>
                                <ul>
                                    ${report.main_concerns.map(c => `<li>${c}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}

                        ${report.conceptualization ? `
                            <div class="report-section">
                                <h3>ğŸ’¡ å€‹æ¡ˆæ¦‚å¿µåŒ–</h3>
                                <p>${report.conceptualization}</p>
                            </div>
                        ` : ''}

                        ${report.theories?.length ? `
                            <div class="report-section">
                                <h3>ğŸ“š ç†è«–å¼•ç”¨</h3>
                                ${report.theories.slice(0, 3).map(t => `
                                    <div class="theory-item">
                                        <p>${t.text}</p>
                                        <div class="theory-meta">
                                            ç›¸ä¼¼åº¦: ${(t.score * 100).toFixed(1)}% | ä¾†æº: ${t.document}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    `;
                }
            },
            'list-reports': {
                title: 'åˆ—å‡ºå ±å‘Š',
                subtitle: 'GET /api/v1/reports',
                renderForm: () => `
                    <button class="btn btn-primary" onclick="executeListReports()" ${!state.token ? 'disabled' : ''}>æŸ¥è©¢å ±å‘Š</button>
                `,
                execute: async () => {
                    const response = await fetch(`${BASE_URL}/api/v1/reports`, {
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        state.reports = data.items;
                    }
                    return { response, data };
                },
                renderPreview: (data) => `
                    <h3>ğŸ“‹ å ±å‘Šåˆ—è¡¨ (å…± ${data.total} ç­†)</h3>
                    ${data.items.map(report => `
                        <div class="info-card">
                            <div class="info-row">
                                <span class="info-label">ID</span>
                                <span class="info-value" style="font-size: 11px;">${report.id}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">æ¨¡å¼</span>
                                <span class="info-value">${report.mode}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ç‹€æ…‹</span>
                                <span class="info-value">${report.status}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">è©•åˆ†</span>
                                <span class="info-value">${report.quality_grade || 'N/A'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">å»ºç«‹æ™‚é–“</span>
                                <span class="info-value">${new Date(report.created_at).toLocaleString('zh-TW')}</span>
                            </div>
                        </div>
                    `).join('')}
                `
            },
            'view-report': {
                title: 'æŸ¥çœ‹å ±å‘Š',
                subtitle: 'GET /api/v1/reports/{id}',
                renderForm: () => {
                    const reportOptions = state.reports.map(r =>
                        `<option value="${r.id}">Report #${r.version || 1} - ${new Date(r.created_at).toLocaleDateString('zh-TW')}</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>é¸æ“‡å ±å‘Š</label>
                            <select id="view-report-id">
                                ${state.currentReport ? `<option value="${state.currentReport.report_id}" selected>Current Report</option>` : ''}
                                ${reportOptions}
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="executeViewReport()" ${!state.token || (!state.currentReport && state.reports.length === 0) ? 'disabled' : ''}>æŸ¥çœ‹å ±å‘Š</button>
                    `;
                },
                execute: async () => {
                    const reportId = document.getElementById('view-report-id').value;
                    const response = await fetch(`${BASE_URL}/api/v1/reports/${reportId}`, {
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });
                    const data = await response.json();
                    return { response, data };
                },
                renderPreview: (data) => {
                    const content = data.content_json?.report || data.content_json || {};
                    return `
                        <div class="info-card">
                            <h3>ğŸ“„ å ±å‘Šè©³æƒ…</h3>
                            <div class="info-row">
                                <span class="info-label">ID</span>
                                <span class="info-value" style="font-size: 11px;">${data.id}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ç‰ˆæœ¬</span>
                                <span class="info-value">${data.version}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ç‹€æ…‹</span>
                                <span class="info-value">${data.status}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">è©•åˆ†</span>
                                <span class="info-value">${data.quality_grade || 'N/A'} (${data.quality_score || 'N/A'})</span>
                            </div>
                        </div>
                        <div class="response-content" style="max-height: 400px;">${JSON.stringify(content, null, 2)}</div>
                    `;
                }
            },
            'update-report': {
                title: 'æ›´æ–°å ±å‘Š',
                subtitle: 'PATCH /api/v1/reports/{id}',
                renderForm: () => {
                    const reportOptions = state.reports.map(r =>
                        `<option value="${r.id}">Report #${r.version || 1} - ${new Date(r.created_at).toLocaleDateString('zh-TW')}</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>é¸æ“‡å ±å‘Š</label>
                            <select id="update-report-id">
                                ${state.currentReport ? `<option value="${state.currentReport.report_id}" selected>Current Report</option>` : ''}
                                ${reportOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ç·¨è¼¯å¾Œçš„å ±å‘Šå…§å®¹ (JSON)</label>
                            <textarea id="update-report-content" rows="10" placeholder='{"report": {...}}'></textarea>
                        </div>
                        <div class="info-card" style="background: #e0f2fe; border-color: #3b82f6;">
                            <p style="color: #1e40af; font-size: 12px;">
                                ğŸ’¡ æç¤ºï¼šä¿®æ”¹å¾Œçš„ JSON æœƒä¿å­˜ç‚º edited_content_jsonï¼ŒAI åŸå§‹ç‰ˆæœ¬æœƒä¿ç•™åœ¨ content_json
                            </p>
                        </div>
                        <button class="btn btn-primary" onclick="executeUpdateReport()" ${!state.token || (!state.currentReport && state.reports.length === 0) ? 'disabled' : ''}>æ›´æ–°å ±å‘Š</button>
                    `;
                },
                execute: async () => {
                    const reportId = document.getElementById('update-report-id').value;
                    const contentText = document.getElementById('update-report-content').value;

                    let editedContent;
                    try {
                        editedContent = JSON.parse(contentText);
                    } catch (e) {
                        throw new Error('Invalid JSON format');
                    }

                    const response = await fetch(`${BASE_URL}/api/v1/reports/${reportId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ edited_content_json: editedContent })
                    });
                    const data = await response.json();
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>âœ… å ±å‘Šæ›´æ–°æˆåŠŸ</h3>
                        <div class="info-row">
                            <span class="info-label">Report ID</span>
                            <span class="info-value" style="font-size: 11px;">${data.id}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç·¨è¼¯æ™‚é–“</span>
                            <span class="info-value">${new Date(data.edited_at).toLocaleString('zh-TW')}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç·¨è¼¯æ¬¡æ•¸</span>
                            <span class="info-value">${data.edit_count}</span>
                        </div>
                    </div>
                    <div class="report-section">
                        <h3>ğŸ“ æ ¼å¼åŒ– Markdown</h3>
                        <div class="response-content" style="max-height: 400px; white-space: pre-wrap;">${data.formatted_markdown}</div>
                    </div>
                `
            },
            'formatted-report': {
                title: 'æ ¼å¼åŒ–å ±å‘Š',
                subtitle: 'GET /api/v1/reports/{id}/formatted',
                renderForm: () => {
                    const reportOptions = state.reports.map(r =>
                        `<option value="${r.id}">Report #${r.version || 1} - ${new Date(r.created_at).toLocaleDateString('zh-TW')}</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label>é¸æ“‡å ±å‘Š</label>
                            <select id="formatted-report-id">
                                ${state.currentReport ? `<option value="${state.currentReport.report_id}" selected>Current Report</option>` : ''}
                                ${reportOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æ ¼å¼</label>
                            <select id="formatted-format">
                                <option value="markdown">Markdown</option>
                                <option value="html">HTML</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="executeFormattedReport()" ${!state.token || (!state.currentReport && state.reports.length === 0) ? 'disabled' : ''}>å–å¾—æ ¼å¼åŒ–å ±å‘Š</button>
                    `;
                },
                execute: async () => {
                    const reportId = document.getElementById('formatted-report-id').value;
                    const format = document.getElementById('formatted-format').value;
                    const response = await fetch(`${BASE_URL}/api/v1/reports/${reportId}/formatted?format=${format}`, {
                        headers: { 'Authorization': `Bearer ${state.token}` }
                    });
                    const data = await response.json();
                    return { response, data };
                },
                renderPreview: (data) => `
                    <div class="info-card">
                        <h3>ğŸ“ æ ¼å¼åŒ–å ±å‘Š</h3>
                        <div class="info-row">
                            <span class="info-label">æ ¼å¼</span>
                            <span class="info-value">${data.format}</span>
                        </div>
                    </div>
                    <div class="response-content" style="max-height: 600px; white-space: pre-wrap;">${data.formatted_content}</div>
                `
            }
        };

        // Event handlers
        document.querySelectorAll('.flow-step').forEach(step => {
            step.addEventListener('click', () => {
                const stepKey = step.dataset.step;
                selectStep(stepKey);
            });
        });

        function selectStep(stepKey) {
            // Update active state
            document.querySelectorAll('.flow-step').forEach(s => s.classList.remove('active'));
            document.querySelector(`[data-step="${stepKey}"]`).classList.add('active');

            // Update UI
            const stepConfig = steps[stepKey];
            document.getElementById('action-title').textContent = stepConfig.title;
            document.getElementById('action-subtitle').textContent = stepConfig.subtitle;
            document.getElementById('action-form').innerHTML = stepConfig.renderForm();

            // Call init function if exists
            if (stepConfig.init) {
                stepConfig.init();
            }

            document.getElementById('preview-title').textContent = stepConfig.title;
            document.getElementById('preview-subtitle').textContent = stepConfig.subtitle;

            // Hide response initially
            document.getElementById('response-section').style.display = 'none';
        }

        async function executeStep(stepKey) {
            const stepConfig = steps[stepKey];
            const stepElement = document.querySelector(`[data-step="${stepKey}"]`);

            // Find the button in the action form and disable it with loading state
            const button = document.querySelector('#action-form .btn-primary');
            const originalText = button?.textContent;

            try {
                stepElement.classList.remove('completed', 'error');

                // Set loading state
                if (button) {
                    button.disabled = true;
                    button.textContent = 'è™•ç†ä¸­...';
                }

                const { response, data } = await stepConfig.execute();

                // Show response
                const responseSection = document.getElementById('response-section');
                const responseStatus = document.getElementById('response-status');
                const responseContent = document.getElementById('response-content');

                responseSection.style.display = 'block';
                responseStatus.innerHTML = `<span class="status-badge status-${response.ok ? 'success' : 'error'}">${response.status} ${response.statusText}</span>`;
                responseContent.textContent = JSON.stringify(data, null, 2);

                if (response.ok) {
                    stepElement.classList.add('completed');
                    // Update preview
                    if (stepConfig.renderPreview) {
                        document.getElementById('preview-content').innerHTML = stepConfig.renderPreview(data);
                    }
                } else {
                    stepElement.classList.add('error');
                    document.getElementById('preview-content').innerHTML = `
                        <div class="info-card" style="border-color: #ef4444;">
                            <h3 style="color: #ef4444;">âŒ éŒ¯èª¤</h3>
                            <p style="color: #991b1b;">${data.detail || 'è«‹æ±‚å¤±æ•—'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                stepElement.classList.add('error');
                document.getElementById('response-section').style.display = 'block';
                document.getElementById('response-status').innerHTML = `<span class="status-badge status-error">Error</span>`;
                document.getElementById('response-content').textContent = error.message;
            } finally {
                // Restore button state
                if (button) {
                    button.disabled = false;
                    button.textContent = originalText;
                }
            }
        }

        // è¼ªè©¢å ±å‘Šç‹€æ…‹
        async function pollReportStatus(reportId) {
            try {
                const response = await fetch(`${BASE_URL}/api/v1/reports/${reportId}`, {
                    headers: { 'Authorization': `Bearer ${state.token}` }
                });
                const data = await response.json();

                const pollingDiv = document.getElementById('polling-status');
                if (!pollingDiv) return;

                if (data.status === 'processing') {
                    pollingDiv.innerHTML = `<p style="font-size: 13px; color: #f59e0b;">â³ è™•ç†ä¸­... (${new Date().toLocaleTimeString('zh-TW')})</p>`;
                    setTimeout(() => pollReportStatus(reportId), 3000);
                } else if (data.status === 'draft') {
                    pollingDiv.innerHTML = `<p style="font-size: 13px; color: #10b981;">âœ… å ±å‘Šç”Ÿæˆå®Œæˆ!</p>`;
                    // è‡ªå‹•é‡æ–°è¼‰å…¥æŸ¥çœ‹å ±å‘Š
                    setTimeout(() => {
                        document.getElementById('preview-content').innerHTML = steps['generate-report'].renderPreview({
                            report_id: data.id,
                            session_id: data.session_id,
                            report: { report: data.content_json.report || data.content_json },
                            quality_summary: {
                                grade: data.quality_grade,
                                overall_score: data.quality_score,
                                strengths: data.quality_strengths,
                                improvements_needed: data.quality_weaknesses
                            }
                        });
                    }, 1000);
                } else if (data.status === 'failed') {
                    pollingDiv.innerHTML = `
                        <p style="font-size: 13px; color: #ef4444;">âŒ ç”Ÿæˆå¤±æ•—</p>
                        <p style="font-size: 12px; color: #991b1b; margin-top: 8px;">${data.error_message || 'æœªçŸ¥éŒ¯èª¤'}</p>
                    `;
                }
            } catch (error) {
                console.error('Polling error:', error);
            }
        }

        // Helper: Load session data when selecting for update
        window.loadSessionForUpdate = function() {
            const sessionId = document.getElementById('update-session-id').value;
            const session = state.sessions.find(s => s.id === sessionId);
            if (session) {
                // Set date
                const sessionDate = new Date(session.session_date);
                document.getElementById('update-session-date').value = sessionDate.toISOString().split('T')[0];

                // Set times
                if (session.start_time) {
                    const startTime = new Date(session.start_time);
                    document.getElementById('update-session-start-time').value =
                        `${String(startTime.getHours()).padStart(2, '0')}:${String(startTime.getMinutes()).padStart(2, '0')}`;
                }
                if (session.end_time) {
                    const endTime = new Date(session.end_time);
                    document.getElementById('update-session-end-time').value =
                        `${String(endTime.getHours()).padStart(2, '0')}:${String(endTime.getMinutes()).padStart(2, '0')}`;
                }

                document.getElementById('update-session-transcript').value = session.transcript_text || '';
                document.getElementById('update-session-notes').value = session.notes || '';
            }
        };

        // Load client data for update form
        window.loadClientDataForUpdate = async () => {
            const clientId = document.getElementById('update-client-id')?.value;
            if (!clientId) return;

            try {
                const response = await fetch(`${BASE_URL}/api/v1/clients/${clientId}`, {
                    headers: { 'Authorization': `Bearer ${state.token}` }
                });

                if (response.ok) {
                    const client = await response.json();
                    document.getElementById('update-client-nickname').value = client.nickname || '';
                    document.getElementById('update-client-age').value = client.age || '';
                    document.getElementById('update-client-occupation').value = client.occupation || '';
                    document.getElementById('update-client-tags').value = client.tags?.join(', ') || '';
                }
            } catch (error) {
                console.error('Failed to load client data:', error);
            }
        };

        // Quick fill session test data
        window.quickFillSessionData = () => {
            const sampleTranscripts = [
                `Co: ä½ å¥½ï¼Œä»Šå¤©æƒ³èŠäº›ä»€éº¼å‘¢ï¼Ÿ
Cl: æœ€è¿‘å·¥ä½œå£“åŠ›å¾ˆå¤§ï¼Œè¦ºå¾—å¿«è¦æ’ä¸ä¸‹å»äº†ã€‚
Co: å¯ä»¥å¤šèªªä¸€äº›å—ï¼Ÿæ˜¯ä»€éº¼æ¨£çš„å£“åŠ›ï¼Ÿ
Cl: ä¸»ç®¡ç¸½æ˜¯å°æˆ‘çš„å·¥ä½œä¸æ»¿æ„ï¼Œä¸ç®¡æˆ‘æ€éº¼åšéƒ½è¦ºå¾—ä¸å¤ å¥½ã€‚
Co: è½èµ·ä¾†ä½ æ„Ÿåˆ°å¾ˆæŒ«æŠ˜ï¼Œå¯ä»¥åˆ†äº«ä¸€å€‹å…·é«”çš„ä¾‹å­å—ï¼Ÿ
Cl: ä¸Šé€±æˆ‘åšäº†ä¸€ä»½ä¼åŠƒæ¡ˆï¼ŒèŠ±äº†å¾ˆå¤šå¿ƒåŠ›ï¼Œä½†ä¸»ç®¡åªçœ‹äº†ä¸€çœ¼å°±èªªé€™ä¸æ˜¯ä»–è¦çš„ã€‚`,
                `Co: ä¸Šæ¬¡æåˆ°çš„è·æ¶¯æ–¹å‘ï¼Œæœ‰æ–°çš„æƒ³æ³•å—ï¼Ÿ
Cl: æˆ‘ä¸€ç›´åœ¨æ€è€ƒï¼Œä½†é‚„æ˜¯å¾ˆè¿·èŒ«ã€‚
Co: è¿·èŒ«çš„æ„Ÿè¦ºæ˜¯ä»€éº¼ï¼Ÿ
Cl: ä¸çŸ¥é“è‡ªå·±é©åˆåšä»€éº¼ï¼Œä¹Ÿä¸ç¢ºå®šç¾åœ¨çš„å·¥ä½œæ˜¯ä¸æ˜¯å°çš„é¸æ“‡ã€‚
Co: è®“æˆ‘å€‘å…ˆå¾ä½ çš„èˆˆè¶£é–‹å§‹èŠèµ·å§ã€‚`,
                `Co: ä»Šå¤©çœ‹èµ·ä¾†å¿ƒæƒ…ä¸éŒ¯ï¼Ÿ
Cl: å°å•Šï¼Œé€™é€±å·¥ä½œé †åˆ©å¾ˆå¤šï¼Œä¸»ç®¡ä¹Ÿç¨±è®šäº†æˆ‘ã€‚
Co: å¾ˆé«˜èˆˆè½åˆ°é€™å€‹æ¶ˆæ¯ï¼æ˜¯ä»€éº¼æ”¹è®Šäº†ï¼Ÿ
Cl: æˆ‘é–‹å§‹ç”¨ä½ ä¸Šæ¬¡å»ºè­°çš„æ–¹æ³•ï¼Œå…ˆç¢ºèªä¸»ç®¡çš„éœ€æ±‚å†é–‹å§‹åšã€‚
Co: è½èµ·ä¾†é€™å€‹ç­–ç•¥å¾ˆæœ‰æ•ˆï¼Œç¹¼çºŒä¿æŒï¼`
            ];

            const randomTranscript = sampleTranscripts[Math.floor(Math.random() * sampleTranscripts.length)];
            const today = new Date();
            const startHour = 14 + Math.floor(Math.random() * 3); // 14-16é»
            const endHour = startHour + 1;

            document.getElementById('session-date').value = today.toISOString().split('T')[0];
            document.getElementById('session-start-time').value = `${startHour}:00`;
            document.getElementById('session-end-time').value = `${endHour}:00`;
            document.getElementById('session-transcript').value = randomTranscript;
            document.getElementById('session-notes').value = 'æ¸¬è©¦æœƒè«‡è¨˜éŒ„';
        };

        // Quick fill random client data
        window.quickFillRandomClient = () => {
            const names = ['ç‹å°æ˜', 'æå°è¯', 'é™³å¤§åŒ', 'å¼µç¾ç²', 'æ—å¿—å¼·', 'é»ƒæ·‘èŠ¬', 'åŠ‰å»ºåœ‹', 'å³ä½³ç©'];
            const nicknames = ['å°æ˜', 'å°è¯', 'å¤§åŒ', 'ç¾ç²', 'é˜¿å¼·', 'èŠ¬èŠ¬', 'å»ºåœ‹', 'ä½³ä½³'];
            const occupations = ['å·¥ç¨‹å¸«', 'è¨­è¨ˆå¸«', 'æ•™å¸«', 'é†«ç”Ÿ', 'è­·ç†å¸«', 'æœƒè¨ˆå¸«', 'æ¥­å‹™', 'è¡Œæ”¿'];
            const genders = ['male', 'female'];

            const randomIndex = Math.floor(Math.random() * names.length);

            document.getElementById('client-name').value = names[randomIndex];
            document.getElementById('client-code').value = '';  // ç•™ç©ºè‡ªå‹•ç”Ÿæˆ
            document.getElementById('client-nickname').value = nicknames[randomIndex];
            document.getElementById('client-age').value = Math.floor(Math.random() * 30) + 20;  // 20-50
            document.getElementById('client-gender').value = genders[Math.floor(Math.random() * genders.length)];
            document.getElementById('client-occupation').value = occupations[Math.floor(Math.random() * occupations.length)];
        };

        // Step execution functions
        window.executeLogin = () => executeStep('login');
        window.executeMe = () => executeStep('me');
        window.executeListClients = () => executeStep('list-clients');
        window.executeCreateClient = () => executeStep('create-client');
        window.executeUpdateClient = () => executeStep('update-client');
        window.executeDeleteClient = () => executeStep('delete-client');
        window.executeCreateSession = () => executeStep('create-session');
        window.executeListSessions = () => executeStep('list-sessions');
        window.executeViewSession = () => executeStep('view-session');
        window.executeUpdateSession = () => executeStep('update-session');
        window.executeDeleteSession = () => executeStep('delete-session');
        window.executeUpdateCounselor = () => executeStep('update-counselor');
        window.executeGenerateReport = () => executeStep('generate-report');
        window.executeListReports = () => executeStep('list-reports');
        window.executeViewReport = () => executeStep('view-report');
        window.executeUpdateReport = () => executeStep('update-report');
        window.executeFormattedReport = () => executeStep('formatted-report');

        // Auto-select first step
        selectStep('login');

        // Load token from localStorage on startup
        if (state.token) {
            fetch(`${BASE_URL}/api/auth/me`, {
                headers: { 'Authorization': `Bearer ${state.token}` }
            }).then(r => r.json()).then(data => {
                if (data.email) {
                    state.currentUser = data;
                    console.log('Token valid, user:', data.email);
                }
            }).catch(() => {
                localStorage.removeItem('token');
                state.token = '';
            });
        }
    </script>
</body>
</html>
