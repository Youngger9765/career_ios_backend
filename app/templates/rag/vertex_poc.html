{% extends "rag/base_sidebar.html" %}

{% block page_title %}Vertex AI RAG POC{% endblock %}

{% block page_content %}
<div class="mb-6">
    <h2 class="text-3xl font-bold text-white mb-2">ğŸ§ª Vertex AI RAG Engine POC</h2>
    <p class="text-gray-400">æ¸¬è©¦ Vertex AI RAG Engine vs ç¾æœ‰ RAG ç³»çµ±</p>
</div>

<!-- Status Bar -->
<div class="bg-gray-800 rounded-lg p-4 mb-6">
    <div class="flex items-center justify-between">
        <div>
            <span class="text-gray-400">ç•¶å‰ Corpus:</span>
            <span id="currentCorpus" class="text-white font-mono ml-2">æœªé¸æ“‡</span>
        </div>
        <div>
            <span class="text-gray-400">Project:</span>
            <span class="text-blue-400 font-mono ml-2">groovy-iris-473015-h3</span>
        </div>
    </div>
</div>

<!-- Step 1: Select Corpus -->
<div class="bg-gray-800 rounded-lg p-6 mb-6">
    <h3 class="text-xl font-semibold text-white mb-4">ğŸ“¦ æ­¥é©Ÿ 1: é¸æ“‡ Corpus</h3>
    <p class="text-gray-400 text-sm mb-4">ğŸ’¡ è«‹å…ˆåœ¨ GCP Console å»ºç«‹ Corpus ä¸¦ä¸Šå‚³æ–‡ä»¶</p>

    <div>
        <label class="block text-sm font-medium text-gray-300 mb-2">é¸æ“‡ç¾æœ‰ Corpus</label>
        <select id="corpusList"
                class="w-full bg-gray-700 text-white rounded px-4 py-2 mb-2"
                onchange="selectCorpus(this.value)">
            <option value="">-- é¸æ“‡ Corpus --</option>
        </select>
        <button onclick="refreshCorpusList()"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded transition">
            ğŸ”„ é‡æ–°æ•´ç†
        </button>
    </div>
</div>

<!-- Step 2: Query & Compare -->
<div class="bg-gray-800 rounded-lg p-6 mb-6">
    <h3 class="text-xl font-semibold text-white mb-4">ğŸ” æ­¥é©Ÿ 2: æŸ¥è©¢èˆ‡å°æ¯”</h3>

    <!-- Query Input -->
    <div class="mb-4">
        <label class="block text-sm font-medium text-gray-300 mb-2">è¼¸å…¥å•é¡Œ</label>
        <textarea id="queryQuestion" rows="3"
                  class="w-full bg-gray-700 text-white rounded px-4 py-2"
                  placeholder="ä¾‹ï¼šå€‹æ¡ˆæ­£åœ¨æ¢ç´¢è·æ¶¯æ–¹å‘ï¼Œä¸ç¢ºå®šæœªä¾†è¦åšä»€éº¼ï¼Œæˆ‘è©²å¦‚ä½•å”åŠ©ï¼Ÿ"></textarea>
    </div>

    <!-- Quick Test Buttons -->
    <div class="mb-4">
        <label class="block text-sm font-medium text-gray-300 mb-2">å¿«é€Ÿæ¸¬è©¦</label>
        <div class="flex gap-2">
            <button onclick="setTestQuery(1)" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2 px-3 rounded text-sm transition">
                æ¸¬è©¦ 1: æ¢ç´¢è·æ¶¯æ–¹å‘
            </button>
            <button onclick="setTestQuery(2)" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2 px-3 rounded text-sm transition">
                æ¸¬è©¦ 2: å·¥ä½œç”Ÿæ´»å¹³è¡¡
            </button>
            <button onclick="setTestQuery(3)" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2 px-3 rounded text-sm transition">
                æ¸¬è©¦ 3: è·æ¶¯ç“¶é ¸
            </button>
        </div>
    </div>

    <!-- Query Options -->
    <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Top-K çµæœæ•¸</label>
            <input type="number" id="topK" value="5" min="1" max="10"
                   class="w-full bg-gray-700 text-white rounded px-4 py-2">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">ç”Ÿæˆæ–¹å¼</label>
            <select id="useGemini" class="w-full bg-gray-700 text-white rounded px-4 py-2">
                <option value="false">åƒ…æª¢ç´¢ï¼ˆå¯æ¥ OpenAIï¼‰</option>
                <option value="true">æª¢ç´¢ + Gemini ç”Ÿæˆ</option>
            </select>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex gap-4">
        <button onclick="queryVertex()"
                class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded transition">
            ğŸš€ æŸ¥è©¢ Vertex AI
        </button>
        <button onclick="compareRag()"
                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded transition">
                âš–ï¸ å°æ¯”æ¸¬è©¦
        </button>
    </div>
</div>

<!-- Results Display -->
<div class="bg-gray-800 rounded-lg p-6 mb-6" id="resultsSection" style="display: none;">
    <h3 class="text-xl font-semibold text-white mb-4">ğŸ“Š æŸ¥è©¢çµæœ</h3>

    <div id="resultsContent">
        <!-- Results will be injected here -->
    </div>
</div>

<script>
let selectedCorpusName = '';

// Test queries
const testQueries = {
    1: "å€‹æ¡ˆæ­£åœ¨æ¢ç´¢è·æ¶¯æ–¹å‘ï¼Œä¸ç¢ºå®šæœªä¾†è¦åšä»€éº¼ï¼Œæˆ‘è©²å¦‚ä½•å”åŠ©ï¼Ÿ",
    2: "å€‹æ¡ˆé‡è¦–å·¥ä½œèˆ‡ç”Ÿæ´»å¹³è¡¡ï¼Œä½†å…¬å¸è¦æ±‚åŠ ç­ï¼Œå¦‚ä½•è«®è©¢ï¼Ÿ",
    3: "å€‹æ¡ˆé‡åˆ°è·æ¶¯ç“¶é ¸ï¼Œè¦ºå¾—å·¥ä½œæ²’æœ‰æŒ‘æˆ°æ€§ï¼Œæœ‰å“ªäº›ç†è«–å¯ä»¥åƒè€ƒï¼Ÿ"
};

function setTestQuery(num) {
    document.getElementById('queryQuestion').value = testQueries[num];
}

async function refreshCorpusList() {
    try {
        const response = await fetch('/api/rag/vertex-poc/corpus/list');
        const data = await response.json();

        const select = document.getElementById('corpusList');
        select.innerHTML = '<option value="">-- é¸æ“‡ Corpus --</option>';

        data.corpuses.forEach(corpus => {
            const option = document.createElement('option');
            option.value = corpus.name;
            option.textContent = corpus.display_name;
            select.appendChild(option);
        });

        if (selectedCorpusName) {
            select.value = selectedCorpusName;
        }
    } catch (error) {
        console.error('åˆ·æ–°åˆ—è¡¨å¤±æ•—:', error);
    }
}

function selectCorpus(corpusName) {
    selectedCorpusName = corpusName;
    const select = document.getElementById('corpusList');
    const selectedOption = select.options[select.selectedIndex];
    document.getElementById('currentCorpus').textContent = selectedOption ? selectedOption.textContent : 'æœªé¸æ“‡';
}

async function queryVertex() {
    if (!selectedCorpusName) {
        alert('è«‹å…ˆé¸æ“‡ Corpus');
        return;
    }

    const question = document.getElementById('queryQuestion').value.trim();
    if (!question) {
        alert('è«‹è¼¸å…¥å•é¡Œ');
        return;
    }

    const topK = parseInt(document.getElementById('topK').value);
    const useGemini = document.getElementById('useGemini').value === 'true';

    const resultsSection = document.getElementById('resultsSection');
    const resultsContent = document.getElementById('resultsContent');
    resultsSection.style.display = 'block';
    resultsContent.innerHTML = '<p class="text-gray-400">â³ æŸ¥è©¢ä¸­...</p>';

    try {
        const response = await fetch('/api/rag/vertex-poc/query', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                corpus_name: selectedCorpusName,
                question: question,
                top_k: topK,
                use_gemini: useGemini
            })
        });

        const data = await response.json();
        console.log('API Response:', data);
        if (response.ok) {
            displayResults(data, 'vertex');
        } else {
            resultsContent.innerHTML = `<p class="text-red-400">âŒ æŸ¥è©¢å¤±æ•—: ${data.detail}</p>`;
        }
    } catch (error) {
        resultsContent.innerHTML = `<p class="text-red-400">âŒ éŒ¯èª¤: ${error.message}</p>`;
    }
}

function displayResults(data, type) {
    const resultsContent = document.getElementById('resultsContent');
    console.log('=== displayResults DEBUG ===');
    console.log('data:', JSON.stringify(data, null, 2));

    let html = `
        <div class="mb-4">
            <div class="text-gray-400 text-sm mb-2">å•é¡Œ</div>
            <div class="bg-gray-700 rounded p-3 text-white">${data.question}</div>
        </div>
        <div class="mb-4">
            <div class="text-gray-400 text-sm mb-2">è™•ç†æ™‚é–“</div>
            <div class="text-green-400 font-mono">${data.processing_time.toFixed(3)} ç§’</div>
        </div>
    `;

    // Gemini response
    if (data.gemini_response) {
        html += `
            <div class="mb-4">
                <div class="text-gray-400 text-sm mb-2">Gemini å›ç­”</div>
                <div class="bg-gray-700 rounded p-4 text-white whitespace-pre-wrap">${data.gemini_response}</div>
            </div>
        `;
    }

    // Contexts - simplified check
    const contexts = data.contexts || [];
    console.log('contexts array:', contexts);
    console.log('contexts length:', contexts.length);

    if (contexts.length > 0) {
        html += '<div class="mb-4"><div class="text-gray-400 text-sm mb-2">æª¢ç´¢çµæœ (' + contexts.length + ' å€‹)</div>';

        for (let i = 0; i < contexts.length; i++) {
            const ctx = contexts[i];
            console.log('Processing context', i, ctx);
            const cleanText = (ctx.text || '').replace(/\r\n/g, '<br>').replace(/\n/g, '<br>');

            html += `
                <div class="bg-gray-700 rounded p-4 mb-3">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-blue-400 font-semibold">ç‰‡æ®µ ${ctx.rank}</span>
                        <span class="text-yellow-400 font-mono text-sm">ç›¸ä¼¼åº¦: ${(ctx.score || 0).toFixed(4)}</span>
                    </div>
                    <div class="text-gray-300 text-sm mb-2">${cleanText}</div>
                    <div class="text-gray-500 text-xs">ä¾†æº: ${ctx.source || 'unknown'}</div>
                </div>
            `;
        }

        html += '</div>';
    } else {
        html += '<div class="bg-yellow-900 border border-yellow-700 rounded p-4 mt-4"><p class="text-yellow-300">âš ï¸ æ²’æœ‰æ‰¾åˆ°ç›¸é—œçµæœ</p></div>';
    }

    console.log('Setting innerHTML, length:', html.length);
    resultsContent.innerHTML = html;
    console.log('=== END DEBUG ===');
}

async function compareRag() {
    alert('ğŸš§ å°æ¯”åŠŸèƒ½é–‹ç™¼ä¸­...\n\nå°‡æœƒåŒæ™‚æŸ¥è©¢ Vertex AI å’Œç¾æœ‰ RAG ç³»çµ±ï¼Œä¸¦é¡¯ç¤ºå°æ¯”çµæœã€‚');
}

// Load corpus list on page load
window.addEventListener('DOMContentLoaded', () => {
    refreshCorpusList();
});
</script>

{% endblock %}
