{% extends "rag/base_sidebar.html" %}

{% block page_title %}Vertex AI RAG POC{% endblock %}

{% block page_content %}
<div class="mb-6">
    <h2 class="text-3xl font-bold text-white mb-2">ğŸ§ª Vertex AI RAG Engine POC</h2>
    <p class="text-gray-400">æ¸¬è©¦ Vertex AI RAG Engine vs ç¾æœ‰ RAG ç³»çµ±</p>
</div>

<!-- Status Bar -->
<div class="bg-gray-800 rounded-lg p-3 mb-6">
    <div class="flex items-center justify-between text-sm">
        <div>
            <span class="text-gray-400">Corpus:</span>
            <span id="currentCorpus" class="text-blue-400 font-mono ml-2">è¼‰å…¥ä¸­...</span>
        </div>
        <button onclick="refreshCorpusList()"
                class="text-gray-400 hover:text-white transition">
            ğŸ”„
        </button>
    </div>
</div>

<!-- Query -->
<div class="bg-gray-800 rounded-lg p-6 mb-6">
    <!-- Query Input -->
    <div class="mb-4">
        <textarea id="queryQuestion" rows="3"
                  class="w-full bg-gray-700 text-white rounded px-4 py-3 text-lg"
                  placeholder="è¼¸å…¥å•é¡Œï¼Œç›´æ¥æ¸¬è©¦..."></textarea>
    </div>

    <!-- Quick Test Buttons -->
    <div class="mb-4">
        <div class="text-xs text-gray-400 mb-2">ğŸ’¬ æƒ…å¢ƒå•é¡Œï¼ˆä½ç›¸ä¼¼åº¦ï¼‰</div>
        <div class="flex gap-2 mb-3">
            <button onclick="setTestQuery(1)" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2 px-3 rounded text-sm transition">
                æ¢ç´¢è·æ¶¯
            </button>
            <button onclick="setTestQuery(2)" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2 px-3 rounded text-sm transition">
                å·¥ä½œå¹³è¡¡
            </button>
            <button onclick="setTestQuery(3)" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2 px-3 rounded text-sm transition">
                è·æ¶¯ç“¶é ¸
            </button>
        </div>
        <div class="text-xs text-gray-400 mb-2">ğŸ“„ æ–‡æª”åŸæ–‡æ¸¬è©¦ï¼ˆé«˜ç›¸ä¼¼åº¦ï¼‰</div>
        <div class="flex gap-2">
            <button onclick="setTestQuery(4)" class="flex-1 bg-blue-700 hover:bg-blue-600 text-white py-2 px-3 rounded text-sm transition">
                Holland ç†è«–
            </button>
            <button onclick="setTestQuery(5)" class="flex-1 bg-blue-700 hover:bg-blue-600 text-white py-2 px-3 rounded text-sm transition">
                CASVE å¾ªç’°
            </button>
            <button onclick="setTestQuery(6)" class="flex-1 bg-blue-700 hover:bg-blue-600 text-white py-2 px-3 rounded text-sm transition">
                Schlossberg 4S
            </button>
        </div>
    </div>

    <!-- Mode Toggle -->
    <div class="mb-4 flex gap-2">
        <label class="flex items-center gap-2 text-gray-300">
            <input type="checkbox" id="useGemini" checked class="form-checkbox h-4 w-4 text-blue-600">
            <span>ä½¿ç”¨ Gemini Groundingï¼ˆå»ºè­°ï¼‰</span>
        </label>
    </div>

    <!-- Action Button -->
    <button onclick="queryVertex()"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded transition text-lg">
        ğŸš€ æŸ¥è©¢
    </button>
</div>

<!-- Results Display -->
<div class="bg-gray-800 rounded-lg p-6 mb-6" id="resultsSection" style="display: none;">
    <h3 class="text-xl font-semibold text-white mb-4">ğŸ“Š æŸ¥è©¢çµæœ</h3>

    <div id="resultsContent">
        <!-- Results will be injected here -->
    </div>
</div>

<script>
let selectedCorpusName = '';
let allCorpuses = [];

// Test queries
const testQueries = {
    // æƒ…å¢ƒå•é¡Œï¼ˆèªç¾©è·é›¢è¼ƒé ï¼‰
    1: "å€‹æ¡ˆæ­£åœ¨æ¢ç´¢è·æ¶¯æ–¹å‘ï¼Œä¸ç¢ºå®šæœªä¾†è¦åšä»€éº¼ï¼Œæˆ‘è©²å¦‚ä½•å”åŠ©ï¼Ÿ",
    2: "å€‹æ¡ˆé‡è¦–å·¥ä½œèˆ‡ç”Ÿæ´»å¹³è¡¡ï¼Œä½†å…¬å¸è¦æ±‚åŠ ç­ï¼Œå¦‚ä½•è«®è©¢ï¼Ÿ",
    3: "å€‹æ¡ˆé‡åˆ°è·æ¶¯ç“¶é ¸ï¼Œè¦ºå¾—å·¥ä½œæ²’æœ‰æŒ‘æˆ°æ€§ï¼Œæœ‰å“ªäº›ç†è«–å¯ä»¥åƒè€ƒï¼Ÿ",

    // æ–‡æª”åŸæ–‡æ¸¬è©¦ï¼ˆèªç¾©è·é›¢è¿‘ï¼‰
    4: "Holland è·æ¥­èˆˆè¶£ç†è«–çš„å…­å¤§é¡å‹æ˜¯ä»€éº¼ï¼Ÿæ€è€ƒè€… I å’Œå‰µé€ è€… A çš„å…¸å‹è·æ¥­æœ‰å“ªäº›ï¼Ÿ",
    5: "CASVE å¾ªç’°çš„äº”å€‹éšæ®µåˆ†åˆ¥æ˜¯ä»€éº¼ï¼ŸAnalysis åˆ†æéšæ®µçš„é‡é»æ˜¯ä»€éº¼ï¼Ÿ",
    6: "Schlossberg ç”Ÿæ¶¯è½‰æ›æ¨¡å¼çš„ 4S ç³»çµ±åŒ…å«å“ªäº›ï¼Ÿæƒ…æ³ï¼ˆSituationï¼‰éœ€è¦è©•ä¼°å“ªäº›å•é¡Œï¼Ÿ"
};

function setTestQuery(num) {
    document.getElementById('queryQuestion').value = testQueries[num];
}

async function refreshCorpusList() {
    try {
        const response = await fetch('/api/rag/vertex-poc/corpus/list');
        const data = await response.json();

        allCorpuses = data.corpuses;

        // Auto-select first corpus
        if (allCorpuses.length > 0) {
            selectedCorpusName = allCorpuses[0].name;
            document.getElementById('currentCorpus').textContent = allCorpuses[0].display_name;
        } else {
            document.getElementById('currentCorpus').textContent = 'âš ï¸ ç„¡å¯ç”¨ Corpus';
        }
    } catch (error) {
        console.error('è¼‰å…¥å¤±æ•—:', error);
        document.getElementById('currentCorpus').textContent = 'âŒ è¼‰å…¥å¤±æ•—';
    }
}

async function queryVertex() {
    if (!selectedCorpusName) {
        alert('ç„¡å¯ç”¨ Corpusï¼Œè«‹å…ˆåœ¨ GCP Console å»ºç«‹');
        return;
    }

    const question = document.getElementById('queryQuestion').value.trim();
    if (!question) {
        alert('è«‹è¼¸å…¥å•é¡Œ');
        return;
    }

    const useGemini = document.getElementById('useGemini').checked;

    const resultsSection = document.getElementById('resultsSection');
    const resultsContent = document.getElementById('resultsContent');
    resultsSection.style.display = 'block';
    resultsContent.innerHTML = `<p class="text-gray-400">â³ æŸ¥è©¢ä¸­... (${useGemini ? 'Gemini Grounding' : 'ç´”æª¢ç´¢'})</p>`;

    try {
        const response = await fetch('/api/rag/vertex-poc/query', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                corpus_name: selectedCorpusName,
                question: question,
                top_k: 5,
                use_gemini: useGemini
            })
        });

        const data = await response.json();
        console.log('API Response:', data);
        if (response.ok) {
            displayResults(data, 'vertex');
        } else {
            resultsContent.innerHTML = `<p class="text-red-400">âŒ æŸ¥è©¢å¤±æ•—: ${data.detail}</p>`;
        }
    } catch (error) {
        resultsContent.innerHTML = `<p class="text-red-400">âŒ éŒ¯èª¤: ${error.message}</p>`;
    }
}

function displayResults(data, type) {
    const resultsContent = document.getElementById('resultsContent');

    let html = `
        <div class="mb-4">
            <div class="text-gray-400 text-sm mb-2">â“ å•é¡Œ</div>
            <div class="bg-gray-700 rounded p-3 text-white">${data.question}</div>
        </div>
    `;

    // 1. Gemini å›ç­” (å…ˆé¡¯ç¤º)
    if (data.gemini_response) {
        html += `
            <div class="mb-6">
                <div class="text-green-400 text-lg font-semibold mb-3">ğŸ’¬ Gemini å›ç­”</div>
                <div class="bg-gradient-to-br from-gray-700 to-gray-800 rounded-lg p-5 text-white whitespace-pre-wrap leading-relaxed">${data.gemini_response}</div>
            </div>
        `;
    }

    // 2. æª¢ç´¢çµ±è¨ˆ (æ‰¾åˆ°å¤šå°‘å…§å®¹ã€ç›¸ä¼¼åº¦)
    if (data.contexts && Array.isArray(data.contexts) && data.contexts.length > 0) {
        const avgScore = (data.contexts.reduce((sum, ctx) => sum + ctx.score, 0) / data.contexts.length).toFixed(4);
        const maxScore = Math.max(...data.contexts.map(ctx => ctx.score)).toFixed(4);

        html += `
            <div class="mb-4">
                <div class="text-blue-400 text-lg font-semibold mb-3">ğŸ“Š æª¢ç´¢çµ±è¨ˆ</div>
                <div class="text-xs text-gray-400 mb-2">ğŸ’¡ é€™æ˜¯åº•å±¤æª¢ç´¢çš„ç›¸ä¼¼åº¦åˆ†æ•¸ï¼ˆRetrieval Scoreï¼‰ï¼Œå³ä½¿åˆ†æ•¸ä¸é«˜ï¼ŒGemini ä»å¯é€é Grounding å’Œ Reasoning ç”Ÿæˆæ­£ç¢ºç­”æ¡ˆ</div>
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="grid ${data.grounding_score ? 'grid-cols-4' : 'grid-cols-3'} gap-4 text-center">
                        <div>
                            <div class="text-gray-400 text-xs mb-1">æ‰¾åˆ°å…§å®¹</div>
                            <div class="text-white text-2xl font-bold">${data.contexts.length}</div>
                            <div class="text-gray-500 text-xs">å€‹ç‰‡æ®µ</div>
                        </div>
                        <div>
                            <div class="text-gray-400 text-xs mb-1">æœ€é«˜ç›¸ä¼¼åº¦</div>
                            <div class="text-yellow-400 text-2xl font-bold">${maxScore}</div>
                            <div class="text-gray-500 text-xs">åˆ†æ•¸</div>
                        </div>
                        <div>
                            <div class="text-gray-400 text-xs mb-1">å¹³å‡ç›¸ä¼¼åº¦</div>
                            <div class="text-green-400 text-2xl font-bold">${avgScore}</div>
                            <div class="text-gray-500 text-xs">åˆ†æ•¸</div>
                        </div>
                        ${data.grounding_score ? `
                        <div>
                            <div class="text-gray-400 text-xs mb-1">Grounding è³ªé‡</div>
                            <div class="text-purple-400 text-2xl font-bold">${data.grounding_score.toFixed(4)}</div>
                            <div class="text-gray-500 text-xs">æ”¯æ´åº¦</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;

        // 3. è©³ç´°æª¢ç´¢çµæœ (æ”¶åˆé¡¯ç¤º)
        html += `
            <div class="mb-4">
                <div class="flex items-center justify-between mb-3 cursor-pointer" onclick="toggleRetrievalDetails()">
                    <div class="text-blue-400 text-lg font-semibold">ğŸ” æª¢ç´¢è©³æƒ…</div>
                    <button class="text-gray-400 hover:text-white transition text-sm">
                        <span id="toggleIcon">â–¼ å±•é–‹</span>
                    </button>
                </div>

                <!-- Compact view (default) -->
                <div id="compactView" class="space-y-2">
        `;

        data.contexts.forEach(ctx => {
            const fileName = ctx.source.split('/').pop().replace('.pdf', '');
            html += `
                <div class="bg-gray-700 rounded-lg p-3 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <span class="text-blue-400 font-mono text-sm">#${ctx.rank}</span>
                        <span class="text-gray-300 text-sm truncate">ğŸ“„ ${fileName}</span>
                    </div>
                    <span class="text-yellow-400 font-mono text-sm">${ctx.score.toFixed(4)}</span>
                </div>
            `;
        });

        html += `
                </div>

                <!-- Detailed view (hidden by default) -->
                <div id="detailedView" class="space-y-3" style="display: none;">
        `;

        data.contexts.forEach(ctx => {
            const cleanText = ctx.text.replace(/\r\n/g, '<br>').replace(/\n/g, '<br>');
            html += `
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-blue-400 font-semibold">ç‰‡æ®µ ${ctx.rank}</span>
                        <span class="text-yellow-400 font-mono text-sm">ç›¸ä¼¼åº¦: ${ctx.score.toFixed(4)}</span>
                    </div>
                    <div class="text-gray-300 text-sm mb-2 leading-relaxed">${cleanText}</div>
                    <div class="text-gray-500 text-xs">ä¾†æº: ${ctx.source}</div>
                </div>
            `;
        });

        html += `
                </div>
            </div>
        `;
    }

    // 4. è™•ç†æ™‚é–“ (æœ€å¾Œ)
    html += `
        <div class="mt-6 pt-4 border-t border-gray-700">
            <div class="flex justify-between items-center text-sm">
                <span class="text-gray-400">â±ï¸ è™•ç†æ™‚é–“</span>
                <span class="text-green-400 font-mono">${data.processing_time.toFixed(3)} ç§’</span>
            </div>
        </div>
    `;

    resultsContent.innerHTML = html;
}

// Toggle retrieval details
function toggleRetrievalDetails() {
    const compactView = document.getElementById('compactView');
    const detailedView = document.getElementById('detailedView');
    const toggleIcon = document.getElementById('toggleIcon');

    if (detailedView.style.display === 'none') {
        compactView.style.display = 'none';
        detailedView.style.display = 'block';
        toggleIcon.textContent = 'â–² æ”¶åˆ';
    } else {
        compactView.style.display = 'block';
        detailedView.style.display = 'none';
        toggleIcon.textContent = 'â–¼ å±•é–‹';
    }
}

// Auto-load on page load
window.addEventListener('DOMContentLoaded', () => {
    refreshCorpusList();
});
</script>

{% endblock %}
