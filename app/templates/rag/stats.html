{% extends "rag/base_sidebar.html" %}

{% block page_title %}è³‡æ–™åº«çµ±è¨ˆ{% endblock %}

{% block page_content %}
<div class="mb-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-2">è³‡æ–™åº«çµ±è¨ˆ</h2>
    <p class="text-gray-600">æŸ¥çœ‹å·² chunk çš„è³‡æ–™åˆ—è¡¨</p>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-4 gap-4 mb-8">
    <div class="bg-white rounded-lg p-4 shadow-md border border-gray-200">
        <div class="text-gray-600 text-sm mb-1">æ–‡ä»¶ç¸½æ•¸</div>
        <div class="text-3xl font-bold text-blue-600" id="totalDocs">-</div>
    </div>
    <div class="bg-white rounded-lg p-4 shadow-md border border-gray-200">
        <div class="text-gray-600 text-sm mb-1">Chunk ç¸½æ•¸</div>
        <div class="text-3xl font-bold text-green-600" id="totalChunks">-</div>
    </div>
    <div class="bg-white rounded-lg p-4 shadow-md border border-gray-200">
        <div class="text-gray-600 text-sm mb-1">Embeddings</div>
        <div class="text-3xl font-bold text-purple-600" id="totalEmbeddings">-</div>
    </div>
    <div class="bg-white rounded-lg p-4 shadow-md border border-gray-200">
        <div class="text-gray-600 text-sm mb-1">ç¸½å¤§å°</div>
        <div class="text-2xl font-bold text-orange-600" id="totalSize">-</div>
    </div>
</div>

<!-- Upload Section -->
<div class="bg-white rounded-lg p-6 mb-6 shadow-md border border-gray-200">
    <h3 class="text-xl font-semibold text-gray-800 mb-4">ä¸Šå‚³æ–°æ–‡ä»¶</h3>
    <div class="flex gap-4">
        <input type="file" id="fileInput" accept=".pdf" multiple class="flex-1 bg-white text-gray-800 rounded-lg px-4 py-2 border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
        <button onclick="uploadFiles()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition shadow-sm">
            ä¸Šå‚³ PDF
        </button>
    </div>
    <div id="uploadProgress" class="mt-4 space-y-2"></div>
</div>

<!-- Documents List -->
<div class="bg-white rounded-lg p-6 shadow-md border border-gray-200">
    <h3 class="text-xl font-semibold text-gray-800 mb-4">å·²è™•ç†æ–‡ä»¶</h3>
    <div class="overflow-x-auto">
        <table class="w-full text-left">
            <thead>
                <tr class="border-b-2 border-gray-200">
                    <th class="py-3 px-4 text-gray-700 font-semibold">æ–‡ä»¶åç¨±</th>
                    <th class="py-3 px-4 text-gray-700 font-semibold">é æ•¸</th>
                    <th class="py-3 px-4 text-gray-700 font-semibold">Chunks</th>
                    <th class="py-3 px-4 text-gray-700 font-semibold">å¥åº·åº¦</th>
                    <th class="py-3 px-4 text-gray-700 font-semibold">å¤§å°</th>
                    <th class="py-3 px-4 text-gray-700 font-semibold">ä¸Šå‚³æ™‚é–“</th>
                    <th class="py-3 px-4 text-gray-700 font-semibold">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="docsList">
                <tr>
                    <td colspan="7" class="text-gray-500 text-center py-8">è¼‰å…¥ä¸­...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modal for viewing chunks -->
<div id="chunksModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto shadow-2xl">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-800" id="modalTitle">Chunks è©³ç´°è³‡æ–™</h3>
            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        </div>
        <div id="chunksContent" class="space-y-3">
            <div class="text-gray-500 text-center py-8">è¼‰å…¥ä¸­...</div>
        </div>
    </div>
</div>

<script>
async function loadStats() {
    try {
        console.log('Fetching stats from /api/rag/stats/...');
        const response = await fetch('/api/rag/stats/');
        console.log('Response status:', response.status);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        console.log('Received data:', data);
        console.log('Documents count:', data.documents ? data.documents.length : 0);

        document.getElementById('totalDocs').textContent = data.total_documents || 0;
        document.getElementById('totalChunks').textContent = data.total_chunks || 0;
        document.getElementById('totalEmbeddings').textContent = data.total_embeddings || 0;
        document.getElementById('totalSize').textContent = formatBytes(data.total_bytes || 0);

        // Display documents
        const docsList = document.getElementById('docsList');
        if (data.documents && data.documents.length > 0) {
            console.log('Rendering', data.documents.length, 'documents');
            docsList.innerHTML = data.documents.map(doc => {
                const health = calculateHealth(doc);
                return `
                <tr class="border-b border-gray-200 hover:bg-blue-50 transition">
                    <td class="py-4 px-4 text-gray-800 font-medium">${doc.title}</td>
                    <td class="py-4 px-4 text-gray-600">${doc.pages}</td>
                    <td class="py-4 px-4 text-gray-600">${doc.chunks_count}</td>
                    <td class="py-4 px-4">
                        <div class="flex items-center gap-2">
                            <span class="${health.color}">${health.icon}</span>
                            <span class="${health.color} text-sm font-medium">${health.label}</span>
                            <span class="text-gray-500 text-xs">(${health.ratio}%)</span>
                        </div>
                    </td>
                    <td class="py-4 px-4 text-gray-600">${formatBytes(doc.bytes)}</td>
                    <td class="py-4 px-4 text-gray-500 text-sm">${new Date(doc.created_at).toLocaleString('zh-TW')}</td>
                    <td class="py-4 px-4">
                        <div class="flex gap-2">
                            <button onclick="viewChunks(${doc.id}, '${doc.title}')" class="text-blue-600 hover:text-blue-800 hover:bg-blue-100 px-3 py-1 rounded text-sm transition">
                                æŸ¥çœ‹
                            </button>
                            <button onclick="rebuildDoc(${doc.id}, '${doc.title}')" class="text-orange-600 hover:text-orange-800 hover:bg-orange-100 px-3 py-1 rounded text-sm transition">
                                é‡å»º
                            </button>
                            <button onclick="deleteDoc(${doc.id})" class="text-red-600 hover:text-red-800 hover:bg-red-100 px-3 py-1 rounded text-sm transition">
                                åˆªé™¤
                            </button>
                        </div>
                    </td>
                </tr>
            `}).join('');
        } else {
            console.log('No documents found in response');
            docsList.innerHTML = '<tr><td colspan="7" class="text-gray-500 text-center py-8">å°šç„¡æ–‡ä»¶</td></tr>';
        }
    } catch (error) {
        console.error('Failed to load stats:', error);
        console.error('Error stack:', error.stack);
        document.getElementById('docsList').innerHTML = '<tr><td colspan="7" class="text-red-600 text-center py-8">è¼‰å…¥å¤±æ•—: ' + error.message + '</td></tr>';
        // Also update stats to show error
        document.getElementById('totalDocs').textContent = 'Error';
        document.getElementById('totalChunks').textContent = 'Error';
        document.getElementById('totalEmbeddings').textContent = 'Error';
        document.getElementById('totalSize').textContent = 'Error';
    }
}

function calculateHealth(doc) {
    // Calculate expected chunk total with overlap
    // Expected total = original_text + (num_chunks - 1) * overlap
    // This accounts for the fact that each chunk overlaps with the previous one

    if (!doc.text_length || doc.text_length === 0) {
        // Old documents without text_length - needs rebuild
        return {
            icon: 'ğŸ”§',
            label: 'éœ€é‡å»º',
            color: 'text-orange-600',
            ratio: 'è«‹é»é‡å»º'
        };
    }

    const overlap = 80; // chunk overlap size
    const expectedTotal = doc.text_length + (doc.chunks_count - 1) * overlap;
    const ratio = doc.total_text_chars / expectedTotal;
    const percentage = Math.round(ratio * 100);

    if (ratio >= 0.95 && ratio <= 1.05) {
        return {
            icon: 'âœ…',
            label: 'å¥åº·',
            color: 'text-green-600',
            ratio: percentage + '%'
        };
    } else if (ratio >= 0.85 && ratio < 0.95) {
        return {
            icon: 'âš ï¸',
            label: 'åä½',
            color: 'text-yellow-600',
            ratio: percentage + '%'
        };
    } else if (ratio > 1.05 && ratio <= 1.15) {
        return {
            icon: 'âš ï¸',
            label: 'åé«˜',
            color: 'text-yellow-600',
            ratio: percentage + '%'
        };
    } else {
        return {
            icon: 'âŒ',
            label: 'ç•°å¸¸',
            color: 'text-red-600',
            ratio: percentage + '%'
        };
    }
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

async function uploadFiles() {
    const input = document.getElementById('fileInput');
    const progressContainer = document.getElementById('uploadProgress');

    if (!input.files || input.files.length === 0) {
        progressContainer.innerHTML = '<div class="text-red-600 text-sm">è«‹é¸æ“‡æ–‡ä»¶</div>';
        return;
    }

    const files = Array.from(input.files);
    progressContainer.innerHTML = '';

    // Upload files sequentially to avoid overwhelming the server
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const fileId = `file-${i}`;

        // Create progress UI for this file
        const fileProgress = document.createElement('div');
        fileProgress.id = fileId;
        fileProgress.className = 'bg-gray-100 rounded-lg p-3 border border-gray-200';
        fileProgress.innerHTML = `
            <div class="flex justify-between items-center mb-2">
                <span class="text-gray-800 text-sm font-medium">${file.name}</span>
                <span class="text-gray-500 text-xs" id="${fileId}-status">ç­‰å¾…ä¸­...</span>
            </div>
            <div class="w-full bg-gray-300 rounded-full h-2">
                <div id="${fileId}-bar" class="bg-blue-500 h-2 rounded-full transition-all" style="width: 0%"></div>
            </div>
        `;
        progressContainer.appendChild(fileProgress);

        try {
            // Update status
            document.getElementById(`${fileId}-status`).textContent = 'ä¸Šå‚³ä¸­...';
            document.getElementById(`${fileId}-bar`).style.width = '30%';

            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch('/api/rag/ingest', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const data = await response.json();
                document.getElementById(`${fileId}-status`).innerHTML = '<span class="text-green-600 font-medium">âœ“ å®Œæˆ (' + data.chunks_created + ' chunks)</span>';
                document.getElementById(`${fileId}-bar`).style.width = '100%';
                document.getElementById(`${fileId}-bar`).classList.remove('bg-blue-500');
                document.getElementById(`${fileId}-bar`).classList.add('bg-green-500');
            } else {
                const error = await response.json();
                const errorMsg = error.detail || 'æœªçŸ¥éŒ¯èª¤';
                document.getElementById(`${fileId}-status`).innerHTML = `<span class="text-red-600 font-medium">âœ— ${errorMsg}</span>`;
                document.getElementById(`${fileId}-bar`).classList.remove('bg-blue-500');
                document.getElementById(`${fileId}-bar`).classList.add('bg-red-500');
                console.error('Upload failed:', error);
            }
        } catch (error) {
            document.getElementById(`${fileId}-status`).innerHTML = '<span class="text-red-600 font-medium">âœ— éŒ¯èª¤</span>';
            document.getElementById(`${fileId}-bar`).classList.remove('bg-blue-500');
            document.getElementById(`${fileId}-bar`).classList.add('bg-red-500');
        }
    }

    // Clear input and reload stats after all uploads
    input.value = '';
    setTimeout(() => {
        loadStats();
        progressContainer.innerHTML = '<div class="text-green-600 text-sm font-medium">âœ“ å…¨éƒ¨ä¸Šå‚³å®Œæˆ</div>';
        setTimeout(() => {
            progressContainer.innerHTML = '';
        }, 3000);
    }, 1000);
}

async function rebuildDoc(docId, docTitle) {
    if (!confirm(`ç¢ºå®šè¦é‡å»ºã€Œ${docTitle}ã€çš„ chunks å—ï¼Ÿ\n\né€™å°‡æœƒï¼š\n1. åˆªé™¤ç¾æœ‰çš„æ‰€æœ‰ chunks\n2. é‡æ–°ä¸‹è¼‰ PDF\n3. é‡æ–°åˆ‡åˆ†æ–‡å­—\n4. é‡æ–°ç”Ÿæˆ embeddings\n\néç¨‹å¯èƒ½éœ€è¦å¹¾åˆ†é˜ã€‚`)) return;

    try {
        // Show loading indicator
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = 'é‡å»ºä¸­...';
        button.disabled = true;

        const response = await fetch(`/api/rag/ingest/reprocess/${docId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                chunk_size: 400,
                overlap: 80
            })
        });

        if (response.ok) {
            const data = await response.json();
            alert(`é‡å»ºæˆåŠŸï¼\n\nèˆŠ chunks: ${data.old_chunks_deleted}\næ–° chunks: ${data.new_chunks_created}`);
            loadStats();
        } else {
            const error = await response.json();
            alert('é‡å»ºå¤±æ•—: ' + (error.detail || 'æœªçŸ¥éŒ¯èª¤'));
        }
    } catch (error) {
        alert('é‡å»ºå¤±æ•—: ' + error.message);
    } finally {
        // Restore button state
        if (button) {
            button.textContent = originalText;
            button.disabled = false;
        }
    }
}

async function deleteDoc(docId) {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ–‡ä»¶åŠå…¶æ‰€æœ‰ chunks å—ï¼Ÿ')) return;

    try {
        const response = await fetch(`/api/rag/stats/documents/${docId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            alert('åˆªé™¤æˆåŠŸ');
            loadStats();
        } else {
            alert('åˆªé™¤å¤±æ•—');
        }
    } catch (error) {
        alert('åˆªé™¤å¤±æ•—: ' + error.message);
    }
}

async function viewChunks(docId, docTitle) {
    // Show modal
    document.getElementById('chunksModal').classList.remove('hidden');
    document.getElementById('modalTitle').textContent = `Chunks è©³ç´°è³‡æ–™ - ${docTitle}`;
    document.getElementById('chunksContent').innerHTML = '<div class="text-gray-400 text-center py-8">è¼‰å…¥ä¸­...</div>';

    try {
        const response = await fetch(`/api/rag/stats/chunks/${docId}`);
        if (!response.ok) {
            throw new Error('Failed to fetch chunks');
        }

        const chunks = await response.json();

        if (chunks && chunks.length > 0) {
            document.getElementById('chunksContent').innerHTML = chunks.map((chunk, idx) => `
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-blue-600 font-mono text-sm font-semibold">Chunk #${chunk.ordinal + 1}</span>
                        <span class="text-gray-500 text-xs">${chunk.text.length} å­—å…ƒ</span>
                    </div>
                    <div class="text-gray-700 text-sm whitespace-pre-wrap leading-relaxed">${chunk.text}</div>
                </div>
            `).join('');
        } else {
            document.getElementById('chunksContent').innerHTML = '<div class="text-gray-500 text-center py-8">æ­¤æ–‡ä»¶å°šç„¡ chunks</div>';
        }
    } catch (error) {
        console.error('Failed to load chunks:', error);
        document.getElementById('chunksContent').innerHTML = '<div class="text-red-600 text-center py-8">è¼‰å…¥å¤±æ•—</div>';
    }
}

function closeModal() {
    document.getElementById('chunksModal').classList.add('hidden');
}

// Load on page load
loadStats();
</script>
{% endblock %}
