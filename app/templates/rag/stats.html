{% extends "rag/base_sidebar.html" %}

{% block page_title %}資料庫統計{% endblock %}

{% block page_content %}
<div class="mb-6">
    <h2 class="text-2xl font-bold text-white mb-2">資料庫統計</h2>
    <p class="text-gray-400">查看已 chunk 的資料列表</p>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-4 gap-4 mb-8">
    <div class="bg-gray-800 rounded-lg p-4">
        <div class="text-gray-400 text-sm mb-1">文件總數</div>
        <div class="text-3xl font-bold text-blue-400" id="totalDocs">-</div>
    </div>
    <div class="bg-gray-800 rounded-lg p-4">
        <div class="text-gray-400 text-sm mb-1">Chunk 總數</div>
        <div class="text-3xl font-bold text-green-400" id="totalChunks">-</div>
    </div>
    <div class="bg-gray-800 rounded-lg p-4">
        <div class="text-gray-400 text-sm mb-1">Embeddings</div>
        <div class="text-3xl font-bold text-purple-400" id="totalEmbeddings">-</div>
    </div>
    <div class="bg-gray-800 rounded-lg p-4">
        <div class="text-gray-400 text-sm mb-1">總大小</div>
        <div class="text-2xl font-bold text-yellow-400" id="totalSize">-</div>
    </div>
</div>

<!-- Upload Section -->
<div class="bg-gray-800 rounded-lg p-6 mb-6">
    <h3 class="text-xl font-semibold text-white mb-4">上傳新文件</h3>
    <div class="flex gap-4">
        <input type="file" id="fileInput" accept=".pdf" multiple class="flex-1 bg-gray-700 text-white rounded-lg px-4 py-2 border border-gray-600">
        <button onclick="uploadFiles()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition">
            上傳 PDF
        </button>
    </div>
    <div id="uploadProgress" class="mt-4 space-y-2"></div>
</div>

<!-- Documents List -->
<div class="bg-gray-800 rounded-lg p-6">
    <h3 class="text-xl font-semibold text-white mb-4">已處理文件</h3>
    <div class="overflow-x-auto">
        <table class="w-full text-left">
            <thead>
                <tr class="border-b border-gray-700">
                    <th class="py-3 px-4 text-gray-400 font-medium">文件名稱</th>
                    <th class="py-3 px-4 text-gray-400 font-medium">頁數</th>
                    <th class="py-3 px-4 text-gray-400 font-medium">Chunks</th>
                    <th class="py-3 px-4 text-gray-400 font-medium">健康度</th>
                    <th class="py-3 px-4 text-gray-400 font-medium">大小</th>
                    <th class="py-3 px-4 text-gray-400 font-medium">上傳時間</th>
                    <th class="py-3 px-4 text-gray-400 font-medium">操作</th>
                </tr>
            </thead>
            <tbody id="docsList">
                <tr>
                    <td colspan="7" class="text-gray-400 text-center py-8">載入中...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modal for viewing chunks -->
<div id="chunksModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-white" id="modalTitle">Chunks 詳細資料</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
        </div>
        <div id="chunksContent" class="space-y-3">
            <div class="text-gray-400 text-center py-8">載入中...</div>
        </div>
    </div>
</div>

<script>
async function loadStats() {
    try {
        console.log('Fetching stats from /api/rag/stats/...');
        const response = await fetch('/api/rag/stats/');
        console.log('Response status:', response.status);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        console.log('Received data:', data);
        console.log('Documents count:', data.documents ? data.documents.length : 0);

        document.getElementById('totalDocs').textContent = data.total_documents || 0;
        document.getElementById('totalChunks').textContent = data.total_chunks || 0;
        document.getElementById('totalEmbeddings').textContent = data.total_embeddings || 0;
        document.getElementById('totalSize').textContent = formatBytes(data.total_bytes || 0);

        // Display documents
        const docsList = document.getElementById('docsList');
        if (data.documents && data.documents.length > 0) {
            console.log('Rendering', data.documents.length, 'documents');
            docsList.innerHTML = data.documents.map(doc => {
                const health = calculateHealth(doc);
                return `
                <tr class="border-b border-gray-700 hover:bg-gray-700/50 transition">
                    <td class="py-4 px-4 text-white">${doc.title}</td>
                    <td class="py-4 px-4 text-gray-300">${doc.pages}</td>
                    <td class="py-4 px-4 text-gray-300">${doc.chunks_count}</td>
                    <td class="py-4 px-4">
                        <div class="flex items-center gap-2">
                            <span class="${health.color}">${health.icon}</span>
                            <span class="${health.color} text-sm">${health.label}</span>
                            <span class="text-gray-500 text-xs">(${health.ratio}%)</span>
                        </div>
                    </td>
                    <td class="py-4 px-4 text-gray-300">${formatBytes(doc.bytes)}</td>
                    <td class="py-4 px-4 text-gray-400 text-sm">${new Date(doc.created_at).toLocaleString('zh-TW')}</td>
                    <td class="py-4 px-4">
                        <div class="flex gap-2">
                            <button onclick="viewChunks(${doc.id}, '${doc.title}')" class="text-blue-400 hover:text-blue-300 px-2 py-1 rounded text-sm">
                                查看
                            </button>
                            <button onclick="rebuildDoc(${doc.id}, '${doc.title}')" class="text-yellow-400 hover:text-yellow-300 px-2 py-1 rounded text-sm">
                                重建
                            </button>
                            <button onclick="deleteDoc(${doc.id})" class="text-red-400 hover:text-red-300 px-2 py-1 rounded text-sm">
                                刪除
                            </button>
                        </div>
                    </td>
                </tr>
            `}).join('');
        } else {
            console.log('No documents found in response');
            docsList.innerHTML = '<tr><td colspan="7" class="text-gray-400 text-center py-8">尚無文件</td></tr>';
        }
    } catch (error) {
        console.error('Failed to load stats:', error);
        console.error('Error stack:', error.stack);
        document.getElementById('docsList').innerHTML = '<tr><td colspan="7" class="text-red-400 text-center py-8">載入失敗: ' + error.message + '</td></tr>';
        // Also update stats to show error
        document.getElementById('totalDocs').textContent = 'Error';
        document.getElementById('totalChunks').textContent = 'Error';
        document.getElementById('totalEmbeddings').textContent = 'Error';
        document.getElementById('totalSize').textContent = 'Error';
    }
}

function calculateHealth(doc) {
    // Calculate expected chunk total with overlap
    // Expected total = original_text + (num_chunks - 1) * overlap
    // This accounts for the fact that each chunk overlaps with the previous one

    if (!doc.text_length || doc.text_length === 0) {
        // Old documents without text_length - needs rebuild
        return {
            icon: '🔧',
            label: '需重建',
            color: 'text-orange-400',
            ratio: '請點重建'
        };
    }

    const overlap = 80; // chunk overlap size
    const expectedTotal = doc.text_length + (doc.chunks_count - 1) * overlap;
    const ratio = doc.total_text_chars / expectedTotal;
    const percentage = Math.round(ratio * 100);

    if (ratio >= 0.95 && ratio <= 1.05) {
        return {
            icon: '✅',
            label: '健康',
            color: 'text-green-400',
            ratio: percentage + '%'
        };
    } else if (ratio >= 0.85 && ratio < 0.95) {
        return {
            icon: '⚠️',
            label: '偏低',
            color: 'text-yellow-400',
            ratio: percentage + '%'
        };
    } else if (ratio > 1.05 && ratio <= 1.15) {
        return {
            icon: '⚠️',
            label: '偏高',
            color: 'text-yellow-400',
            ratio: percentage + '%'
        };
    } else {
        return {
            icon: '❌',
            label: '異常',
            color: 'text-red-400',
            ratio: percentage + '%'
        };
    }
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

async function uploadFiles() {
    const input = document.getElementById('fileInput');
    const progressContainer = document.getElementById('uploadProgress');

    if (!input.files || input.files.length === 0) {
        progressContainer.innerHTML = '<div class="text-red-400 text-sm">請選擇文件</div>';
        return;
    }

    const files = Array.from(input.files);
    progressContainer.innerHTML = '';

    // Upload files sequentially to avoid overwhelming the server
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const fileId = `file-${i}`;

        // Create progress UI for this file
        const fileProgress = document.createElement('div');
        fileProgress.id = fileId;
        fileProgress.className = 'bg-gray-700 rounded-lg p-3';
        fileProgress.innerHTML = `
            <div class="flex justify-between items-center mb-2">
                <span class="text-white text-sm">${file.name}</span>
                <span class="text-gray-400 text-xs" id="${fileId}-status">等待中...</span>
            </div>
            <div class="w-full bg-gray-600 rounded-full h-2">
                <div id="${fileId}-bar" class="bg-blue-500 h-2 rounded-full transition-all" style="width: 0%"></div>
            </div>
        `;
        progressContainer.appendChild(fileProgress);

        try {
            // Update status
            document.getElementById(`${fileId}-status`).textContent = '上傳中...';
            document.getElementById(`${fileId}-bar`).style.width = '30%';

            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch('/api/rag/ingest', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const data = await response.json();
                document.getElementById(`${fileId}-status`).innerHTML = '<span class="text-green-400">✓ 完成 (' + data.chunks_created + ' chunks)</span>';
                document.getElementById(`${fileId}-bar`).style.width = '100%';
                document.getElementById(`${fileId}-bar`).classList.remove('bg-blue-500');
                document.getElementById(`${fileId}-bar`).classList.add('bg-green-500');
            } else {
                const error = await response.json();
                const errorMsg = error.detail || '未知錯誤';
                document.getElementById(`${fileId}-status`).innerHTML = `<span class="text-red-400">✗ ${errorMsg}</span>`;
                document.getElementById(`${fileId}-bar`).classList.remove('bg-blue-500');
                document.getElementById(`${fileId}-bar`).classList.add('bg-red-500');
                console.error('Upload failed:', error);
            }
        } catch (error) {
            document.getElementById(`${fileId}-status`).innerHTML = '<span class="text-red-400">✗ 錯誤</span>';
            document.getElementById(`${fileId}-bar`).classList.remove('bg-blue-500');
            document.getElementById(`${fileId}-bar`).classList.add('bg-red-500');
        }
    }

    // Clear input and reload stats after all uploads
    input.value = '';
    setTimeout(() => {
        loadStats();
        progressContainer.innerHTML = '<div class="text-green-400 text-sm">✓ 全部上傳完成</div>';
        setTimeout(() => {
            progressContainer.innerHTML = '';
        }, 3000);
    }, 1000);
}

async function rebuildDoc(docId, docTitle) {
    if (!confirm(`確定要重建「${docTitle}」的 chunks 嗎？\n\n這將會：\n1. 刪除現有的所有 chunks\n2. 重新下載 PDF\n3. 重新切分文字\n4. 重新生成 embeddings\n\n過程可能需要幾分鐘。`)) return;

    try {
        // Show loading indicator
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = '重建中...';
        button.disabled = true;

        const response = await fetch(`/api/rag/ingest/reprocess/${docId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                chunk_size: 400,
                overlap: 80
            })
        });

        if (response.ok) {
            const data = await response.json();
            alert(`重建成功！\n\n舊 chunks: ${data.old_chunks_deleted}\n新 chunks: ${data.new_chunks_created}`);
            loadStats();
        } else {
            const error = await response.json();
            alert('重建失敗: ' + (error.detail || '未知錯誤'));
        }
    } catch (error) {
        alert('重建失敗: ' + error.message);
    } finally {
        // Restore button state
        if (button) {
            button.textContent = originalText;
            button.disabled = false;
        }
    }
}

async function deleteDoc(docId) {
    if (!confirm('確定要刪除此文件及其所有 chunks 嗎？')) return;

    try {
        const response = await fetch(`/api/rag/stats/documents/${docId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            alert('刪除成功');
            loadStats();
        } else {
            alert('刪除失敗');
        }
    } catch (error) {
        alert('刪除失敗: ' + error.message);
    }
}

async function viewChunks(docId, docTitle) {
    // Show modal
    document.getElementById('chunksModal').classList.remove('hidden');
    document.getElementById('modalTitle').textContent = `Chunks 詳細資料 - ${docTitle}`;
    document.getElementById('chunksContent').innerHTML = '<div class="text-gray-400 text-center py-8">載入中...</div>';

    try {
        const response = await fetch(`/api/rag/stats/chunks/${docId}`);
        if (!response.ok) {
            throw new Error('Failed to fetch chunks');
        }

        const chunks = await response.json();

        if (chunks && chunks.length > 0) {
            document.getElementById('chunksContent').innerHTML = chunks.map((chunk, idx) => `
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-blue-400 font-mono text-sm">Chunk #${chunk.ordinal + 1}</span>
                        <span class="text-gray-500 text-xs">${chunk.text.length} 字元</span>
                    </div>
                    <div class="text-gray-300 text-sm whitespace-pre-wrap">${chunk.text}</div>
                </div>
            `).join('');
        } else {
            document.getElementById('chunksContent').innerHTML = '<div class="text-gray-400 text-center py-8">此文件尚無 chunks</div>';
        }
    } catch (error) {
        console.error('Failed to load chunks:', error);
        document.getElementById('chunksContent').innerHTML = '<div class="text-red-400 text-center py-8">載入失敗</div>';
    }
}

function closeModal() {
    document.getElementById('chunksModal').classList.add('hidden');
}

// Load on page load
loadStats();
</script>
{% endblock %}
