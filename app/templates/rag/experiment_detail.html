{% extends "rag/base_sidebar.html" %}

{% block page_title %}實驗詳情{% endblock %}

{% block page_content %}
<div class="mb-6">
    <a href="/rag/evaluation" class="text-blue-600 hover:text-blue-800 text-sm mb-2 inline-block">← 返回評估系統</a>
    <h2 class="text-2xl font-bold text-gray-800 mb-2" id="experimentTitle">實驗詳情</h2>
    <p class="text-gray-600" id="experimentDescription">載入中...</p>
</div>

<!-- Experiment Info Card -->
<div class="bg-white rounded-lg p-6 mb-6 shadow-md border border-gray-200">
    <h3 class="text-xl font-semibold text-gray-800 mb-4">實驗資訊</h3>
    <div class="grid grid-cols-2 gap-4">
        <div>
            <div class="text-gray-600 text-sm">實驗類型</div>
            <div class="text-gray-800 font-medium" id="expType">-</div>
        </div>
        <div>
            <div class="text-gray-600 text-sm">狀態</div>
            <div id="expStatus">-</div>
        </div>
        <div>
            <div class="text-gray-600 text-sm">Chunking 方法</div>
            <div class="text-gray-800 font-medium" id="expChunking">-</div>
        </div>
        <div>
            <div class="text-gray-600 text-sm">參數設定</div>
            <div class="text-gray-800 font-medium" id="expParams">-</div>
        </div>
        <div>
            <div class="text-gray-600 text-sm">總查詢數</div>
            <div class="text-gray-800 font-medium" id="expQueries">-</div>
        </div>
        <div>
            <div class="text-gray-600 text-sm">平均延遲</div>
            <div class="text-gray-800 font-medium" id="expLatency">-</div>
        </div>
    </div>

    <div class="mt-4 flex gap-2">
        <a id="mlflowLink" href="#" target="_blank" class="text-purple-600 hover:text-purple-800 text-sm hidden">
            🔗 在 MLflow 中查看
        </a>
    </div>
</div>

<!-- Metrics Summary -->
<div class="grid grid-cols-4 gap-4 mb-6">
    <div class="bg-white rounded-lg p-4 shadow-md border border-gray-200">
        <div class="text-gray-600 text-sm mb-1">Faithfulness</div>
        <div class="text-3xl font-bold text-blue-600" id="metricFaithfulness">-</div>
        <div class="text-xs text-gray-500 mt-1">答案忠實度</div>
    </div>
    <div class="bg-white rounded-lg p-4 shadow-md border border-gray-200">
        <div class="text-gray-600 text-sm mb-1">Answer Relevancy</div>
        <div class="text-3xl font-bold text-green-600" id="metricRelevancy">-</div>
        <div class="text-xs text-gray-500 mt-1">答案相關性</div>
    </div>
    <div class="bg-white rounded-lg p-4 shadow-md border border-gray-200">
        <div class="text-gray-600 text-sm mb-1">Context Recall</div>
        <div class="text-3xl font-bold text-purple-600" id="metricRecall">-</div>
        <div class="text-xs text-gray-500 mt-1">上下文召回率</div>
    </div>
    <div class="bg-white rounded-lg p-4 shadow-md border border-gray-200">
        <div class="text-gray-600 text-sm mb-1">Context Precision</div>
        <div class="text-3xl font-bold text-orange-600" id="metricPrecision">-</div>
        <div class="text-xs text-gray-500 mt-1">上下文精確度</div>
    </div>
</div>

<!-- Results Table -->
<div class="bg-white rounded-lg p-6 shadow-md border border-gray-200">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold text-gray-800">評估結果明細</h3>
        <div class="flex gap-2">
            <button onclick="exportResults()" class="text-blue-600 hover:text-blue-800 hover:bg-blue-100 px-3 py-1 rounded text-sm transition">
                匯出 CSV
            </button>
        </div>
    </div>

    <div class="overflow-x-auto">
        <table class="w-full text-left text-sm">
            <thead>
                <tr class="border-b-2 border-gray-200">
                    <th class="py-3 px-3 text-gray-700 font-semibold">#</th>
                    <th class="py-3 px-3 text-gray-700 font-semibold">問題</th>
                    <th class="py-3 px-3 text-gray-700 font-semibold">答案</th>
                    <th class="py-3 px-3 text-gray-700 font-semibold">Faithfulness</th>
                    <th class="py-3 px-3 text-gray-700 font-semibold">Relevancy</th>
                    <th class="py-3 px-3 text-gray-700 font-semibold">Recall</th>
                    <th class="py-3 px-3 text-gray-700 font-semibold">Precision</th>
                    <th class="py-3 px-3 text-gray-700 font-semibold">操作</th>
                </tr>
            </thead>
            <tbody id="resultsList">
                <tr>
                    <td colspan="8" class="text-gray-500 text-center py-8">載入中...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Result Detail Modal -->
<div id="detailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto shadow-2xl">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-800">結果詳情</h3>
            <button onclick="closeDetailModal()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        </div>
        <div id="detailContent">
            <!-- Will be populated dynamically -->
        </div>
    </div>
</div>

<script>
const experimentId = "{{ experiment_id }}";
let experimentData = null;
let resultsData = [];

async function loadExperiment() {
    try {
        const response = await fetch(`/api/rag/evaluation/experiments/${experimentId}`);
        if (!response.ok) throw new Error('Failed to load experiment');

        experimentData = await response.json();

        // Update title and description
        document.getElementById('experimentTitle').textContent = experimentData.name;
        document.getElementById('experimentDescription').textContent = experimentData.description || '無描述';

        // Update info
        document.getElementById('expType').textContent = experimentData.experiment_type;
        document.getElementById('expStatus').innerHTML = getStatusBadge(experimentData.status);
        document.getElementById('expChunking').textContent = experimentData.chunking_method || '-';
        document.getElementById('expParams').textContent = experimentData.chunk_size ?
            `Size: ${experimentData.chunk_size}, Overlap: ${experimentData.chunk_overlap}` : '-';
        document.getElementById('expQueries').textContent = experimentData.total_queries || 0;
        document.getElementById('expLatency').textContent = experimentData.avg_latency_ms ?
            experimentData.avg_latency_ms.toFixed(2) + ' ms' : '-';

        // Update metrics
        document.getElementById('metricFaithfulness').textContent = formatMetric(experimentData.avg_faithfulness);
        document.getElementById('metricRelevancy').textContent = formatMetric(experimentData.avg_answer_relevancy);
        document.getElementById('metricRecall').textContent = formatMetric(experimentData.avg_context_recall);
        document.getElementById('metricPrecision').textContent = formatMetric(experimentData.avg_context_precision);

        // MLflow link
        if (experimentData.mlflow_run_id && experimentData.mlflow_experiment_id) {
            const link = document.getElementById('mlflowLink');
            link.href = `http://127.0.0.1:5000/#/experiments/${experimentData.mlflow_experiment_id}/runs/${experimentData.mlflow_run_id}`;
            link.classList.remove('hidden');
        }

        // Load results
        loadResults();
    } catch (error) {
        console.error('Failed to load experiment:', error);
        alert('載入實驗失敗: ' + error.message);
    }
}

async function loadResults() {
    try {
        const response = await fetch(`/api/rag/evaluation/experiments/${experimentId}/results`);
        if (!response.ok) throw new Error('Failed to load results');

        resultsData = await response.json();

        const list = document.getElementById('resultsList');
        if (resultsData.length > 0) {
            list.innerHTML = resultsData.map((result, idx) => `
                <tr class="border-b border-gray-200 hover:bg-blue-50 transition">
                    <td class="py-3 px-3 text-gray-600">${idx + 1}</td>
                    <td class="py-3 px-3 text-gray-800 max-w-xs truncate">${result.question}</td>
                    <td class="py-3 px-3 text-gray-800 max-w-xs truncate">${result.answer}</td>
                    <td class="py-3 px-3 ${getMetricColor(result.faithfulness)}">${formatMetric(result.faithfulness)}</td>
                    <td class="py-3 px-3 ${getMetricColor(result.answer_relevancy)}">${formatMetric(result.answer_relevancy)}</td>
                    <td class="py-3 px-3 ${getMetricColor(result.context_recall)}">${formatMetric(result.context_recall)}</td>
                    <td class="py-3 px-3 ${getMetricColor(result.context_precision)}">${formatMetric(result.context_precision)}</td>
                    <td class="py-3 px-3">
                        <button onclick="viewDetail(${idx})" class="text-blue-600 hover:text-blue-800 hover:bg-blue-100 px-2 py-1 rounded text-xs transition">
                            查看
                        </button>
                    </td>
                </tr>
            `).join('');
        } else {
            list.innerHTML = '<tr><td colspan="8" class="text-gray-500 text-center py-8">尚無結果</td></tr>';
        }
    } catch (error) {
        console.error('Failed to load results:', error);
        document.getElementById('resultsList').innerHTML =
            '<tr><td colspan="8" class="text-red-600 text-center py-8">載入失敗</td></tr>';
    }
}

function getStatusBadge(status) {
    const badges = {
        'pending': '<span class="px-2 py-1 bg-gray-200 text-gray-700 rounded-full text-xs font-medium">待執行</span>',
        'running': '<span class="px-2 py-1 bg-orange-200 text-orange-700 rounded-full text-xs font-medium">運行中</span>',
        'completed': '<span class="px-2 py-1 bg-green-200 text-green-700 rounded-full text-xs font-medium">已完成</span>',
        'failed': '<span class="px-2 py-1 bg-red-200 text-red-700 rounded-full text-xs font-medium">失敗</span>'
    };
    return badges[status] || status;
}

function formatMetric(value) {
    return value ? value.toFixed(3) : '-';
}

function getMetricColor(value) {
    if (!value) return 'text-gray-400';
    if (value >= 0.8) return 'text-green-600 font-medium';
    if (value >= 0.6) return 'text-yellow-600 font-medium';
    return 'text-red-600 font-medium';
}

function viewDetail(idx) {
    const result = resultsData[idx];

    const detailHtml = `
        <div class="space-y-4">
            <div>
                <h4 class="text-sm font-semibold text-gray-700 mb-2">問題</h4>
                <div class="bg-gray-50 rounded-lg p-3 text-gray-800">${result.question}</div>
            </div>
            <div>
                <h4 class="text-sm font-semibold text-gray-700 mb-2">答案</h4>
                <div class="bg-gray-50 rounded-lg p-3 text-gray-800">${result.answer}</div>
            </div>
            <div>
                <h4 class="text-sm font-semibold text-gray-700 mb-2">檢索到的上下文 (${result.contexts.length} 個)</h4>
                <div class="space-y-2">
                    ${result.contexts.map((ctx, i) => `
                        <div class="bg-blue-50 rounded-lg p-3 text-gray-700 text-sm">
                            <div class="text-blue-600 font-mono text-xs mb-1">Context #${i + 1}</div>
                            ${ctx}
                        </div>
                    `).join('')}
                </div>
            </div>
            ${result.ground_truth ? `
                <div>
                    <h4 class="text-sm font-semibold text-gray-700 mb-2">標準答案</h4>
                    <div class="bg-green-50 rounded-lg p-3 text-gray-800">${result.ground_truth}</div>
                </div>
            ` : ''}
            <div>
                <h4 class="text-sm font-semibold text-gray-700 mb-2">評估指標</h4>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-gray-50 rounded-lg p-3">
                        <div class="text-gray-600 text-xs">Faithfulness</div>
                        <div class="${getMetricColor(result.faithfulness)} text-lg font-bold">${formatMetric(result.faithfulness)}</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <div class="text-gray-600 text-xs">Answer Relevancy</div>
                        <div class="${getMetricColor(result.answer_relevancy)} text-lg font-bold">${formatMetric(result.answer_relevancy)}</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <div class="text-gray-600 text-xs">Context Recall</div>
                        <div class="${getMetricColor(result.context_recall)} text-lg font-bold">${formatMetric(result.context_recall)}</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <div class="text-gray-600 text-xs">Context Precision</div>
                        <div class="${getMetricColor(result.context_precision)} text-lg font-bold">${formatMetric(result.context_precision)}</div>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.getElementById('detailContent').innerHTML = detailHtml;
    document.getElementById('detailModal').classList.remove('hidden');
}

function closeDetailModal() {
    document.getElementById('detailModal').classList.add('hidden');
}

function exportResults() {
    if (resultsData.length === 0) {
        alert('無資料可匯出');
        return;
    }

    // Create CSV
    const headers = ['#', 'Question', 'Answer', 'Faithfulness', 'Answer Relevancy', 'Context Recall', 'Context Precision'];
    const rows = resultsData.map((result, idx) => [
        idx + 1,
        `"${result.question.replace(/"/g, '""')}"`,
        `"${result.answer.replace(/"/g, '""')}"`,
        result.faithfulness || '',
        result.answer_relevancy || '',
        result.context_recall || '',
        result.context_precision || ''
    ]);

    const csv = [headers.join(','), ...rows.map(row => row.join(','))].join('\n');

    // Download
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `experiment_${experimentId}_results.csv`;
    link.click();
}

// Load on page load
loadExperiment();
</script>
{% endblock %}
