{% extends "rag/base_sidebar.html" %}

{% block page_title %}Chunk ç­–ç•¥ç®¡ç†{% endblock %}

{% block page_content %}
<div class="mb-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-2">ğŸ“¦ Chunk ç­–ç•¥ç®¡ç†</h2>
    <p class="text-gray-600">ç®¡ç†ä¸åŒçš„æ–‡æœ¬åˆ‡å‰²ç­–ç•¥ï¼Œç”¨æ–¼è©•ä¼°å¯¦é©—</p>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-4 gap-4 mb-8">
    <div class="bg-white rounded-lg p-4 shadow-md border border-gray-200">
        <div class="text-gray-600 text-sm mb-1">ç¸½ç­–ç•¥æ•¸</div>
        <div class="text-3xl font-bold text-blue-600" id="totalStrategies">0</div>
    </div>
    <div class="bg-white rounded-lg p-4 shadow-md border border-gray-200">
        <div class="text-gray-600 text-sm mb-1">é è¨­ç­–ç•¥</div>
        <div class="text-3xl font-bold text-green-600" id="defaultStrategies">0</div>
    </div>
    <div class="bg-white rounded-lg p-4 shadow-md border border-gray-200">
        <div class="text-gray-600 text-sm mb-1">è‡ªè¨‚ç­–ç•¥</div>
        <div class="text-3xl font-bold text-purple-600" id="customStrategies">0</div>
    </div>
    <div class="bg-white rounded-lg p-4 shadow-md border border-gray-200">
        <div class="text-gray-600 text-sm mb-1">ä½¿ç”¨ä¸­</div>
        <div class="text-3xl font-bold text-orange-600" id="activeStrategies">0</div>
    </div>
</div>

<!-- Create New Strategy Section -->
<div class="bg-white rounded-lg shadow-md border border-gray-200 mb-6">
    <div class="p-6 border-b border-gray-200 flex justify-between items-center cursor-pointer" onclick="toggleSection('createSection')">
        <div>
            <h3 class="text-xl font-bold text-gray-800">å»ºç«‹æ–°ç­–ç•¥</h3>
            <p class="text-sm text-gray-600 mt-1">å®šç¾©æ–°çš„ chunk åˆ‡å‰²ç­–ç•¥</p>
        </div>
        <span id="createSectionIcon" class="text-gray-400 text-2xl">â–¼</span>
    </div>

    <div id="createSection" class="hidden p-6">
        <div class="grid grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ç­–ç•¥åç¨± *</label>
                <input type="text" id="strategyName"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                       placeholder="ä¾‹ï¼šä¸­ç­‰å¤§å°ç­–ç•¥">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">åˆ‡å‰²æ¼”ç®—æ³• *</label>
                <select id="strategyType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="recursive">Recursiveï¼ˆéè¿´åˆ‡å‰²ï¼‰</option>
                    <option value="parent_child">Parent-Childï¼ˆçˆ¶å­æ–‡æª”ï¼‰</option>
                    <option value="normal">Normalï¼ˆä¸€èˆ¬åˆ‡å‰²ï¼‰</option>
                    <option value="semantic">Semanticï¼ˆèªç¾©åˆ‡å‰²ï¼‰</option>
                    <option value="sliding_window">Sliding Windowï¼ˆæ»‘å‹•çª—å£ï¼‰</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Chunk Size *</label>
                <input type="number" id="chunkSize" value="400"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                       placeholder="400">
                <p class="text-xs text-gray-500 mt-1">å»ºè­°ç¯„åœï¼š200-1000 å­—å…ƒ</p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Chunk Overlap</label>
                <input type="number" id="chunkOverlap" value="80"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                       placeholder="80">
                <p class="text-xs text-gray-500 mt-1">é€šå¸¸ç‚º chunk size çš„ 20%</p>
            </div>

            <div class="col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">æè¿°</label>
                <textarea id="strategyDescription" rows="3"
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="æè¿°é€™å€‹ç­–ç•¥çš„ç”¨é€”å’Œç‰¹é»..."></textarea>
            </div>

            <div class="col-span-2 flex items-center gap-2">
                <input type="checkbox" id="isDefault" class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                <label for="isDefault" class="text-sm text-gray-700">è¨­ç‚ºé è¨­ç­–ç•¥ï¼ˆæœƒåœ¨æ–°å¯¦é©—ä¸­è‡ªå‹•ä½¿ç”¨ï¼‰</label>
            </div>
        </div>

        <div class="mt-6 flex gap-4">
            <button onclick="createStrategy()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition font-semibold">
                å»ºç«‹ç­–ç•¥
            </button>
            <button onclick="resetForm()"
                    class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg transition">
                é‡ç½®
            </button>
        </div>
    </div>
</div>

<!-- Strategies List -->
<div class="bg-white rounded-lg shadow-md border border-gray-200">
    <div class="p-6 border-b border-gray-200">
        <h3 class="text-xl font-bold text-gray-800">ç­–ç•¥åˆ—è¡¨</h3>
    </div>

    <div class="p-6">
        <div id="strategiesList" class="space-y-4">
            <!-- Strategies will be loaded here -->
            <div class="text-center text-gray-500 py-8">
                è¼‰å…¥ä¸­...
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="hidden fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transition-opacity">
    <span id="toastMessage"></span>
</div>

<script>
let strategies = [];

// Toggle section visibility
function toggleSection(sectionId) {
    const section = document.getElementById(sectionId);
    const icon = document.getElementById(sectionId + 'Icon');

    if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        icon.textContent = 'â–²';
    } else {
        section.classList.add('hidden');
        icon.textContent = 'â–¼';
    }
}

// Show toast notification
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');

    toastMessage.textContent = message;
    toast.classList.remove('hidden', 'bg-green-600', 'bg-red-600', 'bg-blue-600');

    if (type === 'success') {
        toast.classList.add('bg-green-600');
    } else if (type === 'error') {
        toast.classList.add('bg-red-600');
    } else {
        toast.classList.add('bg-blue-600');
    }

    setTimeout(() => {
        toast.classList.add('hidden');
    }, 3000);
}

// Load strategies
async function loadStrategies() {
    try {
        const response = await fetch('/api/rag/evaluation/chunk-strategies/');

        if (response.ok) {
            strategies = await response.json();
            renderStrategies();
            updateStats();
        } else {
            // If endpoint doesn't exist yet, show sample data
            strategies = getSampleStrategies();
            renderStrategies();
            updateStats();
        }
    } catch (error) {
        console.error('Failed to load strategies:', error);
        // Show sample data on error
        strategies = getSampleStrategies();
        renderStrategies();
        updateStats();
    }
}

// Get sample strategies (temporary)
function getSampleStrategies() {
    return [
        {
            id: '1',
            name: 'Recursive-å°å‹',
            type: 'recursive',
            chunk_size: 200,
            chunk_overlap: 40,
            description: 'éè¿´åˆ‡å‰²ï¼Œé©åˆç²¾ç´°æª¢ç´¢',
            is_default: false,
            created_at: new Date().toISOString()
        },
        {
            id: '2',
            name: 'Recursive-ä¸­å‹ï¼ˆé è¨­ï¼‰',
            type: 'recursive',
            chunk_size: 400,
            chunk_overlap: 80,
            description: 'éè¿´åˆ‡å‰²ï¼Œå¹³è¡¡å¤§å°ï¼Œé©åˆå¤§å¤šæ•¸å ´æ™¯',
            is_default: true,
            created_at: new Date().toISOString()
        },
        {
            id: '3',
            name: 'Recursive-å¤§å‹',
            type: 'recursive',
            chunk_size: 800,
            chunk_overlap: 160,
            description: 'éè¿´åˆ‡å‰²ï¼Œä¿ç•™æ›´å¤šä¸Šä¸‹æ–‡',
            is_default: false,
            created_at: new Date().toISOString()
        },
        {
            id: '4',
            name: 'Parent-Child-æ¨™æº–',
            type: 'parent_child',
            chunk_size: 400,
            chunk_overlap: 0,
            description: 'çˆ¶å­æ–‡æª”çµæ§‹ï¼Œé©åˆéšå±¤å¼æª¢ç´¢',
            is_default: false,
            created_at: new Date().toISOString()
        },
        {
            id: '5',
            name: 'Normal-å¿«é€Ÿ',
            type: 'normal',
            chunk_size: 300,
            chunk_overlap: 50,
            description: 'ä¸€èˆ¬åˆ‡å‰²ï¼Œè™•ç†é€Ÿåº¦å¿«',
            is_default: false,
            created_at: new Date().toISOString()
        },
        {
            id: '6',
            name: 'Semantic-æ™ºèƒ½',
            type: 'semantic',
            chunk_size: 500,
            chunk_overlap: 100,
            description: 'åŸºæ–¼èªç¾©åˆ‡å‰²ï¼Œä¿æŒèªæ„å®Œæ•´æ€§',
            is_default: false,
            created_at: new Date().toISOString()
        }
    ];
}

// Render strategies list
function renderStrategies() {
    const container = document.getElementById('strategiesList');

    if (strategies.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-8">å°šç„¡ç­–ç•¥ï¼Œè«‹å»ºç«‹ç¬¬ä¸€å€‹ç­–ç•¥</div>';
        return;
    }

    container.innerHTML = strategies.map(strategy => `
        <div class="border border-gray-200 rounded-lg p-5 hover:border-blue-400 hover:shadow-md transition">
            <div class="flex justify-between items-start mb-4">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                        <h4 class="font-bold text-lg text-gray-800">${strategy.name}</h4>
                        ${strategy.is_default ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded font-medium">é è¨­</span>' : ''}
                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded font-medium">${getTypeLabel(strategy.type)}</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">${strategy.description || 'ç„¡æè¿°'}</p>
                    <p class="text-xs text-gray-500 italic">${getTypeDescription(strategy.type)}</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="editStrategy('${strategy.id}')"
                            class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                        âœï¸ ç·¨è¼¯
                    </button>
                    <button onclick="deleteStrategy('${strategy.id}')"
                            class="text-red-600 hover:text-red-800 text-sm font-medium">
                        ğŸ—‘ï¸ åˆªé™¤
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 pt-3 border-t border-gray-100">
                <div class="flex items-center gap-2">
                    <span class="text-gray-500 text-sm">ğŸ“ Chunk Size:</span>
                    <span class="font-bold text-blue-600">${strategy.chunk_size}</span>
                    <span class="text-xs text-gray-400">å­—å…ƒ</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-gray-500 text-sm">ğŸ”— Overlap:</span>
                    <span class="font-bold text-purple-600">${strategy.chunk_overlap}</span>
                    <span class="text-xs text-gray-400">(${Math.round(strategy.chunk_overlap / strategy.chunk_size * 100)}%)</span>
                </div>
            </div>
        </div>
    `).join('');
}

// Update stats
function updateStats() {
    document.getElementById('totalStrategies').textContent = strategies.length;
    document.getElementById('defaultStrategies').textContent = strategies.filter(s => s.is_default).length;
    document.getElementById('customStrategies').textContent = strategies.filter(s => !s.is_default).length;
    document.getElementById('activeStrategies').textContent = strategies.length;
}

// Get type label
function getTypeLabel(type) {
    const labels = {
        'recursive': 'Recursive',
        'parent_child': 'Parent-Child',
        'normal': 'Normal',
        'semantic': 'Semantic',
        'sliding_window': 'Sliding Window'
    };
    return labels[type] || type;
}

// Get type description
function getTypeDescription(type) {
    const descriptions = {
        'recursive': 'éè¿´åˆ‡å‰² - æ™ºèƒ½åˆ†æ®µï¼Œä¿æŒçµæ§‹å®Œæ•´',
        'parent_child': 'çˆ¶å­æ–‡æª” - éšå±¤å¼çµæ§‹ï¼Œä¾¿æ–¼ä¸Šä¸‹æ–‡æª¢ç´¢',
        'normal': 'ä¸€èˆ¬åˆ‡å‰² - ç°¡å–®å¿«é€Ÿï¼Œé©åˆå¤§é‡æ–‡æœ¬',
        'semantic': 'èªç¾©åˆ‡å‰² - åŸºæ–¼èªç¾©é‚Šç•Œï¼Œä¿æŒèªæ„å®Œæ•´',
        'sliding_window': 'æ»‘å‹•çª—å£ - é‡ç–Šåˆ‡å‰²ï¼Œæé«˜è¦†è“‹ç‡'
    };
    return descriptions[type] || '';
}

// Create strategy
async function createStrategy() {
    const name = document.getElementById('strategyName').value.trim();
    const type = document.getElementById('strategyType').value;
    const chunkSize = parseInt(document.getElementById('chunkSize').value);
    const chunkOverlap = parseInt(document.getElementById('chunkOverlap').value);
    const description = document.getElementById('strategyDescription').value.trim();
    const isDefault = document.getElementById('isDefault').checked;

    if (!name) {
        showToast('è«‹è¼¸å…¥ç­–ç•¥åç¨±', 'error');
        return;
    }

    if (!chunkSize || chunkSize < 50) {
        showToast('Chunk size å¿…é ˆå¤§æ–¼ 50', 'error');
        return;
    }

    const data = {
        name,
        type,
        chunk_size: chunkSize,
        chunk_overlap: chunkOverlap,
        description,
        is_default: isDefault
    };

    try {
        const response = await fetch('/rag/api/evaluation/chunk-strategies', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            showToast('ç­–ç•¥å»ºç«‹æˆåŠŸï¼', 'success');
            resetForm();
            await loadStrategies();
        } else {
            const error = await response.json();
            showToast('å»ºç«‹å¤±æ•—ï¼š' + (error.detail || 'æœªçŸ¥éŒ¯èª¤'), 'error');
        }
    } catch (error) {
        console.error('Failed to create strategy:', error);
        showToast('å»ºç«‹å¤±æ•—ï¼š' + error.message, 'error');
    }
}

// Reset form
function resetForm() {
    document.getElementById('strategyName').value = '';
    document.getElementById('strategyType').value = 'fixed';
    document.getElementById('chunkSize').value = '400';
    document.getElementById('chunkOverlap').value = '80';
    document.getElementById('strategyDescription').value = '';
    document.getElementById('isDefault').checked = false;
}

// Edit strategy
function editStrategy(id) {
    const strategy = strategies.find(s => s.id === id);
    if (!strategy) return;

    document.getElementById('strategyName').value = strategy.name;
    document.getElementById('strategyType').value = strategy.type;
    document.getElementById('chunkSize').value = strategy.chunk_size;
    document.getElementById('chunkOverlap').value = strategy.chunk_overlap;
    document.getElementById('strategyDescription').value = strategy.description || '';
    document.getElementById('isDefault').checked = strategy.is_default;

    // Expand create section
    const section = document.getElementById('createSection');
    const icon = document.getElementById('createSectionIcon');
    section.classList.remove('hidden');
    icon.textContent = 'â–²';

    // Scroll to form
    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Delete strategy
async function deleteStrategy(id) {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç­–ç•¥å—ï¼Ÿ')) return;

    try {
        const response = await fetch(`/rag/api/evaluation/chunk-strategies/${id}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            showToast('ç­–ç•¥å·²åˆªé™¤', 'success');
            await loadStrategies();
        } else {
            const error = await response.json();
            showToast('åˆªé™¤å¤±æ•—ï¼š' + (error.detail || 'æœªçŸ¥éŒ¯èª¤'), 'error');
        }
    } catch (error) {
        console.error('Failed to delete strategy:', error);
        showToast('åˆªé™¤å¤±æ•—ï¼š' + error.message, 'error');
    }
}

// Load data on page load
document.addEventListener('DOMContentLoaded', () => {
    loadStrategies();

    // Collapse create section by default
    const section = document.getElementById('createSection');
    const icon = document.getElementById('createSectionIcon');
    section.classList.add('hidden');
    icon.textContent = 'â–¼';
});
</script>
{% endblock %}
