{% extends "rag/base_sidebar.html" %}

{% block page_title %}æ¸¬è©¦é›†ç®¡ç†{% endblock %}

{% block page_content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">è©•ä¼°æ¸¬è©¦é›†ç®¡ç†</h1>
            <p class="text-gray-600 mt-2">å»ºç«‹ã€ç®¡ç†å’Œç¶­è­·ç”¨æ–¼ RAG ç³»çµ±è©•ä¼°çš„æ¸¬è©¦é›†</p>
        </div>
        <button onclick="showCreateModal()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
            â• å»ºç«‹æ–°æ¸¬è©¦é›†
        </button>
    </div>

    <!-- Filters -->
    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex gap-4 items-center">
        <label class="flex items-center gap-2">
            <span class="text-gray-700">åˆ†é¡ï¼š</span>
            <select id="categoryFilter" onchange="loadTestSets()" class="px-3 py-2 border border-gray-300 rounded-lg">
                <option value="">å…¨éƒ¨</option>
                <option value="general">ä¸€èˆ¬è«®è©¢</option>
                <option value="career">è·æ¶¯è¦åŠƒ</option>
                <option value="interview">é¢è©¦æº–å‚™</option>
                <option value="resume">å±¥æ­·å„ªåŒ–</option>
            </select>
        </label>
        <label class="flex items-center gap-2">
            <span class="text-gray-700">ç‹€æ…‹ï¼š</span>
            <select id="statusFilter" onchange="loadTestSets()" class="px-3 py-2 border border-gray-300 rounded-lg">
                <option value="">å…¨éƒ¨</option>
                <option value="true">å•Ÿç”¨</option>
                <option value="false">åœç”¨</option>
            </select>
        </label>
    </div>

    <!-- Test Sets List -->
    <div id="testsetsList" class="grid grid-cols-1 gap-4">
        <!-- Will be populated by JavaScript -->
    </div>
</div>

<!-- Create/Edit Modal -->
<div id="testsetModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 id="modalTitle" class="text-2xl font-bold text-gray-900">å»ºç«‹æ¸¬è©¦é›†</h2>
            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
        </div>

        <div class="space-y-4">
            <!-- Basic Info -->
            <div>
                <label class="block text-gray-700 font-medium mb-2">æ¸¬è©¦é›†åç¨± *</label>
                <input type="text" id="testsetName" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="ä¾‹å¦‚ï¼šè·æ¶¯è«®è©¢æ¨™æº–æ¸¬è©¦é›†">
            </div>

            <div>
                <label class="block text-gray-700 font-medium mb-2">æè¿°</label>
                <textarea id="testsetDescription" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="æ¸¬è©¦é›†çš„ç”¨é€”å’Œèªªæ˜..."></textarea>
            </div>

            <div>
                <label class="block text-gray-700 font-medium mb-2">åˆ†é¡</label>
                <select id="testsetCategory" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    <option value="">è«‹é¸æ“‡åˆ†é¡</option>
                    <option value="general">ä¸€èˆ¬è«®è©¢</option>
                    <option value="career">è·æ¶¯è¦åŠƒ</option>
                    <option value="interview">é¢è©¦æº–å‚™</option>
                    <option value="resume">å±¥æ­·å„ªåŒ–</option>
                </select>
            </div>

            <!-- Test Cases -->
            <div>
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-gray-700 font-medium">æ¸¬è©¦æ¡ˆä¾‹ *</label>
                    <button onclick="addTestCase()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                        â• æ–°å¢æ¡ˆä¾‹
                    </button>
                </div>
                <div id="testCasesList" class="space-y-4">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Actions -->
            <div class="flex justify-end gap-3 pt-4 border-t">
                <button onclick="closeModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                    å–æ¶ˆ
                </button>
                <button onclick="saveTestSet()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    å„²å­˜
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Details Modal -->
<div id="viewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 id="viewModalTitle" class="text-2xl font-bold text-gray-900"></h2>
            <button onclick="closeViewModal()" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
        </div>
        <div id="viewModalContent" class="space-y-4">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>
</div>

<script>
let currentTestSets = [];
let editingTestSetId = null;
let testCaseCounter = 0;

// Load test sets on page load
document.addEventListener('DOMContentLoaded', () => {
    loadTestSets();
});

async function loadTestSets() {
    const category = document.getElementById('categoryFilter').value;
    const isActive = document.getElementById('statusFilter').value;

    let url = '/api/rag/evaluation/testsets/?';
    if (category) url += `category=${category}&`;
    if (isActive) url += `is_active=${isActive}&`;

    const response = await fetch(url);
    currentTestSets = await response.json();

    renderTestSets();
}

function renderTestSets() {
    const container = document.getElementById('testsetsList');

    if (currentTestSets.length === 0) {
        container.innerHTML = `
            <div class="bg-white p-12 rounded-lg shadow-sm border border-gray-200 text-center">
                <p class="text-gray-500 text-lg">å°šç„¡æ¸¬è©¦é›†ï¼Œè«‹å»ºç«‹ç¬¬ä¸€å€‹æ¸¬è©¦é›†</p>
            </div>
        `;
        return;
    }

    container.innerHTML = currentTestSets.map(testset => `
        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition">
            <div class="flex justify-between items-start mb-4">
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                        <h3 class="text-xl font-semibold text-gray-900">${testset.name}</h3>
                        ${testset.is_active
                            ? '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">å•Ÿç”¨</span>'
                            : '<span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">åœç”¨</span>'
                        }
                        ${testset.category
                            ? `<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">${getCategoryName(testset.category)}</span>`
                            : ''
                        }
                    </div>
                    ${testset.description
                        ? `<p class="text-gray-600 mb-3">${testset.description}</p>`
                        : ''
                    }
                    <div class="flex gap-4 text-sm text-gray-500">
                        <span>ğŸ“ ${testset.total_cases} å€‹æ¸¬è©¦æ¡ˆä¾‹</span>
                        <span>ğŸ•’ ${new Date(testset.created_at).toLocaleDateString('zh-TW')}</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="viewTestSet('${testset.id}')" class="px-3 py-1 text-blue-600 hover:bg-blue-50 rounded" title="æª¢è¦–">
                        ğŸ‘ï¸
                    </button>
                    <button onclick="editTestSet('${testset.id}')" class="px-3 py-1 text-gray-600 hover:bg-gray-100 rounded" title="ç·¨è¼¯">
                        âœï¸
                    </button>
                    <button onclick="duplicateTestSet('${testset.id}')" class="px-3 py-1 text-green-600 hover:bg-green-50 rounded" title="è¤‡è£½">
                        ğŸ“‹
                    </button>
                    <button onclick="toggleTestSet('${testset.id}')" class="px-3 py-1 text-yellow-600 hover:bg-yellow-50 rounded" title="${testset.is_active ? 'åœç”¨' : 'å•Ÿç”¨'}">
                        ${testset.is_active ? 'â¸ï¸' : 'â–¶ï¸'}
                    </button>
                    <button onclick="deleteTestSet('${testset.id}')" class="px-3 py-1 text-red-600 hover:bg-red-50 rounded" title="åˆªé™¤">
                        ğŸ—‘ï¸
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

function getCategoryName(category) {
    const names = {
        'general': 'ä¸€èˆ¬è«®è©¢',
        'career': 'è·æ¶¯è¦åŠƒ',
        'interview': 'é¢è©¦æº–å‚™',
        'resume': 'å±¥æ­·å„ªåŒ–'
    };
    return names[category] || category;
}

function showCreateModal() {
    editingTestSetId = null;
    document.getElementById('modalTitle').textContent = 'å»ºç«‹æ¸¬è©¦é›†';
    document.getElementById('testsetName').value = '';
    document.getElementById('testsetDescription').value = '';
    document.getElementById('testsetCategory').value = '';
    document.getElementById('testCasesList').innerHTML = '';
    testCaseCounter = 0;
    addTestCase(); // Add one empty test case
    document.getElementById('testsetModal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('testsetModal').classList.add('hidden');
}

function addTestCase() {
    const id = testCaseCounter++;
    const container = document.getElementById('testCasesList');
    const div = document.createElement('div');
    div.id = `testCase${id}`;
    div.className = 'border border-gray-300 rounded-lg p-4 space-y-3 bg-gray-50';
    div.innerHTML = `
        <div class="flex justify-between items-center mb-2">
            <span class="font-medium text-gray-700">æ¡ˆä¾‹ ${id + 1}</span>
            <button onclick="removeTestCase(${id})" class="text-red-600 hover:text-red-800">ğŸ—‘ï¸</button>
        </div>
        <div>
            <label class="block text-sm text-gray-600 mb-1">å•é¡Œ *</label>
            <textarea id="question${id}" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded text-sm" placeholder="ä¾‹å¦‚ï¼šå¦‚ä½•æº–å‚™è»Ÿé«”å·¥ç¨‹å¸«é¢è©¦ï¼Ÿ"></textarea>
        </div>
        <div>
            <label class="block text-sm text-gray-600 mb-1">æ¨™æº–ç­”æ¡ˆ (Ground Truth)</label>
            <textarea id="groundTruth${id}" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded text-sm" placeholder="å¯é¸ï¼Œç”¨æ–¼è¨ˆç®— Context Recall"></textarea>
        </div>
        <div>
            <label class="block text-sm text-gray-600 mb-1">é æœŸä¸Šä¸‹æ–‡ (Contexts)</label>
            <textarea id="contexts${id}" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded text-sm" placeholder="å¯é¸ï¼Œæ¯è¡Œä¸€å€‹ contextï¼Œç”¨æ–¼æ¸¬è©¦æª¢ç´¢çµæœ"></textarea>
        </div>
    `;
    container.appendChild(div);
}

function removeTestCase(id) {
    document.getElementById(`testCase${id}`).remove();
}

function collectTestCases() {
    const testCases = [];
    for (let i = 0; i < testCaseCounter; i++) {
        const questionEl = document.getElementById(`question${i}`);
        if (!questionEl) continue; // Removed

        const question = questionEl.value.trim();
        if (!question) continue;

        const groundTruth = document.getElementById(`groundTruth${i}`).value.trim() || null;
        const contextsText = document.getElementById(`contexts${i}`).value.trim();
        const contexts = contextsText ? contextsText.split('\n').filter(c => c.trim()) : null;

        testCases.push({
            question,
            ground_truth: groundTruth,
            contexts: contexts
        });
    }
    return testCases;
}

async function saveTestSet() {
    const name = document.getElementById('testsetName').value.trim();
    const description = document.getElementById('testsetDescription').value.trim() || null;
    const category = document.getElementById('testsetCategory').value || null;
    const testCases = collectTestCases();

    if (!name) {
        alert('è«‹è¼¸å…¥æ¸¬è©¦é›†åç¨±');
        return;
    }

    if (testCases.length === 0) {
        alert('è«‹è‡³å°‘æ–°å¢ä¸€å€‹æ¸¬è©¦æ¡ˆä¾‹');
        return;
    }

    const data = { name, description, category, test_cases: testCases };

    try {
        let response;
        if (editingTestSetId) {
            response = await fetch(`/api/rag/evaluation/testsets/${editingTestSetId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
        } else {
            response = await fetch('/api/rag/evaluation/testsets/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
        }

        if (!response.ok) {
            const error = await response.json();
            alert(`å„²å­˜å¤±æ•—: ${error.detail}`);
            return;
        }

        closeModal();
        loadTestSets();
    } catch (error) {
        alert(`å„²å­˜å¤±æ•—: ${error.message}`);
    }
}

async function viewTestSet(testsetId) {
    const response = await fetch(`/api/rag/evaluation/testsets/${testsetId}`);
    const testset = await response.json();

    document.getElementById('viewModalTitle').textContent = testset.name;

    const content = `
        <div class="space-y-4">
            ${testset.description ? `
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">æè¿°</h3>
                    <p class="text-gray-600">${testset.description}</p>
                </div>
            ` : ''}

            <div>
                <h3 class="font-semibold text-gray-700 mb-2">åŸºæœ¬è³‡è¨Š</h3>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div><span class="text-gray-600">åˆ†é¡ï¼š</span>${testset.category ? getCategoryName(testset.category) : 'ç„¡'}</div>
                    <div><span class="text-gray-600">ç‹€æ…‹ï¼š</span>${testset.is_active ? 'âœ… å•Ÿç”¨' : 'â¸ï¸ åœç”¨'}</div>
                    <div><span class="text-gray-600">æ¸¬è©¦æ¡ˆä¾‹æ•¸ï¼š</span>${testset.total_cases}</div>
                    <div><span class="text-gray-600">å»ºç«‹æ™‚é–“ï¼š</span>${new Date(testset.created_at).toLocaleString('zh-TW')}</div>
                </div>
            </div>

            <div>
                <h3 class="font-semibold text-gray-700 mb-3">æ¸¬è©¦æ¡ˆä¾‹</h3>
                <div class="space-y-3">
                    ${testset.test_cases.map((tc, idx) => `
                        <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                            <div class="font-medium text-gray-800 mb-2">æ¡ˆä¾‹ ${idx + 1}</div>
                            <div class="space-y-2 text-sm">
                                <div>
                                    <span class="text-gray-600 font-medium">å•é¡Œï¼š</span>
                                    <p class="text-gray-800 mt-1">${tc.question}</p>
                                </div>
                                ${tc.ground_truth ? `
                                    <div>
                                        <span class="text-gray-600 font-medium">æ¨™æº–ç­”æ¡ˆï¼š</span>
                                        <p class="text-gray-800 mt-1">${tc.ground_truth}</p>
                                    </div>
                                ` : ''}
                                ${tc.contexts && tc.contexts.length > 0 ? `
                                    <div>
                                        <span class="text-gray-600 font-medium">é æœŸä¸Šä¸‹æ–‡ (${tc.contexts.length})ï¼š</span>
                                        <ul class="list-disc list-inside text-gray-800 mt-1">
                                            ${tc.contexts.map(c => `<li>${c}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;

    document.getElementById('viewModalContent').innerHTML = content;
    document.getElementById('viewModal').classList.remove('hidden');
}

function closeViewModal() {
    document.getElementById('viewModal').classList.add('hidden');
}

async function editTestSet(testsetId) {
    const response = await fetch(`/api/rag/evaluation/testsets/${testsetId}`);
    const testset = await response.json();

    editingTestSetId = testsetId;
    document.getElementById('modalTitle').textContent = 'ç·¨è¼¯æ¸¬è©¦é›†';
    document.getElementById('testsetName').value = testset.name;
    document.getElementById('testsetDescription').value = testset.description || '';
    document.getElementById('testsetCategory').value = testset.category || '';

    document.getElementById('testCasesList').innerHTML = '';
    testCaseCounter = 0;

    testset.test_cases.forEach(tc => {
        addTestCase();
        const id = testCaseCounter - 1;
        document.getElementById(`question${id}`).value = tc.question;
        document.getElementById(`groundTruth${id}`).value = tc.ground_truth || '';
        document.getElementById(`contexts${id}`).value = tc.contexts ? tc.contexts.join('\n') : '';
    });

    document.getElementById('testsetModal').classList.remove('hidden');
}

async function duplicateTestSet(testsetId) {
    if (!confirm('ç¢ºå®šè¦è¤‡è£½æ­¤æ¸¬è©¦é›†ï¼Ÿ')) return;

    const response = await fetch(`/api/rag/evaluation/testsets/${testsetId}/duplicate`, {
        method: 'POST'
    });

    if (response.ok) {
        loadTestSets();
    } else {
        alert('è¤‡è£½å¤±æ•—');
    }
}

async function toggleTestSet(testsetId) {
    const response = await fetch(`/api/rag/evaluation/testsets/${testsetId}/toggle`, {
        method: 'POST'
    });

    if (response.ok) {
        loadTestSets();
    } else {
        alert('åˆ‡æ›ç‹€æ…‹å¤±æ•—');
    }
}

async function deleteTestSet(testsetId) {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ¸¬è©¦é›†ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;

    const response = await fetch(`/api/rag/evaluation/testsets/${testsetId}`, {
        method: 'DELETE'
    });

    if (response.ok) {
        loadTestSets();
    } else {
        alert('åˆªé™¤å¤±æ•—');
    }
}
</script>
{% endblock %}
