{% extends "rag/base_sidebar.html" %}

{% block page_title %}測試集管理{% endblock %}

{% block page_content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">評估測試集管理</h1>
            <p class="text-gray-600 mt-2">建立、管理和維護用於 RAG 系統評估的測試集</p>
        </div>
        <button onclick="showCreateModal()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
            ➕ 建立新測試集
        </button>
    </div>

    <!-- Filters -->
    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex gap-4 items-center">
        <label class="flex items-center gap-2">
            <span class="text-gray-700">分類：</span>
            <select id="categoryFilter" onchange="loadTestSets()" class="px-3 py-2 border border-gray-300 rounded-lg">
                <option value="">全部</option>
                <option value="general">一般諮詢</option>
                <option value="career">職涯規劃</option>
                <option value="interview">面試準備</option>
                <option value="resume">履歷優化</option>
            </select>
        </label>
        <label class="flex items-center gap-2">
            <span class="text-gray-700">狀態：</span>
            <select id="statusFilter" onchange="loadTestSets()" class="px-3 py-2 border border-gray-300 rounded-lg">
                <option value="">全部</option>
                <option value="true">啟用</option>
                <option value="false">停用</option>
            </select>
        </label>
    </div>

    <!-- Test Sets List -->
    <div id="testsetsList" class="grid grid-cols-1 gap-4">
        <!-- Will be populated by JavaScript -->
    </div>
</div>

<!-- Create/Edit Modal -->
<div id="testsetModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 id="modalTitle" class="text-2xl font-bold text-gray-900">建立測試集</h2>
            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">✕</button>
        </div>

        <div class="space-y-4">
            <!-- Basic Info -->
            <div>
                <label class="block text-gray-700 font-medium mb-2">測試集名稱 *</label>
                <input type="text" id="testsetName" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="例如：職涯諮詢標準測試集">
            </div>

            <div>
                <label class="block text-gray-700 font-medium mb-2">描述</label>
                <textarea id="testsetDescription" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="測試集的用途和說明..."></textarea>
            </div>

            <div>
                <label class="block text-gray-700 font-medium mb-2">分類</label>
                <select id="testsetCategory" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    <option value="">請選擇分類</option>
                    <option value="general">一般諮詢</option>
                    <option value="career">職涯規劃</option>
                    <option value="interview">面試準備</option>
                    <option value="resume">履歷優化</option>
                </select>
            </div>

            <!-- Test Cases -->
            <div>
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-gray-700 font-medium">測試案例 *</label>
                    <button onclick="addTestCase()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                        ➕ 新增案例
                    </button>
                </div>
                <div id="testCasesList" class="space-y-4">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Actions -->
            <div class="flex justify-end gap-3 pt-4 border-t">
                <button onclick="closeModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                    取消
                </button>
                <button onclick="saveTestSet()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    儲存
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Details Modal -->
<div id="viewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 id="viewModalTitle" class="text-2xl font-bold text-gray-900"></h2>
            <button onclick="closeViewModal()" class="text-gray-500 hover:text-gray-700 text-2xl">✕</button>
        </div>
        <div id="viewModalContent" class="space-y-4">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>
</div>

<script>
let currentTestSets = [];
let editingTestSetId = null;
let testCaseCounter = 0;

// Load test sets on page load
document.addEventListener('DOMContentLoaded', () => {
    loadTestSets();
});

async function loadTestSets() {
    const category = document.getElementById('categoryFilter').value;
    const isActive = document.getElementById('statusFilter').value;

    let url = '/api/rag/evaluation/testsets/?';
    if (category) url += `category=${category}&`;
    if (isActive) url += `is_active=${isActive}&`;

    const response = await fetch(url);
    currentTestSets = await response.json();

    renderTestSets();
}

function renderTestSets() {
    const container = document.getElementById('testsetsList');

    if (currentTestSets.length === 0) {
        container.innerHTML = `
            <div class="bg-white p-12 rounded-lg shadow-sm border border-gray-200 text-center">
                <p class="text-gray-500 text-lg">尚無測試集，請建立第一個測試集</p>
            </div>
        `;
        return;
    }

    container.innerHTML = currentTestSets.map(testset => `
        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition">
            <div class="flex justify-between items-start mb-4">
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                        <h3 class="text-xl font-semibold text-gray-900">${testset.name}</h3>
                        ${testset.is_active
                            ? '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">啟用</span>'
                            : '<span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">停用</span>'
                        }
                        ${testset.category
                            ? `<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">${getCategoryName(testset.category)}</span>`
                            : ''
                        }
                    </div>
                    ${testset.description
                        ? `<p class="text-gray-600 mb-3">${testset.description}</p>`
                        : ''
                    }
                    <div class="flex gap-4 text-sm text-gray-500">
                        <span>📝 ${testset.total_cases} 個測試案例</span>
                        <span>🕒 ${new Date(testset.created_at).toLocaleDateString('zh-TW')}</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="viewTestSet('${testset.id}')" class="px-3 py-1 text-blue-600 hover:bg-blue-50 rounded" title="檢視">
                        👁️
                    </button>
                    <button onclick="editTestSet('${testset.id}')" class="px-3 py-1 text-gray-600 hover:bg-gray-100 rounded" title="編輯">
                        ✏️
                    </button>
                    <button onclick="duplicateTestSet('${testset.id}')" class="px-3 py-1 text-green-600 hover:bg-green-50 rounded" title="複製">
                        📋
                    </button>
                    <button onclick="toggleTestSet('${testset.id}')" class="px-3 py-1 text-yellow-600 hover:bg-yellow-50 rounded" title="${testset.is_active ? '停用' : '啟用'}">
                        ${testset.is_active ? '⏸️' : '▶️'}
                    </button>
                    <button onclick="deleteTestSet('${testset.id}')" class="px-3 py-1 text-red-600 hover:bg-red-50 rounded" title="刪除">
                        🗑️
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

function getCategoryName(category) {
    const names = {
        'general': '一般諮詢',
        'career': '職涯規劃',
        'interview': '面試準備',
        'resume': '履歷優化'
    };
    return names[category] || category;
}

function showCreateModal() {
    editingTestSetId = null;
    document.getElementById('modalTitle').textContent = '建立測試集';
    document.getElementById('testsetName').value = '';
    document.getElementById('testsetDescription').value = '';
    document.getElementById('testsetCategory').value = '';
    document.getElementById('testCasesList').innerHTML = '';
    testCaseCounter = 0;
    addTestCase(); // Add one empty test case
    document.getElementById('testsetModal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('testsetModal').classList.add('hidden');
}

function addTestCase() {
    const id = testCaseCounter++;
    const container = document.getElementById('testCasesList');
    const div = document.createElement('div');
    div.id = `testCase${id}`;
    div.className = 'border border-gray-300 rounded-lg p-4 space-y-3 bg-gray-50';
    div.innerHTML = `
        <div class="flex justify-between items-center mb-2">
            <span class="font-medium text-gray-700">案例 ${id + 1}</span>
            <button onclick="removeTestCase(${id})" class="text-red-600 hover:text-red-800">🗑️</button>
        </div>
        <div>
            <label class="block text-sm text-gray-600 mb-1">問題 *</label>
            <textarea id="question${id}" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded text-sm" placeholder="例如：如何準備軟體工程師面試？"></textarea>
        </div>
        <div>
            <label class="block text-sm text-gray-600 mb-1">標準答案 (Ground Truth)</label>
            <textarea id="groundTruth${id}" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded text-sm" placeholder="可選，用於計算 Context Recall"></textarea>
        </div>
        <div>
            <label class="block text-sm text-gray-600 mb-1">預期上下文 (Contexts)</label>
            <textarea id="contexts${id}" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded text-sm" placeholder="可選，每行一個 context，用於測試檢索結果"></textarea>
        </div>
    `;
    container.appendChild(div);
}

function removeTestCase(id) {
    document.getElementById(`testCase${id}`).remove();
}

function collectTestCases() {
    const testCases = [];
    for (let i = 0; i < testCaseCounter; i++) {
        const questionEl = document.getElementById(`question${i}`);
        if (!questionEl) continue; // Removed

        const question = questionEl.value.trim();
        if (!question) continue;

        const groundTruth = document.getElementById(`groundTruth${i}`).value.trim() || null;
        const contextsText = document.getElementById(`contexts${i}`).value.trim();
        const contexts = contextsText ? contextsText.split('\n').filter(c => c.trim()) : null;

        testCases.push({
            question,
            ground_truth: groundTruth,
            contexts: contexts
        });
    }
    return testCases;
}

async function saveTestSet() {
    const name = document.getElementById('testsetName').value.trim();
    const description = document.getElementById('testsetDescription').value.trim() || null;
    const category = document.getElementById('testsetCategory').value || null;
    const testCases = collectTestCases();

    if (!name) {
        alert('請輸入測試集名稱');
        return;
    }

    if (testCases.length === 0) {
        alert('請至少新增一個測試案例');
        return;
    }

    const data = { name, description, category, test_cases: testCases };

    try {
        let response;
        if (editingTestSetId) {
            response = await fetch(`/api/rag/evaluation/testsets/${editingTestSetId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
        } else {
            response = await fetch('/api/rag/evaluation/testsets/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
        }

        if (!response.ok) {
            const error = await response.json();
            alert(`儲存失敗: ${error.detail}`);
            return;
        }

        closeModal();
        loadTestSets();
    } catch (error) {
        alert(`儲存失敗: ${error.message}`);
    }
}

async function viewTestSet(testsetId) {
    const response = await fetch(`/api/rag/evaluation/testsets/${testsetId}`);
    const testset = await response.json();

    document.getElementById('viewModalTitle').textContent = testset.name;

    const content = `
        <div class="space-y-4">
            ${testset.description ? `
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">描述</h3>
                    <p class="text-gray-600">${testset.description}</p>
                </div>
            ` : ''}

            <div>
                <h3 class="font-semibold text-gray-700 mb-2">基本資訊</h3>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div><span class="text-gray-600">分類：</span>${testset.category ? getCategoryName(testset.category) : '無'}</div>
                    <div><span class="text-gray-600">狀態：</span>${testset.is_active ? '✅ 啟用' : '⏸️ 停用'}</div>
                    <div><span class="text-gray-600">測試案例數：</span>${testset.total_cases}</div>
                    <div><span class="text-gray-600">建立時間：</span>${new Date(testset.created_at).toLocaleString('zh-TW')}</div>
                </div>
            </div>

            <div>
                <h3 class="font-semibold text-gray-700 mb-3">測試案例</h3>
                <div class="space-y-3">
                    ${testset.test_cases.map((tc, idx) => `
                        <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                            <div class="font-medium text-gray-800 mb-2">案例 ${idx + 1}</div>
                            <div class="space-y-2 text-sm">
                                <div>
                                    <span class="text-gray-600 font-medium">問題：</span>
                                    <p class="text-gray-800 mt-1">${tc.question}</p>
                                </div>
                                ${tc.ground_truth ? `
                                    <div>
                                        <span class="text-gray-600 font-medium">標準答案：</span>
                                        <p class="text-gray-800 mt-1">${tc.ground_truth}</p>
                                    </div>
                                ` : ''}
                                ${tc.contexts && tc.contexts.length > 0 ? `
                                    <div>
                                        <span class="text-gray-600 font-medium">預期上下文 (${tc.contexts.length})：</span>
                                        <ul class="list-disc list-inside text-gray-800 mt-1">
                                            ${tc.contexts.map(c => `<li>${c}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;

    document.getElementById('viewModalContent').innerHTML = content;
    document.getElementById('viewModal').classList.remove('hidden');
}

function closeViewModal() {
    document.getElementById('viewModal').classList.add('hidden');
}

async function editTestSet(testsetId) {
    const response = await fetch(`/api/rag/evaluation/testsets/${testsetId}`);
    const testset = await response.json();

    editingTestSetId = testsetId;
    document.getElementById('modalTitle').textContent = '編輯測試集';
    document.getElementById('testsetName').value = testset.name;
    document.getElementById('testsetDescription').value = testset.description || '';
    document.getElementById('testsetCategory').value = testset.category || '';

    document.getElementById('testCasesList').innerHTML = '';
    testCaseCounter = 0;

    testset.test_cases.forEach(tc => {
        addTestCase();
        const id = testCaseCounter - 1;
        document.getElementById(`question${id}`).value = tc.question;
        document.getElementById(`groundTruth${id}`).value = tc.ground_truth || '';
        document.getElementById(`contexts${id}`).value = tc.contexts ? tc.contexts.join('\n') : '';
    });

    document.getElementById('testsetModal').classList.remove('hidden');
}

async function duplicateTestSet(testsetId) {
    if (!confirm('確定要複製此測試集？')) return;

    const response = await fetch(`/api/rag/evaluation/testsets/${testsetId}/duplicate`, {
        method: 'POST'
    });

    if (response.ok) {
        loadTestSets();
    } else {
        alert('複製失敗');
    }
}

async function toggleTestSet(testsetId) {
    const response = await fetch(`/api/rag/evaluation/testsets/${testsetId}/toggle`, {
        method: 'POST'
    });

    if (response.ok) {
        loadTestSets();
    } else {
        alert('切換狀態失敗');
    }
}

async function deleteTestSet(testsetId) {
    if (!confirm('確定要刪除此測試集？此操作無法復原。')) return;

    const response = await fetch(`/api/rag/evaluation/testsets/${testsetId}`, {
        method: 'DELETE'
    });

    if (response.ok) {
        loadTestSets();
    } else {
        alert('刪除失敗');
    }
}
</script>
{% endblock %}
