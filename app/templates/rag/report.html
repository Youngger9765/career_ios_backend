{% extends "rag/base_sidebar.html" %}

{% block page_title %}å€‹æ¡ˆå ±å‘Šç”Ÿæˆ{% endblock %}

{% block page_content %}
<div class="mb-6">
    <h2 class="text-2xl font-bold text-white mb-2">å€‹æ¡ˆå ±å‘Šç”Ÿæˆ</h2>
    <p class="text-gray-400">æ ¹æ“šå°è©±è¨˜éŒ„èˆ‡åƒè€ƒè³‡æ–™ï¼Œè‡ªå‹•ç”Ÿæˆè·æ¶¯è«®è©¢å ±å‘Š</p>
</div>

<!-- Report Form -->
<div class="bg-gray-800 rounded-lg p-6 mb-6">
    <h3 class="text-xl font-semibold text-white mb-4">é€å­—ç¨¿è¼¸å…¥</h3>

    <div class="space-y-4">
        <div>
            <div class="flex justify-between items-center mb-2">
                <label class="block text-gray-300 text-sm">æ™¤è«‡é€å­—ç¨¿</label>
                <button
                    onclick="loadSampleTranscript()"
                    class="text-blue-400 hover:text-blue-300 text-xs underline"
                >
                    ğŸ“ è¼‰å…¥ç¯„ä¾‹é€å­—ç¨¿
                </button>
            </div>
            <textarea
                id="transcript"
                rows="12"
                placeholder="è²¼ä¸Šæ™¤è«‡é€å­—ç¨¿å…§å®¹ï¼ŒAI æœƒè‡ªå‹•åˆ†æä¸¦ç”Ÿæˆå€‹æ¡ˆå ±å‘Š..."
                class="w-full bg-gray-700 text-white rounded-lg px-4 py-2 border border-gray-600 font-mono text-sm"
            ></textarea>
            <p class="text-gray-400 text-xs mt-2">ğŸ’¡ æ”¯æ´ä»»ä½•æ ¼å¼çš„å°è©±è¨˜éŒ„ï¼ŒAI æœƒè‡ªå‹•è­˜åˆ¥èªªè©±è€…èˆ‡é—œéµè³‡è¨Š</p>
        </div>

        <div class="grid grid-cols-4 gap-4">
            <div>
                <label class="block text-gray-300 text-sm mb-2">åƒèˆ‡äººæ•¸</label>
                <select id="numParticipants" class="w-full bg-gray-700 text-white rounded-lg px-4 py-2 border border-gray-600">
                    <option value="2">2äººï¼ˆè«®è©¢å¸« + å€‹æ¡ˆï¼‰</option>
                    <option value="3">3äºº</option>
                    <option value="4">4äºº</option>
                    <option value="5">5äºº</option>
                </select>
            </div>

            <div>
                <label class="block text-gray-300 text-sm mb-2">LLM æ¨¡å‹</label>
                <select id="ragSystem" class="w-full bg-gray-700 text-white rounded-lg px-4 py-2 border border-gray-600">
                    <option value="openai">ğŸ¤– OpenAI GPT-4.1 Mini</option>
                    <option value="gemini">ğŸ”· Gemini 2.5 Flash</option>
                </select>
            </div>

            <div>
                <label class="block text-gray-300 text-sm mb-2">æª¢ç´¢æ•¸é‡ (TOP K)</label>
                <select id="topK" class="w-full bg-gray-700 text-white rounded-lg px-4 py-2 border border-gray-600">
                    <option value="3">3 å€‹ï¼ˆç²¾æº–ï¼‰</option>
                    <option value="5">5 å€‹</option>
                    <option value="7" selected>7 å€‹ï¼ˆå»ºè­°ï¼‰</option>
                    <option value="10">10 å€‹ï¼ˆå…¨é¢ï¼‰</option>
                    <option value="15">15 å€‹ï¼ˆæœ€å¤§ï¼‰</option>
                </select>
            </div>

            <div>
                <label class="block text-gray-300 text-sm mb-2">å ±å‘Šç‰ˆæœ¬</label>
                <select id="reportVersion" class="w-full bg-gray-700 text-white rounded-lg px-4 py-2 border border-gray-600">
                    <option value="enhanced">âœ¨ å¢å¼·ç‰ˆï¼ˆ10æ®µå¼+å“è³ªé©—è­‰ï¼‰</option>
                    <option value="legacy">ğŸ“„ èˆŠç‰ˆï¼ˆ5æ®µå¼ç°¡æ˜“ç‰ˆï¼‰</option>
                </select>
            </div>
        </div>

        <!-- Version Comparison Mode Toggle -->
        <div class="mb-4">
            <label class="flex items-center gap-2 text-gray-300 cursor-pointer">
                <input type="checkbox" id="versionComparisonMode" class="form-checkbox h-4 w-4 text-blue-600">
                <span>ğŸ“Š ç‰ˆæœ¬æ¯”è¼ƒæ¨¡å¼ï¼ˆåŒæ™‚ç”ŸæˆèˆŠç‰ˆ+æ–°ç‰ˆå ±å‘Šä¸¦å°æ¯”ï¼‰</span>
            </label>
        </div>

        <div class="flex gap-3">
            <button
                onclick="generateReport()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition"
            >
                ğŸ¤– AI ç”Ÿæˆå ±å‘Š
            </button>
            <button
                onclick="clearForm()"
                class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-3 rounded-lg transition"
            >
                æ¸…ç©º
            </button>
        </div>
    </div>
</div>

<!-- Progress Section -->
<div id="progressSection" class="hidden bg-gray-800 rounded-lg p-6 mb-6">
    <h3 class="text-xl font-semibold text-white mb-4">ç”Ÿæˆé€²åº¦</h3>
    <div id="progressSteps" class="space-y-3">
        <!-- Progress steps will be dynamically added here -->
    </div>
</div>

<!-- Version Comparison Results Section -->
<div id="versionComparisonSection" class="hidden space-y-6 mb-6">
    <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-2xl font-semibold text-white mb-6">ğŸ“Š èˆŠç‰ˆ vs æ–°ç‰ˆå ±å‘Šå°æ¯”</h3>

        <!-- Tab Navigation for Version Comparison -->
        <div class="flex gap-2 mb-6 border-b border-gray-700">
            <button onclick="switchVersionTab('legacy')" id="ver-tab-legacy" class="px-6 py-3 text-white font-semibold border-b-2 border-blue-500 transition">
                ğŸ“„ èˆŠç‰ˆå ±å‘Š
            </button>
            <button onclick="switchVersionTab('enhanced')" id="ver-tab-enhanced" class="px-6 py-3 text-gray-400 hover:text-white font-semibold border-b-2 border-transparent hover:border-gray-600 transition">
                âœ¨ æ–°ç‰ˆå ±å‘Š
            </button>
            <button onclick="switchVersionTab('aligned')" id="ver-tab-aligned" class="px-6 py-3 text-gray-400 hover:text-white font-semibold border-b-2 border-transparent hover:border-gray-600 transition">
                â†”ï¸ æ®µè½å°é½Š
            </button>
            <button onclick="switchVersionTab('comparison')" id="ver-tab-comparison" class="px-6 py-3 text-gray-400 hover:text-white font-semibold border-b-2 border-transparent hover:border-gray-600 transition">
                ğŸ” æ¯”è¼ƒè¡¨
            </button>
        </div>

        <!-- Tab Content: Legacy Report -->
        <div id="ver-content-legacy" class="ver-tab-content">
            <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-lg p-6 border-2 border-gray-600">
                <div class="flex items-center gap-3 mb-4 pb-3 border-b-2 border-gray-600">
                    <h4 class="text-xl font-bold text-gray-300">ğŸ“„ èˆŠç‰ˆå ±å‘Šï¼ˆ5æ®µå¼ï¼‰</h4>
                </div>
                <div id="legacyReportContent" class="text-white text-sm space-y-4">
                    <!-- Legacy report will be injected here -->
                </div>
            </div>
        </div>

        <!-- Tab Content: Enhanced Report -->
        <div id="ver-content-enhanced" class="ver-tab-content hidden">
            <div class="bg-gradient-to-br from-blue-900/30 to-gray-900 rounded-lg p-6 border-2 border-blue-500/50">
                <div class="flex items-center gap-3 mb-4 pb-3 border-b-2 border-blue-500/50">
                    <h4 class="text-xl font-bold text-blue-400">âœ¨ æ–°ç‰ˆå ±å‘Šï¼ˆ10æ®µå¼+å“è³ªé©—è­‰ï¼‰</h4>
                </div>
                <div id="enhancedReportContent" class="text-white text-sm space-y-4">
                    <!-- Enhanced report will be injected here -->
                </div>
                <div id="qualityScoreDisplay" class="mt-6 pt-4 border-t border-blue-500/30">
                    <!-- Quality score will be shown here -->
                </div>
            </div>
        </div>

        <!-- Tab Content: Aligned Comparison -->
        <div id="ver-content-aligned" class="ver-tab-content hidden">
            <div id="alignedComparisonContent" class="space-y-4">
                <!-- Side-by-side aligned comparison will be injected here -->
            </div>
        </div>

        <!-- Tab Content: Comparison Table -->
        <div id="ver-content-comparison" class="ver-tab-content hidden">
            <div id="comparisonTableContent">
                <!-- Comparison table will be generated here -->
            </div>
        </div>
    </div>
</div>

<!-- Comparison Results Section -->
<div id="comparisonSection" class="hidden space-y-6 mb-6">
    <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-2xl font-semibold text-white mb-6">ğŸ”¬ LLM æ¨¡å‹æ¯”è¼ƒçµæœ</h3>

        <!-- Comparison Metrics Summary -->
        <div id="comparisonMetrics" class="mb-6">
            <!-- Metrics will be injected here -->
        </div>

        <!-- Tab Navigation for Comparison View -->
        <div class="flex gap-2 mb-6 border-b border-gray-700">
            <button onclick="switchComparisonTab('retrieval')" id="comp-tab-retrieval" class="px-6 py-3 text-white font-semibold border-b-2 border-blue-500 transition">
                ğŸ” æª¢ç´¢çµæœæ¯”è¼ƒ
            </button>
            <button onclick="switchComparisonTab('reports')" id="comp-tab-reports" class="px-6 py-3 text-gray-400 hover:text-white font-semibold border-b-2 border-transparent hover:border-gray-600 transition">
                ğŸ“„ å€‹æ¡ˆå ±å‘Šæ¯”è¼ƒ
            </button>
        </div>

        <!-- Tab Content: Retrieval Comparison -->
        <div id="comp-content-retrieval" class="comp-tab-content">
            <div class="grid grid-cols-2 gap-6">
                <!-- Supabase Results -->
                <div class="bg-gray-900 rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-blue-400 mb-4">ğŸ¤– OpenAI Embedding</h4>
                    <div id="supabaseResults" class="space-y-3">
                        <!-- Results will be injected here -->
                    </div>
                </div>

                <!-- Vertex Results -->
                <div class="bg-gray-900 rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-purple-400 mb-4">ğŸ”· Gemini Embedding</h4>
                    <div id="vertexResults" class="space-y-3">
                        <!-- Results will be injected here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Reports Comparison -->
        <div id="comp-content-reports" class="comp-tab-content hidden">
            <div class="grid grid-cols-2 gap-6">
                <!-- OpenAI Report -->
                <div class="bg-gradient-to-br from-blue-900/30 to-gray-900 rounded-lg p-6 border-2 border-blue-500/50">
                    <div class="flex items-center gap-3 mb-4 pb-3 border-b-2 border-blue-500/50">
                        <h4 class="text-xl font-bold text-blue-400">ğŸ¤– OpenAI GPT-4.1 Mini</h4>
                        <span class="text-xs bg-blue-500 text-white px-2 py-1 rounded">ç”Ÿæˆå ±å‘Š</span>
                    </div>
                    <div id="supabaseReport" class="text-white text-sm space-y-4">
                        <!-- Report will be injected here -->
                    </div>
                </div>

                <!-- Gemini Report -->
                <div class="bg-gradient-to-br from-purple-900/30 to-gray-900 rounded-lg p-6 border-2 border-purple-500/50">
                    <div class="flex items-center gap-3 mb-4 pb-3 border-b-2 border-purple-500/50">
                        <h4 class="text-xl font-bold text-purple-400">ğŸ”· Gemini 2.5 Flash</h4>
                        <span class="text-xs bg-purple-500 text-white px-2 py-1 rounded">ç”Ÿæˆå ±å‘Š</span>
                    </div>
                    <div id="vertexReport" class="text-white text-sm space-y-4">
                        <!-- Report will be injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Output - TABLE FORMAT -->
<div id="reportSection" class="hidden space-y-6">
    <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-xl font-semibold text-white mb-4">è·æ¸¸å‰µæ–°è·æ¶¯ç™¼å±•èˆ‡è«®è©¢ - å€‹æ¡ˆå ±å‘Š</h3>

        <!-- Tab Navigation -->
        <div class="flex gap-2 mb-6 border-b border-gray-700">
            <button onclick="switchTab('html')" id="tab-html" class="px-6 py-3 text-white font-semibold border-b-2 border-blue-500 transition">
                HTML è¡¨æ ¼
            </button>
            <button onclick="switchTab('json')" id="tab-json" class="px-6 py-3 text-gray-400 hover:text-white font-semibold border-b-2 border-transparent hover:border-gray-600 transition">
                JSON
            </button>
            <button onclick="switchTab('markdown')" id="tab-markdown" class="px-6 py-3 text-gray-400 hover:text-white font-semibold border-b-2 border-transparent hover:border-gray-600 transition">
                Markdown
            </button>
        </div>

        <!-- Tab Content: HTML -->
        <div id="content-html" class="tab-content">
            <div id="singleReportContent"></div>

        <!-- Header Info Table -->
        <div class="mb-6">
            <table class="w-full border-collapse border border-gray-600">
                <tr class="bg-gray-700">
                    <td class="border border-gray-600 px-4 py-2 text-gray-300 font-semibold w-1/3">è«®è©¢ç·´ç¿’ç”Ÿ</td>
                    <td id="counselor_name_display" class="border border-gray-600 px-4 py-2 text-white">-</td>
                </tr>
                <tr class="bg-gray-700">
                    <td class="border border-gray-600 px-4 py-2 text-gray-300 font-semibold">å®Œæˆæ’°å¯«æ—¥æœŸ</td>
                    <td id="completion_date_display" class="border border-gray-600 px-4 py-2 text-white">-</td>
                </tr>
            </table>
        </div>

        <!-- ä¸€ã€æ¡ˆä¸»åŸºæœ¬è³‡æ–™ -->
        <div class="mb-6">
            <h4 class="text-lg font-semibold text-white mb-3">ä¸€ã€æ¡ˆä¸»åŸºæœ¬è³‡æ–™</h4>
            <table class="w-full border-collapse border border-gray-600">
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold w-1/4">1. å§“å(åŒ–å)</td>
                    <td id="client_name" class="border border-gray-600 px-4 py-2 text-white">-</td>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold w-1/4">2. æ€§åˆ¥</td>
                    <td id="client_gender" class="border border-gray-600 px-4 py-2 text-white">-</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold">3. å¹´ç´€</td>
                    <td id="client_age" class="border border-gray-600 px-4 py-2 text-white">-</td>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold">4. éƒ¨é–€/è·æ¥­(å­¸æ ¡ç§‘ç³»)</td>
                    <td id="client_occupation" class="border border-gray-600 px-4 py-2 text-white">-</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold">5. å­¸æ­·</td>
                    <td id="client_education" class="border border-gray-600 px-4 py-2 text-white">-</td>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold">6. ç¾å±…åœ°</td>
                    <td id="client_location" class="border border-gray-600 px-4 py-2 text-white">-</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold">7. ç¶“æ¿Ÿç‹€æ³</td>
                    <td id="client_economic" colspan="3" class="border border-gray-600 px-4 py-2 text-white">-</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold">8. å®¶åº­é—œä¿‚</td>
                    <td id="client_family" colspan="3" class="border border-gray-600 px-4 py-2 text-white">-</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold">9. å…¶ä»–é‡è¦è³‡è¨Š</td>
                    <td id="client_other" colspan="3" class="border border-gray-600 px-4 py-2 text-white whitespace-pre-wrap">-</td>
                </tr>
            </table>
        </div>

        <!-- äºŒã€æ­·ç¨‹åˆ†æ -->
        <div class="mb-6">
            <h4 class="text-lg font-semibold text-white mb-3">äºŒã€æ­·ç¨‹åˆ†æ</h4>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse border border-gray-600">
                    <thead>
                        <tr class="bg-gray-700">
                            <th class="border border-gray-600 px-4 py-2 text-white">æ¬¡æ•¸/æ™¤è«‡æ™‚é–“</th>
                            <th class="border border-gray-600 px-4 py-2 text-white">æ™¤è«‡å…§å®¹æ¦‚è¿°</th>
                            <th class="border border-gray-600 px-4 py-2 text-white">è«®è©¢å¸«è‡ªè©•</th>
                        </tr>
                    </thead>
                    <tbody id="session_history">
                        <tr>
                            <td colspan="3" class="border border-gray-600 px-4 py-2 text-gray-400 text-center">å°šç„¡è³‡æ–™</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ä¸‰ã€æ¦‚å¿µåŒ–åˆ†æ -->
        <div class="mb-6">
            <h4 class="text-lg font-semibold text-white mb-3">ä¸‰ã€æ¦‚å¿µåŒ–åˆ†æ</h4>
            <table class="w-full border-collapse border border-gray-600">
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold w-1/4">ä¸»è¨´å•é¡Œ</td>
                    <td id="main_issue" class="border border-gray-600 px-4 py-2 text-white whitespace-pre-wrap">-</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold">æˆå› åˆ†æ</td>
                    <td id="cause_analysis" class="border border-gray-600 px-4 py-2 text-white whitespace-pre-wrap">-</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold">æ™¤è«‡ç›®æ¨™</td>
                    <td id="counseling_goal" class="border border-gray-600 px-4 py-2 text-white whitespace-pre-wrap">-</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold">ä»‹å…¥ç­–ç•¥</td>
                    <td id="intervention" class="border border-gray-600 px-4 py-2 text-white whitespace-pre-wrap">-</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold">ç›®å‰æˆæ•ˆè©•ä¼°</td>
                    <td id="effectiveness" class="border border-gray-600 px-4 py-2 text-white whitespace-pre-wrap">-</td>
                </tr>
            </table>
        </div>

        <!-- å››ã€å€‹äººåŒ–åˆ†æ -->
        <div class="mb-6">
            <h4 class="text-lg font-semibold text-white mb-3">å››ã€å€‹äººåŒ–åˆ†æ</h4>
            <table class="w-full border-collapse border border-gray-600">
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold w-1/3">æˆ‘å’Œé€™å€‹äººå·¥ä½œçš„æ„Ÿå—æ˜¯ï¼Ÿ</td>
                    <td id="counselor_feeling" class="border border-gray-600 px-4 py-2 text-white whitespace-pre-wrap">-</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold">é€™å€‹æ„Ÿå—çš„åŸå› æ˜¯ï¼Ÿ</td>
                    <td id="feeling_reason" class="border border-gray-600 px-4 py-2 text-white whitespace-pre-wrap">-</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold">ç›®å‰è·Ÿé€™å€‹äººå·¥ä½œçš„å›°é›£</td>
                    <td id="difficulties" class="border border-gray-600 px-4 py-2 text-white whitespace-pre-wrap">-</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold">æˆ‘æœƒæƒ³æ‰¾ç£å°è¨è«–çš„å•é¡Œæ˜¯ï¼Ÿ</td>
                    <td id="supervision_topic" class="border border-gray-600 px-4 py-2 text-white whitespace-pre-wrap">-</td>
                </tr>
            </table>
        </div>

        <!-- é—œéµå°è©±æ‘˜éŒ„ -->
        <div class="mb-6">
            <h4 class="text-lg font-semibold text-white mb-3">é—œéµå°è©±æ‘˜éŒ„</h4>
            <div id="dialogueExcerpts" class="space-y-3">
                <div class="text-gray-400">å°šç„¡å°è©±æ‘˜éŒ„</div>
            </div>
        </div>

        <!-- åƒè€ƒç†è«–æ–‡ç» -->
        <div>
            <h4 class="text-lg font-semibold text-white mb-3">åƒè€ƒç†è«–æ–‡ç»</h4>
            <div id="theoriesList" class="space-y-3">
                <div class="text-gray-400">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
        </div>

        <!-- Tab Content: JSON -->
        <div id="content-json" class="tab-content hidden">
            <div class="flex justify-end mb-4">
                <button onclick="downloadJSON()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                    ğŸ“¥ ä¸‹è¼‰ JSON
                </button>
            </div>
            <pre id="jsonOutput" class="bg-gray-900 text-green-400 p-6 rounded-lg overflow-auto max-h-[800px] font-mono text-sm"></pre>
        </div>

        <!-- Tab Content: Markdown -->
        <div id="content-markdown" class="tab-content hidden">
            <div class="flex justify-end mb-4">
                <button onclick="downloadMarkdown()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
                    ğŸ“„ ä¸‹è¼‰ Markdown
                </button>
            </div>
            <pre id="markdownOutput" class="bg-gray-900 text-gray-300 p-6 rounded-lg overflow-auto max-h-[800px] font-mono text-sm whitespace-pre-wrap"></pre>
        </div>
    </div>
</div>

<script>
let reportData = null;

async function loadSampleTranscript() {
    try {
        const response = await fetch('/static/sample_transcript.txt');
        const text = await response.text();
        document.getElementById('transcript').value = text;
    } catch (error) {
        console.error('Failed to load sample transcript:', error);
    }
}

async function generateReport() {
    const transcript = document.getElementById('transcript').value.trim();
    const numParticipants = parseInt(document.getElementById('numParticipants').value);
    const ragSystem = document.getElementById('ragSystem').value;
    const topK = parseInt(document.getElementById('topK').value);
    const versionComparisonMode = document.getElementById('versionComparisonMode').checked;

    if (!transcript) {
        alert('è«‹è¼¸å…¥æ™¤è«‡é€å­—ç¨¿');
        return;
    }

    // Reset and show progress
    document.getElementById('progressSection').classList.remove('hidden');
    document.getElementById('reportSection').classList.add('hidden');
    document.getElementById('comparisonSection').classList.add('hidden');
    document.getElementById('versionComparisonSection').classList.add('hidden');
    document.getElementById('progressSteps').innerHTML = '';

    if (versionComparisonMode) {
        await runVersionComparison(transcript, numParticipants, ragSystem, topK);
    } else {
        await runSingleReport(transcript, numParticipants, ragSystem, topK);
    }
}

async function runSingleReport(transcript, numParticipants, ragSystem, topK) {
    try {
        document.getElementById('progressSteps').innerHTML = '<div class="text-blue-400">â³ æ­£åœ¨ç”Ÿæˆå ±å‘Šï¼Œè«‹ç¨å€™...</div>';

        const reportVersion = document.getElementById('reportVersion').value;
        const useLegacy = (reportVersion === 'legacy');

        const response = await fetch('/api/report/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                transcript: transcript,
                num_participants: numParticipants,
                rag_system: ragSystem,
                top_k: topK,
                use_legacy: useLegacy
            })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'å ±å‘Šç”Ÿæˆå¤±æ•—');
        }

        const result = await response.json();

        document.getElementById('progressSteps').innerHTML = '<div class="text-green-400">âœ… å ±å‘Šç”Ÿæˆå®Œæˆï¼</div>';

        // Display report using the same format as comparison mode
        reportData = result.report;
        const reportHTML = formatReportContent(reportData);
        document.getElementById('singleReportContent').innerHTML = reportHTML;
        document.getElementById('reportSection').classList.remove('hidden');

    } catch (error) {
        console.error('Report generation error:', error);
        document.getElementById('progressSteps').innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded p-4 mt-4">
                <p class="text-red-800 font-semibold">âœ— å ±å‘Šç”Ÿæˆå¤±æ•—</p>
                <p class="text-red-600 text-sm mt-2">${error.message}</p>
                <p class="text-red-500 text-xs mt-2">è«‹æª¢æŸ¥ï¼š<br>
                1. ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸<br>
                2. é€å­—ç¨¿å…§å®¹æ˜¯å¦æœ‰æ•ˆ<br>
                3. API æœå‹™æ˜¯å¦æ­£å¸¸é‹ä½œ</p>
            </div>
        `;
    }
}

async function runComparisonMode(transcript, numParticipants, topK) {
    try {
        const comparisonData = {
            openai: null,
            gemini: null
        };

        // Run OpenAI first
        document.getElementById('progressSteps').innerHTML = '<div class="text-blue-400 font-semibold text-lg">ğŸ”µ æ­£åœ¨é‹è¡Œ OpenAI GPT-4.1 Mini...</div>';
        console.log('Starting OpenAI comparison...');
        comparisonData.openai = await runReportAndCapture(transcript, numParticipants, 'openai', topK);
        console.log('OpenAI completed:', comparisonData.openai);

        // Run Gemini
        document.getElementById('progressSteps').innerHTML += '<div class="text-purple-400 font-semibold text-lg mt-4">ğŸŸ£ æ­£åœ¨é‹è¡Œ Gemini 2.5 Flash...</div>';
        console.log('Starting Gemini comparison...');
        comparisonData.gemini = await runReportAndCapture(transcript, numParticipants, 'gemini', topK);
        console.log('Gemini completed:', comparisonData.gemini);

        // Display comparison
        console.log('Displaying comparison results...');
        displayComparisonResults(comparisonData);

        // Hide progress and show comparison
        document.getElementById('progressSection').classList.add('hidden');
        document.getElementById('reportSection').classList.add('hidden');  // Ensure single report is hidden
        document.getElementById('comparisonSection').classList.remove('hidden');

        // Auto-switch to reports tab
        switchComparisonTab('reports');

        console.log('Comparison mode completed successfully');
    } catch (error) {
        console.error('Comparison mode failed:', error);
        alert('æ¯”è¼ƒæ¨¡å¼åŸ·è¡Œå¤±æ•—: ' + error.message);
        document.getElementById('progressSection').classList.add('hidden');
    }
}

async function runReportAndCapture(transcript, numParticipants, ragSystem, topK) {
    const capturedData = {
        system: ragSystem,
        theories: [],
        report: null,
        processingTime: 0,
        startTime: Date.now()
    };

    const response = await fetch('/api/report/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            transcript: transcript,
            num_participants: numParticipants,
            rag_system: ragSystem,
            top_k: topK
        })
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder();

    while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value);
        const lines = chunk.split('\n\n');

        for (const line of lines) {
            if (line.startsWith('data: ')) {
                const jsonStr = line.substring(6);
                try {
                    const data = JSON.parse(jsonStr);

                    if (data.status === 'error') {
                        throw new Error(data.message);
                    }

                    // Capture theories from step 3
                    if (data.step === 3 && data.status === 'completed' && data.data?.theories) {
                        capturedData.theories = data.data.theories;
                    }

                    // Capture final report from step 5
                    if (data.step === 5 && data.status === 'completed' && data.data?.report) {
                        capturedData.report = data.data.report;
                    }

                    // Complete when done
                    if (data.step === 6 && data.status === 'completed') {
                        capturedData.processingTime = (Date.now() - capturedData.startTime) / 1000;
                        return capturedData;
                    }
                } catch (e) {
                    // Ignore parse errors for incomplete chunks
                    if (data?.status === 'error') throw e;
                }
            }
        }
    }

    return capturedData;
}

function displayComparisonResults(comparisonData) {
    const openaiData = comparisonData.openai;
    const geminiData = comparisonData.gemini;

    // Calculate metrics
    const supabaseAvgScore = openaiData.theories.length > 0
        ? (openaiData.theories.reduce((sum, t) => sum + t.score, 0) / openaiData.theories.length).toFixed(4)
        : 0;
    const geminiAvgScore = geminiData.theories.length > 0
        ? (geminiData.theories.reduce((sum, t) => sum + t.score, 0) / geminiData.theories.length).toFixed(4)
        : 0;

    // Find unique and common theories by document name
    const supabaseDocs = new Set(openaiData.theories.map(t => t.document));
    const geminiDocs = new Set(geminiData.theories.map(t => t.document));
    const commonDocs = [...supabaseDocs].filter(doc => geminiDocs.has(doc));
    const uniqueSupabase = [...supabaseDocs].filter(doc => !geminiDocs.has(doc));
    const uniqueGemini = [...geminiDocs].filter(doc => !supabaseDocs.has(doc));

    // Display summary metrics
    const metricsHTML = `
        <div class="bg-gradient-to-r from-gray-900 to-gray-800 rounded-lg p-6">
            <h4 class="text-xl font-semibold text-white mb-4">ğŸ“Š æ¯”è¼ƒçµ±è¨ˆ</h4>
            <div class="grid grid-cols-5 gap-4 text-center">
                <div>
                    <div class="text-gray-400 text-sm mb-1">å…±åŒæ–‡ç»</div>
                    <div class="text-green-400 text-3xl font-bold">${commonDocs.length}</div>
                    <div class="text-gray-500 text-xs">å…©è€…çš†æ‰¾åˆ°</div>
                </div>
                <div>
                    <div class="text-gray-400 text-sm mb-1">OpenAI ç¨æœ‰</div>
                    <div class="text-blue-400 text-3xl font-bold">${uniqueSupabase.length}</div>
                    <div class="text-gray-500 text-xs">åƒ… OpenAI</div>
                </div>
                <div>
                    <div class="text-gray-400 text-sm mb-1">Gemini ç¨æœ‰</div>
                    <div class="text-purple-400 text-3xl font-bold">${uniqueGemini.length}</div>
                    <div class="text-gray-500 text-xs">åƒ… Gemini</div>
                </div>
                <div>
                    <div class="text-gray-400 text-sm mb-1">OpenAI é€Ÿåº¦</div>
                    <div class="text-blue-400 text-3xl font-bold">${openaiData.processingTime.toFixed(1)}s</div>
                    <div class="text-gray-500 text-xs">è™•ç†æ™‚é–“</div>
                </div>
                <div>
                    <div class="text-gray-400 text-sm mb-1">Gemini é€Ÿåº¦</div>
                    <div class="text-purple-400 text-3xl font-bold">${geminiData.processingTime.toFixed(1)}s</div>
                    <div class="text-gray-500 text-xs">è™•ç†æ™‚é–“</div>
                </div>
            </div>

            <!-- Winner Badge -->
            <div class="mt-6 pt-4 border-t border-gray-700">
                <div class="flex justify-around text-sm">
                    <div class="text-center">
                        <div class="text-gray-400 mb-1">å¹³å‡ç›¸ä¼¼åº¦</div>
                        <div class="flex items-center gap-4">
                            <span class="text-blue-400 font-mono text-lg">${supabaseAvgScore}</span>
                            <span class="text-gray-500">vs</span>
                            <span class="text-purple-400 font-mono text-lg">${geminiAvgScore}</span>
                        </div>
                    </div>
                    <div class="text-center">
                        <div class="text-gray-400 mb-1">æª¢ç´¢åˆ°ç†è«–æ•¸</div>
                        <div class="flex items-center gap-4">
                            <span class="text-blue-400 font-mono text-lg">${openaiData.theories.length}</span>
                            <span class="text-gray-500">vs</span>
                            <span class="text-purple-400 font-mono text-lg">${geminiData.theories.length}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.getElementById('comparisonMetrics').innerHTML = metricsHTML;

    // Display OpenAI results
    displaySystemResults('supabaseResults', openaiData, supabaseDocs, uniqueSupabase, commonDocs);

    // Display Gemini results
    displaySystemResults('vertexResults', geminiData, geminiDocs, uniqueGemini, commonDocs);

    // Display reports
    displaySystemReport('supabaseReport', openaiData.report, 'ğŸ¤– OpenAI Embedding');
    displaySystemReport('vertexReport', geminiData.report, 'ğŸ”· Gemini Embedding');
}

function displaySystemReport(elementId, reportData, systemName) {
    if (!reportData || !reportData.conceptualization) {
        document.getElementById(elementId).innerHTML = '<div class="text-red-400 p-4 bg-red-900/20 rounded">âš ï¸ å ±å‘Šç”Ÿæˆå¤±æ•—</div>';
        return;
    }

    const borderColor = elementId === 'supabaseReport' ? 'border-blue-500' : 'border-purple-500';
    const textColor = elementId === 'supabaseReport' ? 'text-blue-400' : 'text-purple-400';

    let html = `
        <div class="space-y-4">
            <div class="bg-gray-800/70 rounded-lg p-4 border border-gray-700">
                <h5 class="${textColor} font-semibold mb-3 text-base">ğŸ‘¤ æ¡ˆä¸»åŸºæœ¬è³‡è¨Š</h5>
                <div class="text-gray-300 text-sm space-y-2">
                    <div class="flex"><span class="text-gray-500 w-16">å§“åï¼š</span><span class="font-medium">${reportData.client_info.name}</span></div>
                    <div class="flex"><span class="text-gray-500 w-16">å¹´é½¡ï¼š</span><span>${reportData.client_info.age}</span></div>
                    <div class="flex"><span class="text-gray-500 w-16">è·æ¥­ï¼š</span><span>${reportData.client_info.occupation}</span></div>
                </div>
            </div>

            <div class="bg-gray-800/70 rounded-lg p-4 border border-gray-700">
                <h5 class="${textColor} font-semibold mb-3 text-base">ğŸ¯ ä¸»è¨´å•é¡Œ</h5>
                <div class="text-gray-300 text-sm space-y-1">
                    ${reportData.main_concerns.map(c => `<div class="flex items-start gap-2"><span class="text-yellow-400">â€¢</span><span>${c}</span></div>`).join('')}
                </div>
            </div>

            <div class="bg-gray-800/70 rounded-lg p-4 border border-gray-700">
                <h5 class="${textColor} font-semibold mb-3 text-base">ğŸ“ æ¦‚å¿µåŒ–åˆ†æ</h5>
                <div class="text-gray-300 text-sm leading-relaxed whitespace-pre-wrap max-h-[500px] overflow-y-auto bg-gray-900/50 rounded p-3">
${reportData.conceptualization}
                </div>
            </div>

            <div class="bg-gray-800/70 rounded-lg p-4 border border-gray-700">
                <h5 class="${textColor} font-semibold mb-3 text-base">ğŸ“š å¼•ç”¨ç†è«–æ–‡ç»ï¼ˆ${reportData.theories.length} å€‹ï¼‰</h5>
                <div class="text-gray-300 text-sm space-y-3">
                    ${reportData.theories.slice(0, 3).map((t, idx) => `
                        <div class="border-l-3 ${borderColor} pl-3 py-1 bg-gray-900/50 rounded">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-yellow-400 font-mono text-xs">[${idx + 1}]</span>
                                <span class="text-gray-500 text-xs">${(t.score * 100).toFixed(1)}% ç›¸ä¼¼</span>
                            </div>
                            <div class="text-gray-400 text-xs">${t.text.substring(0, 120)}...</div>
                        </div>
                    `).join('')}
                    ${reportData.theories.length > 3 ? `<div class="text-gray-500 text-xs text-center pt-2">... é‚„æœ‰ ${reportData.theories.length - 3} å€‹åƒè€ƒç†è«–</div>` : ''}
                </div>
            </div>

            <div class="mt-4 pt-4 border-t border-gray-700">
                <div class="text-gray-500 text-xs text-center">
                    ${systemName} â€¢ ç”Ÿæˆæ™‚é–“ç´„ ${reportData.theories.length > 0 ? Math.ceil(reportData.theories.length * 0.5) : 1} ç§’
                </div>
            </div>
        </div>
    `;

    document.getElementById(elementId).innerHTML = html;
}

function displaySystemResults(elementId, systemData, allDocs, uniqueDocs, commonDocs) {
    const theories = systemData.theories;
    const avgScore = theories.length > 0
        ? (theories.reduce((sum, t) => sum + t.score, 0) / theories.length).toFixed(4)
        : 0;

    let html = `
        <div class="mb-4 p-4 bg-gray-800 rounded-lg">
            <div class="grid grid-cols-2 gap-3 text-sm">
                <div>
                    <span class="text-gray-400">æ‰¾åˆ°ç†è«–ï¼š</span>
                    <span class="text-white font-bold">${theories.length} å€‹</span>
                </div>
                <div>
                    <span class="text-gray-400">å¹³å‡åˆ†æ•¸ï¼š</span>
                    <span class="text-yellow-400 font-mono">${avgScore}</span>
                </div>
                <div>
                    <span class="text-gray-400">è™•ç†æ™‚é–“ï¼š</span>
                    <span class="text-green-400 font-mono">${systemData.processingTime.toFixed(2)}s</span>
                </div>
                <div>
                    <span class="text-gray-400">ç¨æœ‰æ–‡ç»ï¼š</span>
                    <span class="text-orange-400 font-bold">${uniqueDocs.length} å€‹</span>
                </div>
            </div>
        </div>

        <div class="space-y-2">
    `;

    theories.forEach((theory, idx) => {
        const isUnique = uniqueDocs.includes(theory.document);
        const isCommon = commonDocs.includes(theory.document);
        const badge = isUnique ? '<span class="text-xs bg-orange-500 text-white px-2 py-1 rounded">ç¨æœ‰</span>' :
                      isCommon ? '<span class="text-xs bg-green-500 text-white px-2 py-1 rounded">å…±åŒ</span>' : '';

        html += `
            <div class="bg-gray-800 rounded p-3">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center gap-2">
                        <span class="text-gray-500 text-sm">#${idx + 1}</span>
                        <span class="text-gray-300 text-sm font-medium">${theory.document}</span>
                        ${badge}
                    </div>
                    <span class="text-yellow-400 font-mono text-sm">${theory.score.toFixed(4)}</span>
                </div>
                <div class="text-gray-400 text-xs leading-relaxed max-h-20 overflow-hidden">
                    ${theory.text.substring(0, 150)}${theory.text.length > 150 ? '...' : ''}
                </div>
            </div>
        `;
    });

    html += '</div>';
    document.getElementById(elementId).innerHTML = html;
}

function updateProgress(data) {
    const stepMessages = {
        1: 'åˆ†æé€å­—ç¨¿çµæ§‹',
        2: 'è­˜åˆ¥é—œéµè­°é¡Œ',
        3: 'æª¢ç´¢ç›¸é—œç†è«–',
        4: 'ç”Ÿæˆå€‹æ¡ˆå ±å‘Š',
        5: 'æå–é—œéµå°è©±',
        6: 'å®Œæˆ'
    };

    const progressSteps = document.getElementById('progressSteps');
    let stepDiv = document.getElementById(`step-${data.step}`);

    if (!stepDiv) {
        stepDiv = document.createElement('div');
        stepDiv.id = `step-${data.step}`;
        stepDiv.className = 'flex items-center gap-3';
        progressSteps.appendChild(stepDiv);
    }

    const icon = data.status === 'completed' ? 'âœ…' :
                 data.status === 'processing' ? 'â³' : 'âŒ';

    stepDiv.innerHTML = `
        <span class="text-2xl">${icon}</span>
        <div class="flex-1">
            <div class="text-white font-medium">${stepMessages[data.step] || data.message}</div>
            <div class="text-sm text-gray-400">${data.message}</div>
        </div>
    `;
}

function switchComparisonTab(tabName) {
    // Update tab buttons
    ['retrieval', 'reports'].forEach(tab => {
        const button = document.getElementById(`comp-tab-${tab}`);
        const content = document.getElementById(`comp-content-${tab}`);

        if (tab === tabName) {
            button.classList.remove('text-gray-400', 'border-transparent');
            button.classList.add('text-white', 'border-blue-500');
            content.classList.remove('hidden');
        } else {
            button.classList.remove('text-white', 'border-blue-500');
            button.classList.add('text-gray-400', 'border-transparent');
            content.classList.add('hidden');
        }
    });
}

function switchTab(tabName) {
    // Update tab buttons
    ['html', 'json', 'markdown'].forEach(tab => {
        const button = document.getElementById(`tab-${tab}`);
        const content = document.getElementById(`content-${tab}`);

        if (tab === tabName) {
            button.classList.remove('text-gray-400', 'border-transparent');
            button.classList.add('text-white', 'border-blue-500');
            content.classList.remove('hidden');
        } else {
            button.classList.remove('text-white', 'border-blue-500');
            button.classList.add('text-gray-400', 'border-transparent');
            content.classList.add('hidden');
        }
    });

    // Update JSON and Markdown content when switching to those tabs
    if (tabName === 'json' && reportData) {
        document.getElementById('jsonOutput').textContent = JSON.stringify(reportData, null, 2);
    } else if (tabName === 'markdown' && reportData) {
        document.getElementById('markdownOutput').textContent = generateMarkdownText();
    }
}

function displayReportInTable(report) {
    const info = report.client_info;

    // Header
    document.getElementById('counselor_name_display').textContent = '-';
    document.getElementById('completion_date_display').textContent = new Date().toLocaleDateString('zh-TW');

    // Client Info
    document.getElementById('client_name').textContent = info.name || '-';
    document.getElementById('client_gender').textContent = info.gender || '-';
    document.getElementById('client_age').textContent = info.age || '-';
    document.getElementById('client_occupation').textContent = info.occupation || '-';
    document.getElementById('client_education').textContent = info.education || '-';
    document.getElementById('client_location').textContent = info.location || '-';
    document.getElementById('client_economic').textContent = info.economic_status || '-';
    document.getElementById('client_family').textContent = info.family_relations || '-';
    document.getElementById('client_other').textContent = Array.isArray(info.other_info) ? info.other_info.join('\n') : (info.other_info || '-');

    // Session History (currently empty from API, but structure is ready)
    const sessionTable = document.getElementById('session_history');
    sessionTable.innerHTML = `
        <tr>
            <td class="border border-gray-600 px-4 py-2 text-white">ç¬¬ä¸€æ¬¡æ™¤è«‡</td>
            <td class="border border-gray-600 px-4 py-2 text-white">${report.session_summary?.content || 'å¾é€å­—ç¨¿è‡ªå‹•ç”Ÿæˆ'}</td>
            <td class="border border-gray-600 px-4 py-2 text-white">${report.session_summary?.self_evaluation || '-'}</td>
        </tr>
    `;

    // Parse conceptualization into sections
    const conceptText = report.conceptualization;
    const sections = parseConceptualization(conceptText);

    document.getElementById('main_issue').textContent = sections.main_issue || (report.main_concerns ? report.main_concerns.join('ã€') : '-');
    document.getElementById('cause_analysis').textContent = sections.cause_analysis || '-';
    document.getElementById('counseling_goal').textContent = sections.counseling_goal || (report.counseling_goals ? report.counseling_goals.join('ã€') : '-');
    document.getElementById('intervention').textContent = sections.intervention || (report.techniques ? report.techniques.join('ã€') : '-');
    document.getElementById('effectiveness').textContent = sections.effectiveness || '-';

    // Personal Analysis (not in current API, set defaults)
    document.getElementById('counselor_feeling').textContent = '-';
    document.getElementById('feeling_reason').textContent = '-';
    document.getElementById('difficulties').textContent = '-';
    document.getElementById('supervision_topic').textContent = '-';

    // Dialogue Excerpts
    const dialogueExcerpts = document.getElementById('dialogueExcerpts');
    if (report.dialogue_excerpts && report.dialogue_excerpts.length > 0) {
        dialogueExcerpts.innerHTML = report.dialogue_excerpts.map(d => {
            const speakerLabel = d.speaker === 'speaker1' ? 'è«®è©¢å¸«' : 'å€‹æ¡ˆ';
            const bgColor = d.speaker === 'speaker1' ? 'bg-blue-900/30' : 'bg-green-900/30';
            return `
                <div class="${bgColor} rounded-lg p-3">
                    <div class="text-xs text-gray-400 mb-1">${speakerLabel}</div>
                    <div class="text-gray-200">${d.text}</div>
                </div>
            `;
        }).join('');
    } else {
        dialogueExcerpts.innerHTML = '<div class="text-gray-400">ç„¡å°è©±æ‘˜éŒ„</div>';
    }

    // Theories
    const theoriesList = document.getElementById('theoriesList');
    if (report.theories && report.theories.length > 0) {
        theoriesList.innerHTML = report.theories.map((theory, idx) => `
            <div class="bg-gray-700 rounded-lg p-4 border border-gray-600">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-blue-400 font-mono text-sm">[${idx + 1}]</span>
                    <span class="text-gray-400 text-xs">${(theory.score * 100).toFixed(1)}% ç›¸ä¼¼åº¦</span>
                </div>
                <div class="text-white text-sm mb-2">${theory.document}</div>
                <div class="text-gray-300 text-sm">${theory.text}</div>
            </div>
        `).join('');
    } else {
        theoriesList.innerHTML = '<div class="text-yellow-400 p-4 bg-yellow-900/20 rounded-lg">âš ï¸ æœªæ‰¾åˆ°ç›¸é—œåƒè€ƒç†è«–æ–‡ç»ï¼ˆå»ºè­°åœ¨é€å­—ç¨¿ä¸­åŒ…å«æ›´å¤šè·æ¶¯ç›¸é—œé—œéµå­—ï¼‰</div>';
    }
}

function parseConceptualization(text) {
    const sections = {
        main_issue: '',
        cause_analysis: '',
        counseling_goal: '',
        intervention: '',
        effectiveness: ''
    };

    // Check if this is the enhanced 10-section version
    const isEnhancedVersion = text.includes('ã€äºŒã€ä¸»è¨´å•é¡Œã€‘') || text.includes('ã€äº”ã€å¤šå±¤æ¬¡å› ç´ åˆ†æã€‘');

    if (isEnhancedVersion) {
        // Parse enhanced 10-section format
        const section2Match = text.match(/ã€äºŒã€ä¸»è¨´å•é¡Œã€‘\s*([\s\S]*?)(?=ã€[ä¸‰å››äº”å…­ä¸ƒå…«ä¹å]ã€|$)/);
        const section3Match = text.match(/ã€ä¸‰ã€å•é¡Œç™¼å±•è„ˆçµ¡ã€‘\s*([\s\S]*?)(?=ã€[å››äº”å…­ä¸ƒå…«ä¹å]ã€|$)/);
        const section4Match = text.match(/ã€å››ã€æ±‚åŠ©å‹•æ©Ÿèˆ‡æœŸå¾…ã€‘\s*([\s\S]*?)(?=ã€[äº”å…­ä¸ƒå…«ä¹å]ã€|$)/);
        const section5Match = text.match(/ã€äº”ã€å¤šå±¤æ¬¡å› ç´ åˆ†æã€‘\s*([\s\S]*?)(?=ã€[å…­ä¸ƒå…«ä¹å]ã€|$)/);
        const section6Match = text.match(/ã€å…­ã€å€‹æ¡ˆå„ªå‹¢èˆ‡è³‡æºã€‘\s*([\s\S]*?)(?=ã€[ä¸ƒå…«ä¹å]ã€|$)/);
        const section7Match = text.match(/ã€ä¸ƒã€è«®è©¢å¸«çš„å°ˆæ¥­åˆ¤æ–·ã€‘\s*([\s\S]*?)(?=ã€[å…«ä¹å]ã€|$)/);
        const section8Match = text.match(/ã€å…«ã€è«®å•†ç›®æ¨™èˆ‡ä»‹å…¥ç­–ç•¥ã€‘\s*([\s\S]*?)(?=ã€[ä¹å]ã€|$)/);
        const section9Match = text.match(/ã€ä¹ã€é æœŸæˆæ•ˆèˆ‡è©•ä¼°ã€‘\s*([\s\S]*?)(?=ã€åã€|$)/);

        // Map to legacy structure for display compatibility
        if (section2Match) sections.main_issue = section2Match[1].trim();
        if (section5Match) sections.cause_analysis = section5Match[1].trim();  // å¤šå±¤æ¬¡å› ç´ åˆ†æ
        if (section8Match) {
            // Extract counseling goal and intervention from section 8
            const goalPart = section8Match[1].match(/è«®å•†ç›®æ¨™[ï¼š:]([\s\S]*?)(?=ä»‹å…¥æŠ€è¡“|$)/);
            const interventionPart = section8Match[1].match(/ä»‹å…¥æŠ€è¡“[ï¼š:]([\s\S]*?)$/);
            if (goalPart) sections.counseling_goal = goalPart[1].trim();
            if (interventionPart) sections.intervention = interventionPart[1].trim();
        }
        if (section9Match) sections.effectiveness = section9Match[1].trim();

        // Store full enhanced sections for future use
        sections.enhanced = {
            section2: section2Match ? section2Match[1].trim() : '',
            section3: section3Match ? section3Match[1].trim() : '',
            section4: section4Match ? section4Match[1].trim() : '',
            section5: section5Match ? section5Match[1].trim() : '',
            section6: section6Match ? section6Match[1].trim() : '',
            section7: section7Match ? section7Match[1].trim() : '',
            section8: section8Match ? section8Match[1].trim() : '',
            section9: section9Match ? section9Match[1].trim() : ''
        };
    } else {
        // Parse legacy 5-section format
        const mainIssueMatch = text.match(/ã€ä¸»è¨´å•é¡Œã€‘\s*([\s\S]*?)(?=ã€|$)/);
        const causeMatch = text.match(/ã€æˆå› åˆ†æã€‘\s*([\s\S]*?)(?=ã€|$)/);
        const goalMatch = text.match(/ã€æ™¤è«‡ç›®æ¨™ã€‘\s*([\s\S]*?)(?=ã€|$)/);
        const interventionMatch = text.match(/ã€ä»‹å…¥ç­–ç•¥ã€‘\s*([\s\S]*?)(?=ã€|$)/);
        const effectivenessMatch = text.match(/ã€ç›®å‰æˆæ•ˆè©•ä¼°ã€‘\s*([\s\S]*?)(?=ã€|$)/);

        if (mainIssueMatch) sections.main_issue = mainIssueMatch[1].trim();
        if (causeMatch) sections.cause_analysis = causeMatch[1].trim();
        if (goalMatch) sections.counseling_goal = goalMatch[1].trim();
        if (interventionMatch) sections.intervention = interventionMatch[1].trim();
        if (effectivenessMatch) sections.effectiveness = effectivenessMatch[1].trim();
    }

    return sections;
}

function clearForm() {
    document.getElementById('transcript').value = '';
    document.getElementById('numParticipants').value = '2';
    document.getElementById('reportSection').classList.add('hidden');
    document.getElementById('progressSection').classList.add('hidden');
    document.getElementById('comparisonSection').classList.add('hidden');
    reportData = null;
}

// Toggle RAG system selector based on comparison mode
document.addEventListener('DOMContentLoaded', function() {
    const comparisonCheckbox = document.getElementById('comparisonMode');
    const ragSystemSelect = document.getElementById('ragSystem');

    if (comparisonCheckbox && ragSystemSelect) {
        comparisonCheckbox.addEventListener('change', function() {
            if (this.checked) {
                ragSystemSelect.disabled = true;
                ragSystemSelect.style.opacity = '0.5';
                ragSystemSelect.title = 'æ¯”è¼ƒæ¨¡å¼æœƒæ¸¬è©¦å…©å€‹ç³»çµ±';
            } else {
                ragSystemSelect.disabled = false;
                ragSystemSelect.style.opacity = '1';
                ragSystemSelect.title = '';
            }
        });
    }
});

function downloadJSON() {
    if (!reportData) {
        alert('è«‹å…ˆç”Ÿæˆå ±å‘Š');
        return;
    }

    const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `case_report_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function generateMarkdownText() {
    if (!reportData) return '';

    const info = reportData.client_info;
    let markdown = `# è·æ¸¸å‰µæ–°è·æ¶¯ç™¼å±•èˆ‡è«®è©¢ - å€‹æ¡ˆå ±å‘Š

**è«®è©¢ç·´ç¿’ç”Ÿ**ï¼š-
**å®Œæˆæ’°å¯«æ—¥æœŸ**ï¼š${new Date().toLocaleDateString('zh-TW')}

---

## ä¸€ã€æ¡ˆä¸»åŸºæœ¬è³‡æ–™

| é …ç›® | å…§å®¹ |
|-----|------|
| 1. å§“å(åŒ–å) | ${info.name || '-'} |
| 2. æ€§åˆ¥ | ${info.gender || '-'} |
| 3. å¹´ç´€ | ${info.age || '-'} |
| 4. éƒ¨é–€/è·æ¥­(å­¸æ ¡ç§‘ç³») | ${info.occupation || '-'} |
| 5. å­¸æ­· | ${info.education || '-'} |
| 6. ç¾å±…åœ° | ${info.location || '-'} |
| 7. ç¶“æ¿Ÿç‹€æ³ | ${info.economic_status || '-'} |
| 8. å®¶åº­é—œä¿‚ | ${info.family_relations || '-'} |
| 9. å…¶ä»–é‡è¦è³‡è¨Š | ${Array.isArray(info.other_info) ? info.other_info.join('; ') : (info.other_info || '-')} |

---

## äºŒã€æ­·ç¨‹åˆ†æ

| æ¬¡æ•¸/æ™¤è«‡æ™‚é–“ | æ™¤è«‡å…§å®¹æ¦‚è¿° | è«®è©¢å¸«è‡ªè©• |
|--------------|-------------|-----------|
| ç¬¬ä¸€æ¬¡æ™¤è«‡ | ${reportData.session_summary?.content || 'å¾é€å­—ç¨¿è‡ªå‹•ç”Ÿæˆ'} | ${reportData.session_summary?.self_evaluation || '-'} |

---

## ä¸‰ã€æ¦‚å¿µåŒ–åˆ†æ

`;

    const sections = parseConceptualization(reportData.conceptualization);

    markdown += `### ä¸»è¨´å•é¡Œ
${sections.main_issue || (reportData.main_concerns ? reportData.main_concerns.join('ã€') : '-')}

### æˆå› åˆ†æ
${sections.cause_analysis || '-'}

### æ™¤è«‡ç›®æ¨™(ç§»å‹•ä¸»è¨´)
${sections.counseling_goal || (reportData.counseling_goals ? reportData.counseling_goals.join('ã€') : '-')}

### ä»‹å…¥ç­–ç•¥
${sections.intervention || (reportData.techniques ? reportData.techniques.join('ã€') : '-')}

### ç›®å‰æˆæ•ˆè©•ä¼°
${sections.effectiveness || '-'}

---

## å››ã€å€‹äººåŒ–åˆ†æ

### æˆ‘å’Œé€™å€‹äººå·¥ä½œçš„æ„Ÿå—æ˜¯ï¼Ÿ
-

### é€™å€‹æ„Ÿå—çš„åŸå› æ˜¯ï¼Ÿ
-

### ç›®å‰è·Ÿé€™å€‹äººå·¥ä½œçš„å›°é›£
-

### æˆ‘æœƒæƒ³æ‰¾ç£å°è¨è«–çš„å•é¡Œæ˜¯ï¼Ÿ
-

---

## é—œéµå°è©±æ‘˜éŒ„

`;

    if (reportData.dialogue_excerpts && reportData.dialogue_excerpts.length > 0) {
        reportData.dialogue_excerpts.forEach(d => {
            const speaker = d.speaker === 'speaker1' ? 'è«®è©¢å¸«' : 'å€‹æ¡ˆ';
            markdown += `**${speaker}**: ${d.text}\n\n`;
        });
    } else {
        markdown += 'ç„¡å°è©±æ‘˜éŒ„\n\n';
    }

    markdown += `---

## åƒè€ƒç†è«–æ–‡ç»

`;

    if (reportData.theories && reportData.theories.length > 0) {
        reportData.theories.forEach((t, i) => {
            markdown += `**[${i+1}]** ${t.document} (ç›¸ä¼¼åº¦: ${(t.score * 100).toFixed(1)}%)\n\n${t.text}\n\n`;
        });
    } else {
        markdown += 'ç„¡åƒè€ƒç†è«–\n\n';
    }

    markdown += `---\n\n*å ±å‘Šç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}*\n`;

    return markdown;
}

function downloadMarkdown() {
    if (!reportData) {
        alert('è«‹å…ˆç”Ÿæˆå ±å‘Š');
        return;
    }

    const markdown = generateMarkdownText();
    const blob = new Blob([markdown], { type: 'text/markdown;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `case_report_${new Date().toISOString().split('T')[0]}.md`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function copyReport() {
    if (!reportData) {
        alert('è«‹å…ˆç”Ÿæˆå ±å‘Š');
        return;
    }

    const info = reportData.client_info;
    const sections = parseConceptualization(reportData.conceptualization);

    const fullReport = `è·æ¸¸å‰µæ–°è·æ¶¯ç™¼å±•èˆ‡è«®è©¢ - å€‹æ¡ˆå ±å‘Š

ä¸€ã€æ¡ˆä¸»åŸºæœ¬è³‡æ–™
å§“åï¼š${info.name || '-'}
æ€§åˆ¥ï¼š${info.gender || '-'}
å¹´é½¡ï¼š${info.age || '-'}
è·æ¥­/ç§‘ç³»ï¼š${info.occupation || '-'}
å­¸æ­·ï¼š${info.education || '-'}
ç¾å±…åœ°ï¼š${info.location || '-'}
ç¶“æ¿Ÿç‹€æ³ï¼š${info.economic_status || '-'}
å®¶åº­é—œä¿‚ï¼š${info.family_relations || '-'}

ä¸‰ã€æ¦‚å¿µåŒ–åˆ†æ

ä¸»è¨´å•é¡Œï¼š
${sections.main_issue || (reportData.main_concerns ? reportData.main_concerns.join('ã€') : '-')}

æˆå› åˆ†æï¼š
${sections.cause_analysis || '-'}

æ™¤è«‡ç›®æ¨™ï¼š
${sections.counseling_goal || (reportData.counseling_goals ? reportData.counseling_goals.join('ã€') : '-')}

ä»‹å…¥ç­–ç•¥ï¼š
${sections.intervention || (reportData.techniques ? reportData.techniques.join('ã€') : '-')}

æˆæ•ˆè©•ä¼°ï¼š
${sections.effectiveness || '-'}
    `.trim();

    navigator.clipboard.writeText(fullReport).then(() => {
        alert('âœ… å ±å‘Šå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
    }).catch(err => {
        console.error('è¤‡è£½å¤±æ•—:', err);
        alert('âŒ è¤‡è£½å¤±æ•—');
    });
}

// Version Comparison Functions
async function runVersionComparison(transcript, numParticipants, ragSystem, topK) {
    try {
        const comparisonData = {
            legacy: null,
            enhanced: null
        };

        // Generate Legacy Version
        document.getElementById('progressSteps').innerHTML = '<div class="text-gray-400 font-semibold text-lg">ğŸ“„ æ­£åœ¨ç”ŸæˆèˆŠç‰ˆå ±å‘Šï¼ˆ5æ®µå¼ï¼‰...</div>';
        comparisonData.legacy = await generateReportVersion(transcript, numParticipants, ragSystem, topK, true);

        // Generate Enhanced Version
        document.getElementById('progressSteps').innerHTML += '<div class="text-blue-400 font-semibold text-lg mt-4">âœ¨ æ­£åœ¨ç”Ÿæˆæ–°ç‰ˆå ±å‘Šï¼ˆ10æ®µå¼+å“è³ªé©—è­‰ï¼‰...</div>';
        comparisonData.enhanced = await generateReportVersion(transcript, numParticipants, ragSystem, topK, false);

        // Display comparison
        displayVersionComparison(comparisonData);

        // Hide progress and show comparison
        document.getElementById('progressSection').classList.add('hidden');
        document.getElementById('reportSection').classList.add('hidden');
        document.getElementById('versionComparisonSection').classList.remove('hidden');

    } catch (error) {
        console.error('Version comparison failed:', error);
        alert('ç‰ˆæœ¬æ¯”è¼ƒåŸ·è¡Œå¤±æ•—: ' + error.message);
        document.getElementById('progressSection').classList.add('hidden');
    }
}

async function generateReportVersion(transcript, numParticipants, ragSystem, topK, useLegacy) {
    const response = await fetch('/api/report/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            transcript: transcript,
            num_participants: numParticipants,
            rag_system: ragSystem,
            top_k: topK,
            use_legacy: useLegacy
        })
    });

    if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || 'å ±å‘Šç”Ÿæˆå¤±æ•—');
    }

    return await response.json();
}

function displayVersionComparison(data) {
    const legacyReport = data.legacy.report;
    const enhancedReport = data.enhanced.report;
    const legacyQuality = data.legacy.quality_summary;
    const enhancedQuality = data.enhanced.quality_summary;

    // Display Legacy Report
    const legacyHTML = formatReportContent(legacyReport);
    document.getElementById('legacyReportContent').innerHTML = legacyHTML;

    // Display Legacy Quality Score
    if (legacyQuality) {
        // DEBUG: Show actual report text to verify citations
        console.log('ğŸ“„ èˆŠç‰ˆå ±å‘Šå®Œæ•´æ–‡æœ¬:', legacyReport.conceptualization);
        console.log('ğŸ” æª¢æŸ¥å¼•ç”¨æ¨™è¨˜ [1], [2] ç­‰:', legacyReport.conceptualization.match(/\[\d+\]/g));

        console.log('ğŸ“Š èˆŠç‰ˆå“è³ªè³‡æ–™:', legacyQuality);

        // Check if using LLM grading or legacy grading
        const isLLMGrading = legacyQuality.grading_method === 'llm';

        let legacyQualityHTML = `
            <div class="bg-gray-800/50 rounded-lg p-4 mt-4">
                <h5 class="text-gray-400 font-semibold mb-3">ğŸ“Š å“è³ªè©•åˆ†ï¼ˆèˆŠç‰ˆï¼‰${isLLMGrading ? ' - LLM è©•åˆ†' : ''}</h5>`;

        if (isLLMGrading) {
            // LLM Grading Display with 8 dimensions (å€‹æ¡ˆæ¦‚å¿µåŒ–èƒ½åŠ›è©•é‡è¡¨)
            const dimensions = [
                { key: 'problem_clarity', label: 'å•é¡Œé™³è¿°', color: 'gray' },
                { key: 'problem_evolution', label: 'å•é¡Œæ¼”è®Š', color: 'gray' },
                { key: 'help_seeking', label: 'æ±‚åŠ©åŸå› ', color: 'gray' },
                { key: 'related_factors', label: 'ç›¸é—œå› ç´ ', color: 'gray' },
                { key: 'function_assessment', label: 'åŠŸèƒ½è©•ä¼°', color: 'gray' },
                { key: 'problem_judgment', label: 'å•é¡Œåˆ¤æ–·', color: 'gray' },
                { key: 'counseling_plan', label: 'è«®å•†è¨ˆåŠƒ', color: 'gray' },
                { key: 'implementation_eval', label: 'å¯¦æ–½è©•ä¼°', color: 'gray' }
            ];

            legacyQualityHTML += `
                <div class="text-xs text-gray-400 mb-2">ä¾æ“šã€Œå€‹æ¡ˆæ¦‚å¿µåŒ–èƒ½åŠ›è©•é‡è¡¨ã€8å‘åº¦è©•åˆ†</div>
                <div class="grid grid-cols-4 gap-2 text-sm mb-4">`;

            dimensions.forEach(dim => {
                const dimData = legacyQuality[dim.key];
                if (dimData) {
                    legacyQualityHTML += `
                        <div class="bg-${dim.color}-700/50 rounded p-2">
                            <div class="text-gray-400 text-xs">${dim.label} (${dimData.max_score})</div>
                            <div class="text-white font-mono text-lg font-bold">${dimData.score}</div>
                            ${dimData.feedback ? `<div class="text-gray-400 text-xs mt-1 line-clamp-2" title="${dimData.feedback}">${dimData.feedback}</div>` : ''}
                        </div>`;
                }
            });

            legacyQualityHTML += `
                </div>
                <div class="border-t border-gray-700 pt-3">
                    <div class="flex justify-between items-center mb-2">
                        <div class="text-gray-400">ç¸½åˆ†</div>
                        <div class="text-2xl font-bold ${getScoreColor(legacyQuality.overall_score)}">${legacyQuality.overall_score} / 100 (${legacyQuality.grade})</div>
                    </div>
                    ${legacyQuality.overall_feedback ? `<div class="text-gray-300 text-sm bg-gray-700/30 rounded p-2 mb-2">${legacyQuality.overall_feedback}</div>` : ''}
                    ${legacyQuality.strengths && legacyQuality.strengths.length > 0 ? `
                        <div class="mt-2">
                            <div class="text-green-400 text-xs font-semibold mb-1">âœ… å„ªé»ï¼š</div>
                            <ul class="text-gray-300 text-xs list-disc list-inside space-y-1">
                                ${legacyQuality.strengths.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    ${legacyQuality.improvements && legacyQuality.improvements.length > 0 ? `
                        <div class="mt-2">
                            <div class="text-yellow-400 text-xs font-semibold mb-1">ğŸ’¡ å»ºè­°æ”¹é€²ï¼š</div>
                            <ul class="text-gray-300 text-xs list-disc list-inside space-y-1">
                                ${legacyQuality.improvements.map(i => `<li>${i}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>`;
        } else {
            // Fallback if LLM grading not available
            legacyQualityHTML += `
                <div class="text-center text-gray-400 py-4">
                    <div class="text-2xl font-bold ${getScoreColor(legacyQuality.overall_score)}">${legacyQuality.overall_score} / 100</div>
                    <div class="text-xs mt-1">${legacyQuality.grade}</div>
                </div>`;
        }

        legacyQualityHTML += `
            </div>
        `;
        document.getElementById('legacyReportContent').innerHTML += legacyQualityHTML;
    }

    // Display Enhanced Report
    const enhancedHTML = formatReportContent(enhancedReport);
    document.getElementById('enhancedReportContent').innerHTML = enhancedHTML;

    // Display Enhanced Quality Score
    if (enhancedQuality) {
        // DEBUG: Show actual report text to verify citations
        console.log('ğŸ“„ æ–°ç‰ˆå ±å‘Šå®Œæ•´æ–‡æœ¬:', enhancedReport.conceptualization);
        console.log('ğŸ” æª¢æŸ¥å¼•ç”¨æ¨™è¨˜ [1], [2] ç­‰:', enhancedReport.conceptualization.match(/\[\d+\]/g));

        console.log('ğŸ“Š æ–°ç‰ˆå“è³ªè³‡æ–™:', enhancedQuality);

        // Check if using LLM grading
        const isEnhancedLLMGrading = enhancedQuality.grading_method === 'llm';

        let qualityHTML = `
            <div class="bg-blue-900/20 rounded-lg p-4">
                <h5 class="text-blue-400 font-semibold mb-3">ğŸ“Š å“è³ªè©•åˆ†ï¼ˆæ–°ç‰ˆï¼‰${isEnhancedLLMGrading ? ' - LLM è©•åˆ†' : ''}</h5>`;

        if (isEnhancedLLMGrading) {
            // LLM Grading Display with 8 dimensions (å€‹æ¡ˆæ¦‚å¿µåŒ–èƒ½åŠ›è©•é‡è¡¨)
            const dimensions = [
                { key: 'problem_clarity', label: 'å•é¡Œé™³è¿°', color: 'blue' },
                { key: 'problem_evolution', label: 'å•é¡Œæ¼”è®Š', color: 'blue' },
                { key: 'help_seeking', label: 'æ±‚åŠ©åŸå› ', color: 'blue' },
                { key: 'related_factors', label: 'ç›¸é—œå› ç´ ', color: 'blue' },
                { key: 'function_assessment', label: 'åŠŸèƒ½è©•ä¼°', color: 'blue' },
                { key: 'problem_judgment', label: 'å•é¡Œåˆ¤æ–·', color: 'blue' },
                { key: 'counseling_plan', label: 'è«®å•†è¨ˆåŠƒ', color: 'blue' },
                { key: 'implementation_eval', label: 'å¯¦æ–½è©•ä¼°', color: 'blue' }
            ];

            qualityHTML += `
                <div class="text-xs text-gray-400 mb-2">ä¾æ“šã€Œå€‹æ¡ˆæ¦‚å¿µåŒ–èƒ½åŠ›è©•é‡è¡¨ã€8å‘åº¦è©•åˆ†</div>
                <div class="grid grid-cols-4 gap-2 text-sm mb-4">`;

            dimensions.forEach(dim => {
                const dimData = enhancedQuality[dim.key];
                if (dimData) {
                    qualityHTML += `
                        <div class="bg-${dim.color}-900/30 rounded p-2">
                            <div class="text-gray-400 text-xs">${dim.label} (${dimData.max_score})</div>
                            <div class="text-white font-mono text-lg font-bold">${dimData.score}</div>
                            ${dimData.feedback ? `<div class="text-gray-400 text-xs mt-1 line-clamp-2" title="${dimData.feedback}">${dimData.feedback}</div>` : ''}
                        </div>`;
                }
            });

            qualityHTML += `
                </div>
                <div class="border-t border-blue-800 pt-3">
                    <div class="flex justify-between items-center mb-2">
                        <div class="text-gray-400">ç¸½åˆ†</div>
                        <div class="text-2xl font-bold ${getScoreColor(enhancedQuality.overall_score)}">${enhancedQuality.overall_score} / 100 (${enhancedQuality.grade})</div>
                    </div>
                    ${enhancedQuality.overall_feedback ? `<div class="text-gray-300 text-sm bg-blue-900/20 rounded p-2 mb-2">${enhancedQuality.overall_feedback}</div>` : ''}
                    ${enhancedQuality.strengths && enhancedQuality.strengths.length > 0 ? `
                        <div class="mt-2">
                            <div class="text-green-400 text-xs font-semibold mb-1">âœ… å„ªé»ï¼š</div>
                            <ul class="text-gray-300 text-xs list-disc list-inside space-y-1">
                                ${enhancedQuality.strengths.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    ${enhancedQuality.improvements && enhancedQuality.improvements.length > 0 ? `
                        <div class="mt-2">
                            <div class="text-yellow-400 text-xs font-semibold mb-1">ğŸ’¡ å»ºè­°æ”¹é€²ï¼š</div>
                            <ul class="text-gray-300 text-xs list-disc list-inside space-y-1">
                                ${enhancedQuality.improvements.map(i => `<li>${i}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>`;
        } else {
            // Fallback if LLM grading not available
            qualityHTML += `
                <div class="text-center text-gray-400 py-4">
                    <div class="text-2xl font-bold ${getScoreColor(enhancedQuality.overall_score)}">${enhancedQuality.overall_score} / 100</div>
                    <div class="text-xs mt-1">${enhancedQuality.grade}</div>
                </div>`;
        }

        qualityHTML += `
            </div>
        `;
        document.getElementById('qualityScoreDisplay').innerHTML = qualityHTML;
    }

    // Generate Comparison Table
    generateComparisonTable(legacyReport, enhancedReport, legacyQuality, enhancedQuality);

    // Generate Aligned Comparison
    generateAlignedComparison(legacyReport, enhancedReport);
}

function extractSectionContent(text, sectionTitle) {
    const escapedTitle = sectionTitle.replace(/[()ã€ã€‘]/g, '\\$&');
    const regex = new RegExp(`${escapedTitle}[ï¼‰ã€‘]?\\s*([\\s\\S]*?)(?=ã€|$)`);
    const match = text.match(regex);
    const content = match ? match[1].trim() : '';
    console.log(`Extracting "${sectionTitle}": found ${content.length} chars`);
    return content || '-';
}

function formatReportContent(report) {
    const info = report.client_info;
    const conceptText = report.conceptualization || '';
    const isEnhanced = conceptText.includes('ã€ä¸€ã€æ¡ˆä¸»åŸºæœ¬è³‡æ–™ã€‘') || conceptText.includes('ã€äºŒã€ä¸»è¨´å•é¡Œã€‘');

    let html = '<div class="space-y-6 max-h-[600px] overflow-y-auto">';

    // Client Info Table
    html += `
        <div>
            <h4 class="text-lg font-semibold text-white mb-3">ä¸€ã€æ¡ˆä¸»åŸºæœ¬è³‡æ–™</h4>
            <table class="w-full border-collapse border border-gray-600 text-sm">
                <tr>
                    <td class="border border-gray-600 px-3 py-2 bg-gray-700 text-gray-300 font-semibold w-1/4">å§“å(åŒ–å)</td>
                    <td class="border border-gray-600 px-3 py-2 text-white">${info.name || '-'}</td>
                    <td class="border border-gray-600 px-3 py-2 bg-gray-700 text-gray-300 font-semibold w-1/4">æ€§åˆ¥</td>
                    <td class="border border-gray-600 px-3 py-2 text-white">${info.gender || '-'}</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 px-3 py-2 bg-gray-700 text-gray-300 font-semibold">å¹´ç´€</td>
                    <td class="border border-gray-600 px-3 py-2 text-white">${info.age || '-'}</td>
                    <td class="border border-gray-600 px-3 py-2 bg-gray-700 text-gray-300 font-semibold">è·æ¥­</td>
                    <td class="border border-gray-600 px-3 py-2 text-white">${info.occupation || '-'}</td>
                </tr>
            </table>
        </div>
    `;

    // Conceptualization Section
    html += '<div>';
    if (isEnhanced) {
        // Enhanced 10-section version
        const sections = [
            { title: 'äºŒã€ä¸»è¨´å•é¡Œ', key: 'ã€äºŒã€ä¸»è¨´å•é¡Œã€‘' },
            { title: 'ä¸‰ã€å•é¡Œç™¼å±•è„ˆçµ¡', key: 'ã€ä¸‰ã€å•é¡Œç™¼å±•è„ˆçµ¡ã€‘' },
            { title: 'å››ã€æ±‚åŠ©å‹•æ©Ÿèˆ‡æœŸå¾…', key: 'ã€å››ã€æ±‚åŠ©å‹•æ©Ÿèˆ‡æœŸå¾…ã€‘' },
            { title: 'äº”ã€å¤šå±¤æ¬¡å› ç´ åˆ†æ', key: 'ã€äº”ã€å¤šå±¤æ¬¡å› ç´ åˆ†æã€‘' },
            { title: 'å…­ã€å€‹æ¡ˆå„ªå‹¢èˆ‡è³‡æº', key: 'ã€å…­ã€å€‹æ¡ˆå„ªå‹¢èˆ‡è³‡æºã€‘' },
            { title: 'ä¸ƒã€è«®è©¢å¸«çš„å°ˆæ¥­åˆ¤æ–·', key: 'ã€ä¸ƒã€è«®è©¢å¸«çš„å°ˆæ¥­åˆ¤æ–·ã€‘' },
            { title: 'å…«ã€è«®å•†ç›®æ¨™èˆ‡ä»‹å…¥ç­–ç•¥', key: 'ã€å…«ã€è«®å•†ç›®æ¨™èˆ‡ä»‹å…¥ç­–ç•¥ã€‘' },
            { title: 'ä¹ã€é æœŸæˆæ•ˆèˆ‡è©•ä¼°', key: 'ã€ä¹ã€é æœŸæˆæ•ˆèˆ‡è©•ä¼°ã€‘' },
            { title: 'åã€è«®è©¢å¸«è‡ªæˆ‘åæ€', key: 'ã€åã€è«®è©¢å¸«è‡ªæˆ‘åæ€ã€‘' }
        ];

        html += '<h4 class="text-lg font-semibold text-white mb-3">æ¦‚å¿µåŒ–åˆ†æï¼ˆå¢å¼·ç‰ˆ 10 æ®µå¼ï¼‰</h4>';
        html += '<table class="w-full border-collapse border border-gray-600 text-sm">';

        sections.forEach(section => {
            const content = extractSectionContent(conceptText, section.key);
            html += `
                <tr>
                    <td class="border border-gray-600 px-3 py-2 bg-gray-700 text-gray-300 font-semibold w-1/4">${section.title}</td>
                    <td class="border border-gray-600 px-3 py-2 text-white whitespace-pre-wrap">${content}</td>
                </tr>
            `;
        });

        html += '</table>';
    } else {
        // Legacy 5-section version
        const sections = [
            { title: 'ä¸»è¨´å•é¡Œ', key: 'ã€ä¸»è¨´å•é¡Œã€‘' },
            { title: 'æˆå› åˆ†æ', key: 'ã€æˆå› åˆ†æã€‘' },
            { title: 'æ™¤è«‡ç›®æ¨™ï¼ˆç§»å‹•ä¸»è¨´ï¼‰', key: 'ã€æ™¤è«‡ç›®æ¨™' },
            { title: 'ä»‹å…¥ç­–ç•¥', key: 'ã€ä»‹å…¥ç­–ç•¥ã€‘' },
            { title: 'ç›®å‰æˆæ•ˆè©•ä¼°', key: 'ã€ç›®å‰æˆæ•ˆè©•ä¼°ã€‘' }
        ];

        html += '<h4 class="text-lg font-semibold text-white mb-3">æ¦‚å¿µåŒ–åˆ†æï¼ˆèˆŠç‰ˆ 5 æ®µå¼ï¼‰</h4>';
        html += '<table class="w-full border-collapse border border-gray-600 text-sm">';

        sections.forEach(section => {
            const content = extractSectionContent(conceptText, section.key);
            html += `
                <tr>
                    <td class="border border-gray-600 px-3 py-2 bg-gray-700 text-gray-300 font-semibold w-1/4">${section.title}</td>
                    <td class="border border-gray-600 px-3 py-2 text-white whitespace-pre-wrap">${content}</td>
                </tr>
            `;
        });

        html += '</table>';
    }
    html += '</div>';

    html += '</div>';
    return html;
}

function generateComparisonTable(legacyReport, enhancedReport, legacyQuality, enhancedQuality) {
    // Extract actual report content for evidence-based comparison
    const legacyText = legacyReport.conceptualization || '';
    const enhancedText = enhancedReport.conceptualization || '';

    // Extract real sections from reports for rubrics validation
    const extractSection = (text, sectionTitle) => {
        const regex = new RegExp(`ã€${sectionTitle}ã€‘([^ã€]+)`, 's');
        const match = text.match(regex);
        return match ? match[1].trim().substring(0, 200) + '...' : 'ï¼ˆæœªæ‰¾åˆ°æ­¤æ®µè½ï¼‰';
    };

    // Get actual missing sections from quality summary
    const legacyMissing = legacyQuality?.structure_quality?.missing_sections || [];
    const enhancedMissing = enhancedQuality?.structure_quality?.missing_sections || [];

    // Extract real citation examples from critical sections
    const extractCitation = (text, sectionNum) => {
        const sectionNames = {
            5: 'äº”ã€å¤šå±¤æ¬¡å› ç´ åˆ†æ',
            7: 'ä¸ƒã€è«®è©¢å¸«çš„å°ˆæ¥­åˆ¤æ–·',
            8: 'å…«ã€è«®å•†ç›®æ¨™èˆ‡ä»‹å…¥ç­–ç•¥'
        };
        const section = extractSection(text, sectionNames[sectionNum]);
        const citationMatch = section.match(/[^ã€‚]*\[\d+\][^ã€‚]{0,100}/);
        return citationMatch ? citationMatch[0] : section.substring(0, 150) + '...';
    };

    // Check if citations have rationale (actual text analysis)
    const hasRationale = (text) => {
        const rationaleKeywords = ['æ ¹æ“š', 'åŸºæ–¼', 'å¾', 'ç†è«–æŒ‡å‡º', 'é¡¯ç¤º', 'è§€é»', 'ä¾æ“š'];
        return rationaleKeywords.some(kw => text.includes(kw));
    };

    const legacyHasRationale = hasRationale(legacyText);
    const enhancedHasRationale = hasRationale(enhancedText);

    const tableHTML = `
        <!-- Summary Cards -->
        <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="bg-gradient-to-br from-red-900/30 to-gray-800 rounded-lg p-4 border-2 border-red-500/50">
                <div class="text-red-400 text-xs mb-1">èˆŠç‰ˆå•é¡Œ</div>
                <div class="text-white text-2xl font-bold mb-2">3 å€‹</div>
                <div class="text-gray-400 text-xs">çµæ§‹ä¸å®Œæ•´ã€ç„¡ç†ç”±èªªæ˜ã€ç„¡å“è³ªé©—è­‰</div>
            </div>
            <div class="bg-gradient-to-br from-blue-900/30 to-gray-800 rounded-lg p-4 border-2 border-blue-500/50">
                <div class="text-blue-400 text-xs mb-1">æ–°ç‰ˆæ”¹å–„</div>
                <div class="text-white text-2xl font-bold mb-2">6 é …</div>
                <div class="text-gray-400 text-xs">å®Œæ•´çµæ§‹ã€ç†è«–èªªæ˜ã€å“è³ªè©•åˆ†ã€å¢å¼·æª¢ç´¢ã€ç¯„ä¾‹å¼•å°</div>
            </div>
            <div class="bg-gradient-to-br from-green-900/30 to-gray-800 rounded-lg p-4 border-2 border-green-500/50">
                <div class="text-green-400 text-xs mb-1">å“è³ªæå‡</div>
                <div class="text-white text-2xl font-bold mb-2">${(legacyQuality && enhancedQuality) ? '+' + (enhancedQuality.overall_score - legacyQuality.overall_score).toFixed(0) : 'N/A'} åˆ†</div>
                <div class="text-gray-400 text-xs">${legacyQuality ? legacyQuality.grade : ''} â†’ ${enhancedQuality ? enhancedQuality.grade : ''}</div>
            </div>
        </div>

        <!-- Visual Comparison -->
        <div class="mb-6">
            <h4 class="text-white font-semibold mb-4 text-lg">ğŸ“Š è¦–è¦ºåŒ–å°æ¯”</h4>
            <div class="grid grid-cols-2 gap-6">
                <!-- Legacy Version Visualization -->
                <div class="bg-gray-900/50 rounded-lg p-4">
                    <div class="text-center text-gray-300 font-semibold mb-3">ğŸ“„ èˆŠç‰ˆæ¶æ§‹</div>
                    <div class="space-y-2">
                        <div class="bg-gray-700 rounded px-3 py-2 text-gray-400 text-sm">1. ä¸»è¨´å•é¡Œ</div>
                        <div class="bg-gray-700 rounded px-3 py-2 text-gray-400 text-sm">2. æˆå› åˆ†æ</div>
                        <div class="bg-gray-700 rounded px-3 py-2 text-gray-400 text-sm">3. æ™¤è«‡ç›®æ¨™</div>
                        <div class="bg-gray-700 rounded px-3 py-2 text-gray-400 text-sm">4. ä»‹å…¥ç­–ç•¥</div>
                        <div class="bg-gray-700 rounded px-3 py-2 text-gray-400 text-sm">5. æˆæ•ˆè©•ä¼°</div>
                        <div class="text-center text-red-400 text-xs mt-3">âŒ ç¼ºå°‘ 5 å€‹æ®µè½</div>
                    </div>
                </div>

                <!-- Enhanced Version Visualization -->
                <div class="bg-gray-900/50 rounded-lg p-4">
                    <div class="text-center text-blue-400 font-semibold mb-3">âœ¨ æ–°ç‰ˆæ¶æ§‹</div>
                    <div class="space-y-2">
                        <div class="bg-blue-800/30 rounded px-3 py-2 text-white text-sm border border-blue-500/30">1. æ¡ˆä¸»åŸºæœ¬è³‡æ–™</div>
                        <div class="bg-blue-800/30 rounded px-3 py-2 text-white text-sm border border-blue-500/30">2. ä¸»è¨´å•é¡Œ</div>
                        <div class="bg-blue-800/30 rounded px-3 py-2 text-white text-sm border border-blue-500/30">3. å•é¡Œç™¼å±•è„ˆçµ¡</div>
                        <div class="bg-blue-800/30 rounded px-3 py-2 text-white text-sm border border-blue-500/30">4. æ±‚åŠ©å‹•æ©Ÿ</div>
                        <div class="bg-blue-800/50 rounded px-3 py-2 text-white text-sm border-2 border-blue-400">5. å¤šå±¤æ¬¡åˆ†æ â­</div>
                        <div class="bg-blue-800/30 rounded px-3 py-2 text-white text-sm border border-blue-500/30">6. å„ªå‹¢è³‡æº</div>
                        <div class="bg-blue-800/50 rounded px-3 py-2 text-white text-sm border-2 border-blue-400">7. å°ˆæ¥­åˆ¤æ–· â­</div>
                        <div class="bg-blue-800/50 rounded px-3 py-2 text-white text-sm border-2 border-blue-400">8. ç›®æ¨™ç­–ç•¥ â­</div>
                        <div class="bg-blue-800/30 rounded px-3 py-2 text-white text-sm border border-blue-500/30">9. æˆæ•ˆè©•ä¼°</div>
                        <div class="bg-blue-800/30 rounded px-3 py-2 text-white text-sm border border-blue-500/30">10. è‡ªæˆ‘åæ€</div>
                        <div class="text-center text-green-400 text-xs mt-3">âœ… 100% å®Œæ•´çµæ§‹</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Citation Quality Comparison -->
        <div class="mb-6">
            <h4 class="text-white font-semibold mb-4 text-lg">ğŸ“š ç†è«–å¼•ç”¨å“è³ªå°æ¯”</h4>
            <div class="grid grid-cols-2 gap-6">
                <!-- Legacy Citation Example -->
                <div class="bg-red-900/20 rounded-lg p-4 border-2 border-red-500/50">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-red-400 text-lg">âŒ</span>
                        <span class="text-gray-300 font-semibold">èˆŠç‰ˆå¼•ç”¨æ–¹å¼</span>
                    </div>
                    <div class="bg-gray-900/50 rounded p-3 mb-3">
                        <div class="text-gray-400 text-sm font-mono leading-relaxed">
                            ${extractCitation(legacyText, 5).substring(0, 150)}...
                        </div>
                    </div>
                    <div class="space-y-1 text-xs">
                        <div class="text-red-300">âš ï¸ åªæœ‰ç·¨è™Ÿ [1]ï¼Œç„¡ç†è«–èªªæ˜</div>
                        <div class="text-red-300">âš ï¸ çœ‹ä¸å‡ºç‚ºä½•é©ç”¨æ­¤ç†è«–</div>
                        <div class="text-red-300">âš ï¸ ç„¡æ³•å­¸ç¿’ç†è«–æ‡‰ç”¨é‚è¼¯</div>
                    </div>
                </div>

                <!-- Enhanced Citation Example -->
                <div class="bg-blue-900/20 rounded-lg p-4 border-2 border-blue-500/50">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-blue-400 text-lg">âœ…</span>
                        <span class="text-white font-semibold">æ–°ç‰ˆå¼•ç”¨æ–¹å¼</span>
                    </div>
                    <div class="bg-gray-900/50 rounded p-3 mb-3">
                        <div class="text-white text-sm font-mono leading-relaxed">
                            ${extractCitation(enhancedText, 5).substring(0, 150)}...
                        </div>
                    </div>
                    <div class="space-y-1 text-xs">
                        <div class="text-blue-300">âœ“ èªªæ˜ç†è«–å…§å®¹</div>
                        <div class="text-blue-300">âœ“ é€£çµå€‹æ¡ˆæƒ…æ³</div>
                        <div class="text-blue-300">âœ“ æ¨è«–çµè«–</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Comparison Table -->
        <div class="overflow-x-auto">
            <h4 class="text-white font-semibold mb-4 text-lg">ğŸ” è©³ç´°åŠŸèƒ½æ¯”è¼ƒï¼ˆé»æ“Šã€Œè©³ç´°èªªæ˜ã€æŸ¥çœ‹æ¡ˆä¾‹ï¼‰</h4>
            <table class="w-full border-collapse border border-gray-600">
                <thead>
                    <tr class="bg-gray-700">
                        <th class="border border-gray-600 px-4 py-3 text-white w-1/5">æ”¹å–„é …ç›®</th>
                        <th class="border border-gray-600 px-4 py-3 text-gray-300 w-1/5">ğŸ“„ èˆŠç‰ˆå•é¡Œ</th>
                        <th class="border border-gray-600 px-4 py-3 text-blue-400 w-1/5">âœ¨ æ–°ç‰ˆæ”¹å–„</th>
                        <th class="border border-gray-600 px-4 py-3 text-green-400 w-1/6">æ•ˆæœ</th>
                        <th class="border border-gray-600 px-4 py-3 text-yellow-400 w-1/5">è©³ç´°èªªæ˜</th>
                    </tr>
                </thead>
                <tbody class="text-sm">
                    <tr>
                        <td class="border border-gray-600 px-4 py-2 font-semibold text-gray-300">
                            <div>æ•´é«”å“è³ªè©•åˆ†</div>
                            <div class="text-gray-500 text-xs mt-1">å€‹æ¡ˆæ¦‚å¿µåŒ–èƒ½åŠ›è©•é‡è¡¨ï¼ˆ8å‘åº¦ï¼‰</div>
                        </td>
                        <td class="border border-gray-600 px-4 py-2 text-gray-400">
                            <div class="font-semibold">${legacyQuality ? legacyQuality.overall_score : 'N/A'} / 100</div>
                            <div class="text-red-400 text-xs mt-1">
                                ${legacyQuality ? legacyQuality.grade : 'N/A'}
                            </div>
                        </td>
                        <td class="border border-gray-600 px-4 py-2 text-white">
                            <div class="font-semibold">${enhancedQuality ? enhancedQuality.overall_score : 'N/A'} / 100</div>
                            <div class="text-${enhancedQuality && enhancedQuality.overall_score >= 90 ? 'green' : 'yellow'}-400 text-xs mt-1">
                                ${enhancedQuality ? enhancedQuality.grade : 'N/A'}
                            </div>
                        </td>
                        <td class="border border-gray-600 px-4 py-2 text-green-400">
                            ${legacyQuality && enhancedQuality ? `+${(enhancedQuality.overall_score - legacyQuality.overall_score).toFixed(1)} åˆ†` : 'N/A'}
                        </td>
                        <td class="border border-gray-600 px-4 py-2">
                            <button onclick="toggleDetailRow('detail-structure')" class="text-yellow-400 hover:text-yellow-300 underline text-xs">
                                é»æ“ŠæŸ¥çœ‹è­‰æ“š â–¼
                            </button>
                        </td>
                    </tr>
                    <tr id="detail-structure" class="hidden">
                        <td colspan="5" class="border border-gray-600 px-6 py-4 bg-gray-900/50">
                            <div class="space-y-3 text-sm">
                                <div class="text-yellow-400 font-semibold">ğŸ“‹ è©•åˆ†ä¾æ“šï¼šå€‹æ¡ˆæ¦‚å¿µåŒ–èƒ½åŠ›è©•é‡è¡¨ï¼ˆ8å‘åº¦ï¼‰</div>
                                <div class="text-gray-300 text-xs">
                                    ä½¿ç”¨ GPT-4o ä¾ç…§å°ˆæ¥­ç£å°æ¨™æº–è©•åˆ†ï¼Œæ¨¡æ“¬çœŸå¯¦ç£å°å°å ±å‘Šçš„è©•åƒ¹
                                </div>

                                <div class="text-yellow-400 font-semibold mt-4">ğŸ” å…«å¤§å‘åº¦å¾—åˆ†æ¯”è¼ƒï¼š</div>
                                <div class="grid grid-cols-2 gap-4 mt-2">
                                    <div class="bg-red-900/20 border border-red-500/30 rounded p-3">
                                        <div class="text-red-400 font-semibold mb-2">ğŸ“Š èˆŠç‰ˆ (5æ®µå¼)</div>
                                        <div class="text-gray-300 text-xs space-y-1">
                                            ${legacyQuality ? `
                                                <div>å•é¡Œé™³è¿°ï¼š${legacyQuality.problem_clarity?.score || 0}/15</div>
                                                <div>å•é¡Œæ¼”è®Šï¼š${legacyQuality.problem_evolution?.score || 0}/15</div>
                                                <div>æ±‚åŠ©åŸå› ï¼š${legacyQuality.help_seeking?.score || 0}/10</div>
                                                <div>ç›¸é—œå› ç´ ï¼š${legacyQuality.related_factors?.score || 0}/25</div>
                                                <div>åŠŸèƒ½è©•ä¼°ï¼š${legacyQuality.function_assessment?.score || 0}/10</div>
                                                <div>å•é¡Œåˆ¤æ–·ï¼š${legacyQuality.problem_judgment?.score || 0}/10</div>
                                                <div>è«®å•†è¨ˆåŠƒï¼š${legacyQuality.counseling_plan?.score || 0}/10</div>
                                                <div>å¯¦æ–½è©•ä¼°ï¼š${legacyQuality.implementation_eval?.score || 0}/5</div>
                                                <div class="mt-2 pt-2 border-t border-red-500/30 font-semibold">ç¸½åˆ†ï¼š${legacyQuality.overall_score}/100</div>
                                            ` : 'N/A'}
                                        </div>
                                    </div>
                                    <div class="bg-blue-900/20 border border-blue-500/30 rounded p-3">
                                        <div class="text-blue-400 font-semibold mb-2">ğŸ“Š æ–°ç‰ˆ (10æ®µå¼)</div>
                                        <div class="text-gray-300 text-xs space-y-1">
                                            ${enhancedQuality ? `
                                                <div>å•é¡Œé™³è¿°ï¼š${enhancedQuality.problem_clarity?.score || 0}/15</div>
                                                <div>å•é¡Œæ¼”è®Šï¼š${enhancedQuality.problem_evolution?.score || 0}/15</div>
                                                <div>æ±‚åŠ©åŸå› ï¼š${enhancedQuality.help_seeking?.score || 0}/10</div>
                                                <div>ç›¸é—œå› ç´ ï¼š${enhancedQuality.related_factors?.score || 0}/25</div>
                                                <div>åŠŸèƒ½è©•ä¼°ï¼š${enhancedQuality.function_assessment?.score || 0}/10</div>
                                                <div>å•é¡Œåˆ¤æ–·ï¼š${enhancedQuality.problem_judgment?.score || 0}/10</div>
                                                <div>è«®å•†è¨ˆåŠƒï¼š${enhancedQuality.counseling_plan?.score || 0}/10</div>
                                                <div>å¯¦æ–½è©•ä¼°ï¼š${enhancedQuality.implementation_eval?.score || 0}/5</div>
                                                <div class="mt-2 pt-2 border-t border-blue-500/30 font-semibold text-green-300">ç¸½åˆ†ï¼š${enhancedQuality.overall_score}/100</div>
                                            ` : 'N/A'}
                                        </div>
                                    </div>
                                </div>

                                <div class="text-yellow-400 font-semibold mt-4">ğŸ’¡ LLM ç£å°è©•èªï¼š</div>
                                <div class="text-gray-300 italic text-xs bg-gray-800/50 p-3 rounded">
                                    ${enhancedQuality?.overall_feedback || 'è©•èªç”Ÿæˆä¸­...'}
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="border border-gray-600 px-4 py-2 font-semibold text-gray-300">çµæ§‹é©—è­‰</td>
                        <td class="border border-gray-600 px-4 py-2 text-gray-400">
                            <div>âŒ ç„¡é©—è­‰æ©Ÿåˆ¶</div>
                            <div class="text-red-400 text-xs mt-1">å¯èƒ½æ¼æ®µè½</div>
                        </td>
                        <td class="border border-gray-600 px-4 py-2 text-white">
                            <div>âœ… è‡ªå‹•æª¢æŸ¥ 10 å€‹æ®µè½</div>
                            <div class="text-blue-400 text-xs mt-1">ç¸½åˆ† ${enhancedQuality ? enhancedQuality.overall_score : 'N/A'}/100</div>
                        </td>
                        <td class="border border-gray-600 px-4 py-2 text-green-400">
                            é›¶éºæ¼
                        </td>
                        <td class="border border-gray-600 px-4 py-2">
                            <button onclick="toggleDetailRow('detail-validation')" class="text-yellow-400 hover:text-yellow-300 underline text-xs">
                                é»æ“ŠæŸ¥çœ‹ â–¼
                            </button>
                        </td>
                    </tr>
                    <tr id="detail-validation" class="hidden">
                        <td colspan="5" class="border border-gray-600 px-6 py-4 bg-gray-900/50">
                            <div class="space-y-3 text-sm">
                                <div class="text-yellow-400 font-semibold">ğŸ“Œ è‡ªå‹•é©—è­‰çš„é‡è¦æ€§</div>
                                <div class="text-gray-300">
                                    èˆŠç‰ˆæ²’æœ‰é©—è­‰æ©Ÿåˆ¶ï¼ŒAIå¯èƒ½ã€Œè¦ºå¾—ã€è‡ªå·±å¯«äº†10æ®µï¼Œä½†å¯¦éš›ä¸Šæ¼æ‰2-3æ®µã€‚æ–°ç‰ˆæœƒè‡ªå‹•æª¢æŸ¥æ‰€æœ‰å¿…è¦æ®µè½æ˜¯å¦å­˜åœ¨ï¼Œä¸¦çµ¦å‡ºçµæ§‹å®Œæ•´æ€§è©•åˆ†ï¼ˆ0-100%ï¼‰ã€‚
                                </div>
                                <div class="bg-gray-800/50 p-3 rounded text-xs">
                                    <div class="text-green-400">âœ… æ–°ç‰ˆé©—è­‰é‚è¼¯ï¼šä½¿ç”¨ã€Œå€‹æ¡ˆæ¦‚å¿µåŒ–èƒ½åŠ›è©•é‡è¡¨ã€8å‘åº¦è©•åˆ† â†’ ç¸½åˆ† ${enhancedQuality ? enhancedQuality.overall_score : 'N/A'}/100</div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="border border-gray-600 px-4 py-2 font-semibold text-gray-300">
                            <div>ç†è«–å¼•ç”¨èªªæ˜</div>
                            <div class="text-gray-500 text-xs mt-1">Rubrics: å¼•ç”¨å“è³ª</div>
                        </td>
                        <td class="border border-gray-600 px-4 py-2 text-gray-400">
                            <div class="font-semibold">${legacyHasRationale ? 'æœ‰èªªæ˜' : 'ç„¡èªªæ˜'}</div>
                            <div class="text-${legacyHasRationale ? 'green' : 'red'}-400 text-xs mt-1">
                                ${legacyHasRationale ? 'âœ… æœ‰ã€Œæ ¹æ“š/åŸºæ–¼ã€é—œéµè©' : 'âŒ åªæœ‰ [1][2] ç·¨è™Ÿ'}
                            </div>
                        </td>
                        <td class="border border-gray-600 px-4 py-2 text-white">
                            <div class="font-semibold">${enhancedHasRationale ? 'æœ‰èªªæ˜' : 'ç„¡èªªæ˜'}</div>
                            <div class="text-${enhancedHasRationale ? 'green' : 'red'}-400 text-xs mt-1">
                                ${enhancedHasRationale ? 'âœ… æœ‰ç†è«–èªªæ˜æ–‡å­—' : 'âŒ ç„¡ç†è«–èªªæ˜'}
                            </div>
                        </td>
                        <td class="border border-gray-600 px-4 py-2 text-green-400">
                            ${enhancedHasRationale && !legacyHasRationale ? '+10 åˆ†' : (enhancedHasRationale ? 'æŒå¹³' : '-10 åˆ†')}
                        </td>
                        <td class="border border-gray-600 px-4 py-2">
                            <button onclick="toggleDetailRow('detail-citation')" class="text-yellow-400 hover:text-yellow-300 underline text-xs">
                                é»æ“ŠæŸ¥çœ‹è­‰æ“š â–¼
                            </button>
                        </td>
                    </tr>
                    <tr id="detail-citation" class="hidden">
                        <td colspan="5" class="border border-gray-600 px-6 py-4 bg-gray-900/50">
                            <div class="space-y-3 text-sm">
                                <div class="text-yellow-400 font-semibold">ğŸ“‹ Rubrics åˆ¤æ–·ä¾æ“šï¼šå¼•ç”¨å“è³ªï¼ˆ20åˆ†ï¼‰</div>
                                <div class="text-gray-300 text-xs">
                                    ç³»çµ±æª¢æŸ¥å ±å‘Šæ˜¯å¦åŒ…å«ã€Œæ ¹æ“š/åŸºæ–¼/å¾ã€ç­‰èªªæ˜ç†ç”±çš„é—œéµè©ï¼ˆ10åˆ†ï¼‰+ å¼•ç”¨æ•¸é‡é©ä¸­ï¼ˆ10åˆ†ï¼‰
                                </div>

                                <div class="text-yellow-400 font-semibold mt-4">ğŸ” çœŸå¯¦åˆ¤æ–·çµæœï¼ˆä¾†è‡ªæœ¬æ¬¡å ±å‘Šï¼‰ï¼š</div>
                                <div class="space-y-3 mt-2">
                                    <div class="bg-red-900/20 border border-red-500/30 rounded p-3">
                                        <div class="text-red-400 font-semibold mb-2">âŒ èˆŠç‰ˆæª¢æŸ¥çµæœ</div>
                                        <div class="text-gray-300 text-xs">
                                            <strong>æœ‰èªªæ˜ç†ç”±ï¼š</strong>${legacyHasRationale ? 'æ˜¯' : 'å¦'} ${legacyHasRationale ? '(+10åˆ†)' : '(+0åˆ†)'}<br>
                                            <strong>å¼•ç”¨æ•¸é‡ï¼š</strong>${legacyQuality?.citation_quality?.total_citations || 0} å€‹<br><br>
                                            <div class="text-gray-400 font-mono text-xs mt-2 bg-gray-900/50 p-2 rounded max-h-32 overflow-y-auto">
                                                ${extractCitation(legacyText, 5).substring(0, 200)}...
                                            </div>
                                            ${!legacyHasRationale ? '<div class="text-red-300 mt-2">âœ å•é¡Œï¼šåªæœ‰ [1][2] ç·¨è™Ÿï¼Œæ²’æœ‰èªªæ˜ç‚ºä»€éº¼ç”¨é€™å€‹ç†è«–</div>' : ''}
                                        </div>
                                    </div>

                                    <div class="bg-blue-900/20 border border-blue-500/30 rounded p-3">
                                        <div class="text-blue-400 font-semibold mb-2">âœ… æ–°ç‰ˆæª¢æŸ¥çµæœ</div>
                                        <div class="text-gray-300 text-xs">
                                            <strong>æœ‰èªªæ˜ç†ç”±ï¼š</strong>${enhancedHasRationale ? 'æ˜¯' : 'å¦'} ${enhancedHasRationale ? '(+10åˆ†)' : '(+0åˆ†)'}<br>
                                            <strong>å¼•ç”¨æ•¸é‡ï¼š</strong>${enhancedQuality?.citation_quality?.total_citations || 0} å€‹<br><br>
                                            <div class="text-gray-300 font-mono text-xs mt-2 bg-gray-900/50 p-2 rounded max-h-32 overflow-y-auto">
                                                ${extractCitation(enhancedText, 5).substring(0, 200)}...
                                            </div>
                                            ${enhancedHasRationale ? '<div class="text-green-300 mt-2">âœ æ”¹å–„ï¼šæ˜ç¢ºèªªæ˜ç†è«–åç¨±å’Œæ‡‰ç”¨ç†ç”±</div>' : ''}
                                        </div>
                                    </div>
                                </div>

                                <div class="text-yellow-400 font-semibold mt-4">âš™ï¸ ç³»çµ±åˆ¤æ–·é‚è¼¯ï¼ˆvalidate_citationsï¼‰ï¼š</div>
                                <div class="bg-gray-800/50 p-3 rounded text-xs font-mono text-gray-300">
                                    1. æœå°‹é—œéµè©ï¼šã€Œæ ¹æ“šã€ã€ŒåŸºæ–¼ã€ã€Œå¾ã€ã€Œç†è«–æŒ‡å‡ºã€ã€Œé¡¯ç¤ºã€ã€Œè§€é»ã€ã€Œä¾æ“šã€<br>
                                    2. æ‰¾åˆ°ä»»ä¸€é—œéµè© â†’ has_rationale = True (+10åˆ†)<br>
                                    3. æœªæ‰¾åˆ° â†’ has_rationale = False (+0åˆ†)<br>
                                    4. è¨ˆç®—å¼•ç”¨æ•¸é‡ï¼šæœå°‹ [æ•¸å­—] æ ¼å¼<br>
                                    5. å¼•ç”¨æ•¸é‡ / 7 Ã— 10 = å¼•ç”¨æ•¸é‡åˆ†æ•¸ï¼ˆæœ€é«˜10åˆ†ï¼‰<br>
                                    6. has_rationale åˆ†æ•¸ + å¼•ç”¨æ•¸é‡åˆ†æ•¸ = å¼•ç”¨å“è³ªåˆ†æ•¸ï¼ˆæœ€é«˜20åˆ†ï¼‰
                                </div>

                                <div class="text-yellow-400 font-semibold mt-4">ğŸ’¡ å°ˆå®¶è©•èªï¼š</div>
                                <div class="text-gray-300 italic text-xs bg-gray-800/50 p-3 rounded">
                                    "${legacyHasRationale ? 'èˆŠç‰ˆæœ‰ç†è«–èªªæ˜é—œéµè©ï¼Œå°šå¯ã€‚' : 'èˆŠç‰ˆåªæœ‰ [1][2] ç·¨è™Ÿï¼Œç„¡æ³•çœ‹å‡ºç†è«–æ‡‰ç”¨é‚è¼¯ã€‚'}æ–°ç‰ˆ${enhancedHasRationale ? 'æ˜ç¢ºèªªæ˜ç†è«–ä¾æ“šï¼Œå±•ç¾å°ˆæ¥­æ€è€ƒéç¨‹' : 'ä»éœ€æ”¹é€²ç†è«–èªªæ˜'}ã€‚"
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="border border-gray-600 px-4 py-2 font-semibold text-gray-300">RAG æª¢ç´¢</td>
                        <td class="border border-gray-600 px-4 py-2 text-gray-400">
                            <div>ç°¡å–®é—œéµè©æ‹¼æ¥</div>
                            <div class="text-gray-500 text-xs mt-1 font-mono">ã€Œè·æ¶¯è¿·èŒ« å·¥ä½œå€¦æ€ ã€</div>
                        </td>
                        <td class="border border-gray-600 px-4 py-2 text-white">
                            <div>çµæ§‹åŒ–æŸ¥è©¢ï¼ˆå¹´é½¡+éšæ®µ+ä¸»è¨´ï¼‰</div>
                            <div class="text-blue-400 text-xs mt-1 font-mono">ã€Œå»ºç«‹æœŸ 28æ­² å¥³æ€§ ç¢©å£« è·æ¶¯è¿·èŒ«ã€</div>
                        </td>
                        <td class="border border-gray-600 px-4 py-2 text-green-400">
                            ç›¸é—œæ€§ â†‘
                        </td>
                        <td class="border border-gray-600 px-4 py-2">
                            <button onclick="toggleDetailRow('detail-rag')" class="text-yellow-400 hover:text-yellow-300 underline text-xs">
                                é»æ“ŠæŸ¥çœ‹ â–¼
                            </button>
                        </td>
                    </tr>
                    <tr id="detail-rag" class="hidden">
                        <td colspan="5" class="border border-gray-600 px-6 py-4 bg-gray-900/50">
                            <div class="space-y-3 text-sm">
                                <div class="text-yellow-400 font-semibold">ğŸ“Œ çµæ§‹åŒ–æŸ¥è©¢çš„å„ªå‹¢</div>
                                <div class="text-gray-300">
                                    æ–°ç‰ˆæœƒæ ¹æ“šæ¡ˆä¸»å¹´é½¡è‡ªå‹•åˆ¤æ–·ç”Ÿæ¶¯éšæ®µï¼ˆå»ºç«‹æœŸ/ç¶­æŒæœŸç­‰ï¼‰ï¼Œä¸¦å°‡ã€Œå¹´é½¡+éšæ®µ+å­¸æ­·+ä¸»è¨´ã€çµ„åˆæˆçµæ§‹åŒ–æŸ¥è©¢ï¼Œå¤§å¹…æå‡ç†è«–åŒ¹é…ç²¾æº–åº¦ã€‚
                                </div>
                                <div class="grid grid-cols-2 gap-3 mt-2">
                                    <div class="bg-red-900/20 border border-red-500/30 rounded p-2 text-xs">
                                        <div class="text-red-400 font-semibold">âŒ èˆŠç‰ˆæŸ¥è©¢</div>
                                        <div class="text-gray-400 font-mono mt-1">"è·æ¶¯è¿·èŒ« å·¥ä½œå€¦æ€ "</div>
                                        <div class="text-gray-500 mt-1">â†’ å¯èƒ½åŒ¹é…åˆ°é«˜ä¸­ç”Ÿã€é€€ä¼‘æ—çš„æ¡ˆä¾‹</div>
                                    </div>
                                    <div class="bg-blue-900/20 border border-blue-500/30 rounded p-2 text-xs">
                                        <div class="text-blue-400 font-semibold">âœ… æ–°ç‰ˆæŸ¥è©¢</div>
                                        <div class="text-gray-300 font-mono mt-1">"å»ºç«‹æœŸ 28æ­² å¥³æ€§ ç¢©å£« è·æ¶¯è¿·èŒ«"</div>
                                        <div class="text-green-400 mt-1">â†’ ç²¾æº–åŒ¹é…åŒé½¡ã€åŒéšæ®µæ¡ˆä¾‹</div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="border border-gray-600 px-4 py-2 font-semibold text-gray-300">å“è³ªè©•åˆ†</td>
                        <td class="border border-gray-600 px-4 py-2 text-gray-400">
                            <div>âŒ ç„¡è©•åˆ†æ©Ÿåˆ¶</div>
                            <div class="text-red-400 text-xs mt-1">ç„¡æ³•é‡åŒ–å“è³ª</div>
                        </td>
                        <td class="border border-gray-600 px-4 py-2 text-white">
                            <div>âœ… è‡ªå‹•è©•åˆ† 0-100</div>
                            <div class="text-blue-400 text-xs mt-1">çµæ§‹(40%)+å¼•ç”¨è¦†è“‹(40%)+å¼•ç”¨å“è³ª(20%)</div>
                        </td>
                        <td class="border border-gray-600 px-4 py-2 text-green-400">
                            å¯è¡¡é‡
                        </td>
                        <td class="border border-gray-600 px-4 py-2">
                            <button onclick="toggleDetailRow('detail-scoring')" class="text-yellow-400 hover:text-yellow-300 underline text-xs">
                                é»æ“ŠæŸ¥çœ‹ â–¼
                            </button>
                        </td>
                    </tr>
                    <tr id="detail-scoring" class="hidden">
                        <td colspan="5" class="border border-gray-600 px-6 py-4 bg-gray-900/50">
                            <div class="space-y-3 text-sm">
                                <div class="text-yellow-400 font-semibold">ğŸ“Œ è©•åˆ†æ©Ÿåˆ¶èªªæ˜</div>
                                <div class="text-gray-300">
                                    æ–°ç‰ˆæä¾›é€æ˜çš„è©•åˆ†æ¨™æº–ï¼Œè®“æ–°æ‰‹è«®è©¢å¸«çŸ¥é“ã€Œå“ªè£¡åšå¾—å¥½ã€ã€ã€Œå“ªè£¡éœ€è¦æ”¹é€²ã€ã€‚
                                </div>
                                <div class="bg-gray-800/50 p-3 rounded text-xs">
                                    <div class="text-white font-semibold mb-2">è©•åˆ†å…¬å¼ï¼š</div>
                                    <div class="text-gray-300">
                                        â€¢ <strong class="text-blue-400">çµæ§‹å®Œæ•´æ€§ 40%</strong>ï¼š10å€‹æ®µè½éƒ½æœ‰ = 40åˆ†<br>
                                        â€¢ <strong class="text-green-400">å¼•ç”¨è¦†è“‹ç‡ 40%</strong>ï¼šç¬¬5ã€7ã€8æ®µéƒ½æœ‰å¼•ç”¨ = 40åˆ†<br>
                                        â€¢ <strong class="text-yellow-400">å¼•ç”¨å“è³ª 20%</strong>ï¼šæœ‰èªªæ˜ç†ç”±(10%) + å¼•ç”¨æ•¸é‡é©ä¸­(10%)<br>
                                        <div class="mt-2 text-green-400">ç¯„ä¾‹ï¼šçµæ§‹100% (40åˆ†) + å¼•ç”¨3/3 (40åˆ†) + æœ‰ç†ç”±+5å€‹å¼•ç”¨ (17åˆ†) = <strong>97åˆ†ï¼ˆå„ªç§€ï¼‰</strong></div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="border border-gray-600 px-4 py-2 font-semibold text-gray-300">é—œéµæ®µè½æª¢æŸ¥</td>
                        <td class="border border-gray-600 px-4 py-2 text-gray-400">
                            <div>ç„¡ç‰¹åˆ¥è¦æ±‚</div>
                        </td>
                        <td class="border border-gray-600 px-4 py-2 text-white">
                            <div>å¼·åˆ¶æª¢æŸ¥ç¬¬ 5ã€7ã€8 æ®µ</div>
                            <div class="text-blue-400 text-xs mt-1">æ ¸å¿ƒæ®µè½å¿…é ˆæœ‰ç†è«–æ”¯æ’</div>
                        </td>
                        <td class="border border-gray-600 px-4 py-2 text-green-400">
                            å°ˆæ¥­åº¦ â†‘
                        </td>
                        <td class="border border-gray-600 px-4 py-2">
                            <button onclick="toggleDetailRow('detail-critical')" class="text-yellow-400 hover:text-yellow-300 underline text-xs">
                                é»æ“ŠæŸ¥çœ‹ â–¼
                            </button>
                        </td>
                    </tr>
                    <tr id="detail-critical" class="hidden">
                        <td colspan="5" class="border border-gray-600 px-6 py-4 bg-gray-900/50">
                            <div class="space-y-3 text-sm">
                                <div class="text-yellow-400 font-semibold">ğŸ“Œ ç‚ºä»€éº¼ç‰¹åˆ¥æª¢æŸ¥ç¬¬5ã€7ã€8æ®µï¼Ÿ</div>
                                <div class="text-gray-300">
                                    æ ¹æ“šè©•å¯© rubricsï¼Œé€™ä¸‰å€‹æ®µè½æ˜¯<strong class="text-yellow-400">ã€Œå±•ç¾å°ˆæ¥­åˆ¤æ–·ã€</strong>çš„æ ¸å¿ƒæ®µè½ï¼Œå¿…é ˆæœ‰ç†è«–æ”¯æ’æ‰ç®—å°ˆæ¥­å ±å‘Šã€‚
                                </div>
                                <div class="bg-gray-800/50 p-3 rounded text-xs">
                                    <div class="space-y-2">
                                        <div>
                                            <strong class="text-blue-400">ã€äº”ã€å¤šå±¤æ¬¡å› ç´ åˆ†æã€‘â­</strong><br>
                                            <span class="text-gray-400">ç†ç”±ï¼šéœ€è¦ç”¨ç†è«–æ¡†æ¶ï¼ˆå¦‚ç”Ÿæ…‹ç³»çµ±ç†è«–ï¼‰åˆ†æå€‹äºº/ç’°å¢ƒ/æ™‚é–“å› ç´ </span>
                                        </div>
                                        <div>
                                            <strong class="text-blue-400">ã€ä¸ƒã€è«®è©¢å¸«çš„å°ˆæ¥­åˆ¤æ–·ã€‘â­</strong><br>
                                            <span class="text-gray-400">ç†ç”±ï¼šåˆ¤æ–·éœ€è¦ç†è«–ä¾æ“šï¼ˆå¦‚Superç†è«–åˆ¤æ–·ç”Ÿæ¶¯éšæ®µï¼‰</span>
                                        </div>
                                        <div>
                                            <strong class="text-blue-400">ã€å…«ã€è«®å•†ç›®æ¨™èˆ‡ä»‹å…¥ç­–ç•¥ã€‘â­</strong><br>
                                            <span class="text-gray-400">ç†ç”±ï¼šä»‹å…¥ç­–ç•¥éœ€è¦å¼•ç”¨æŠ€è¡“æ–‡ç»ï¼ˆå¦‚èªçŸ¥é‡æ§‹ã€è·æ¶¯æ¢ç´¢å¡ï¼‰</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr class="bg-gray-800">
                        <td class="border border-gray-600 px-4 py-3 font-bold text-white">ç¸½è©•</td>
                        <td class="border border-gray-600 px-4 py-3 text-red-400 font-semibold">
                            å¯ç”¨ä½†ä¸å®Œæ•´
                        </td>
                        <td class="border border-gray-600 px-4 py-3 text-blue-400 font-semibold">
                            å°ˆæ¥­ä¸”å¯é©—è­‰
                        </td>
                        <td class="border border-gray-600 px-4 py-3 text-green-400 font-bold">
                            ${legacyQuality ? legacyQuality.overall_score : 'N/A'} â†’ ${enhancedQuality ? enhancedQuality.overall_score : 'N/A'}
                        </td>
                        <td class="border border-gray-600 px-4 py-3">
                            <span class="text-gray-500 text-xs">æœ€çµ‚çµæœ</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Key Improvements Summary -->
        <div class="mt-6 bg-gradient-to-r from-blue-900/30 to-purple-900/30 rounded-lg p-6 border-2 border-blue-500/50">
            <h4 class="text-white font-semibold mb-4 text-lg">ğŸ’¡ æ ¸å¿ƒæ”¹å–„é‡é»</h4>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <div class="text-blue-400 font-semibold mb-2">çµæ§‹åŒ–æ”¹å–„</div>
                    <ul class="text-gray-300 text-sm space-y-1">
                        <li>âœ“ 10æ®µå¼å®Œæ•´æ¶æ§‹</li>
                        <li>âœ“ è‡ªå‹•çµæ§‹é©—è­‰</li>
                        <li>âœ“ é—œéµæ®µè½å¼·åˆ¶è¦æ±‚</li>
                    </ul>
                </div>
                <div>
                    <div class="text-purple-400 font-semibold mb-2">å¼•ç”¨å“è³ªæ”¹å–„</div>
                    <ul class="text-gray-300 text-sm space-y-1">
                        <li>âœ“ ç†è«–èªªæ˜å¼·åˆ¶è¦æ±‚</li>
                        <li>âœ“ æ­£åç¯„ä¾‹å¼•å°</li>
                        <li>âœ“ å¼•ç”¨è¦†è“‹ç‡æª¢æŸ¥</li>
                    </ul>
                </div>
                <div>
                    <div class="text-green-400 font-semibold mb-2">æª¢ç´¢èƒ½åŠ›æå‡</div>
                    <ul class="text-gray-300 text-sm space-y-1">
                        <li>âœ“ çµæ§‹åŒ–æŸ¥è©¢èªå¥</li>
                        <li>âœ“ ç”Ÿæ¶¯éšæ®µè‡ªå‹•è­˜åˆ¥</li>
                        <li>âœ“ æ›´ç²¾æº–çš„ç†è«–åŒ¹é…</li>
                    </ul>
                </div>
                <div>
                    <div class="text-yellow-400 font-semibold mb-2">å“è³ªå¯è¦–åŒ–</div>
                    <ul class="text-gray-300 text-sm space-y-1">
                        <li>âœ“ 0-100 è‡ªå‹•è©•åˆ†</li>
                        <li>âœ“ çµæ§‹/å¼•ç”¨åˆ†é …è©•åˆ†</li>
                        <li>âœ“ å„ªç§€/è‰¯å¥½/åŠæ ¼ç­‰ç´š</li>
                    </ul>
                </div>
            </div>
        </div>
    `;
    document.getElementById('comparisonTableContent').innerHTML = tableHTML;
}

function generateAlignedComparison(legacyReport, enhancedReport) {
    const legacyText = legacyReport.conceptualization || '';
    const enhancedText = enhancedReport.conceptualization || '';

    // All enhanced sections (complete 10 sections)
    const enhancedSections = [
        { title: 'ä¸€ã€æ¡ˆä¸»åŸºæœ¬è³‡æ–™', key: 'ã€ä¸€ã€æ¡ˆä¸»åŸºæœ¬è³‡æ–™ã€‘', legacyKey: null },
        { title: 'äºŒã€ä¸»è¨´å•é¡Œ', key: 'ã€äºŒã€ä¸»è¨´å•é¡Œã€‘', legacyKey: 'ã€ä¸»è¨´å•é¡Œã€‘' },
        { title: 'ä¸‰ã€å•é¡Œç™¼å±•è„ˆçµ¡', key: 'ã€ä¸‰ã€å•é¡Œç™¼å±•è„ˆçµ¡ã€‘', legacyKey: null },
        { title: 'å››ã€æ±‚åŠ©å‹•æ©Ÿèˆ‡æœŸå¾…', key: 'ã€å››ã€æ±‚åŠ©å‹•æ©Ÿèˆ‡æœŸå¾…ã€‘', legacyKey: null },
        { title: 'äº”ã€å¤šå±¤æ¬¡å› ç´ åˆ†æ', key: 'ã€äº”ã€å¤šå±¤æ¬¡å› ç´ åˆ†æã€‘', legacyKey: 'ã€æˆå› åˆ†æã€‘' },
        { title: 'å…­ã€å€‹æ¡ˆå„ªå‹¢èˆ‡è³‡æº', key: 'ã€å…­ã€å€‹æ¡ˆå„ªå‹¢èˆ‡è³‡æºã€‘', legacyKey: null },
        { title: 'ä¸ƒã€è«®è©¢å¸«çš„å°ˆæ¥­åˆ¤æ–·', key: 'ã€ä¸ƒã€è«®è©¢å¸«çš„å°ˆæ¥­åˆ¤æ–·ã€‘', legacyKey: 'ã€æ™¤è«‡ç›®æ¨™ï¼ˆç§»å‹•ä¸»è¨´ï¼‰ã€‘' },
        { title: 'å…«ã€è«®å•†ç›®æ¨™èˆ‡ä»‹å…¥ç­–ç•¥', key: 'ã€å…«ã€è«®å•†ç›®æ¨™èˆ‡ä»‹å…¥ç­–ç•¥ã€‘', legacyKey: 'ã€ä»‹å…¥ç­–ç•¥ã€‘' },
        { title: 'ä¹ã€é æœŸæˆæ•ˆèˆ‡è©•ä¼°', key: 'ã€ä¹ã€é æœŸæˆæ•ˆèˆ‡è©•ä¼°ã€‘', legacyKey: 'ã€ç›®å‰æˆæ•ˆè©•ä¼°ã€‘' },
        { title: 'åã€è«®è©¢å¸«è‡ªæˆ‘åæ€', key: 'ã€åã€è«®è©¢å¸«è‡ªæˆ‘åæ€ã€‘', legacyKey: null }
    ];

    let alignedHTML = `
        <div class="bg-gray-800 rounded-lg p-6">
            <h3 class="text-xl font-bold text-white mb-4">â†”ï¸ æ®µè½å°é½Šæ¯”è¼ƒ</h3>
            <p class="text-gray-400 text-sm mb-6">å·¦å´ç‚ºèˆŠç‰ˆ 5 æ®µå¼å ±å‘Šï¼Œå³å´ç‚ºæ–°ç‰ˆå®Œæ•´ 10 æ®µå¼å ±å‘Š</p>

            <div class="space-y-4">
    `;

    enhancedSections.forEach((section, index) => {
        const enhancedContent = extractSectionContent(enhancedText, section.key);

        let legacyContent = '';
        let legacyTitle = '';

        if (section.legacyKey) {
            legacyContent = extractSectionContent(legacyText, section.legacyKey);
            // Extract legacy title without brackets
            legacyTitle = section.legacyKey.replace(/ã€|ã€‘/g, '');
        }

        alignedHTML += `
            <div class="grid grid-cols-2 gap-4 border border-gray-700 rounded-lg overflow-hidden">
                <!-- Legacy Section -->
                <div class="bg-gray-900 p-4 ${!section.legacyKey ? 'opacity-50' : ''}">
                    ${section.legacyKey
                        ? `<h4 class="text-sm font-semibold text-blue-400 mb-3">ğŸ“„ èˆŠç‰ˆï¼š${legacyTitle}</h4>
                           <div class="text-white text-sm whitespace-pre-wrap leading-relaxed">${legacyContent}</div>`
                        : `<h4 class="text-sm font-semibold text-gray-500 mb-3">ğŸ“„ èˆŠç‰ˆï¼šç„¡æ­¤æ®µè½</h4>
                           <div class="text-gray-500 text-sm italic">æ­¤æ®µè½åƒ…åœ¨æ–°ç‰ˆå ±å‘Šä¸­æä¾›</div>`
                    }
                </div>

                <!-- Enhanced Section -->
                <div class="bg-gray-900 p-4">
                    <h4 class="text-sm font-semibold text-green-400 mb-3">âœ¨ æ–°ç‰ˆï¼š${section.title}</h4>
                    <div class="text-white text-sm whitespace-pre-wrap leading-relaxed">${enhancedContent}</div>
                </div>
            </div>
        `;
    });

    alignedHTML += `
            </div>

            <div class="mt-6 p-4 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                <h4 class="text-blue-400 font-semibold mb-2">ğŸ’¡ èªªæ˜</h4>
                <ul class="text-gray-300 text-sm space-y-1">
                    <li>â€¢ å·¦å´ç‚ºèˆŠç‰ˆ 5 æ®µå¼å ±å‘Šï¼Œå³å´ç‚ºæ–°ç‰ˆå®Œæ•´ 10 æ®µå¼å ±å‘Š</li>
                    <li>â€¢ æ–°ç‰ˆæ–°å¢çš„æ®µè½ï¼ˆä¸€ã€ä¸‰ã€å››ã€å…­ã€åï¼‰åœ¨å·¦å´é¡¯ç¤ºç‚ºã€Œç„¡æ­¤æ®µè½ã€</li>
                    <li>â€¢ å¯æ¸…æ¥šçœ‹å‡ºæ–°ç‰ˆå ±å‘Šåœ¨çµæ§‹ä¸Šçš„æ“´å……èˆ‡å„ªåŒ–</li>
                </ul>
            </div>
        </div>
    `;

    document.getElementById('alignedComparisonContent').innerHTML = alignedHTML;
}

function switchVersionTab(tabName) {
    ['legacy', 'enhanced', 'aligned', 'comparison'].forEach(tab => {
        const button = document.getElementById(`ver-tab-${tab}`);
        const content = document.getElementById(`ver-content-${tab}`);

        if (tab === tabName) {
            button.classList.remove('text-gray-400', 'border-transparent');
            button.classList.add('text-white', 'border-blue-500');
            content.classList.remove('hidden');
        } else {
            button.classList.remove('text-white', 'border-blue-500');
            button.classList.add('text-gray-400', 'border-transparent');
            content.classList.add('hidden');
        }
    });
}

function getScoreColor(score) {
    if (score >= 90) return 'text-green-400';
    if (score >= 75) return 'text-blue-400';
    if (score >= 60) return 'text-yellow-400';
    return 'text-red-400';
}

function toggleDetailRow(rowId) {
    const row = document.getElementById(rowId);
    if (row) {
        row.classList.toggle('hidden');
    }
}

// Disable reportVersion selector when version comparison mode is checked
document.addEventListener('DOMContentLoaded', function() {
    const versionCompCheckbox = document.getElementById('versionComparisonMode');
    const reportVersionSelect = document.getElementById('reportVersion');

    if (versionCompCheckbox && reportVersionSelect) {
        versionCompCheckbox.addEventListener('change', function() {
            if (this.checked) {
                reportVersionSelect.disabled = true;
                reportVersionSelect.style.opacity = '0.5';
                reportVersionSelect.title = 'ç‰ˆæœ¬æ¯”è¼ƒæ¨¡å¼æœƒåŒæ™‚ç”Ÿæˆå…©å€‹ç‰ˆæœ¬';
            } else {
                reportVersionSelect.disabled = false;
                reportVersionSelect.style.opacity = '1';
                reportVersionSelect.title = '';
            }
        });
    }
});
</script>
{% endblock %}
