{% extends "rag/base_sidebar.html" %}

{% block page_title %}å€‹æ¡ˆå ±å‘Šç”Ÿæˆ{% endblock %}

{% block page_content %}
<div class="mb-6">
    <h2 class="text-2xl font-bold text-white mb-2">å€‹æ¡ˆå ±å‘Šç”Ÿæˆ</h2>
    <p class="text-gray-400">æ ¹æ“šå°è©±è¨˜éŒ„èˆ‡åƒè€ƒè³‡æ–™ï¼Œè‡ªå‹•ç”Ÿæˆè·æ¶¯è«®è©¢å ±å‘Š</p>
</div>

<!-- Report Form -->
<div class="bg-gray-800 rounded-lg p-6 mb-6">
    <h3 class="text-xl font-semibold text-white mb-4">é€å­—ç¨¿è¼¸å…¥</h3>

    <div class="space-y-4">
        <div>
            <div class="flex justify-between items-center mb-2">
                <label class="block text-gray-300 text-sm">æ™¤è«‡é€å­—ç¨¿</label>
                <button
                    onclick="loadSampleTranscript()"
                    class="text-blue-400 hover:text-blue-300 text-xs underline"
                >
                    ğŸ“ è¼‰å…¥ç¯„ä¾‹é€å­—ç¨¿
                </button>
            </div>
            <textarea
                id="transcript"
                rows="12"
                placeholder="è²¼ä¸Šæ™¤è«‡é€å­—ç¨¿å…§å®¹ï¼ŒAI æœƒè‡ªå‹•åˆ†æä¸¦ç”Ÿæˆå€‹æ¡ˆå ±å‘Š..."
                class="w-full bg-gray-700 text-white rounded-lg px-4 py-2 border border-gray-600 font-mono text-sm"
            ></textarea>
            <p class="text-gray-400 text-xs mt-2">ğŸ’¡ æ”¯æ´ä»»ä½•æ ¼å¼çš„å°è©±è¨˜éŒ„ï¼ŒAI æœƒè‡ªå‹•è­˜åˆ¥èªªè©±è€…èˆ‡é—œéµè³‡è¨Š</p>
        </div>

        <div class="grid grid-cols-3 gap-4">
            <div>
                <label class="block text-gray-300 text-sm mb-2">åƒèˆ‡äººæ•¸</label>
                <select id="numParticipants" class="w-full bg-gray-700 text-white rounded-lg px-4 py-2 border border-gray-600">
                    <option value="2">2äººï¼ˆè«®è©¢å¸« + å€‹æ¡ˆï¼‰</option>
                    <option value="3">3äºº</option>
                    <option value="4">4äºº</option>
                    <option value="5">5äºº</option>
                </select>
            </div>

            <div>
                <label class="block text-gray-300 text-sm mb-2">RAG ç³»çµ±</label>
                <select id="ragSystem" class="w-full bg-gray-700 text-white rounded-lg px-4 py-2 border border-gray-600">
                    <option value="supabase">ğŸ¤– OpenAI + Supabase</option>
                    <option value="vertex">ğŸ”· Google Vertex AI</option>
                </select>
            </div>

            <div>
                <label class="block text-gray-300 text-sm mb-2">æª¢ç´¢æ•¸é‡ (TOP K)</label>
                <select id="topK" class="w-full bg-gray-700 text-white rounded-lg px-4 py-2 border border-gray-600">
                    <option value="3">3 å€‹ï¼ˆç²¾æº–ï¼‰</option>
                    <option value="5">5 å€‹</option>
                    <option value="7" selected>7 å€‹ï¼ˆå»ºè­°ï¼‰</option>
                    <option value="10">10 å€‹ï¼ˆå…¨é¢ï¼‰</option>
                    <option value="15">15 å€‹ï¼ˆæœ€å¤§ï¼‰</option>
                </select>
            </div>
        </div>

        <!-- Comparison Mode Toggle -->
        <div class="mb-4">
            <label class="flex items-center gap-2 text-gray-300 cursor-pointer">
                <input type="checkbox" id="comparisonMode" class="form-checkbox h-4 w-4 text-purple-600">
                <span>ğŸ”¬ æ¯”è¼ƒæ¨¡å¼ï¼ˆåŒæ™‚æ¸¬è©¦å…©å€‹ RAG ç³»çµ±ï¼‰</span>
            </label>
        </div>

        <div class="flex gap-3">
            <button
                onclick="generateReport()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition"
            >
                ğŸ¤– AI ç”Ÿæˆå ±å‘Š
            </button>
            <button
                onclick="clearForm()"
                class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-3 rounded-lg transition"
            >
                æ¸…ç©º
            </button>
        </div>
    </div>
</div>

<!-- Progress Section -->
<div id="progressSection" class="hidden bg-gray-800 rounded-lg p-6 mb-6">
    <h3 class="text-xl font-semibold text-white mb-4">ç”Ÿæˆé€²åº¦</h3>
    <div id="progressSteps" class="space-y-3">
        <!-- Progress steps will be dynamically added here -->
    </div>
</div>

<!-- Comparison Results Section -->
<div id="comparisonSection" class="hidden space-y-6 mb-6">
    <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-2xl font-semibold text-white mb-6">ğŸ”¬ RAG ç³»çµ±æ¯”è¼ƒçµæœ</h3>

        <!-- Comparison Metrics Summary -->
        <div id="comparisonMetrics" class="mb-6">
            <!-- Metrics will be injected here -->
        </div>

        <!-- Tab Navigation for Comparison View -->
        <div class="flex gap-2 mb-6 border-b border-gray-700">
            <button onclick="switchComparisonTab('retrieval')" id="comp-tab-retrieval" class="px-6 py-3 text-white font-semibold border-b-2 border-blue-500 transition">
                ğŸ” æª¢ç´¢çµæœæ¯”è¼ƒ
            </button>
            <button onclick="switchComparisonTab('reports')" id="comp-tab-reports" class="px-6 py-3 text-gray-400 hover:text-white font-semibold border-b-2 border-transparent hover:border-gray-600 transition">
                ğŸ“„ å€‹æ¡ˆå ±å‘Šæ¯”è¼ƒ
            </button>
        </div>

        <!-- Tab Content: Retrieval Comparison -->
        <div id="comp-content-retrieval" class="comp-tab-content">
            <div class="grid grid-cols-2 gap-6">
                <!-- Supabase Results -->
                <div class="bg-gray-900 rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-blue-400 mb-4">ğŸ¤– OpenAI + Supabase</h4>
                    <div id="supabaseResults" class="space-y-3">
                        <!-- Results will be injected here -->
                    </div>
                </div>

                <!-- Vertex Results -->
                <div class="bg-gray-900 rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-purple-400 mb-4">ğŸ”· Google Vertex AI</h4>
                    <div id="vertexResults" class="space-y-3">
                        <!-- Results will be injected here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Reports Comparison -->
        <div id="comp-content-reports" class="comp-tab-content hidden">
            <div class="grid grid-cols-2 gap-6">
                <!-- Supabase Report -->
                <div class="bg-gray-900 rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-blue-400 mb-4">ğŸ¤– OpenAI + Supabase ç”Ÿæˆå ±å‘Š</h4>
                    <div id="supabaseReport" class="text-white text-sm space-y-4">
                        <!-- Report will be injected here -->
                    </div>
                </div>

                <!-- Vertex Report -->
                <div class="bg-gray-900 rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-purple-400 mb-4">ğŸ”· Google Vertex AI ç”Ÿæˆå ±å‘Š</h4>
                    <div id="vertexReport" class="text-white text-sm space-y-4">
                        <!-- Report will be injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Output - TABLE FORMAT -->
<div id="reportSection" class="hidden space-y-6">
    <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-xl font-semibold text-white mb-4">è·æ¸¸å‰µæ–°è·æ¶¯ç™¼å±•èˆ‡è«®è©¢ - å€‹æ¡ˆå ±å‘Š</h3>

        <!-- Tab Navigation -->
        <div class="flex gap-2 mb-6 border-b border-gray-700">
            <button onclick="switchTab('html')" id="tab-html" class="px-6 py-3 text-white font-semibold border-b-2 border-blue-500 transition">
                HTML è¡¨æ ¼
            </button>
            <button onclick="switchTab('json')" id="tab-json" class="px-6 py-3 text-gray-400 hover:text-white font-semibold border-b-2 border-transparent hover:border-gray-600 transition">
                JSON
            </button>
            <button onclick="switchTab('markdown')" id="tab-markdown" class="px-6 py-3 text-gray-400 hover:text-white font-semibold border-b-2 border-transparent hover:border-gray-600 transition">
                Markdown
            </button>
        </div>

        <!-- Tab Content: HTML -->
        <div id="content-html" class="tab-content">

        <!-- Header Info Table -->
        <div class="mb-6">
            <table class="w-full border-collapse border border-gray-600">
                <tr class="bg-gray-700">
                    <td class="border border-gray-600 px-4 py-2 text-gray-300 font-semibold w-1/3">è«®è©¢ç·´ç¿’ç”Ÿ</td>
                    <td id="counselor_name_display" class="border border-gray-600 px-4 py-2 text-white">-</td>
                </tr>
                <tr class="bg-gray-700">
                    <td class="border border-gray-600 px-4 py-2 text-gray-300 font-semibold">å®Œæˆæ’°å¯«æ—¥æœŸ</td>
                    <td id="completion_date_display" class="border border-gray-600 px-4 py-2 text-white">-</td>
                </tr>
            </table>
        </div>

        <!-- ä¸€ã€æ¡ˆä¸»åŸºæœ¬è³‡æ–™ -->
        <div class="mb-6">
            <h4 class="text-lg font-semibold text-white mb-3">ä¸€ã€æ¡ˆä¸»åŸºæœ¬è³‡æ–™</h4>
            <table class="w-full border-collapse border border-gray-600">
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold w-1/4">1. å§“å(åŒ–å)</td>
                    <td id="client_name" class="border border-gray-600 px-4 py-2 text-white">-</td>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold w-1/4">2. æ€§åˆ¥</td>
                    <td id="client_gender" class="border border-gray-600 px-4 py-2 text-white">-</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold">3. å¹´ç´€</td>
                    <td id="client_age" class="border border-gray-600 px-4 py-2 text-white">-</td>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold">4. éƒ¨é–€/è·æ¥­(å­¸æ ¡ç§‘ç³»)</td>
                    <td id="client_occupation" class="border border-gray-600 px-4 py-2 text-white">-</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold">5. å­¸æ­·</td>
                    <td id="client_education" class="border border-gray-600 px-4 py-2 text-white">-</td>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold">6. ç¾å±…åœ°</td>
                    <td id="client_location" class="border border-gray-600 px-4 py-2 text-white">-</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold">7. ç¶“æ¿Ÿç‹€æ³</td>
                    <td id="client_economic" colspan="3" class="border border-gray-600 px-4 py-2 text-white">-</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold">8. å®¶åº­é—œä¿‚</td>
                    <td id="client_family" colspan="3" class="border border-gray-600 px-4 py-2 text-white">-</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold">9. å…¶ä»–é‡è¦è³‡è¨Š</td>
                    <td id="client_other" colspan="3" class="border border-gray-600 px-4 py-2 text-white whitespace-pre-wrap">-</td>
                </tr>
            </table>
        </div>

        <!-- äºŒã€æ­·ç¨‹åˆ†æ -->
        <div class="mb-6">
            <h4 class="text-lg font-semibold text-white mb-3">äºŒã€æ­·ç¨‹åˆ†æ</h4>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse border border-gray-600">
                    <thead>
                        <tr class="bg-gray-700">
                            <th class="border border-gray-600 px-4 py-2 text-white">æ¬¡æ•¸/æ™¤è«‡æ™‚é–“</th>
                            <th class="border border-gray-600 px-4 py-2 text-white">æ™¤è«‡å…§å®¹æ¦‚è¿°</th>
                            <th class="border border-gray-600 px-4 py-2 text-white">è«®è©¢å¸«è‡ªè©•</th>
                        </tr>
                    </thead>
                    <tbody id="session_history">
                        <tr>
                            <td colspan="3" class="border border-gray-600 px-4 py-2 text-gray-400 text-center">å°šç„¡è³‡æ–™</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ä¸‰ã€æ¦‚å¿µåŒ–åˆ†æ -->
        <div class="mb-6">
            <h4 class="text-lg font-semibold text-white mb-3">ä¸‰ã€æ¦‚å¿µåŒ–åˆ†æ</h4>
            <table class="w-full border-collapse border border-gray-600">
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold w-1/4">ä¸»è¨´å•é¡Œ</td>
                    <td id="main_issue" class="border border-gray-600 px-4 py-2 text-white whitespace-pre-wrap">-</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold">æˆå› åˆ†æ</td>
                    <td id="cause_analysis" class="border border-gray-600 px-4 py-2 text-white whitespace-pre-wrap">-</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold">æ™¤è«‡ç›®æ¨™</td>
                    <td id="counseling_goal" class="border border-gray-600 px-4 py-2 text-white whitespace-pre-wrap">-</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold">ä»‹å…¥ç­–ç•¥</td>
                    <td id="intervention" class="border border-gray-600 px-4 py-2 text-white whitespace-pre-wrap">-</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold">ç›®å‰æˆæ•ˆè©•ä¼°</td>
                    <td id="effectiveness" class="border border-gray-600 px-4 py-2 text-white whitespace-pre-wrap">-</td>
                </tr>
            </table>
        </div>

        <!-- å››ã€å€‹äººåŒ–åˆ†æ -->
        <div class="mb-6">
            <h4 class="text-lg font-semibold text-white mb-3">å››ã€å€‹äººåŒ–åˆ†æ</h4>
            <table class="w-full border-collapse border border-gray-600">
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold w-1/3">æˆ‘å’Œé€™å€‹äººå·¥ä½œçš„æ„Ÿå—æ˜¯ï¼Ÿ</td>
                    <td id="counselor_feeling" class="border border-gray-600 px-4 py-2 text-white whitespace-pre-wrap">-</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold">é€™å€‹æ„Ÿå—çš„åŸå› æ˜¯ï¼Ÿ</td>
                    <td id="feeling_reason" class="border border-gray-600 px-4 py-2 text-white whitespace-pre-wrap">-</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold">ç›®å‰è·Ÿé€™å€‹äººå·¥ä½œçš„å›°é›£</td>
                    <td id="difficulties" class="border border-gray-600 px-4 py-2 text-white whitespace-pre-wrap">-</td>
                </tr>
                <tr>
                    <td class="border border-gray-600 px-4 py-2 bg-gray-700 text-gray-300 font-semibold">æˆ‘æœƒæƒ³æ‰¾ç£å°è¨è«–çš„å•é¡Œæ˜¯ï¼Ÿ</td>
                    <td id="supervision_topic" class="border border-gray-600 px-4 py-2 text-white whitespace-pre-wrap">-</td>
                </tr>
            </table>
        </div>

        <!-- é—œéµå°è©±æ‘˜éŒ„ -->
        <div class="mb-6">
            <h4 class="text-lg font-semibold text-white mb-3">é—œéµå°è©±æ‘˜éŒ„</h4>
            <div id="dialogueExcerpts" class="space-y-3">
                <div class="text-gray-400">å°šç„¡å°è©±æ‘˜éŒ„</div>
            </div>
        </div>

        <!-- åƒè€ƒç†è«–æ–‡ç» -->
        <div>
            <h4 class="text-lg font-semibold text-white mb-3">åƒè€ƒç†è«–æ–‡ç»</h4>
            <div id="theoriesList" class="space-y-3">
                <div class="text-gray-400">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
        </div>

        <!-- Tab Content: JSON -->
        <div id="content-json" class="tab-content hidden">
            <div class="flex justify-end mb-4">
                <button onclick="downloadJSON()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                    ğŸ“¥ ä¸‹è¼‰ JSON
                </button>
            </div>
            <pre id="jsonOutput" class="bg-gray-900 text-green-400 p-6 rounded-lg overflow-auto max-h-[800px] font-mono text-sm"></pre>
        </div>

        <!-- Tab Content: Markdown -->
        <div id="content-markdown" class="tab-content hidden">
            <div class="flex justify-end mb-4">
                <button onclick="downloadMarkdown()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
                    ğŸ“„ ä¸‹è¼‰ Markdown
                </button>
            </div>
            <pre id="markdownOutput" class="bg-gray-900 text-gray-300 p-6 rounded-lg overflow-auto max-h-[800px] font-mono text-sm whitespace-pre-wrap"></pre>
        </div>
    </div>
</div>

<script>
let reportData = null;

async function loadSampleTranscript() {
    try {
        const response = await fetch('/static/sample_transcript.txt');
        const text = await response.text();
        document.getElementById('transcript').value = text;
    } catch (error) {
        console.error('Failed to load sample transcript:', error);
    }
}

async function generateReport() {
    const transcript = document.getElementById('transcript').value.trim();
    const numParticipants = parseInt(document.getElementById('numParticipants').value);
    const ragSystem = document.getElementById('ragSystem').value;
    const topK = parseInt(document.getElementById('topK').value);
    const comparisonMode = document.getElementById('comparisonMode').checked;

    if (!transcript) {
        alert('è«‹è¼¸å…¥æ™¤è«‡é€å­—ç¨¿');
        return;
    }

    // Reset and show progress
    document.getElementById('progressSection').classList.remove('hidden');
    document.getElementById('reportSection').classList.add('hidden');
    document.getElementById('comparisonSection').classList.add('hidden');
    document.getElementById('progressSteps').innerHTML = '';

    if (comparisonMode) {
        await runComparisonMode(transcript, numParticipants, topK);
    } else {
        await runSingleReport(transcript, numParticipants, ragSystem, topK);
    }
}

async function runSingleReport(transcript, numParticipants, ragSystem, topK) {
    try {
        const url = `/api/report/generate?transcript=${encodeURIComponent(transcript)}&num_participants=${numParticipants}&rag_system=${ragSystem}&top_k=${topK}`;
        const eventSource = new EventSource(url);

        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);

            if (data.status === 'error') {
                alert('éŒ¯èª¤: ' + data.message);
                eventSource.close();
                return;
            }

            updateProgress(data);

            if (data.step === 5 && data.status === 'completed' && data.data?.report) {
                reportData = data.data.report;
                displayReportInTable(reportData);
                document.getElementById('reportSection').classList.remove('hidden');
            }

            if (data.step === 6 && data.status === 'completed') {
                eventSource.close();
            }
        };

        eventSource.onerror = function(error) {
            console.error('EventSource error:', error);
            alert('é€£ç·šéŒ¯èª¤ï¼Œè«‹é‡è©¦');
            eventSource.close();
            document.getElementById('progressSection').classList.add('hidden');
        };

    } catch (error) {
        console.error('Report generation error:', error);
        alert('å ±å‘Šç”Ÿæˆå¤±æ•—: ' + error.message);
        document.getElementById('progressSection').classList.add('hidden');
    }
}

async function runComparisonMode(transcript, numParticipants, topK) {
    const comparisonData = {
        supabase: null,
        vertex: null
    };

    // Run Supabase first
    document.getElementById('progressSteps').innerHTML = '<div class="text-blue-400">ğŸ”µ æ­£åœ¨é‹è¡Œ OpenAI + Supabase...</div>';
    comparisonData.supabase = await runReportAndCapture(transcript, numParticipants, 'supabase', topK);

    // Run Vertex AI
    document.getElementById('progressSteps').innerHTML += '<div class="text-purple-400 mt-2">ğŸŸ£ æ­£åœ¨é‹è¡Œ Vertex AI...</div>';
    comparisonData.vertex = await runReportAndCapture(transcript, numParticipants, 'vertex', topK);

    // Display comparison
    displayComparisonResults(comparisonData);
    document.getElementById('progressSection').classList.add('hidden');
    document.getElementById('comparisonSection').classList.remove('hidden');
}

function runReportAndCapture(transcript, numParticipants, ragSystem, topK) {
    return new Promise((resolve, reject) => {
        const url = `/api/report/generate?transcript=${encodeURIComponent(transcript)}&num_participants=${numParticipants}&rag_system=${ragSystem}&top_k=${topK}`;
        const eventSource = new EventSource(url);
        const capturedData = {
            system: ragSystem,
            theories: [],
            report: null,
            processingTime: 0,
            startTime: Date.now()
        };

        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);

            if (data.status === 'error') {
                eventSource.close();
                reject(new Error(data.message));
                return;
            }

            // Capture theories from step 3
            if (data.step === 3 && data.status === 'completed' && data.data?.theories) {
                capturedData.theories = data.data.theories;
            }

            // Capture final report from step 5
            if (data.step === 5 && data.status === 'completed' && data.data?.report) {
                capturedData.report = data.data.report;
            }

            // Close and resolve when done
            if (data.step === 6 && data.status === 'completed') {
                capturedData.processingTime = (Date.now() - capturedData.startTime) / 1000;
                eventSource.close();
                resolve(capturedData);
            }
        };

        eventSource.onerror = function(error) {
            eventSource.close();
            reject(error);
        };
    });
}

function displayComparisonResults(comparisonData) {
    const supabase = comparisonData.supabase;
    const vertex = comparisonData.vertex;

    // Calculate metrics
    const supabaseAvgScore = supabase.theories.length > 0
        ? (supabase.theories.reduce((sum, t) => sum + t.score, 0) / supabase.theories.length).toFixed(4)
        : 0;
    const vertexAvgScore = vertex.theories.length > 0
        ? (vertex.theories.reduce((sum, t) => sum + t.score, 0) / vertex.theories.length).toFixed(4)
        : 0;

    // Find unique and common theories by document name
    const supabaseDocs = new Set(supabase.theories.map(t => t.document));
    const vertexDocs = new Set(vertex.theories.map(t => t.document));
    const commonDocs = [...supabaseDocs].filter(doc => vertexDocs.has(doc));
    const uniqueSupabase = [...supabaseDocs].filter(doc => !vertexDocs.has(doc));
    const uniqueVertex = [...vertexDocs].filter(doc => !supabaseDocs.has(doc));

    // Display summary metrics
    const metricsHTML = `
        <div class="bg-gradient-to-r from-gray-900 to-gray-800 rounded-lg p-6">
            <h4 class="text-xl font-semibold text-white mb-4">ğŸ“Š æ¯”è¼ƒçµ±è¨ˆ</h4>
            <div class="grid grid-cols-5 gap-4 text-center">
                <div>
                    <div class="text-gray-400 text-sm mb-1">å…±åŒæ–‡ç»</div>
                    <div class="text-green-400 text-3xl font-bold">${commonDocs.length}</div>
                    <div class="text-gray-500 text-xs">å…©è€…çš†æ‰¾åˆ°</div>
                </div>
                <div>
                    <div class="text-gray-400 text-sm mb-1">Supabase ç¨æœ‰</div>
                    <div class="text-blue-400 text-3xl font-bold">${uniqueSupabase.length}</div>
                    <div class="text-gray-500 text-xs">åƒ… Supabase</div>
                </div>
                <div>
                    <div class="text-gray-400 text-sm mb-1">Vertex ç¨æœ‰</div>
                    <div class="text-purple-400 text-3xl font-bold">${uniqueVertex.length}</div>
                    <div class="text-gray-500 text-xs">åƒ… Vertex</div>
                </div>
                <div>
                    <div class="text-gray-400 text-sm mb-1">Supabase é€Ÿåº¦</div>
                    <div class="text-blue-400 text-3xl font-bold">${supabase.processingTime.toFixed(1)}s</div>
                    <div class="text-gray-500 text-xs">è™•ç†æ™‚é–“</div>
                </div>
                <div>
                    <div class="text-gray-400 text-sm mb-1">Vertex é€Ÿåº¦</div>
                    <div class="text-purple-400 text-3xl font-bold">${vertex.processingTime.toFixed(1)}s</div>
                    <div class="text-gray-500 text-xs">è™•ç†æ™‚é–“</div>
                </div>
            </div>

            <!-- Winner Badge -->
            <div class="mt-6 pt-4 border-t border-gray-700">
                <div class="flex justify-around text-sm">
                    <div class="text-center">
                        <div class="text-gray-400 mb-1">å¹³å‡ç›¸ä¼¼åº¦</div>
                        <div class="flex items-center gap-4">
                            <span class="text-blue-400 font-mono text-lg">${supabaseAvgScore}</span>
                            <span class="text-gray-500">vs</span>
                            <span class="text-purple-400 font-mono text-lg">${vertexAvgScore}</span>
                        </div>
                    </div>
                    <div class="text-center">
                        <div class="text-gray-400 mb-1">æª¢ç´¢åˆ°ç†è«–æ•¸</div>
                        <div class="flex items-center gap-4">
                            <span class="text-blue-400 font-mono text-lg">${supabase.theories.length}</span>
                            <span class="text-gray-500">vs</span>
                            <span class="text-purple-400 font-mono text-lg">${vertex.theories.length}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.getElementById('comparisonMetrics').innerHTML = metricsHTML;

    // Display Supabase results
    displaySystemResults('supabaseResults', supabase, supabaseDocs, uniqueSupabase, commonDocs);

    // Display Vertex results
    displaySystemResults('vertexResults', vertex, vertexDocs, uniqueVertex, commonDocs);

    // Display reports
    displaySystemReport('supabaseReport', supabase.report, 'ğŸ¤– OpenAI + Supabase');
    displaySystemReport('vertexReport', vertex.report, 'ğŸ”· Google Vertex AI');
}

function displaySystemReport(elementId, reportData, systemName) {
    if (!reportData || !reportData.conceptualization) {
        document.getElementById(elementId).innerHTML = '<div class="text-gray-400">å ±å‘Šç”Ÿæˆå¤±æ•—</div>';
        return;
    }

    let html = `
        <div class="space-y-4">
            <div class="bg-gray-800 rounded-lg p-4">
                <h5 class="text-white font-semibold mb-2">ğŸ‘¤ æ¡ˆä¸»è³‡è¨Š</h5>
                <div class="text-gray-300 text-xs space-y-1">
                    <div><span class="text-gray-500">å§“åï¼š</span>${reportData.client_info.name}</div>
                    <div><span class="text-gray-500">å¹´é½¡ï¼š</span>${reportData.client_info.age}</div>
                    <div><span class="text-gray-500">è·æ¥­ï¼š</span>${reportData.client_info.occupation}</div>
                </div>
            </div>

            <div class="bg-gray-800 rounded-lg p-4">
                <h5 class="text-white font-semibold mb-2">ğŸ¯ ä¸»è¨´å•é¡Œ</h5>
                <div class="text-gray-300 text-xs">
                    ${reportData.main_concerns.map(c => `<div>â€¢ ${c}</div>`).join('')}
                </div>
            </div>

            <div class="bg-gray-800 rounded-lg p-4">
                <h5 class="text-white font-semibold mb-2">ğŸ“ æ¦‚å¿µåŒ–å…§å®¹</h5>
                <div class="text-gray-300 text-xs leading-relaxed whitespace-pre-wrap max-h-96 overflow-y-auto">
                    ${reportData.conceptualization}
                </div>
            </div>

            <div class="bg-gray-800 rounded-lg p-4">
                <h5 class="text-white font-semibold mb-2">ğŸ“š åƒè€ƒç†è«–ï¼ˆ${reportData.theories.length} å€‹ï¼‰</h5>
                <div class="text-gray-300 text-xs space-y-2">
                    ${reportData.theories.slice(0, 3).map((t, idx) => `
                        <div class="border-l-2 border-blue-500 pl-2">
                            <div class="text-yellow-400 font-mono">[${idx + 1}] ${t.score.toFixed(3)}</div>
                            <div class="text-gray-400">${t.text.substring(0, 100)}...</div>
                        </div>
                    `).join('')}
                    ${reportData.theories.length > 3 ? `<div class="text-gray-500">... é‚„æœ‰ ${reportData.theories.length - 3} å€‹ç†è«–</div>` : ''}
                </div>
            </div>
        </div>
    `;

    document.getElementById(elementId).innerHTML = html;
}

function displaySystemResults(elementId, systemData, allDocs, uniqueDocs, commonDocs) {
    const theories = systemData.theories;
    const avgScore = theories.length > 0
        ? (theories.reduce((sum, t) => sum + t.score, 0) / theories.length).toFixed(4)
        : 0;

    let html = `
        <div class="mb-4 p-4 bg-gray-800 rounded-lg">
            <div class="grid grid-cols-2 gap-3 text-sm">
                <div>
                    <span class="text-gray-400">æ‰¾åˆ°ç†è«–ï¼š</span>
                    <span class="text-white font-bold">${theories.length} å€‹</span>
                </div>
                <div>
                    <span class="text-gray-400">å¹³å‡åˆ†æ•¸ï¼š</span>
                    <span class="text-yellow-400 font-mono">${avgScore}</span>
                </div>
                <div>
                    <span class="text-gray-400">è™•ç†æ™‚é–“ï¼š</span>
                    <span class="text-green-400 font-mono">${systemData.processingTime.toFixed(2)}s</span>
                </div>
                <div>
                    <span class="text-gray-400">ç¨æœ‰æ–‡ç»ï¼š</span>
                    <span class="text-orange-400 font-bold">${uniqueDocs.length} å€‹</span>
                </div>
            </div>
        </div>

        <div class="space-y-2">
    `;

    theories.forEach((theory, idx) => {
        const isUnique = uniqueDocs.includes(theory.document);
        const isCommon = commonDocs.includes(theory.document);
        const badge = isUnique ? '<span class="text-xs bg-orange-500 text-white px-2 py-1 rounded">ç¨æœ‰</span>' :
                      isCommon ? '<span class="text-xs bg-green-500 text-white px-2 py-1 rounded">å…±åŒ</span>' : '';

        html += `
            <div class="bg-gray-800 rounded p-3">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center gap-2">
                        <span class="text-gray-500 text-sm">#${idx + 1}</span>
                        <span class="text-gray-300 text-sm font-medium">${theory.document}</span>
                        ${badge}
                    </div>
                    <span class="text-yellow-400 font-mono text-sm">${theory.score.toFixed(4)}</span>
                </div>
                <div class="text-gray-400 text-xs leading-relaxed max-h-20 overflow-hidden">
                    ${theory.text.substring(0, 150)}${theory.text.length > 150 ? '...' : ''}
                </div>
            </div>
        `;
    });

    html += '</div>';
    document.getElementById(elementId).innerHTML = html;
}

function updateProgress(data) {
    const stepMessages = {
        1: 'åˆ†æé€å­—ç¨¿çµæ§‹',
        2: 'è­˜åˆ¥é—œéµè­°é¡Œ',
        3: 'æª¢ç´¢ç›¸é—œç†è«–',
        4: 'ç”Ÿæˆå€‹æ¡ˆå ±å‘Š',
        5: 'æå–é—œéµå°è©±',
        6: 'å®Œæˆ'
    };

    const progressSteps = document.getElementById('progressSteps');
    let stepDiv = document.getElementById(`step-${data.step}`);

    if (!stepDiv) {
        stepDiv = document.createElement('div');
        stepDiv.id = `step-${data.step}`;
        stepDiv.className = 'flex items-center gap-3';
        progressSteps.appendChild(stepDiv);
    }

    const icon = data.status === 'completed' ? 'âœ…' :
                 data.status === 'processing' ? 'â³' : 'âŒ';

    stepDiv.innerHTML = `
        <span class="text-2xl">${icon}</span>
        <div class="flex-1">
            <div class="text-white font-medium">${stepMessages[data.step] || data.message}</div>
            <div class="text-sm text-gray-400">${data.message}</div>
        </div>
    `;
}

function switchComparisonTab(tabName) {
    // Update tab buttons
    ['retrieval', 'reports'].forEach(tab => {
        const button = document.getElementById(`comp-tab-${tab}`);
        const content = document.getElementById(`comp-content-${tab}`);

        if (tab === tabName) {
            button.classList.remove('text-gray-400', 'border-transparent');
            button.classList.add('text-white', 'border-blue-500');
            content.classList.remove('hidden');
        } else {
            button.classList.remove('text-white', 'border-blue-500');
            button.classList.add('text-gray-400', 'border-transparent');
            content.classList.add('hidden');
        }
    });
}

function switchTab(tabName) {
    // Update tab buttons
    ['html', 'json', 'markdown'].forEach(tab => {
        const button = document.getElementById(`tab-${tab}`);
        const content = document.getElementById(`content-${tab}`);

        if (tab === tabName) {
            button.classList.remove('text-gray-400', 'border-transparent');
            button.classList.add('text-white', 'border-blue-500');
            content.classList.remove('hidden');
        } else {
            button.classList.remove('text-white', 'border-blue-500');
            button.classList.add('text-gray-400', 'border-transparent');
            content.classList.add('hidden');
        }
    });

    // Update JSON and Markdown content when switching to those tabs
    if (tabName === 'json' && reportData) {
        document.getElementById('jsonOutput').textContent = JSON.stringify(reportData, null, 2);
    } else if (tabName === 'markdown' && reportData) {
        document.getElementById('markdownOutput').textContent = generateMarkdownText();
    }
}

function displayReportInTable(report) {
    const info = report.client_info;

    // Header
    document.getElementById('counselor_name_display').textContent = '-';
    document.getElementById('completion_date_display').textContent = new Date().toLocaleDateString('zh-TW');

    // Client Info
    document.getElementById('client_name').textContent = info.name || '-';
    document.getElementById('client_gender').textContent = info.gender || '-';
    document.getElementById('client_age').textContent = info.age || '-';
    document.getElementById('client_occupation').textContent = info.occupation || '-';
    document.getElementById('client_education').textContent = info.education || '-';
    document.getElementById('client_location').textContent = info.location || '-';
    document.getElementById('client_economic').textContent = info.economic_status || '-';
    document.getElementById('client_family').textContent = info.family_relations || '-';
    document.getElementById('client_other').textContent = Array.isArray(info.other_info) ? info.other_info.join('\n') : (info.other_info || '-');

    // Session History (currently empty from API, but structure is ready)
    const sessionTable = document.getElementById('session_history');
    sessionTable.innerHTML = `
        <tr>
            <td class="border border-gray-600 px-4 py-2 text-white">ç¬¬ä¸€æ¬¡æ™¤è«‡</td>
            <td class="border border-gray-600 px-4 py-2 text-white">${report.session_summary?.content || 'å¾é€å­—ç¨¿è‡ªå‹•ç”Ÿæˆ'}</td>
            <td class="border border-gray-600 px-4 py-2 text-white">${report.session_summary?.self_evaluation || '-'}</td>
        </tr>
    `;

    // Parse conceptualization into sections
    const conceptText = report.conceptualization;
    const sections = parseConceptualization(conceptText);

    document.getElementById('main_issue').textContent = sections.main_issue || (report.main_concerns ? report.main_concerns.join('ã€') : '-');
    document.getElementById('cause_analysis').textContent = sections.cause_analysis || '-';
    document.getElementById('counseling_goal').textContent = sections.counseling_goal || (report.counseling_goals ? report.counseling_goals.join('ã€') : '-');
    document.getElementById('intervention').textContent = sections.intervention || (report.techniques ? report.techniques.join('ã€') : '-');
    document.getElementById('effectiveness').textContent = sections.effectiveness || '-';

    // Personal Analysis (not in current API, set defaults)
    document.getElementById('counselor_feeling').textContent = '-';
    document.getElementById('feeling_reason').textContent = '-';
    document.getElementById('difficulties').textContent = '-';
    document.getElementById('supervision_topic').textContent = '-';

    // Dialogue Excerpts
    const dialogueExcerpts = document.getElementById('dialogueExcerpts');
    if (report.dialogue_excerpts && report.dialogue_excerpts.length > 0) {
        dialogueExcerpts.innerHTML = report.dialogue_excerpts.map(d => {
            const speakerLabel = d.speaker === 'speaker1' ? 'è«®è©¢å¸«' : 'å€‹æ¡ˆ';
            const bgColor = d.speaker === 'speaker1' ? 'bg-blue-900/30' : 'bg-green-900/30';
            return `
                <div class="${bgColor} rounded-lg p-3">
                    <div class="text-xs text-gray-400 mb-1">${speakerLabel}</div>
                    <div class="text-gray-200">${d.text}</div>
                </div>
            `;
        }).join('');
    } else {
        dialogueExcerpts.innerHTML = '<div class="text-gray-400">ç„¡å°è©±æ‘˜éŒ„</div>';
    }

    // Theories
    const theoriesList = document.getElementById('theoriesList');
    if (report.theories && report.theories.length > 0) {
        theoriesList.innerHTML = report.theories.map((theory, idx) => `
            <div class="bg-gray-700 rounded-lg p-4 border border-gray-600">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-blue-400 font-mono text-sm">[${idx + 1}]</span>
                    <span class="text-gray-400 text-xs">${(theory.score * 100).toFixed(1)}% ç›¸ä¼¼åº¦</span>
                </div>
                <div class="text-white text-sm mb-2">${theory.document}</div>
                <div class="text-gray-300 text-sm">${theory.text}</div>
            </div>
        `).join('');
    } else {
        theoriesList.innerHTML = '<div class="text-yellow-400 p-4 bg-yellow-900/20 rounded-lg">âš ï¸ æœªæ‰¾åˆ°ç›¸é—œåƒè€ƒç†è«–æ–‡ç»ï¼ˆå»ºè­°åœ¨é€å­—ç¨¿ä¸­åŒ…å«æ›´å¤šè·æ¶¯ç›¸é—œé—œéµå­—ï¼‰</div>';
    }
}

function parseConceptualization(text) {
    const sections = {
        main_issue: '',
        cause_analysis: '',
        counseling_goal: '',
        intervention: '',
        effectiveness: ''
    };

    // Try to parse sections marked with ã€ã€‘
    const mainIssueMatch = text.match(/ã€ä¸»è¨´å•é¡Œã€‘\s*([\s\S]*?)(?=ã€|$)/);
    const causeMatch = text.match(/ã€æˆå› åˆ†æã€‘\s*([\s\S]*?)(?=ã€|$)/);
    const goalMatch = text.match(/ã€æ™¤è«‡ç›®æ¨™ã€‘\s*([\s\S]*?)(?=ã€|$)/);
    const interventionMatch = text.match(/ã€ä»‹å…¥ç­–ç•¥ã€‘\s*([\s\S]*?)(?=ã€|$)/);
    const effectivenessMatch = text.match(/ã€ç›®å‰æˆæ•ˆè©•ä¼°ã€‘\s*([\s\S]*?)(?=ã€|$)/);

    if (mainIssueMatch) sections.main_issue = mainIssueMatch[1].trim();
    if (causeMatch) sections.cause_analysis = causeMatch[1].trim();
    if (goalMatch) sections.counseling_goal = goalMatch[1].trim();
    if (interventionMatch) sections.intervention = interventionMatch[1].trim();
    if (effectivenessMatch) sections.effectiveness = effectivenessMatch[1].trim();

    return sections;
}

function clearForm() {
    document.getElementById('transcript').value = '';
    document.getElementById('numParticipants').value = '2';
    document.getElementById('reportSection').classList.add('hidden');
    document.getElementById('progressSection').classList.add('hidden');
    document.getElementById('comparisonSection').classList.add('hidden');
    reportData = null;
}

// Toggle RAG system selector based on comparison mode
document.addEventListener('DOMContentLoaded', function() {
    const comparisonCheckbox = document.getElementById('comparisonMode');
    const ragSystemSelect = document.getElementById('ragSystem');

    comparisonCheckbox.addEventListener('change', function() {
        if (this.checked) {
            ragSystemSelect.disabled = true;
            ragSystemSelect.style.opacity = '0.5';
            ragSystemSelect.title = 'æ¯”è¼ƒæ¨¡å¼æœƒæ¸¬è©¦å…©å€‹ç³»çµ±';
        } else {
            ragSystemSelect.disabled = false;
            ragSystemSelect.style.opacity = '1';
            ragSystemSelect.title = '';
        }
    });
});

function downloadJSON() {
    if (!reportData) {
        alert('è«‹å…ˆç”Ÿæˆå ±å‘Š');
        return;
    }

    const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `case_report_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function generateMarkdownText() {
    if (!reportData) return '';

    const info = reportData.client_info;
    let markdown = `# è·æ¸¸å‰µæ–°è·æ¶¯ç™¼å±•èˆ‡è«®è©¢ - å€‹æ¡ˆå ±å‘Š

**è«®è©¢ç·´ç¿’ç”Ÿ**ï¼š-
**å®Œæˆæ’°å¯«æ—¥æœŸ**ï¼š${new Date().toLocaleDateString('zh-TW')}

---

## ä¸€ã€æ¡ˆä¸»åŸºæœ¬è³‡æ–™

| é …ç›® | å…§å®¹ |
|-----|------|
| 1. å§“å(åŒ–å) | ${info.name || '-'} |
| 2. æ€§åˆ¥ | ${info.gender || '-'} |
| 3. å¹´ç´€ | ${info.age || '-'} |
| 4. éƒ¨é–€/è·æ¥­(å­¸æ ¡ç§‘ç³») | ${info.occupation || '-'} |
| 5. å­¸æ­· | ${info.education || '-'} |
| 6. ç¾å±…åœ° | ${info.location || '-'} |
| 7. ç¶“æ¿Ÿç‹€æ³ | ${info.economic_status || '-'} |
| 8. å®¶åº­é—œä¿‚ | ${info.family_relations || '-'} |
| 9. å…¶ä»–é‡è¦è³‡è¨Š | ${Array.isArray(info.other_info) ? info.other_info.join('; ') : (info.other_info || '-')} |

---

## äºŒã€æ­·ç¨‹åˆ†æ

| æ¬¡æ•¸/æ™¤è«‡æ™‚é–“ | æ™¤è«‡å…§å®¹æ¦‚è¿° | è«®è©¢å¸«è‡ªè©• |
|--------------|-------------|-----------|
| ç¬¬ä¸€æ¬¡æ™¤è«‡ | ${reportData.session_summary?.content || 'å¾é€å­—ç¨¿è‡ªå‹•ç”Ÿæˆ'} | ${reportData.session_summary?.self_evaluation || '-'} |

---

## ä¸‰ã€æ¦‚å¿µåŒ–åˆ†æ

`;

    const sections = parseConceptualization(reportData.conceptualization);

    markdown += `### ä¸»è¨´å•é¡Œ
${sections.main_issue || (reportData.main_concerns ? reportData.main_concerns.join('ã€') : '-')}

### æˆå› åˆ†æ
${sections.cause_analysis || '-'}

### æ™¤è«‡ç›®æ¨™(ç§»å‹•ä¸»è¨´)
${sections.counseling_goal || (reportData.counseling_goals ? reportData.counseling_goals.join('ã€') : '-')}

### ä»‹å…¥ç­–ç•¥
${sections.intervention || (reportData.techniques ? reportData.techniques.join('ã€') : '-')}

### ç›®å‰æˆæ•ˆè©•ä¼°
${sections.effectiveness || '-'}

---

## å››ã€å€‹äººåŒ–åˆ†æ

### æˆ‘å’Œé€™å€‹äººå·¥ä½œçš„æ„Ÿå—æ˜¯ï¼Ÿ
-

### é€™å€‹æ„Ÿå—çš„åŸå› æ˜¯ï¼Ÿ
-

### ç›®å‰è·Ÿé€™å€‹äººå·¥ä½œçš„å›°é›£
-

### æˆ‘æœƒæƒ³æ‰¾ç£å°è¨è«–çš„å•é¡Œæ˜¯ï¼Ÿ
-

---

## é—œéµå°è©±æ‘˜éŒ„

`;

    if (reportData.dialogue_excerpts && reportData.dialogue_excerpts.length > 0) {
        reportData.dialogue_excerpts.forEach(d => {
            const speaker = d.speaker === 'speaker1' ? 'è«®è©¢å¸«' : 'å€‹æ¡ˆ';
            markdown += `**${speaker}**: ${d.text}\n\n`;
        });
    } else {
        markdown += 'ç„¡å°è©±æ‘˜éŒ„\n\n';
    }

    markdown += `---

## åƒè€ƒç†è«–æ–‡ç»

`;

    if (reportData.theories && reportData.theories.length > 0) {
        reportData.theories.forEach((t, i) => {
            markdown += `**[${i+1}]** ${t.document} (ç›¸ä¼¼åº¦: ${(t.score * 100).toFixed(1)}%)\n\n${t.text}\n\n`;
        });
    } else {
        markdown += 'ç„¡åƒè€ƒç†è«–\n\n';
    }

    markdown += `---\n\n*å ±å‘Šç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}*\n`;

    return markdown;
}

function downloadMarkdown() {
    if (!reportData) {
        alert('è«‹å…ˆç”Ÿæˆå ±å‘Š');
        return;
    }

    const markdown = generateMarkdownText();
    const blob = new Blob([markdown], { type: 'text/markdown;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `case_report_${new Date().toISOString().split('T')[0]}.md`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function copyReport() {
    if (!reportData) {
        alert('è«‹å…ˆç”Ÿæˆå ±å‘Š');
        return;
    }

    const info = reportData.client_info;
    const sections = parseConceptualization(reportData.conceptualization);

    const fullReport = `è·æ¸¸å‰µæ–°è·æ¶¯ç™¼å±•èˆ‡è«®è©¢ - å€‹æ¡ˆå ±å‘Š

ä¸€ã€æ¡ˆä¸»åŸºæœ¬è³‡æ–™
å§“åï¼š${info.name || '-'}
æ€§åˆ¥ï¼š${info.gender || '-'}
å¹´é½¡ï¼š${info.age || '-'}
è·æ¥­/ç§‘ç³»ï¼š${info.occupation || '-'}
å­¸æ­·ï¼š${info.education || '-'}
ç¾å±…åœ°ï¼š${info.location || '-'}
ç¶“æ¿Ÿç‹€æ³ï¼š${info.economic_status || '-'}
å®¶åº­é—œä¿‚ï¼š${info.family_relations || '-'}

ä¸‰ã€æ¦‚å¿µåŒ–åˆ†æ

ä¸»è¨´å•é¡Œï¼š
${sections.main_issue || (reportData.main_concerns ? reportData.main_concerns.join('ã€') : '-')}

æˆå› åˆ†æï¼š
${sections.cause_analysis || '-'}

æ™¤è«‡ç›®æ¨™ï¼š
${sections.counseling_goal || (reportData.counseling_goals ? reportData.counseling_goals.join('ã€') : '-')}

ä»‹å…¥ç­–ç•¥ï¼š
${sections.intervention || (reportData.techniques ? reportData.techniques.join('ã€') : '-')}

æˆæ•ˆè©•ä¼°ï¼š
${sections.effectiveness || '-'}
    `.trim();

    navigator.clipboard.writeText(fullReport).then(() => {
        alert('âœ… å ±å‘Šå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
    }).catch(err => {
        console.error('è¤‡è£½å¤±æ•—:', err);
        alert('âŒ è¤‡è£½å¤±æ•—');
    });
}
</script>
{% endblock %}
