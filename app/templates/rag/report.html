{% extends "rag/base_sidebar.html" %}

{% block page_title %}å€‹æ¡ˆå ±å‘Šç”Ÿæˆ{% endblock %}

{% block page_content %}
<div class="mb-6">
    <h2 class="text-2xl font-bold text-white mb-2">å€‹æ¡ˆå ±å‘Šç”Ÿæˆ</h2>
    <p class="text-gray-400">æ ¹æ“šå°è©±è¨˜éŒ„èˆ‡åƒè€ƒè³‡æ–™ï¼Œè‡ªå‹•ç”Ÿæˆè·æ¶¯è«®è©¢å ±å‘Š</p>
</div>

<!-- Report Form -->
<div class="bg-gray-800 rounded-lg p-6 mb-6">
    <h3 class="text-xl font-semibold text-white mb-4">é€å­—ç¨¿è¼¸å…¥</h3>

    <div class="space-y-4">
        <div>
            <div class="flex justify-between items-center mb-2">
                <label class="block text-gray-300 text-sm">æ™¤è«‡é€å­—ç¨¿</label>
                <button
                    onclick="loadSampleTranscript()"
                    class="text-blue-400 hover:text-blue-300 text-xs underline"
                >
                    ğŸ“ è¼‰å…¥ç¯„ä¾‹é€å­—ç¨¿
                </button>
            </div>
            <textarea
                id="transcript"
                rows="12"
                placeholder="è²¼ä¸Šæ™¤è«‡é€å­—ç¨¿å…§å®¹ï¼ŒAI æœƒè‡ªå‹•åˆ†æä¸¦ç”Ÿæˆå€‹æ¡ˆå ±å‘Š..."
                class="w-full bg-gray-700 text-white rounded-lg px-4 py-2 border border-gray-600 font-mono text-sm"
            ></textarea>
            <p class="text-gray-400 text-xs mt-2">ğŸ’¡ æ”¯æ´ä»»ä½•æ ¼å¼çš„å°è©±è¨˜éŒ„ï¼ŒAI æœƒè‡ªå‹•è­˜åˆ¥èªªè©±è€…èˆ‡é—œéµè³‡è¨Š</p>
        </div>

        <div>
            <label class="block text-gray-300 text-sm mb-2">åƒèˆ‡äººæ•¸</label>
            <select id="numParticipants" class="w-full bg-gray-700 text-white rounded-lg px-4 py-2 border border-gray-600">
                <option value="2">2äººï¼ˆè«®è©¢å¸« + å€‹æ¡ˆï¼‰</option>
                <option value="3">3äºº</option>
                <option value="4">4äºº</option>
                <option value="5">5äºº</option>
            </select>
        </div>

        <div class="flex gap-3">
            <button
                onclick="generateReport()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition"
            >
                ğŸ¤– AI ç”Ÿæˆå ±å‘Š
            </button>
            <button
                onclick="clearForm()"
                class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-3 rounded-lg transition"
            >
                æ¸…ç©º
            </button>
        </div>
    </div>
</div>

<!-- Progress Section -->
<div id="progressSection" class="hidden bg-gray-800 rounded-lg p-6 mb-6">
    <h3 class="text-xl font-semibold text-white mb-4">ç”Ÿæˆé€²åº¦</h3>
    <div id="progressSteps" class="space-y-3">
        <!-- Progress steps will be dynamically added here -->
    </div>
</div>

<!-- Report Output -->
<div id="reportSection" class="hidden space-y-6">
    <!-- Client Info -->
    <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-xl font-semibold text-white mb-4">å€‹æ¡ˆåŸºæœ¬è³‡æ–™</h3>
        <div id="clientInfo" class="grid grid-cols-2 gap-4 text-sm">
            <!-- Will be populated by JS -->
        </div>
    </div>

    <!-- Key Dialogues -->
    <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-xl font-semibold text-white mb-4">é—œéµå°è©±æ‘˜éŒ„</h3>
        <div id="dialogueExcerpts" class="space-y-3">
            <!-- Will be populated by JS -->
        </div>
    </div>

    <!-- Report Content -->
    <div class="bg-gray-800 rounded-lg p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-white">å€‹æ¡ˆæ¦‚å¿µåŒ–</h3>
            <div class="flex gap-2">
                <button
                    onclick="copyReport()"
                    class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition text-sm"
                >
                    ğŸ“‹ è¤‡è£½
                </button>
                <button
                    onclick="downloadReport()"
                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition text-sm"
                >
                    ğŸ’¾ ä¸‹è¼‰
                </button>
            </div>
        </div>
        <div id="reportContent" class="bg-gray-900 rounded-lg p-6 text-gray-200 whitespace-pre-wrap leading-relaxed">
        </div>
    </div>

    <!-- Theories -->
    <div class="bg-gray-800 rounded-lg p-6">
        <h3 class="text-xl font-semibold text-white mb-4">åƒè€ƒç†è«–æ–‡ç»</h3>
        <div id="theoriesList" class="space-y-3">
            <!-- Will be populated by JS -->
        </div>
    </div>
</div>

<script>
let reportData = null;

async function loadSampleTranscript() {
    try {
        const response = await fetch('/static/sample_transcript.txt');
        const text = await response.text();
        document.getElementById('transcript').value = text;
        alert('âœ… ç¯„ä¾‹é€å­—ç¨¿å·²è¼‰å…¥ï¼');
    } catch (error) {
        console.error('Failed to load sample transcript:', error);
        alert('âŒ ç„¡æ³•è¼‰å…¥ç¯„ä¾‹é€å­—ç¨¿');
    }
}

async function generateReport() {
    const transcript = document.getElementById('transcript').value.trim();
    const numParticipants = parseInt(document.getElementById('numParticipants').value);

    if (!transcript) {
        alert('è«‹è¼¸å…¥æ™¤è«‡é€å­—ç¨¿');
        return;
    }

    // Reset and show progress
    document.getElementById('progressSection').classList.remove('hidden');
    document.getElementById('reportSection').classList.add('hidden');
    document.getElementById('progressSteps').innerHTML = '';

    try {
        // Use EventSource for SSE streaming (agent decides top_k automatically)
        const url = `/api/report/generate?transcript=${encodeURIComponent(transcript)}&num_participants=${numParticipants}`;
        const eventSource = new EventSource(url);

        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);

            if (data.status === 'error') {
                alert('éŒ¯èª¤: ' + data.message);
                eventSource.close();
                return;
            }

            // Update progress
            updateProgress(data);

            // If final step completed
            if (data.step === 5 && data.status === 'completed' && data.data?.report) {
                reportData = data.data.report;
                displayReport(reportData);
                document.getElementById('reportSection').classList.remove('hidden');
            }

            // Close on completion
            if (data.step === 6 && data.status === 'completed') {
                eventSource.close();
            }
        };

        eventSource.onerror = function(error) {
            console.error('EventSource error:', error);
            alert('é€£ç·šéŒ¯èª¤ï¼Œè«‹é‡è©¦');
            eventSource.close();
            document.getElementById('progressSection').classList.add('hidden');
        };

    } catch (error) {
        console.error('Report generation error:', error);
        alert('å ±å‘Šç”Ÿæˆå¤±æ•—: ' + error.message);
        document.getElementById('progressSection').classList.add('hidden');
    }
}

function updateProgress(data) {
    const stepMessages = {
        1: 'åˆ†æé€å­—ç¨¿çµæ§‹',
        2: 'è­˜åˆ¥é—œéµè­°é¡Œ',
        3: 'æª¢ç´¢ç›¸é—œç†è«–',
        4: 'ç”Ÿæˆå€‹æ¡ˆå ±å‘Š',
        5: 'æå–é—œéµå°è©±',
        6: 'å®Œæˆ'
    };

    const progressSteps = document.getElementById('progressSteps');
    let stepDiv = document.getElementById(`step-${data.step}`);

    if (!stepDiv) {
        stepDiv = document.createElement('div');
        stepDiv.id = `step-${data.step}`;
        stepDiv.className = 'flex items-center gap-3';
        progressSteps.appendChild(stepDiv);
    }

    const icon = data.status === 'completed' ? 'âœ…' :
                 data.status === 'processing' ? 'â³' : 'âŒ';

    stepDiv.innerHTML = `
        <span class="text-2xl">${icon}</span>
        <div class="flex-1">
            <div class="text-white font-medium">${stepMessages[data.step] || data.message}</div>
            <div class="text-sm text-gray-400">${data.message}</div>
        </div>
    `;
}

function displayReport(report) {
    // Client Info
    const clientInfo = document.getElementById('clientInfo');
    const info = report.client_info;
    clientInfo.innerHTML = `
        <div><span class="text-gray-400">å§“åï¼š</span><span class="text-white">${info.name}</span></div>
        <div><span class="text-gray-400">æ€§åˆ¥ï¼š</span><span class="text-white">${info.gender}</span></div>
        <div><span class="text-gray-400">å¹´é½¡ï¼š</span><span class="text-white">${info.age}</span></div>
        <div><span class="text-gray-400">è·æ¥­/ç§‘ç³»ï¼š</span><span class="text-white">${info.occupation}</span></div>
        <div><span class="text-gray-400">å­¸æ­·ï¼š</span><span class="text-white">${info.education}</span></div>
        <div><span class="text-gray-400">ç¾å±…åœ°ï¼š</span><span class="text-white">${info.location}</span></div>
        <div class="col-span-2"><span class="text-gray-400">å®¶åº­é—œä¿‚ï¼š</span><span class="text-white">${info.family_relations}</span></div>
    `;

    // Dialogue Excerpts
    const dialogueExcerpts = document.getElementById('dialogueExcerpts');
    if (report.dialogue_excerpts && report.dialogue_excerpts.length > 0) {
        dialogueExcerpts.innerHTML = report.dialogue_excerpts.map(d => {
            const speakerLabel = d.speaker === 'speaker1' ? 'è«®è©¢å¸«' : 'å€‹æ¡ˆ';
            const bgColor = d.speaker === 'speaker1' ? 'bg-blue-900/30' : 'bg-green-900/30';
            return `
                <div class="${bgColor} rounded-lg p-3">
                    <div class="text-xs text-gray-400 mb-1">${speakerLabel}</div>
                    <div class="text-gray-200">${d.text}</div>
                </div>
            `;
        }).join('');
    } else {
        dialogueExcerpts.innerHTML = '<div class="text-gray-400">ç„¡å°è©±æ‘˜éŒ„</div>';
    }

    // Report Content
    document.getElementById('reportContent').textContent = report.conceptualization;

    // Theories
    const theoriesList = document.getElementById('theoriesList');
    if (report.theories && report.theories.length > 0) {
        theoriesList.innerHTML = report.theories.map((theory, idx) => `
            <div class="bg-gray-700 rounded-lg p-4">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-blue-400 font-mono text-sm">[${idx + 1}]</span>
                    <span class="text-gray-400 text-xs">${(theory.score * 100).toFixed(1)}% ç›¸ä¼¼åº¦</span>
                </div>
                <div class="text-white text-sm mb-2">${theory.document}</div>
                <div class="text-gray-300 text-sm">${theory.text}</div>
            </div>
        `).join('');
    } else {
        theoriesList.innerHTML = '<div class="text-gray-400">ç„¡åƒè€ƒç†è«–</div>';
    }
}

function clearForm() {
    document.getElementById('transcript').value = '';
    document.getElementById('numParticipants').value = '2';
    document.getElementById('reportSection').classList.add('hidden');
    document.getElementById('progressSection').classList.add('hidden');
    reportData = null;
}

function copyReport() {
    if (!reportData) return;

    const fullReport = `
ã€å€‹æ¡ˆåŸºæœ¬è³‡æ–™ã€‘
å§“åï¼š${reportData.client_info.name}
æ€§åˆ¥ï¼š${reportData.client_info.gender}
å¹´é½¡ï¼š${reportData.client_info.age}
è·æ¥­/ç§‘ç³»ï¼š${reportData.client_info.occupation}
å­¸æ­·ï¼š${reportData.client_info.education}
ç¾å±…åœ°ï¼š${reportData.client_info.location}
å®¶åº­é—œä¿‚ï¼š${reportData.client_info.family_relations}

ã€å€‹æ¡ˆæ¦‚å¿µåŒ–ã€‘
${reportData.conceptualization}
    `.trim();

    navigator.clipboard.writeText(fullReport).then(() => {
        alert('å ±å‘Šå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
    }).catch(err => {
        console.error('è¤‡è£½å¤±æ•—:', err);
        alert('è¤‡è£½å¤±æ•—');
    });
}

function downloadReport() {
    if (!reportData) return;

    const fullReport = `
ã€å€‹æ¡ˆåŸºæœ¬è³‡æ–™ã€‘
å§“åï¼š${reportData.client_info.name}
æ€§åˆ¥ï¼š${reportData.client_info.gender}
å¹´é½¡ï¼š${reportData.client_info.age}
è·æ¥­/ç§‘ç³»ï¼š${reportData.client_info.occupation}
å­¸æ­·ï¼š${reportData.client_info.education}
ç¾å±…åœ°ï¼š${reportData.client_info.location}
å®¶åº­é—œä¿‚ï¼š${reportData.client_info.family_relations}

ã€å€‹æ¡ˆæ¦‚å¿µåŒ–ã€‘
${reportData.conceptualization}

ã€åƒè€ƒç†è«–ã€‘
${reportData.theories.map((t, i) => `[${i+1}] ${t.document}\n${t.text}`).join('\n\n')}
    `.trim();

    const blob = new Blob([fullReport], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `case_report_${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
</script>
{% endblock %}
