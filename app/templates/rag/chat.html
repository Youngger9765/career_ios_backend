{% extends "rag/base_sidebar.html" %}

{% block page_title %}AI å°è©±{% endblock %}

{% block page_content %}
<div class="mb-6">
    <h2 class="text-2xl font-bold text-white mb-2">AI å°è©± + File Search</h2>
    <p class="text-gray-400">èˆ‡ AI å°è©±ï¼Œè‡ªå‹•æœå°‹ç›¸é—œæ–‡ä»¶å…§å®¹</p>
</div>

<div class="grid grid-cols-3 gap-6" style="height: calc(100vh - 200px);">
<!-- Chat Container -->
<div class="col-span-2 bg-gray-800 rounded-lg p-6 flex flex-col">
    <!-- Messages Area -->
    <div id="chatMessages" class="flex-1 overflow-y-auto mb-4 space-y-4">
        <div class="text-gray-400 text-center py-8">
            é–‹å§‹å°è©±ï¼Œæˆ‘æœƒæ ¹æ“šä½ çš„å•é¡Œæœå°‹ç›¸é—œæ–‡ä»¶ä¸¦å›ç­”
        </div>
    </div>

    <!-- Input Area -->
    <div class="flex gap-3">
        <input
            type="text"
            id="messageInput"
            placeholder="è¼¸å…¥ä½ çš„å•é¡Œ..."
            class="flex-1 bg-gray-700 text-white rounded-lg px-4 py-3 border border-gray-600 focus:outline-none focus:border-blue-500"
            onkeypress="if(event.key === 'Enter') sendMessage()"
        >
        <button
            onclick="sendMessage()"
            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition"
        >
            ç™¼é€
        </button>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="hidden mt-2 text-blue-400 text-sm">
        <span class="animate-pulse">AI æ­£åœ¨æ€è€ƒä¸­...</span>
    </div>
</div>

<!-- Settings Panel -->
<div class="bg-gray-800 rounded-lg p-6 overflow-y-auto">
    <h3 class="text-lg font-semibold text-white mb-4">âš™ï¸ åƒæ•¸è¨­å®š</h3>

    <div class="space-y-4">
        <!-- Top K -->
        <div>
            <label class="block text-gray-300 text-sm mb-2">
                æª¢ç´¢æ–‡ç»æ•¸é‡ (top_k)
                <span class="text-gray-500 text-xs ml-1" id="topKValue">7</span>
            </label>
            <input
                type="range"
                id="topK"
                min="1"
                max="15"
                value="7"
                class="w-full"
                oninput="document.getElementById('topKValue').textContent = this.value"
            >
            <p class="text-gray-500 text-xs mt-1">æœå°‹æœ€ç›¸é—œçš„å‰ N ç¯‡æ–‡ç»</p>
        </div>

        <!-- Similarity Threshold -->
        <div>
            <label class="block text-gray-300 text-sm mb-2">
                ç›¸ä¼¼åº¦é–€æª» (similarity_threshold)
                <span class="text-gray-500 text-xs ml-1" id="similarityValue">0.35</span>
            </label>
            <input
                type="range"
                id="similarityThreshold"
                min="0"
                max="1"
                step="0.05"
                value="0.35"
                class="w-full"
                oninput="document.getElementById('similarityValue').textContent = parseFloat(this.value).toFixed(2)"
            >
            <p class="text-gray-500 text-xs mt-1">åªä½¿ç”¨ç›¸ä¼¼åº¦é«˜æ–¼æ­¤å€¼çš„æ–‡ç»</p>
        </div>

        <!-- Temperature -->
        <div>
            <label class="block text-gray-300 text-sm mb-2">
                å‰µæ„åº¦ (temperature)
                <span class="text-gray-500 text-xs ml-1" id="temperatureValue">0.6</span>
            </label>
            <input
                type="range"
                id="temperature"
                min="0"
                max="1"
                step="0.1"
                value="0.6"
                class="w-full"
                oninput="document.getElementById('temperatureValue').textContent = parseFloat(this.value).toFixed(1)"
            >
            <p class="text-gray-500 text-xs mt-1">0=ä¿å®ˆæº–ç¢º, 1=å‰µæ„ç™¼æ•£</p>
        </div>

        <!-- System Prompt -->
        <div>
            <label class="block text-gray-300 text-sm mb-2">ç³»çµ±æŒ‡ä»¤ (System Prompt)</label>
            <textarea
                id="systemPrompt"
                rows="8"
                class="w-full bg-gray-700 text-white rounded-lg px-3 py-2 border border-gray-600 text-xs font-mono"
                placeholder="è¼¸å…¥è‡ªè¨‚ç³»çµ±æŒ‡ä»¤..."
            >ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„è·æ¶¯è«®è©¢åŠ©ç†ã€‚è«‹æ ¹æ“šæä¾›çš„æ–‡æœ¬ä¾†å›ç­”å•é¡Œã€‚

å›ç­”æ™‚è«‹éµå¾ªï¼š
1. ä¸»è¦æ ¹æ“šæ–‡æœ¬å…§å®¹ä¸¦ç”¨ [1]ã€[2] æ¨™è¨»ä¾†æº
2. ä¿æŒå°ˆæ¥­ã€å®¢è§€ä¸”å…·åŒç†å¿ƒçš„èªæ°£
3. å¦‚æœæ–‡æœ¬ä¸­æ²’æœ‰ç›¸é—œè³‡è¨Šï¼Œè«‹æ˜ç¢ºèªªæ˜
4. é©ç•¶å¼•ç”¨é—œéµæ¦‚å¿µã€ç†è«–å’Œæœ€ä½³å¯¦è¸
5. è€ƒæ…®å€‹åˆ¥å·®ç•°å’Œå¤šå…ƒè§€é»
6. ä½¿ç”¨èˆ‡å•é¡Œç›¸åŒçš„èªè¨€å›ç­”ï¼ˆç¹é«”ä¸­æ–‡æˆ–è‹±æ–‡ï¼‰</textarea>
            <button
                onclick="resetSystemPrompt()"
                class="mt-2 text-xs text-blue-400 hover:text-blue-300"
            >
                â†» é‡ç½®ç‚ºé è¨­å€¼
            </button>
        </div>

        <!-- Reset All -->
        <div class="pt-4 border-t border-gray-700">
            <button
                onclick="resetAllSettings()"
                class="w-full bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition text-sm"
            >
                é‡ç½®æ‰€æœ‰è¨­å®š
            </button>
        </div>
    </div>
</div>
</div>

<script>
let messageHistory = [];

const DEFAULT_SYSTEM_PROMPT = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„è·æ¶¯è«®è©¢åŠ©ç†ã€‚è«‹æ ¹æ“šæä¾›çš„æ–‡æœ¬ä¾†å›ç­”å•é¡Œã€‚

å›ç­”æ™‚è«‹éµå¾ªï¼š
1. ä¸»è¦æ ¹æ“šæ–‡æœ¬å…§å®¹ä¸¦ç”¨ [1]ã€[2] æ¨™è¨»ä¾†æº
2. ä¿æŒå°ˆæ¥­ã€å®¢è§€ä¸”å…·åŒç†å¿ƒçš„èªæ°£
3. å¦‚æœæ–‡æœ¬ä¸­æ²’æœ‰ç›¸é—œè³‡è¨Šï¼Œè«‹æ˜ç¢ºèªªæ˜
4. é©ç•¶å¼•ç”¨é—œéµæ¦‚å¿µã€ç†è«–å’Œæœ€ä½³å¯¦è¸
5. è€ƒæ…®å€‹åˆ¥å·®ç•°å’Œå¤šå…ƒè§€é»
6. ä½¿ç”¨èˆ‡å•é¡Œç›¸åŒçš„èªè¨€å›ç­”ï¼ˆç¹é«”ä¸­æ–‡æˆ–è‹±æ–‡ï¼‰`;

function resetSystemPrompt() {
    document.getElementById('systemPrompt').value = DEFAULT_SYSTEM_PROMPT;
}

function resetAllSettings() {
    document.getElementById('topK').value = 7;
    document.getElementById('topKValue').textContent = '7';
    document.getElementById('similarityThreshold').value = 0.35;
    document.getElementById('similarityValue').textContent = '0.35';
    document.getElementById('temperature').value = 0.6;
    document.getElementById('temperatureValue').textContent = '0.6';
    resetSystemPrompt();
}

function addMessage(role, content, sources = []) {
    const messagesDiv = document.getElementById('chatMessages');

    // Remove welcome message if exists
    if (messagesDiv.querySelector('.text-gray-400.text-center')) {
        messagesDiv.innerHTML = '';
    }

    const messageDiv = document.createElement('div');
    messageDiv.className = role === 'user' ? 'flex justify-end' : 'flex justify-start';

    let sourcesHtml = '';
    if (sources && sources.length > 0) {
        sourcesHtml = `
            <div class="mt-3 pt-3 border-t border-gray-600">
                <div class="text-xs text-gray-400 mb-2">ğŸ“š åƒè€ƒä¾†æº (${sources.length})ï¼š</div>
                ${sources.map((src, idx) => `
                    <div class="text-xs text-blue-400 mb-1">
                        [${idx + 1}] ${src.document_title} (ç›¸ä¼¼åº¦: ${(src.similarity_score * 100).toFixed(1)}%)
                    </div>
                `).join('')}
            </div>
        `;
    }

    messageDiv.innerHTML = `
        <div class="${role === 'user' ? 'bg-blue-600' : 'bg-gray-700'} rounded-lg px-4 py-3 max-w-2xl">
            <div class="text-white whitespace-pre-wrap">${escapeHtml(content)}</div>
            ${sourcesHtml}
        </div>
    `;

    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();

    if (!message) return;

    // Add user message
    addMessage('user', message);
    messageHistory.push({ role: 'user', content: message });

    // Clear input
    input.value = '';

    // Show loading
    document.getElementById('loadingIndicator').classList.remove('hidden');

    try {
        // Get settings from UI
        const topK = parseInt(document.getElementById('topK').value);
        const similarityThreshold = parseFloat(document.getElementById('similarityThreshold').value);
        const temperature = parseFloat(document.getElementById('temperature').value);
        const systemPrompt = document.getElementById('systemPrompt').value.trim() || null;

        // Call chat API
        const response = await fetch('/api/rag/chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                question: message,
                top_k: topK,
                similarity_threshold: similarityThreshold,
                temperature: temperature,
                system_prompt: systemPrompt
            })
        });

        if (!response.ok) {
            throw new Error('Chat request failed');
        }

        const data = await response.json();

        // Add AI response
        addMessage('assistant', data.answer, data.citations || []);
        messageHistory.push({ role: 'assistant', content: data.answer });

    } catch (error) {
        console.error('Chat error:', error);
        addMessage('assistant', 'æŠ±æ­‰ï¼Œç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
    } finally {
        document.getElementById('loadingIndicator').classList.add('hidden');
    }
}

// Focus input on load
document.getElementById('messageInput').focus();
</script>
{% endblock %}
