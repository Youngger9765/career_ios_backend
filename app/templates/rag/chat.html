{% extends "rag/base_sidebar.html" %}

{% block page_title %}AI 對話{% endblock %}

{% block page_content %}
<div class="mb-6">
    <h2 class="text-2xl font-bold text-white mb-2">AI 對話 + File Search</h2>
    <p class="text-gray-400">與 AI 對話，自動搜尋相關文件內容</p>
</div>

<!-- Chat Container -->
<div class="bg-gray-800 rounded-lg p-6 flex flex-col" style="height: calc(100vh - 200px);">
    <!-- Messages Area -->
    <div id="chatMessages" class="flex-1 overflow-y-auto mb-4 space-y-4">
        <div class="text-gray-400 text-center py-8">
            開始對話，我會根據你的問題搜尋相關文件並回答
        </div>
    </div>

    <!-- Input Area -->
    <div class="flex gap-3">
        <input
            type="text"
            id="messageInput"
            placeholder="輸入你的問題..."
            class="flex-1 bg-gray-700 text-white rounded-lg px-4 py-3 border border-gray-600 focus:outline-none focus:border-blue-500"
            onkeypress="if(event.key === 'Enter') sendMessage()"
        >
        <button
            onclick="sendMessage()"
            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition"
        >
            發送
        </button>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="hidden mt-2 text-blue-400 text-sm">
        <span class="animate-pulse">AI 正在思考中...</span>
    </div>
</div>

<script>
let messageHistory = [];

function addMessage(role, content, sources = []) {
    const messagesDiv = document.getElementById('chatMessages');

    // Remove welcome message if exists
    if (messagesDiv.querySelector('.text-gray-400.text-center')) {
        messagesDiv.innerHTML = '';
    }

    const messageDiv = document.createElement('div');
    messageDiv.className = role === 'user' ? 'flex justify-end' : 'flex justify-start';

    let sourcesHtml = '';
    if (sources && sources.length > 0) {
        sourcesHtml = `
            <div class="mt-3 pt-3 border-t border-gray-600">
                <div class="text-xs text-gray-400 mb-2">📚 參考來源：</div>
                ${sources.map(src => `
                    <div class="text-xs text-blue-400 mb-1">
                        • ${src.document_title} (chunk #${src.ordinal}, 相似度: ${(src.similarity * 100).toFixed(1)}%)
                    </div>
                `).join('')}
            </div>
        `;
    }

    messageDiv.innerHTML = `
        <div class="${role === 'user' ? 'bg-blue-600' : 'bg-gray-700'} rounded-lg px-4 py-3 max-w-2xl">
            <div class="text-white whitespace-pre-wrap">${escapeHtml(content)}</div>
            ${sourcesHtml}
        </div>
    `;

    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();

    if (!message) return;

    // Add user message
    addMessage('user', message);
    messageHistory.push({ role: 'user', content: message });

    // Clear input
    input.value = '';

    // Show loading
    document.getElementById('loadingIndicator').classList.remove('hidden');

    try {
        // Call chat API
        const response = await fetch('/api/rag/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                history: messageHistory.slice(-10) // Last 10 messages for context
            })
        });

        if (!response.ok) {
            throw new Error('Chat request failed');
        }

        const data = await response.json();

        // Add AI response
        addMessage('assistant', data.response, data.sources || []);
        messageHistory.push({ role: 'assistant', content: data.response });

    } catch (error) {
        console.error('Chat error:', error);
        addMessage('assistant', '抱歉，發生錯誤：' + error.message);
    } finally {
        document.getElementById('loadingIndicator').classList.add('hidden');
    }
}

// Focus input on load
document.getElementById('messageInput').focus();
</script>
{% endblock %}
