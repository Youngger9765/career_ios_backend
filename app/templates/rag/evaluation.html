{% extends "rag/base_sidebar.html" %}

{% block page_title %}RAG è©•ä¼°ç³»çµ±{% endblock %}

{% block page_content %}
<div class="mb-6 flex justify-between items-center">
    <div>
        <h2 class="text-2xl font-bold text-gray-800 mb-2">RAG è©•ä¼°ç³»çµ±</h2>
        <p class="text-gray-600">ä½¿ç”¨ RAGAS è©•ä¼° RAG ç³»çµ±å“è³ªï¼Œè¿½è¹¤å¯¦é©—çµæœ</p>
    </div>
    <button onclick="document.getElementById('quickStartGuide').classList.toggle('hidden')"
            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition flex items-center gap-2">
        <span>ğŸš€</span>
        <span>å¿«é€Ÿé–‹å§‹</span>
    </button>
</div>

<!-- Quick Start Guide -->
<div id="quickStartGuide" class="hidden bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6 mb-6 border border-blue-200">
    <div class="flex items-start gap-4">
        <div class="text-4xl">ğŸš€</div>
        <div class="flex-1">
            <h3 class="text-xl font-bold text-gray-800 mb-3">é–‹å§‹ä½ çš„ç¬¬ä¸€å€‹è©•ä¼°å¯¦é©—</h3>
            <p class="text-gray-700 mb-4">é¸æ“‡ä¸€å€‹å¯¦é©—æ¨¡æ¿å¿«é€Ÿé–‹å§‹ï¼Œæˆ–è‡ªè¡Œè¨­å®šåƒæ•¸</p>

            <div class="grid grid-cols-3 gap-4 mb-4">
                <!-- Template 1: Baseline -->
                <div class="bg-white rounded-lg p-4 border-2 border-blue-300 hover:border-blue-500 cursor-pointer transition" onclick="applyTemplate('baseline')">
                    <div class="text-2xl mb-2">ğŸ“Š</div>
                    <h4 class="font-bold text-gray-800 mb-2">åŸºæº–æ¸¬è©¦</h4>
                    <p class="text-sm text-gray-600 mb-3">ä½¿ç”¨é è¨­åƒæ•¸å»ºç«‹åŸºæº–ç·šï¼Œè©•ä¼°ç•¶å‰ç³»çµ±è¡¨ç¾</p>
                    <div class="text-xs text-gray-500">
                        <div>â€¢ Chunk: 400 / Overlap: 80</div>
                        <div>â€¢ ä½¿ç”¨æ‰€æœ‰å•Ÿç”¨çš„æ¸¬è©¦é›†</div>
                    </div>
                </div>

                <!-- Template 2: Chunking Optimization -->
                <div class="bg-white rounded-lg p-4 border-2 border-green-300 hover:border-green-500 cursor-pointer transition" onclick="applyTemplate('chunking')">
                    <div class="text-2xl mb-2">ğŸ”¬</div>
                    <h4 class="font-bold text-gray-800 mb-2">Chunk å¤§å°å„ªåŒ–</h4>
                    <p class="text-sm text-gray-600 mb-3">æ¯”è¼ƒä¸åŒ chunk sizeï¼Œæ‰¾å‡ºæœ€ä½³é…ç½®</p>
                    <div class="text-xs text-gray-500">
                        <div>â€¢ æ¸¬è©¦ 200/400/600/800</div>
                        <div>â€¢ è‡ªå‹•æ‰¹æ¬¡å»ºç«‹å¯¦é©—</div>
                    </div>
                </div>

                <!-- Template 3: Advanced -->
                <div class="bg-white rounded-lg p-4 border-2 border-purple-300 hover:border-purple-500 cursor-pointer transition" onclick="applyTemplate('advanced')">
                    <div class="text-2xl mb-2">âš¡</div>
                    <h4 class="font-bold text-gray-800 mb-2">é€²éšè©•ä¼°</h4>
                    <p class="text-sm text-gray-600 mb-3">å®Œæ•´è©•ä¼° chunking + retrieval + generation</p>
                    <div class="text-xs text-gray-500">
                        <div>â€¢ End-to-End æ¸¬è©¦</div>
                        <div>â€¢ åŒ…å«æ‰€æœ‰ RAGAS æŒ‡æ¨™</div>
                    </div>
                </div>
            </div>

            <button onclick="closeQuickStart()" class="text-sm text-gray-500 hover:text-gray-700">ç•¥éï¼Œæ‰‹å‹•å»ºç«‹ â†’</button>
        </div>
    </div>
</div>

<!-- Smart Recommendations -->
<div id="smartRecommendations" class="hidden bg-yellow-50 rounded-lg p-4 mb-6 border border-yellow-200">
    <div class="flex items-start gap-3">
        <div class="text-2xl">ğŸ’¡</div>
        <div class="flex-1">
            <h4 class="font-bold text-gray-800 mb-2">æ™ºèƒ½å»ºè­°</h4>
            <div id="recommendationsContent"></div>
        </div>
        <button onclick="document.getElementById('smartRecommendations').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">âœ•</button>
    </div>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-4 gap-4 mb-8">
    <div class="bg-white rounded-lg p-4 shadow-md border border-gray-200">
        <div class="text-gray-600 text-sm mb-1">ç¸½å¯¦é©—æ•¸</div>
        <div class="text-3xl font-bold text-blue-600" id="totalExperiments">-</div>
    </div>
    <div class="bg-white rounded-lg p-4 shadow-md border border-gray-200">
        <div class="text-gray-600 text-sm mb-1">é‹è¡Œä¸­</div>
        <div class="text-3xl font-bold text-orange-600" id="runningExperiments">-</div>
    </div>
    <div class="bg-white rounded-lg p-4 shadow-md border border-gray-200">
        <div class="text-gray-600 text-sm mb-1">å·²å®Œæˆ</div>
        <div class="text-3xl font-bold text-green-600" id="completedExperiments">-</div>
    </div>
    <div class="bg-white rounded-lg p-4 shadow-md border border-gray-200">
        <div class="text-gray-600 text-sm mb-1">å¤±æ•—</div>
        <div class="text-3xl font-bold text-red-600" id="failedExperiments">-</div>
    </div>
</div>

<!-- Batch Run Matrix Experiments -->
<div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-6 mb-8 border border-purple-200">
    <div class="flex items-start gap-4">
        <div class="text-4xl">ğŸš€</div>
        <div class="flex-1">
            <h3 class="text-xl font-bold text-gray-800 mb-2">æ‰¹é‡åŸ·è¡ŒçŸ©é™£å¯¦é©—</h3>
            <p class="text-gray-700 mb-4">è‡ªå‹•åŸ·è¡Œæ‰€æœ‰ç­–ç•¥Ã—æ¸¬è©¦é›†Ã—Promptç‰ˆæœ¬çš„çµ„åˆï¼Œè·³éå·²å®Œæˆçš„å¯¦é©—</p>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <!-- Prompt Versions Selection -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">é¸æ“‡ Prompt ç‰ˆæœ¬</label>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="promptV20" checked class="w-4 h-4 text-indigo-600 rounded">
                            <span class="text-gray-700">v2.0</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="promptV21" checked class="w-4 h-4 text-indigo-600 rounded">
                            <span class="text-gray-700">v2.1</span>
                        </label>
                    </div>
                </div>

                <!-- Summary -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">å¯¦é©—è¦æ¨¡</label>
                    <div class="bg-white rounded-lg p-3 border border-purple-200">
                        <div class="text-sm text-gray-600 mb-1">â€¢ 5 å€‹ Chunk ç­–ç•¥</div>
                        <div class="text-sm text-gray-600 mb-1">â€¢ 4 å€‹æ¸¬è©¦é›†</div>
                        <div class="text-sm text-gray-600 mb-1" id="batchPromptCount">â€¢ 2 å€‹ Prompt ç‰ˆæœ¬</div>
                        <div class="text-sm font-bold text-purple-600 mt-2" id="batchTotalCount">ç¸½è¨ˆï¼šæœ€å¤š 40 å€‹å¯¦é©—</div>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="startBatchRun()"
                        id="batchRunBtn"
                        class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:from-purple-700 hover:to-pink-700 transition font-semibold shadow-lg">
                    ğŸš€ é–‹å§‹æ‰¹é‡åŸ·è¡Œ
                </button>
                <div id="batchProgress" class="hidden flex items-center gap-2">
                    <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-purple-600"></div>
                    <span class="text-sm text-gray-700" id="batchProgressText">æº–å‚™ä¸­...</span>
                </div>
            </div>

            <div class="mt-3 text-xs text-gray-500">
                â„¹ï¸ ç³»çµ±æœƒè‡ªå‹•è·³éå·²æœ‰å®Œæ•´ 4 å€‹ RAGAS æŒ‡æ¨™çš„å¯¦é©—ï¼Œé¿å…é‡è¤‡åŸ·è¡Œ
            </div>
        </div>
    </div>
</div>

<!-- Create Experiment Section -->
<div class="bg-white rounded-lg p-6 mb-6 shadow-md border border-gray-200">
    <h3 class="text-xl font-semibold text-gray-800 mb-4">å»ºç«‹æ–°å¯¦é©—</h3>

    <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
            <label class="block text-gray-700 text-sm font-medium mb-2">å¯¦é©—åç¨±</label>
            <input type="text" id="expName" placeholder="ä¾‹å¦‚: chunk_size_400_test"
                class="w-full bg-white text-gray-800 rounded-lg px-4 py-2 border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
        </div>
        <div>
            <label class="block text-gray-700 text-sm font-medium mb-2">å¯¦é©—é¡å‹</label>
            <select id="expType" class="w-full bg-white text-gray-800 rounded-lg px-4 py-2 border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                <option value="chunking">Chunking</option>
                <option value="retrieval">Retrieval</option>
                <option value="generation">Generation</option>
                <option value="end_to_end" selected>End-to-End</option>
            </select>
        </div>
    </div>

    <div class="grid grid-cols-4 gap-4 mb-4">
        <div>
            <label class="block text-gray-700 text-sm font-medium mb-2">Chunk Strategy</label>
            <select id="chunkStrategy" onchange="updateChunkParams()" class="w-full bg-white text-gray-800 rounded-lg px-4 py-2 border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                <option value="">é è¨­ (ç„¡éæ¿¾)</option>
                <option value="rec_256_50">rec_256_50</option>
                <option value="rec_400_80" selected>rec_400_80</option>
                <option value="rec_512_100">rec_512_100</option>
                <option value="rec_1024_200">rec_1024_200</option>
                <option value="rec_2048_400">rec_2048_400</option>
            </select>
        </div>
        <div>
            <label class="block text-gray-700 text-sm font-medium mb-2">Chunking æ–¹æ³•</label>
            <select id="chunkingMethod" class="w-full bg-white text-gray-800 rounded-lg px-4 py-2 border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                <option value="fixed">Fixed Size</option>
                <option value="recursive">Recursive</option>
                <option value="semantic">Semantic</option>
            </select>
        </div>
        <div>
            <label class="block text-gray-700 text-sm font-medium mb-2">Chunk Size</label>
            <input type="number" id="chunkSize" value="400"
                class="w-full bg-white text-gray-800 rounded-lg px-4 py-2 border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
        </div>
        <div>
            <label class="block text-gray-700 text-sm font-medium mb-2">Overlap</label>
            <input type="number" id="chunkOverlap" value="80"
                class="w-full bg-white text-gray-800 rounded-lg px-4 py-2 border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
        </div>
    </div>

    <div class="mb-4">
        <label class="block text-gray-700 text-sm font-medium mb-2">æè¿° (é¸å¡«)</label>
        <textarea id="expDescription" rows="2" placeholder="å¯¦é©—ç›®çš„å’Œé æœŸçµæœ..."
            class="w-full bg-white text-gray-800 rounded-lg px-4 py-2 border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200"></textarea>
    </div>

    <div class="flex gap-3">
        <button onclick="createExperiment()"
            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition shadow-sm">
            å»ºç«‹å¯¦é©—
        </button>
        <button onclick="runBatchEvaluation()"
            class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white px-6 py-2 rounded-lg transition shadow-lg flex items-center gap-2">
            <span class="text-xl">ğŸš€</span>
            <span class="font-semibold">æ‰¾å‡ºæœ€ä½³å›ç­”å“è³ªè¨­å®š</span>
            <span class="text-xs bg-white/20 px-2 py-1 rounded">ä¸€éµè‡ªå‹•</span>
        </button>
    </div>
</div>

<!-- Step-by-Step Wizard Modal -->
<div id="wizardModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-8 max-w-3xl w-full mx-4 shadow-2xl">

        <!-- Step Indicator -->
        <div class="mb-8">
            <div class="flex items-center justify-between mb-4">
                <div id="step1Indicator" class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-purple-600 text-white flex items-center justify-center font-bold">1</div>
                    <span class="font-semibold text-purple-600">é¸æ“‡ç­–ç•¥</span>
                </div>
                <div class="flex-1 h-1 bg-gray-200 mx-2"></div>
                <div id="step2Indicator" class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-bold">2</div>
                    <span class="font-semibold text-gray-400">é¸æ“‡æ¸¬è©¦é›†</span>
                </div>
                <div class="flex-1 h-1 bg-gray-200 mx-2"></div>
                <div id="step3Indicator" class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-bold">3</div>
                    <span class="font-semibold text-gray-400">ç¢ºèªé–‹å§‹</span>
                </div>
            </div>
        </div>

        <!-- Step 1: Strategy Selection -->
        <div id="wizardStep1" class="wizard-step">
            <div class="mb-6">
                <h3 class="text-2xl font-bold text-gray-800 mb-2">ğŸ“Š æ­¥é©Ÿ1: é¸æ“‡è¦æ¸¬è©¦çš„ Chunk ç­–ç•¥</h3>
                <p class="text-gray-600">é¸æ“‡æ‚¨æƒ³æ¯”è¼ƒçš„åˆ†å¡Šç­–ç•¥ï¼ˆå¯è¤‡é¸ï¼‰</p>
            </div>
            <div id="strategyCheckboxList" class="space-y-3 mb-6 max-h-96 overflow-y-auto">
                <!-- Will be populated by JavaScript -->
            </div>
            <div class="flex gap-3">
                <button onclick="cancelWizard()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-3 rounded-lg transition font-semibold">
                    å–æ¶ˆ
                </button>
                <button onclick="goToStep2()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg transition font-semibold">
                    ä¸‹ä¸€æ­¥ â†’
                </button>
            </div>
        </div>

        <!-- Step 2: Test Set Selection -->
        <div id="wizardStep2" class="wizard-step hidden">
            <div class="mb-6">
                <h3 class="text-2xl font-bold text-gray-800 mb-2">ğŸ“‹ æ­¥é©Ÿ2: é¸æ“‡æ¸¬è©¦é›†</h3>
                <p class="text-gray-600">é¸æ“‡æ‚¨æƒ³ä½¿ç”¨çš„æ¸¬è©¦é›†ï¼ˆå¯è¤‡é¸ï¼‰</p>
            </div>
            <div id="testSetCheckboxList" class="space-y-2 max-h-96 overflow-y-auto border border-gray-200 rounded-lg p-3 mb-6">
                <!-- Will be populated by JavaScript -->
            </div>
            <div class="flex gap-3">
                <button onclick="goToStep1()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-3 rounded-lg transition font-semibold">
                    â† ä¸Šä¸€æ­¥
                </button>
                <button onclick="goToStep3()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg transition font-semibold">
                    ä¸‹ä¸€æ­¥ â†’
                </button>
            </div>
        </div>

        <!-- Step 3: Confirmation -->
        <div id="wizardStep3" class="wizard-step hidden">
            <div class="mb-6">
                <h3 class="text-2xl font-bold text-gray-800 mb-2">âœ… æ­¥é©Ÿ3: ç¢ºèªä¸¦é–‹å§‹æ¸¬è©¦</h3>
                <p class="text-gray-600">è«‹ç¢ºèªæ‚¨çš„é¸æ“‡</p>
            </div>

            <div class="space-y-4 mb-6">
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                    <div class="font-semibold text-purple-900 mb-2">å·²é¸æ“‡ç­–ç•¥ (<span id="selectedStrategyCount">0</span>)</div>
                    <div id="selectedStrategyList" class="text-sm text-gray-700"></div>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="font-semibold text-blue-900 mb-2">å·²é¸æ“‡æ¸¬è©¦é›† (<span id="selectedTestSetCount">0</span>)</div>
                    <div id="selectedTestSetList" class="text-sm text-gray-700"></div>
                </div>

                <div class="bg-gradient-to-r from-green-50 to-teal-50 border border-green-200 rounded-lg p-4">
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <div class="text-xs text-gray-600">ç¸½å¯¦é©—æ•¸</div>
                            <div class="font-bold text-lg text-gray-800" id="finalExperimentCount">0 å€‹</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-600">é ä¼°æ™‚é–“</div>
                            <div class="font-bold text-lg text-gray-800" id="finalEstimatedTime">0 åˆ†é˜</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-600">è©•ä¼°æŒ‡æ¨™</div>
                            <div class="font-bold text-lg text-gray-800">æº–ç¢ºåº¦+ç›¸é—œæ€§</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="goToStep2()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-3 rounded-lg transition font-semibold">
                    â† ä¸Šä¸€æ­¥
                </button>
                <button onclick="startBatchEvaluation()" class="flex-1 bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-700 hover:to-teal-700 text-white px-6 py-3 rounded-lg transition font-semibold">
                    ğŸš€ é–‹å§‹æ¸¬è©¦
                </button>
            </div>
        </div>

    </div>
</div>

<!-- Batch Evaluation Progress Modal -->
<div id="batchProgressModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4 shadow-2xl">
        <div class="mb-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-2">ğŸš€ æ­£åœ¨å°‹æ‰¾æœ€ä½³å›ç­”å“è³ªè¨­å®š</h3>
            <p class="text-gray-600">ç³»çµ±æœƒè‡ªå‹•æ¸¬è©¦ 5 ç¨®ä¸åŒçš„è¨­å®šï¼Œæ‰¾å‡ºæœ€é©åˆæ‚¨çš„é…ç½®</p>
        </div>

        <!-- Progress Bar -->
        <div class="mb-6">
            <div class="flex justify-between text-sm text-gray-600 mb-2">
                <span id="progressText">æº–å‚™é–‹å§‹...</span>
                <span id="progressPercent">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                <div id="progressBar" class="bg-gradient-to-r from-purple-500 to-pink-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>

        <!-- Current Strategy Info -->
        <div id="currentStrategyInfo" class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 mb-4 hidden">
            <div class="flex items-center gap-3 mb-2">
                <span class="text-2xl">ğŸ”¬</span>
                <div>
                    <div class="font-semibold text-gray-800" id="currentStrategyName">æ­£åœ¨æ¸¬è©¦...</div>
                    <div class="text-sm text-gray-600" id="currentStrategyDesc">æ­£åœ¨ç”Ÿæˆæ¸¬è©¦æ¡ˆä¾‹...</div>
                </div>
            </div>
        </div>

        <!-- Results Summary -->
        <div id="resultsContainer" class="space-y-2 max-h-60 overflow-y-auto">
            <!-- Results will be added here dynamically -->
        </div>

        <!-- Close Button (hidden until complete) -->
        <button id="closeProgressBtn" onclick="closeBatchProgress()" class="hidden w-full mt-6 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition font-semibold">
            æŸ¥çœ‹å®Œæ•´å ±å‘Š
        </button>
    </div>
</div>

<!-- Batch Evaluation Report Modal -->
<div id="batchReportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-8 max-w-4xl w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-start mb-6">
            <div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">ğŸ“Š æœ€ä½³å›ç­”å“è³ªè¨­å®šå ±å‘Š</h3>
                <p class="text-gray-600">æ ¹æ“šæ¸¬è©¦çµæœï¼Œç‚ºæ‚¨æ¨è–¦æœ€ä½³è¨­å®š</p>
            </div>
            <button onclick="closeBatchReport()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>

        <div id="batchReportContent">
            <!-- Report content will be inserted here -->
        </div>
    </div>
</div>

<!-- Experiments List -->
<div class="bg-white rounded-lg p-6 shadow-md border border-gray-200">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold text-gray-800">å¯¦é©—åˆ—è¡¨</h3>
        <div class="flex gap-2">
            <select id="filterStatus" onchange="loadExperiments()"
                class="bg-white text-gray-800 rounded-lg px-3 py-1 border border-gray-300 text-sm">
                <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                <option value="pending">å¾…åŸ·è¡Œ</option>
                <option value="running">é‹è¡Œä¸­</option>
                <option value="completed">å·²å®Œæˆ</option>
                <option value="failed">å¤±æ•—</option>
            </select>
        </div>
    </div>

    <div class="overflow-x-auto">
        <table class="w-full text-left">
            <thead>
                <tr class="border-b-2 border-gray-200">
                    <th class="py-3 px-4 text-gray-700 font-semibold">å¯¦é©—åç¨±</th>
                    <th class="py-3 px-4 text-gray-700 font-semibold">é¡å‹</th>
                    <th class="py-3 px-4 text-gray-700 font-semibold">Strategy</th>
                    <th class="py-3 px-4 text-gray-700 font-semibold">Chunking</th>
                    <th class="py-3 px-4 text-gray-700 font-semibold">ç‹€æ…‹</th>
                    <th class="py-3 px-4 text-gray-700 font-semibold">Faithfulness</th>
                    <th class="py-3 px-4 text-gray-700 font-semibold">Answer Relevancy</th>
                    <th class="py-3 px-4 text-gray-700 font-semibold">å»ºç«‹æ™‚é–“</th>
                    <th class="py-3 px-4 text-gray-700 font-semibold">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="experimentsList">
                <tr>
                    <td colspan="9" class="text-gray-500 text-center py-8">è¼‰å…¥ä¸­...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Run Evaluation Modal -->
<div id="runModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto shadow-2xl">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-800">åŸ·è¡Œè©•ä¼°</h3>
            <button onclick="closeRunModal()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        </div>

        <div id="runModalContent">
            <!-- Tab é¸æ“‡ -->
            <div class="flex gap-4 mb-4 border-b">
                <button onclick="switchTab('testset')" id="testsetTab"
                    class="px-4 py-2 border-b-2 border-blue-500 text-blue-600 font-medium">
                    é¸æ“‡æ¸¬è©¦é›†
                </button>
                <button onclick="switchTab('manual')" id="manualTab"
                    class="px-4 py-2 text-gray-600 hover:text-gray-800">
                    æ‰‹å‹•è¼¸å…¥
                </button>
            </div>

            <!-- æ¸¬è©¦é›†é¸æ“‡ -->
            <div id="testsetContent" class="space-y-4">
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">é¸æ“‡æ¸¬è©¦é›†</label>
                    <select id="testsetSelect" onchange="loadTestSetPreview()" class="w-full bg-white text-gray-800 rounded-lg px-4 py-2 border border-gray-300">
                        <option value="">è¼‰å…¥ä¸­...</option>
                    </select>
                </div>
                <div id="testsetPreview" class="hidden bg-gray-50 rounded-lg p-4 border">
                    <div class="text-sm text-gray-600 mb-2">æ¸¬è©¦é›†é è¦½ï¼š</div>
                    <div id="testsetInfo" class="text-sm"></div>
                </div>

                <!-- Progress Indicator -->
                <div id="evaluationProgress" class="hidden bg-blue-50 rounded-lg p-4 border border-blue-200">
                    <div class="flex items-center gap-3">
                        <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <div class="flex-1">
                            <div id="progressText" class="text-sm font-medium text-blue-900"></div>
                            <div id="progressDetail" class="text-xs text-blue-700 mt-1"></div>
                        </div>
                    </div>
                </div>

                <button id="runEvalBtn" onclick="runEvaluationWithTestSet()"
                    class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                    ä½¿ç”¨æ­¤æ¸¬è©¦é›†åŸ·è¡Œè©•ä¼°
                </button>
            </div>

            <!-- æ‰‹å‹•è¼¸å…¥ -->
            <div id="manualContent" class="hidden space-y-4">
                <p class="text-gray-600 mb-4">è«‹è¼¸å…¥æ¸¬è©¦æ¡ˆä¾‹ (JSON æ ¼å¼)ï¼š</p>
                <textarea id="testCasesJson" rows="10"
                    class="w-full bg-white text-gray-800 rounded-lg px-4 py-2 border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 font-mono text-sm"
                    placeholder='[
  {
    "question": "å¦‚ä½•æº–å‚™è»Ÿé«”å·¥ç¨‹å¸«é¢è©¦ï¼Ÿ",
    "answer": "...",
    "contexts": ["...", "..."],
    "ground_truth": "..." (optional)
  }
]'></textarea>

                <div class="flex gap-3">
                    <button onclick="runEvaluation()"
                        class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition">
                        åŸ·è¡Œè©•ä¼°
                    </button>
                    <button onclick="loadSampleTestCases()"
                        class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg transition">
                        è¼‰å…¥ç¯„ä¾‹
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Details Modal -->
<div id="detailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[85vh] overflow-y-auto shadow-2xl">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-800">å¯¦é©—è©³æƒ…</h3>
            <button onclick="closeDetailsModal()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        </div>

        <div id="detailsContent" class="space-y-4">
            <!-- Content will be loaded here -->
        </div>
    </div>
</div>

<script>
let currentExperimentId = null;
let currentTestSets = [];
let selectedTestSet = null;

async function loadExperiments() {
    try {
        const statusFilter = document.getElementById('filterStatus').value;
        const params = new URLSearchParams();
        if (statusFilter) params.append('status', statusFilter);

        const response = await fetch(`/api/rag/evaluation/experiments?${params}`);
        if (!response.ok) throw new Error('Failed to load experiments');

        const experiments = await response.json();

        // Update stats
        const total = experiments.length;
        const running = experiments.filter(e => e.status === 'running').length;
        const completed = experiments.filter(e => e.status === 'completed').length;
        const failed = experiments.filter(e => e.status === 'failed').length;

        document.getElementById('totalExperiments').textContent = total;
        document.getElementById('runningExperiments').textContent = running;
        document.getElementById('completedExperiments').textContent = completed;
        document.getElementById('failedExperiments').textContent = failed;

        // Display experiments
        const list = document.getElementById('experimentsList');
        if (experiments.length > 0) {
            list.innerHTML = experiments.map(exp => {
                const status = getStatusBadge(exp.status);
                const chunking = exp.chunking_method ? `${exp.chunking_method} (${exp.chunk_size}/${exp.chunk_overlap})` : '-';
                const strategy = exp.chunk_strategy || '-';

                return `
                <tr class="border-b border-gray-200 hover:bg-blue-50 transition">
                    <td class="py-4 px-4">
                        <div class="text-gray-800 font-medium">${exp.name}</div>
                        ${exp.description ? `<div class="text-gray-500 text-xs mt-1">${exp.description}</div>` : ''}
                    </td>
                    <td class="py-4 px-4 text-gray-600">${exp.experiment_type}</td>
                    <td class="py-4 px-4 text-gray-600 text-sm font-mono">${strategy}</td>
                    <td class="py-4 px-4 text-gray-600 text-sm">${chunking}</td>
                    <td class="py-4 px-4">${status}</td>
                    <td class="py-4 px-4 text-gray-600">${formatMetric(exp.avg_faithfulness)}</td>
                    <td class="py-4 px-4 text-gray-600">${formatMetric(exp.avg_answer_relevancy)}</td>
                    <td class="py-4 px-4 text-gray-500 text-sm">${new Date(exp.created_at).toLocaleString('zh-TW')}</td>
                    <td class="py-4 px-4">
                        <div class="flex gap-2">
                            ${exp.status === 'pending' || exp.status === 'failed' ? `
                                <button onclick="openRunModal('${exp.id}')"
                                    class="text-green-600 hover:text-green-800 hover:bg-green-100 px-3 py-1 rounded text-sm transition">
                                    ${exp.status === 'failed' ? 'é‡æ–°åŸ·è¡Œ' : 'åŸ·è¡Œ'}
                                </button>
                            ` : ''}
                            ${exp.status === 'completed' || exp.status === 'failed' ? `
                                <button onclick="viewExperimentDetails('${exp.id}')"
                                    class="text-blue-600 hover:text-blue-800 hover:bg-blue-100 px-3 py-1 rounded text-sm transition">
                                    æŸ¥çœ‹
                                </button>
                            ` : ''}
                            ${exp.mlflow_run_id && exp.status === 'completed' ? `
                                <a href="http://127.0.0.1:5000/#/experiments/${exp.mlflow_experiment_id}/runs/${exp.mlflow_run_id}"
                                    target="_blank"
                                    class="text-purple-600 hover:text-purple-800 hover:bg-purple-100 px-3 py-1 rounded text-sm transition">
                                    MLflow
                                </a>
                            ` : ''}
                        </div>
                    </td>
                </tr>
                `;
            }).join('');
        } else {
            list.innerHTML = '<tr><td colspan="9" class="text-gray-500 text-center py-8">å°šç„¡å¯¦é©—</td></tr>';
        }
    } catch (error) {
        console.error('Failed to load experiments:', error);
        document.getElementById('experimentsList').innerHTML =
            '<tr><td colspan="9" class="text-red-600 text-center py-8">è¼‰å…¥å¤±æ•—: ' + error.message + '</td></tr>';
    }
}

function getStatusBadge(status) {
    const badges = {
        'pending': '<span class="px-2 py-1 bg-gray-200 text-gray-700 rounded-full text-xs font-medium">å¾…åŸ·è¡Œ</span>',
        'running': '<span class="px-2 py-1 bg-orange-200 text-orange-700 rounded-full text-xs font-medium">é‹è¡Œä¸­</span>',
        'completed': '<span class="px-2 py-1 bg-green-200 text-green-700 rounded-full text-xs font-medium">å·²å®Œæˆ</span>',
        'failed': '<span class="px-2 py-1 bg-red-200 text-red-700 rounded-full text-xs font-medium">å¤±æ•—</span>'
    };
    return badges[status] || status;
}

function formatMetric(value) {
    return value ? value.toFixed(3) : '-';
}

async function createExperiment() {
    const name = document.getElementById('expName').value.trim();
    const description = document.getElementById('expDescription').value.trim();
    const experimentType = document.getElementById('expType').value;
    const chunkStrategy = document.getElementById('chunkStrategy').value || null;
    const chunkingMethod = document.getElementById('chunkingMethod').value;
    const chunkSize = parseInt(document.getElementById('chunkSize').value);
    const chunkOverlap = parseInt(document.getElementById('chunkOverlap').value);

    if (!name) {
        alert('è«‹è¼¸å…¥å¯¦é©—åç¨±');
        return;
    }

    try {
        const response = await fetch('/api/rag/evaluation/experiments', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name,
                description: description || null,
                experiment_type: experimentType,
                chunk_strategy: chunkStrategy,
                chunking_method: chunkingMethod,
                chunk_size: chunkSize,
                chunk_overlap: chunkOverlap
            })
        });

        if (response.ok) {
            alert('å¯¦é©—å»ºç«‹æˆåŠŸï¼');
            // Clear form
            document.getElementById('expName').value = '';
            document.getElementById('expDescription').value = '';
            loadExperiments();
        } else {
            const error = await response.json();
            alert('å»ºç«‹å¤±æ•—: ' + (error.detail || 'æœªçŸ¥éŒ¯èª¤'));
        }
    } catch (error) {
        alert('å»ºç«‹å¤±æ•—: ' + error.message);
    }
}

function openRunModal(experimentId) {
    currentExperimentId = experimentId;
    document.getElementById('runModal').classList.remove('hidden');
    // Load test sets when modal opens
    loadTestSets();
}

function closeRunModal() {
    document.getElementById('runModal').classList.add('hidden');
    currentExperimentId = null;
}

function loadSampleTestCases() {
    const sample = [
        {
            "question": "å¦‚ä½•æº–å‚™è»Ÿé«”å·¥ç¨‹å¸«é¢è©¦ï¼Ÿ",
            "answer": "æº–å‚™è»Ÿé«”å·¥ç¨‹å¸«é¢è©¦éœ€è¦ï¼š1. ç†Ÿæ‚‰æ¼”ç®—æ³•å’Œè³‡æ–™çµæ§‹ 2. ç·´ç¿’è§£é¡Œ 3. æº–å‚™ç³»çµ±è¨­è¨ˆ 4. äº†è§£å…¬å¸æ–‡åŒ–",
            "contexts": [
                "è»Ÿé«”å·¥ç¨‹å¸«é¢è©¦é€šå¸¸åŒ…å«æ¼”ç®—æ³•é¡Œã€ç³»çµ±è¨­è¨ˆå’Œè¡Œç‚ºé¢è©¦",
                "LeetCode æ˜¯å¾ˆå¥½çš„ç·´ç¿’å¹³å°"
            ],
            "ground_truth": "éœ€è¦æ¼”ç®—æ³•ã€ç³»çµ±è¨­è¨ˆå’Œè¡Œç‚ºé¢è©¦çš„æº–å‚™"
        },
        {
            "question": "è½‰è·åˆ°ç§‘æŠ€æ¥­éœ€è¦ä»€éº¼æº–å‚™ï¼Ÿ",
            "answer": "è½‰è·åˆ°ç§‘æŠ€æ¥­éœ€è¦ï¼š1. å­¸ç¿’ç¨‹å¼èªè¨€ 2. å»ºç«‹ä½œå“é›† 3. åƒåŠ ç¤¾ç¾¤æ´»å‹• 4. æº–å‚™é¢è©¦",
            "contexts": [
                "è½‰è·è€…å¯ä»¥é€éç·šä¸Šèª²ç¨‹å­¸ç¿’",
                "GitHub ä½œå“é›†å¾ˆé‡è¦"
            ]
        }
    ];
    document.getElementById('testCasesJson').value = JSON.stringify(sample, null, 2);
}

async function runEvaluation() {
    if (!currentExperimentId) return;

    const testCasesText = document.getElementById('testCasesJson').value.trim();
    if (!testCasesText) {
        alert('è«‹è¼¸å…¥æ¸¬è©¦æ¡ˆä¾‹');
        return;
    }

    try {
        const testCases = JSON.parse(testCasesText);

        const response = await fetch(`/api/rag/evaluation/experiments/${currentExperimentId}/run`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                test_cases: testCases,
                include_ground_truth: testCases.some(tc => tc.ground_truth)
            })
        });

        if (response.ok) {
            alert('è©•ä¼°åŸ·è¡ŒæˆåŠŸï¼');
            closeRunModal();
            loadExperiments();
        } else {
            const error = await response.json();
            alert('åŸ·è¡Œå¤±æ•—: ' + (error.detail || 'æœªçŸ¥éŒ¯èª¤'));
        }
    } catch (error) {
        alert('åŸ·è¡Œå¤±æ•—: ' + error.message);
    }
}

// Test Set Management
function switchTab(tab) {
    if (tab === 'testset') {
        document.getElementById('testsetContent').classList.remove('hidden');
        document.getElementById('manualContent').classList.add('hidden');
        document.getElementById('testsetTab').className = 'px-4 py-2 border-b-2 border-blue-500 text-blue-600 font-medium';
        document.getElementById('manualTab').className = 'px-4 py-2 text-gray-600 hover:text-gray-800';
        loadTestSets();
    } else {
        document.getElementById('testsetContent').classList.add('hidden');
        document.getElementById('manualContent').classList.remove('hidden');
        document.getElementById('testsetTab').className = 'px-4 py-2 text-gray-600 hover:text-gray-800';
        document.getElementById('manualTab').className = 'px-4 py-2 border-b-2 border-blue-500 text-blue-600 font-medium';
    }
}

async function loadTestSets() {
    const select = document.getElementById('testsetSelect');
    select.innerHTML = '<option value="">è¼‰å…¥ä¸­...</option>';

    try {
        const response = await fetch('/api/rag/evaluation/testsets/?is_active=true');
        if (!response.ok) throw new Error('Failed to load test sets');

        currentTestSets = await response.json();

        if (currentTestSets.length > 0) {
            select.innerHTML = '<option value="">é¸æ“‡æ¸¬è©¦é›†...</option>' +
                currentTestSets.map(ts => `<option value="${ts.id}">${ts.name} (${ts.total_cases} å€‹å•é¡Œ)</option>`).join('');
        } else {
            select.innerHTML = '<option value="">å°šç„¡æ¸¬è©¦é›†</option>';
        }
    } catch (error) {
        console.error('Failed to load test sets:', error);
        select.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>';
    }
}

async function loadTestSetPreview() {
    const testsetId = document.getElementById('testsetSelect').value;
    if (!testsetId) {
        document.getElementById('testsetPreview').classList.add('hidden');
        return;
    }

    try {
        const response = await fetch(`/api/rag/evaluation/testsets/${testsetId}`);
        if (!response.ok) throw new Error('Failed to load test set');

        selectedTestSet = await response.json();
        document.getElementById('testsetInfo').innerHTML = `
            <div><strong>åç¨±ï¼š</strong>${selectedTestSet.name}</div>
            <div><strong>æè¿°ï¼š</strong>${selectedTestSet.description || 'ç„¡'}</div>
            <div><strong>å•é¡Œæ•¸ï¼š</strong>${selectedTestSet.total_cases}</div>
            <div><strong>åˆ†é¡ï¼š</strong>${selectedTestSet.category || 'ç„¡'}</div>
        `;
        document.getElementById('testsetPreview').classList.remove('hidden');
    } catch (error) {
        console.error('Failed to load test set preview:', error);
        alert('è¼‰å…¥æ¸¬è©¦é›†å¤±æ•—');
    }
}

// Helper functions for progress indicator
function showProgress(mainText, detailText = '') {
    document.getElementById('evaluationProgress').classList.remove('hidden');
    document.getElementById('progressText').textContent = mainText;
    document.getElementById('progressDetail').textContent = detailText;
    document.getElementById('runEvalBtn').disabled = true;
}

function hideProgress() {
    document.getElementById('evaluationProgress').classList.add('hidden');
    document.getElementById('runEvalBtn').disabled = false;
}

async function runEvaluationWithTestSet() {
    if (!selectedTestSet) {
        alert('è«‹é¸æ“‡æ¸¬è©¦é›†');
        return;
    }

    // Step 1: Create experiment automatically
    const expName = document.getElementById('expName').value.trim() ||
                    `${selectedTestSet.name} - ${new Date().toISOString().split('T')[0]}`;
    const expType = document.getElementById('expType').value;
    const chunkingMethod = document.getElementById('chunkingMethod').value;
    const chunkSize = parseInt(document.getElementById('chunkSize').value);
    const chunkOverlap = parseInt(document.getElementById('chunkOverlap').value);
    const expDescription = document.getElementById('expDescription').value.trim() ||
                           `ä½¿ç”¨æ¸¬è©¦é›†ã€Œ${selectedTestSet.name}ã€é€²è¡Œè©•ä¼°`;

    try {
        // Step 1: Generate answers for test cases if missing
        const needsAnswers = selectedTestSet.test_cases.filter(tc => !tc.answer || tc.answer === '');

        if (needsAnswers.length > 0) {
            showProgress('æ­£åœ¨é€é RAG ç³»çµ±ç”Ÿæˆç­”æ¡ˆ...', `æº–å‚™ç”Ÿæˆ ${needsAnswers.length} å€‹ç­”æ¡ˆ`);
        }

        const testCasesWithAnswers = [];
        let answersGenerated = 0;

        for (const testCase of selectedTestSet.test_cases) {
            if (!testCase.answer || testCase.answer === '') {
                answersGenerated++;
                showProgress(
                    'æ­£åœ¨é€é RAG ç³»çµ±ç”Ÿæˆç­”æ¡ˆ...',
                    `æ­£åœ¨ç”Ÿæˆç­”æ¡ˆ ${answersGenerated}/${needsAnswers.length}: ${testCase.question.substring(0, 40)}...`
                );

                // Generate answer via RAG API (with chunk_strategy if selected)
                const ragPayload = {
                    question: testCase.question,
                    top_k: 3
                };
                if (chunkStrategy) {
                    ragPayload.chunk_strategy = chunkStrategy;
                }

                const ragResponse = await fetch('/api/rag/chat/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(ragPayload)
                });

                if (ragResponse.ok) {
                    const ragResult = await ragResponse.json();
                    testCasesWithAnswers.push({
                        ...testCase,
                        answer: ragResult.answer,
                        contexts: testCase.contexts && testCase.contexts.length > 0
                            ? testCase.contexts
                            : ragResult.citations.map(c => c.text)
                    });
                } else {
                    throw new Error(`ç”Ÿæˆç­”æ¡ˆå¤±æ•—: ${testCase.question}`);
                }
            } else {
                testCasesWithAnswers.push(testCase);
            }
        }

        // Step 2: Create experiment
        showProgress('æ­£åœ¨å»ºç«‹å¯¦é©—...', `å¯¦é©—åç¨±: ${expName}`);

        const chunkStrategy = document.getElementById('chunkStrategy').value || null;

        const createResponse = await fetch('/api/rag/evaluation/experiments', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: expName,
                description: expDescription,
                experiment_type: expType,
                chunk_strategy: chunkStrategy,
                chunking_method: chunkingMethod,
                chunk_size: chunkSize,
                chunk_overlap: chunkOverlap
            })
        });

        if (!createResponse.ok) {
            const error = await createResponse.json();
            hideProgress();
            alert('å»ºç«‹å¯¦é©—å¤±æ•—: ' + (error.detail || 'æœªçŸ¥éŒ¯èª¤'));
            return;
        }

        const experiment = await createResponse.json();
        const experimentId = experiment.id;

        // Step 3: Run evaluation with complete test cases
        showProgress(
            'æ­£åœ¨åŸ·è¡Œ RAGAS è©•ä¼°...',
            `è©•ä¼° ${testCasesWithAnswers.length} å€‹æ¸¬è©¦æ¡ˆä¾‹ï¼Œé€™å¯èƒ½éœ€è¦å¹¾åˆ†é˜...`
        );

        const runResponse = await fetch(`/api/rag/evaluation/experiments/${experimentId}/run`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                test_cases: testCasesWithAnswers,
                include_ground_truth: testCasesWithAnswers.some(tc => tc.ground_truth)
            })
        });

        hideProgress();

        if (runResponse.ok) {
            const result = await runResponse.json();
            alert(`âœ… è©•ä¼°åŸ·è¡ŒæˆåŠŸï¼\n\n` +
                  `- ç¸½æŸ¥è©¢æ•¸: ${result.total_queries}\n` +
                  `- Faithfulness: ${result.avg_faithfulness?.toFixed(3) || 'N/A'}\n` +
                  `- Answer Relevancy: ${result.avg_answer_relevancy?.toFixed(3) || 'N/A'}\n` +
                  `- Context Recall: ${result.avg_context_recall?.toFixed(3) || 'N/A'}\n` +
                  `- Context Precision: ${result.avg_context_precision?.toFixed(3) || 'N/A'}`
            );
            closeRunModal();
            loadExperiments();
        } else {
            const error = await runResponse.json();
            const errorMsg = typeof error.detail === 'string'
                ? error.detail
                : JSON.stringify(error.detail || error);
            alert('åŸ·è¡Œå¤±æ•—: ' + errorMsg);
            console.error('Evaluation error:', error);
        }
    } catch (error) {
        hideProgress();
        alert('åŸ·è¡Œå¤±æ•—: ' + error.message);
        console.error('Evaluation exception:', error);
    }
}

// ========== View Details Modal ==========

async function viewExperimentDetails(experimentId) {
    try {
        // Fetch experiment details
        const expResponse = await fetch(`/api/rag/evaluation/experiments/${experimentId}`);
        if (!expResponse.ok) throw new Error('Failed to load experiment');
        const experiment = await expResponse.json();

        // Fetch results if completed or failed
        let results = [];
        if (experiment.status === 'completed' || experiment.status === 'failed') {
            const resultsResponse = await fetch(`/api/rag/evaluation/experiments/${experimentId}/results`);
            if (resultsResponse.ok) {
                results = await resultsResponse.json();
            }
        }

        // Build content
        let content = `
            <div class="bg-gray-50 rounded-lg p-4 border space-y-3">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <span class="text-sm text-gray-600">å¯¦é©—åç¨±ï¼š</span>
                        <span class="font-medium">${experiment.name}</span>
                    </div>
                    <div>
                        <span class="text-sm text-gray-600">ç‹€æ…‹ï¼š</span>
                        ${getStatusBadge(experiment.status)}
                    </div>
                    <div>
                        <span class="text-sm text-gray-600">é¡å‹ï¼š</span>
                        <span>${experiment.experiment_type}</span>
                    </div>
                    <div>
                        <span class="text-sm text-gray-600">Chunk Strategyï¼š</span>
                        <span class="font-mono text-blue-600">${experiment.chunk_strategy || 'N/A'}</span>
                    </div>
                    <div>
                        <span class="text-sm text-gray-600">Chunkingï¼š</span>
                        <span>${experiment.chunking_method || 'N/A'} (${experiment.chunk_size}/${experiment.chunk_overlap})</span>
                    </div>
                </div>
                ${experiment.description ? `
                    <div>
                        <span class="text-sm text-gray-600">æè¿°ï¼š</span>
                        <span>${experiment.description}</span>
                    </div>
                ` : ''}
                ${experiment.status === 'failed' && experiment.error_message ? `
                    <div class="bg-red-50 border border-red-200 rounded p-3">
                        <div class="text-sm font-medium text-red-900 mb-1">éŒ¯èª¤è¨Šæ¯ï¼š</div>
                        <div class="text-sm text-red-700 font-mono">${experiment.error_message}</div>
                    </div>
                ` : ''}
            </div>
        `;

        if (experiment.status === 'completed') {
            content += `
                <div class="bg-white rounded-lg border p-4">
                    <h4 class="font-medium text-gray-800 mb-3">è©•ä¼°æŒ‡æ¨™</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600">${formatMetric(experiment.avg_faithfulness)}</div>
                            <div class="text-sm text-gray-600">Faithfulness</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">${formatMetric(experiment.avg_answer_relevancy)}</div>
                            <div class="text-sm text-gray-600">Answer Relevancy</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-600">${formatMetric(experiment.avg_context_recall)}</div>
                            <div class="text-sm text-gray-600">Context Recall</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-orange-600">${formatMetric(experiment.avg_context_precision)}</div>
                            <div class="text-sm text-gray-600">Context Precision</div>
                        </div>
                    </div>
                </div>
            `;

            if (results.length > 0) {
                content += `
                    <div class="bg-white rounded-lg border p-4">
                        <h4 class="font-medium text-gray-800 mb-3">è©³ç´°çµæœ (${results.length} å€‹æ¸¬è©¦æ¡ˆä¾‹)</h4>
                        <div class="space-y-3 max-h-96 overflow-y-auto">
                            ${results.map((result, idx) => `
                                <div class="border rounded p-3 bg-gray-50">
                                    <div class="font-medium text-gray-800 mb-2">${idx + 1}. ${result.question}</div>
                                    <div class="grid grid-cols-4 gap-2 text-sm">
                                        <div>
                                            <span class="text-gray-600">Faithfulness:</span>
                                            <span class="font-medium">${formatMetric(result.faithfulness)}</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-600">Relevancy:</span>
                                            <span class="font-medium">${formatMetric(result.answer_relevancy)}</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-600">Recall:</span>
                                            <span class="font-medium">${formatMetric(result.context_recall)}</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-600">Precision:</span>
                                            <span class="font-medium">${formatMetric(result.context_precision)}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        document.getElementById('detailsContent').innerHTML = content;
        document.getElementById('detailsModal').classList.remove('hidden');

    } catch (error) {
        alert('è¼‰å…¥è©³æƒ…å¤±æ•—: ' + error.message);
        console.error('Failed to load details:', error);
    }
}

function closeDetailsModal() {
    document.getElementById('detailsModal').classList.add('hidden');
}

// ========== Smart Features ==========

// Template configurations
const templates = {
    baseline: {
        name: 'åŸºæº–æ¸¬è©¦',
        description: 'ä½¿ç”¨é è¨­åƒæ•¸å»ºç«‹ç³»çµ±æ•ˆèƒ½åŸºæº–ç·š',
        type: 'end_to_end',
        chunking_method: 'fixed',
        chunk_size: 400,
        chunk_overlap: 80
    },
    chunking: {
        name: 'Chunk å¤§å°å„ªåŒ–',
        description: 'æ¯”è¼ƒä¸åŒ chunk size çš„æ•ˆèƒ½',
        experiments: [
            { size: 200, overlap: 40 },
            { size: 400, overlap: 80 },
            { size: 600, overlap: 120 },
            { size: 800, overlap: 160 }
        ],
        type: 'chunking',
        chunking_method: 'fixed'
    },
    advanced: {
        name: 'é€²éšç«¯åˆ°ç«¯è©•ä¼°',
        description: 'å®Œæ•´è©•ä¼° RAG ç³»çµ±æ‰€æœ‰ç’°ç¯€',
        type: 'end_to_end',
        chunking_method: 'semantic',
        chunk_size: 400,
        chunk_overlap: 80
    }
};

function applyTemplate(templateName) {
    const template = templates[templateName];

    if (templateName === 'chunking') {
        // Batch creation
        if (confirm(`å°‡å»ºç«‹ ${template.experiments.length} å€‹å¯¦é©—ï¼Œæ¯”è¼ƒä¸åŒ chunk sizeã€‚ç¢ºå®šè¦ç¹¼çºŒï¼Ÿ`)) {
            createChunkingExperiments(template);
        }
    } else {
        // Single experiment
        document.getElementById('expName').value = template.name + ' - ' + new Date().toISOString().split('T')[0];
        document.getElementById('expType').value = template.type;
        document.getElementById('chunkingMethod').value = template.chunking_method;
        document.getElementById('chunkSize').value = template.chunk_size;
        document.getElementById('chunkOverlap').value = template.chunk_overlap;
        document.getElementById('expDescription').value = template.description;

        closeQuickStart();
        document.getElementById('expName').scrollIntoView({ behavior: 'smooth' });
    }
}

async function createChunkingExperiments(template) {
    try {
        for (const config of template.experiments) {
            const data = {
                name: `Chunk ${config.size} - ${new Date().toISOString().split('T')[0]}`,
                description: `æ¸¬è©¦ chunk size ${config.size} èˆ‡ overlap ${config.overlap} çš„æ•ˆèƒ½`,
                experiment_type: template.type,
                chunking_method: template.chunking_method,
                chunk_size: config.size,
                chunk_overlap: config.overlap
            };

            const response = await fetch('/api/rag/evaluation/experiments', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error(`å»ºç«‹å¯¦é©—å¤±æ•—: Chunk ${config.size}`);
        }

        alert('æˆåŠŸå»ºç«‹ ' + template.experiments.length + ' å€‹å¯¦é©—ï¼');
        closeQuickStart();
        loadExperiments();
    } catch (error) {
        alert('æ‰¹æ¬¡å»ºç«‹å¤±æ•—: ' + error.message);
    }
}

function closeQuickStart() {
    document.getElementById('quickStartGuide').classList.add('hidden');
}

// Smart recommendations based on existing experiments
async function analyzeAndRecommend() {
    try {
        const response = await fetch('/api/rag/evaluation/experiments');
        const experiments = await response.json();

        if (experiments.length === 0) return;

        const completed = experiments.filter(e => e.status === 'completed');
        if (completed.length === 0) return;

        const recommendations = [];

        // Check if baseline exists
        const hasBaseline = completed.some(e => e.name.includes('åŸºæº–') || e.name.includes('Baseline'));
        if (!hasBaseline) {
            recommendations.push({
                icon: 'ğŸ“Š',
                title: 'å»ºç«‹åŸºæº–ç·š',
                description: 'å°šæœªå»ºç«‹æ•ˆèƒ½åŸºæº–ç·šï¼Œå»ºè­°å…ˆåŸ·è¡ŒåŸºæº–æ¸¬è©¦ä½œç‚ºåƒè€ƒ'
            });
        }

        // Check chunk size variety
        const chunkSizes = [...new Set(completed.map(e => e.chunk_size).filter(Boolean))];
        if (chunkSizes.length < 3) {
            recommendations.push({
                icon: 'ğŸ”¬',
                title: 'Chunk å¤§å°å„ªåŒ–',
                description: 'ç›®å‰åªæ¸¬è©¦é ' + chunkSizes.length + ' ç¨® chunk sizeï¼Œå»ºè­°æ¸¬è©¦æ›´å¤šé…ç½®'
            });
        }

        // Check for low performance
        const avgFaithfulness = completed.reduce((sum, e) => sum + (e.avg_faithfulness || 0), 0) / completed.length;
        if (avgFaithfulness < 0.7) {
            recommendations.push({
                icon: 'âš ï¸',
                title: 'æ•ˆèƒ½åä½',
                description: `å¹³å‡ Faithfulness åªæœ‰ ${avgFaithfulness.toFixed(2)}ï¼Œå»ºè­°èª¿æ•´ chunking ç­–ç•¥æˆ–æª¢ç´¢åƒæ•¸`
            });
        }

        // Check for recent failures
        const recentFailed = experiments.filter(e => e.status === 'failed').slice(-3);
        if (recentFailed.length >= 2) {
            recommendations.push({
                icon: 'ğŸ”´',
                title: 'å¤šæ¬¡å¯¦é©—å¤±æ•—',
                description: 'æœ€è¿‘æœ‰å¤šå€‹å¯¦é©—å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¸¬è©¦é›†æ ¼å¼å’Œç³»çµ±é…ç½®'
            });
        }

        // Display recommendations
        if (recommendations.length > 0) {
            const content = recommendations.map(rec => `
                <div class="flex items-start gap-3 mb-3 last:mb-0">
                    <div class="text-xl">${rec.icon}</div>
                    <div>
                        <div class="font-medium text-gray-800">${rec.title}</div>
                        <div class="text-sm text-gray-600">${rec.description}</div>
                    </div>
                </div>
            `).join('');

            document.getElementById('recommendationsContent').innerHTML = content;
            document.getElementById('smartRecommendations').classList.remove('hidden');
        }
    } catch (error) {
        console.error('åˆ†æå¤±æ•—:', error);
    }
}

// Enhanced loadExperiments with smart recommendations
const originalLoadExperiments = loadExperiments;
loadExperiments = async function() {
    await originalLoadExperiments();

    // Always analyze and show recommendations if there are completed experiments
    const response = await fetch('/api/rag/evaluation/experiments');
    const experiments = await response.json();

    if (experiments.length > 0) {
        analyzeAndRecommend();
    }
};

// Helper function to auto-fill chunk size/overlap based on strategy selection
function updateChunkParams() {
    const strategy = document.getElementById('chunkStrategy').value;
    if (!strategy) return;

    const strategyMap = {
        'rec_256_50': { size: 256, overlap: 50 },
        'rec_400_80': { size: 400, overlap: 80 },
        'rec_512_100': { size: 512, overlap: 100 },
        'rec_1024_200': { size: 1024, overlap: 200 },
        'rec_2048_400': { size: 2048, overlap: 400 }
    };

    if (strategyMap[strategy]) {
        document.getElementById('chunkSize').value = strategyMap[strategy].size;
        document.getElementById('chunkOverlap').value = strategyMap[strategy].overlap;
    }
}

// Global variables for batch evaluation
let batchEvalStrategies = [];
let batchEvalTestSets = [];
let batchEvalResolver = null;

// Batch evaluation entry point
async function runBatchEvaluation() {
    batchEvalStrategies = [
        { name: 'rec_256_50', size: 256, overlap: 50, label: 'å¿«é€Ÿæ¨¡å¼ (256å­—)', desc: 'é©åˆå¿«é€Ÿæª¢ç´¢ï¼Œå›ç­”é€Ÿåº¦æœ€å¿«', selected: false },
        { name: 'rec_400_80', size: 400, overlap: 80, label: 'æ¨™æº–æ¨¡å¼ (400å­—)', desc: 'é è¨­æ¨è–¦ï¼Œå¹³è¡¡é€Ÿåº¦èˆ‡å“è³ª', selected: true },
        { name: 'rec_512_100', size: 512, overlap: 100, label: 'å„ªè³ªæ¨¡å¼ (512å­—)', desc: 'è¼ƒé«˜å“è³ªï¼Œé©åˆå¤§éƒ¨åˆ†æƒ…å¢ƒ', selected: true },
        { name: 'rec_1024_200', size: 1024, overlap: 200, label: 'é«˜å“è³ªæ¨¡å¼ (1024å­—)', desc: 'é•·æ–‡æœ¬ï¼Œé«˜å“è³ªå›ç­”', selected: true },
        { name: 'rec_2048_400', size: 2048, overlap: 400, label: 'æ¥µè‡´æ¨¡å¼ (2048å­—)', desc: 'æœ€é•·ä¸Šä¸‹æ–‡ï¼Œæœ€é«˜å“è³ª', selected: false }
    ];

    // Load test sets from API
    try {
        const response = await fetch('/api/rag/evaluation/testsets');
        if (response.ok) {
            batchEvalTestSets = await response.json();
        } else {
            batchEvalTestSets = [];
        }
    } catch (error) {
        console.error('Failed to load test sets:', error);
        batchEvalTestSets = [];
    }

    // Show wizard modal - Step 1
    showWizardStep1();
}

function showWizardStep1() {
    // Populate strategy checkboxes
    const listHTML = batchEvalStrategies.map((strategy, index) => `
        <div class="border ${strategy.selected ? 'border-purple-300 bg-purple-50' : 'border-gray-200 bg-white'} rounded-lg p-4 hover:shadow-md transition">
            <label class="flex items-start gap-3 cursor-pointer">
                <input type="checkbox"
                       id="strategy_${index}"
                       ${strategy.selected ? 'checked' : ''}
                       onchange="toggleStrategy(${index})"
                       class="mt-1 w-5 h-5 text-purple-600 rounded focus:ring-2 focus:ring-purple-500">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="font-semibold text-gray-800">${strategy.label}</span>
                        ${strategy.selected ? '<span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">æ¨è–¦</span>' : ''}
                    </div>
                    <div class="text-sm text-gray-600 mb-2">${strategy.desc}</div>
                    <div class="text-xs text-gray-500">
                        ğŸ“ æ–‡å­—é•·åº¦: ${strategy.size} | é‡ç–Š: ${strategy.overlap}
                    </div>
                </div>
            </label>
        </div>
    `).join('');

    document.getElementById('strategyCheckboxList').innerHTML = listHTML;

    // Show wizard modal at step 1
    document.getElementById('wizardModal').classList.remove('hidden');
}

function goToStep1() {
    document.getElementById('wizardStep1').classList.remove('hidden');
    document.getElementById('wizardStep2').classList.add('hidden');
    document.getElementById('wizardStep3').classList.add('hidden');
    updateStepIndicator(1);
}

function goToStep2() {
    const selectedStrategies = batchEvalStrategies.filter(s => s.selected);
    if (selectedStrategies.length === 0) {
        alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ç­–ç•¥');
        return;
    }

    // Populate test sets
    const testSetCheckboxList = document.getElementById('testSetCheckboxList');
    if (batchEvalTestSets.length === 0) {
        testSetCheckboxList.innerHTML = '<div class="text-gray-500 text-sm p-2">ç›®å‰æ²’æœ‰æ¸¬è©¦é›†ï¼Œè«‹å…ˆå»ºç«‹æ¸¬è©¦é›†</div>';
    } else {
        batchEvalTestSets.forEach(ts => {
            if (ts.selected === undefined) ts.selected = false;
        });

        const testSetHTML = batchEvalTestSets.map((ts, index) => `
            <label class="flex items-center gap-3 p-2 hover:bg-gray-50 rounded cursor-pointer">
                <input type="checkbox"
                       id="testset_${index}"
                       ${ts.selected ? 'checked' : ''}
                       onchange="toggleTestSet(${index})"
                       class="w-4 h-4 text-purple-600 rounded focus:ring-2 focus:ring-purple-500">
                <div class="flex-1">
                    <div class="font-medium text-gray-800">${ts.name}</div>
                    <div class="text-xs text-gray-500">${ts.total_cases} å€‹å•é¡Œ${ts.category ? ' | ' + ts.category : ''}</div>
                </div>
            </label>
        `).join('');
        testSetCheckboxList.innerHTML = testSetHTML;
    }

    document.getElementById('wizardStep1').classList.add('hidden');
    document.getElementById('wizardStep2').classList.remove('hidden');
    document.getElementById('wizardStep3').classList.add('hidden');
    updateStepIndicator(2);
}

function goToStep3() {
    const selectedTestSets = batchEvalTestSets.filter(ts => ts.selected);
    if (selectedTestSets.length === 0) {
        alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ¸¬è©¦é›†');
        return;
    }

    // Update confirmation display
    const selectedStrategies = batchEvalStrategies.filter(s => s.selected);

    document.getElementById('selectedStrategyCount').textContent = selectedStrategies.length;
    document.getElementById('selectedStrategyList').innerHTML = selectedStrategies.map(s =>
        `<div class="mb-1">â€¢ ${s.label}</div>`
    ).join('');

    document.getElementById('selectedTestSetCount').textContent = selectedTestSets.length;
    document.getElementById('selectedTestSetList').innerHTML = selectedTestSets.map(ts =>
        `<div class="mb-1">â€¢ ${ts.name} (${ts.total_cases} å€‹å•é¡Œ)</div>`
    ).join('');

    const totalExperiments = selectedStrategies.length * selectedTestSets.length;
    const estimatedMinutes = Math.ceil(totalExperiments * 0.5);
    document.getElementById('finalExperimentCount').textContent = `${totalExperiments} å€‹`;
    document.getElementById('finalEstimatedTime').textContent = `${estimatedMinutes} åˆ†é˜`;

    document.getElementById('wizardStep1').classList.add('hidden');
    document.getElementById('wizardStep2').classList.add('hidden');
    document.getElementById('wizardStep3').classList.remove('hidden');
    updateStepIndicator(3);
}

function updateStepIndicator(step) {
    const steps = [1, 2, 3];
    steps.forEach(s => {
        const indicator = document.getElementById(`step${s}Indicator`);
        const circle = indicator.querySelector('div');
        const text = indicator.querySelector('span');

        if (s < step) {
            // Completed
            circle.className = 'w-8 h-8 rounded-full bg-green-600 text-white flex items-center justify-center font-bold';
            text.className = 'font-semibold text-green-600';
        } else if (s === step) {
            // Current
            circle.className = 'w-8 h-8 rounded-full bg-purple-600 text-white flex items-center justify-center font-bold';
            text.className = 'font-semibold text-purple-600';
        } else {
            // Not reached
            circle.className = 'w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-bold';
            text.className = 'font-semibold text-gray-400';
        }
    });
}

function cancelWizard() {
    document.getElementById('wizardModal').classList.add('hidden');
}

function toggleTestSet(index) {
    batchEvalTestSets[index].selected = !batchEvalTestSets[index].selected;
}

function toggleStrategy(index) {
    batchEvalStrategies[index].selected = !batchEvalStrategies[index].selected;

    // Update checkbox styling
    const checkbox = document.getElementById(`strategy_${index}`);
    const container = checkbox.closest('.border');
    if (batchEvalStrategies[index].selected) {
        container.classList.remove('border-gray-200', 'bg-white');
        container.classList.add('border-purple-300', 'bg-purple-50');
    } else {
        container.classList.remove('border-purple-300', 'bg-purple-50');
        container.classList.add('border-gray-200', 'bg-white');
    }
}

function updateEstimations() {
    const selectedStrategies = batchEvalStrategies.filter(s => s.selected);
    const selectedTestSets = batchEvalTestSets.filter(ts => ts.selected);

    // Total experiments = strategies Ã— test sets
    const totalExperiments = selectedStrategies.length * selectedTestSets.length;
    document.getElementById('totalExperiments').textContent = `${totalExperiments} å€‹`;

    // Estimate time (assume 30 seconds per experiment)
    const estimatedMinutes = Math.ceil(totalExperiments * 0.5); // 30ç§’ = 0.5åˆ†é˜
    document.getElementById('estimatedTime').textContent = totalExperiments === 0 ? '0 åˆ†é˜' : `ç´„ ${estimatedMinutes} åˆ†é˜`;

    // Update strategy checkbox styling
    batchEvalStrategies.forEach((strategy, index) => {
        const checkbox = document.getElementById(`strategy_${index}`);
        if (checkbox) {
            const container = checkbox.closest('.border');
            if (strategy.selected) {
                container.classList.remove('border-gray-200', 'bg-white');
                container.classList.add('border-purple-300', 'bg-purple-50');
            } else {
                container.classList.remove('border-purple-300', 'bg-purple-50');
                container.classList.add('border-gray-200', 'bg-white');
            }
        }
    });
}

async function startBatchEvaluation() {
    const selectedStrategies = batchEvalStrategies.filter(s => s.selected);
    const selectedTestSets = batchEvalTestSets.filter(ts => ts.selected);

    // Hide wizard modal
    document.getElementById('wizardModal').classList.add('hidden');

    // Execute matrix evaluation (strategies Ã— test sets)
    await executeMatrixEvaluation(selectedStrategies, selectedTestSets);
}

async function executeMatrixEvaluation(selectedStrategies, selectedTestSets) {

    // Show progress modal
    document.getElementById('batchProgressModal').classList.remove('hidden');
    document.getElementById('resultsContainer').innerHTML = '';
    document.getElementById('closeProgressBtn').classList.add('hidden');

    const results = [];
    const totalExperiments = selectedStrategies.length * selectedTestSets.length;
    let completedCount = 0;

    // Matrix loop: strategies Ã— test sets
    for (let si = 0; si < selectedStrategies.length; si++) {
        const strategy = selectedStrategies[si];

        for (let ti = 0; ti < selectedTestSets.length; ti++) {
            const testSet = selectedTestSets[ti];

            try {
                // Update progress
                const progress = (completedCount / totalExperiments) * 100;
                updateProgress(
                    progress,
                    `å¯¦é©— ${completedCount + 1}/${totalExperiments}: ${strategy.label} Ã— ${testSet.name}`,
                    strategy.label,
                    testSet.name
                );

                // Step 1: Initialize
                updateStrategyStatus(`ğŸ”„ åˆå§‹åŒ–å¯¦é©— ${completedCount + 1}/${totalExperiments}...`);
                await new Promise(resolve => setTimeout(resolve, 300));

                // Step 2: Load test set
                updateStrategyStatus(`ğŸ“‹ è¼‰å…¥æ¸¬è©¦é›† "${testSet.name}" (${testSet.total_cases}å€‹å•é¡Œ)...`);
                await new Promise(resolve => setTimeout(resolve, 200));

                // Fetch full test set details (to get test_cases)
                const testSetResponse = await fetch(`/api/rag/evaluation/testsets/${testSet.id}`);
                if (!testSetResponse.ok) {
                    throw new Error(`Failed to load test set: ${testSet.name}`);
                }
                const fullTestSet = await testSetResponse.json();
                const originalTestCases = fullTestSet.test_cases;

                // Step 3: Generate answers using RAG API with current strategy
                updateStrategyStatus(`ğŸ¤– ä½¿ç”¨ ${strategy.label} ç”Ÿæˆç­”æ¡ˆ... (${originalTestCases.length} å€‹å•é¡Œ)`);
                await new Promise(resolve => setTimeout(resolve, 300));

                const testCases = [];
                for (let i = 0; i < originalTestCases.length; i++) {
                    const testCase = originalTestCases[i];
                    updateStrategyStatus(`ğŸ¤– ç”Ÿæˆç­”æ¡ˆ ${i + 1}/${originalTestCases.length}: ${testCase.question.substring(0, 30)}...`);

                    // Use RAG API to generate answer with current strategy
                    const ragResponse = await fetch('/api/rag/chat/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            question: testCase.question,
                            top_k: 3,
                            chunk_strategy: strategy.name  // Use current strategy!
                        })
                    });

                    if (!ragResponse.ok) {
                        throw new Error(`Failed to generate answer for question: ${testCase.question}`);
                    }

                    const ragResult = await ragResponse.json();

                    // Build test case with generated answer and contexts
                    testCases.push({
                        question: testCase.question,
                        answer: ragResult.answer,
                        contexts: ragResult.citations ? ragResult.citations.map(c => c.text) : [],
                        ground_truth: testCase.ground_truth || null
                    });
                }

            // Step 4: Create experiment
            updateStrategyStatus('ğŸ”¬ å»ºç«‹è©•ä¼°å¯¦é©— (MLflow tracking)...');
            await new Promise(resolve => setTimeout(resolve, 300));

                const expResponse = await fetch('/api/rag/evaluation/experiments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: `çŸ©é™£è©•ä¼° - ${strategy.label} Ã— ${testSet.name}`,
                        description: `ç­–ç•¥: ${strategy.label} (${strategy.desc}) | æ¸¬è©¦é›†: ${testSet.name}`,
                        experiment_type: 'end_to_end',
                        chunking_method: 'recursive',
                        chunk_size: strategy.size,
                        chunk_overlap: strategy.overlap,
                        chunk_strategy: strategy.name
                    })
                });

                if (!expResponse.ok) {
                    throw new Error(`Failed to create experiment`);
                }

                const experiment = await expResponse.json();

                // Step 5: Run evaluation
                updateStrategyStatus('âš¡ åŸ·è¡Œ RAGAS å“è³ªè©•ä¼°...');
                await new Promise(resolve => setTimeout(resolve, 200));

                updateStrategyStatus('ğŸ“Š è¨ˆç®— Faithfulness (å¿ å¯¦åº¦) æŒ‡æ¨™...');
                await new Promise(resolve => setTimeout(resolve, 150));

                const evalResponse = await fetch(`/api/rag/evaluation/experiments/${experiment.id}/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        test_cases: testCases,
                        include_ground_truth: false
                    })
                });

                if (!evalResponse.ok) {
                    throw new Error(`Evaluation failed`);
                }

                updateStrategyStatus('ğŸ“ˆ è¨ˆç®— Answer Relevancy (ç›¸é—œæ€§) æŒ‡æ¨™...');
                await new Promise(resolve => setTimeout(resolve, 150));

                const evalResult = await evalResponse.json();

                // Step 6: Save results
                updateStrategyStatus('ğŸ’¾ å„²å­˜è©•ä¼°çµæœ...');
                await new Promise(resolve => setTimeout(resolve, 150));

                const result = {
                    strategy: strategy.name,
                    strategyLabel: strategy.label,
                    testSet: testSet.name,
                    testSetId: testSet.id,
                    faithfulness: evalResult.avg_faithfulness,
                    answer_relevancy: evalResult.avg_answer_relevancy,
                    experiment_id: experiment.id,
                    size: strategy.size,
                    overlap: strategy.overlap
                };

                results.push(result);
                completedCount++;

                // Add result to UI
                updateStrategyStatus(`âœ… å®Œæˆï¼`);
                addMatrixResultToUI(result, 'success');

                await new Promise(resolve => setTimeout(resolve, 300));

            } catch (error) {
                const result = {
                    strategy: strategy.name,
                    strategyLabel: strategy.label,
                    testSet: testSet.name,
                    error: error.message
                };
                results.push(result);
                addMatrixResultToUI(result, 'error');
                completedCount++;
            }

            // Brief pause between experiments
            await new Promise(resolve => setTimeout(resolve, 500));
        }
    }

    // Complete
    updateProgress(100, 'âœ… æ¸¬è©¦å®Œæˆï¼', 'æ‰€æœ‰è¨­å®šæ¸¬è©¦å®Œæˆ', 'æ­£åœ¨åˆ†æçµæœ...');
    document.getElementById('closeProgressBtn').classList.remove('hidden');

    // Generate and show matrix report
    setTimeout(() => {
        showMatrixReport(results, selectedStrategies, selectedTestSets);
    }, 1000);

    loadExperiments(); // Refresh experiment list
}

function updateProgress(percent, text, strategyName, testSetName) {
    document.getElementById('progressBar').style.width = `${percent}%`;
    document.getElementById('progressPercent').textContent = `${Math.round(percent)}%`;
    document.getElementById('progressText').textContent = text;

    const infoDiv = document.getElementById('currentStrategyInfo');
    if (strategyName) {
        infoDiv.classList.remove('hidden');
        document.getElementById('currentStrategyName').textContent = strategyName;
        document.getElementById('currentStrategyDesc').textContent = testSetName || '';
    }
}

function updateStrategyStatus(status) {
    document.getElementById('currentStrategyDesc').textContent = status;
}

function addMatrixResultToUI(result, type) {
    const container = document.getElementById('resultsContainer');
    const div = document.createElement('div');

    if (type === 'success') {
        div.className = 'bg-green-50 border border-green-200 rounded-lg p-3';
        div.innerHTML = `
            <div class="flex items-center gap-2 mb-1">
                <span class="text-lg">âœ…</span>
                <div class="font-semibold text-gray-800">${result.strategyLabel} Ã— ${result.testSet}</div>
            </div>
            <div class="text-sm text-gray-600 ml-7">
                æº–ç¢ºåº¦: ${(result.faithfulness * 100).toFixed(1)}% | ç›¸é—œæ€§: ${(result.answer_relevancy * 100).toFixed(1)}%
            </div>
        `;
    } else {
        div.className = 'bg-red-50 border border-red-200 rounded-lg p-3';
        div.innerHTML = `
            <div class="flex items-center gap-2">
                <span class="text-lg">âŒ</span>
                <div>
                    <div class="font-semibold text-gray-800">${result.strategyLabel} Ã— ${result.testSet}</div>
                    <div class="text-sm text-red-600">${result.error}</div>
                </div>
            </div>
        `;
    }

    container.appendChild(div);
}

function addResultToUI(result, type) {
    const container = document.getElementById('resultsContainer');
    const div = document.createElement('div');

    if (type === 'success') {
        div.className = 'bg-green-50 border border-green-200 rounded-lg p-3 flex items-center justify-between';
        div.innerHTML = `
            <div class="flex items-center gap-2">
                <span class="text-lg">âœ…</span>
                <div>
                    <div class="font-semibold text-gray-800">${result.label}</div>
                    <div class="text-sm text-gray-600">å›ç­”æº–ç¢ºåº¦: ${(result.faithfulness * 100).toFixed(1)}% | ç›¸é—œæ€§: ${(result.answer_relevancy * 100).toFixed(1)}%</div>
                </div>
            </div>
        `;
    } else {
        div.className = 'bg-red-50 border border-red-200 rounded-lg p-3 flex items-center gap-2';
        div.innerHTML = `
            <span class="text-lg">âŒ</span>
            <div>
                <div class="font-semibold text-gray-800">${result.label}</div>
                <div class="text-sm text-red-600">${result.error}</div>
            </div>
        `;
    }

    container.appendChild(div);
}

function closeBatchProgress() {
    document.getElementById('batchProgressModal').classList.add('hidden');
    document.getElementById('batchReportModal').classList.remove('hidden');
}

function closeBatchReport() {
    document.getElementById('batchReportModal').classList.add('hidden');
}

function showMatrixReport(results, strategies, testSets) {
    const successful = results.filter(r => !r.error);

    if (successful.length === 0) {
        showToast('âŒ æ‰€æœ‰è©•ä¼°éƒ½å¤±æ•—äº†ï¼Œè«‹æª¢æŸ¥è¨­å®š', 'error');
        return;
    }

    // Find best combination (highest composite score)
    const best = successful.reduce((best, r) => {
        const score = (r.faithfulness * 0.6 + r.answer_relevancy * 0.4);
        const bestScore = (best.faithfulness * 0.6 + best.answer_relevancy * 0.4);
        return score > bestScore ? r : best;
    });

    // Group results by strategy and by test set
    const byStrategy = {};
    const byTestSet = {};

    successful.forEach(r => {
        if (!byStrategy[r.strategy]) byStrategy[r.strategy] = [];
        byStrategy[r.strategy].push(r);

        if (!byTestSet[r.testSet]) byTestSet[r.testSet] = [];
        byTestSet[r.testSet].push(r);
    });

    const message = `
        <div class="space-y-4">
            <div class="border-b pb-3">
                <h3 class="text-xl font-bold text-gray-800 mb-2">ğŸ¯ çŸ©é™£è©•ä¼°ç¸½çµå ±å‘Š</h3>
                <div class="text-sm text-gray-600">
                    å®Œæˆ ${successful.length}/${results.length} å€‹å¯¦é©— (${strategies.length} å€‹ç­–ç•¥ Ã— ${testSets.length} å€‹æ¸¬è©¦é›†)
                </div>
            </div>

            <div class="bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-lg p-4">
                <div class="font-semibold text-purple-900 mb-2">ğŸ† æœ€ä½³çµ„åˆ</div>
                <div class="text-gray-800">
                    <div class="font-bold text-lg">${best.strategyLabel} Ã— ${best.testSet}</div>
                    <div class="text-sm text-gray-600 mt-1">
                        æº–ç¢ºåº¦: ${(best.faithfulness * 100).toFixed(1)}% |
                        ç›¸é—œæ€§: ${(best.answer_relevancy * 100).toFixed(1)}% |
                        ç¶œåˆåˆ†æ•¸: ${((best.faithfulness * 0.6 + best.answer_relevancy * 0.4) * 100).toFixed(1)}åˆ†
                    </div>
                </div>
            </div>

            <div>
                <div class="font-semibold text-gray-800 mb-2">ğŸ“Š å„ç­–ç•¥è¡¨ç¾</div>
                <div class="space-y-2">
                    ${Object.entries(byStrategy).map(([strategy, results]) => {
                        const avgF = results.reduce((sum, r) => sum + r.faithfulness, 0) / results.length;
                        const avgA = results.reduce((sum, r) => sum + r.answer_relevancy, 0) / results.length;
                        return `
                            <div class="bg-gray-50 border border-gray-200 rounded p-2 text-sm">
                                <div class="font-medium">${results[0].strategyLabel}</div>
                                <div class="text-gray-600">
                                    å¹³å‡æº–ç¢ºåº¦: ${(avgF * 100).toFixed(1)}% |
                                    å¹³å‡ç›¸é—œæ€§: ${(avgA * 100).toFixed(1)}% |
                                    æ¸¬è©¦é›†æ•¸: ${results.length}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>

            <div>
                <div class="font-semibold text-gray-800 mb-2">ğŸ“‹ å„æ¸¬è©¦é›†è¡¨ç¾</div>
                <div class="space-y-2">
                    ${Object.entries(byTestSet).map(([testSet, results]) => {
                        const avgF = results.reduce((sum, r) => sum + r.faithfulness, 0) / results.length;
                        const avgA = results.reduce((sum, r) => sum + r.answer_relevancy, 0) / results.length;
                        return `
                            <div class="bg-gray-50 border border-gray-200 rounded p-2 text-sm">
                                <div class="font-medium">${testSet}</div>
                                <div class="text-gray-600">
                                    å¹³å‡æº–ç¢ºåº¦: ${(avgF * 100).toFixed(1)}% |
                                    å¹³å‡ç›¸é—œæ€§: ${(avgA * 100).toFixed(1)}% |
                                    ç­–ç•¥æ•¸: ${results.length}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        </div>
    `;

    showToast(message, 'success', 30000);
}

function showDetailedBatchReport(results) {
    const successful = results.filter(r => !r.error);

    if (successful.length === 0) {
        document.getElementById('batchReportContent').innerHTML = `
            <div class="text-center py-12">
                <div class="text-6xl mb-4">ğŸ˜</div>
                <div class="text-xl font-semibold text-gray-800 mb-2">è©•ä¼°æœªèƒ½å®Œæˆ</div>
                <div class="text-gray-600">æ‰€æœ‰è¨­å®šæ¸¬è©¦éƒ½å¤±æ•—äº†ï¼Œè«‹æª¢æŸ¥ç³»çµ±è¨­å®š</div>
            </div>
        `;
        return;
    }

    // Calculate composite scores
    successful.forEach(r => {
        r.compositeScore = (r.faithfulness || 0) * 0.6 + (r.answer_relevancy || 0) * 0.4;
    });

    // Sort by composite score
    successful.sort((a, b) => b.compositeScore - a.compositeScore);
    const best = successful[0];

    let html = `
        <!-- Winner Card -->
        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-400 rounded-lg p-6 mb-6">
            <div class="flex items-center gap-4 mb-4">
                <span class="text-5xl">ğŸ†</span>
                <div>
                    <div class="text-2xl font-bold text-gray-800">${best.label}</div>
                    <div class="text-gray-600">${best.desc}</div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white rounded-lg p-4">
                    <div class="text-sm text-gray-600 mb-1">å›ç­”æº–ç¢ºåº¦ (Faithfulness)</div>
                    <div class="text-3xl font-bold text-green-600">${(best.faithfulness * 100).toFixed(1)}%</div>
                </div>
                <div class="bg-white rounded-lg p-4">
                    <div class="text-sm text-gray-600 mb-1">å›ç­”ç›¸é—œæ€§ (Relevancy)</div>
                    <div class="text-3xl font-bold text-blue-600">${(best.answer_relevancy * 100).toFixed(1)}%</div>
                </div>
            </div>
            <div class="mt-4 p-4 bg-white rounded-lg">
                <div class="text-sm text-gray-600 mb-1">ç¶œåˆè©•åˆ†</div>
                <div class="flex items-center gap-3">
                    <div class="flex-1 bg-gray-200 rounded-full h-3 overflow-hidden">
                        <div class="bg-gradient-to-r from-green-500 to-blue-500 h-3 rounded-full" style="width: ${best.compositeScore * 100}%"></div>
                    </div>
                    <div class="text-2xl font-bold text-gray-800">${(best.compositeScore * 100).toFixed(1)}</div>
                </div>
                <div class="text-xs text-gray-500 mt-2">* ç¶œåˆè©•åˆ† = æº–ç¢ºåº¦ 60% + ç›¸é—œæ€§ 40%</div>
            </div>
        </div>

        <!-- Detailed Comparison -->
        <div class="mb-6">
            <h4 class="text-lg font-semibold text-gray-800 mb-4">ğŸ“Š è©³ç´°æ¯”è¼ƒ</h4>
            <div class="space-y-3">
    `;

    successful.forEach((r, index) => {
        const rank = index + 1;
        const rankEmoji = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : `#${rank}`;
        const borderColor = rank === 1 ? 'border-yellow-300' : rank === 2 ? 'border-gray-300' : rank === 3 ? 'border-orange-300' : 'border-gray-200';

        html += `
            <div class="border ${borderColor} rounded-lg p-4 bg-white hover:shadow-md transition">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">${rankEmoji}</span>
                        <div>
                            <div class="font-semibold text-gray-800">${r.label}</div>
                            <div class="text-sm text-gray-500">${r.desc}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold text-gray-800">${(r.compositeScore * 100).toFixed(1)}</div>
                        <div class="text-xs text-gray-500">ç¶œåˆåˆ†æ•¸</div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3 mt-3">
                    <div class="bg-green-50 rounded p-2">
                        <div class="text-xs text-gray-600">æº–ç¢ºåº¦</div>
                        <div class="text-lg font-semibold text-green-700">${(r.faithfulness * 100).toFixed(1)}%</div>
                    </div>
                    <div class="bg-blue-50 rounded p-2">
                        <div class="text-xs text-gray-600">ç›¸é—œæ€§</div>
                        <div class="text-lg font-semibold text-blue-700">${(r.answer_relevancy * 100).toFixed(1)}%</div>
                    </div>
                </div>
            </div>
        `;
    });

    html += `
            </div>
        </div>

        <!-- Recommendation -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
            <div class="flex items-start gap-3">
                <span class="text-3xl">ğŸ’¡</span>
                <div>
                    <div class="font-semibold text-gray-800 mb-2">ä½¿ç”¨å»ºè­°</div>
                    <div class="text-gray-700 space-y-2">
                        <p>âœ… <strong>æ¨è–¦ä½¿ç”¨ã€Œ${best.label}ã€</strong>ï¼Œç¶œåˆè©•åˆ†æœ€é«˜ (${(best.compositeScore * 100).toFixed(1)}åˆ†)</p>
                        <p>ğŸ“ˆ æ­¤è¨­å®šåœ¨å›ç­”æº–ç¢ºåº¦å’Œç›¸é—œæ€§æ–¹é¢è¡¨ç¾æœ€ä½³</p>
                        <p>âš™ï¸ æ‚¨å¯ä»¥åœ¨å»ºç«‹å¯¦é©—æ™‚ï¼Œé¸æ“‡ Chunk Strategy ç‚ºã€Œ${best.strategy}ã€</p>
                    </div>
                </div>
            </div>
        </div>
    `;

    const failures = results.filter(r => r.error);
    if (failures.length > 0) {
        html += `
            <div class="mt-6 bg-red-50 border border-red-200 rounded-lg p-4">
                <div class="font-semibold text-red-800 mb-2">âŒ å¤±æ•—çš„è¨­å®š (${failures.length})</div>
                <div class="text-sm text-red-600 space-y-1">
        `;
        failures.forEach(r => {
            html += `<div>â€¢ ${r.label}: ${r.error}</div>`;
        });
        html += `
                </div>
            </div>
        `;
    }

    document.getElementById('batchReportContent').innerHTML = html;
}

function showBatchEvaluationReport(results) {
    // Legacy function for compatibility
    showDetailedBatchReport(results);
}

// Batch Matrix Run Functions
function updateBatchCount() {
    const v20Checked = document.getElementById('promptV20').checked;
    const v21Checked = document.getElementById('promptV21').checked;
    const promptCount = (v20Checked ? 1 : 0) + (v21Checked ? 1 : 0);

    document.getElementById('batchPromptCount').textContent = `â€¢ ${promptCount} å€‹ Prompt ç‰ˆæœ¬`;
    document.getElementById('batchTotalCount').textContent = `ç¸½è¨ˆï¼šæœ€å¤š ${5 * 4 * promptCount} å€‹å¯¦é©—`;
}

async function startBatchRun() {
    const v20Checked = document.getElementById('promptV20').checked;
    const v21Checked = document.getElementById('promptV21').checked;

    if (!v20Checked && !v21Checked) {
        alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ Prompt ç‰ˆæœ¬');
        return;
    }

    const promptVersions = [];
    if (v20Checked) promptVersions.push('2.0');
    if (v21Checked) promptVersions.push('2.1');

    const totalPossible = 5 * 4 * promptVersions.length;

    if (!confirm(`ç¢ºå®šè¦åŸ·è¡Œæ‰¹é‡å¯¦é©—å—ï¼Ÿ\n\nå°‡åŸ·è¡Œï¼š\nâ€¢ 5 å€‹ Chunk ç­–ç•¥\nâ€¢ 4 å€‹æ¸¬è©¦é›†\nâ€¢ ${promptVersions.length} å€‹ Prompt ç‰ˆæœ¬\nâ€¢ ç¸½è¨ˆæœ€å¤šï¼š${totalPossible} å€‹å¯¦é©—\n\nç³»çµ±æœƒè‡ªå‹•è·³éå·²æœ‰å®Œæ•´ 4 å€‹ RAGAS æŒ‡æ¨™çš„å¯¦é©—`)) {
        return;
    }

    const btn = document.getElementById('batchRunBtn');
    const progress = document.getElementById('batchProgress');
    const progressText = document.getElementById('batchProgressText');

    btn.disabled = true;
    progress.classList.remove('hidden');

    const STRATEGIES = [
        {name: "rec_256_50", method: "recursive", size: 256, overlap: 50, display: "å¿«é€Ÿæ¨¡å¼ (256å­—)"},
        {name: "rec_400_80", method: "recursive", size: 400, overlap: 80, display: "æ¨™æº–æ¨¡å¼ (400å­—)"},
        {name: "rec_512_100", method: "recursive", size: 512, overlap: 100, display: "å„ªè³ªæ¨¡å¼ (512å­—)"},
        {name: "rec_1024_200", method: "recursive", size: 1024, overlap: 200, display: "æ·±åº¦æ¨¡å¼ (1024å­—)"},
        {name: "rec_2048_400", method: "recursive", size: 2048, overlap: 400, display: "è¶…æ·±åº¦æ¨¡å¼ (2048å­—)"}
    ];

    const TEST_SETS = [
        "å„ªå‹¢è·èƒ½è©•ä¼°",
        "æ±‚è·å±¥æ­·èˆ‡é¢è©¦æŠ€å·§",
        "ç”Ÿæ¶¯åƒ¹å€¼è§€æ¾„æ¸…",
        "è·æ¶¯èˆˆè¶£èˆ‡ç†±æƒ…æ¢ç´¢"
    ];

    try {
        // Step 1: Get all existing experiments
        progressText.textContent = 'æª¢æŸ¥ç¾æœ‰å¯¦é©—...';
        const expResponse = await fetch('/api/rag/evaluation/experiments?limit=1000');
        const existingExps = await expResponse.json();

        // Build a set of completed experiment keys (strategy_testset_promptversion)
        const completedKeys = new Set();
        existingExps.forEach(exp => {
            // Check if all 4 metrics are present
            if (exp.avg_faithfulness !== null &&
                exp.avg_answer_relevancy !== null &&
                exp.avg_context_recall !== null &&
                exp.avg_context_precision !== null &&
                exp.chunk_strategy &&
                exp.instruction_version) {

                // Extract test set name from experiment name
                for (const testSet of TEST_SETS) {
                    if (exp.name.includes(testSet)) {
                        const key = `${exp.chunk_strategy}_${testSet}_${exp.instruction_version}`;
                        completedKeys.add(key);
                        break;
                    }
                }
            }
        });

        // Step 2: Build list of experiments to run
        const experimentsToRun = [];
        for (const strategy of STRATEGIES) {
            for (const testSet of TEST_SETS) {
                for (const promptVersion of promptVersions) {
                    const key = `${strategy.name}_${testSet}_${promptVersion}`;
                    if (!completedKeys.has(key)) {
                        experimentsToRun.push({strategy, testSet, promptVersion});
                    }
                }
            }
        }

        const skippedCount = totalPossible - experimentsToRun.length;

        if (experimentsToRun.length === 0) {
            alert('æ‰€æœ‰å¯¦é©—éƒ½å·²å®Œæˆï¼Œç„¡éœ€åŸ·è¡Œ');
            btn.disabled = false;
            progress.classList.add('hidden');
            return;
        }

        progressText.textContent = `æ‰¾åˆ° ${experimentsToRun.length} å€‹å¾…åŸ·è¡Œå¯¦é©— (è·³é ${skippedCount} å€‹å·²å®Œæˆ)`;
        await new Promise(resolve => setTimeout(resolve, 1000));

        // Step 3: Get test data for each test set
        progressText.textContent = 'è¼‰å…¥æ¸¬è©¦è³‡æ–™...';
        const testData = {};

        for (const testSet of TEST_SETS) {
            // Find any existing experiment for this test set
            const exp = existingExps.find(e => e.name.includes(testSet) && e.status === 'completed');
            if (exp) {
                const resultsResponse = await fetch(`/api/rag/evaluation/experiments/${exp.id}/results`);
                if (resultsResponse.ok) {
                    const results = await resultsResponse.json();
                    testData[testSet] = results.map(r => ({
                        question: r.question,
                        answer: r.answer,
                        contexts: r.contexts,
                        ground_truth: r.ground_truth
                    }));
                }
            }
        }

        // Step 4: Run experiments
        let successCount = 0;
        let failCount = 0;

        for (let i = 0; i < experimentsToRun.length; i++) {
            const {strategy, testSet, promptVersion} = experimentsToRun[i];
            const current = i + 1;

            progressText.textContent = `[${current}/${experimentsToRun.length}] åŸ·è¡Œ: ${strategy.display} Ã— ${testSet} (v${promptVersion})`;

            if (!testData[testSet]) {
                console.warn(`No test data for ${testSet}, skipping`);
                failCount++;
                continue;
            }

            try {
                // Create experiment
                const createResponse = await fetch('/api/rag/evaluation/experiments', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: `[v${promptVersion}] çŸ©é™£è©•ä¼° - ${strategy.display} Ã— ${testSet}`,
                        description: `æ‰¹é‡åŸ·è¡Œè©•ä¼°ï¼ŒåŒ…å«æ‰€æœ‰ 4 å€‹ RAGAS æŒ‡æ¨™ (Prompt v${promptVersion})`,
                        experiment_type: "end_to_end",
                        chunking_method: strategy.method,
                        chunk_size: strategy.size,
                        chunk_overlap: strategy.overlap,
                        chunk_strategy: strategy.name,
                        instruction_version: promptVersion
                    })
                });

                if (!createResponse.ok) {
                    throw new Error('Failed to create experiment');
                }

                const newExp = await createResponse.json();

                // Run evaluation
                const evalResponse = await fetch(`/api/rag/evaluation/experiments/${newExp.id}/run`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        test_cases: testData[testSet],
                        include_ground_truth: true
                    })
                });

                if (evalResponse.ok) {
                    successCount++;
                } else {
                    failCount++;
                    console.error(`Evaluation failed for ${testSet}`);
                }

                // Small delay to avoid overwhelming the API
                if (current < experimentsToRun.length) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }

            } catch (error) {
                console.error(`Error running experiment:`, error);
                failCount++;
            }
        }

        // Show completion
        alert(`æ‰¹é‡åŸ·è¡Œå®Œæˆï¼\n\nâœ… æˆåŠŸï¼š${successCount} å€‹\nâŒ å¤±æ•—ï¼š${failCount} å€‹\nâ­ï¸ è·³éï¼š${skippedCount} å€‹\n\né é¢å°‡é‡æ–°è¼‰å…¥ä»¥é¡¯ç¤ºæœ€æ–°çµæœ`);

        // Reload page
        window.location.reload();

    } catch (error) {
        console.error('Batch run error:', error);
        alert(`æ‰¹é‡åŸ·è¡Œå¤±æ•—ï¼š${error.message}`);
        btn.disabled = false;
        progress.classList.add('hidden');
    }
}

// Add event listeners for prompt version checkboxes
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('promptV20').addEventListener('change', updateBatchCount);
    document.getElementById('promptV21').addEventListener('change', updateBatchCount);
});

// Load on page load
loadExperiments();
</script>
{% endblock %}
