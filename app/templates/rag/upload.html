{% extends "base.html" %}

{% block title %}Upload - RAG Ops Console{% endblock %}

{% block nav_title %}RAG Ops Console{% endblock %}

{% block nav_items %}
<a href="/rag/agents" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
    Agents
</a>
<a href="/rag/documents" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
    Documents
</a>
<a href="/rag/upload" class="border-indigo-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
    Upload
</a>
<a href="/rag/test" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
    Test Bench
</a>
{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <h2 class="text-2xl font-bold text-gray-900 mb-6">上傳文件</h2>

    <div class="bg-white shadow sm:rounded-lg p-6">
        <form id="uploadForm" enctype="multipart/form-data">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    選擇 PDF 文件（可多選）
                </label>
                <input type="file" id="fileInput" name="files" multiple accept=".pdf"
                    class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
            </div>

            <button type="submit" id="uploadBtn"
                class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                上傳
            </button>
        </form>

        <!-- Pipeline Progress -->
        <div id="pipelineProgress" class="mt-6 hidden">
            <h3 class="text-lg font-medium text-gray-900 mb-4">處理進度</h3>
            <div id="pipelineSteps" class="space-y-3"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.getElementById('uploadForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const fileInput = document.getElementById('fileInput');
    const files = fileInput.files;

    if (files.length === 0) {
        alert('請選擇文件');
        return;
    }

    document.getElementById('pipelineProgress').classList.remove('hidden');
    document.getElementById('pipelineSteps').innerHTML = '<p class="text-gray-600">上傳中...</p>';

    // Upload files one by one (API accepts single file)
    let successCount = 0;
    let errorMessages = [];

    for (let file of files) {
        try {
            const formData = new FormData();
            formData.append('file', file);  // Changed from 'files' to 'file'

            const response = await fetch('/api/rag/ingest/files', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (response.ok) {
                successCount++;
                document.getElementById('pipelineSteps').innerHTML += `
                    <div class="bg-green-50 border border-green-200 rounded p-4 mb-2">
                        <p class="text-green-800">✓ ${file.name} 上傳成功！</p>
                        <p class="text-sm text-green-600">Document ID: ${result.document_id}, Chunks: ${result.chunks_created}</p>
                    </div>
                `;
            } else {
                // Handle error response
                const errorMsg = typeof result.detail === 'string'
                    ? result.detail
                    : JSON.stringify(result.detail);
                errorMessages.push(`${file.name}: ${errorMsg}`);
                document.getElementById('pipelineSteps').innerHTML += `
                    <div class="bg-red-50 border border-red-200 rounded p-4 mb-2">
                        <p class="text-red-800">✗ ${file.name} 上傳失敗</p>
                        <p class="text-sm text-red-600">${errorMsg}</p>
                    </div>
                `;
            }
        } catch (error) {
            errorMessages.push(`${file.name}: ${error.message}`);
            document.getElementById('pipelineSteps').innerHTML += `
                <div class="bg-red-50 border border-red-200 rounded p-4 mb-2">
                    <p class="text-red-800">✗ ${file.name} 發生錯誤</p>
                    <p class="text-sm text-red-600">${error.message}</p>
                </div>
            `;
        }
    }

    // Summary
    if (successCount === files.length) {
        document.getElementById('pipelineSteps').innerHTML += `
            <div class="bg-blue-50 border border-blue-200 rounded p-4 mt-4">
                <p class="text-blue-800">✓ 全部完成！成功上傳 ${successCount} 個文件</p>
            </div>
        `;
        fileInput.value = '';
    } else if (successCount > 0) {
        document.getElementById('pipelineSteps').innerHTML += `
            <div class="bg-yellow-50 border border-yellow-200 rounded p-4 mt-4">
                <p class="text-yellow-800">⚠ 部分完成：成功 ${successCount}/${files.length} 個文件</p>
            </div>
        `;
        fileInput.value = '';
    } else {
        document.getElementById('pipelineSteps').innerHTML += `
            <div class="bg-red-50 border border-red-200 rounded p-4 mt-4">
                <p class="text-red-800">✗ 全部失敗！請檢查錯誤訊息</p>
            </div>
        `;
    }
});
</script>
{% endblock %}
