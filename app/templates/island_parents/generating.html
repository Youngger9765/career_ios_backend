{% extends "island_parents/base.html" %}

{% block title %}報告生成中 - 浮島親子{% endblock %}

{% block extra_styles %}
/* Loading dots animation */
@keyframes dotPulse {
    0%, 100% { background: #1f2937; }
    50% { background: #d1d5db; }
}

.loading-dot {
    width: 0.75rem;
    height: 0.75rem;
    border-radius: 50%;
    animation: dotPulse 1.5s ease-in-out infinite;
}

.loading-dot:nth-child(1) { animation-delay: 0s; }
.loading-dot:nth-child(2) { animation-delay: 0.2s; }
.loading-dot:nth-child(3) { animation-delay: 0.4s; }
.loading-dot:nth-child(4) { animation-delay: 0.6s; }
{% endblock %}

{% block content %}
<div class="page-container safe-area-top safe-area-bottom" style="background: #f5f5f5;">
    <div class="flex-1 flex flex-col max-w-md mx-auto w-full items-center justify-center">
        <!-- Mountain Logo -->
        <div class="mb-6">
            <svg class="w-24 h-16" viewBox="0 0 80 50" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 40 L25 20 L35 30 L50 10 L65 25 L70 40" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M5 40 L75 40" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
        </div>

        <!-- Tagline -->
        <p class="text-gray-700 text-lg mb-12">陪你把話好好說完</p>

        <!-- Loading Status -->
        <h1 class="text-xl font-bold text-gray-900 mb-4">報告生成中，請稍等</h1>

        <!-- Loading Dots -->
        <div class="flex gap-2 mb-12">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
        </div>

        <!-- Scenario Hint -->
        <p id="generating-scenario-hint" class="text-gray-500 text-sm">適合用在：升學規劃、成績、學涯…</p>
    </div>

    <!-- Bottom Navigation Placeholder -->
    {% include 'island_parents/_components/bottom_nav.html' %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // Generate report via API
    async function generateReport() {
        const currentSession = JSON.parse(localStorage.getItem('island_parents_current_session') || 'null');

        if (!currentSession || !currentSession.id) {
            showMessageModal('找不到會談資料', 'error');
            window.location.href = '/island-parents/clients';
            return;
        }

        try {
            // POST /api/v1/sessions/{id}/report - Generate report
            const response = await fetch(`${API_BASE}/api/v1/sessions/${currentSession.id}/report`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${state.token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || '報告生成失敗');
            }

            const report = await response.json();
            localStorage.setItem('island_parents_current_report', JSON.stringify(report));

            // Navigate to complete page
            window.location.href = '/island-parents/complete';

        } catch (error) {
            console.error('Report generation error:', error);
            showMessageModal(error.message || '報告生成失敗', 'error');
            // Still navigate to complete, showing error there
            window.location.href = '/island-parents/complete';
        }
    }

    // Update scenario hint
    function updateScenarioHint() {
        const scenarioTitle = localStorage.getItem('island_parents_scenario_title');
        if (scenarioTitle) {
            document.getElementById('generating-scenario-hint').textContent = `情境：${scenarioTitle}`;
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
        if (!await checkAuth()) return;

        updateScenarioHint();
        generateReport();
    });
</script>
{% endblock %}
