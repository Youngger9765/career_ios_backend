{% extends "island_parents/base.html" %}

{% block title %}選擇模式 - 浮島親子{% endblock %}

{% block content %}
<div class="page-container safe-area-top safe-area-bottom">
    <div class="flex-1 flex flex-col max-w-md mx-auto w-full">
        <!-- Back Button -->
        <div class="flex items-center mb-4">
            <button onclick="window.location.href='/island-parents/clients'" class="p-2 -ml-2 text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </button>
        </div>

        <!-- Logo -->
        <div class="flex justify-center mb-6">
            <svg class="w-20 h-16" viewBox="0 0 80 50" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 40 L25 20 L35 30 L50 10 L65 25 L70 40" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M5 40 L75 40" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
        </div>

        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-xl font-bold text-gray-900 mb-2">選擇您目前的情境</h1>
            <p class="text-gray-500" id="remaining-time-display">預計還可以使用 -- 分鐘</p>
        </div>

        <!-- Mode Buttons -->
        <div class="space-y-4 px-4">
            <!-- Practice Mode -->
            <button onclick="selectMode('practice')" class="w-full py-6 px-6 bg-gray-900 text-white rounded-xl text-lg font-medium hover:bg-gray-800 transition-colors">
                預先練習
            </button>

            <!-- Emergency Mode -->
            <button onclick="selectMode('emergency')" class="w-full py-6 px-6 bg-gray-900 text-white rounded-xl text-lg font-medium hover:bg-gray-800 transition-colors border-2 border-gray-900">
                和孩子談談
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Select mode
    function selectMode(mode) {
        localStorage.setItem('island_parents_mode', mode);

        if (mode === 'practice') {
            window.location.href = '/island-parents/session';
        } else if (mode === 'emergency') {
            window.location.href = '/island-parents/emergency-hint';
        }
    }

    // Fetch and display available credits
    async function loadAvailableCredits() {
        try {
            const token = localStorage.getItem('island_parents_token');
            const response = await fetch('/api/auth/me', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'X-Tenant-Id': 'island_parents'
                }
            });

            if (response.ok) {
                const data = await response.json();
                const credits = Math.floor(data.available_credits || 0);
                document.getElementById('remaining-time-display').textContent =
                    `預計還可以使用 ${credits} 分鐘`;
            } else if (response.status === 401) {
                // Token expired or invalid, redirect to login
                console.warn('Token expired, redirecting to login');
                window.location.href = '/island-parents/login';
            }
        } catch (error) {
            console.error('Failed to load credits:', error);
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
        if (!await checkAuth()) return;

        // Check if client is selected
        const selectedClient = localStorage.getItem('island_parents_selected_client');
        if (!selectedClient) {
            window.location.href = '/island-parents/clients';
        }

        // Load available credits
        await loadAvailableCredits();
    });
</script>
{% endblock %}
