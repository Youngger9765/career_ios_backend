{% extends "island_parents/base.html" %}

{% block title %}新增孩子 - 浮島親子{% endblock %}

{% block extra_styles %}
/* Avatar selection */
.avatar-option {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    border: 3px solid transparent;
}

.avatar-option:hover {
    transform: scale(1.05);
}

.avatar-option.selected {
    border-color: #1f2937;
}

.avatar-option-inner {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Avatar colors */
.avatar-mint { background: linear-gradient(135deg, #a8e6cf 0%, #88d8b0 100%); }
.avatar-yellow { background: linear-gradient(135deg, #fff59d 0%, #fff176 100%); }
.avatar-pink { background: linear-gradient(135deg, #f8bbd9 0%, #f48fb1 100%); }
.avatar-blue { background: linear-gradient(135deg, #90caf9 0%, #64b5f6 100%); }
.avatar-purple { background: linear-gradient(135deg, #ce93d8 0%, #ba68c8 100%); }
.avatar-orange { background: linear-gradient(135deg, #ffcc80 0%, #ffa726 100%); }
{% endblock %}

{% block content %}
<div class="page-container safe-area-top safe-area-bottom">
    <div class="flex-1 flex flex-col max-w-md mx-auto w-full">
        <!-- Back Button -->
        <div class="flex items-center mb-4">
            <button onclick="window.location.href='/island-parents/clients'" class="p-2 -ml-2 text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </button>
        </div>

        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-2xl font-bold text-gray-900 mb-2">新增孩子</h1>
            <p class="text-gray-500">建立孩子的資料以開始練習</p>
        </div>

        <!-- Form -->
        <form id="create-client-form" onsubmit="return handleCreateClient(event)">
            <!-- Child Name -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">孩子的名字</label>
                <input
                    type="text"
                    id="child-name"
                    class="input-field"
                    placeholder="輸入孩子的名字或暱稱"
                    required
                >
            </div>

            <!-- Child Grade (年級) -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">年級 <span class="text-red-500">*</span></label>
                <select id="child-grade" class="input-field" required>
                    <option value="">選擇年級</option>
                    <option value="1 (小一)">小一</option>
                    <option value="2 (小二)">小二</option>
                    <option value="3 (小三)">小三</option>
                    <option value="4 (小四)">小四</option>
                    <option value="5 (小五)">小五</option>
                    <option value="6 (小六)">小六</option>
                    <option value="7 (國一)">國一</option>
                    <option value="8 (國二)">國二</option>
                    <option value="9 (國三)">國三</option>
                    <option value="10 (高一)">高一</option>
                    <option value="11 (高二)">高二</option>
                    <option value="12 (高三)">高三</option>
                </select>
            </div>

            <!-- Relationship (與孩子的關係) -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">你是孩子的 <span class="text-red-500">*</span></label>
                <select id="child-relationship" class="input-field" required>
                    <option value="">選擇關係</option>
                    <option value="爸爸">爸爸</option>
                    <option value="媽媽">媽媽</option>
                    <option value="爺爺">爺爺</option>
                    <option value="奶奶">奶奶</option>
                    <option value="外公">外公</option>
                    <option value="外婆">外婆</option>
                    <option value="其他">其他</option>
                </select>
            </div>

            <!-- Avatar Selection -->
            <div class="mb-8">
                <label class="block text-sm font-medium text-gray-700 mb-3">選擇頭像</label>
                <div class="flex flex-wrap justify-center gap-3">
                    <div class="avatar-option selected" data-color="mint" onclick="selectAvatar('mint')">
                        <div class="avatar-option-inner avatar-mint">
                            <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="avatar-option" data-color="yellow" onclick="selectAvatar('yellow')">
                        <div class="avatar-option-inner avatar-yellow">
                            <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="avatar-option" data-color="pink" onclick="selectAvatar('pink')">
                        <div class="avatar-option-inner avatar-pink">
                            <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="avatar-option" data-color="blue" onclick="selectAvatar('blue')">
                        <div class="avatar-option-inner avatar-blue">
                            <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="avatar-option" data-color="purple" onclick="selectAvatar('purple')">
                        <div class="avatar-option-inner avatar-purple">
                            <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="avatar-option" data-color="orange" onclick="selectAvatar('orange')">
                        <div class="avatar-option-inner avatar-orange">
                            <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="selected-avatar" value="mint">
            </div>

            <!-- Error Message -->
            <div id="create-error" class="error-message mb-4"></div>

            <!-- Submit Button -->
            <button type="submit" id="create-btn" class="btn-primary">
                <span id="create-btn-text">建立孩子資料</span>
                <span id="create-btn-loading" class="hidden flex items-center justify-center">
                    <div class="spinner"></div>
                </span>
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let selectedAvatar = 'mint';

    // Select avatar
    function selectAvatar(color) {
        selectedAvatar = color;
        document.getElementById('selected-avatar').value = color;

        // Update UI
        document.querySelectorAll('.avatar-option').forEach(option => {
            option.classList.remove('selected');
        });
        document.querySelector(`[data-color="${color}"]`).classList.add('selected');
    }

    // Handle create client
    async function handleCreateClient(event) {
        event.preventDefault();
        hideError('create-error');
        setButtonLoading('create-btn', true);

        const name = document.getElementById('child-name').value.trim();
        const grade = document.getElementById('child-grade').value;
        const relationship = document.getElementById('child-relationship').value;

        // 驗證必填欄位
        if (!name) {
            showError('create-error', '請輸入孩子的名字');
            setButtonLoading('create-btn', false);
            return false;
        }
        if (!grade) {
            showError('create-error', '請選擇年級');
            setButtonLoading('create-btn', false);
            return false;
        }
        if (!relationship) {
            showError('create-error', '請選擇與孩子的關係');
            setButtonLoading('create-btn', false);
            return false;
        }

        try {
            // Use unified client-case API (Island Parents 只需要 name, grade, relationship)
            const response = await fetch(`${API_BASE}/api/v1/ui/client-case`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${state.token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: name,
                    grade: grade,
                    relationship: relationship
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || '建立失敗');
            }

            const result = await response.json();

            // Store client and case info
            const newClient = {
                id: result.client_id,
                name: result.client_name,
                code: result.client_code,
                metadata: {
                    avatar_color: selectedAvatar,
                    grade: grade,
                    relationship: relationship
                }
            };
            const newCase = {
                id: result.case_id,
                case_number: result.case_number
            };

            localStorage.setItem('island_parents_selected_client', JSON.stringify(newClient));
            localStorage.setItem('island_parents_selected_case', JSON.stringify(newCase));

            // Navigate to mode selection
            window.location.href = '/island-parents/mode';

        } catch (error) {
            showError('create-error', error.message);
        } finally {
            setButtonLoading('create-btn', false);
        }

        return false;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
        if (!await checkAuth()) return;
    });
</script>
{% endblock %}
