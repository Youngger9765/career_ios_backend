<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>å³æ™‚è«®å•†è¼”åŠ©ç³»çµ± - Realtime Counseling</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS for commercial-grade UI */
        * {
            -webkit-tap-highlight-color: transparent;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Safe area for mobile notches */
        .safe-area-inset-bottom {
            padding-bottom: max(1rem, env(safe-area-inset-bottom));
        }

        /* Smooth transitions */
        .transition-smooth {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Card hover effects */
        .card-hover {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
        }

        /* Animated gradient backgrounds */
        .gradient-animate {
            background-size: 200% 200%;
            animation: gradientShift 8s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Pulse animation for recording */
        .pulse-recording {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Fade in animation */
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Slide in from right animation */
        .animate-slide-in-right {
            animation: slideInRight 0.4s ease-out;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Chat bubble styles */
        .chat-bubble {
            max-width: 85%;
            word-wrap: break-word;
        }

        @media (min-width: 768px) {
            .chat-bubble {
                max-width: 75%;
            }
        }

        /* Touch-friendly button sizes */
        .btn-touch {
            min-height: 44px;
            min-width: 44px;
        }

        /* Badge severity colors */
        .badge-critical {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .badge-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .badge-info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .badge-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        /* Audio waveform animation */
        .waveform-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            height: 60px;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .waveform-bar {
            width: 6px;
            background: linear-gradient(180deg, #10b981 0%, #14b8a6 100%);
            border-radius: 3px;
            animation: waveform 1.2s ease-in-out infinite;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }

        .waveform-bar:nth-child(1) { animation-delay: 0s; }
        .waveform-bar:nth-child(2) { animation-delay: 0.1s; }
        .waveform-bar:nth-child(3) { animation-delay: 0.2s; }
        .waveform-bar:nth-child(4) { animation-delay: 0.3s; }
        .waveform-bar:nth-child(5) { animation-delay: 0.4s; }
        .waveform-bar:nth-child(6) { animation-delay: 0.3s; }
        .waveform-bar:nth-child(7) { animation-delay: 0.2s; }
        .waveform-bar:nth-child(8) { animation-delay: 0.1s; }

        @keyframes waveform {
            0%, 100% {
                height: 20px;
                background: linear-gradient(180deg, #10b981 0%, #14b8a6 100%);
            }
            50% {
                height: 50px;
                background: linear-gradient(180deg, #14b8a6 0%, #06b6d4 100%);
            }
        }

        /* REQUIREMENT 5: Compact waveform for mobile */
        @keyframes waveform-compact {
            0%, 100% {
                height: 8px;
                background: linear-gradient(180deg, #10b981 0%, #14b8a6 100%);
            }
            50% {
                height: 20px;
                background: linear-gradient(180deg, #14b8a6 0%, #06b6d4 100%);
            }
        }

        /* Recording timer */
        .recording-timer {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Courier New', monospace;
            font-variant-numeric: tabular-nums;
            letter-spacing: 0.05em;
        }

        /* iOS-Style Frosted Glass Effect */
        .ios-frosted {
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
        }

        /* iOS Safe Area - Top */
        .safe-area-inset-top {
            padding-top: max(1rem, env(safe-area-inset-top));
        }

        /* iOS Button Active State */
        .ios-button-active {
            transform: scale(0.96);
        }

        /* iOS Card Shadow */
        .ios-card-shadow {
            box-shadow: 0 2px 16px rgba(0, 0, 0, 0.08), 0 1px 4px rgba(0, 0, 0, 0.04);
        }

        /* Mobile Content Padding for Fixed Bars - REMOVED, using spacer blocks instead */

        /* Haptic Feedback Animation */
        @keyframes haptic-tap {
            0% { transform: scale(1); }
            50% { transform: scale(0.96); }
            100% { transform: scale(1); }
        }

        /* Spinner Animation for Loading State */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        .haptic-feedback:active {
            animation: haptic-tap 0.15s ease-out;
        }

        /* Header is now controlled via Tailwind classes (hidden md:block) */
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <!-- Header - Commercial Grade with Gradient - Hidden on mobile, visible on desktop -->
    <nav id="mainHeader" class="hidden md:block sticky top-0 z-50 bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-700 shadow-lg gradient-animate">
        <div class="container mx-auto max-w-7xl px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 md:w-12 md:h-12 bg-white rounded-xl flex items-center justify-center shadow-md">
                        <span class="text-2xl">ğŸ¤</span>
                    </div>
                    <div>
                        <h1 class="text-white font-bold text-lg md:text-xl">å³æ™‚è«®å•†è¼”åŠ©</h1>
                        <p class="text-indigo-200 text-xs hidden md:block">AI-Powered Counseling Assistant</p>
                    </div>
                </div>
                <a href="/console" class="text-white hover:bg-white/20 px-3 md:px-4 py-2 rounded-lg transition-smooth text-sm font-medium backdrop-blur-sm bg-white/10">
                    <span class="hidden md:inline">â† è¿”å›æ§åˆ¶å°</span>
                    <span class="md:hidden">â† è¿”å›</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- MOBILE-ONLY: Non-scrollable Block Layout (100vh, no position: fixed) -->
    <div class="md:hidden h-screen flex flex-col overflow-hidden">
        <!-- TOP BLOCK: Recording Controls (fixed height) -->
        <div class="bg-white/95 ios-frosted border-b border-gray-200/50 ios-card-shadow safe-area-inset-top">
            <div class="px-4 py-3">
                <!-- Start/Stop Buttons -->
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <button id="startBtnMobile" class="haptic-feedback btn-touch bg-gradient-to-r from-green-500 to-emerald-600 active:from-green-600 active:to-emerald-700 text-white py-3 px-4 rounded-2xl font-bold transition-smooth ios-card-shadow flex items-center justify-center gap-2">
                        <span class="text-xl">â–¶ï¸</span>
                        <span class="text-base">é–‹å§‹</span>
                    </button>
                    <button id="stopBtnMobile" class="haptic-feedback btn-touch bg-gradient-to-r from-red-500 to-rose-600 active:from-red-600 active:to-rose-700 text-white py-3 px-4 rounded-2xl font-bold opacity-50 cursor-not-allowed ios-card-shadow flex items-center justify-center gap-2" disabled>
                        <span class="text-xl">â¹ï¸</span>
                        <span class="text-base">çµæŸ</span>
                    </button>
                </div>

                <!-- Mode Toggle + Recording Waveform & Timer -->
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <!-- Left: Demo/Real Mode Toggle -->
                    <div class="flex flex-col items-start gap-1.5 bg-gray-50/90 rounded-xl p-2.5 border border-gray-200/50">
                        <label class="text-xs font-semibold text-gray-700 flex items-center gap-1">
                            <span class="text-base">ğŸ¤</span>
                            <span id="modeToggleLabel">çœŸå¯¦éŒ„éŸ³</span>
                        </label>
                        <button id="modeToggle" class="relative inline-flex h-6 w-11 items-center rounded-full bg-green-600 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-1" role="switch" aria-checked="true" title="åˆ‡æ›çœŸå¯¦éŒ„éŸ³/Demoæ¨¡å¼">
                            <span class="inline-block h-4 w-4 transform rounded-full bg-white shadow transition-transform translate-x-6"></span>
                        </button>
                        <span id="modeHint" class="text-[10px] text-gray-500">é–‹å•Ÿ = çœŸå¯¦</span>
                    </div>

                    <!-- Right: Recording Waveform + Timer (only shows when recording) -->
                    <div id="recordingTimerDisplayMobile" class="flex flex-col items-center justify-center bg-gradient-to-r from-teal-50/90 to-cyan-50/90 rounded-xl p-2.5 border border-teal-200/50" style="display: none;">
                        <div class="flex items-center justify-between gap-2 w-full">
                            <!-- Compact Waveform -->
                            <div id="waveformContainerMobile" class="flex items-center justify-center gap-1 flex-1" style="height: 20px;">
                                <div class="waveform-bar" style="width: 3px; animation: waveform-compact 1.2s ease-in-out infinite; animation-delay: 0s;"></div>
                                <div class="waveform-bar" style="width: 3px; animation: waveform-compact 1.2s ease-in-out infinite; animation-delay: 0.1s;"></div>
                                <div class="waveform-bar" style="width: 3px; animation: waveform-compact 1.2s ease-in-out infinite; animation-delay: 0.2s;"></div>
                                <div class="waveform-bar" style="width: 3px; animation: waveform-compact 1.2s ease-in-out infinite; animation-delay: 0.3s;"></div>
                                <div class="waveform-bar" style="width: 3px; animation: waveform-compact 1.2s ease-in-out infinite; animation-delay: 0.2s;"></div>
                                <div class="waveform-bar" style="width: 3px; animation: waveform-compact 1.2s ease-in-out infinite; animation-delay: 0.1s;"></div>
                            </div>
                            <!-- Compact Timer -->
                            <div class="flex items-center gap-1 flex-shrink-0">
                                <div class="w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse"></div>
                                <span id="recordingTimerMobile" class="text-xs font-mono font-bold text-gray-700">00:00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MIDDLE BLOCK: Content Area (flex-1, fills remaining space) -->
        <div class="flex-1 overflow-hidden bg-gradient-to-br from-gray-50 to-gray-100 p-4">
            <!-- REQUIREMENT 3: Instruction Card (visible when NOT recording) -->
            <div id="instructionCard" class="h-full bg-gradient-to-br from-purple-50 via-indigo-50 to-blue-50 rounded-2xl p-6 ios-card-shadow border border-indigo-100 flex flex-col justify-center">
                <div class="flex items-start gap-4 mb-4">
                    <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl flex items-center justify-center flex-shrink-0 shadow-md">
                        <span class="text-2xl">ğŸ’¡</span>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-bold text-gray-800 mb-2">å¦‚ä½•ä½¿ç”¨</h3>
                        <div class="space-y-2 text-sm text-gray-700 leading-relaxed">
                            <p class="flex items-start gap-2">
                                <span class="text-green-600 font-bold mt-0.5">1.</span>
                                <span>é»æ“Šä¸Šæ–¹ã€Œé–‹å§‹ã€æŒ‰éˆ•é–‹å§‹éŒ„éŸ³</span>
                            </p>
                            <p class="flex items-start gap-2">
                                <span class="text-green-600 font-bold mt-0.5">2.</span>
                                <span>å°è©±éç¨‹ä¸­ï¼ŒAI æ¯ 60 ç§’è‡ªå‹•åˆ†æ</span>
                            </p>
                            <p class="flex items-start gap-2">
                                <span class="text-green-600 font-bold mt-0.5">3.</span>
                                <span>æˆ–é»æ“Šä¸‹æ–¹ã€Œå³æ™‚åˆ†æã€ç«‹å³å–å¾—å»ºè­°</span>
                            </p>
                            <p class="flex items-start gap-2">
                                <span class="text-purple-600 font-bold mt-0.5">ğŸ’¡</span>
                                <span class="font-semibold">æ¸¬è©¦æ¨¡å¼ï¼šæŒ‰ <kbd class="bg-white px-2 py-0.5 rounded border shadow-sm font-mono text-xs">T</kbd> éµå¯æ¨¡æ“¬å°è©±</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- REQUIREMENT 6: Carousel Container (hidden initially, shown when analysis cards appear) -->
            <div id="mobileCarousel" class="hidden h-full flex flex-col">
                <!-- Carousel Header with Navigation -->
                <div class="flex items-center justify-between mb-3 flex-shrink-0">
                    <h3 class="text-base font-bold text-gray-800 flex items-center gap-2">
                        <span class="text-lg">ğŸ¤–</span>
                        <span>AI åˆ†æ</span>
                    </h3>
                    <div class="flex items-center gap-2">
                        <span id="carouselCounter" class="text-xs text-gray-500 font-medium">1 / 1</span>
                    </div>
                </div>

                <!-- Carousel Navigation Buttons -->
                <div class="relative flex-1 min-h-0">
                    <!-- Previous Button -->
                    <button id="carouselPrev" class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-2 z-10 w-10 h-10 bg-white/95 ios-frosted rounded-full ios-card-shadow flex items-center justify-center text-gray-700 hover:bg-gray-50 transition-smooth disabled:opacity-30 disabled:cursor-not-allowed" disabled>
                        <span class="text-xl">â†</span>
                    </button>

                    <!-- Card Container -->
                    <div class="overflow-hidden rounded-2xl h-full">
                        <div id="mobileCarouselTrack" class="flex transition-transform duration-300 ease-out h-full">
                            <!-- Cards will be inserted here via JavaScript -->
                        </div>
                    </div>

                    <!-- Next Button -->
                    <button id="carouselNext" class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-2 z-10 w-10 h-10 bg-white/95 ios-frosted rounded-full ios-card-shadow flex items-center justify-center text-gray-700 hover:bg-gray-50 transition-smooth disabled:opacity-30 disabled:cursor-not-allowed" disabled>
                        <span class="text-xl">â†’</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- BOTTOM BLOCK: Analysis Button (fixed height) -->
        <div class="bg-white/95 ios-frosted border-t border-gray-200/50 ios-card-shadow safe-area-inset-bottom">
            <div class="px-4 py-4">
                <button id="fabAnalyze" class="haptic-feedback w-full h-16 bg-gradient-to-r from-purple-500 via-indigo-600 to-purple-600 text-white rounded-2xl font-bold ios-card-shadow flex items-center justify-center gap-3 transition-smooth active:scale-95 opacity-50 cursor-not-allowed" aria-label="Instant Analysis" disabled>
                    <span class="text-3xl">âš¡</span>
                    <span class="text-lg tracking-wide">å³æ™‚åˆ†æ</span>
                </button>
            </div>
        </div>
    </div>

    <!-- DESKTOP LAYOUT (unchanged) -->
    <div class="container mx-auto px-4 md:px-6 py-4 md:py-6 max-w-7xl md:pb-6 hidden md:block">

        <!-- Demo Mode Instructions - Collapsible on Mobile -->
        <div class="bg-gradient-to-r from-yellow-50 to-amber-50 border-l-4 border-yellow-400 p-4 mb-4 md:mb-6 rounded-xl shadow-md card-hover" style="display: none">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-yellow-400 rounded-lg flex items-center justify-center">
                        <svg class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
                <div class="ml-3 flex-1">
                    <h3 class="text-sm md:text-base font-bold text-yellow-800 flex items-center gap-2">
                        <span>ğŸ­ Demo æ¨¡å¼èªªæ˜</span>
                        <span class="text-xs bg-yellow-200 text-yellow-800 px-2 py-0.5 rounded-full">ç„¡éœ€ API Key</span>
                    </h3>
                    <div class="mt-2 text-sm text-yellow-700 leading-relaxed">
                        <p class="mb-2">æ­¤ç‚ºå±•ç¤ºæ¨¡å¼ï¼Œä½¿ç”¨æ™ºæ…§å‡è³‡æ–™æ¨¡æ“¬å®Œæ•´åŠŸèƒ½ï¼š</p>
                        <ul class="space-y-1 ml-2">
                            <li class="flex items-center gap-2">
                                <kbd class="px-2 py-1 bg-white rounded border shadow-sm font-mono text-xs">T</kbd>
                                <span>æ’­æ”¾ä¸‹ä¸€å¥å°è©±ï¼ˆè‡ªå‹•åˆ‡æ›èªªè©±è€…ï¼‰</span>
                            </li>
                            <li class="flex items-center gap-2">
                                <kbd class="px-2 py-1 bg-white rounded border shadow-sm font-mono text-xs">R</kbd>
                                <span>é‡ç½®åŠ‡æœ¬å¾é ­é–‹å§‹</span>
                            </li>
                            <li class="flex items-center gap-2">
                                <kbd class="px-2 py-1 bg-white rounded border shadow-sm font-mono text-xs">1</kbd>
                                <span>åˆ‡æ›åˆ°ã€Œå·¥ä½œå£“åŠ›ã€åŠ‡æœ¬ï¼ˆå«è‡ªæ®ºé¢¨éšªåµæ¸¬ï¼‰</span>
                            </li>
                            <li class="flex items-center gap-2">
                                <kbd class="px-2 py-1 bg-white rounded border shadow-sm font-mono text-xs">2</kbd>
                                <span>åˆ‡æ›åˆ°ã€Œä¸€èˆ¬è«®è©¢ã€åŠ‡æœ¬</span>
                            </li>
                        </ul>
                        <p class="mt-3 font-bold bg-yellow-100 p-2 rounded-lg">ğŸ’¡ AI åˆ†ææ¯ 60 ç§’è‡ªå‹•è§¸ç™¼ï¼Œæ ¹æ“šé€å­—ç¨¿å…§å®¹æ™ºæ…§ç”Ÿæˆæ‘˜è¦ã€è­¦ç¤ºã€å»ºè­°ã€‚</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Left Panel: Recording Controls -->
            <div class="space-y-4 hidden md:block">
                <!-- Recording Controls - Enhanced -->
                <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 card-hover border border-gray-100">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-8 h-8 bg-gradient-to-br from-red-500 to-pink-500 rounded-lg flex items-center justify-center">
                            <span class="text-white text-lg">ğŸ™ï¸</span>
                        </div>
                        <h2 class="text-lg md:text-xl font-bold text-gray-800">éŒ„éŸ³æ§åˆ¶</h2>
                    </div>

                    <!-- Timer Display - More Prominent -->
                    <div class="text-center mb-6 bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-4 md:p-6">
                        <div class="text-4xl md:text-5xl font-mono font-bold text-gray-800" id="timer">00:00</div>
                        <div class="text-xs md:text-sm text-gray-500 mt-2 font-medium">æœƒè«‡æ™‚é–“</div>
                    </div>

                    <!-- Start/Stop Buttons - Desktop -->
                    <div class="hidden md:grid md:grid-cols-2 gap-4 mb-6">
                        <button id="startBtn" class="btn-touch bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white py-4 px-6 rounded-xl font-bold transition-smooth shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                            <span class="text-xl">â–¶ï¸</span>
                            <span>é–‹å§‹æœƒè«‡</span>
                        </button>
                        <button id="stopBtn" class="btn-touch bg-gradient-to-r from-red-500 to-rose-600 text-white py-4 px-6 rounded-xl font-bold opacity-50 cursor-not-allowed shadow-md flex items-center justify-center gap-2" disabled>
                            <span class="text-xl">â¹ï¸</span>
                            <span>çµæŸæœƒè«‡</span>
                        </button>
                    </div>

                    <!-- Audio Waveform Animation -->
                    <div id="waveformContainer" class="waveform-container mb-4" style="display: none;">
                        <div class="waveform-bar"></div>
                        <div class="waveform-bar"></div>
                        <div class="waveform-bar"></div>
                        <div class="waveform-bar"></div>
                        <div class="waveform-bar"></div>
                        <div class="waveform-bar"></div>
                        <div class="waveform-bar"></div>
                        <div class="waveform-bar"></div>
                    </div>

                    <!-- Recording Timer Display -->
                    <div id="recordingTimerDisplay" class="text-center mb-6 bg-gradient-to-r from-teal-50 to-cyan-50 rounded-xl p-4 border border-teal-200" style="display: none;">
                        <div class="flex items-center justify-center gap-3">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                                <span class="text-sm font-medium text-gray-700">éŒ„éŸ³ä¸­</span>
                            </div>
                            <div class="recording-timer text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-teal-600 to-cyan-600" id="recordingTimer">00:00</div>
                        </div>
                    </div>

                    <!-- Audio Playback Controls (Demo Mode) -->
                    <div id="audioPlayerSection" class="mb-6 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-4 border border-purple-200" style="display: none;">
                        <div class="flex flex-col gap-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span class="text-lg">ğŸµ</span>
                                    <span class="text-sm font-bold text-gray-700">æ¨¡æ“¬éŸ³è¨Šæ’­æ”¾</span>
                                </div>
                                <span id="audioStatus" class="text-xs text-purple-600 font-medium">æº–å‚™ä¸­</span>
                            </div>

                            <!-- Audio Progress Bar -->
                            <div class="w-full bg-purple-200 rounded-full h-2 cursor-pointer" id="audioProgressContainer">
                                <div id="audioProgress" class="bg-gradient-to-r from-purple-500 to-indigo-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>

                            <!-- Playback Controls -->
                            <div class="flex items-center justify-between gap-2">
                                <button id="audioPlayBtn" class="btn-touch bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md flex items-center gap-2">
                                    <span id="audioPlayIcon">â–¶ï¸</span>
                                    <span id="audioPlayText">æ’­æ”¾å°è©±</span>
                                </button>
                                <div class="flex items-center gap-2 text-xs font-mono text-gray-600">
                                    <span id="audioCurrentTime">0:00</span>
                                    <span>/</span>
                                    <span id="audioDuration">0:00</span>
                                </div>
                            </div>

                            <p class="text-xs text-purple-700">
                                ğŸ’¡ éŸ³è¨Šæ’­æ”¾æ™‚ï¼Œé€å­—ç¨¿æœƒåŒæ­¥é¡¯ç¤ºã€‚é»æ“Šã€Œå³æ™‚åˆ†æã€å¯åˆ†æç•¶å‰å·²é¡¯ç¤ºçš„å°è©±å…§å®¹ã€‚
                            </p>
                        </div>
                    </div>

                    <!-- Mode Toggle - Desktop -->
                    <div class="mb-4">
                        <div class="flex items-center justify-between bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-4 border border-purple-200">
                            <label class="text-sm font-bold text-gray-800 flex items-center gap-2">
                                <span class="text-lg">ğŸ¤</span>
                                <span id="modeToggleLabelDesktop">çœŸå¯¦éŒ„éŸ³</span>
                            </label>
                            <div class="flex items-center gap-2">
                                <span id="modeHintDesktop" class="text-xs text-gray-600">é–‹å•Ÿ = çœŸå¯¦</span>
                                <button id="modeToggleDesktop" class="relative inline-flex h-7 w-12 items-center rounded-full bg-green-600 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" role="switch" aria-checked="true" title="åˆ‡æ›çœŸå¯¦éŒ„éŸ³/Demoæ¨¡å¼">
                                    <span class="inline-block h-5 w-5 transform rounded-full bg-white shadow transition-transform translate-x-6"></span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Status Indicator - Enhanced -->
                    <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-4 border border-gray-200">
                        <div class="flex items-center justify-between text-sm mb-2">
                            <span class="font-bold text-gray-700">ç‹€æ…‹ï¼š</span>
                            <span id="status" class="text-gray-600 font-medium">å¾…æ©Ÿä¸­</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="font-bold text-gray-700">ä¸‹æ¬¡åˆ†æï¼š</span>
                            <span id="nextAnalysis" class="text-gray-600 font-medium">æœªé–‹å§‹</span>
                        </div>
                    </div>

                    <!-- Demo Mode Hint - Enhanced -->
                    <div class="mt-4 p-3 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl">
                        <p class="text-xs md:text-sm text-blue-700 leading-relaxed">
                            ğŸ’¡ <strong>æ¸¬è©¦æ¨¡å¼</strong>ï¼šé»æ“Šä¸Šæ–¹ã€Œæ’­æ”¾å°è©±ã€æŒ‰éˆ•ï¼Œæˆ–æŒ‰ <kbd class="bg-blue-200 px-2 py-1 rounded font-mono text-xs">T</kbd> éµæ‰‹å‹•æ’­æ”¾ä¸‹ä¸€å¥
                        </p>
                    </div>
                </div>
            </div>

            <!-- Right Panel: AI Analysis Cards -->
            <div class="space-y-4">
                <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 card-hover border border-gray-100">
                    <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-3 mb-4">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-lg flex items-center justify-center">
                                <span class="text-white text-lg">ğŸ¤–</span>
                            </div>
                            <h2 class="text-lg md:text-xl font-bold text-gray-800">AI å³æ™‚åˆ†æ</h2>
                        </div>
                        <div class="flex gap-2 flex-wrap">
                            <button id="triggerAnalysisBtn" class="btn-touch bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white px-3 md:px-4 py-2 rounded-lg text-xs md:text-sm font-bold transition-smooth shadow-md opacity-50 cursor-not-allowed flex items-center gap-1" disabled>
                                <span>âš¡</span>
                                <span class="hidden sm:inline">ç«‹å³åˆ†æ</span>
                                <span class="sm:hidden">åˆ†æ</span>
                            </button>
                            <button id="generateMultipleBtn" class="btn-touch bg-gradient-to-r from-indigo-500 to-blue-600 hover:from-indigo-600 hover:to-blue-700 text-white px-3 md:px-4 py-2 rounded-lg text-xs md:text-sm font-bold transition-smooth shadow-md hover:shadow-lg flex items-center gap-1">
                                <span>ğŸ¬</span>
                                <span class="hidden sm:inline">ç”Ÿæˆé€£çºŒåˆ†æ</span>
                                <span class="sm:hidden">Demo</span>
                            </button>
                        </div>
                    </div>

                    <!-- Analysis Cards Container -->
                    <div id="analysisCards" class="space-y-4 max-h-[600px] md:max-h-[800px] overflow-y-auto custom-scrollbar">
                        <!-- Empty State -->
                        <div class="flex flex-col items-center justify-center py-12 text-center" id="analysisEmpty">
                            <div class="w-16 h-16 md:w-20 md:h-20 bg-gradient-to-br from-purple-100 to-indigo-100 rounded-full flex items-center justify-center mb-4">
                                <span class="text-3xl md:text-4xl">ğŸ’¡</span>
                            </div>
                            <h3 class="text-base md:text-lg font-bold text-gray-800 mb-2">ç­‰å¾…åˆ†æ</h3>
                            <p class="text-gray-600 text-xs md:text-sm max-w-xs">
                                é»æ“Šã€Œç«‹å³åˆ†æã€æˆ–ã€Œç”Ÿæˆé€£çºŒåˆ†æã€æŸ¥çœ‹ AI ç£å°å»ºè­°
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Transcript Section - Collapsible (Moved to Bottom) -->
        <div class="mt-6 bg-white rounded-xl shadow-lg p-4 md:p-6 card-hover border border-gray-100 hidden md:block">
            <h2 class="text-lg md:text-xl font-bold mb-4 cursor-pointer flex justify-between items-center transition-smooth hover:text-teal-600" onclick="toggleTranscript()">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-gradient-to-br from-teal-500 to-cyan-500 rounded-lg flex items-center justify-center">
                        <span class="text-white text-lg">ğŸ“</span>
                    </div>
                    <span>å³æ™‚é€å­—ç¨¿</span>
                    <!-- Live Indicator -->
                    <div class="hidden" id="liveIndicator">
                        <span class="flex items-center gap-1 px-2 py-1 bg-red-500 text-white text-xs rounded-full animate-pulse">
                            <span class="w-2 h-2 bg-white rounded-full"></span>
                            <span class="font-bold">LIVE</span>
                        </span>
                    </div>
                </div>
                <span id="transcriptToggle" class="text-gray-400 transition-transform duration-300">â–¼</span>
            </h2>
            <div id="transcriptSection" class="hidden">
                <!-- Transcript Container - Chat-like -->
                <div id="transcript" class="h-[400px] md:h-[500px] overflow-y-auto bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 md:p-4 custom-scrollbar">
                    <!-- Empty State -->
                    <div class="flex flex-col items-center justify-center h-full text-center" id="transcriptEmpty">
                        <div class="w-16 h-16 md:w-20 md:h-20 bg-gray-200 rounded-full flex items-center justify-center mb-4">
                            <span class="text-3xl md:text-4xl">ğŸ’¬</span>
                        </div>
                        <h3 class="text-base md:text-lg font-bold text-gray-800 mb-2">é–‹å§‹æ–°æœƒè«‡</h3>
                        <p class="text-gray-600 text-xs md:text-sm">é»æ“Šã€Œé–‹å§‹æœƒè«‡ã€ï¼Œé–‹å§‹è¨˜éŒ„å°è©±</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Section (Collapsed by default) - Enhanced -->
        <div id="historyContainer" class="mt-6 bg-white rounded-xl shadow-lg p-4 md:p-6 card-hover border border-gray-100">
            <h2 class="text-lg md:text-xl font-bold mb-4 cursor-pointer flex justify-between items-center transition-smooth hover:text-indigo-600" onclick="toggleHistory()">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-gradient-to-br from-gray-500 to-gray-600 rounded-lg flex items-center justify-center">
                        <span class="text-white text-lg">ğŸ“Š</span>
                    </div>
                    <span>æ­·å²è¨˜éŒ„</span>
                </div>
                <span id="historyToggle" class="text-gray-400 transition-transform duration-300">â–¼</span>
            </h2>
            <div id="historySection" class="hidden">
                <button onclick="clearHistory()" class="btn-touch bg-gradient-to-r from-red-500 to-rose-600 hover:from-red-600 hover:to-rose-700 text-white px-4 py-2 rounded-lg mb-4 transition-smooth shadow-md hover:shadow-lg flex items-center gap-2">
                    <span>ğŸ—‘ï¸</span>
                    <span>æ¸…é™¤æ­·å²</span>
                </button>
                <div id="historyList" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <script>
        // === State Management ===
        let isRecording = false;
        let currentSpeaker = 'counselor';
        let startTime = null;
        let timerInterval = null;
        let analysisInterval = null;
        let transcriptSegments = []; // Only stores DISPLAYED transcript segments
        let lastAutoAnalysisTime = 0; // Track last auto-analysis to prevent duplicates
        let analysisHistory = [];
        let isDemoMode = false; // Default to real recording, toggle switches to demo mode
        let isVoiceSimEnabled = false; // Voice simulation toggle state (demo mode only)

        // === ElevenLabs Real-time STT State ===
        let elevenLabsWs = null; // WebSocket connection
        let audioContext = null; // Web Audio API context
        let audioWorkletNode = null; // AudioWorklet for PCM processing
        let audioStream = null; // MediaStream from microphone
        let partialTranscriptText = ''; // Temporary storage for partial transcript
        let elevenlabsToken = null; // Token from backend

        // === Audio Simulation State ===
        let audioSimulation = {
            isPlaying: false,
            currentTime: 0,
            duration: 0,
            lastDisplayedIndex: 0, // Track which script lines have been displayed
            animationFrame: null,
            startTimeMs: 0 // When playback started (performance.now())
        };

        // === Web Speech API (TTS) State ===
        let ttsState = {
            voices: [],
            counselorVoice: null,
            clientVoice: null,
            isSupported: 'speechSynthesis' in window,
            currentUtterance: null
        };

        // === Inactivity Timeout State ===
        let lastActivityTime = Date.now();
        let inactivityCheckInterval = null;
        let countdownInterval = null;

        // === DOM Elements ===
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const startBtnMobile = document.getElementById('startBtnMobile');
        const stopBtnMobile = document.getElementById('stopBtnMobile');
        const timer = document.getElementById('timer');
        const status = document.getElementById('status');
        const nextAnalysis = document.getElementById('nextAnalysis');
        const transcript = document.getElementById('transcript');
        const analysisCards = document.getElementById('analysisCards');
        const speakerCounselorBtn = document.getElementById('speakerCounselor');
        const speakerClientBtn = document.getElementById('speakerClient');
        const speakerToggleSection = document.getElementById('speakerToggleSection');
        const triggerAnalysisBtn = document.getElementById('triggerAnalysisBtn');
        const generateMultipleBtn = document.getElementById('generateMultipleBtn');
        const liveIndicator = document.getElementById('liveIndicator');
        const transcriptEmpty = document.getElementById('transcriptEmpty');
        const analysisEmpty = document.getElementById('analysisEmpty');
        const fabAnalyze = document.getElementById('fabAnalyze');
        const waveformContainer = document.getElementById('waveformContainer');
        const waveformContainerMobile = document.getElementById('waveformContainerMobile');
        const recordingTimerDisplay = document.getElementById('recordingTimerDisplay');
        const recordingTimerDisplayMobile = document.getElementById('recordingTimerDisplayMobile');
        const recordingTimer = document.getElementById('recordingTimer');
        const recordingTimerMobile = document.getElementById('recordingTimerMobile');
        const modeToggle = document.getElementById('modeToggle');
        const modeToggleDesktop = document.getElementById('modeToggleDesktop');
        const modeToggleLabel = document.getElementById('modeToggleLabel');
        const modeToggleLabelDesktop = document.getElementById('modeToggleLabelDesktop');
        const modeHint = document.getElementById('modeHint');
        const modeHintDesktop = document.getElementById('modeHintDesktop');

        // NEW: Mobile-specific elements for requirements 3, 4, 6
        const mainHeader = document.getElementById('mainHeader');
        const instructionCard = document.getElementById('instructionCard');
        const mobileCarousel = document.getElementById('mobileCarousel');
        const mobileCarouselTrack = document.getElementById('mobileCarouselTrack');
        const carouselPrev = document.getElementById('carouselPrev');
        const carouselNext = document.getElementById('carouselNext');
        const carouselCounter = document.getElementById('carouselCounter');

        // Audio Player Elements
        const audioPlayerSection = document.getElementById('audioPlayerSection');
        const audioPlayBtn = document.getElementById('audioPlayBtn');
        const audioPlayIcon = document.getElementById('audioPlayIcon');
        const audioPlayText = document.getElementById('audioPlayText');
        const audioProgress = document.getElementById('audioProgress');
        const audioProgressContainer = document.getElementById('audioProgressContainer');
        const audioCurrentTime = document.getElementById('audioCurrentTime');
        const audioDuration = document.getElementById('audioDuration');
        const audioStatus = document.getElementById('audioStatus');

        // Carousel state
        let mobileAnalysisCards = [];
        let currentCarouselIndex = 0;

        // === Event Listeners ===
        startBtn.addEventListener('click', startSession);
        stopBtn.addEventListener('click', stopSession);
        startBtnMobile.addEventListener('click', startSession);
        stopBtnMobile.addEventListener('click', stopSession);
        // Speaker buttons removed (AI auto-detects speakers)
        triggerAnalysisBtn.addEventListener('click', manuallyTriggerAnalysis);
        generateMultipleBtn.addEventListener('click', generateMultipleAnalyses);
        fabAnalyze.addEventListener('click', manuallyTriggerAnalysis);

        // NEW: Carousel navigation
        if (carouselPrev) carouselPrev.addEventListener('click', () => navigateCarousel(-1));
        if (carouselNext) carouselNext.addEventListener('click', () => navigateCarousel(1));

        // Mode Toggle (Demo/Real)
        modeToggle.addEventListener('click', toggleRecordingMode);
        if (modeToggleDesktop) modeToggleDesktop.addEventListener('click', toggleRecordingMode);

        // Audio Player Controls
        if (audioPlayBtn) audioPlayBtn.addEventListener('click', toggleAudioPlayback);
        if (audioProgressContainer) {
            audioProgressContainer.addEventListener('click', (e) => {
                const rect = audioProgressContainer.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const percentage = clickX / rect.width;
                seekAudio(percentage);
            });
        }

        // === Initialization ===
        // Initialize Web Speech API (TTS)
        initializeSpeechSynthesis();

        // === ElevenLabs Real-time STT Functions ===

        /**
         * Start real recording with ElevenLabs WebSocket + MediaRecorder
         */
        async function startRealRecording() {
            // Step 1: Get single-use token from backend
            console.log('ğŸ“ å‘¼å«å¾Œç«¯å–å¾— ElevenLabs token...');
            const tokenResponse = await fetch('/api/v1/realtime/elevenlabs-token', {
                method: 'POST'
            });

            if (!tokenResponse.ok) {
                throw new Error(`Token ç”Ÿæˆå¤±æ•—: ${tokenResponse.status}`);
            }

            const { token } = await tokenResponse.json();
            elevenlabsToken = token;
            console.log('âœ… Token å–å¾—æˆåŠŸ');

            // Step 2: Request microphone access
            try {
                audioStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        channelCount: 1,
                        sampleRate: 16000, // 16kHz for speech (ElevenLabs supports 8-48kHz)
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                console.log('âœ… Microphone access granted');
            } catch (error) {
                throw new Error(`éº¥å…‹é¢¨å­˜å–å¤±æ•—: ${error.message}`);
            }

            // Step 3: Establish WebSocket connection to ElevenLabs
            // All configuration goes in query parameters, not as JSON message
            // Use "token" parameter (browsers can't set custom headers in WebSocket)
            const wsUrl = `wss://api.elevenlabs.io/v1/speech-to-text/realtime?` +
                `token=${elevenlabsToken}` +
                `&audio_format=pcm_16000` +
                `&language=cmn` +  // Mandarin Chinese (cmn, not zh)
                `&commit_strategy=vad`;  // Auto-commit with Voice Activity Detection

            console.log('ğŸ”Œ Connecting to ElevenLabs WebSocket...');
            elevenLabsWs = new WebSocket(wsUrl);

            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    reject(new Error('WebSocket é€£ç·šè¶…æ™‚'));
                }, 10000); // 10 second timeout

                elevenLabsWs.onopen = () => {
                    clearTimeout(timeout);
                    console.log('âœ… ElevenLabs WebSocket connected');
                    console.log('â³ Waiting for session_started message...');

                    // No need to send config - it's all in the URL query parameters
                    // Wait for session_started confirmation before starting audio

                    // Step 3: Start AudioContext to capture PCM audio
                    startAudioCapture();

                    // Start inactivity monitoring
                    startInactivityMonitoring();
                    resetInactivityTimer();

                    resolve();
                };

                elevenLabsWs.onmessage = (event) => {
                    handleElevenLabsMessage(event.data);
                };

                elevenLabsWs.onerror = (error) => {
                    clearTimeout(timeout);
                    console.error('âŒ WebSocket error:', error);
                    reject(new Error('WebSocket é€£ç·šéŒ¯èª¤'));
                };

                elevenLabsWs.onclose = (event) => {
                    console.log('ğŸ”Œ WebSocket closed:', event.code, event.reason);
                    if (!event.wasClean) {
                        console.warn('âš ï¸ WebSocket closed unexpectedly');
                    }
                };
            });
        }

        /**
         * Start AudioContext to capture and stream PCM audio
         */
        function startAudioCapture() {
            // Create AudioContext with 16kHz sample rate (ElevenLabs requirement)
            audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
            const source = audioContext.createMediaStreamSource(audioStream);

            // Create ScriptProcessorNode for audio processing (4096 buffer size)
            const bufferSize = 4096;
            const processor = audioContext.createScriptProcessor(bufferSize, 1, 1);

            processor.onaudioprocess = (e) => {
                if (elevenLabsWs && elevenLabsWs.readyState === WebSocket.OPEN) {
                    // Get PCM float32 audio data
                    const inputData = e.inputBuffer.getChannelData(0);

                    // Convert Float32 to Int16 (PCM S16LE)
                    const pcmData = new Int16Array(inputData.length);
                    for (let i = 0; i < inputData.length; i++) {
                        // Clamp to [-1, 1] and convert to 16-bit
                        const s = Math.max(-1, Math.min(1, inputData[i]));
                        pcmData[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                    }

                    // Convert to Base64
                    const base64Audio = arrayBufferToBase64(pcmData.buffer);

                    // Send to ElevenLabs (correct JSON format)
                    const message = {
                        message_type: 'input_audio_chunk',
                        audio_base_64: base64Audio,
                        commit: false,  // Auto-commit handled by VAD
                        sample_rate: 16000
                    };
                    elevenLabsWs.send(JSON.stringify(message));
                }
            };

            // Connect audio graph: source -> processor -> destination
            source.connect(processor);
            processor.connect(audioContext.destination);

            console.log('âœ… AudioContext started (PCM 16kHz streaming)');
        }

        /**
         * Convert ArrayBuffer to Base64
         */
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        /**
         * Handle messages from ElevenLabs WebSocket
         */
        function handleElevenLabsMessage(data) {
            try {
                const message = JSON.parse(data);

                // Debug: Log raw message to understand ElevenLabs response format
                console.log('ğŸ“¨ ElevenLabs raw message:', JSON.stringify(message, null, 2));
                console.log('ğŸ“¨ Message type:', message.message_type);
                console.log('ğŸ“¨ Message keys:', Object.keys(message));

                switch (message.message_type) {
                    case 'session_started':
                        console.log('âœ… ElevenLabs session started:', message);
                        break;

                    case 'partial_transcript':
                        // Real-time transcription (not yet finalized)
                        if (message.text) {
                            partialTranscriptText = message.text;
                            updatePartialTranscriptUI(message.text);
                            console.log('ğŸ“ Partial:', message.text);
                            resetInactivityTimer(); // Reset timer on any transcript activity
                        }
                        break;

                    case 'committed_transcript':
                        // Finalized transcription - add to chat
                        if (message.text && message.text.trim()) {
                            // Clear partial transcript UI
                            clearPartialTranscriptUI();

                            // Add to transcript with current speaker
                            addTranscriptLine(currentSpeaker, message.text.trim());
                            console.log('âœ… Committed:', message.text);

                            // Reset partial text
                            partialTranscriptText = '';

                            // Reset inactivity timer on committed transcript
                            resetInactivityTimer();
                        }
                        break;

                    case 'committed_transcript_with_timestamps':
                        // Finalized transcription with word-level timestamps
                        if (message.text && message.text.trim()) {
                            clearPartialTranscriptUI();
                            addTranscriptLine(currentSpeaker, message.text.trim());
                            console.log('âœ… Committed (with timestamps):', message.text);

                            // You can use message.words for word-level timing if needed
                            if (message.words) {
                                console.log('â±ï¸ Word timestamps:', message.words);
                            }

                            partialTranscriptText = '';

                            // Reset inactivity timer on committed transcript
                            resetInactivityTimer();
                        }
                        break;

                    case 'error':
                        console.error('âŒ ElevenLabs error:', message);
                        alert(`èªéŸ³è¾¨è­˜éŒ¯èª¤: ${message.message || message.error || 'æœªçŸ¥éŒ¯èª¤'}`);
                        break;

                    default:
                        console.log('â„¹ï¸ Unknown message type:', message.message_type);
                }
            } catch (error) {
                console.error('âŒ Failed to parse WebSocket message:', error);
            }
        }

        /**
         * Update UI with partial (in-progress) transcript
         */
        function updatePartialTranscriptUI(text) {
            // Check if partial transcript bubble already exists
            let partialBubble = document.getElementById('partial-transcript-bubble');

            if (!partialBubble) {
                // Create new partial transcript bubble
                const messageDiv = document.createElement('div');
                messageDiv.id = 'partial-transcript-container';
                messageDiv.className = `flex items-start gap-2 mb-3 fade-in ${currentSpeaker === 'client' ? 'flex-row-reverse' : ''}`;

                const avatarDiv = document.createElement('div');
                avatarDiv.className = `w-8 h-8 ${currentSpeaker === 'counselor' ? 'bg-blue-500' : 'bg-green-500'} rounded-full flex items-center justify-center flex-shrink-0 shadow-md opacity-60`;
                avatarDiv.innerHTML = `<span class="text-white text-sm">${currentSpeaker === 'counselor' ? 'ğŸ‘¨â€âš•ï¸' : 'ğŸ§‘'}</span>`;

                const bubbleWrapper = document.createElement('div');
                bubbleWrapper.className = `flex-1 flex flex-col ${currentSpeaker === 'client' ? 'items-end' : 'items-start'}`;

                const bubble = document.createElement('div');
                bubble.id = 'partial-transcript-bubble';
                bubble.className = `chat-bubble ${currentSpeaker === 'counselor' ? 'bg-blue-100 rounded-2xl rounded-tl-none' : 'bg-green-100 rounded-2xl rounded-tr-none'} px-4 py-2 shadow-sm border-2 border-dashed ${currentSpeaker === 'counselor' ? 'border-blue-300' : 'border-green-300'} opacity-75`;
                bubble.innerHTML = `<p class="text-sm text-gray-700 leading-relaxed italic">${text}</p>`;

                bubbleWrapper.appendChild(bubble);
                messageDiv.appendChild(avatarDiv);
                messageDiv.appendChild(bubbleWrapper);

                transcript.appendChild(messageDiv);
            } else {
                // Update existing partial transcript
                partialBubble.querySelector('p').textContent = text;
            }

            // Auto-scroll to bottom
            transcript.scrollTop = transcript.scrollHeight;
        }

        /**
         * Clear partial transcript UI when committed
         */
        function clearPartialTranscriptUI() {
            const partialContainer = document.getElementById('partial-transcript-container');
            if (partialContainer) {
                partialContainer.remove();
            }
        }

        /**
         * Reset inactivity timer when user is active
         */
        function resetInactivityTimer() {
            lastActivityTime = Date.now();
            console.log('â° Inactivity timer reset');
        }

        /**
         * Start monitoring for inactivity (check every 10 seconds)
         */
        function startInactivityMonitoring() {
            console.log('ğŸ” Starting inactivity monitoring');
            inactivityCheckInterval = setInterval(() => {
                const inactiveTime = Date.now() - lastActivityTime;
                const inactiveSeconds = Math.floor(inactiveTime / 1000);

                // Check if inactive for more than 60 seconds
                if (inactiveTime > 60000 && !document.getElementById('inactivityModal')) {
                    console.warn(`âš ï¸ User inactive for ${inactiveSeconds} seconds, showing warning`);
                    showInactivityWarning();
                }
            }, 10000); // Check every 10 seconds
        }

        /**
         * Stop inactivity monitoring and cleanup
         */
        function stopInactivityMonitoring() {
            console.log('ğŸ›‘ Stopping inactivity monitoring');
            if (inactivityCheckInterval) {
                clearInterval(inactivityCheckInterval);
                inactivityCheckInterval = null;
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            // Remove modal if exists
            const modal = document.getElementById('inactivityModal');
            if (modal) {
                modal.remove();
            }
        }

        /**
         * Show inactivity warning modal with 10-second countdown
         */
        function showInactivityWarning() {
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'inactivityModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-8 max-w-md mx-4 text-center shadow-2xl">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800">é‚„åœ¨å—ï¼Ÿ</h2>
                        <p class="mb-4 text-gray-600">å·²ç¶“ 1 åˆ†é˜æ²’æœ‰å°è©±äº†ï¼Œæ˜¯å¦è¦ç¹¼çºŒï¼Ÿ</p>
                        <p class="text-red-500 font-bold mb-6 text-lg">
                            å°‡åœ¨ <span id="countdownSeconds" class="text-2xl">10</span> ç§’å¾Œè‡ªå‹•çµæŸ
                        </p>
                        <div class="flex gap-4">
                            <button onclick="continueSession()"
                                class="flex-1 bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors font-semibold">
                                ç¹¼çºŒå°è©±
                            </button>
                            <button onclick="endSessionFromModal()"
                                class="flex-1 bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition-colors font-semibold">
                                çµæŸå°è©±
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Start 10-second countdown
            let secondsLeft = 10;
            countdownInterval = setInterval(() => {
                secondsLeft--;
                const countdownEl = document.getElementById('countdownSeconds');
                if (countdownEl) {
                    countdownEl.textContent = secondsLeft;
                }

                // Auto-end if countdown reaches 0
                if (secondsLeft <= 0) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    console.log('â±ï¸ Countdown reached 0, auto-ending session');
                    endSessionFromModal();
                }
            }, 1000);
        }

        /**
         * User chose to continue session
         */
        function continueSession() {
            console.log('âœ… User chose to continue session');
            const modal = document.getElementById('inactivityModal');
            if (modal) {
                modal.remove();
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            resetInactivityTimer();
        }

        /**
         * User chose to end session or countdown expired
         */
        function endSessionFromModal() {
            console.log('ğŸ›‘ Ending session from inactivity modal');
            const modal = document.getElementById('inactivityModal');
            if (modal) {
                modal.remove();
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            stopSession();
        }

        /**
         * Stop real recording and cleanup resources
         */
        function stopRealRecording() {
            // Stop AudioContext
            if (audioContext) {
                audioContext.close();
                audioContext = null;
                console.log('â¹ï¸ AudioContext stopped');
            }

            // Stop audio stream
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
                audioStream = null;
                console.log('ğŸ¤ Microphone released');
            }

            // Close WebSocket
            if (elevenLabsWs && elevenLabsWs.readyState === WebSocket.OPEN) {
                elevenLabsWs.close();
                elevenLabsWs = null;
                console.log('ğŸ”Œ WebSocket closed');
            }

            // Clear partial transcript
            clearPartialTranscriptUI();
            partialTranscriptText = '';
        }

        /**
         * Convert Blob to Base64
         */
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // === Core Functions ===
        async function startSession() {
            isRecording = true;
            startTime = Date.now();
            transcriptSegments = [];
            analysisHistory = [];

            // REAL RECORDING MODE: Start ElevenLabs WebSocket + Microphone
            if (!isDemoMode) {
                try {
                    await startRealRecording();
                    console.log('ğŸ¤ Real recording started with ElevenLabs STT');
                } catch (error) {
                    console.error('âŒ Failed to start real recording:', error);
                    alert(`ç„¡æ³•å•Ÿå‹•éº¥å…‹é¢¨æˆ–é€£æ¥èªéŸ³è¾¨è­˜æœå‹™ï¼š${error.message}\n\nå°‡åˆ‡æ›åˆ° Demo æ¨¡å¼`);
                    isDemoMode = true; // Fallback to demo mode
                }
            }

            // DEMO MODE: Initialize audio simulation
            if (isDemoMode) {
                initializeAudioSimulation();

                // Auto-play audio if voice simulation is enabled
                if (isVoiceSimEnabled) {
                    playAudioSimulation();
                    console.log('ğŸµ è‡ªå‹•é–‹å§‹æ’­æ”¾éŸ³è¨Šï¼ˆæ¨¡æ“¬äººè²å·²å•Ÿç”¨ï¼‰');
                }
            }

            // UI Updates - Desktop
            startBtn.disabled = true;
            startBtn.classList.add('opacity-50', 'cursor-not-allowed');
            stopBtn.disabled = false;
            stopBtn.classList.remove('opacity-50', 'cursor-not-allowed');

            // UI Updates - Mobile
            startBtnMobile.disabled = true;
            startBtnMobile.classList.add('opacity-50', 'cursor-not-allowed');
            stopBtnMobile.disabled = false;
            stopBtnMobile.classList.remove('opacity-50', 'cursor-not-allowed');

            // Analysis buttons
            triggerAnalysisBtn.disabled = false;
            triggerAnalysisBtn.classList.remove('opacity-50', 'cursor-not-allowed');

            // Show/hide indicators
            liveIndicator.classList.remove('hidden');
            transcriptEmpty.style.display = 'none';

            // REQUIREMENT 1: Enable bottom analyze button (remove disabled state)
            fabAnalyze.disabled = false;
            fabAnalyze.classList.remove('opacity-50', 'cursor-not-allowed');
            fabAnalyze.classList.add('hover:shadow-xl');

            // REQUIREMENT 3: Hide instruction card when recording starts
            if (instructionCard) {
                instructionCard.style.display = 'none';
            }

            // Header is now hidden on mobile via CSS (hidden md:block)
            // No need for JavaScript header manipulation on mobile

            // Show waveform and recording timer
            waveformContainer.classList.add('active');
            recordingTimerDisplay.style.display = 'block';
            recordingTimerDisplayMobile.style.display = 'block';

            // Start waveform animations
            updateWaveformAnimations();

            // Auto-expand transcript section when recording starts
            const transcriptSection = document.getElementById('transcriptSection');
            const transcriptToggle = document.getElementById('transcriptToggle');
            if (transcriptSection.classList.contains('hidden')) {
                transcriptSection.classList.remove('hidden');
                transcriptToggle.textContent = 'â–²';
                transcriptToggle.style.transform = 'rotate(180deg)';
            }

            status.textContent = 'ğŸ”´ éŒ„éŸ³ä¸­';
            status.classList.add('pulse-recording');
            transcript.innerHTML = '';
            analysisCards.innerHTML = '';
            if (analysisEmpty) analysisEmpty.style.display = 'none';

            // Start Timer
            timerInterval = setInterval(updateTimer, 1000);

            // Show next analysis countdown
            updateNextAnalysisCountdown();
        }

        function stopSession() {
            isRecording = false;

            // Stop inactivity monitoring
            stopInactivityMonitoring();

            // Stop real recording if active
            if (!isDemoMode) {
                stopRealRecording();
            }

            // Final analysis
            analyzeTranscript();

            // Stop audio playback and speech (demo mode)
            if (audioSimulation.isPlaying) {
                pauseAudioSimulation();
            }
            stopSpeech();

            // Hide audio player
            if (audioPlayerSection) {
                audioPlayerSection.style.display = 'none';
            }

            // Cleanup
            clearInterval(timerInterval);
            clearInterval(analysisInterval);
            lastAutoAnalysisTime = 0; // Reset auto-analysis tracker

            // UI Updates - Desktop
            startBtn.disabled = false;
            startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            stopBtn.disabled = true;
            stopBtn.classList.add('opacity-50', 'cursor-not-allowed');

            // UI Updates - Mobile
            startBtnMobile.disabled = false;
            startBtnMobile.classList.remove('opacity-50', 'cursor-not-allowed');
            stopBtnMobile.disabled = true;
            stopBtnMobile.classList.add('opacity-50', 'cursor-not-allowed');

            // Hide indicators
            liveIndicator.classList.add('hidden');

            // REQUIREMENT 1: Disable bottom analyze button again
            fabAnalyze.disabled = true;
            fabAnalyze.classList.add('opacity-50', 'cursor-not-allowed');
            fabAnalyze.classList.remove('hover:shadow-xl');

            // REQUIREMENT 3: Show instruction card when recording stops
            if (instructionCard && mobileAnalysisCards.length === 0) {
                instructionCard.style.display = 'block';
            }

            // Header is now hidden on mobile via CSS (hidden md:block)
            // No need for JavaScript header manipulation on mobile

            // Hide waveform and recording timer
            waveformContainer.classList.remove('active');
            recordingTimerDisplay.style.display = 'none';
            recordingTimerDisplayMobile.style.display = 'none';

            // Stop waveform animations
            updateWaveformAnimations();

            status.textContent = 'â¹ï¸ å·²çµæŸ';
            status.classList.remove('pulse-recording');
            nextAnalysis.textContent = '-';

            // Save to localStorage
            saveToHistory();
        }

        function switchSpeaker(speaker) {
            currentSpeaker = speaker;

            if (speaker === 'counselor') {
                speakerCounselorBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300', 'shadow-sm');
                speakerCounselorBtn.classList.add('bg-gradient-to-br', 'from-blue-500', 'to-indigo-600', 'text-white', 'shadow-md', 'hover:shadow-lg');
                speakerClientBtn.classList.remove('bg-gradient-to-br', 'from-blue-500', 'to-indigo-600', 'text-white', 'shadow-md', 'hover:shadow-lg');
                speakerClientBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300', 'shadow-sm');
            } else {
                speakerClientBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300', 'shadow-sm');
                speakerClientBtn.classList.add('bg-gradient-to-br', 'from-blue-500', 'to-indigo-600', 'text-white', 'shadow-md', 'hover:shadow-lg');
                speakerCounselorBtn.classList.remove('bg-gradient-to-br', 'from-blue-500', 'to-indigo-600', 'text-white', 'shadow-md', 'hover:shadow-lg');
                speakerCounselorBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300', 'shadow-sm');
            }
        }

        function toggleRecordingMode() {
            // Prevent mode change during recording
            if (isRecording) {
                alert('è«‹å…ˆåœæ­¢éŒ„éŸ³å†åˆ‡æ›æ¨¡å¼');
                return;
            }

            // Toggle mode
            isDemoMode = !isDemoMode;

            // Update all toggle switches (mobile + desktop)
            const toggles = [modeToggle, modeToggleDesktop].filter(t => t);
            const labels = [
                { elem: modeToggleLabel, hintElem: modeHint },
                { elem: modeToggleLabelDesktop, hintElem: modeHintDesktop }
            ].filter(l => l.elem);

            toggles.forEach(toggleBtn => {
                const toggleCircle = toggleBtn.querySelector('span');

                if (!isDemoMode) {
                    // Real recording mode: green background, circle to right
                    toggleBtn.classList.remove('bg-gray-300');
                    toggleBtn.classList.add('bg-green-600');
                    toggleBtn.setAttribute('aria-checked', 'true');
                    toggleCircle.classList.remove('translate-x-1');
                    toggleCircle.classList.add('translate-x-6');
                } else {
                    // Demo mode: gray background, circle to left
                    toggleBtn.classList.remove('bg-green-600');
                    toggleBtn.classList.add('bg-gray-300');
                    toggleBtn.setAttribute('aria-checked', 'false');
                    toggleCircle.classList.remove('translate-x-6');
                    toggleCircle.classList.add('translate-x-1');
                }
            });

            // Update labels
            labels.forEach(({ elem, hintElem }) => {
                if (!isDemoMode) {
                    elem.textContent = 'çœŸå¯¦éŒ„éŸ³';
                    hintElem.textContent = 'é–‹å•Ÿ = çœŸå¯¦';
                } else {
                    elem.textContent = 'Demo æ¨¡å¼';
                    hintElem.textContent = 'é—œé–‰ = Demo';
                }
            });

            // Log mode change
            console.log(`ğŸ”„ Mode switched to: ${isDemoMode ? 'Demo' : 'Real Recording'}`);

            // Show notification
            const modeText = isDemoMode ? 'Demo æ¨¡å¼ï¼ˆæ¨¡æ“¬å°è©±ï¼‰' : 'çœŸå¯¦éŒ„éŸ³æ¨¡å¼ï¼ˆéœ€è¦éº¥å…‹é¢¨æ¬Šé™ï¼‰';
            showNotification(`å·²åˆ‡æ›åˆ° ${modeText}`, isDemoMode ? 'info' : 'success');
        }

        function showNotification(message, type = 'info') {
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-4 ${bgColor} text-white px-6 py-3 rounded-xl shadow-lg z-50 fade-in`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function toggleVoiceSimulation() {
            isVoiceSimEnabled = !isVoiceSimEnabled;

            // Update both mobile and desktop toggles
            const toggles = [voiceSimToggle, voiceSimToggleDesktop].filter(t => t);

            toggles.forEach(toggleBtn => {
                const toggleCircle = toggleBtn.querySelector('span');

                if (isVoiceSimEnabled) {
                    // Enabled state: indigo background, circle moved to right
                    toggleBtn.classList.remove('bg-gray-300');
                    toggleBtn.classList.add('bg-indigo-600');
                    toggleBtn.setAttribute('aria-checked', 'true');
                    toggleCircle.classList.remove('translate-x-1');
                    toggleCircle.classList.add('translate-x-6');
                } else {
                    // Disabled state: gray background, circle moved to left
                    toggleBtn.classList.remove('bg-indigo-600');
                    toggleBtn.classList.add('bg-gray-300');
                    toggleBtn.setAttribute('aria-checked', 'false');
                    toggleCircle.classList.remove('translate-x-6');
                    toggleCircle.classList.add('translate-x-1');
                }
            });

            if (isVoiceSimEnabled) {
                console.log('ğŸ­ Voice Simulation: ENABLED');

                // If recording, show audio player and start playback
                if (isRecording && audioPlayerSection) {
                    audioPlayerSection.style.display = 'block';
                    if (!audioSimulation.isPlaying) {
                        playAudioSimulation();
                        console.log('ğŸµ è‡ªå‹•é–‹å§‹æ’­æ”¾éŸ³è¨Šï¼ˆåˆ‡æ›è‡³æ¨¡æ“¬äººè²ï¼‰');
                    }
                }
            } else {
                console.log('ğŸ­ Voice Simulation: DISABLED');

                // If recording, hide audio player and stop playback
                if (isRecording) {
                    if (audioSimulation.isPlaying) {
                        pauseAudioSimulation();
                        console.log('â¸ï¸ åœæ­¢æ’­æ”¾éŸ³è¨Šï¼ˆåˆ‡æ›è‡³é—œé–‰æ¨¡æ“¬äººè²ï¼‰');
                    }
                    if (audioPlayerSection) {
                        audioPlayerSection.style.display = 'none';
                    }
                }
            }
        }

        function updateWaveformAnimations() {
            const containers = [waveformContainer, waveformContainerMobile];
            containers.forEach(container => {
                if (!container) return;
                const bars = container.querySelectorAll('.waveform-bar');
                bars.forEach(bar => {
                    // Animation enabled when recording
                    if (isRecording) {
                        bar.style.animationPlayState = 'running';
                    } else {
                        bar.style.animationPlayState = 'paused';
                    }
                });
            });
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            const timeString = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            // Update main timer
            timer.textContent = timeString;

            // Update recording timer displays
            if (recordingTimer) recordingTimer.textContent = timeString;
            if (recordingTimerMobile) recordingTimerMobile.textContent = timeString;

            // Auto-analysis every 60 seconds
            if (elapsed > 0 && elapsed % 60 === 0 && elapsed !== lastAutoAnalysisTime) {
                lastAutoAnalysisTime = elapsed;

                // Only trigger if we have transcript content
                if (transcriptSegments.length > 0) {
                    // Show auto-analysis notification
                    showAutoAnalysisNotification();

                    // Trigger analysis automatically
                    analyzeTranscript();
                }
            }
        }

        function updateNextAnalysisCountdown() {
            if (!isRecording) return;

            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const remaining = 60 - (elapsed % 60);
            nextAnalysis.textContent = `${remaining} ç§’`;

            setTimeout(() => updateNextAnalysisCountdown(), 1000);
        }

        // === Transcript Management ===
        function addTranscriptLine(speaker, text) {
            // Chat-style bubble
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex items-start gap-2 mb-3 fade-in ${speaker === 'client' ? 'flex-row-reverse' : ''}`;

            const avatarDiv = document.createElement('div');
            avatarDiv.className = `w-8 h-8 ${speaker === 'counselor' ? 'bg-blue-500' : 'bg-green-500'} rounded-full flex items-center justify-center flex-shrink-0 shadow-md`;
            avatarDiv.innerHTML = `<span class="text-white text-sm">${speaker === 'counselor' ? 'ğŸ‘¨â€âš•ï¸' : 'ğŸ§‘'}</span>`;

            const bubbleWrapper = document.createElement('div');
            bubbleWrapper.className = `flex-1 flex flex-col ${speaker === 'client' ? 'items-end' : 'items-start'}`;

            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${speaker === 'counselor' ? 'bg-blue-50 rounded-2xl rounded-tl-none' : 'bg-green-50 rounded-2xl rounded-tr-none'} px-4 py-2 shadow-sm`;
            bubble.innerHTML = `<p class="text-sm text-gray-800 leading-relaxed">${text}</p>`;

            const timestamp = document.createElement('span');
            timestamp.className = `text-xs text-gray-400 ${speaker === 'client' ? 'mr-2' : 'ml-2'} mt-1`;
            const now = new Date();
            timestamp.textContent = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });

            bubbleWrapper.appendChild(bubble);
            bubbleWrapper.appendChild(timestamp);

            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(bubbleWrapper);

            transcript.appendChild(messageDiv);
            transcript.scrollTop = transcript.scrollHeight;

            // Save to segments
            transcriptSegments.push({ speaker, text });
        }

        // === AI Analysis ===
        async function analyzeTranscript() {
            // Set loading state for both analyze buttons (do this first for user feedback)
            setAnalyzeButtonsLoading(true);

            if (transcriptSegments.length === 0) {
                // Restore button state and show error
                setAnalyzeButtonsLoading(false);
                alert('ç›®å‰æ²’æœ‰é€å­—ç¨¿å…§å®¹ï¼Œè«‹å…ˆé–‹å§‹éŒ„éŸ³');
                return;
            }

            try {
                // Build transcript text
                const transcriptText = transcriptSegments.map(s =>
                    `${s.speaker === 'counselor' ? 'è«®å•†å¸«' : 'æ¡ˆä¸»'}ï¼š${s.text}`
                ).join('\n');

                // Skip analysis if transcript is too short (less than 10 characters)
                if (!transcriptText || transcriptText.trim().length < 10) {
                    console.log('â­ï¸ Skipping analysis: transcript too short');
                    setAnalyzeButtonsLoading(false);
                    return;
                }

                // Calculate time range and capture recording timestamp
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                const timeRange = `${Math.max(0, minutes - 1)}:00-${minutes}:00`;
                const recordingTimestamp = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                // === ä½¿ç”¨å‡è³‡æ–™æ¨¡å¼ï¼ˆDemoï¼‰ ===
                const useMockData = false; // è¨­ç‚º false ä½¿ç”¨çœŸå¯¦ API

                if (useMockData) {
                    // æ™ºæ…§ç”Ÿæˆå‡è³‡æ–™
                    const mockAnalysis = generateMockAnalysis(transcriptText, timeRange, recordingTimestamp);
                    displayAnalysisCard(mockAnalysis);
                    return;
                }

                // === çœŸå¯¦ API å‘¼å«ï¼ˆéœ€è¦èªè­‰ï¼‰ ===
                const response = await fetch('/api/v1/realtime/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        transcript: transcriptText,
                        speakers: transcriptSegments,
                        time_range: timeRange,
                        recording_timestamp: recordingTimestamp
                    })
                });

                if (!response.ok) throw new Error('åˆ†æå¤±æ•—');

                const analysis = await response.json();
                // Add recording timestamp if not provided by API
                if (!analysis.recording_timestamp) {
                    analysis.recording_timestamp = recordingTimestamp;
                }
                displayAnalysisCard(analysis);

            } catch (error) {
                console.error('Analysis error:', error);

                // Don't show error to user for short transcripts or display mock data
                // Only log warning for meaningful errors
                if (error.message && !error.message.includes('too short')) {
                    console.warn('åˆ†ææš«æ™‚ç„¡æ³•åŸ·è¡Œï¼Œå°‡åœ¨ä¸‹æ¬¡å˜—è©¦');
                }

                // Fallback to mock data if we have valid transcript
                try {
                    const transcriptText = transcriptSegments.map(s =>
                        `${s.speaker === 'counselor' ? 'è«®å•†å¸«' : 'æ¡ˆä¸»'}ï¼š${s.text}`
                    ).join('\n');

                    if (transcriptText && transcriptText.trim().length >= 10) {
                        const elapsed = Math.floor((Date.now() - startTime) / 1000);
                        const minutes = Math.floor(elapsed / 60);
                        const seconds = elapsed % 60;
                        const timeRange = `${Math.max(0, minutes - 1)}:00-${minutes}:00`;
                        const recordingTimestamp = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                        const mockAnalysis = generateMockAnalysis(transcriptText, timeRange, recordingTimestamp);
                        displayAnalysisCard(mockAnalysis);
                    }
                } catch (fallbackError) {
                    console.error('Fallback mock data generation failed:', fallbackError);
                }
            } finally {
                // Always restore button states, even if error occurs
                setAnalyzeButtonsLoading(false);
            }
        }

        // Helper function to set loading state for analyze buttons
        function setAnalyzeButtonsLoading(isLoading) {
            const buttons = [
                { btn: fabAnalyze, icon: 'âš¡', text: 'å³æ™‚åˆ†æ' },
                { btn: triggerAnalysisBtn, icon: 'âš¡', text: 'ç«‹å³åˆ†æ' }
            ];

            buttons.forEach(({ btn, icon, text }) => {
                if (!btn) return;

                if (isLoading) {
                    // Set loading state
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    btn.classList.remove('hover:shadow-xl');

                    // Update button content with spinner
                    const isFab = btn.id === 'fabAnalyze';
                    if (isFab) {
                        btn.innerHTML = `
                            <span class="text-3xl spinner">âš™ï¸</span>
                            <span class="text-lg tracking-wide">åˆ†æä¸­...</span>
                        `;
                    } else {
                        btn.innerHTML = `
                            <span class="spinner">âš™ï¸</span>
                            <span class="hidden sm:inline">åˆ†æä¸­...</span>
                            <span class="sm:hidden">...</span>
                        `;
                    }
                } else {
                    // Restore normal state (only if recording is active)
                    if (isRecording) {
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        if (btn.id === 'fabAnalyze') {
                            btn.classList.add('hover:shadow-xl');
                        }
                    }

                    // Restore original button content
                    const isFab = btn.id === 'fabAnalyze';
                    if (isFab) {
                        btn.innerHTML = `
                            <span class="text-3xl">${icon}</span>
                            <span class="text-lg tracking-wide">${text}</span>
                        `;
                    } else {
                        btn.innerHTML = `
                            <span>${icon}</span>
                            <span class="hidden sm:inline">${text}</span>
                            <span class="sm:hidden">åˆ†æ</span>
                        `;
                    }
                }
            });
        }

        // === Mock Data Generator ===
        function generateMockAnalysis(transcriptText, timeRange, recordingTimestamp) {
            const lowerText = transcriptText.toLowerCase();

            // åµæ¸¬é—œéµè­°é¡Œ
            const hasSuicideRisk = /è‡ªæ®º|æƒ³æ­»|æ´»è‘—æ²’æ„ç¾©|ä¸æƒ³æ´»|çµæŸç”Ÿå‘½/.test(transcriptText);
            const hasAnxiety = /ç„¦æ…®|å£“åŠ›|ç·Šå¼µ|å®³æ€•|æ“”å¿ƒ/.test(transcriptText);
            const hasDepression = /æ†‚é¬±|æ²®å–ª|ç„¡åŠ›|ç–²ç´¯|å¤±çœ /.test(transcriptText);
            const hasWork = /å·¥ä½œ|ä¸»ç®¡|è€é—†|åŒäº‹|è·å ´/.test(transcriptText);
            const hasFamily = /å®¶äºº|çˆ¶æ¯|é…å¶|å°å­©|å®¶åº­/.test(transcriptText);
            const hasRelationship = /é—œä¿‚|æœ‹å‹|ä¼´ä¾¶|æ„Ÿæƒ…/.test(transcriptText);

            // ç”Ÿæˆæ‘˜è¦
            let summary = '';
            if (hasSuicideRisk) {
                summary = 'âš ï¸ æ¡ˆä¸»è¡¨é”è‡ªæ®ºæ„å¿µï¼Œè«®å•†å¸«æ­£åœ¨è©•ä¼°é¢¨éšªç¨‹åº¦ã€‚éœ€ç«‹å³é—œæ³¨æ¡ˆä¸»å®‰å…¨ã€‚';
            } else if (hasDepression && hasWork) {
                summary = 'æ¡ˆä¸»è¡¨é”å·¥ä½œç›¸é—œçš„æ†‚é¬±ç—‡ç‹€ï¼Œè«®å•†å¸«åŒç†æ¡ˆä¸»è™•å¢ƒï¼Œæ¢ç´¢å£“åŠ›ä¾†æºã€‚';
            } else if (hasAnxiety && hasFamily) {
                summary = 'æ¡ˆä¸»è«‡åŠå®¶åº­è­°é¡Œå¼•ç™¼çš„ç„¦æ…®æ„Ÿå—ï¼Œè«®å•†å¸«ä½¿ç”¨åæ˜ æŠ€å·§å»ºç«‹é—œä¿‚ã€‚';
            } else if (hasWork) {
                summary = 'æ¡ˆä¸»åˆ†äº«å·¥ä½œå›°æ“¾ï¼Œè«®å•†å¸«å¼•å°æ¡ˆä¸»æ¢ç´¢å…·é«”æƒ…å¢ƒèˆ‡æ„Ÿå—ã€‚';
            } else if (hasRelationship) {
                summary = 'æ¡ˆä¸»è«‡è«–äººéš›é—œä¿‚è­°é¡Œï¼Œè«®å•†å¸«å”åŠ©æ¡ˆä¸»è¦ºå¯Ÿäº’å‹•æ¨¡å¼ã€‚';
            } else {
                summary = 'è«®å•†å¸«èˆ‡æ¡ˆä¸»å»ºç«‹åˆæ­¥é—œä¿‚ï¼Œé–‹å§‹æ¢ç´¢æ¡ˆä¸»ç•¶å‰é—œæ³¨è­°é¡Œã€‚';
            }

            // ç”Ÿæˆè­¦ç¤º
            const alerts = [];
            if (hasSuicideRisk) {
                alerts.push('âš ï¸ é«˜é¢¨éšªï¼šæ¡ˆä¸»æåŠè‡ªæ®ºç›¸é—œå­—çœ¼ï¼Œéœ€ç«‹å³è©•ä¼°è‡ªæ®ºé¢¨éšªï¼ˆè¨ˆç•«ã€æ–¹æ³•ã€æ™‚é–“ï¼‰');
                alerts.push('âš ï¸ å®‰å…¨è©•ä¼°ï¼šè€ƒæ…®æ˜¯å¦éœ€è¦å±æ©Ÿè™•ç†ã€è¯çµ¡ç·Šæ€¥è¯çµ¡äººæˆ–è½‰ä»‹ç²¾ç¥ç§‘');
                alerts.push('âš ï¸ æŒçºŒè¿½è¹¤ï¼šæœ¬æ¬¡æœƒè«‡çµæŸå‰ç¢ºèªæ¡ˆä¸»å®‰å…¨ï¼Œå®‰æ’å¯†é›†è¿½è¹¤');
            } else if (hasDepression) {
                alerts.push('âš ï¸ æ³¨æ„æ¡ˆä¸»æƒ…ç·’ç‹€æ…‹ï¼Œè©•ä¼°æ†‚é¬±ç¨‹åº¦ï¼ˆæŒçºŒæ™‚é–“ã€åš´é‡åº¦ã€åŠŸèƒ½å½±éŸ¿ï¼‰');
                alerts.push('âš ï¸ å¦‚ç—‡ç‹€æŒçºŒå…©é€±ä»¥ä¸Šï¼Œå»ºè­°è©•ä¼°æ˜¯å¦éœ€è¦ç²¾ç¥ç§‘æœƒè¨º');
            } else if (hasAnxiety) {
                alerts.push('âš ï¸ æ¡ˆä¸»ç„¦æ…®ç¨‹åº¦è¼ƒé«˜ï¼Œæ³¨æ„ç”Ÿç†ç—‡ç‹€ï¼ˆå¿ƒè·³ã€å‘¼å¸ã€è‚Œè‚‰ç·Šç¹ƒï¼‰');
            }

            // ä¸€èˆ¬æé†’
            if (transcriptSegments.filter(s => s.speaker === 'counselor').length < transcriptSegments.length * 0.3) {
                alerts.push('ğŸ’¡ è«®å•†å¸«ç™¼è¨€æ¯”ä¾‹è¼ƒå°‘ï¼Œå¯é©åº¦å¼•å°å°è©±æ–¹å‘');
            }
            if (transcriptSegments.length > 10) {
                alerts.push('âœ… å°è©±æŒçºŒé€²è¡Œä¸­ï¼Œæ³¨æ„æ™‚é–“ç®¡ç†èˆ‡æœƒè«‡çµæ§‹');
            }

            // ç”Ÿæˆå»ºè­°
            const suggestions = [];
            if (hasSuicideRisk) {
                suggestions.push('ğŸ’¡ ç›´æ¥è©•ä¼°ï¼šã€Œç•¶ä½ èªªä¸æƒ³æ´»äº†ï¼Œæ˜¯å¦æ›¾æƒ³éè¦å¦‚ä½•çµæŸç”Ÿå‘½ï¼Ÿã€');
                suggestions.push('ğŸ’¡ è©•ä¼°ä¿è­·å› å­ï¼šã€Œæœ‰ä»€éº¼äº‹æƒ…æˆ–äººï¼Œè®“ä½ åˆ°ç¾åœ¨é‚„é¡˜æ„æ´»è‘—ï¼Ÿã€');
                suggestions.push('ğŸ’¡ å»ºç«‹å®‰å…¨è¨ˆç•«ï¼šèˆ‡æ¡ˆä¸»è¨è«–å±æ©Ÿæ™‚å¯ä»¥åšä»€éº¼ã€å¯ä»¥æ‰¾èª°');
            } else if (hasDepression && hasWork) {
                suggestions.push('ğŸ’¡ æ¢ç´¢å·¥ä½œå£“åŠ›æºï¼šã€Œå·¥ä½œä¸­å“ªäº›å…·é«”æƒ…æ³è®“ä½ æ„Ÿåˆ°ç‰¹åˆ¥æ²®å–ªï¼Ÿã€');
                suggestions.push('ğŸ’¡ è©•ä¼°åŠŸèƒ½å½±éŸ¿ï¼šã€Œé€™äº›æ„Ÿå—å¦‚ä½•å½±éŸ¿ä½ çš„æ—¥å¸¸ç”Ÿæ´»å’Œå·¥ä½œè¡¨ç¾ï¼Ÿã€');
                suggestions.push('ğŸ’¡ æ‰¾å‡ºå› æ‡‰è³‡æºï¼šã€Œéå»é‡åˆ°é¡ä¼¼å›°é›£æ™‚ï¼Œä½ æ˜¯æ€éº¼åº¦éçš„ï¼Ÿã€');
            } else if (hasAnxiety) {
                suggestions.push('ğŸ’¡ å¼•å°å…·é«”åŒ–ï¼šã€Œç•¶ç„¦æ…®å‡ºç¾æ™‚ï¼Œä½ çš„èº«é«”æœ‰ä»€éº¼æ„Ÿè¦ºï¼Ÿã€');
                suggestions.push('ğŸ’¡ æ•™å°æ”¾é¬†æŠ€å·§ï¼šè€ƒæ…®å¼•å…¥å‘¼å¸ç·´ç¿’æˆ–æ­£å¿µæŠ€å·§');
                suggestions.push('ğŸ’¡ æ¢ç´¢ç„¦æ…®è§¸ç™¼é»ï¼šã€Œä»€éº¼æƒ…æ³ä¸‹ç„¦æ…®æ„Ÿæœƒç‰¹åˆ¥å¼·çƒˆï¼Ÿã€');
            } else if (hasWork) {
                suggestions.push('ğŸ’¡ å…·é«”åŒ–æ¢ç´¢ï¼šã€Œå¯ä»¥èªªèªªæœ€è¿‘ä¸€æ¬¡å›°æ“¾çš„å…·é«”æƒ…æ³å—ï¼Ÿã€');
                suggestions.push('ğŸ’¡ æƒ…ç·’åæ˜ ï¼šã€Œè½èµ·ä¾†é€™è®“ä½ æ„Ÿåˆ°...ï¼ˆæŒ«æŠ˜/æ†¤æ€’/ç„¡åŠ›ï¼‰ã€');
                suggestions.push('ğŸ’¡ è©•ä¼°æ”¯æŒç³»çµ±ï¼šã€Œå·¥ä½œä¹‹å¤–ï¼Œä½ æœ‰å¯ä»¥è«‡å¿ƒçš„å°è±¡å—ï¼Ÿã€');
            } else {
                suggestions.push('ğŸ’¡ é–‹æ”¾å¼æå•ï¼šã€Œä»Šå¤©æœ€æƒ³è«‡çš„æ˜¯ä»€éº¼ï¼Ÿã€');
                suggestions.push('ğŸ’¡ å»ºç«‹é—œä¿‚ï¼šä½¿ç”¨åŒç†å¿ƒå›æ‡‰ï¼Œè®“æ¡ˆä¸»æ„Ÿåˆ°è¢«ç†è§£');
                suggestions.push('ğŸ’¡ æ¾„æ¸…ç›®æ¨™ï¼šã€Œä½ å¸Œæœ›é€éè«®å•†é”åˆ°ä»€éº¼ï¼Ÿã€');
            }

            return {
                summary: summary,
                alerts: alerts.slice(0, 3), // æœ€å¤š3å€‹è­¦ç¤º
                suggestions: suggestions.slice(0, 3), // æœ€å¤š3å€‹å»ºè­°
                time_range: timeRange,
                recording_timestamp: recordingTimestamp,
                timestamp: new Date().toISOString()
            };
        }

        function displayAnalysisCard(analysis) {
            // Clear placeholder/empty state
            if (analysisEmpty) analysisEmpty.style.display = 'none';

            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-md hover:shadow-lg transition-shadow p-4 md:p-5 border-l-4 border-purple-500 fade-in card-hover';

            // Determine severity for alerts
            const hasCritical = analysis.alerts.some(a => a.includes('ğŸ”´') || a.includes('é«˜é¢¨éšª'));
            const hasWarning = analysis.alerts.some(a => a.includes('âš ï¸'));

            card.innerHTML = `
                <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <span class="inline-block px-3 py-1 bg-purple-100 text-purple-700 text-xs font-semibold rounded-full">
                            ${analysis.time_range}
                        </span>
                        ${analysis.recording_timestamp ? `
                            <span class="inline-flex items-center gap-1 px-2 py-1 bg-teal-100 text-teal-700 rounded-full text-xs font-medium">
                                <span>â±</span>
                                <span>${analysis.recording_timestamp}</span>
                            </span>
                        ` : ''}
                    </div>
                    <span class="text-xs text-gray-400">${new Date(analysis.timestamp).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })}</span>
                </div>

                <!-- Summary Section -->
                <div class="mb-4">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-6 h-6 bg-blue-100 rounded flex items-center justify-center">
                            ğŸ“‹
                        </div>
                        <h3 class="font-bold text-sm md:text-base text-gray-800">æ‘˜è¦</h3>
                    </div>
                    <p class="text-sm text-gray-700 leading-relaxed pl-8">${analysis.summary}</p>
                </div>

                <!-- Alerts Section -->
                ${analysis.alerts.length > 0 ? `
                    <div class="mb-4">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-6 h-6 ${hasCritical ? 'bg-red-100' : 'bg-yellow-100'} rounded flex items-center justify-center">
                                ${hasCritical ? 'ğŸ”´' : 'âš ï¸'}
                            </div>
                            <h3 class="font-bold text-sm md:text-base text-gray-800">è­¦ç¤º</h3>
                        </div>
                        <div class="space-y-2 pl-8">
                            ${analysis.alerts.map(alert => {
                                const isCritical = alert.includes('ğŸ”´') || alert.includes('é«˜é¢¨éšª');
                                const isWarning = alert.includes('âš ï¸');
                                const bgColor = isCritical ? 'bg-red-50 border-red-200' : isWarning ? 'bg-yellow-50 border-yellow-200' : 'bg-blue-50 border-blue-200';
                                const textColor = isCritical ? 'text-red-700' : isWarning ? 'text-yellow-700' : 'text-blue-700';
                                const badgeClass = isCritical ? 'badge-critical' : isWarning ? 'badge-warning' : 'badge-info';
                                const severity = isCritical ? 'é«˜' : isWarning ? 'ä¸­' : 'ä½';

                                return `
                                    <div class="flex items-start gap-2 p-2 ${bgColor} rounded-lg border transition-smooth hover:shadow-sm">
                                        <span class="px-2 py-0.5 ${badgeClass} text-white text-xs rounded font-bold shadow-sm">${severity}</span>
                                        <p class="text-xs md:text-sm ${textColor} flex-1 leading-relaxed">${alert}</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- Suggestions Section -->
                ${analysis.suggestions.length > 0 ? `
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-6 h-6 bg-green-100 rounded flex items-center justify-center">
                                ğŸ’¡
                            </div>
                            <h3 class="font-bold text-sm md:text-base text-gray-800">å»ºè­°</h3>
                        </div>
                        <div class="space-y-2 pl-8">
                            ${analysis.suggestions.map(sug => `
                                <div class="p-2 bg-green-50 border border-green-200 rounded-lg hover:bg-green-100 transition-smooth cursor-pointer">
                                    <p class="text-xs md:text-sm text-green-700 leading-relaxed">${sug}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;

            // Desktop: Animate card entrance
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            analysisCards.insertBefore(card, analysisCards.firstChild);

            setTimeout(() => {
                card.style.transition = 'all 0.3s ease-out';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, 10);

            // REQUIREMENT 6: Mobile carousel implementation
            if (mobileCarouselTrack && window.innerWidth < 768) {
                // Hide instruction card when first analysis appears
                if (instructionCard && mobileAnalysisCards.length === 0) {
                    instructionCard.style.display = 'none';
                }

                // Show carousel container
                if (mobileCarousel) {
                    mobileCarousel.classList.remove('hidden');
                }

                // Create mobile card (full width and height for carousel)
                const mobileCard = document.createElement('div');
                mobileCard.className = 'flex-shrink-0 w-full h-full bg-white rounded-2xl shadow-md p-5 border-l-4 border-purple-500 overflow-y-auto';
                mobileCard.innerHTML = card.innerHTML;

                // Add to carousel track (append to maintain chronological order)
                // Index 0 = oldest (1/4), Index length-1 = newest (4/4)
                mobileCarouselTrack.appendChild(mobileCard);
                mobileAnalysisCards.push(analysis);

                // Jump to newest card (last index)
                currentCarouselIndex = mobileAnalysisCards.length - 1;
                updateCarousel();
            }

            // Save to history
            analysisHistory.push(analysis);
        }

        function showError(message) {
            const card = document.createElement('div');
            card.className = 'bg-red-50 rounded-lg p-4 border-l-4 border-red-500';
            card.innerHTML = `<p class="text-sm text-red-700">âŒ ${message}</p>`;
            analysisCards.insertBefore(card, analysisCards.firstChild);
        }

        // === Auto-Analysis Notification ===
        function showAutoAnalysisNotification() {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 right-4 bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-6 py-3 rounded-lg shadow-xl z-50 flex items-center gap-2 animate-slide-in-right';
            toast.innerHTML = `
                <span class="text-lg">âš¡</span>
                <span class="font-medium">è‡ªå‹•åˆ†æä¸­...</span>
            `;

            document.body.appendChild(toast);

            // Auto-remove after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                toast.style.transition = 'all 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // === Manual Analysis Triggers ===
        function manuallyTriggerAnalysis() {
            if (transcriptSegments.length === 0) {
                alert('è«‹å…ˆæŒ‰ T éµæ–°å¢å°è©±å…§å®¹');
                return;
            }
            analyzeTranscript();
        }

        function generateMultipleAnalyses() {
            // Clear existing cards and show loading
            analysisCards.innerHTML = '';
            if (analysisEmpty) analysisEmpty.style.display = 'none';

            // Clear mobile carousel
            if (mobileCarouselTrack) {
                mobileCarouselTrack.innerHTML = '';
                mobileAnalysisCards = [];
                currentCarouselIndex = 0;
                if (mobileCarousel) mobileCarousel.classList.add('hidden');
            }

            // Show loading skeleton
            for (let i = 0; i < 3; i++) {
                const skeleton = document.createElement('div');
                skeleton.className = 'bg-white rounded-xl p-5 border border-gray-200 animate-pulse';
                skeleton.innerHTML = `
                    <div class="flex justify-between mb-3">
                        <div class="h-6 bg-gray-200 rounded-full w-20"></div>
                        <div class="h-4 bg-gray-200 rounded w-12"></div>
                    </div>
                    <div class="space-y-2">
                        <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                        <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                    </div>
                `;
                analysisCards.appendChild(skeleton);
            }

            // Clear skeletons after 1 second
            setTimeout(() => {
                analysisCards.innerHTML = '';
            }, 1000);

            // Generate 5 progressive analyses (simulating 5 minutes of conversation)
            const mockProgressiveData = [
                {
                    timeRange: '0:00-1:00',
                    transcript: 'è«®å•†å¸«ï¼šä½ å¥½ï¼Œä»Šå¤©æƒ³èŠä»€éº¼å‘¢ï¼Ÿ\næ¡ˆä¸»ï¼šæˆ‘æœ€è¿‘å·¥ä½œå£“åŠ›å¾ˆå¤§...',
                    hasIssue: { anxiety: true }
                },
                {
                    timeRange: '1:00-2:00',
                    transcript: 'è«®å•†å¸«ï¼šè½èµ·ä¾†å£“åŠ›çœŸçš„å¾ˆå¤§ï¼Œèƒ½è·Ÿæˆ‘å¤šèªªä¸€äº›å—ï¼Ÿ\næ¡ˆä¸»ï¼šæˆ‘è¦ºå¾—ä¸ç®¡æ€éº¼åšï¼Œä¸»ç®¡éƒ½ä¸æ»¿æ„ã€‚\nè«®å•†å¸«ï¼šé€™è®“ä½ æ„Ÿåˆ°å¾ˆæŒ«æŠ˜ï¼Œæ˜¯å—ï¼Ÿ',
                    hasIssue: { anxiety: true, work: true }
                },
                {
                    timeRange: '2:00-3:00',
                    transcript: 'æ¡ˆä¸»ï¼šå°ï¼Œè€Œä¸”æˆ‘é–‹å§‹æ‡·ç–‘è‡ªå·±çš„èƒ½åŠ›...\nè«®å•†å¸«ï¼šç•¶ä½ èªªã€Œæ‡·ç–‘è‡ªå·±ã€ï¼Œå…·é«”æ˜¯æŒ‡ä»€éº¼å‘¢ï¼Ÿ\næ¡ˆä¸»ï¼šæˆ‘è¦ºå¾—è‡ªå·±ä»€éº¼éƒ½åšä¸å¥½ã€‚',
                    hasIssue: { anxiety: true, work: true, depression: true }
                },
                {
                    timeRange: '3:00-4:00',
                    transcript: 'æ¡ˆä¸»ï¼šæœ‰æ™‚å€™è¦ºå¾—æ´»è‘—å¥½åƒæ²’ä»€éº¼æ„ç¾©ã€‚\nè«®å•†å¸«ï¼šä½ å‰›æ‰èªªã€Œæ´»è‘—æ²’æ„ç¾©ã€ï¼Œé€™æ˜¯æœ€è¿‘æ‰æœ‰çš„æƒ³æ³•å—ï¼Ÿ\næ¡ˆä¸»ï¼šå—¯...æœ€è¿‘ç‰¹åˆ¥å¼·çƒˆã€‚',
                    hasIssue: { anxiety: true, work: true, depression: true, suicideRisk: true }
                },
                {
                    timeRange: '4:00-5:00',
                    transcript: 'è«®å•†å¸«ï¼šç•¶ä½ èªªã€Œæ´»è‘—æ²’æ„ç¾©ã€ï¼Œæœ‰æƒ³éè¦çµæŸç”Ÿå‘½å—ï¼Ÿ\næ¡ˆä¸»ï¼šæœ‰æƒ³é...ä½†æˆ‘ä¸ç¢ºå®šæœƒä¸æœƒçœŸçš„å»åšã€‚\nè«®å•†å¸«ï¼šæœ‰ä»€éº¼äº‹æƒ…æˆ–äººï¼Œè®“ä½ åˆ°ç¾åœ¨é‚„é¡˜æ„æ´»è‘—ï¼Ÿ',
                    hasIssue: { suicideRisk: true, assessment: true }
                }
            ];

            // Generate analyses for each segment with staggered animation
            mockProgressiveData.forEach((data, index) => {
                const mockAnalysis = generateProgressiveAnalysis(data, index + 1);
                setTimeout(() => {
                    displayAnalysisCard(mockAnalysis);
                }, 1000 + (index * 400)); // Start after skeleton clears, stagger by 400ms
            });
        }

        function generateProgressiveAnalysis(data, minute) {
            const { timeRange, transcript, hasIssue } = data;

            let summary = '';
            const alerts = [];
            const suggestions = [];

            // Progressive summary
            if (hasIssue.suicideRisk && hasIssue.assessment) {
                summary = 'âš ï¸ è«®å•†å¸«æ­£é€²è¡Œè‡ªæ®ºé¢¨éšªè©•ä¼°ï¼Œæ¡ˆä¸»è¡¨é”æœ‰è‡ªæ®ºæ„å¿µä½†å°šæœªæœ‰å…·é«”è¨ˆç•«ã€‚æ­£åœ¨æ¢ç´¢ä¿è­·å› å­ã€‚';
                alerts.push('ğŸ”´ ç«‹å³è¡Œå‹•ï¼šæ¡ˆä¸»ç¢ºèªæœ‰è‡ªæ®ºæ„å¿µï¼Œéœ€å®Œæ•´è©•ä¼°è¨ˆç•«ã€æ–¹æ³•ã€æ™‚é–“');
                alerts.push('âš ï¸ å®‰å…¨è¨ˆç•«ï¼šå»ºç«‹å±æ©Ÿè™•ç†è¯çµ¡äººã€ç§»é™¤å±éšªç‰©å“');
                alerts.push('âš ï¸ å¾ŒçºŒè¿½è¹¤ï¼šå®‰æ’å¯†é›†æœƒè«‡ï¼ˆæ¯é€±2-3æ¬¡ï¼‰ï¼Œè€ƒæ…®ç²¾ç¥ç§‘æœƒè¨º');
                suggestions.push('ğŸ’¡ ç¹¼çºŒè©•ä¼°ï¼šã€Œä½ æ˜¯å¦æœ‰æƒ³éå…·é«”çš„æ–¹æ³•ï¼Ÿã€ã€Œä»€éº¼æ™‚å€™é€™å€‹æƒ³æ³•æœ€å¼·çƒˆï¼Ÿã€');
                suggestions.push('ğŸ’¡ å¼·åŒ–ä¿è­·å› å­ï¼šæ·±å…¥æ¢ç´¢æ”¯æŒç³»çµ±ã€ç”Ÿæ´»ç›®æ¨™ã€é‡è¦é—œä¿‚');
                suggestions.push('ğŸ’¡ å»ºç«‹å®‰å…¨å¥‘ç´„ï¼šèˆ‡æ¡ˆä¸»å…±åŒåˆ¶å®šå±æ©Ÿæ™‚çš„å› æ‡‰è¨ˆç•«');
            } else if (hasIssue.suicideRisk) {
                summary = 'âš ï¸ æ¡ˆä¸»é¦–æ¬¡æåŠã€Œæ´»è‘—æ²’æ„ç¾©ã€ï¼Œè«®å•†å¸«è­¦è¦ºä¸¦é–‹å§‹è©•ä¼°è‡ªæ®ºé¢¨éšªç¨‹åº¦ã€‚';
                alerts.push('ğŸ”´ é«˜é¢¨éšªè­¦ç¤ºï¼šæ¡ˆä¸»æåŠã€Œæ´»è‘—æ²’æ„ç¾©ã€ï¼Œéœ€ç«‹å³è©•ä¼°è‡ªæ®ºæ„å¿µ');
                alerts.push('âš ï¸ ä¸‹ä¸€æ­¥ï¼šç›´æ¥è©¢å•æ˜¯å¦æœ‰è‡ªæ®ºæƒ³æ³•æˆ–è¨ˆç•«');
                suggestions.push('ğŸ’¡ ç›´æ¥è©•ä¼°ï¼šã€Œç•¶ä½ èªªæ´»è‘—æ²’æ„ç¾©ï¼Œæ˜¯å¦æ›¾æƒ³éè¦çµæŸç”Ÿå‘½ï¼Ÿã€');
                suggestions.push('ğŸ’¡ æ¾„æ¸…åš´é‡åº¦ï¼šã€Œé€™å€‹æƒ³æ³•æœ‰å¤šå¼·çƒˆï¼Ÿå¤šå¸¸å‡ºç¾ï¼Ÿã€');
            } else if (hasIssue.depression) {
                summary = `æ¡ˆä¸»è¡¨é”æ†‚é¬±ç—‡ç‹€ï¼ˆè‡ªæˆ‘æ‡·ç–‘ã€ç„¡åƒ¹å€¼æ„Ÿï¼‰ï¼Œè«®å•†å¸«æ¢ç´¢å…·é«”æ„Ÿå—èˆ‡æƒ³æ³•ã€‚`;
                alerts.push('âš ï¸ æ³¨æ„æ†‚é¬±æŒ‡æ¨™ï¼šè‡ªæˆ‘å¦å®šã€ç„¡åƒ¹å€¼æ„Ÿï¼Œéœ€è©•ä¼°æŒçºŒæ™‚é–“èˆ‡åš´é‡åº¦');
                alerts.push('ğŸ’¡ å»ºè­°è©•ä¼°ï¼šè©¢å•ç¡çœ ã€é£Ÿæ…¾ã€èˆˆè¶£ã€ç²¾åŠ›ç­‰å…¶ä»–æ†‚é¬±ç—‡ç‹€');
                suggestions.push('ğŸ’¡ æ¢ç´¢èªçŸ¥æ¨¡å¼ï¼šã€Œä»€éº¼è®“ä½ è¦ºå¾—è‡ªå·±ä»€éº¼éƒ½åšä¸å¥½ï¼Ÿã€');
                suggestions.push('ğŸ’¡ å°‹æ‰¾ä¾‹å¤–ï¼šã€Œæœ‰æ²’æœ‰åšå¾—é‚„ä¸éŒ¯çš„æ™‚å€™ï¼Ÿã€');
            } else if (hasIssue.work) {
                summary = `æ¡ˆä¸»è«‡è«–å·¥ä½œå£“åŠ›èˆ‡æŒ«æŠ˜æ„Ÿï¼Œè«®å•†å¸«ä½¿ç”¨åæ˜ æŠ€å·§å»ºç«‹åŒç†é€£çµã€‚`;
                alerts.push('âœ… è«®å•†å¸«ä½¿ç”¨åæ˜ æŠ€å·§é©ç•¶ï¼ˆã€Œé€™è®“ä½ æ„Ÿåˆ°å¾ˆæŒ«æŠ˜ã€ï¼‰');
                alerts.push('ğŸ’¡ å¯æ·±å…¥æ¢ç´¢ï¼šä¸»ç®¡çš„å…·é«”è¡Œç‚ºã€æ¡ˆä¸»çš„å› æ‡‰æ–¹å¼');
                suggestions.push('ğŸ’¡ å…·é«”åŒ–ï¼šã€Œä¸»ç®¡å“ªäº›è¡Œç‚ºè®“ä½ è¦ºå¾—ä¸è¢«æ»¿æ„ï¼Ÿã€');
                suggestions.push('ğŸ’¡ è©•ä¼°å½±éŸ¿ï¼šã€Œé€™ç¨®ç‹€æ³æŒçºŒå¤šä¹…äº†ï¼Ÿå°ä½ çš„å½±éŸ¿æœ‰å¤šå¤§ï¼Ÿã€');
            } else {
                summary = `æœƒè«‡é–‹å§‹ï¼Œè«®å•†å¸«å¼•å°æ¡ˆä¸»è«‡è«–è¿‘æ³ï¼Œæ¡ˆä¸»æåŠå·¥ä½œå£“åŠ›è­°é¡Œã€‚`;
                alerts.push('âœ… è‰¯å¥½çš„é–‹æ”¾å¼æå•');
                alerts.push('ğŸ’¡ å»ºè­°æ–¹å‘ï¼šæŒçºŒæ¢ç´¢å£“åŠ›ä¾†æºèˆ‡å½±éŸ¿');
                suggestions.push('ğŸ’¡ æ·±å…¥äº†è§£ï¼šã€Œå£“åŠ›å¤§çš„æ™‚å€™ï¼Œä½ æœƒæœ‰ä»€éº¼æ„Ÿè¦ºæˆ–åæ‡‰ï¼Ÿã€');
                suggestions.push('ğŸ’¡ è©•ä¼°å› æ‡‰ï¼šã€Œä½ å¹³å¸¸æ€éº¼è™•ç†é€™äº›å£“åŠ›ï¼Ÿã€');
            }

            // Generate recording timestamp for auto-analysis (at the end of each minute)
            const recordingMinutes = minute;
            const recordingSeconds = 0;
            const recordingTimestamp = `${String(recordingMinutes).padStart(2, '0')}:${String(recordingSeconds).padStart(2, '0')}`;

            return {
                summary: summary,
                alerts: alerts.slice(0, 3),
                suggestions: suggestions.slice(0, 3),
                time_range: timeRange,
                recording_timestamp: recordingTimestamp,
                timestamp: new Date(Date.now() + minute * 60000).toISOString()
            };
        }

        // === localStorage Management ===
        function saveToHistory() {
            const session = {
                timestamp: new Date().toISOString(),
                duration: timer.textContent,
                transcript: transcriptSegments,
                analyses: analysisHistory
            };

            const history = JSON.parse(localStorage.getItem('realtimeCounselingHistory') || '[]');
            history.unshift(session);

            // Keep last 10 sessions
            localStorage.setItem('realtimeCounselingHistory', JSON.stringify(history.slice(0, 10)));
        }

        function toggleHistory() {
            const section = document.getElementById('historySection');
            const toggle = document.getElementById('historyToggle');

            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                toggle.textContent = 'â–²';
                toggle.style.transform = 'rotate(180deg)';
                loadHistory();
            } else {
                section.classList.add('hidden');
                toggle.textContent = 'â–¼';
                toggle.style.transform = 'rotate(0deg)';
            }
        }

        function toggleTranscript() {
            const section = document.getElementById('transcriptSection');
            const toggle = document.getElementById('transcriptToggle');

            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                toggle.textContent = 'â–²';
                toggle.style.transform = 'rotate(180deg)';
            } else {
                section.classList.add('hidden');
                toggle.textContent = 'â–¼';
                toggle.style.transform = 'rotate(0deg)';
            }
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('realtimeCounselingHistory') || '[]');
            const list = document.getElementById('historyList');

            if (history.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-8">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <span class="text-3xl">ğŸ“‚</span>
                        </div>
                        <p class="text-gray-400 font-medium">å°šç„¡æ­·å²è¨˜éŒ„</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = history.map((session, index) => `
                <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-4 border border-gray-200 hover:shadow-md transition-smooth">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <span class="w-8 h-8 bg-indigo-500 text-white rounded-lg flex items-center justify-center text-sm font-bold">#${index + 1}</span>
                            <div>
                                <p class="font-bold text-gray-800 text-sm">${new Date(session.timestamp).toLocaleString('zh-TW', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                                <p class="text-xs text-gray-500">æœƒè«‡æ™‚é•·ï¼š${session.duration}</p>
                            </div>
                        </div>
                        <span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full font-bold">
                            ${session.analyses.length} æ¬¡åˆ†æ
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function clearHistory() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ­·å²è¨˜éŒ„å—ï¼Ÿ')) {
                localStorage.removeItem('realtimeCounselingHistory');
                loadHistory();
            }
        }

        // === REQUIREMENT 6: Carousel Navigation Functions ===
        function navigateCarousel(direction) {
            if (mobileAnalysisCards.length === 0) return;

            currentCarouselIndex += direction;

            // Wrap around
            if (currentCarouselIndex < 0) {
                currentCarouselIndex = mobileAnalysisCards.length - 1;
            } else if (currentCarouselIndex >= mobileAnalysisCards.length) {
                currentCarouselIndex = 0;
            }

            updateCarousel();
        }

        function updateCarousel() {
            if (!mobileCarouselTrack || mobileAnalysisCards.length === 0) return;

            // Update transform to show current card
            const offset = -currentCarouselIndex * 100;
            mobileCarouselTrack.style.transform = `translateX(${offset}%)`;

            // Update counter
            if (carouselCounter) {
                carouselCounter.textContent = `${currentCarouselIndex + 1} / ${mobileAnalysisCards.length}`;
            }

            // Update button states
            if (carouselPrev && carouselNext) {
                // Enable/disable buttons based on position
                if (mobileAnalysisCards.length <= 1) {
                    carouselPrev.disabled = true;
                    carouselNext.disabled = true;
                } else {
                    carouselPrev.disabled = false;
                    carouselNext.disabled = false;
                }
            }
        }

        // Add swipe gesture support for carousel
        if (mobileCarouselTrack) {
            let touchStartX = 0;
            let touchEndX = 0;

            mobileCarouselTrack.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            mobileCarouselTrack.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, { passive: true });

            function handleSwipe() {
                const swipeThreshold = 50; // minimum distance for swipe
                const diff = touchStartX - touchEndX;

                if (Math.abs(diff) < swipeThreshold) return;

                if (diff > 0) {
                    // Swipe left â†’ earlier time (lower index)
                    navigateCarousel(-1);
                } else {
                    // Swipe right â†’ later time (higher index)
                    navigateCarousel(1);
                }
            }
        }

        // === Demo Mode (Simulate transcript input) ===
        let demoScriptIndex = 0;
        const demoScripts = {
            // åŠ‡æœ¬ 1: å·¥ä½œå£“åŠ›èˆ‡ç„¦æ…®ï¼ˆå«è‡ªæ®ºé¢¨éšªè©•ä¼°ï¼‰- 30åˆ†é˜å®Œæ•´ç‰ˆ
            // æ¯å¥è©±éƒ½æœ‰æ™‚é–“æˆ³ï¼ˆç§’ï¼‰ï¼Œç”¨æ–¼åŒæ­¥éŸ³è¨Šæ’­æ”¾
            workStress: [
                // Phase 1: é–‹å ´èˆ‡å»ºç«‹é—œä¿‚ (0-5åˆ†é˜)
                { speaker: 'counselor', text: 'ä½ å¥½ï¼Œä»Šå¤©æƒ³èŠä»€éº¼å‘¢ï¼Ÿ', time: 2 },
                { speaker: 'client', text: 'æˆ‘æœ€è¿‘å·¥ä½œå£“åŠ›å¾ˆå¤§ï¼Œå¸¸å¸¸ç„¦æ…®åˆ°ç¡ä¸è‘—...', time: 6 },
                { speaker: 'counselor', text: 'è½èµ·ä¾†å£“åŠ›çœŸçš„å¾ˆå¤§ã€‚èƒ½è·Ÿæˆ‘å¤šèªªä¸€äº›ï¼Œä½ éƒ½å¹¾é»ç¡è¦ºï¼Ÿ', time: 12 },
                { speaker: 'client', text: 'æˆ‘å¸¸å¸¸èººåœ¨åºŠä¸Šç¿»ä¾†è¦†å»åˆ°å‡Œæ™¨å…©ã€ä¸‰é»ã€‚', time: 18 },
                { speaker: 'counselor', text: 'å¤±çœ å°ä½ çš„å½±éŸ¿ä¸€å®šå¾ˆå¤§ã€‚ä½ èººåœ¨åºŠä¸Šçš„æ™‚å€™ï¼Œè…¦è¢‹éƒ½åœ¨æƒ³ä»€éº¼ï¼Ÿ', time: 24 },
                { speaker: 'client', text: 'å°±æƒ³è‘—æ˜å¤©çš„å·¥ä½œï¼Œæƒ³è‘—æˆ‘åˆè¦é¢å°ä¸»ç®¡...', time: 31 },
                { speaker: 'counselor', text: 'ä¸»ç®¡æ˜¯ä½ å£“åŠ›çš„ä¸»è¦ä¾†æºå—ï¼Ÿ', time: 37 },
                { speaker: 'client', text: 'å°ï¼Œæˆ‘è¦ºå¾—ä¸ç®¡æ€éº¼åšï¼Œä»–éƒ½ä¸æ»¿æ„ã€‚', time: 41 },
                { speaker: 'counselor', text: 'é€™è®“ä½ æ„Ÿåˆ°å¾ˆæŒ«æŠ˜ï¼Œæ˜¯å—ï¼Ÿèƒ½èˆ‰å€‹æœ€è¿‘çš„ä¾‹å­å—ï¼Ÿ', time: 47 },
                { speaker: 'client', text: 'ä¸Šç¦®æ‹œæˆ‘ç†¬å¤œè¶•å‡ºä¾†çš„ä¼åŠƒæ¡ˆï¼Œä»–åªçœ‹äº†å…©åˆ†é˜å°±èªªè¦é‡åšã€‚', time: 54 },
                { speaker: 'counselor', text: 'ä½ é‚£æ™‚å€™çš„æ„Ÿå—æ˜¯ä»€éº¼ï¼Ÿ', time: 62 },
                { speaker: 'client', text: 'æˆ‘ç•¶ä¸‹çœŸçš„å¾ˆç”Ÿæ°£ï¼Œä½†åˆä¸æ•¢èªªä»€éº¼ï¼Œå°±åä¸‹ä¾†äº†ã€‚', time: 66 },
                { speaker: 'counselor', text: 'ç”Ÿæ°£ä½†åˆä¸èƒ½è¡¨é”ï¼Œé€™ç¨®æ„Ÿè¦ºä¸€å®šå¾ˆé›£å—ã€‚', time: 73 },
                { speaker: 'client', text: 'å°...æˆ‘å›åˆ°åº§ä½ä¸Šçœ¼æ·šå°±æ‰ä¸‹ä¾†äº†ï¼Œé‚„å¥½æ²’äººçœ‹åˆ°ã€‚', time: 79 },

                // Phase 2: æ¢ç´¢å·¥ä½œå£“åŠ›èˆ‡æƒ…ç·’ (5-12åˆ†é˜)
                { speaker: 'counselor', text: 'é€™ç¨®æƒ…æ³æŒçºŒå¤šä¹…äº†ï¼Ÿ', time: 86 },
                { speaker: 'client', text: 'å¤§æ¦‚åŠå¹´å§ï¼Œå¾ä»–èª¿ä¾†ç•¶æˆ‘å€‘ä¸»ç®¡ä¹‹å¾Œã€‚', time: 90 },
                { speaker: 'counselor', text: 'é€™åŠå¹´ä¾†ï¼Œä½ çš„å·¥ä½œå’Œç”Ÿæ´»æœ‰ä»€éº¼æ”¹è®Šå—ï¼Ÿ', time: 96 },
                { speaker: 'client', text: 'æˆ‘è®Šå¾—å¾ˆæ²’è‡ªä¿¡ï¼Œå¸¸å¸¸æ‡·ç–‘è‡ªå·±çš„èƒ½åŠ›...', time: 102 },
                { speaker: 'counselor', text: 'ç•¶ä½ èªªã€Œæ‡·ç–‘è‡ªå·±ã€ï¼Œå…·é«”æ˜¯æŒ‡ä»€éº¼å‘¢ï¼Ÿ', time: 108 },
                { speaker: 'client', text: 'æˆ‘è¦ºå¾—è‡ªå·±ä»€éº¼éƒ½åšä¸å¥½ï¼Œå¯èƒ½æ ¹æœ¬ä¸é©åˆé€™ä»½å·¥ä½œã€‚', time: 114 },
                { speaker: 'counselor', text: 'åœ¨é€™å€‹ä¸»ç®¡ä¾†ä¹‹å‰ï¼Œä½ å°è‡ªå·±çš„å·¥ä½œè¡¨ç¾æœ‰é€™æ¨£çš„æ„Ÿè¦ºå—ï¼Ÿ', time: 121 },
                { speaker: 'client', text: 'æ²’æœ‰...ä»¥å‰æˆ‘åšå¾—é‚„ä¸éŒ¯ï¼Œå‰ä¸€å€‹ä¸»ç®¡é‚„æ»¿è‚¯å®šæˆ‘çš„ã€‚', time: 128 },
                { speaker: 'counselor', text: 'æ‰€ä»¥é€™å€‹æ‡·ç–‘ï¼Œä¸»è¦æ˜¯æœ€è¿‘é€™åŠå¹´æ‰é–‹å§‹çš„ã€‚', time: 135 },
                { speaker: 'client', text: 'å°ï¼Œæˆ‘ç¾åœ¨é€£ç°¡å–®çš„äº‹æƒ…éƒ½æœƒå®³æ€•åšéŒ¯ã€‚', time: 141 },
                { speaker: 'counselor', text: 'é€™ç¨®å®³æ€•ï¼Œé™¤äº†åœ¨å·¥ä½œä¸Šï¼Œæœƒä¸æœƒå½±éŸ¿åˆ°ä½ çš„ç”Ÿæ´»å…¶ä»–éƒ¨åˆ†ï¼Ÿ', time: 147 },
                { speaker: 'client', text: 'æœƒ...æˆ‘ç¾åœ¨ä¸å¤ªæƒ³è·Ÿæœ‹å‹å‡ºå»ï¼Œä¹Ÿä¸æƒ³è·Ÿå®¶äººèŠå¤©ã€‚', time: 154 },
                { speaker: 'counselor', text: 'è½èµ·ä¾†ä½ æœ‰é»æŠŠè‡ªå·±å­¤ç«‹èµ·ä¾†äº†ã€‚', time: 161 },
                { speaker: 'client', text: 'æˆ‘åªæ˜¯è¦ºå¾—å¾ˆç´¯ï¼Œä¸æƒ³è®“åˆ¥äººçœ‹åˆ°æˆ‘é€™å€‹æ¨£å­ã€‚', time: 166 },
                { speaker: 'counselor', text: 'ä½ æ“”å¿ƒåˆ¥äººæ€éº¼çœ‹ä½ ï¼Ÿ', time: 172 },
                { speaker: 'client', text: 'æ€•ä»–å€‘è¦ºå¾—æˆ‘å¾ˆå¼±ï¼Œé€£å·¥ä½œéƒ½åšä¸å¥½ã€‚', time: 176 },
                { speaker: 'counselor', text: 'é™¤äº†ç–²ç´¯å’Œå®³æ€•ï¼Œä½ é‚„æœ‰å…¶ä»–èº«é«”çš„æ„Ÿè¦ºå—ï¼Ÿ', time: 182 },
                { speaker: 'client', text: 'æˆ‘å¸¸å¸¸èƒ¸æ‚¶ï¼Œæœ‰æ™‚å€™æœƒçªç„¶å–˜ä¸éæ°£ã€‚', time: 188 },
                { speaker: 'counselor', text: 'é€™è½èµ·ä¾†åƒæ˜¯ç„¦æ…®ç™¼ä½œã€‚ç™¼ä½œçš„æ™‚å€™ä½ æœƒæ€éº¼åšï¼Ÿ', time: 194 },
                { speaker: 'client', text: 'æˆ‘å°±...èº²åˆ°å»æ‰€æ·±å‘¼å¸ï¼Œç­‰å®ƒéå»ã€‚', time: 200 },
                { speaker: 'counselor', text: 'ä½ æœ‰è©¦éå…¶ä»–æ–¹æ³•å—ï¼Ÿæˆ–æ˜¯æœ‰è·Ÿèª°è«‡éé€™ä»¶äº‹ï¼Ÿ', time: 206 },
                { speaker: 'client', text: 'æ²’æœ‰...æˆ‘ä¸çŸ¥é“è¦è·Ÿèª°èªªã€‚', time: 212 },

                // Phase 3: æ†‚é¬±ç—‡ç‹€æµ®ç¾ (12-17åˆ†é˜)
                { speaker: 'counselor', text: 'é™¤äº†ç¡çœ å•é¡Œå’Œç„¦æ…®ï¼Œä½ çš„èƒƒå£æœ‰æ”¹è®Šå—ï¼Ÿ', time: 218 },
                { speaker: 'client', text: 'æˆ‘æœ€è¿‘éƒ½ä¸å¤ªæƒ³åƒæ±è¥¿ï¼Œé«”é‡æ‰äº†äº”ã€å…­å…¬æ–¤ã€‚', time: 224 },
                { speaker: 'counselor', text: 'é‚£ä½ å¹³å¸¸æœ‰æ²’æœ‰ä»€éº¼äº‹æƒ…æ˜¯è®“ä½ é–‹å¿ƒçš„ï¼Ÿ', time: 231 },
                { speaker: 'client', text: 'ä»¥å‰æˆ‘å¾ˆå–œæ­¡ç•«ç•«ï¼Œä½†ç¾åœ¨å®Œå…¨æä¸èµ·å‹ã€‚', time: 236 },
                { speaker: 'counselor', text: 'é€£åŸæœ¬å–œæ­¡çš„äº‹æƒ…éƒ½å¤±å»èˆˆè¶£äº†...é€™ç¨®æƒ…æ³æŒçºŒå¤šä¹…äº†ï¼Ÿ', time: 242 },
                { speaker: 'client', text: 'å¤§æ¦‚å…©ã€ä¸‰å€‹æœˆå§ï¼Œæˆ‘è¦ºå¾—åšä»€éº¼éƒ½æ²’æ„æ€ã€‚', time: 249 },
                { speaker: 'counselor', text: 'è½èµ·ä¾†ä½ ç¾åœ¨çš„ç‹€æ…‹çœŸçš„å¾ˆè¾›è‹¦ã€‚', time: 255 },
                { speaker: 'client', text: 'å—¯...', time: 260 },
                { speaker: 'counselor', text: 'ä½ æ—©ä¸Šèµ·åºŠçš„æ™‚å€™ï¼Œæœƒä¸æœƒç‰¹åˆ¥é›£ç†¬ï¼Ÿ', time: 263 },
                { speaker: 'client', text: 'æœƒï¼Œæˆ‘æ¯å¤©çœé–‹çœ¼ç›ç¬¬ä¸€å€‹æƒ³æ³•å°±æ˜¯ã€Œåˆè¦é¢å°æ–°çš„ä¸€å¤©ã€ã€‚', time: 269 },
                { speaker: 'counselor', text: 'é€™è½èµ·ä¾†åƒæ˜¯ä¸€ç¨®è² æ“”ã€‚', time: 276 },
                { speaker: 'client', text: 'å°ï¼Œæˆ‘è¦ºå¾—æ´»è‘—å¥½åƒåªæ˜¯åœ¨æ‡‰ä»˜ï¼Œæ²’ä»€éº¼æ„ç¾©ã€‚', time: 280 },

                // Phase 4: è‡ªæ®ºæ„å¿µè©•ä¼° (17-22åˆ†é˜) - CRITICAL SECTION
                { speaker: 'counselor', text: 'ä½ å‰›æ‰èªªã€Œæ´»è‘—æ²’æ„ç¾©ã€ï¼Œé€™æ˜¯æœ€è¿‘æ‰æœ‰çš„æƒ³æ³•å—ï¼Ÿ', time: 287 },
                { speaker: 'client', text: 'å—¯...æœ€è¿‘ç‰¹åˆ¥å¼·çƒˆã€‚', time: 293 },
                { speaker: 'counselor', text: 'æˆ‘æƒ³ç›´æ¥å•ä½ ï¼Œç•¶ä½ èªªæ´»è‘—æ²’æ„ç¾©ï¼Œä½ æœ‰æ²’æœ‰æƒ³éè¦çµæŸç”Ÿå‘½ï¼Ÿ', time: 297 },
                { speaker: 'client', text: '...', time: 305 },
                { speaker: 'counselor', text: 'æˆ‘çŸ¥é“é€™å€‹å•é¡Œå¾ˆç›´æ¥ï¼Œä½†é€™å°æˆ‘äº†è§£ä½ çš„ç‹€æ³å¾ˆé‡è¦ã€‚', time: 308 },
                { speaker: 'client', text: 'æœ‰...æœ‰æƒ³éã€‚', time: 315 },
                { speaker: 'counselor', text: 'è¬è¬ä½ é¡˜æ„è·Ÿæˆ‘èªªã€‚ä½ èƒ½è·Ÿæˆ‘å¤šèªªä¸€é»å—ï¼Ÿé€™å€‹æƒ³æ³•å¤šå¸¸å‡ºç¾ï¼Ÿ', time: 319 },
                { speaker: 'client', text: 'æœ€è¿‘å¹¾ä¹æ¯å¤©éƒ½æœƒæƒ³åˆ°ã€‚', time: 326 },
                { speaker: 'counselor', text: 'ç•¶é€™å€‹æƒ³æ³•å‡ºç¾çš„æ™‚å€™ï¼Œå®ƒæœ‰å¤šå¼·çƒˆï¼Ÿå¾0åˆ°10ï¼Œ10æ˜¯éå¸¸å¼·çƒˆã€‚', time: 331 },
                { speaker: 'client', text: 'å¤§æ¦‚...7ã€8å§ã€‚', time: 339 },
                { speaker: 'counselor', text: 'é€™ç¢ºå¯¦æ˜¯å¾ˆå¼·çš„ç¨‹åº¦ã€‚ä½ æœ‰æƒ³éå…·é«”çš„æ–¹æ³•å—ï¼Ÿ', time: 343 },
                { speaker: 'client', text: 'æœ‰æƒ³é...ä½†æˆ‘ä¸ç¢ºå®šæœƒä¸æœƒçœŸçš„å»åšã€‚', time: 349 },
                { speaker: 'counselor', text: 'ä½ æƒ³éä»€éº¼æ–¹æ³•ï¼Ÿ', time: 355 },
                { speaker: 'client', text: 'å°±...åƒå®‰çœ è—¥ã€‚æˆ‘å®¶è£¡æœ‰ä¸€äº›ã€‚', time: 358 },
                { speaker: 'counselor', text: 'ä½ æœ‰æƒ³éä»€éº¼æ™‚å€™åšé€™ä»¶äº‹å—ï¼Ÿ', time: 364 },
                { speaker: 'client', text: 'æ²’æœ‰æ˜ç¢ºçš„æ™‚é–“ï¼Œä½†æœ‰æ™‚å€™çœŸçš„å¾ˆæƒ³å°±é€™æ¨£çµæŸã€‚', time: 369 },
                { speaker: 'counselor', text: 'é‚£æœ‰ä»€éº¼äº‹æƒ…æˆ–äººï¼Œè®“ä½ åˆ°ç¾åœ¨é‚„é¡˜æ„æ´»è‘—ï¼Ÿ', time: 376 },
                { speaker: 'client', text: 'æˆ‘åª½...å¥¹èº«é«”ä¸å¥½ï¼Œå¦‚æœæˆ‘å‡ºäº‹ï¼Œå¥¹ä¸€å®šå—ä¸äº†ã€‚', time: 382 },
                { speaker: 'counselor', text: 'ä½ åª½åª½å°ä½ ä¾†èªªå¾ˆé‡è¦ã€‚', time: 389 },
                { speaker: 'client', text: 'å°ï¼Œå¥¹æ˜¯æˆ‘å”¯ä¸€çš„ç‰½æ›ã€‚', time: 393 },

                // Phase 5: é¢¨éšªè©•ä¼°æ·±å…¥ (22-27åˆ†é˜)
                { speaker: 'counselor', text: 'é™¤äº†åª½åª½ï¼Œé‚„æœ‰å…¶ä»–è®“ä½ è¦ºå¾—å€¼å¾—æ´»ä¸‹å»çš„äº‹æƒ…å—ï¼Ÿ', time: 400 },
                { speaker: 'client', text: 'æˆ‘æƒ³ä¸åˆ°äº†...å¯èƒ½å°±åªæœ‰å¥¹ã€‚', time: 407 },
                { speaker: 'counselor', text: 'ç•¶ä½ æƒ³åˆ°è¦çµæŸç”Ÿå‘½çš„æ™‚å€™ï¼Œæœ‰æ²’æœ‰ä»€éº¼äº‹æƒ…å¯ä»¥è®“ä½ åœä¸‹ä¾†ï¼Ÿ' },
                { speaker: 'client', text: 'å°±æƒ³åˆ°æˆ‘åª½ï¼Œé‚„æœ‰...æˆ‘ä¹Ÿæœ‰é»å®³æ€•æ­»äº¡ã€‚' },
                { speaker: 'counselor', text: 'ä½ èªªçš„å®³æ€•æ˜¯ä»€éº¼æ¨£çš„å®³æ€•ï¼Ÿ' },
                { speaker: 'client', text: 'ä¸çŸ¥é“æ­»äº†ä¹‹å¾Œæœƒæ€æ¨£ï¼Œè€Œä¸”æˆ‘ä¹Ÿä¸æƒ³è®“å®¶äººå‚·å¿ƒã€‚' },
                { speaker: 'counselor', text: 'é€™äº›éƒ½æ˜¯å¾ˆé‡è¦çš„ä¿è­·å› å­ã€‚ä½ æœ‰è·Ÿä»»ä½•äººè«‡éé€™äº›æƒ³æ³•å—ï¼Ÿ' },
                { speaker: 'client', text: 'æ²’æœ‰...é€™æ˜¯æˆ‘ç¬¬ä¸€æ¬¡èªªå‡ºä¾†ã€‚' },
                { speaker: 'counselor', text: 'æˆ‘å¾ˆæ…¶å¹¸ä½ ä»Šå¤©é¡˜æ„ä¾†é€™è£¡ï¼Œä¹Ÿé¡˜æ„è·Ÿæˆ‘èªªé€™äº›ã€‚' },
                { speaker: 'client', text: 'å—¯...å…¶å¯¦æˆ‘ä¹Ÿä¸çŸ¥é“è©²æ€éº¼è¾¦äº†ã€‚' },
                { speaker: 'counselor', text: 'ä½ éå»æœ‰è©¦åœ–å‚·å®³è‡ªå·±æˆ–è‡ªæ®ºçš„ç¶“é©—å—ï¼Ÿ' },
                { speaker: 'client', text: 'æ²’æœ‰ï¼Œé€™æ˜¯ç¬¬ä¸€æ¬¡é€™éº¼åš´é‡ã€‚' },
                { speaker: 'counselor', text: 'é‚£ç¾åœ¨æ­¤åˆ»ï¼Œå¦‚æœå¾0åˆ°10ä¾†è©•ä¼°ï¼Œä½ è¦ºå¾—è‡ªå·±åœ¨æ¥ä¸‹ä¾†ä¸€é€±å…§æœƒçœŸçš„åŸ·è¡Œçš„å¯èƒ½æ€§æœ‰å¤šé«˜ï¼Ÿ' },
                { speaker: 'client', text: 'å¯èƒ½...3ã€4å§ã€‚æˆ‘ä¸ç¢ºå®šã€‚' },
                { speaker: 'counselor', text: 'æˆ‘è½åˆ°ä½ èªªä¸ç¢ºå®šï¼Œé€™ä»£è¡¨ä½ å…§å¿ƒé‚„åœ¨æ™æ‰ã€‚' },
                { speaker: 'client', text: 'å°ï¼Œæœ‰æ™‚å€™å¾ˆæƒ³çµæŸï¼Œä½†åˆè¦ºå¾—ä¸èƒ½é€™æ¨£åšã€‚' },

                // Phase 6: å®‰å…¨è¨ˆç•«èˆ‡è³‡æº (27-30åˆ†é˜)
                { speaker: 'counselor', text: 'æˆ‘æƒ³è·Ÿä½ ä¸€èµ·åˆ¶å®šä¸€å€‹å®‰å…¨è¨ˆç•«ï¼Œç•¶ä½ æœ‰å¼·çƒˆçš„è‡ªæ®ºå¿µé ­æ™‚å¯ä»¥æ€éº¼åšã€‚' },
                { speaker: 'client', text: 'å¥½...' },
                { speaker: 'counselor', text: 'é¦–å…ˆï¼Œç•¶é€™å€‹å¿µé ­å‡ºç¾æ™‚ï¼Œä½ å¯ä»¥åšä»€éº¼äº‹æƒ…ä¾†è½‰ç§»æ³¨æ„åŠ›ï¼Ÿ' },
                { speaker: 'client', text: 'æˆ‘å¯èƒ½...å»æ•£æ­¥ï¼Ÿæˆ–æ˜¯è½éŸ³æ¨‚ï¼Ÿ' },
                { speaker: 'counselor', text: 'é€™äº›éƒ½æ˜¯å¥½æ–¹æ³•ã€‚æ¥ä¸‹ä¾†ï¼Œä½ æœ‰å¯ä»¥æ‰“é›»è©±æ±‚åŠ©çš„äººå—ï¼Ÿ' },
                { speaker: 'client', text: 'æˆ‘æœ‰ä¸€å€‹å¤§å­¸åŒå­¸ï¼Œæˆ‘å€‘é—œä¿‚é‚„ä¸éŒ¯ã€‚' },
                { speaker: 'counselor', text: 'å¾ˆå¥½ã€‚å¦‚æœæƒ…æ³æ›´ç·Šæ€¥ï¼Œä½ çŸ¥é“å¯ä»¥æ‰“1925å®‰å¿ƒå°ˆç·šå—ï¼Ÿ' },
                { speaker: 'client', text: 'è½éï¼Œä½†æ²’æ‰“éã€‚' },
                { speaker: 'counselor', text: 'é€™æ˜¯24å°æ™‚çš„å¿ƒç†è«®è©¢å°ˆç·šï¼Œéš¨æ™‚éƒ½å¯ä»¥æ‰“ã€‚é‚„æœ‰ï¼Œé—œæ–¼å®¶è£¡çš„å®‰çœ è—¥...' },
                { speaker: 'client', text: 'å—¯ï¼Ÿ' },
                { speaker: 'counselor', text: 'ç‚ºäº†ä½ çš„å®‰å…¨ï¼Œæˆ‘å»ºè­°ä½ æŠŠå®ƒå€‘äº¤çµ¦ä¿¡ä»»çš„äººä¿ç®¡ï¼Œä½ è¦ºå¾—å¯ä»¥å—ï¼Ÿ' },
                { speaker: 'client', text: 'å¯ä»¥...æˆ‘å¯ä»¥çµ¦æˆ‘åª½ä¿ç®¡ã€‚' },
                { speaker: 'counselor', text: 'å¥½çš„ï¼Œé€™å¾ˆé‡è¦ã€‚æˆ‘ä¹Ÿå»ºè­°ä½ è€ƒæ…®å»èº«å¿ƒç§‘è©•ä¼°ï¼Œçœ‹æ˜¯å¦éœ€è¦è—¥ç‰©å”åŠ©ã€‚' },
                { speaker: 'client', text: 'ä½ è¦ºå¾—æˆ‘éœ€è¦åƒè—¥å—ï¼Ÿ' },
                { speaker: 'counselor', text: 'é€™éœ€è¦é†«ç”Ÿè©•ä¼°ï¼Œä½†å¾ä½ çš„ç—‡ç‹€ä¾†çœ‹ï¼Œè—¥ç‰©å¯èƒ½å¯ä»¥å¹«åŠ©ä½ ç©©å®šæƒ…ç·’å’Œç¡çœ ã€‚' },
                { speaker: 'client', text: 'å¥½...æˆ‘æœƒè€ƒæ…®çš„ã€‚' },
                { speaker: 'counselor', text: 'æˆ‘å¸Œæœ›æˆ‘å€‘èƒ½å¯†é›†åœ°è¦‹é¢ï¼Œæ¯é€±è‡³å°‘å…©æ¬¡ï¼Œä½ è¦ºå¾—å¯ä»¥å—ï¼Ÿ' },
                { speaker: 'client', text: 'å¯ä»¥ï¼Œæˆ‘éœ€è¦æœ‰äººå¹«æˆ‘ã€‚' },
                { speaker: 'counselor', text: 'æˆ‘æœƒé™ªè‘—ä½ åº¦éé€™æ®µæ™‚é–“ã€‚åœ¨ä¸‹æ¬¡è¦‹é¢ä¹‹å‰ï¼Œå¦‚æœä½ æœ‰å¼·çƒˆçš„è‡ªæ®ºå¿µé ­ï¼Œè«‹ä¸€å®šè¦æ‰“1925æˆ–è¯çµ¡æˆ‘ã€‚' },
                { speaker: 'client', text: 'å¥½ï¼Œè¬è¬ä½ ã€‚' },
                { speaker: 'counselor', text: 'ä¸å®¢æ°£ã€‚æˆ‘å€‘ç´„ä¸‹é€±äºŒåŒä¸€æ™‚é–“ï¼Œä½ è¦ºå¾—å¯ä»¥å—ï¼Ÿ' },
                { speaker: 'client', text: 'å¯ä»¥ã€‚' },
                { speaker: 'counselor', text: 'é‚£ä»Šå¤©å°±åˆ°é€™è£¡ã€‚è¨˜å¾—ï¼Œä½ ä¸æ˜¯ä¸€å€‹äººï¼Œæˆ‘å€‘æœƒä¸€èµ·é¢å°é€™å€‹å›°é›£ã€‚' },
                { speaker: 'client', text: 'è¬è¬...' }
            ],

            // åŠ‡æœ¬ 2: ä¸€èˆ¬è«®è©¢ï¼ˆé—œä¿‚ã€å®¶åº­ã€ç”Ÿæ¶¯æ¢ç´¢ï¼‰- 30åˆ†é˜å®Œæ•´ç‰ˆ
            general: [
                // Phase 1: é–‹å ´èˆ‡è¿‘æ³ (0-5åˆ†é˜)
                { speaker: 'counselor', text: 'ä»Šå¤©éå¾—å¦‚ä½•ï¼Ÿ' },
                { speaker: 'client', text: 'é‚„å¥½ï¼Œå°±æ˜¯æœ‰é»ç´¯ã€‚' },
                { speaker: 'counselor', text: 'ä»€éº¼è®“ä½ æ„Ÿåˆ°ç´¯å‘¢ï¼Ÿ' },
                { speaker: 'client', text: 'å·¥ä½œçš„äº‹æƒ…ï¼Œé‚„æœ‰å®¶è£¡çš„äº‹ã€‚' },
                { speaker: 'counselor', text: 'èƒ½å…·é«”èªªèªªæ˜¯ä»€éº¼äº‹å—ï¼Ÿæˆ‘å€‘å…ˆå¾å“ªä¸€å€‹é–‹å§‹èŠï¼Ÿ' },
                { speaker: 'client', text: 'å…ˆèªªå·¥ä½œå¥½äº†ï¼Œä¸»ç®¡æœ€è¿‘ä¸€ç›´ç›¯æˆ‘ï¼Œè®“æˆ‘å£“åŠ›å¾ˆå¤§ã€‚' },
                { speaker: 'counselor', text: 'ä¸»ç®¡ç›¯è‘—ä½ çš„æ„Ÿè¦ºï¼Œèƒ½æè¿°ä¸€ä¸‹å—ï¼Ÿ' },
                { speaker: 'client', text: 'å°±æ˜¯è¦ºå¾—è¢«ç›£è¦–ï¼Œä»€éº¼éƒ½è¦å ±å‘Šï¼Œè®“æˆ‘å¾ˆä¸èˆ’æœã€‚' },
                { speaker: 'counselor', text: 'è½èµ·ä¾†é€™è®“ä½ è¦ºå¾—ä¸è¢«ä¿¡ä»»ã€‚' },
                { speaker: 'client', text: 'å°ï¼Œæ˜æ˜æˆ‘å·¥ä½œéƒ½æœ‰åšå¥½ï¼Œä½†ä»–é‚„æ˜¯ä¸€ç›´å•æ±å•è¥¿ã€‚' },
                { speaker: 'counselor', text: 'é€™ç¨®ç‹€æ³æŒçºŒå¤šä¹…äº†ï¼Ÿ' },
                { speaker: 'client', text: 'å¤§æ¦‚ä¸€å€‹æœˆå§ï¼Œå¾ä¸Šæ¬¡å°ˆæ¡ˆå‡ºäº†é»å°å•é¡Œä¹‹å¾Œã€‚' },
                { speaker: 'counselor', text: 'é‚£æ¬¡çš„å°å•é¡Œï¼Œå°ä½ å½±éŸ¿å¾ˆå¤§å—ï¼Ÿ' },
                { speaker: 'client', text: 'å…¶å¯¦é‚„å¥½ï¼Œä½†ä¸»ç®¡å¥½åƒå¾é‚£ä¹‹å¾Œå°±é–‹å§‹ç‰¹åˆ¥æ³¨æ„æˆ‘ã€‚' },

                // Phase 2: å·¥ä½œå£“åŠ›èˆ‡å› æ‡‰ (5-10åˆ†é˜)
                { speaker: 'counselor', text: 'ä½ æœ‰è©¦è‘—è·Ÿä¸»ç®¡æºé€šéå—ï¼Ÿ' },
                { speaker: 'client', text: 'æ²’æœ‰...æˆ‘ä¸å¤ªæ•¢ï¼Œæ€•ä»–è¦ºå¾—æˆ‘åœ¨æŠ±æ€¨ã€‚' },
                { speaker: 'counselor', text: 'ä½ æ“”å¿ƒè¡¨é”è‡ªå·±çš„æ„Ÿå—æœƒå¸¶ä¾†è² é¢å¾Œæœã€‚' },
                { speaker: 'client', text: 'å°ï¼Œè€Œä¸”æˆ‘ä¹Ÿä¸çŸ¥é“è©²æ€éº¼èªªã€‚' },
                { speaker: 'counselor', text: 'å¦‚æœæœ‰æ©Ÿæœƒè·Ÿä»–èªªï¼Œä½ æœ€æƒ³è®“ä»–çŸ¥é“ä»€éº¼ï¼Ÿ' },
                { speaker: 'client', text: 'æˆ‘å¸Œæœ›ä»–çŸ¥é“æˆ‘æ˜¯æœ‰èƒ½åŠ›çš„ï¼Œä¸éœ€è¦ä¸€ç›´è¢«ç›£ç£ã€‚' },
                { speaker: 'counselor', text: 'é€™æ˜¯å¾ˆåˆç†çš„éœ€æ±‚ã€‚ä½ è¦ºå¾—ä»€éº¼é˜»ç¤™äº†ä½ è¡¨é”é€™å€‹éœ€æ±‚ï¼Ÿ' },
                { speaker: 'client', text: 'å¯èƒ½æ˜¯...æˆ‘ä¸æƒ³æƒ¹éº»ç…©ï¼Œä¹Ÿæ€•ç ´å£é—œä¿‚ã€‚' },
                { speaker: 'counselor', text: 'ä¿æŒå’Œå¹³å°ä½ ä¾†èªªå¾ˆé‡è¦ã€‚é€™ç¨®æ¨¡å¼åœ¨ä½ ç”Ÿæ´»çš„å…¶ä»–éƒ¨åˆ†ä¹Ÿæœƒå‡ºç¾å—ï¼Ÿ' },
                { speaker: 'client', text: 'æœƒ...æˆ‘è·Ÿå®¶äººä¹Ÿæ˜¯é€™æ¨£ã€‚' },
                { speaker: 'counselor', text: 'èƒ½å¤šèªªä¸€é»å—ï¼Ÿ' },
                { speaker: 'client', text: 'æˆ‘åª½å¸¸å¸¸å¿µæˆ‘è©²çµå©šäº†ï¼Œä½†æˆ‘ä¸æƒ³è½ï¼Œå°±éƒ½ä¸å›æ‡‰ã€‚' },

                // Phase 3: å®¶åº­é—œä¿‚æ¢ç´¢ (10-17åˆ†é˜)
                { speaker: 'counselor', text: 'ä½ ä¸æƒ³å›æ‡‰çš„åŸå› æ˜¯ä»€éº¼ï¼Ÿ' },
                { speaker: 'client', text: 'å› ç‚ºæˆ‘é‚„æ²’æº–å‚™å¥½ï¼Œä½†èªªäº†å¥¹ä¹Ÿä¸æœƒæ‡‚ã€‚' },
                { speaker: 'counselor', text: 'ä½ è¦ºå¾—åª½åª½ä¸ç†è§£ä½ çš„æƒ³æ³•ã€‚' },
                { speaker: 'client', text: 'å°ï¼Œå¥¹é‚£å€‹å¹´ä»£çš„äººï¼Œè¦ºå¾—åˆ°äº†å¹´ç´€å°±è©²çµå©šã€‚' },
                { speaker: 'counselor', text: 'é‚£ä½ è‡ªå·±å°å©šå§»çš„æƒ³æ³•æ˜¯ä»€éº¼ï¼Ÿ' },
                { speaker: 'client', text: 'æˆ‘è¦ºå¾—...å¦‚æœé‡åˆ°å°çš„äººç•¶ç„¶å¥½ï¼Œä½†ä¸æƒ³ç‚ºäº†çµå©šè€Œçµå©šã€‚' },
                { speaker: 'counselor', text: 'é€™æ˜¯å¾ˆæˆç†Ÿçš„æƒ³æ³•ã€‚ä½ è·Ÿåª½åª½çš„é—œä¿‚ï¼Œé™¤äº†é€™å€‹è©±é¡Œï¼Œå…¶ä»–æ–¹é¢å¦‚ä½•ï¼Ÿ' },
                { speaker: 'client', text: 'å…¶å¯¦é‚„ä¸éŒ¯ï¼Œå¥¹å°æˆ‘å¾ˆå¥½ï¼Œå°±æ˜¯æœ‰æ™‚å€™æœƒç¢å¿µã€‚' },
                { speaker: 'counselor', text: 'è½èµ·ä¾†ä½ å€‘é—œä¿‚çš„åŸºç¤æ˜¯å¥½çš„ï¼Œåªæ˜¯åœ¨æŸäº›è­°é¡Œä¸Šæœ‰ä¸åŒçœ‹æ³•ã€‚' },
                { speaker: 'client', text: 'å°ï¼Œä½†æ¯æ¬¡å¥¹ä¸€è¬›åˆ°çµå©šï¼Œæˆ‘å°±æœƒå¾ˆç…©èºã€‚' },
                { speaker: 'counselor', text: 'é€™å€‹ç…©èºèƒŒå¾Œï¼Œé™¤äº†ä¸æƒ³è¢«å‚¬å©šï¼Œé‚„æœ‰å…¶ä»–æ„Ÿå—å—ï¼Ÿ' },
                { speaker: 'client', text: 'å¯èƒ½æœ‰ä¸€é»...å£“åŠ›å§ï¼Œè¦ºå¾—å¥½åƒæˆ‘ä¸ç¬¦åˆæœŸå¾…ã€‚' },
                { speaker: 'counselor', text: 'ä½ åœ¨æ„åª½åª½æ€éº¼çœ‹ä½ ã€‚' },
                { speaker: 'client', text: 'å—¯...æˆ‘ä¸æƒ³è®“å¥¹å¤±æœ›ã€‚' },
                { speaker: 'counselor', text: 'é‚£å¦‚æœåª½åª½çŸ¥é“ä½ çš„æƒ³æ³•ï¼Œä½ è¦ºå¾—å¥¹æœƒå¤±æœ›å—ï¼Ÿ' },
                { speaker: 'client', text: 'å¯èƒ½æœƒå§...ä½†æˆ‘ä¹Ÿä¸ç¢ºå®šã€‚' },
                { speaker: 'counselor', text: 'æ‰€ä»¥ä½ é‚„æ²’æœ‰çœŸæ­£è©¦è‘—è®“å¥¹ç†è§£ä½ çš„æƒ³æ³•ã€‚' },
                { speaker: 'client', text: 'å°ï¼Œå› ç‚ºæˆ‘è¦ºå¾—èªªäº†ä¹Ÿæ²’ç”¨ã€‚' },
                { speaker: 'counselor', text: 'é€™è½èµ·ä¾†æœ‰é»åƒè‡ªæˆ‘è¨­é™ï¼Œåœ¨é‚„æ²’è©¦ä¹‹å‰å°±å‡è¨­çµæœäº†ã€‚' },
                { speaker: 'client', text: 'å—¯...ä½ é€™æ¨£èªªå¥½åƒæœ‰é“ç†ã€‚' },

                // Phase 4: äººéš›é—œä¿‚æ¨¡å¼ (17-22åˆ†é˜)
                { speaker: 'counselor', text: 'æˆ‘æ³¨æ„åˆ°ï¼Œä¸ç®¡æ˜¯ä¸»ç®¡é‚„æ˜¯åª½åª½ï¼Œä½ éƒ½å‚¾å‘ä¸è¡¨é”è‡ªå·±çš„æ„Ÿå—ã€‚' },
                { speaker: 'client', text: 'å¥½åƒæ˜¯...æˆ‘å¾å°å°±é€™æ¨£ã€‚' },
                { speaker: 'counselor', text: 'ä½ è¨˜å¾—æ˜¯å¾ä»€éº¼æ™‚å€™é–‹å§‹çš„å—ï¼Ÿ' },
                { speaker: 'client', text: 'å°æ™‚å€™æˆ‘çˆ¸è„¾æ°£å¾ˆä¸å¥½ï¼Œæˆ‘å­¸æœƒä¸è¦æƒ¹ä»–ç”Ÿæ°£ã€‚' },
                { speaker: 'counselor', text: 'æ‰€ä»¥ä½ å­¸æœƒäº†ä¿è­·è‡ªå·±çš„æ–¹å¼æ˜¯ä¸è¡¨é”ã€ä¸å¼•ç™¼è¡çªã€‚' },
                { speaker: 'client', text: 'å°...ä½†é€™æ¨£å¥½åƒä¹Ÿè®“æˆ‘å¾ˆç´¯ã€‚' },
                { speaker: 'counselor', text: 'å› ç‚ºä½ çš„éœ€æ±‚å’Œæ„Ÿå—æ²’æœ‰è¢«çœ‹è¦‹ã€‚' },
                { speaker: 'client', text: 'å—¯ï¼Œæœ‰æ™‚å€™æˆ‘ä¹Ÿä¸çŸ¥é“è‡ªå·±è¦ä»€éº¼äº†ã€‚' },
                { speaker: 'counselor', text: 'é€™æ˜¯é•·æœŸå£“æŠ‘çš„çµæœã€‚é‚£åœ¨æœ‹å‹é—œä¿‚ä¸­å‘¢ï¼Ÿä½ æœƒè¡¨é”è‡ªå·±å—ï¼Ÿ' },
                { speaker: 'client', text: 'è·Ÿæœ‹å‹æ¯”è¼ƒè‡ªåœ¨ä¸€é»ï¼Œä½†ä¹Ÿä¸æ˜¯å®Œå…¨æ”¾é¬†ã€‚' },
                { speaker: 'counselor', text: 'ä»€éº¼æ¨£çš„æƒ…æ³ä¸‹ä½ æœƒæ¯”è¼ƒæ”¾é¬†ï¼Ÿ' },
                { speaker: 'client', text: 'å¦‚æœå°æ–¹å…ˆåˆ†äº«ä»–çš„ç…©æƒ±ï¼Œæˆ‘å°±æœƒè¦ºå¾—æ¯”è¼ƒå®‰å…¨ã€‚' },
                { speaker: 'counselor', text: 'æ‰€ä»¥ä½ éœ€è¦å…ˆç¢ºèªé€™æ˜¯ä¸€å€‹å®‰å…¨çš„ç’°å¢ƒã€‚' },
                { speaker: 'client', text: 'å°ï¼Œæˆ‘æ€•è‡ªå·±èªªå¤ªå¤šæœƒé€ æˆåˆ¥äººçš„è² æ“”ã€‚' },
                { speaker: 'counselor', text: 'ä½ å¾ˆåœ¨æ„åˆ¥äººçš„æ„Ÿå—ï¼Œä½†ç›¸å°ä¾†èªªï¼Œæ¯”è¼ƒå¿½ç•¥è‡ªå·±çš„éœ€æ±‚ã€‚' },
                { speaker: 'client', text: 'å¥½åƒæ˜¯é€™æ¨£...æˆ‘è©²æ€éº¼æ”¹è®Šï¼Ÿ' },

                // Phase 5: è‡ªæˆ‘æ¢ç´¢èˆ‡åƒ¹å€¼è§€ (22-27åˆ†é˜)
                { speaker: 'counselor', text: 'æ”¹è®Šæ˜¯ä¸€å€‹éç¨‹ã€‚æˆ‘å€‘å¯ä»¥å…ˆå¾è¦ºå¯Ÿé–‹å§‹ï¼Œä½ é¡˜æ„è©¦è©¦çœ‹å—ï¼Ÿ' },
                { speaker: 'client', text: 'é¡˜æ„ï¼Œä½†è¦æ€éº¼åšï¼Ÿ' },
                { speaker: 'counselor', text: 'ä¸‹æ¬¡ç•¶ä½ åˆæƒ³å£“æŠ‘è‡ªå·±çš„æ„Ÿå—æ™‚ï¼Œå…ˆåœä¸‹ä¾†ï¼Œå•è‡ªå·±ï¼šæˆ‘ç¾åœ¨çœŸæ­£çš„æ„Ÿå—æ˜¯ä»€éº¼ï¼Ÿ' },
                { speaker: 'client', text: 'å¥½ï¼Œæˆ‘è©¦è©¦çœ‹ã€‚' },
                { speaker: 'counselor', text: 'é‚„æœ‰ï¼Œæˆ‘æƒ³å•ä½ ï¼Œåœ¨ä½ çš„ç”Ÿæ´»ä¸­ï¼Œä»€éº¼äº‹æƒ…æ˜¯çœŸæ­£é‡è¦çš„ï¼Ÿ' },
                { speaker: 'client', text: 'é‡è¦çš„...å®¶äººã€å·¥ä½œ...é‚„æœ‰è‡ªå·±çš„å¥åº·å§ã€‚' },
                { speaker: 'counselor', text: 'é€™äº›éƒ½å¾ˆé‡è¦ã€‚é‚£ä½ ç¾åœ¨çš„ç”Ÿæ´»ï¼Œæœ‰ç¬¦åˆé€™äº›åƒ¹å€¼å—ï¼Ÿ' },
                { speaker: 'client', text: 'å¥½åƒæ²’æœ‰...æˆ‘ç‚ºäº†å·¥ä½œçŠ§ç‰²å¥åº·ï¼Œç‚ºäº†å®¶äººå£“æŠ‘è‡ªå·±ã€‚' },
                { speaker: 'counselor', text: 'ä½ çœ‹åˆ°é€™å€‹å¤±è¡¡äº†ã€‚' },
                { speaker: 'client', text: 'å°ï¼Œä½†æˆ‘ä¸çŸ¥é“è¦æ€éº¼å¹³è¡¡ã€‚' },
                { speaker: 'counselor', text: 'å¦‚æœå¯ä»¥é‡æ–°å®‰æ’ï¼Œä½ å¸Œæœ›ä½ çš„ç”Ÿæ´»æ˜¯ä»€éº¼æ¨£å­ï¼Ÿ' },
                { speaker: 'client', text: 'æˆ‘å¸Œæœ›...å¯ä»¥åšè‡ªå·±å–œæ­¡çš„äº‹ï¼Œä¹Ÿèƒ½å¥½å¥½ç…§é¡§èº«é«”ã€‚' },
                { speaker: 'counselor', text: 'é‚£ä½ å–œæ­¡åšä»€éº¼äº‹ï¼Ÿ' },
                { speaker: 'client', text: 'æˆ‘å–œæ­¡ç™»å±±ï¼Œé‚„æœ‰æ”å½±ï¼Œä½†å·²ç¶“å¾ˆä¹…æ²’åšäº†ã€‚' },
                { speaker: 'counselor', text: 'æ˜¯ä»€éº¼é˜»æ­¢ä½ åšé€™äº›äº‹ï¼Ÿ' },
                { speaker: 'client', text: 'ç¸½è¦ºå¾—æ²’æ™‚é–“ï¼Œå·¥ä½œå¤ªå¿™äº†ã€‚' },
                { speaker: 'counselor', text: 'å¦‚æœæŠŠé€™äº›äº‹æƒ…ä¹Ÿæ’é€²ä½ çš„è¡Œç¨‹ï¼Œä½ è¦ºå¾—å¯è¡Œå—ï¼Ÿ' },
                { speaker: 'client', text: 'å¯èƒ½...é€±æœ«å¯ä»¥è©¦è©¦çœ‹ã€‚' },

                // Phase 6: ç›®æ¨™è¨­å®šèˆ‡ç¸½çµ (27-30åˆ†é˜)
                { speaker: 'counselor', text: 'é€™æ˜¯å€‹å¾ˆå¥½çš„é–‹å§‹ã€‚é‚£æˆ‘å€‘ä¾†è¨­å®šä¸€äº›å°ç›®æ¨™ï¼Œé€™é€±ä½ æƒ³è©¦è‘—åšä»€éº¼ï¼Ÿ' },
                { speaker: 'client', text: 'é€™é€±æœ«æˆ‘æƒ³å»çˆ¬å€‹å°å±±ï¼Œå¸¶è‘—ç›¸æ©Ÿã€‚' },
                { speaker: 'counselor', text: 'è½èµ·ä¾†æ˜¯å€‹å¾ˆæ£’çš„è¨ˆç•«ã€‚é‚£é—œæ–¼è·Ÿåª½åª½æºé€šçš„éƒ¨åˆ†å‘¢ï¼Ÿ' },
                { speaker: 'client', text: 'æˆ‘æƒ³...æ‰¾å€‹æ™‚é–“å¥½å¥½è·Ÿå¥¹èŠèŠæˆ‘çš„æƒ³æ³•ã€‚' },
                { speaker: 'counselor', text: 'å¾ˆå¥½ã€‚ä½ æƒ³æ€éº¼é–‹å§‹é€™å€‹å°è©±ï¼Ÿ' },
                { speaker: 'client', text: 'å¯èƒ½å¾è¬è¬å¥¹çš„é—œå¿ƒé–‹å§‹ï¼Œç„¶å¾Œèªªæˆ‘æœ‰è‡ªå·±çš„è¦åŠƒã€‚' },
                { speaker: 'counselor', text: 'é€™å€‹é–‹å ´å¾ˆæº«å’Œã€‚è¨˜å¾—ï¼Œè¡¨é”è‡ªå·±ä¸ä»£è¡¨è¡çªï¼Œè€Œæ˜¯è®“å°æ–¹æ›´äº†è§£ä½ ã€‚' },
                { speaker: 'client', text: 'å—¯ï¼Œæˆ‘æœƒè©¦è©¦çœ‹ã€‚' },
                { speaker: 'counselor', text: 'é‚£å·¥ä½œçš„éƒ¨åˆ†ï¼Œä½ è¦ºå¾—éœ€è¦è·Ÿä¸»ç®¡è«‡å—ï¼Ÿ' },
                { speaker: 'client', text: 'æˆ‘æƒ³å†è§€å¯Ÿçœ‹çœ‹ï¼Œå¦‚æœæƒ…æ³æ²’æ”¹å–„ï¼Œæˆ‘å†æ‰¾æ©Ÿæœƒè·Ÿä»–èªªã€‚' },
                { speaker: 'counselor', text: 'å¥½çš„ï¼Œé€™æ˜¯ä½ çš„æ±ºå®šã€‚æˆ‘å€‘ä¸‹æ¬¡è¦‹é¢æ™‚å¯ä»¥å†è¨è«–é€²å±•ã€‚' },
                { speaker: 'client', text: 'å¥½ã€‚' },
                { speaker: 'counselor', text: 'ä»Šå¤©æˆ‘å€‘èŠäº†å¾ˆå¤šï¼Œä½ å°å·¥ä½œã€å®¶åº­ã€é‚„æœ‰è‡ªå·±çš„éœ€æ±‚éƒ½æœ‰äº†æ›´å¤šè¦ºå¯Ÿã€‚' },
                { speaker: 'client', text: 'å°ï¼Œæˆ‘è¦ºå¾—é‡æ¸…äº†ä¸€äº›äº‹æƒ…ã€‚' },
                { speaker: 'counselor', text: 'é€™å¾ˆå¥½ã€‚è¨˜å¾—ï¼Œæ”¹è®Šéœ€è¦æ™‚é–“ï¼Œå°è‡ªå·±æœ‰è€å¿ƒä¸€é»ã€‚' },
                { speaker: 'client', text: 'æˆ‘æœƒçš„ï¼Œè¬è¬ä½ ã€‚' },
                { speaker: 'counselor', text: 'ä¸å®¢æ°£ã€‚æˆ‘å€‘ä¸‹é€±åŒä¸€æ™‚é–“è¦‹ï¼Œä½ è¦ºå¾—å¯ä»¥å—ï¼Ÿ' },
                { speaker: 'client', text: 'å¯ä»¥ï¼Œä¸‹é€±è¦‹ã€‚' },
                { speaker: 'counselor', text: 'å¥½çš„ï¼Œé‚£å°±ä¸‹é€±è¦‹ã€‚è¨˜å¾—ç…§é¡§å¥½è‡ªå·±ã€‚' },
                { speaker: 'client', text: 'å¥½ï¼Œä½ ä¹Ÿæ˜¯ã€‚' }
            ]
        };

        let currentScript = demoScripts.workStress; // é è¨­ä½¿ç”¨å·¥ä½œå£“åŠ›åŠ‡æœ¬

        function simulateTranscriptInput() {
            if (!isRecording) return;

            // å¾ªåºæ’­æ”¾åŠ‡æœ¬
            if (demoScriptIndex < currentScript.length) {
                const line = currentScript[demoScriptIndex];

                // è‡ªå‹•åˆ‡æ›èªªè©±è€…
                if (line.speaker !== currentSpeaker) {
                    switchSpeaker(line.speaker);
                }

                addTranscriptLine(line.speaker, line.text);
                demoScriptIndex++;
            } else {
                // åŠ‡æœ¬æ’­å®Œï¼Œé‡ç½®æˆ–æç¤º
                console.log('Demo åŠ‡æœ¬å·²æ’­æ”¾å®Œç•¢ï¼ŒæŒ‰ R éµé‡æ–°é–‹å§‹');
            }
        }

        // === Audio Simulation Functions ===
        function initializeAudioSimulation() {
            // Calculate total duration from script timestamps
            const lastLine = currentScript[currentScript.length - 1];
            audioSimulation.duration = lastLine.time || 400; // Default 400 seconds (~6.7 minutes)

            // Reset state
            audioSimulation.currentTime = 0;
            audioSimulation.lastDisplayedIndex = 0;
            audioSimulation.isPlaying = false;

            // Update UI - only show player if voice simulation is enabled
            if (audioPlayerSection) {
                audioPlayerSection.style.display = isVoiceSimEnabled ? 'block' : 'none';
                audioStatus.textContent = 'æº–å‚™å°±ç·’';
                audioDuration.textContent = formatTime(audioSimulation.duration);
                audioCurrentTime.textContent = '0:00';
                audioProgress.style.width = '0%';
            }

            console.log(`ğŸµ éŸ³è¨Šæ¨¡æ“¬å·²åˆå§‹åŒ–ï¼Œç¸½æ™‚é•·: ${formatTime(audioSimulation.duration)}`);
        }

        // === Web Speech API (TTS) Functions ===
        function initializeSpeechSynthesis() {
            if (!ttsState.isSupported) {
                console.warn('âš ï¸ æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Speech API (TTS)');
                return;
            }

            // Wait for voices to be loaded
            function loadVoices() {
                ttsState.voices = speechSynthesis.getVoices();
                selectVoices();
            }

            // Voices may load asynchronously
            speechSynthesis.onvoiceschanged = loadVoices;

            // Try loading immediately (some browsers have voices ready)
            loadVoices();

            console.log('ğŸ”Š Web Speech API (TTS) å·²åˆå§‹åŒ–');
        }

        function selectVoices() {
            if (ttsState.voices.length === 0) {
                console.warn('âš ï¸ å°šæœªè¼‰å…¥èªéŸ³åˆ—è¡¨');
                return;
            }

            // Try to find Traditional Chinese (zh-TW) voices
            const zhTWVoices = ttsState.voices.filter(v => v.lang.includes('zh-TW'));
            const zhVoices = ttsState.voices.filter(v => v.lang.includes('zh'));

            // Select counselor voice (prefer female voice for Traditional Chinese)
            ttsState.counselorVoice = zhTWVoices.find(v => v.name.includes('Female') || v.name.includes('å¥³')) ||
                                     zhTWVoices.find(v => v.name.includes('Meijia') || v.name.includes('ç¾ä½³')) ||
                                     zhVoices.find(v => v.name.includes('Female') || v.name.includes('å¥³')) ||
                                     zhTWVoices[0] ||
                                     zhVoices[0] ||
                                     ttsState.voices[0]; // Fallback to any voice

            // Select client voice (prefer male voice for Traditional Chinese)
            ttsState.clientVoice = zhTWVoices.find(v => v.name.includes('Male') || v.name.includes('ç”·')) ||
                                  zhTWVoices.find(v => v.name.includes('Zhiwei') || v.name.includes('å¿—å¨')) ||
                                  zhVoices.find(v => v.name.includes('Male') || v.name.includes('ç”·')) ||
                                  zhTWVoices[1] || // Try different voice from counselor
                                  zhVoices[1] ||
                                  ttsState.voices[1] || // Fallback to different voice
                                  ttsState.voices[0]; // Last resort

            console.log(`ğŸ™ï¸ è«®å•†å¸«èªéŸ³: ${ttsState.counselorVoice?.name || 'æœªé¸æ“‡'} (${ttsState.counselorVoice?.lang || 'N/A'})`);
            console.log(`ğŸ™ï¸ æ¡ˆä¸»èªéŸ³: ${ttsState.clientVoice?.name || 'æœªé¸æ“‡'} (${ttsState.clientVoice?.lang || 'N/A'})`);
            console.log(`ğŸ“‹ å¯ç”¨èªéŸ³æ•¸é‡: ${ttsState.voices.length}`);
        }

        function speakText(text, speaker) {
            if (!ttsState.isSupported) return;
            if (!isVoiceSimEnabled) return; // Only speak if voice simulation is enabled
            if (!audioSimulation.isPlaying) return; // Only speak if audio is playing

            // Cancel any ongoing speech
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-TW'; // Traditional Chinese

            // Select voice and adjust pitch based on speaker
            if (speaker === 'counselor') {
                utterance.voice = ttsState.counselorVoice;
                utterance.pitch = 1.1; // Slightly higher pitch for counselor
            } else {
                utterance.voice = ttsState.clientVoice;
                utterance.pitch = 0.9; // Slightly lower pitch for client
            }

            // Speech settings
            utterance.rate = 1.0; // Normal speed
            utterance.volume = 1.0; // Full volume

            // Error handling
            utterance.onerror = (event) => {
                console.error('ğŸ”‡ TTS éŒ¯èª¤:', event.error);
            };

            // Store reference and speak
            ttsState.currentUtterance = utterance;
            speechSynthesis.speak(utterance);

            console.log(`ğŸ—£ï¸ TTS: ${speaker === 'counselor' ? 'è«®å•†å¸«' : 'æ¡ˆä¸»'} - "${text.substring(0, 20)}${text.length > 20 ? '...' : ''}"`);
        }

        function stopSpeech() {
            if (ttsState.isSupported && speechSynthesis.speaking) {
                speechSynthesis.cancel();
                console.log('ğŸ”‡ TTS å·²åœæ­¢');
            }
        }

        function toggleAudioPlayback() {
            if (!isRecording) {
                alert('è«‹å…ˆé»æ“Šã€Œé–‹å§‹æœƒè«‡ã€');
                return;
            }

            if (audioSimulation.isPlaying) {
                pauseAudioSimulation();
            } else {
                playAudioSimulation();
            }
        }

        function playAudioSimulation() {
            // If finished, restart from beginning
            if (audioSimulation.currentTime >= audioSimulation.duration) {
                audioSimulation.currentTime = 0;
                audioSimulation.lastDisplayedIndex = 0;
                transcriptSegments = [];
                transcript.innerHTML = '';
                console.log('â†º é‡æ–°é–‹å§‹æ’­æ”¾');
            }

            audioSimulation.isPlaying = true;
            audioSimulation.startTimeMs = performance.now() - (audioSimulation.currentTime * 1000);

            // Update UI
            audioPlayIcon.textContent = 'â¸ï¸';
            audioPlayText.textContent = 'æš«åœ';
            audioStatus.textContent = 'æ’­æ”¾ä¸­';

            // Start animation loop
            updateAudioProgress();

            console.log('â–¶ï¸ é–‹å§‹æ’­æ”¾æ¨¡æ“¬éŸ³è¨Š');
        }

        function pauseAudioSimulation() {
            audioSimulation.isPlaying = false;

            if (audioSimulation.animationFrame) {
                cancelAnimationFrame(audioSimulation.animationFrame);
                audioSimulation.animationFrame = null;
            }

            // Stop speech synthesis
            stopSpeech();

            // Update UI
            audioPlayIcon.textContent = 'â–¶ï¸';
            audioPlayText.textContent = 'ç¹¼çºŒæ’­æ”¾';
            audioStatus.textContent = 'å·²æš«åœ';

            console.log('â¸ï¸ æš«åœæ’­æ”¾');
        }

        function seekAudio(percentage) {
            const newTime = audioSimulation.duration * percentage;
            audioSimulation.currentTime = newTime;
            audioSimulation.startTimeMs = performance.now() - (newTime * 1000);

            // Stop any ongoing speech when seeking
            stopSpeech();

            // Update which lines should be displayed
            audioSimulation.lastDisplayedIndex = 0;
            transcriptSegments = [];
            transcript.innerHTML = '';

            // Display all lines up to current time
            for (let i = 0; i < currentScript.length; i++) {
                const line = currentScript[i];
                if (line.time && line.time <= newTime) {
                    if (line.speaker !== currentSpeaker) {
                        switchSpeaker(line.speaker);
                    }
                    addTranscriptLine(line.speaker, line.text);
                    audioSimulation.lastDisplayedIndex = i + 1;
                } else {
                    break;
                }
            }

            updateAudioUI();
            console.log(`â© è·³è½‰åˆ° ${formatTime(newTime)}`);
        }

        function updateAudioProgress() {
            if (!audioSimulation.isPlaying) return;

            const elapsed = performance.now() - audioSimulation.startTimeMs;
            audioSimulation.currentTime = Math.min(elapsed / 1000, audioSimulation.duration);

            // Display new transcript lines based on timestamp
            displayTranscriptAtTime(audioSimulation.currentTime);

            // Update UI
            updateAudioUI();

            // Check if finished
            if (audioSimulation.currentTime >= audioSimulation.duration) {
                audioSimulation.isPlaying = false;
                audioStatus.textContent = 'æ’­æ”¾å®Œç•¢';
                audioPlayIcon.textContent = 'â†º';
                audioPlayText.textContent = 'é‡æ–°æ’­æ”¾';
                console.log('âœ… éŸ³è¨Šæ’­æ”¾å®Œç•¢');
                return;
            }

            // Continue loop
            audioSimulation.animationFrame = requestAnimationFrame(updateAudioProgress);
        }

        function displayTranscriptAtTime(currentTime) {
            // Display all lines that should appear by current time
            for (let i = audioSimulation.lastDisplayedIndex; i < currentScript.length; i++) {
                const line = currentScript[i];

                if (line.time && line.time <= currentTime) {
                    // Switch speaker if needed
                    if (line.speaker !== currentSpeaker) {
                        switchSpeaker(line.speaker);
                    }

                    // Add transcript line
                    addTranscriptLine(line.speaker, line.text);

                    // Speak the text using TTS if voice simulation is enabled
                    if (isVoiceSimEnabled && audioSimulation.isPlaying) {
                        speakText(line.text, line.speaker);
                    }

                    audioSimulation.lastDisplayedIndex = i + 1;
                } else {
                    // Not yet time for this line
                    break;
                }
            }
        }

        function updateAudioUI() {
            const progress = (audioSimulation.currentTime / audioSimulation.duration) * 100;
            audioProgress.style.width = `${progress}%`;
            audioCurrentTime.textContent = formatTime(audioSimulation.currentTime);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${String(secs).padStart(2, '0')}`;
        }

        // Demo: Press 'T' to add next transcript line
        // Press 'R' to reset script
        // Press '1' for work stress script, '2' for general script
        document.addEventListener('keydown', (e) => {
            if (e.key === 't' || e.key === 'T') {
                simulateTranscriptInput();
            } else if (e.key === 'r' || e.key === 'R') {
                demoScriptIndex = 0;
                console.log('Demo åŠ‡æœ¬å·²é‡ç½®');
            } else if (e.key === '1') {
                currentScript = demoScripts.workStress;
                demoScriptIndex = 0;
                console.log('åˆ‡æ›åˆ°åŠ‡æœ¬ 1: å·¥ä½œå£“åŠ›èˆ‡ç„¦æ…®');
            } else if (e.key === '2') {
                currentScript = demoScripts.general;
                demoScriptIndex = 0;
                console.log('åˆ‡æ›åˆ°åŠ‡æœ¬ 2: ä¸€èˆ¬è«®è©¢');
            }
        });

        // === Initialize ===
        // Initialize waveform animations as paused on page load
        updateWaveformAnimations();

        // Hide speaker toggle in demo mode (scripted conversations auto-switch speaker)
        if (isDemoMode && speakerToggleSection) {
            speakerToggleSection.style.display = 'none';
        }

        // Hide history section in demo mode
        const historyContainer = document.getElementById('historyContainer');
        if (isDemoMode && historyContainer) {
            historyContainer.style.display = 'none';
        }

        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log('ğŸ¤ å³æ™‚è«®å•†è¼”åŠ©ç³»çµ± - Demo æ¨¡å¼ï¼ˆéŸ³è¨ŠåŒæ­¥ç‰ˆï¼‰');
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log('');
        console.log('ğŸµ éŸ³è¨Šæ’­æ”¾æ¨¡å¼ï¼š');
        console.log('  1. é»æ“Šã€Œé–‹å§‹æœƒè«‡ã€');
        console.log('  2. é»æ“Šã€Œæ’­æ”¾å°è©±ã€æŒ‰éˆ•');
        console.log('  3. é€å­—ç¨¿æœƒæ ¹æ“šéŸ³è¨Šæ™‚é–“æˆ³è‡ªå‹•é¡¯ç¤º');
        console.log('  4. éš¨æ™‚é»æ“Šã€Œå³æ™‚åˆ†æã€åˆ†æç•¶å‰å·²é¡¯ç¤ºçš„å°è©±');
        console.log('');
        console.log('ğŸ“Œ å¿«æ·éµèªªæ˜ï¼ˆå‚™ç”¨æ‰‹å‹•æ¨¡å¼ï¼‰ï¼š');
        console.log('  T - æ‰‹å‹•æ’­æ”¾ä¸‹ä¸€å¥å°è©±');
        console.log('  R - é‡ç½®åŠ‡æœ¬');
        console.log('  1 - å·¥ä½œå£“åŠ›åŠ‡æœ¬ï¼ˆå«è‡ªæ®ºé¢¨éšªï¼‰');
        console.log('  2 - ä¸€èˆ¬è«®è©¢åŠ‡æœ¬');
        console.log('');
        console.log('ğŸ¤– AI åˆ†æï¼š');
        console.log('  â€¢ è‡ªå‹•æ¨¡å¼ï¼šæ¯ 60 ç§’è‡ªå‹•è§¸ç™¼');
        console.log('  â€¢ æ‰‹å‹•æ¨¡å¼ï¼šéš¨æ™‚é»æ“Šã€Œå³æ™‚åˆ†æã€æŒ‰éˆ•');
        console.log('  â€¢ åˆ†æç¯„åœï¼šåƒ…åˆ†æç•¶å‰å·²é¡¯ç¤ºçš„é€å­—ç¨¿');
        console.log('');
        console.log('âœ¨ ç•¶å‰åŠ‡æœ¬ï¼šå·¥ä½œå£“åŠ›èˆ‡ç„¦æ…®ï¼ˆåŠ‡æœ¬ 1ï¼‰');
        console.log('ğŸ’¡ Demo æ¨¡å¼ï¼šæ¨¡æ“¬å³æ™‚å°è©±ï¼Œèªªè©±è€…è‡ªå‹•åˆ‡æ›');
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    </script>
</body>
</html>
