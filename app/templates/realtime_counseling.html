<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å³æ™‚è«®å•†è¼”åŠ©ç³»çµ± - Realtime Counseling</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <nav class="bg-indigo-600 text-white p-4">
        <div class="container mx-auto max-w-7xl flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold">ğŸ¤ å³æ™‚è«®å•†è¼”åŠ©ç³»çµ±</h1>
                <p class="text-sm opacity-90">AI-Powered Realtime Counseling Assistant</p>
            </div>
            <a href="/console" class="bg-white text-indigo-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition">
                â† è¿”å›æ§åˆ¶å°
            </a>
        </div>
    </nav>

    <div class="container mx-auto p-6 max-w-7xl">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Left Panel: Recording & Transcript -->
            <div class="space-y-4">
                <!-- Recording Controls -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold mb-4">ğŸ™ï¸ éŒ„éŸ³æ§åˆ¶</h2>

                    <!-- Timer Display -->
                    <div class="text-center mb-4">
                        <div class="text-4xl font-mono" id="timer">00:00</div>
                        <div class="text-sm text-gray-500">æœƒè«‡æ™‚é–“</div>
                    </div>

                    <!-- Start/Stop Buttons -->
                    <div class="flex gap-4">
                        <button id="startBtn" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 px-6 rounded-lg font-bold transition">
                            â–¶ï¸ é–‹å§‹æœƒè«‡
                        </button>
                        <button id="stopBtn" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 px-6 rounded-lg font-bold opacity-50 cursor-not-allowed" disabled>
                            â¹ï¸ çµæŸæœƒè«‡
                        </button>
                    </div>

                    <!-- Speaker Toggle (Manual) -->
                    <div class="mt-6">
                        <label class="block text-sm font-medium mb-2">ç•¶å‰èªªè©±è€…</label>
                        <div class="flex gap-2">
                            <button id="speakerCounselor" class="flex-1 py-3 px-4 rounded-lg font-bold bg-blue-500 text-white transition">
                                ğŸ‘¨â€âš•ï¸ è«®å•†å¸«
                            </button>
                            <button id="speakerClient" class="flex-1 py-3 px-4 rounded-lg font-bold bg-gray-300 text-gray-700 transition">
                                ğŸ§‘ æ¡ˆä¸»
                            </button>
                        </div>
                    </div>

                    <!-- Status Indicator -->
                    <div class="mt-4 p-3 bg-gray-100 rounded-lg">
                        <div class="flex items-center justify-between text-sm">
                            <span class="font-medium">ç‹€æ…‹ï¼š</span>
                            <span id="status" class="text-gray-600">å¾…æ©Ÿä¸­</span>
                        </div>
                        <div class="flex items-center justify-between text-sm mt-2">
                            <span class="font-medium">ä¸‹æ¬¡åˆ†æï¼š</span>
                            <span id="nextAnalysis" class="text-gray-600">æœªé–‹å§‹</span>
                        </div>
                    </div>

                    <!-- Demo Mode Hint -->
                    <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-sm text-blue-700">
                            ğŸ’¡ <strong>æ¸¬è©¦æ¨¡å¼</strong>ï¼šæŒ‰ <kbd class="bg-blue-200 px-2 py-1 rounded">T</kbd> éµå¯æ¨¡æ“¬è¼¸å…¥å°è©±æ–‡å­—
                        </p>
                    </div>
                </div>

                <!-- Live Transcript -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold mb-4">ğŸ“ å³æ™‚é€å­—ç¨¿</h2>
                    <div id="transcript" class="h-96 overflow-y-auto bg-gray-50 rounded-lg p-4 font-mono text-sm space-y-2">
                        <p class="text-gray-400 italic">ç­‰å¾…æœƒè«‡é–‹å§‹...</p>
                    </div>
                </div>
            </div>

            <!-- Right Panel: AI Analysis Cards -->
            <div class="space-y-4">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold mb-4">ğŸ¤– AI å³æ™‚åˆ†æ</h2>

                    <!-- Analysis Cards Container -->
                    <div id="analysisCards" class="space-y-4 max-h-[800px] overflow-y-auto">
                        <p class="text-gray-400 italic">åˆ†æå°‡æ¯ 60 ç§’è‡ªå‹•ç”¢ç”Ÿ...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Section (Collapsed by default) -->
        <div class="mt-6 bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold mb-4 cursor-pointer flex justify-between items-center" onclick="toggleHistory()">
                <span>ğŸ“Š æ­·å²è¨˜éŒ„</span>
                <span id="historyToggle">â–¼</span>
            </h2>
            <div id="historySection" class="hidden">
                <button onclick="clearHistory()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded mb-4 transition">
                    ğŸ—‘ï¸ æ¸…é™¤æ­·å²
                </button>
                <div id="historyList" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <script>
        // === State Management ===
        let isRecording = false;
        let currentSpeaker = 'counselor';
        let startTime = null;
        let timerInterval = null;
        let analysisInterval = null;
        let transcriptSegments = [];
        let analysisHistory = [];

        // === DOM Elements ===
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const timer = document.getElementById('timer');
        const status = document.getElementById('status');
        const nextAnalysis = document.getElementById('nextAnalysis');
        const transcript = document.getElementById('transcript');
        const analysisCards = document.getElementById('analysisCards');
        const speakerCounselorBtn = document.getElementById('speakerCounselor');
        const speakerClientBtn = document.getElementById('speakerClient');

        // === Event Listeners ===
        startBtn.addEventListener('click', startSession);
        stopBtn.addEventListener('click', stopSession);
        speakerCounselorBtn.addEventListener('click', () => switchSpeaker('counselor'));
        speakerClientBtn.addEventListener('click', () => switchSpeaker('client'));

        // === Core Functions ===
        function startSession() {
            isRecording = true;
            startTime = Date.now();
            transcriptSegments = [];
            analysisHistory = [];

            // UI Updates
            startBtn.disabled = true;
            startBtn.classList.add('opacity-50', 'cursor-not-allowed');
            stopBtn.disabled = false;
            stopBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            status.textContent = 'ğŸ”´ éŒ„éŸ³ä¸­';
            transcript.innerHTML = '';
            analysisCards.innerHTML = '<p class="text-gray-400 italic">ç­‰å¾…ç¬¬ä¸€æ¬¡åˆ†æï¼ˆ60ç§’å¾Œï¼‰...</p>';

            // Start Timer
            timerInterval = setInterval(updateTimer, 1000);

            // Start Analysis Interval (every 60 seconds)
            analysisInterval = setInterval(analyzeTranscript, 60000);

            // Show next analysis countdown
            updateNextAnalysisCountdown();
        }

        function stopSession() {
            isRecording = false;

            // Final analysis
            analyzeTranscript();

            // Cleanup
            clearInterval(timerInterval);
            clearInterval(analysisInterval);

            // UI Updates
            startBtn.disabled = false;
            startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            stopBtn.disabled = true;
            stopBtn.classList.add('opacity-50', 'cursor-not-allowed');
            status.textContent = 'â¹ï¸ å·²çµæŸ';
            nextAnalysis.textContent = '-';

            // Save to localStorage
            saveToHistory();
        }

        function switchSpeaker(speaker) {
            currentSpeaker = speaker;

            if (speaker === 'counselor') {
                speakerCounselorBtn.classList.remove('bg-gray-300', 'text-gray-700');
                speakerCounselorBtn.classList.add('bg-blue-500', 'text-white');
                speakerClientBtn.classList.remove('bg-blue-500', 'text-white');
                speakerClientBtn.classList.add('bg-gray-300', 'text-gray-700');
            } else {
                speakerClientBtn.classList.remove('bg-gray-300', 'text-gray-700');
                speakerClientBtn.classList.add('bg-blue-500', 'text-white');
                speakerCounselorBtn.classList.remove('bg-blue-500', 'text-white');
                speakerCounselorBtn.classList.add('bg-gray-300', 'text-gray-700');
            }
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            timer.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function updateNextAnalysisCountdown() {
            if (!isRecording) return;

            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const remaining = 60 - (elapsed % 60);
            nextAnalysis.textContent = `${remaining} ç§’`;

            setTimeout(() => updateNextAnalysisCountdown(), 1000);
        }

        // === Transcript Management ===
        function addTranscriptLine(speaker, text) {
            const line = document.createElement('div');
            line.className = speaker === 'counselor' ? 'text-blue-700' : 'text-green-700';
            line.innerHTML = `<strong>${speaker === 'counselor' ? 'ğŸ‘¨â€âš•ï¸ è«®å•†å¸«' : 'ğŸ§‘ æ¡ˆä¸»'}ï¼š</strong>${text}`;
            transcript.appendChild(line);
            transcript.scrollTop = transcript.scrollHeight;

            // Save to segments
            transcriptSegments.push({ speaker, text });
        }

        // === AI Analysis ===
        async function analyzeTranscript() {
            if (transcriptSegments.length === 0) return;

            // Build transcript text
            const transcriptText = transcriptSegments.map(s =>
                `${s.speaker === 'counselor' ? 'è«®å•†å¸«' : 'æ¡ˆä¸»'}ï¼š${s.text}`
            ).join('\n');

            // Calculate time range
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const timeRange = `${Math.max(0, minutes - 1)}:00-${minutes}:00`;

            try {
                const response = await fetch('/api/v1/realtime/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        transcript: transcriptText,
                        speakers: transcriptSegments,
                        time_range: timeRange
                    })
                });

                if (!response.ok) throw new Error('åˆ†æå¤±æ•—');

                const analysis = await response.json();
                displayAnalysisCard(analysis);

            } catch (error) {
                console.error('Analysis error:', error);
                showError('AI åˆ†æå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        function displayAnalysisCard(analysis) {
            // Clear placeholder
            if (analysisCards.querySelector('.text-gray-400')) {
                analysisCards.innerHTML = '';
            }

            const card = document.createElement('div');
            card.className = 'bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-4 border-l-4 border-purple-500';
            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <span class="text-xs text-gray-500">${analysis.time_range}</span>
                    <span class="text-xs text-gray-500">${new Date(analysis.timestamp).toLocaleTimeString('zh-TW')}</span>
                </div>

                <div class="mb-3">
                    <h3 class="font-bold text-sm text-gray-700 mb-1">ğŸ“‹ æ‘˜è¦</h3>
                    <p class="text-sm">${analysis.summary}</p>
                </div>

                ${analysis.alerts.length > 0 ? `
                    <div class="mb-3">
                        <h3 class="font-bold text-sm text-gray-700 mb-1">âš ï¸ è­¦ç¤º</h3>
                        <ul class="text-sm space-y-1">
                            ${analysis.alerts.map(alert => `<li class="text-red-600">â€¢ ${alert}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}

                ${analysis.suggestions.length > 0 ? `
                    <div>
                        <h3 class="font-bold text-sm text-gray-700 mb-1">ğŸ’¡ å»ºè­°</h3>
                        <ul class="text-sm space-y-1">
                            ${analysis.suggestions.map(sug => `<li class="text-green-600">â€¢ ${sug}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            `;

            // Insert at top
            analysisCards.insertBefore(card, analysisCards.firstChild);

            // Save to history
            analysisHistory.push(analysis);
        }

        function showError(message) {
            const card = document.createElement('div');
            card.className = 'bg-red-50 rounded-lg p-4 border-l-4 border-red-500';
            card.innerHTML = `<p class="text-sm text-red-700">âŒ ${message}</p>`;
            analysisCards.insertBefore(card, analysisCards.firstChild);
        }

        // === localStorage Management ===
        function saveToHistory() {
            const session = {
                timestamp: new Date().toISOString(),
                duration: timer.textContent,
                transcript: transcriptSegments,
                analyses: analysisHistory
            };

            const history = JSON.parse(localStorage.getItem('realtimeCounselingHistory') || '[]');
            history.unshift(session);

            // Keep last 10 sessions
            localStorage.setItem('realtimeCounselingHistory', JSON.stringify(history.slice(0, 10)));
        }

        function toggleHistory() {
            const section = document.getElementById('historySection');
            const toggle = document.getElementById('historyToggle');

            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                toggle.textContent = 'â–²';
                loadHistory();
            } else {
                section.classList.add('hidden');
                toggle.textContent = 'â–¼';
            }
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('realtimeCounselingHistory') || '[]');
            const list = document.getElementById('historyList');

            if (history.length === 0) {
                list.innerHTML = '<p class="text-gray-400 italic">å°šç„¡æ­·å²è¨˜éŒ„</p>';
                return;
            }

            list.innerHTML = history.map((session, index) => `
                <div class="bg-gray-50 rounded p-3">
                    <div class="flex justify-between items-center">
                        <span class="font-bold">#${index + 1} - ${new Date(session.timestamp).toLocaleString('zh-TW')}</span>
                        <span class="text-sm text-gray-600">æ™‚é•·ï¼š${session.duration}</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-1">åˆ†ææ¬¡æ•¸ï¼š${session.analyses.length} æ¬¡</p>
                </div>
            `).join('');
        }

        function clearHistory() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ­·å²è¨˜éŒ„å—ï¼Ÿ')) {
                localStorage.removeItem('realtimeCounselingHistory');
                document.getElementById('historyList').innerHTML = '<p class="text-gray-400 italic">å°šç„¡æ­·å²è¨˜éŒ„</p>';
            }
        }

        // === Demo Mode (Simulate transcript input) ===
        // TODO: Replace with actual ElevenLabs WebSocket integration when API key is ready
        function simulateTranscriptInput() {
            if (!isRecording) return;

            const demoTexts = [
                'ä½ å¥½ï¼Œä»Šå¤©æƒ³èŠä»€éº¼å‘¢ï¼Ÿ',
                'æˆ‘æœ€è¿‘å·¥ä½œå£“åŠ›å¾ˆå¤§...',
                'èƒ½å¤šèªªä¸€äº›å—ï¼Ÿ',
                'æˆ‘è¦ºå¾—æˆ‘åšä»€éº¼éƒ½ä¸å°ã€‚',
                'è½èµ·ä¾†ä½ æ„Ÿå—åˆ°å¾ˆå¤§çš„å£“åŠ›ã€‚',
                'æ˜¯çš„ï¼Œæˆ‘è¦ºå¾—å¾ˆç„¡åŠ©ã€‚',
                'é€™ç¨®æ„Ÿè¦ºå¾ä»€éº¼æ™‚å€™é–‹å§‹çš„ï¼Ÿ',
                'å¤§æ¦‚å¾ä¸Šå€‹æœˆé–‹å§‹ã€‚',
                'é‚£å€‹æ™‚å€™ç™¼ç”Ÿäº†ä»€éº¼äº‹å—ï¼Ÿ',
                'æˆ‘è¢«èª¿åˆ°æ–°çš„éƒ¨é–€...'
            ];

            const randomText = demoTexts[Math.floor(Math.random() * demoTexts.length)];
            addTranscriptLine(currentSpeaker, randomText);
        }

        // Demo: Press 'T' to add random transcript line (for testing without microphone)
        document.addEventListener('keydown', (e) => {
            if (e.key === 't' || e.key === 'T') {
                simulateTranscriptInput();
            }
        });

        // === Initialize ===
        console.log('ğŸ¤ Realtime Counseling System Ready');
        console.log('ğŸ’¡ Press "T" to simulate transcript input (demo mode)');
    </script>
</body>
</html>
