<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>AI å³æ™‚è¦ªå­è«®è©¢åˆ†æ - Parenting Counseling</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Session Workflow Modules (New Architecture) -->
    <script type="module" src="/static/js/api-client.js"></script>
    <script type="module" src="/static/js/session-workflow.js"></script>
    <style>
        /* Custom CSS for commercial-grade UI */
        * {
            -webkit-tap-highlight-color: transparent;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Safe area for mobile notches */
        .safe-area-inset-bottom {
            padding-bottom: max(1rem, env(safe-area-inset-bottom));
        }

        /* Smooth transitions */
        .transition-smooth {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Card hover effects */
        .card-hover {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
        }

        /* Animated gradient backgrounds */
        .gradient-animate {
            background-size: 200% 200%;
            animation: gradientShift 8s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Pulse animation for recording */
        .pulse-recording {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Fade in animation */
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Slide in from right animation */
        .animate-slide-in-right {
            animation: slideInRight 0.4s ease-out;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Chat bubble styles */
        .chat-bubble {
            max-width: 85%;
            word-wrap: break-word;
        }

        @media (min-width: 768px) {
            .chat-bubble {
                max-width: 75%;
            }
        }

        /* Touch-friendly button sizes */
        .btn-touch {
            min-height: 44px;
            min-width: 44px;
        }

        /* Badge severity colors */
        .badge-critical {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .badge-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .badge-info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .badge-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        /* Audio waveform animation */
        .waveform-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            height: 60px;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .waveform-bar {
            width: 6px;
            background: linear-gradient(180deg, #10b981 0%, #14b8a6 100%);
            border-radius: 3px;
            animation: waveform 1.2s ease-in-out infinite;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }

        .waveform-bar:nth-child(1) { animation-delay: 0s; }
        .waveform-bar:nth-child(2) { animation-delay: 0.1s; }
        .waveform-bar:nth-child(3) { animation-delay: 0.2s; }
        .waveform-bar:nth-child(4) { animation-delay: 0.3s; }
        .waveform-bar:nth-child(5) { animation-delay: 0.4s; }
        .waveform-bar:nth-child(6) { animation-delay: 0.3s; }
        .waveform-bar:nth-child(7) { animation-delay: 0.2s; }
        .waveform-bar:nth-child(8) { animation-delay: 0.1s; }

        @keyframes waveform {
            0%, 100% {
                height: 20px;
                background: linear-gradient(180deg, #10b981 0%, #14b8a6 100%);
            }
            50% {
                height: 50px;
                background: linear-gradient(180deg, #14b8a6 0%, #06b6d4 100%);
            }
        }

        /* REQUIREMENT 5: Compact waveform for mobile */
        @keyframes waveform-compact {
            0%, 100% {
                height: 8px;
                background: linear-gradient(180deg, #10b981 0%, #14b8a6 100%);
            }
            50% {
                height: 20px;
                background: linear-gradient(180deg, #14b8a6 0%, #06b6d4 100%);
            }
        }

        /* Recording timer */
        .recording-timer {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Courier New', monospace;
            font-variant-numeric: tabular-nums;
            letter-spacing: 0.05em;
        }

        /* iOS-Style Frosted Glass Effect */
        .ios-frosted {
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
        }

        /* iOS Safe Area - Top */
        .safe-area-inset-top {
            padding-top: max(1rem, env(safe-area-inset-top));
        }

        /* Mobile: Additional padding for fixed mobile nav header */
        @media (max-width: 767px) {
            .mobile-nav-padding {
                padding-top: calc(60px + max(1rem, env(safe-area-inset-top)));
            }
        }

        /* iOS Button Active State */
        .ios-button-active {
            transform: scale(0.96);
        }

        /* iOS Card Shadow */
        .ios-card-shadow {
            box-shadow: 0 2px 16px rgba(0, 0, 0, 0.08), 0 1px 4px rgba(0, 0, 0, 0.04);
        }

        /* Mobile Content Padding for Fixed Bars - REMOVED, using spacer blocks instead */

        /* Haptic Feedback Animation */
        @keyframes haptic-tap {
            0% { transform: scale(1); }
            50% { transform: scale(0.96); }
            100% { transform: scale(1); }
        }

        /* Spinner Animation for Loading State */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        .haptic-feedback:active {
            animation: haptic-tap 0.15s ease-out;
        }

        /* Disabled button styles */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Bouncing dots animation */
        @keyframes bounce-dot {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-8px);
            }
        }

        .loading-dot {
            display: inline-block;
            animation: bounce-dot 1.4s infinite ease-in-out;
        }

        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        /* Pure color concentric circles - fade between red, yellow, green */
        @keyframes color-cycle {
            0%, 25% {
                background: radial-gradient(circle,
                    rgba(239, 68, 68, 0.6) 0%,      /* Solid red center */
                    rgba(239, 68, 68, 0.3) 50%,     /* Light red */
                    rgba(239, 68, 68, 0.1) 80%,     /* Very light red */
                    transparent 100%
                );
            }
            33%, 58% {
                background: radial-gradient(circle,
                    rgba(251, 191, 36, 0.6) 0%,     /* Solid yellow center */
                    rgba(251, 191, 36, 0.3) 50%,    /* Light yellow */
                    rgba(251, 191, 36, 0.1) 80%,    /* Very light yellow */
                    transparent 100%
                );
            }
            66%, 91% {
                background: radial-gradient(circle,
                    rgba(34, 197, 94, 0.6) 0%,      /* Solid green center */
                    rgba(34, 197, 94, 0.3) 50%,     /* Light green */
                    rgba(34, 197, 94, 0.1) 80%,     /* Very light green */
                    transparent 100%
                );
            }
            100% {
                background: radial-gradient(circle,
                    rgba(239, 68, 68, 0.6) 0%,
                    rgba(239, 68, 68, 0.3) 50%,
                    rgba(239, 68, 68, 0.1) 80%,
                    transparent 100%
                );
            }
        }

        @keyframes pulse-scale {
            0%, 100% {
                transform: scale(1);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.1);
                opacity: 1;
            }
        }

        .concentric-circles {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            animation: color-cycle 6s ease-in-out infinite, pulse-scale 3s ease-in-out infinite;
        }

        /* Header is now controlled via Tailwind classes (hidden md:block) */
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <!-- MOBILE-ONLY: Global Navigation Header (Fixed at top, shows on ALL screens) -->
    <div id="mobileGlobalNav" class="md:hidden fixed top-0 left-0 right-0 z-[9999] bg-white/95 ios-frosted border-b border-gray-200/50 ios-card-shadow" style="display: none;">
        <div class="flex items-center justify-between px-4 py-3 safe-area-inset-top">
            <!-- Left: Home Button -->
            <button
                type="button"
                onclick="goToHome()"
                class="flex items-center gap-2 px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm font-medium rounded-lg transition-all active:scale-95"
            >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                <span>å›åˆ°é¦–é </span>
            </button>

            <!-- Right: Logout Button -->
            <button
                type="button"
                onclick="logout()"
                class="flex items-center gap-2 px-3 py-2 bg-red-50 hover:bg-red-100 text-red-600 text-sm font-medium rounded-lg transition-all active:scale-95"
            >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                </svg>
                <span>ç™»å‡º</span>
            </button>
        </div>
    </div>

    <!-- Early function definitions for mobile nav buttons -->
    <script>
        // Go to Home function (navigate back to onboarding screen 1 - client selection)
        function goToHome() {
            // Hide all screens
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('onboardingContainer').style.display = 'block';

            // Reset to first onboarding screen (client selection)
            const onboardingScreens = document.querySelectorAll('[id^="onboardingScreen"]');
            onboardingScreens.forEach(screen => {
                screen.style.display = 'none';
            });
            document.getElementById('onboardingScreen1').style.display = 'flex';
            document.getElementById('clientListMode').style.display = 'flex';
            document.getElementById('clientFormMode').style.display = 'none';

            // Reset any active recording or analysis
            if (typeof stopRecording === 'function') {
                try {
                    stopRecording();
                } catch (e) {
                    console.log('No active recording to stop');
                }
            }
        }

        // Logout function (called by logout button)
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('tenantId');
            localStorage.removeItem('debugMode'); // Clear debug mode on logout

            // Hide main content and onboarding, show login form
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('onboardingContainer').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'flex';

            // Hide mobile global nav
            document.getElementById('mobileGlobalNav').style.display = 'none';
        }

        // Onboarding: Show client form
        function showClientForm() {
            console.log('[CLIENT_FORM] Showing client creation form');
            document.getElementById('onboardingContainer').style.display = 'block';
            document.getElementById('onboardingScreen1').style.display = 'flex';
            document.getElementById('clientListMode').style.display = 'none';
            document.getElementById('clientFormMode').style.display = 'flex';
            document.getElementById('onboardingScreen2').style.display = 'none';
        }

        // Onboarding: Back to client selection from mode selection screen
        function backToClientSelection() {
            console.log('[ONBOARDING] Going back to client selection');
            document.getElementById('onboardingScreen2').style.display = 'none';
            document.getElementById('onboardingScreen1').style.display = 'flex';
            document.getElementById('clientListMode').style.display = 'flex';
            document.getElementById('clientFormMode').style.display = 'none';
            localStorage.removeItem('selectedClientId');
            localStorage.removeItem('selectedClientName');
        }

        // Counseling mode variable (will be set by setOnboardingMode)
        var counselingMode = 'practice'; // default

        // Onboarding: Set counseling mode (emergency or practice)
        function setOnboardingMode(mode) {
            console.log(`[ONBOARDING] Setting mode to: ${mode}`);
            counselingMode = mode;

            const emergencyBtn = document.getElementById('onboardingEmergencyBtn');
            const practiceBtn = document.getElementById('onboardingPracticeBtn');

            if (mode === 'emergency') {
                emergencyBtn.classList.remove('bg-gray-200', 'text-gray-700');
                emergencyBtn.classList.add('bg-red-500', 'text-white');
                practiceBtn.classList.remove('bg-green-500', 'text-white');
                practiceBtn.classList.add('bg-gray-200', 'text-gray-700');
            } else {
                practiceBtn.classList.remove('bg-gray-200', 'text-gray-700');
                practiceBtn.classList.add('bg-green-500', 'text-white');
                emergencyBtn.classList.remove('bg-red-500', 'text-white');
                emergencyBtn.classList.add('bg-gray-200', 'text-gray-700');
            }
        }

        // Onboarding: Complete onboarding and go to main content
        function completeOnboarding() {
            console.log(`[ONBOARDING] Completing with mode: ${counselingMode}`);

            // Apply the selected mode if setCounselingMode exists
            if (typeof setCounselingMode === 'function') {
                setCounselingMode(counselingMode);
            }

            document.getElementById('onboardingContainer').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }
    </script>

    <!-- Login Form (shown when not logged in) - Mobile-Friendly Design -->
    <div id="loginContainer" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-white">
        <div class="w-full max-w-md px-6 py-8 fade-in">
            <!-- Alert Messages -->
            <div id="loginAlertContainer" class="mb-4"></div>

            <!-- Login Form -->
            <form id="loginForm" class="space-y-6">
                <!-- Email Section -->
                <div>
                    <label for="loginEmail" class="block text-gray-800 font-medium text-base mb-3">è¼¸å…¥é›»å­éƒµä»¶</label>
                    <input
                        type="email"
                        id="loginEmail"
                        class="w-full px-4 py-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 transition-all text-base"
                        placeholder="your.email@example.com"
                        required
                    >
                </div>

                <!-- Password Section -->
                <div>
                    <label for="loginPassword" class="block text-gray-800 font-medium text-base mb-3">è¼¸å…¥å¯†ç¢¼</label>
                    <input
                        type="password"
                        id="loginPassword"
                        class="w-full px-4 py-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 transition-all text-base"
                        placeholder="è«‹è¼¸å…¥å¯†ç¢¼"
                        required
                    >
                    <div class="mt-2 text-right">
                        <a href="/forgot-password?tenant=island_parents" class="text-xs text-gray-500 hover:text-gray-700 transition-colors">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</a>
                    </div>
                </div>

                <!-- Tenant Selector (Hidden by default) -->
                <input type="hidden" id="loginTenantId" value="island_parents">

                <!-- Submit Button - Large Black Button at Bottom -->
                <div class="mt-auto pt-8">
                    <button
                        type="submit"
                        id="loginSubmitBtn"
                        class="w-full py-4 bg-black text-white font-semibold rounded-lg hover:bg-gray-800 transition-all duration-300 text-lg relative"
                    >
                        <span id="loginBtnText">é–‹å§‹è«®è©¢</span>
                        <span id="loginBtnSpinner" class="hidden">ç™»å…¥ä¸­...</span>
                    </button>
                </div>

                <!-- Debug Indicator (Hidden by default) -->
                <div id="debugIndicator" class="hidden text-center mt-4">
                    <span class="text-xs text-red-500 font-mono">ğŸ› DEBUG MODE</span>
                </div>
            </form>

            <!-- Advanced Options Toggle (Optional) -->
            <div class="text-center mt-6">
                <button
                    type="button"
                    id="showAdvancedBtn"
                    class="text-sm text-gray-500 hover:text-gray-700 transition-colors"
                    onclick="toggleAdvancedOptions()"
                >
                    é€²éšé¸é … â–¼
                </button>
            </div>

            <!-- Advanced Options Panel (Hidden by default) -->
            <div id="advancedOptions" class="hidden mt-4 p-4 bg-gray-50 rounded-lg space-y-3">
                <div>
                    <label for="tenantSelector" class="block text-gray-600 text-sm mb-1">ç§Ÿæˆ¶é¸æ“‡</label>
                    <select
                        id="tenantSelector"
                        class="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                        onchange="document.getElementById('loginTenantId').value = this.value"
                    >
                        <option value="island_parents" selected>Island Parents</option>
                        <option value="career">Career</option>
                        <option value="island">Island</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Onboarding Container (shown after login for island_parents) -->
    <div id="onboardingContainer" class="fixed inset-0 z-50 bg-white" style="display: none;">
        <!-- Screen 1: Client Selection or Creation -->
        <div id="onboardingScreen1" class="h-full flex flex-col p-6 mobile-nav-padding safe-area-inset-bottom">
            <!-- Top Right Buttons -->
            <div class="flex justify-end items-center gap-4 mb-6">
                <!-- Logout button: Only show on desktop (mobile uses global nav) -->
                <button
                    type="button"
                    onclick="logout()"
                    class="hidden md:inline-block text-red-500 hover:text-red-700 text-sm font-medium transition-colors"
                >
                    ç™»å‡º
                </button>
                <!-- Skip button: Always visible -->
                <button
                    type="button"
                    id="skipOnboardingBtn"
                    class="text-gray-500 hover:text-gray-700 text-sm font-medium transition-colors"
                    onclick="skipOnboarding()"
                >
                    è·³é
                </button>
            </div>

            <!-- Mode 1: Client List (shown when user has existing clients) -->
            <div id="clientListMode" class="flex-1 flex flex-col" style="display: none;">
                <h2 class="text-2xl font-bold text-gray-800 mb-8">é¸æ“‡å­©å­</h2>

                <!-- Client List Container -->
                <div id="clientListContainer" class="flex-1 overflow-y-auto space-y-3 mb-6">
                    <!-- Client items will be dynamically inserted here -->
                </div>

                <!-- Add New Client Button -->
                <div class="mt-auto">
                    <button
                        type="button"
                        id="addNewClientBtn"
                        class="w-full py-4 border-2 border-black text-black font-semibold rounded-lg hover:bg-gray-100 transition-all duration-300 text-lg"
                        onclick="showClientForm()"
                    >
                        + æ–°å¢å…¶ä»–å­©å­
                    </button>
                </div>
            </div>

            <!-- Mode 2: Client Creation Form (shown when no clients or adding new) -->
            <div id="clientFormMode" class="flex-1 flex flex-col" style="display: none;">
                <h2 class="text-2xl font-bold text-gray-800 mb-8">è¨­å®šå­©å­è³‡æ–™</h2>

                <form id="clientSetupForm" class="space-y-6 flex-1 flex flex-col">
                    <!-- Child Name Input -->
                    <div>
                        <label for="childNickname" class="block text-gray-800 font-medium text-base mb-3">è¼¸å…¥å­©å­æš±ç¨±</label>
                        <input
                            type="text"
                            id="childNickname"
                            class="w-full px-4 py-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 transition-all text-base"
                            placeholder="ex.å°å¯¶"
                            required
                        >
                    </div>

                    <!-- Child Grade Dropdown -->
                    <div>
                        <label for="childGrade" class="block text-gray-800 font-medium text-base mb-3">å­©å­å¹´ç´š</label>
                        <select
                            id="childGrade"
                            class="w-full px-4 py-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 transition-all text-base appearance-none bg-white"
                            required
                        >
                            <option value="" disabled selected>è¼¸å…¥å¹´ç´š</option>
                            <option value="å¹¼å…’åœ’">å¹¼å…’åœ’</option>
                            <option value="å°å­¸1å¹´ç´š">å°å­¸1å¹´ç´š</option>
                            <option value="å°å­¸2å¹´ç´š">å°å­¸2å¹´ç´š</option>
                            <option value="å°å­¸3å¹´ç´š">å°å­¸3å¹´ç´š</option>
                            <option value="å°å­¸4å¹´ç´š">å°å­¸4å¹´ç´š</option>
                            <option value="å°å­¸5å¹´ç´š">å°å­¸5å¹´ç´š</option>
                            <option value="å°å­¸6å¹´ç´š">å°å­¸6å¹´ç´š</option>
                            <option value="åœ‹ä¸­1å¹´ç´š">åœ‹ä¸­1å¹´ç´š</option>
                            <option value="åœ‹ä¸­2å¹´ç´š">åœ‹ä¸­2å¹´ç´š</option>
                            <option value="åœ‹ä¸­3å¹´ç´š">åœ‹ä¸­3å¹´ç´š</option>
                            <option value="é«˜ä¸­1å¹´ç´š">é«˜ä¸­1å¹´ç´š</option>
                            <option value="é«˜ä¸­2å¹´ç´š">é«˜ä¸­2å¹´ç´š</option>
                            <option value="é«˜ä¸­3å¹´ç´š">é«˜ä¸­3å¹´ç´š</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>

                    <!-- Parent Relationship Dropdown -->
                    <div>
                        <label for="parentRelation" class="block text-gray-800 font-medium text-base mb-3">ä½ æ˜¯å­©å­çš„</label>
                        <select
                            id="parentRelation"
                            class="w-full px-4 py-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 transition-all text-base appearance-none bg-white"
                            required
                        >
                            <option value="" disabled selected>é¸æ“‡é—œä¿‚</option>
                            <option value="çˆ¸çˆ¸">çˆ¸çˆ¸</option>
                            <option value="åª½åª½">åª½åª½</option>
                            <option value="çˆºçˆº">çˆºçˆº</option>
                            <option value="å¥¶å¥¶">å¥¶å¥¶</option>
                            <option value="å¤–å…¬">å¤–å…¬</option>
                            <option value="å¤–å©†">å¤–å©†</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>

                    <!-- Submit Button - Large Black Button at Bottom -->
                    <div class="mt-auto pt-8">
                        <button
                            type="submit"
                            id="clientSetupSubmitBtn"
                            class="w-full py-4 bg-black text-white font-semibold rounded-lg hover:bg-gray-800 transition-all duration-300 text-lg relative"
                        >
                            <span id="clientSetupBtnText">ä¸‹ä¸€æ­¥</span>
                            <span id="clientSetupBtnSpinner" class="hidden">å»ºç«‹ä¸­...</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Screen 2: Mode Selection & Confirmation -->
        <div id="onboardingScreen2" class="h-full flex flex-col p-6 mobile-nav-padding safe-area-inset-bottom" style="display: none;">
            <!-- Back Button (Top Left) -->
            <div class="flex justify-start mb-6">
                <button
                    type="button"
                    onclick="backToClientSelection()"
                    class="text-gray-500 hover:text-gray-700 text-sm font-medium transition-colors flex items-center gap-2"
                >
                    â† é‡æ–°é¸æ“‡å­©å­
                </button>
            </div>

            <!-- Content Container (Centered) -->
            <div class="flex-1 flex flex-col items-center justify-center">
                <!-- Success Header -->
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">å»ºç«‹å®ŒæˆğŸ‰</h2>
                </div>

                <!-- Avatar Circle -->
                <div class="mb-6">
                    <div class="w-24 h-24 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center shadow-lg">
                        <span class="text-white text-4xl font-bold">ğŸ‘¶</span>
                    </div>
                </div>

                <!-- Child Name Display with context -->
                <div class="mb-8 text-center">
                    <p class="text-lg text-gray-600 mb-2">ç¾åœ¨è¦è·Ÿ</p>
                    <p id="childNameDisplay" class="text-3xl font-bold text-gray-800 mb-2"></p>
                    <p class="text-lg text-gray-600">å°è©±</p>
                </div>

                <!-- Mode Selection -->
                <div class="w-full max-w-md mb-8">
                    <label class="text-sm font-semibold text-gray-700 flex items-center gap-2 mb-3 justify-center">
                        <span class="text-xl">ğŸ¯</span>
                        <span>é¸æ“‡æ¨¡å¼</span>
                    </label>
                    <div class="grid grid-cols-2 gap-4">
                        <button
                            id="onboardingEmergencyBtn"
                            class="px-6 py-4 rounded-lg bg-red-500 text-white font-semibold text-base transition-all hover:bg-red-600 shadow-md"
                            onclick="setOnboardingMode('emergency')"
                        >
                            ğŸš¨ å¯¦æˆ°æ¨¡å¼
                        </button>
                        <button
                            id="onboardingPracticeBtn"
                            class="px-6 py-4 rounded-lg bg-gray-200 text-gray-700 font-semibold text-base transition-all hover:bg-gray-300 shadow-md"
                            onclick="setOnboardingMode('practice')"
                        >
                            ğŸ“ ç·´ç¿’æ¨¡å¼
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-3 text-center">
                        å¯¦æˆ°ï¼šå³æ™‚ä»‹å…¥ï¼Œå¿«é€Ÿå»ºè­°<br>
                        ç·´ç¿’ï¼šäº‹å‰æº–å‚™ï¼Œè©³ç´°æŒ‡å°
                    </p>
                </div>

                <!-- Next Button - Large Black Button -->
                <div class="w-full max-w-md">
                    <button
                        type="button"
                        id="completeOnboardingBtn"
                        class="w-full py-4 bg-black text-white font-semibold rounded-lg hover:bg-gray-800 transition-all duration-300 text-lg shadow-lg"
                        onclick="completeOnboarding()"
                    >
                        é–‹å§‹å°è©±
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content (hidden until logged in) -->
    <div id="mainContent" style="display: none;">
    <!-- Header - Commercial Grade with Gradient - Hidden on mobile, visible on desktop -->
    <nav id="mainHeader" class="hidden md:block sticky top-0 z-50 shadow-lg gradient-animate" style="background: linear-gradient(135deg, #8bd1a8 0%, #7dbf9b 45%, #6fb1a1 100%);">
        <div class="container mx-auto max-w-7xl px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 md:w-12 md:h-12 bg-white rounded-xl flex items-center justify-center shadow-md">
                        <span class="text-2xl">ğŸ¤</span>
                    </div>
                    <div>
                        <h1 class="text-white font-bold text-lg md:text-xl">AI å³æ™‚è¦ªå­è«®è©¢åˆ†æ</h1>
                        <p class="text-green-900 text-xs hidden md:block">è¦ªå­æ•™é¤Šå°ˆæ¥­ç‰ˆ - æœ¬ç³»çµ±ä½¿ç”¨è¦ªå­æ•™é¤Šç†è«–çŸ¥è­˜åº«ï¼Œæä¾›å³æ™‚ AI åˆ†æèˆ‡å»ºè­°ï¼Œå¹«åŠ©è«®å•†å¸«åœ¨è¦ªå­è«®è©¢éç¨‹ä¸­ç²å¾—å°ˆæ¥­æ”¯æ´ã€‚</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="userEmailDisplay" class="text-white text-sm"></span>
                    <button onclick="logout()" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg transition-all duration-300 hover:shadow-lg font-semibold">
                        ç™»å‡º
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- MOBILE-ONLY: Non-scrollable Block Layout (100vh, no position: fixed) -->
    <div class="md:hidden h-screen flex flex-col overflow-hidden">
        <!-- TOP BLOCK: Timer and Waveform only (buttons moved to bottom) -->
        <div class="bg-white/95 ios-frosted border-b border-gray-200/50 ios-card-shadow mobile-nav-padding">
            <div class="px-4 py-3">

                <!-- Recording Waveform & Timer (shown when recording) -->
                <div id="recordingTimerDisplayMobile" class="bg-gradient-to-r from-teal-50/90 to-cyan-50/90 rounded-xl p-2.5 border border-teal-200/50" style="display: none;">
                    <div class="flex items-center justify-between gap-2">
                        <!-- Compact Waveform -->
                        <div id="waveformContainerMobile" class="flex items-center justify-center gap-1 flex-1" style="height: 20px;">
                            <div class="waveform-bar" style="width: 3px; animation: waveform-compact 1.2s ease-in-out infinite; animation-delay: 0s;"></div>
                            <div class="waveform-bar" style="width: 3px; animation: waveform-compact 1.2s ease-in-out infinite; animation-delay: 0.1s;"></div>
                            <div class="waveform-bar" style="width: 3px; animation: waveform-compact 1.2s ease-in-out infinite; animation-delay: 0.2s;"></div>
                            <div class="waveform-bar" style="width: 3px; animation: waveform-compact 1.2s ease-in-out infinite; animation-delay: 0.3s;"></div>
                            <div class="waveform-bar" style="width: 3px; animation: waveform-compact 1.2s ease-in-out infinite; animation-delay: 0.2s;"></div>
                            <div class="waveform-bar" style="width: 3px; animation: waveform-compact 1.2s ease-in-out infinite; animation-delay: 0.1s;"></div>
                        </div>
                        <!-- Compact Timer -->
                        <div class="flex items-center gap-1 flex-shrink-0">
                            <div class="w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse"></div>
                            <span id="recordingTimerMobile" class="text-xs font-mono font-bold text-gray-700">00:00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- iOS-style Settings Modal (Bottom Sheet) -->
        <div id="settingsModal" class="fixed inset-0 z-50 hidden">
            <!-- Backdrop -->
            <div id="settingsModalBackdrop" class="absolute inset-0 bg-black/50 opacity-0 transition-opacity duration-300"></div>

            <!-- Modal Content (slides up from bottom) -->
            <div id="settingsModalContent" class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl max-h-[70vh] overflow-y-auto transform translate-y-full transition-transform duration-300 mb-20">
                <!-- Modal Header -->
                <div class="sticky top-0 bg-white/95 backdrop-blur-md border-b border-gray-200 px-6 py-4 flex items-center justify-between rounded-t-3xl">
                    <h3 class="text-lg font-bold text-gray-800">è¨­å®š</h3>
                    <button id="settingsModalClose" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 active:bg-gray-200 transition-colors">
                        <span class="text-2xl text-gray-500">Ã—</span>
                    </button>
                </div>

                <!-- Modal Body -->
                <div class="px-6 py-4 space-y-4">
                    <!-- AI Model Selection -->
                    <div id="aiModelSectionMobile" class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-2xl p-4 border border-purple-200">
                        <label class="text-sm font-semibold text-gray-700 flex items-center gap-2 mb-3">
                            <span class="text-xl">ğŸ¤–</span>
                            <span>AI æ¨¡å‹</span>
                        </label>

                        <!-- Provider Toggle -->
                        <div id="aiModelToggleRowMobile" class="flex items-center justify-between mb-3 pb-3 border-b border-purple-200">
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-700" id="providerLabel">Gemini</span>
                            </div>
                            <button id="providerToggle" class="relative inline-flex h-7 w-12 items-center rounded-full bg-gray-300 transition-colors focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <span id="providerToggleCircle" class="inline-block h-5 w-5 transform rounded-full bg-white shadow-lg transition-transform translate-x-1"></span>
                            </button>
                        </div>

                        <div class="text-xs text-gray-600">
                            <span id="providerDescription">é€Ÿåº¦å¿« Â· æ”¯æ´å¿«å–</span>
                            <span id="providerLatency" class="ml-2 text-purple-600 font-mono hidden"></span>
                        </div>

                        <!-- Codeer Model Selector -->
                        <div id="codeerModelSelector" class="mt-3 pt-3 border-t border-purple-200 hidden">
                            <label class="text-xs font-semibold text-gray-600 mb-2 block">é¸æ“‡ Codeer æ¨¡å‹</label>
                            <div class="space-y-2">
                                <label class="flex items-center gap-2 p-3 rounded-xl hover:bg-white/50 cursor-pointer transition-colors border border-transparent hover:border-purple-200">
                                    <input type="radio" name="codeerModel" value="gemini-flash" checked class="text-purple-600 focus:ring-purple-500">
                                    <span class="text-sm">ğŸ”® Gemini 2.5 Flash<span class="ml-1 text-green-600 font-semibold text-xs">æ¨è–¦</span></span>
                                </label>
                                <label class="flex items-center gap-2 p-3 rounded-xl hover:bg-white/50 cursor-pointer transition-colors border border-transparent hover:border-purple-200">
                                    <input type="radio" name="codeerModel" value="claude-sonnet" class="text-purple-600 focus:ring-purple-500">
                                    <span class="text-sm">ğŸ¤– Claude Sonnet 4.5<span class="ml-1 text-blue-600 text-xs">é«˜å“è³ª</span></span>
                                </label>
                                <label class="flex items-center gap-2 p-3 rounded-xl hover:bg-white/50 cursor-pointer transition-colors border border-transparent hover:border-purple-200">
                                    <input type="radio" name="codeerModel" value="gpt5-mini" class="text-purple-600 focus:ring-purple-500">
                                    <span class="text-sm">âš¡ GPT-5 Mini<span class="ml-1 text-gray-500 text-xs">ç©©å®š</span></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Recording Mode Toggle -->
                    <div class="bg-gray-50 rounded-2xl p-4 border border-gray-200">
                        <div class="flex items-center justify-between">
                            <label class="text-sm font-semibold text-gray-700 flex items-center gap-2">
                                <span class="text-xl">ğŸ¤</span>
                                <span id="modeToggleLabel">çœŸå¯¦éŒ„éŸ³</span>
                            </label>
                            <button id="modeToggle" class="relative inline-flex h-7 w-12 items-center rounded-full bg-green-600 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500" role="switch" aria-checked="true" title="åˆ‡æ›çœŸå¯¦éŒ„éŸ³/Demoæ¨¡å¼">
                                <span class="inline-block h-5 w-5 transform rounded-full bg-white shadow-lg transition-transform translate-x-6"></span>
                            </button>
                        </div>
                        <span id="modeHint" class="text-xs text-gray-500 mt-2 block">é–‹å•Ÿ = çœŸå¯¦éŒ„éŸ³ / é—œé–‰ = Demo æ¨¡å¼</span>
                    </div>

                    <!-- Counseling Mode Toggle (Emergency/Practice) -->
                    <div class="bg-gray-50 rounded-2xl p-4 border border-gray-200 mt-4">
                        <label class="text-sm font-semibold text-gray-700 flex items-center gap-2 mb-3">
                            <span class="text-xl">ğŸ¯</span>
                            <span>è«®è©¢æ¨¡å¼</span>
                        </label>
                        <div class="flex gap-2">
                            <button id="emergencyModeBtn" class="flex-1 px-3 py-2 rounded-lg bg-red-500 text-white font-semibold text-sm transition-all hover:bg-red-600">
                                ğŸš¨ å¯¦æˆ°
                            </button>
                            <button id="practiceModeBtn" class="flex-1 px-3 py-2 rounded-lg bg-gray-200 text-gray-700 font-semibold text-sm transition-all hover:bg-gray-300">
                                ğŸ“ ç·´ç¿’
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            ç·Šæ€¥ï¼š1-2 å¥å°ˆå®¶å»ºè­°ï¼ˆå¾ 200 å¥ä¸­é¸æ“‡ï¼‰<br>
                            ç·´ç¿’ï¼š3-4 å¥å°ˆå®¶å»ºè­°ï¼ˆå¾ 200 å¥ä¸­é¸æ“‡ï¼‰
                        </p>
                    </div>

                    <!-- Transcript Testing Shortcuts (Mobile) -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-4 border border-blue-200 mt-4">
                        <label class="text-sm font-semibold text-gray-700 flex items-center gap-2 mb-3">
                            <span class="text-xl">ğŸ§ª</span>
                            <span>å¿«é€Ÿæ¸¬è©¦</span>
                        </label>
                        <div class="grid grid-cols-3 gap-2 mb-2">
                            <button id="loadGreenBtn" class="px-2 py-2 rounded-lg bg-green-500 text-white font-semibold text-xs transition-all hover:bg-green-600 shadow-sm">
                                ğŸŸ¢ ç¶ ç‡ˆ
                            </button>
                            <button id="loadYellowBtn" class="px-2 py-2 rounded-lg bg-yellow-500 text-white font-semibold text-xs transition-all hover:bg-yellow-600 shadow-sm">
                                ğŸŸ¡ é»ƒç‡ˆ
                            </button>
                            <button id="loadRedBtn" class="px-2 py-2 rounded-lg bg-red-500 text-white font-semibold text-xs transition-all hover:bg-red-600 shadow-sm">
                                ğŸ”´ ç´…ç‡ˆ
                            </button>
                        </div>
                        <button id="quickTestAnalyzeBtn" class="w-full px-3 py-2.5 rounded-lg bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white font-semibold text-xs transition-all mb-2 shadow-md hover:shadow-lg">
                            âš¡ ç«‹å³åˆ†æ
                        </button>
                        <div class="flex gap-2">
                            <button id="clearTranscriptBtn" class="flex-1 px-2 py-1.5 rounded-lg bg-gray-200 text-gray-700 font-semibold text-xs transition-all hover:bg-gray-300">
                                æ¸…é™¤
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            å¿«é€Ÿè¼‰å…¥æ¸¬è©¦å°è©±ï¼Œç„¡éœ€èªéŸ³è¾¨è­˜
                        </p>
                    </div>
                </div>

                <!-- Safe Area Bottom Padding -->
                <div class="h-6 bg-white"></div>
            </div>
        </div>

        <!-- MIDDLE BLOCK: Content Area (flex-1, fills remaining space) -->
        <div class="flex-1 overflow-hidden bg-gradient-to-br from-gray-50 to-gray-100 p-4">
            <!-- Initial UI (æ‰‹æ©Ÿç‰ˆé¦–é ) -->
            <div id="initialUI" class="h-full bg-gradient-to-br from-gray-50 to-white flex flex-col items-center justify-center px-8 py-12 space-y-12">
                <!-- é ‚éƒ¨æ¨™é¡Œ -->
                <h1 class="text-2xl font-bold text-gray-900 text-center">
                    æº–å‚™å¥½è·Ÿå­©å­è«‡è«‡äº†å—ï¼Ÿ
                </h1>

                <!-- æŒ‰éˆ•å€åŸŸ -->
                <div class="w-full max-w-sm space-y-6">
                    <!-- ç·´ç¿’æŒ‰éˆ• -->
                    <button id="practiceBtn" class="haptic-feedback btn-touch w-full bg-black active:bg-gray-800 text-white py-6 px-8 rounded-3xl font-bold text-lg transition-smooth shadow-xl">
                        é å…ˆç·´ç¿’
                    </button>

                    <!-- å¯¦æˆ°æŒ‰éˆ• -->
                    <button id="realTalkBtn" class="haptic-feedback btn-touch w-full bg-black active:bg-gray-800 text-white py-6 px-8 rounded-3xl font-bold text-lg transition-smooth shadow-xl">
                        å’Œå­©å­è«‡è«‡
                    </button>
                </div>
            </div>

            <!-- Practice Intro UI (ç·´ç¿’ä»‹ç´¹é é¢) -->
            <div id="practiceIntroUI" class="hidden h-full bg-gradient-to-br from-gray-50 to-white flex flex-col items-center justify-between px-8 py-12 relative">
                <!-- Navigation buttons -->
                <div class="absolute top-4 left-4 right-4 flex justify-between z-10">
                    <!-- Home button (left) -->
                    <button id="homeBtn" class="haptic-feedback px-4 py-2 bg-white/90 hover:bg-white active:bg-gray-50 rounded-full text-gray-700 font-medium text-sm shadow-md transition-smooth flex items-center gap-2">
                        <span>ğŸ </span>
                        <span>é¦–é </span>
                    </button>

                    <!-- Back button (right) -->
                    <button id="backToInitialBtn" class="haptic-feedback px-4 py-2 bg-white/90 hover:bg-white active:bg-gray-50 rounded-full text-gray-700 font-medium text-sm shadow-md transition-smooth flex items-center gap-2">
                        <span>â†</span>
                        <span>ä¸Šä¸€é </span>
                    </button>
                </div>

                <!-- ä¸­å¤®åŒå¿ƒåœ“æ¼¸å±¤å€åŸŸ -->
                <div class="flex-1 flex items-center justify-center w-full">
                    <div class="relative w-80 h-80 flex items-center justify-center">
                        <!-- åŒå¿ƒåœ“æ¼¸å±¤èƒŒæ™¯ (4 å±¤ teal/cyan) -->
                        <div class="absolute inset-0 rounded-full" style="background: radial-gradient(circle, #2dd4bf 0%, #5eead4 25%, #99f6e4 50%, #ccfbf1 75%, transparent 100%);"></div>

                        <!-- ä¸­å¤®æ–‡å­— -->
                        <div class="relative z-10 text-center space-y-6">
                            <h2 class="text-2xl font-bold text-teal-900">
                                æº–å‚™å¥½è·Ÿå­©å­è«‡è«‡äº†å—ï¼Ÿ
                            </h2>
                        </div>
                    </div>
                </div>

                <!-- åº•éƒ¨æ–‡å­—å’ŒæŒ‰éˆ• -->
                <div class="w-full max-w-sm space-y-8">
                    <!-- æè¿°æ–‡å­— -->
                    <div class="text-center space-y-2">
                        <p class="text-lg font-semibold text-gray-800">ç‚ºç¾å¥½å°è©±åšæº–å‚™</p>
                        <p class="text-base text-gray-600">æº–å‚™å¥½äº†ï¼Œæºé€šæ›´è¼•é¬†</p>
                    </div>

                    <!-- å‰µå»ºç·´ç¿’æŒ‰éˆ• -->
                    <button id="createPracticeBtn" class="haptic-feedback btn-touch w-full bg-black active:bg-gray-800 text-white py-6 px-8 rounded-3xl font-bold text-lg transition-smooth shadow-xl">
                        å‰µå»ºç·´ç¿’
                    </button>
                </div>
            </div>

            <!-- Recording UI (æ‰‹æ©Ÿç‰ˆéŒ„éŸ³ä¸­çš„æ¥µç°¡ç•Œé¢) -->
            <div id="recordingUI" class="hidden h-full flex flex-col items-center justify-between py-8 px-4">
                <!-- é ‚éƒ¨ç‹€æ…‹å’Œè¨ˆæ™‚å™¨ -->
                <div class="text-center space-y-2">
                    <h2 class="text-lg font-semibold text-gray-800" id="recordingStatusText">ç·´ç¿’èˆ‡å­©å­å°è©±ä¸­</h2>
                    <p class="text-sm text-gray-600">
                        å·²è«‡è©± <span id="recordingTimer">00:00:00</span>
                    </p>
                </div>

                <!-- ä¸­å¤®åŒå¿ƒåœ“æ¼¸å±¤å’Œå»ºè­°æ–‡å­— -->
                <div class="flex-1 flex items-center justify-center w-full max-w-md">
                    <div id="suggestionCircle" class="relative w-80 h-80 rounded-full flex items-center justify-center shadow-2xl" style="background: radial-gradient(circle, #67e8f9 0%, #99f6e4 40%, #ccfbf1 70%, #f0fdfa 100%);">
                        <!-- å»ºè­°æ–‡å­— - åˆ†ç‚º Deep å’Œ Quick å…©è¡Œ -->
                        <div class="text-center px-8 space-y-3">
                            <!-- Deep Analysis (ä¸»è¦å»ºè­°) -->
                            <p id="liveSuggestion" class="text-2xl font-bold text-teal-900 leading-tight">
                                è®“å­©å­çŸ¥é“<br>ä½ ç«™åœ¨ä»–é€™é‚Š
                            </p>
                            <!-- Quick Feedback (å³æ™‚é¼“å‹µ) -->
                            <p id="quickFeedbackText" class="text-sm font-medium text-teal-700 leading-tight opacity-80">

                            </p>
                        </div>
                    </div>
                </div>

                <!-- åº•éƒ¨é ç•™ç©ºé–“ï¼ˆæŒ‰éˆ•åœ¨ fixed bottom barï¼‰ -->
                <div class="h-4"></div>
            </div>

            <!-- REQUIREMENT 6: Carousel Container with Persistent Circle (hidden initially, shown when analysis cards appear) -->
            <div id="mobileCarousel" class="hidden h-full flex flex-col">
                <!-- Top Section: Compact Suggestion Circle (shown when carousel is active) -->
                <div id="carouselSuggestionCircle" class="flex-shrink-0 mb-3 flex items-center justify-center">
                    <div id="carouselCircle" class="relative w-32 h-32 rounded-full flex items-center justify-center shadow-lg transition-all duration-300" style="background: radial-gradient(circle, #67e8f9 0%, #99f6e4 40%, #ccfbf1 70%, #f0fdfa 100%);">
                        <!-- Compact suggestion text - åˆ†ç‚º Deep å’Œ Quick å…©è¡Œ -->
                        <div class="text-center px-4 space-y-1">
                            <!-- Deep Analysis -->
                            <p id="carouselLiveSuggestion" class="text-sm font-bold text-teal-900 leading-tight">
                                è®“å­©å­çŸ¥é“<br>ä½ ç«™åœ¨ä»–é€™é‚Š
                            </p>
                            <!-- Quick Feedback -->
                            <p id="carouselQuickFeedbackText" class="text-xs font-medium text-teal-700 leading-tight opacity-80">

                            </p>
                        </div>
                    </div>
                </div>
                <!-- Carousel Header with Navigation -->
                <div class="flex items-center justify-between mb-3 flex-shrink-0">
                    <h3 class="text-base font-bold text-gray-800 flex items-center gap-2">
                        <span class="text-lg">ğŸ¤–</span>
                        <span>AI åˆ†æ</span>
                    </h3>
                    <div class="flex items-center gap-2">
                        <span id="carouselCounter" class="text-xs text-gray-500 font-medium">1 / 1</span>
                    </div>
                </div>

                <!-- Carousel Navigation Buttons -->
                <div class="relative flex-1 min-h-0">
                    <!-- Previous Button -->
                    <button id="carouselPrev" class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-2 z-10 w-10 h-10 bg-white/95 ios-frosted rounded-full ios-card-shadow flex items-center justify-center text-gray-700 hover:bg-gray-50 transition-smooth disabled:opacity-30 disabled:cursor-not-allowed" disabled>
                        <span class="text-xl">â†</span>
                    </button>

                    <!-- Card Container -->
                    <div class="overflow-hidden rounded-2xl h-full">
                        <div id="mobileCarouselTrack" class="flex transition-transform duration-300 ease-out h-full">
                            <!-- Cards will be inserted here via JavaScript -->
                        </div>
                    </div>

                    <!-- Next Button -->
                    <button id="carouselNext" class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-2 z-10 w-10 h-10 bg-white/95 ios-frosted rounded-full ios-card-shadow flex items-center justify-center text-gray-700 hover:bg-gray-50 transition-smooth disabled:opacity-30 disabled:cursor-not-allowed" disabled>
                        <span class="text-xl">â†’</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- MOBILE-ONLY: Fixed Bottom Navigation Bar (åªåœ¨éŒ„éŸ³æ™‚é¡¯ç¤º) -->
        <div id="recordingBottomBar" class="hidden md:hidden fixed bottom-0 left-0 right-0 bg-white/95 ios-frosted border-t border-gray-200/50 ios-card-shadow safe-area-inset-bottom z-50">
            <div class="px-4 py-4 flex gap-3">
                <!-- æš«åœæŒ‰éˆ• -->
                <button id="pauseBtnMobile" class="haptic-feedback btn-touch flex-1 bg-black active:bg-gray-800 text-white py-4 px-6 rounded-full font-bold text-base transition-smooth shadow-xl flex items-center justify-center gap-2">
                    <span class="text-2xl">â¸</span>
                    <span>æš«åœ</span>
                </button>

                <!-- çµæŸå°è©±æŒ‰éˆ• -->
                <button id="stopBtnMobile" class="haptic-feedback btn-touch flex-1 bg-white border-2 border-gray-800 text-gray-900 py-4 px-6 rounded-full font-semibold transition-smooth shadow-lg flex items-center justify-center gap-2">
                    <span class="text-xl">â¹</span>
                    <span>çµæŸå°è©±</span>
                </button>
            </div>
        </div>

        <!-- MOBILE-ONLY: Completion Screen (é¡¯ç¤ºåœ¨çµæŸå°è©±å¾Œ) -->
        <div id="completionScreen" class="hidden fixed inset-0 bg-gray-50 flex flex-col items-center justify-center px-8 z-50">
            <!-- Title -->
            <h1 class="text-4xl font-bold mb-4 text-gray-900">å¤ªæ£’äº†ï¼</h1>

            <!-- Subtitle with session duration -->
            <p class="text-gray-600 text-lg mb-12">
                å·²å®Œæˆ <span id="sessionDuration" class="font-semibold text-gray-900">00:00:00</span> çš„ç·´ç¿’
            </p>

            <!-- Buttons -->
            <div class="space-y-4 w-full max-w-xs">
                <!-- View Report Button (Black) -->
                <button id="viewReportBtn" class="haptic-feedback btn-touch w-full bg-black active:bg-gray-800 text-white rounded-full py-4 px-8 text-lg font-medium transition-smooth shadow-xl">
                    æŸ¥çœ‹å ±å‘Š
                </button>

                <!-- Return to Home Button (White with border) -->
                <button id="returnHomeBtn" class="haptic-feedback btn-touch w-full bg-white text-black border-2 border-black rounded-full py-4 px-8 text-lg font-medium transition-smooth shadow-lg">
                    å›åˆ°é¦–é 
                </button>
            </div>
        </div>

        <!-- MOBILE Loading Overlay for Report Generation -->
        <div id="reportLoadingOverlay" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50" style="z-index: 9999 !important; pointer-events: auto; display: none;">
            <div class="bg-white rounded-2xl p-8 shadow-2xl flex flex-col items-center space-y-6 max-w-md mx-4">
                <!-- Concentric circles gradient animation -->
                <div class="concentric-circles"></div>
                <!-- Loading text (removed "AI") -->
                <p class="text-2xl font-semibold text-gray-800">
                    ç”Ÿæˆå ±å‘Šä¸­<span class="loading-dot">.</span><span class="loading-dot">.</span><span class="loading-dot">.</span>
                </p>
                <p class="text-sm text-gray-500 text-center">è«‹ç¨å€™ç‰‡åˆ»</p>
            </div>
        </div>

        <!-- MOBILE-ONLY: Report Screen (é¡¯ç¤ºåœ¨é»æ“ŠæŸ¥çœ‹å ±å‘Šå¾Œ) -->
        <div id="reportScreen" class="hidden fixed inset-0 bg-gray-50 overflow-y-auto z-50 px-6 py-8">
            <div class="max-w-2xl mx-auto">
                <!-- Back button (top left) -->
                <button id="reportBackBtn" class="haptic-feedback btn-touch mb-6 text-gray-600 flex items-center gap-2 hover:text-gray-900 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                    <span class="font-medium">è¿”å›</span>
                </button>

                <!-- Summary Section (populated from API) -->
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-6 mb-8 shadow-sm border border-blue-100">
                    <div class="flex items-start gap-3">
                        <div class="flex-shrink-0 mt-1">
                            <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="flex-1">
                            <h2 class="text-lg font-semibold text-gray-900 mb-2">å°è©±æ‘˜è¦</h2>
                            <p id="reportSummary" class="text-gray-700 leading-relaxed">
                                <!-- Summary will be populated by JavaScript -->
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Highlights Section -->
                <h2 class="text-xl font-bold mb-6 text-center text-gray-900">
                    é€™æ¬¡å°è©±çš„äº®é»
                </h2>

                <!-- Highlight Cards Container -->
                <div id="highlightCards" class="space-y-4 mb-8">
                    <!-- Cards will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- DESKTOP LAYOUT (unchanged) -->
    <div class="container mx-auto px-4 md:px-6 py-4 md:py-6 max-w-7xl md:pb-6 hidden md:block">

        <!-- Demo Mode Instructions - Collapsible on Mobile -->
        <div class="bg-gradient-to-r from-yellow-50 to-amber-50 border-l-4 border-yellow-400 p-4 mb-4 md:mb-6 rounded-xl shadow-md card-hover" style="display: none">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-yellow-400 rounded-lg flex items-center justify-center">
                        <svg class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
                <div class="ml-3 flex-1">
                    <h3 class="text-sm md:text-base font-bold text-yellow-800 flex items-center gap-2">
                        <span>ğŸ­ Demo æ¨¡å¼èªªæ˜</span>
                        <span class="text-xs bg-yellow-200 text-yellow-800 px-2 py-0.5 rounded-full">ç„¡éœ€ API Key</span>
                    </h3>
                    <div class="mt-2 text-sm text-yellow-700 leading-relaxed">
                        <p class="mb-2">æ­¤ç‚ºå±•ç¤ºæ¨¡å¼ï¼Œä½¿ç”¨æ™ºæ…§å‡è³‡æ–™æ¨¡æ“¬å®Œæ•´åŠŸèƒ½ï¼š</p>
                        <ul class="space-y-1 ml-2">
                            <li class="flex items-center gap-2">
                                <kbd class="px-2 py-1 bg-white rounded border shadow-sm font-mono text-xs">T</kbd>
                                <span>æ’­æ”¾ä¸‹ä¸€å¥å°è©±ï¼ˆè‡ªå‹•åˆ‡æ›èªªè©±è€…ï¼‰</span>
                            </li>
                            <li class="flex items-center gap-2">
                                <kbd class="px-2 py-1 bg-white rounded border shadow-sm font-mono text-xs">R</kbd>
                                <span>é‡ç½®åŠ‡æœ¬å¾é ­é–‹å§‹</span>
                            </li>
                            <li class="flex items-center gap-2">
                                <kbd class="px-2 py-1 bg-white rounded border shadow-sm font-mono text-xs">1</kbd>
                                <span>åˆ‡æ›åˆ°ã€Œå·¥ä½œå£“åŠ›ã€åŠ‡æœ¬ï¼ˆå«è‡ªæ®ºé¢¨éšªåµæ¸¬ï¼‰</span>
                            </li>
                            <li class="flex items-center gap-2">
                                <kbd class="px-2 py-1 bg-white rounded border shadow-sm font-mono text-xs">2</kbd>
                                <span>åˆ‡æ›åˆ°ã€Œä¸€èˆ¬è«®è©¢ã€åŠ‡æœ¬</span>
                            </li>
                        </ul>
                        <p class="mt-3 font-bold bg-yellow-100 p-2 rounded-lg">ğŸ’¡ AI åˆ†ææ¯ 60 ç§’è‡ªå‹•è§¸ç™¼ï¼Œæ ¹æ“šé€å­—ç¨¿å…§å®¹æ™ºæ…§ç”Ÿæˆæ‘˜è¦ã€è­¦ç¤ºã€å»ºè­°ã€‚</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Left Panel: Recording Controls -->
            <div class="space-y-4">
                <!-- Recording Controls - Enhanced -->
                <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 card-hover border border-gray-100">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-8 h-8 bg-gradient-to-br from-red-500 to-pink-500 rounded-lg flex items-center justify-center">
                            <span class="text-white text-lg">ğŸ™ï¸</span>
                        </div>
                        <h2 class="text-lg md:text-xl font-bold text-gray-800">éŒ„éŸ³æ§åˆ¶</h2>
                    </div>

                    <!-- Timer Display - More Prominent -->
                    <div class="text-center mb-6 bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-4 md:p-6">
                        <div class="text-4xl md:text-5xl font-mono font-bold text-gray-800" id="timer">00:00</div>
                        <div class="text-xs md:text-sm text-gray-500 mt-2 font-medium">æœƒè«‡æ™‚é–“</div>
                    </div>

                    <!-- Start/Stop Buttons - Desktop -->
                    <div class="hidden md:grid md:grid-cols-2 gap-4 mb-6">
                        <button id="startBtn" class="btn-touch bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white py-4 px-6 rounded-xl font-bold transition-smooth shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                            <span class="text-xl">â–¶ï¸</span>
                            <span>é–‹å§‹æœƒè«‡</span>
                        </button>
                        <button id="stopBtn" class="btn-touch bg-gradient-to-r from-red-500 to-rose-600 text-white py-4 px-6 rounded-xl font-bold opacity-50 cursor-not-allowed shadow-md flex items-center justify-center gap-2" disabled>
                            <span class="text-xl">â¹ï¸</span>
                            <span>çµæŸæœƒè«‡</span>
                        </button>
                    </div>

                    <!-- Audio Waveform Animation -->
                    <div id="waveformContainer" class="waveform-container mb-4" style="display: none;">
                        <div class="waveform-bar"></div>
                        <div class="waveform-bar"></div>
                        <div class="waveform-bar"></div>
                        <div class="waveform-bar"></div>
                        <div class="waveform-bar"></div>
                        <div class="waveform-bar"></div>
                        <div class="waveform-bar"></div>
                        <div class="waveform-bar"></div>
                    </div>

                    <!-- Recording Timer Display -->
                    <div id="recordingTimerDisplay" class="text-center mb-6 bg-gradient-to-r from-teal-50 to-cyan-50 rounded-xl p-4 border border-teal-200" style="display: none;">
                        <div class="flex items-center justify-center gap-3">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                                <span class="text-sm font-medium text-gray-700">éŒ„éŸ³ä¸­</span>
                            </div>
                            <div class="recording-timer text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-teal-600 to-cyan-600" id="recordingTimerDesktop">00:00</div>
                        </div>
                    </div>

                    <!-- Audio Playback Controls (Demo Mode) -->
                    <div id="audioPlayerSection" class="mb-6 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-4 border border-purple-200" style="display: none;">
                        <div class="flex flex-col gap-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span class="text-lg">ğŸµ</span>
                                    <span class="text-sm font-bold text-gray-700">æ¨¡æ“¬éŸ³è¨Šæ’­æ”¾</span>
                                </div>
                                <span id="audioStatus" class="text-xs text-purple-600 font-medium">æº–å‚™ä¸­</span>
                            </div>

                            <!-- Audio Progress Bar -->
                            <div class="w-full bg-purple-200 rounded-full h-2 cursor-pointer" id="audioProgressContainer">
                                <div id="audioProgress" class="bg-gradient-to-r from-purple-500 to-indigo-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>

                            <!-- Playback Controls -->
                            <div class="flex items-center justify-between gap-2">
                                <button id="audioPlayBtn" class="btn-touch bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md flex items-center gap-2">
                                    <span id="audioPlayIcon">â–¶ï¸</span>
                                    <span id="audioPlayText">æ’­æ”¾å°è©±</span>
                                </button>
                                <div class="flex items-center gap-2 text-xs font-mono text-gray-600">
                                    <span id="audioCurrentTime">0:00</span>
                                    <span>/</span>
                                    <span id="audioDuration">0:00</span>
                                </div>
                            </div>

                            <p class="text-xs text-purple-700">
                                ğŸ’¡ éŸ³è¨Šæ’­æ”¾æ™‚ï¼Œé€å­—ç¨¿æœƒåŒæ­¥é¡¯ç¤ºã€‚é»æ“Šã€Œå³æ™‚åˆ†æã€å¯åˆ†æç•¶å‰å·²é¡¯ç¤ºçš„å°è©±å…§å®¹ã€‚
                            </p>
                        </div>
                    </div>

                    <!-- Provider Selection Toggle - Desktop -->
                    <div id="aiModelSectionDesktop" class="mb-4">
                        <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-4 border border-purple-200">
                            <div id="aiModelToggleRowDesktop" class="flex items-center justify-between">
                                <label class="text-sm font-bold text-gray-800 flex items-center gap-2">
                                    <span class="text-lg">ğŸ¤–</span>
                                    <span>AI æ¨¡å‹</span>
                                </label>
                                <div class="flex items-center gap-3">
                                    <span class="text-xs text-gray-600" id="providerDescriptionDesktop">é€Ÿåº¦å¿« Â· æ”¯æ´å¿«å–</span>
                                    <span class="text-sm text-gray-500" id="providerLabelDesktop">Gemini</span>
                                    <button id="providerToggleDesktop" class="relative inline-flex h-7 w-12 items-center rounded-full bg-gray-300 transition-colors focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2">
                                        <span id="providerToggleCircleDesktop" class="inline-block h-5 w-5 transform rounded-full bg-white shadow-lg transition-transform translate-x-1"></span>
                                    </button>
                                    <span id="providerLatencyDesktop" class="text-purple-600 font-mono text-sm hidden"></span>
                                </div>
                            </div>

                            <!-- Codeer Model Selector Desktop (shown only when Codeer is selected) -->
                            <div id="codeerModelSelectorDesktop" class="mt-4 pt-4 border-t border-purple-200 hidden">
                                <label class="text-xs font-semibold text-gray-700 mb-3 block">é¸æ“‡ Codeer æ¨¡å‹ <span class="text-gray-500 font-normal">Â· æ‰€æœ‰æ¨¡å‹å‡å·²é©—è­‰</span></label>
                                <div class="grid grid-cols-3 gap-3">
                                    <label class="flex flex-col gap-1 p-3 rounded-lg bg-white/70 hover:bg-white cursor-pointer transition-colors border border-purple-100">
                                        <div class="flex items-center gap-2">
                                            <input type="radio" name="codeerModelDesktop" value="gemini-flash" checked class="text-purple-600 focus:ring-purple-500">
                                            <span class="text-xs font-medium">ğŸ”® Gemini Flash</span>
                                        </div>
                                        <span class="text-xs text-green-600 font-semibold ml-5">æ¨è–¦ Â· ~10.6s</span>
                                    </label>
                                    <label class="flex flex-col gap-1 p-3 rounded-lg bg-white/70 hover:bg-white cursor-pointer transition-colors border border-purple-100">
                                        <div class="flex items-center gap-2">
                                            <input type="radio" name="codeerModelDesktop" value="claude-sonnet" class="text-purple-600 focus:ring-purple-500">
                                            <span class="text-xs font-medium">ğŸ¤– Claude Sonnet</span>
                                        </div>
                                        <span class="text-xs text-blue-600 ml-5">é«˜å“è³ª Â· ~10.3s</span>
                                    </label>
                                    <label class="flex flex-col gap-1 p-3 rounded-lg bg-white/70 hover:bg-white cursor-pointer transition-colors border border-purple-100">
                                        <div class="flex items-center gap-2">
                                            <input type="radio" name="codeerModelDesktop" value="gpt5-mini" class="text-purple-600 focus:ring-purple-500">
                                            <span class="text-xs font-medium">âš¡ GPT-5 Mini</span>
                                        </div>
                                        <span class="text-xs text-gray-600 ml-5">ç©©å®š Â· ~22.6s</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mode Toggle - Desktop -->
                    <div class="mb-4">
                        <div class="flex items-center justify-between bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-4 border border-purple-200">
                            <label class="text-sm font-bold text-gray-800 flex items-center gap-2">
                                <span class="text-lg">ğŸ¤</span>
                                <span id="modeToggleLabelDesktop">çœŸå¯¦éŒ„éŸ³</span>
                            </label>
                            <div class="flex items-center gap-2">
                                <span id="modeHintDesktop" class="text-xs text-gray-600">é–‹å•Ÿ = çœŸå¯¦</span>
                                <button id="modeToggleDesktop" class="relative inline-flex h-7 w-12 items-center rounded-full bg-green-600 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" role="switch" aria-checked="true" title="åˆ‡æ›çœŸå¯¦éŒ„éŸ³/Demoæ¨¡å¼">
                                    <span class="inline-block h-5 w-5 transform rounded-full bg-white shadow transition-transform translate-x-6"></span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Counseling Mode Toggle - Desktop -->
                    <div class="mb-4">
                        <div class="bg-gradient-to-r from-orange-50 to-red-50 rounded-xl p-4 border border-orange-200">
                            <label class="text-sm font-bold text-gray-800 flex items-center gap-2 mb-3">
                                <span class="text-lg">ğŸ¯</span>
                                <span>è«®è©¢æ¨¡å¼</span>
                            </label>
                            <div class="grid grid-cols-2 gap-3">
                                <button id="emergencyModeBtnDesktop" class="px-4 py-3 rounded-lg bg-red-500 text-white font-bold text-sm transition-all hover:bg-red-600 shadow-md hover:shadow-lg">
                                    ğŸš¨ å¯¦æˆ°
                                </button>
                                <button id="practiceModeBtnDesktop" class="px-4 py-3 rounded-lg bg-gray-200 text-gray-700 font-bold text-sm transition-all hover:bg-gray-300">
                                    ğŸ“ ç·´ç¿’
                                </button>
                            </div>
                            <p class="text-xs text-gray-600 mt-3">
                                ç·Šæ€¥ï¼š1-2 å¥å°ˆå®¶å»ºè­°ï¼ˆå¾ 200 å¥ä¸­é¸æ“‡ï¼‰<br>
                                ç·´ç¿’ï¼š3-4 å¥å°ˆå®¶å»ºè­°ï¼ˆå¾ 200 å¥ä¸­é¸æ“‡ï¼‰
                            </p>
                        </div>
                    </div>

                    <!-- Transcript Testing Shortcuts (Desktop) -->
                    <div class="mb-4">
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-200">
                            <label class="text-sm font-bold text-gray-800 flex items-center gap-2 mb-3">
                                <span class="text-lg">ğŸ§ª</span>
                                <span>å¿«é€Ÿæ¸¬è©¦</span>
                            </label>
                            <div class="grid grid-cols-3 gap-2 mb-3">
                                <button id="loadGreenBtnDesktop" class="px-3 py-2 rounded-lg bg-green-500 text-white font-bold text-sm transition-all hover:bg-green-600 shadow-md hover:shadow-lg">
                                    ğŸŸ¢ ç¶ ç‡ˆ
                                </button>
                                <button id="loadYellowBtnDesktop" class="px-3 py-2 rounded-lg bg-yellow-500 text-white font-bold text-sm transition-all hover:bg-yellow-600 shadow-md hover:shadow-lg">
                                    ğŸŸ¡ é»ƒç‡ˆ
                                </button>
                                <button id="loadRedBtnDesktop" class="px-3 py-2 rounded-lg bg-red-500 text-white font-bold text-sm transition-all hover:bg-red-600 shadow-md hover:shadow-lg">
                                    ğŸ”´ ç´…ç‡ˆ
                                </button>
                            </div>
                            <button id="quickTestAnalyzeBtnDesktop" class="w-full px-4 py-3 rounded-lg bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white font-semibold transition-all mb-3 shadow-md hover:shadow-lg">
                                âš¡ ç«‹å³åˆ†æ
                            </button>
                            <button id="clearTranscriptBtnDesktop" class="w-full px-3 py-2 rounded-lg bg-gray-200 text-gray-700 font-bold text-sm transition-all hover:bg-gray-300">
                                æ¸…é™¤å°è©±è¨˜éŒ„
                            </button>
                            <p class="text-xs text-gray-600 mt-3">
                                å¿«é€Ÿè¼‰å…¥æ¸¬è©¦å°è©±ï¼Œç„¡éœ€èªéŸ³è¾¨è­˜
                            </p>
                        </div>
                    </div>

                    <!-- Status Indicator - Enhanced -->
                    <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-4 border border-gray-200">
                        <div class="flex items-center justify-between text-sm mb-2">
                            <span class="font-bold text-gray-700">ç‹€æ…‹ï¼š</span>
                            <span id="status" class="text-gray-600 font-medium">å¾…æ©Ÿä¸­</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="font-bold text-gray-700">ä¸‹æ¬¡åˆ†æï¼š</span>
                            <span id="nextAnalysis" class="text-gray-600 font-medium">æœªé–‹å§‹</span>
                        </div>
                    </div>

                    <!-- Demo Mode Hint - Enhanced (hidden by default) -->
                    <div id="demoModeHintDesktop" class="mt-4 p-3 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl" style="display: none;">
                        <p class="text-xs md:text-sm text-blue-700 leading-relaxed">
                            ğŸ’¡ <strong>æ¸¬è©¦æ¨¡å¼</strong>ï¼šé»æ“Šä¸Šæ–¹ã€Œæ’­æ”¾å°è©±ã€æŒ‰éˆ•ï¼Œæˆ–æŒ‰ <kbd class="bg-blue-200 px-2 py-1 rounded font-mono text-xs">T</kbd> éµæ‰‹å‹•æ’­æ”¾ä¸‹ä¸€å¥
                        </p>
                    </div>
                </div>
            </div>

            <!-- Right Panel: AI Analysis Cards -->
            <div class="space-y-4">
                <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 card-hover border border-gray-100">
                <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-3 mb-4">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-lg flex items-center justify-center">
                            <span class="text-white text-lg">ğŸ¤–</span>
                        </div>
                        <h2 class="text-lg md:text-xl font-bold text-gray-800">AI å³æ™‚åˆ†æ</h2>
                    </div>
                    <div class="hidden md:flex gap-2 flex-wrap">
                        <button id="triggerAnalysisBtn" class="btn-touch bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white px-3 md:px-4 py-2 rounded-lg text-xs md:text-sm font-bold transition-smooth shadow-md opacity-50 cursor-not-allowed flex items-center gap-1" disabled>
                            <span>âš¡</span>
                            <span>ç«‹å³åˆ†æ</span>
                        </button>
                    </div>
                </div>

                <!-- Analysis Cards Container -->
                <div id="analysisCards" class="space-y-4 max-h-[600px] md:max-h-[800px] overflow-y-auto custom-scrollbar">
                    <!-- Empty State -->
                    <div class="flex flex-col items-center justify-center py-12 text-center" id="analysisEmpty">
                        <div class="w-16 h-16 md:w-20 md:h-20 bg-gradient-to-br from-purple-100 to-indigo-100 rounded-full flex items-center justify-center mb-4">
                            <span class="text-3xl md:text-4xl">ğŸ’¡</span>
                        </div>
                        <h3 class="text-base md:text-lg font-bold text-gray-800 mb-2">ç­‰å¾…åˆ†æ</h3>
                        <p class="text-gray-600 text-xs md:text-sm max-w-xs">
                            é»æ“Šã€Œç«‹å³åˆ†æã€æŸ¥çœ‹ AI ç£å°å»ºè­°
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Transcript Section - Collapsible (Moved to Bottom) -->
        <div class="mt-6 bg-white rounded-xl shadow-lg p-4 md:p-6 card-hover border border-gray-100 hidden md:block">
            <h2 class="text-lg md:text-xl font-bold mb-4 cursor-pointer flex justify-between items-center transition-smooth hover:text-teal-600" onclick="toggleTranscript()">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-gradient-to-br from-teal-500 to-cyan-500 rounded-lg flex items-center justify-center">
                        <span class="text-white text-lg">ğŸ“</span>
                    </div>
                    <span>å³æ™‚é€å­—ç¨¿</span>
                    <!-- Live Indicator -->
                    <div class="hidden" id="liveIndicator">
                        <span class="flex items-center gap-1 px-2 py-1 bg-red-500 text-white text-xs rounded-full animate-pulse">
                            <span class="w-2 h-2 bg-white rounded-full"></span>
                            <span class="font-bold">LIVE</span>
                        </span>
                    </div>
                </div>
                <span id="transcriptToggle" class="text-gray-400 transition-transform duration-300">â–¼</span>
            </h2>
            <div id="transcriptSection" class="hidden">
                <!-- Transcript Container - Chat-like -->
                <div id="transcript" class="h-[400px] md:h-[500px] overflow-y-auto bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 md:p-4 custom-scrollbar">
                    <!-- Empty State -->
                    <div class="flex flex-col items-center justify-center h-full text-center" id="transcriptEmpty">
                        <div class="w-16 h-16 md:w-20 md:h-20 bg-gray-200 rounded-full flex items-center justify-center mb-4">
                            <span class="text-3xl md:text-4xl">ğŸ’¬</span>
                        </div>
                        <h3 class="text-base md:text-lg font-bold text-gray-800 mb-2">é–‹å§‹æ–°æœƒè«‡</h3>
                        <p class="text-gray-600 text-xs md:text-sm">é»æ“Šã€Œé–‹å§‹æœƒè«‡ã€ï¼Œé–‹å§‹è¨˜éŒ„å°è©±</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Section (Collapsed by default) - Enhanced -->
        <div id="historyContainer" class="mt-6 bg-white rounded-xl shadow-lg p-4 md:p-6 card-hover border border-gray-100">
            <h2 class="text-lg md:text-xl font-bold mb-4 cursor-pointer flex justify-between items-center transition-smooth hover:text-indigo-600" onclick="toggleHistory()">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-gradient-to-br from-gray-500 to-gray-600 rounded-lg flex items-center justify-center">
                        <span class="text-white text-lg">ğŸ“Š</span>
                    </div>
                    <span>æ­·å²è¨˜éŒ„</span>
                </div>
                <span id="historyToggle" class="text-gray-400 transition-transform duration-300">â–¼</span>
            </h2>
            <div id="historySection" class="hidden">
                <button onclick="clearHistory()" class="btn-touch bg-gradient-to-r from-red-500 to-rose-600 hover:from-red-600 hover:to-rose-700 text-white px-4 py-2 rounded-lg mb-4 transition-smooth shadow-md hover:shadow-lg flex items-center gap-2">
                    <span>ğŸ—‘ï¸</span>
                    <span>æ¸…é™¤æ­·å²</span>
                </button>
                <div id="historyList" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <script type="module">
        // === Feature Flags ===
        // Check URL parameter for Codeer feature flag
        const urlParams = new URLSearchParams(window.location.search);
        const SHOW_CODEER = urlParams.get('show_codeer') === 'true';

        if (!SHOW_CODEER) {
            console.log('ğŸ”’ Codeer models hidden (default). Use ?show_codeer=true to enable.');
        } else {
            console.log('ğŸ”“ Codeer models enabled via URL parameter');
        }

        // === New Session Workflow Feature Flag ===
        // Set to true to use new modular session workflow (iOS-style)
        // Set to false to use legacy realtime analyze API
        const USE_NEW_SESSION_WORKFLOW = true;
        console.log(`ğŸ”§ Session Workflow: ${USE_NEW_SESSION_WORKFLOW ? 'NEW (modular)' : 'LEGACY (realtime)'}`);

        // Import SessionWorkflow module dynamically
        let SessionWorkflow = null;
        let sessionWorkflow = null;

        if (USE_NEW_SESSION_WORKFLOW) {
            import('/static/js/session-workflow.js').then(module => {
                SessionWorkflow = module.SessionWorkflow;
                sessionWorkflow = new SessionWorkflow();
                console.log('âœ… SessionWorkflow module loaded');
            }).catch(error => {
                console.error('âŒ Failed to load SessionWorkflow module:', error);
            });
        }

        // === State Management ===
        let isRecording = false;
        let isPaused = false; // NEW: Track pause state
        let pausedTime = 0; // NEW: Track paused duration
        let pauseStartTime = null; // NEW: Track when pause started
        let currentSpeaker = 'counselor';
        let startTime = null;
        let timerInterval = null;
        let analysisInterval = null;
        let transcriptSegments = []; // Only stores DISPLAYED transcript segments
        let lastAutoAnalysisTime = 0; // Track last auto-analysis to prevent duplicates
        let analysisHistory = [];
        let isDemoMode = false; // Default to real recording, toggle switches to demo mode

        // Dynamic analysis interval based on safety_level
        let nextAnalysisInterval = 60; // Default 60 seconds
        let lastSafetyLevel = 'green';
        let lastQuickFeedbackTime = 0; // Track last quick feedback call (every 10 seconds)
        let isVoiceSimEnabled = false; // Voice simulation toggle state (demo mode only)
        let currentProvider = 'gemini'; // 'gemini' or 'codeer' - Force to 'gemini' if Codeer is hidden
        let currentCodeerModel = 'gemini-flash'; // Codeer model selection (default: Gemini 2.5 Flash - fastest + best quality balance)
        let counselingMode = 'emergency'; // 'emergency' or 'practice' - Default to emergency for real-time counseling

        // === ElevenLabs Real-time STT State ===
        let elevenLabsWs = null; // WebSocket connection
        let audioContext = null; // Web Audio API context
        let audioWorkletNode = null; // AudioWorklet for PCM processing
        let audioStream = null; // MediaStream from microphone
        let partialTranscriptText = ''; // Temporary storage for partial transcript
        let elevenlabsToken = null; // Token from backend

        // === Audio Simulation State ===
        let audioSimulation = {
            isPlaying: false,
            currentTime: 0,
            duration: 0,
            lastDisplayedIndex: 0, // Track which script lines have been displayed
            animationFrame: null,
            startTimeMs: 0 // When playback started (performance.now())
        };

        // === Web Speech API (TTS) State ===
        let ttsState = {
            voices: [],
            counselorVoice: null,
            clientVoice: null,
            isSupported: 'speechSynthesis' in window,
            currentUtterance: null
        };

        // === Inactivity Timeout State ===
        let lastActivityTime = Date.now();
        let inactivityCheckInterval = null;
        let countdownInterval = null;

        // === Analysis State ===
        let isAnalyzing = false; // Global flag to prevent concurrent analysis
        let sessionMode = 'practice'; // 'practice' or 'realTalk'
        let currentSessionId = null; // Global session ID for unified tracking

        // === DOM Elements ===
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const practiceBtn = document.getElementById('practiceBtn');
        const realTalkBtn = document.getElementById('realTalkBtn');
        const pauseBtnMobile = document.getElementById('pauseBtnMobile');
        const stopBtnMobile = document.getElementById('stopBtnMobile');
        const timer = document.getElementById('timer');
        const status = document.getElementById('status');
        const nextAnalysis = document.getElementById('nextAnalysis');
        const transcript = document.getElementById('transcript');
        const analysisCards = document.getElementById('analysisCards');
        const speakerCounselorBtn = document.getElementById('speakerCounselor');
        const speakerClientBtn = document.getElementById('speakerClient');
        const speakerToggleSection = document.getElementById('speakerToggleSection');
        const triggerAnalysisBtn = document.getElementById('triggerAnalysisBtn');
        const liveIndicator = document.getElementById('liveIndicator');
        const transcriptEmpty = document.getElementById('transcriptEmpty');
        const analysisEmpty = document.getElementById('analysisEmpty');
        const fabAnalyzeMobile = document.getElementById('fabAnalyzeMobile');
        const waveformContainer = document.getElementById('waveformContainer');
        const waveformContainerMobile = document.getElementById('waveformContainerMobile');
        const recordingTimerDisplay = document.getElementById('recordingTimerDisplay');
        const recordingTimerDisplayMobile = document.getElementById('recordingTimerDisplayMobile');
        const recordingTimer = document.getElementById('recordingTimer'); // Mobile recording UI timer
        const recordingTimerDesktop = document.getElementById('recordingTimerDesktop'); // Desktop recording timer display
        const recordingTimerMobile = document.getElementById('recordingTimerMobile'); // Mobile compact waveform timer
        const modeToggle = document.getElementById('modeToggle');
        const modeToggleDesktop = document.getElementById('modeToggleDesktop');
        const modeToggleLabel = document.getElementById('modeToggleLabel');
        const modeToggleLabelDesktop = document.getElementById('modeToggleLabelDesktop');
        const modeHint = document.getElementById('modeHint');
        const modeHintDesktop = document.getElementById('modeHintDesktop');

        // NEW: Mobile-specific elements for requirements 3, 4, 6
        const mainHeader = document.getElementById('mainHeader');
        const initialUI = document.getElementById('initialUI');
        const practiceIntroUI = document.getElementById('practiceIntroUI');
        const createPracticeBtn = document.getElementById('createPracticeBtn');
        const homeBtn = document.getElementById('homeBtn');
        const backToInitialBtn = document.getElementById('backToInitialBtn');
        const recordingUI = document.getElementById('recordingUI');
        const recordingBottomBar = document.getElementById('recordingBottomBar');
        const mobileCarousel = document.getElementById('mobileCarousel');
        const mobileCarouselTrack = document.getElementById('mobileCarouselTrack');
        const carouselPrev = document.getElementById('carouselPrev');
        const carouselNext = document.getElementById('carouselNext');
        const carouselCounter = document.getElementById('carouselCounter');

        // Completion Screen Elements
        const completionScreen = document.getElementById('completionScreen');
        const sessionDuration = document.getElementById('sessionDuration');
        const viewReportBtn = document.getElementById('viewReportBtn');
        const returnHomeBtn = document.getElementById('returnHomeBtn');

        // Report Screen Elements
        const reportScreen = document.getElementById('reportScreen');
        const reportBackBtn = document.getElementById('reportBackBtn');
        const highlightCards = document.getElementById('highlightCards');

        // Settings Modal Elements
        const settingsBtnMobile = document.getElementById('settingsBtnMobile');
        const settingsModal = document.getElementById('settingsModal');
        const settingsModalBackdrop = document.getElementById('settingsModalBackdrop');
        const settingsModalContent = document.getElementById('settingsModalContent');
        const settingsModalClose = document.getElementById('settingsModalClose');

        // Audio Player Elements
        const audioPlayerSection = document.getElementById('audioPlayerSection');
        const audioPlayBtn = document.getElementById('audioPlayBtn');
        const audioPlayIcon = document.getElementById('audioPlayIcon');
        const audioPlayText = document.getElementById('audioPlayText');
        const audioProgress = document.getElementById('audioProgress');
        const audioProgressContainer = document.getElementById('audioProgressContainer');
        const audioCurrentTime = document.getElementById('audioCurrentTime');
        const audioDuration = document.getElementById('audioDuration');
        const audioStatus = document.getElementById('audioStatus');

        // Carousel state
        let mobileAnalysisCards = [];
        let currentCarouselIndex = 0;

        // === Counseling Mode Setup (must be before event listeners) ===
        const emergencyModeBtn = document.getElementById('emergencyModeBtn');
        const practiceModeBtn = document.getElementById('practiceModeBtn');
        const emergencyModeBtnDesktop = document.getElementById('emergencyModeBtnDesktop');
        const practiceModeBtnDesktop = document.getElementById('practiceModeBtnDesktop');

        function setCounselingMode(mode) {
            counselingMode = mode;

            // Update mobile button styles with consistent hover effects
            if (emergencyModeBtn && practiceModeBtn) {
                if (mode === 'emergency') {
                    emergencyModeBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                    emergencyModeBtn.classList.add('bg-red-500', 'text-white', 'hover:bg-red-600');
                    practiceModeBtn.classList.remove('bg-green-500', 'text-white', 'hover:bg-green-600');
                    practiceModeBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                } else {
                    practiceModeBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                    practiceModeBtn.classList.add('bg-green-500', 'text-white', 'hover:bg-green-600');
                    emergencyModeBtn.classList.remove('bg-red-500', 'text-white', 'hover:bg-red-600');
                    emergencyModeBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                }
            }

            // Update desktop button styles
            if (emergencyModeBtnDesktop && practiceModeBtnDesktop) {
                if (mode === 'emergency') {
                    emergencyModeBtnDesktop.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                    emergencyModeBtnDesktop.classList.add('bg-red-500', 'text-white', 'hover:bg-red-600');
                    practiceModeBtnDesktop.classList.remove('bg-green-500', 'text-white', 'hover:bg-green-600');
                    practiceModeBtnDesktop.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                } else {
                    practiceModeBtnDesktop.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                    practiceModeBtnDesktop.classList.add('bg-green-500', 'text-white', 'hover:bg-green-600');
                    emergencyModeBtnDesktop.classList.remove('bg-red-500', 'text-white', 'hover:bg-red-600');
                    emergencyModeBtnDesktop.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                }
            }

            console.log(`âœ… åˆ‡æ›è«®è©¢æ¨¡å¼: ${mode}`);
        }

        // === Event Listeners ===
        startBtn.addEventListener('click', startSession);
        stopBtn.addEventListener('click', stopSession);

        // Mobile flow: Practice button shows intro screen
        if (practiceBtn) {
            practiceBtn.addEventListener('click', () => {
                sessionMode = 'practice';
                // Sync consultation mode to 'practice'
                setCounselingMode('practice');
                if (initialUI) initialUI.classList.add('hidden');
                if (practiceIntroUI) practiceIntroUI.classList.remove('hidden');
                // Update button text for practice mode
                if (createPracticeBtn) {
                    createPracticeBtn.textContent = 'å‰µå»ºç·´ç¿’';
                }
            });
        }

        // Mobile flow: Real talk button shows intro screen
        if (realTalkBtn) {
            realTalkBtn.addEventListener('click', () => {
                sessionMode = 'realTalk';
                // Sync consultation mode to 'emergency' (å¯¦æˆ°)
                setCounselingMode('emergency');
                if (initialUI) initialUI.classList.add('hidden');
                if (practiceIntroUI) practiceIntroUI.classList.remove('hidden');
                // Update button text for real talk mode
                if (createPracticeBtn) {
                    createPracticeBtn.textContent = 'é–‹å§‹å°è©±';
                }
            });
        }

        // Mobile flow: Create practice/real talk button starts recording
        if (createPracticeBtn) {
            createPracticeBtn.addEventListener('click', () => {
                if (practiceIntroUI) practiceIntroUI.classList.add('hidden');
                startSession();
            });
        }

        // Navigation buttons for Practice Intro UI
        if (homeBtn) {
            homeBtn.addEventListener('click', () => {
                location.reload();
            });
        }

        if (backToInitialBtn) {
            backToInitialBtn.addEventListener('click', () => {
                if (practiceIntroUI) practiceIntroUI.classList.add('hidden');
                if (initialUI) initialUI.classList.remove('hidden');
            });
        }

        if (pauseBtnMobile) pauseBtnMobile.addEventListener('click', togglePause);
        if (stopBtnMobile) stopBtnMobile.addEventListener('click', stopSession);
        // Speaker buttons removed (AI auto-detects speakers)
        triggerAnalysisBtn.addEventListener('click', manuallyTriggerAnalysis);
        if (fabAnalyzeMobile) fabAnalyzeMobile.addEventListener('click', manuallyTriggerAnalysis);

        // NEW: Carousel navigation
        if (carouselPrev) carouselPrev.addEventListener('click', () => navigateCarousel(-1));
        if (carouselNext) carouselNext.addEventListener('click', () => navigateCarousel(1));

        // Completion Screen Buttons
        if (viewReportBtn) {
            viewReportBtn.addEventListener('click', async () => {
                console.log('ğŸ”˜ æŸ¥çœ‹å ±å‘ŠæŒ‰éˆ•è¢«é»æ“Šäº†ï¼');

                // Show loading overlay
                const loadingOverlay = document.getElementById('reportLoadingOverlay');
                console.log('ğŸ“¦ Loading overlay element:', loadingOverlay);

                if (loadingOverlay) {
                    loadingOverlay.classList.remove('hidden');
                    loadingOverlay.style.display = 'flex';  // Force flex display
                    loadingOverlay.style.position = 'fixed';
                    loadingOverlay.style.inset = '0';
                    loadingOverlay.style.zIndex = '9999';
                    loadingOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                    loadingOverlay.style.alignItems = 'center';
                    loadingOverlay.style.justifyContent = 'center';
                    console.log('âœ… Loading overlay é¡¯ç¤ºæˆåŠŸ with forced styles');
                } else {
                    console.error('âŒ æ‰¾ä¸åˆ° loading overlay element!');
                }

                // Disable all buttons
                viewReportBtn.disabled = true;
                if (returnHomeBtn) returnHomeBtn.disabled = true;
                console.log('ğŸ”’ æŒ‰éˆ•å·²ç¦ç”¨');

                // Change button text to "ç”Ÿæˆå ±å‘Šä¸­..." with bouncing dots
                viewReportBtn.innerHTML = 'ç”Ÿæˆå ±å‘Šä¸­<span class="loading-dot">.</span><span class="loading-dot">.</span><span class="loading-dot">.</span>';
                console.log('ğŸ“ æŒ‰éˆ•æ–‡å­—å·²è®Šæ›´ç‚ºã€Œç”Ÿæˆå ±å‘Šä¸­...ã€');

                try {
                    // Call new parents-report API
                    const fullTranscript = transcriptSegments.map(seg =>
                        `${seg.speaker === 'counselor' ? 'å®¶é•·' : 'å­©å­'}ï¼š${seg.text}`
                    ).join('\n');

                    const response = await fetch('/api/v1/realtime/parents-report', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            transcript: fullTranscript,
                            session_id: currentSessionId  // Use unified session ID
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }

                    const reportData = await response.json();
                    console.log('ğŸ“Š Parents report generated:', reportData);

                    // Hide loading overlay
                    if (loadingOverlay) {
                        loadingOverlay.classList.add('hidden');
                        loadingOverlay.style.display = 'none';  // Force hide
                    }

                    // Hide completion screen
                    if (completionScreen) completionScreen.classList.add('hidden');

                    // Populate report with real API data
                    populateReportFromAPI(reportData);

                    // Show report screen
                    if (reportScreen) reportScreen.classList.remove('hidden');

                } catch (error) {
                    console.error('Failed to generate report:', error);

                    // Hide loading overlay
                    if (loadingOverlay) {
                        loadingOverlay.classList.add('hidden');
                        loadingOverlay.style.display = 'none';  // Force hide
                    }

                    alert('å ±å‘Šç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                } finally {
                    // Reset button text back to "æŸ¥çœ‹å ±å‘Š"
                    viewReportBtn.innerHTML = 'æŸ¥çœ‹å ±å‘Š';
                    // Re-enable buttons
                    viewReportBtn.disabled = false;
                    if (returnHomeBtn) returnHomeBtn.disabled = false;
                }
            });
        }

        // Report Screen Back Button
        if (reportBackBtn) {
            reportBackBtn.addEventListener('click', () => {
                // Hide report screen
                if (reportScreen) reportScreen.classList.add('hidden');

                // Show completion screen
                if (completionScreen) completionScreen.classList.remove('hidden');
            });
        }

        if (returnHomeBtn) {
            returnHomeBtn.addEventListener('click', () => {
                location.reload();
            });
        }

        // Settings Modal Control
        if (settingsBtnMobile) {
            settingsBtnMobile.addEventListener('click', openSettingsModal);
        }
        if (settingsModalBackdrop) {
            settingsModalBackdrop.addEventListener('click', closeSettingsModal);
        }
        if (settingsModalClose) {
            settingsModalClose.addEventListener('click', closeSettingsModal);
        }

        // Mode Toggle (Demo/Real)
        modeToggle.addEventListener('click', toggleRecordingMode);
        if (modeToggleDesktop) modeToggleDesktop.addEventListener('click', toggleRecordingMode);

        // Counseling Mode Toggle event listeners (Emergency/Practice)
        // (Function definition and DOM elements are above, before all event listeners)
        if (emergencyModeBtn) emergencyModeBtn.addEventListener('click', () => setCounselingMode('emergency'));
        if (practiceModeBtn) practiceModeBtn.addEventListener('click', () => setCounselingMode('practice'));
        if (emergencyModeBtnDesktop) emergencyModeBtnDesktop.addEventListener('click', () => setCounselingMode('emergency'));
        if (practiceModeBtnDesktop) practiceModeBtnDesktop.addEventListener('click', () => setCounselingMode('practice'));

        // === Preset Transcript Testing Shortcuts ===
        // Preset transcripts based on test_10min_realtime_simulation.py
        const PRESET_TRANSCRIPTS = {
            green: [
                { speaker: 'counselor', text: 'å¯¶è²ï¼Œä»Šå¤©åœ¨å­¸æ ¡æ€éº¼æ¨£ï¼Ÿ', time: 0 },
                { speaker: 'client', text: 'é‚„å¥½å•¦ã€‚', time: 3 },
                { speaker: 'counselor', text: 'è€å¸«æœ‰èªªä»€éº¼å—ï¼Ÿ', time: 5 },
                { speaker: 'client', text: 'æ²’æœ‰ç‰¹åˆ¥èªªä»€éº¼ã€‚', time: 8 },
                { speaker: 'counselor', text: 'é‚£æ•¸å­¸è€ƒè©¦æ€éº¼æ¨£ï¼Ÿ', time: 11 },
                { speaker: 'client', text: 'é‚„æ²’ç™¼ä¸‹ä¾†ã€‚', time: 14 },
                { speaker: 'counselor', text: 'å–”ï¼Œé‚£ç­‰ç™¼ä¸‹ä¾†è·Ÿåª½åª½èªªä¸€è²ã€‚', time: 17 },
                { speaker: 'client', text: 'å¥½ã€‚', time: 20 }
            ],
            yellow: [
                { speaker: 'counselor', text: 'å’¦ï¼Œé€™æ˜¯ä»€éº¼ï¼Ÿæ•¸å­¸è€ƒå·å—ï¼Ÿ', time: 0 },
                { speaker: 'client', text: 'å•Šé‚£å€‹', time: 3 },
                { speaker: 'counselor', text: '65åˆ†ï¼Ÿä½ æ°£æ­»æˆ‘äº†ï¼ä¸Šæ¬¡ä¸æ˜¯è€ƒ85åˆ†å—ï¼Ÿ', time: 5 },
                { speaker: 'client', text: 'é€™æ¬¡æ¯”è¼ƒé›£å•¦', time: 9 },
                { speaker: 'counselor', text: 'ä½ ç…©æ­»æˆ‘äº†ï¼åˆä¸€ç›´ç©æ‰‹æ©Ÿä¸è½è©±', time: 12 },
                { speaker: 'client', text: 'æˆ‘æœ‰èªçœŸè®€å•Š', time: 16 },
                { speaker: 'counselor', text: 'ä½ èªªè¬Šï¼æˆ‘å—å¤ äº†ï¼æ¯æ¬¡éƒ½é€™æ¨£', time: 19 },
                { speaker: 'client', text: 'æˆ‘å¿«å´©æ½°äº†ï¼ç‚ºä»€éº¼ä½ éƒ½ä¸ç›¸ä¿¡æˆ‘ï¼', time: 24 }
            ],
            red: [
                { speaker: 'counselor', text: 'ä½ çµ¦æˆ‘æ»¾å‡ºå»ï¼é€™æ˜¯ä»€éº¼æˆç¸¾ï¼Ÿ', time: 0 },
                { speaker: 'client', text: 'æˆ‘...', time: 3 },
                { speaker: 'counselor', text: '50åˆ†ï¼æ‰“æ­»ä½ ç®—äº†ï¼ä½ é‚„æƒ³ä¸æƒ³è®€æ›¸ï¼Ÿ', time: 5 },
                { speaker: 'client', text: 'æˆ‘å—ä¸äº†äº†...', time: 10 },
                { speaker: 'counselor', text: 'å—ä¸äº†ï¼Ÿæˆ‘æ‰å—ä¸äº†ä½ é€™æ¨£ï¼', time: 13 },
                { speaker: 'client', text: 'æˆ‘ä¸æƒ³æ´»äº†', time: 18 },
                { speaker: 'counselor', text: 'ä½ èªªä»€éº¼ï¼Ÿä¸æƒ³æ´»ï¼Ÿä½ çŸ¥é“ä½ åœ¨èªªä»€éº¼å—ï¼Ÿ', time: 21 },
                { speaker: 'client', text: 'æˆ‘çœŸçš„ä¸æƒ³æ´»äº†...', time: 27 },
                { speaker: 'counselor', text: 'ä½ é€™æ¨£èªªæˆ‘æ¨æ­»ä½ äº†ï¼', time: 32 }
            ]
        };

        // Function to load preset transcript
        function loadPresetTranscript(safetyLevel) {
            const preset = PRESET_TRANSCRIPTS[safetyLevel];
            if (!preset) {
                console.error(`Unknown safety level: ${safetyLevel}`);
                return;
            }

            console.log(`ğŸ§ª Loading ${safetyLevel.toUpperCase()} preset transcript (${preset.length} segments)`);

            // Clear existing transcript
            clearTranscript();

            // Load preset segments
            preset.forEach(segment => {
                addTranscriptLine(segment.speaker, segment.text);
            });

            console.log(`âœ… Loaded ${preset.length} transcript segments`);
        }

        // Function to clear transcript
        function clearTranscript() {
            transcriptSegments = [];
            const transcript = document.getElementById('transcript');
            if (transcript) {
                // Keep only the header
                const header = transcript.querySelector('.text-xs.text-gray-500.mb-3');
                transcript.innerHTML = '';
                if (header) {
                    transcript.appendChild(header);
                }
            }

            console.log('ğŸ—‘ï¸ Transcript cleared');
        }

        // Event listeners for mobile shortcut buttons
        const loadGreenBtn = document.getElementById('loadGreenBtn');
        const loadYellowBtn = document.getElementById('loadYellowBtn');
        const loadRedBtn = document.getElementById('loadRedBtn');
        const quickTestAnalyzeBtn = document.getElementById('quickTestAnalyzeBtn');
        const quickTestAnalyzeBtnDesktop = document.getElementById('quickTestAnalyzeBtnDesktop');
        const clearTranscriptBtn = document.getElementById('clearTranscriptBtn');

        if (loadGreenBtn) loadGreenBtn.addEventListener('click', () => loadPresetTranscript('green'));
        if (loadYellowBtn) loadYellowBtn.addEventListener('click', () => loadPresetTranscript('yellow'));
        if (loadRedBtn) loadRedBtn.addEventListener('click', () => loadPresetTranscript('red'));
        if (quickTestAnalyzeBtn) quickTestAnalyzeBtn.addEventListener('click', analyzeTranscript);
        if (clearTranscriptBtn) clearTranscriptBtn.addEventListener('click', clearTranscript);

        // Event listeners for desktop shortcut buttons
        const loadGreenBtnDesktop = document.getElementById('loadGreenBtnDesktop');
        const loadYellowBtnDesktop = document.getElementById('loadYellowBtnDesktop');
        const loadRedBtnDesktop = document.getElementById('loadRedBtnDesktop');
        const clearTranscriptBtnDesktop = document.getElementById('clearTranscriptBtnDesktop');

        if (loadGreenBtnDesktop) loadGreenBtnDesktop.addEventListener('click', () => loadPresetTranscript('green'));
        if (loadYellowBtnDesktop) loadYellowBtnDesktop.addEventListener('click', () => loadPresetTranscript('yellow'));
        if (loadRedBtnDesktop) loadRedBtnDesktop.addEventListener('click', () => loadPresetTranscript('red'));
        if (quickTestAnalyzeBtnDesktop) quickTestAnalyzeBtnDesktop.addEventListener('click', analyzeTranscript);
        if (clearTranscriptBtnDesktop) clearTranscriptBtnDesktop.addEventListener('click', clearTranscript);

        // Audio Player Controls
        if (audioPlayBtn) audioPlayBtn.addEventListener('click', toggleAudioPlayback);
        if (audioProgressContainer) {
            audioProgressContainer.addEventListener('click', (e) => {
                const rect = audioProgressContainer.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const percentage = clickX / rect.width;
                seekAudio(percentage);
            });
        }

        // === Initialization ===
        // Initialize Web Speech API (TTS)
        initializeSpeechSynthesis();

        // Initialize provider toggle
        setupProviderToggle();
        setupCodeerModelSelector();
        updateProviderUI();

        // Hide Codeer-related UI if feature flag is not set
        if (!SHOW_CODEER) {
            // Hide mobile AI model toggle (Gemini/Codeer buttons)
            const aiModelToggleMobile = document.getElementById('aiModelToggleRowMobile');
            if (aiModelToggleMobile) {
                aiModelToggleMobile.style.display = 'none';
            }

            // Hide mobile Codeer sub-model selector
            const codeerModelSelectorMobile = document.getElementById('codeerModelSelector');
            if (codeerModelSelectorMobile) {
                codeerModelSelectorMobile.style.display = 'none';
            }

            // Hide desktop AI model toggle (Gemini/Codeer buttons)
            const aiModelToggleDesktop = document.getElementById('aiModelToggleRowDesktop');
            if (aiModelToggleDesktop) {
                aiModelToggleDesktop.style.display = 'none';
            }

            // Hide desktop Codeer sub-model selector
            const codeerModelSelectorDesktop = document.getElementById('codeerModelSelectorDesktop');
            if (codeerModelSelectorDesktop) {
                codeerModelSelectorDesktop.style.display = 'none';
            }

            // Force provider to Gemini
            currentProvider = 'gemini';

            console.log('âœ… Codeer UI elements hidden. Provider locked to Gemini.');
        }

        // === ElevenLabs Real-time STT Functions ===

        /**
         * Start real recording with ElevenLabs WebSocket + MediaRecorder
         */
        async function startRealRecording() {
            // Step 1: Get single-use token from backend
            console.log('ğŸ“ å‘¼å«å¾Œç«¯å–å¾— ElevenLabs token...');
            const tokenResponse = await fetch('/api/v1/realtime/elevenlabs-token', {
                method: 'POST'
            });

            if (!tokenResponse.ok) {
                throw new Error(`Token ç”Ÿæˆå¤±æ•—: ${tokenResponse.status}`);
            }

            const { token } = await tokenResponse.json();
            elevenlabsToken = token;
            console.log('âœ… Token å–å¾—æˆåŠŸ');

            // Step 2: Request microphone access
            try {
                audioStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        channelCount: 1,
                        sampleRate: 16000, // 16kHz for speech (ElevenLabs supports 8-48kHz)
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                console.log('âœ… Microphone access granted');
            } catch (error) {
                throw new Error(`éº¥å…‹é¢¨å­˜å–å¤±æ•—: ${error.message}`);
            }

            // Step 3: Establish WebSocket connection to ElevenLabs
            // All configuration goes in query parameters, not as JSON message
            // Use "token" parameter (browsers can't set custom headers in WebSocket)
            const wsUrl = `wss://api.elevenlabs.io/v1/speech-to-text/realtime?` +
                `token=${elevenlabsToken}` +
                `&audio_format=pcm_16000` +
                `&language=zh` +  // Chinese (same as test page)
                `&commit_strategy=vad`;  // Auto-commit with Voice Activity Detection

            console.log('ğŸ”Œ Connecting to ElevenLabs WebSocket...');
            elevenLabsWs = new WebSocket(wsUrl);

            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    reject(new Error('WebSocket é€£ç·šè¶…æ™‚'));
                }, 10000); // 10 second timeout

                elevenLabsWs.onopen = () => {
                    clearTimeout(timeout);
                    console.log('âœ… ElevenLabs WebSocket connected');
                    console.log('â³ Waiting for session_started message...');

                    // No need to send config - it's all in the URL query parameters
                    // Wait for session_started confirmation before starting audio

                    // Step 3: Start AudioContext to capture PCM audio
                    startAudioCapture();

                    // Start inactivity monitoring
                    startInactivityMonitoring();
                    resetInactivityTimer();

                    resolve();
                };

                elevenLabsWs.onmessage = (event) => {
                    handleElevenLabsMessage(event.data);
                };

                elevenLabsWs.onerror = (error) => {
                    clearTimeout(timeout);
                    console.error('âŒ WebSocket error:', error);
                    reject(new Error('WebSocket é€£ç·šéŒ¯èª¤'));
                };

                elevenLabsWs.onclose = (event) => {
                    console.log('ğŸ”Œ WebSocket closed:', event.code, event.reason);
                    if (!event.wasClean) {
                        console.warn('âš ï¸ WebSocket closed unexpectedly');
                    }
                };
            });
        }

        /**
         * Start AudioContext to capture and stream PCM audio
         */
        function startAudioCapture() {
            // Create AudioContext with 16kHz sample rate (ElevenLabs requirement)
            audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
            const source = audioContext.createMediaStreamSource(audioStream);

            // Create ScriptProcessorNode for audio processing (4096 buffer size)
            const bufferSize = 4096;
            const processor = audioContext.createScriptProcessor(bufferSize, 1, 1);

            processor.onaudioprocess = (e) => {
                // Don't send audio if paused
                if (isPaused) return;

                if (elevenLabsWs && elevenLabsWs.readyState === WebSocket.OPEN) {
                    // Get PCM float32 audio data
                    const inputData = e.inputBuffer.getChannelData(0);

                    // Calculate RMS (Root Mean Square) to detect if there's actual audio
                    const rms = Math.sqrt(inputData.reduce((sum, val) => sum + val * val, 0) / inputData.length);
                    if (rms > 0.01) {  // Only log if there's actual audio signal
                        console.log('ğŸµ Audio chunk captured - RMS:', rms.toFixed(4), 'samples:', inputData.length);
                    }

                    // Convert Float32 to Int16 (PCM S16LE)
                    const pcmData = new Int16Array(inputData.length);
                    for (let i = 0; i < inputData.length; i++) {
                        // Clamp to [-1, 1] and convert to 16-bit
                        const s = Math.max(-1, Math.min(1, inputData[i]));
                        pcmData[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                    }

                    // Convert to Base64
                    const base64Audio = arrayBufferToBase64(pcmData.buffer);

                    // Send to ElevenLabs (correct JSON format)
                    const message = {
                        message_type: 'input_audio_chunk',
                        audio_base_64: base64Audio,
                        commit: false,  // Auto-commit handled by VAD
                        sample_rate: 16000
                    };
                    elevenLabsWs.send(JSON.stringify(message));

                    // Log that chunk was sent
                    if (rms > 0.01) {
                        console.log('ğŸ“¤ Audio chunk sent to ElevenLabs - size:', base64Audio.length, 'chars');
                    }
                }
            };

            // Connect audio graph: source -> processor -> destination
            source.connect(processor);
            processor.connect(audioContext.destination);

            console.log('âœ… AudioContext started (PCM 16kHz streaming)');
        }

        /**
         * Convert ArrayBuffer to Base64
         */
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        /**
         * Handle messages from ElevenLabs WebSocket
         */
        function handleElevenLabsMessage(data) {
            try {
                const message = JSON.parse(data);

                // Debug: Log raw message to understand ElevenLabs response format
                console.log('ğŸ“¨ ElevenLabs raw message:', JSON.stringify(message, null, 2));
                console.log('ğŸ“¨ Message type:', message.message_type);
                console.log('ğŸ“¨ Message keys:', Object.keys(message));

                switch (message.message_type) {
                    case 'session_started':
                        console.log('âœ… ElevenLabs session started:', message);
                        break;

                    case 'partial_transcript':
                        // Real-time transcription (not yet finalized)
                        if (message.text) {
                            partialTranscriptText = message.text;
                            updatePartialTranscriptUI(message.text);
                            console.log('ğŸ“ Partial:', message.text);
                            resetInactivityTimer(); // Reset timer on any transcript activity
                        }
                        break;

                    case 'committed_transcript':
                        // Finalized transcription - add to chat
                        if (message.text && message.text.trim()) {
                            // Clear partial transcript UI
                            clearPartialTranscriptUI();

                            // Add to transcript with current speaker
                            addTranscriptLine(currentSpeaker, message.text.trim());
                            console.log('âœ… Committed:', message.text);

                            // Reset partial text
                            partialTranscriptText = '';

                            // Reset inactivity timer on committed transcript
                            resetInactivityTimer();
                        }
                        break;

                    case 'committed_transcript_with_timestamps':
                        // Finalized transcription with word-level timestamps
                        if (message.text && message.text.trim()) {
                            clearPartialTranscriptUI();
                            addTranscriptLine(currentSpeaker, message.text.trim());
                            console.log('âœ… Committed (with timestamps):', message.text);

                            // You can use message.words for word-level timing if needed
                            if (message.words) {
                                console.log('â±ï¸ Word timestamps:', message.words);
                            }

                            partialTranscriptText = '';

                            // Reset inactivity timer on committed transcript
                            resetInactivityTimer();
                        }
                        break;

                    case 'error':
                        console.error('âŒ ElevenLabs error:', message);
                        alert(`èªéŸ³è¾¨è­˜éŒ¯èª¤: ${message.message || message.error || 'æœªçŸ¥éŒ¯èª¤'}`);
                        break;

                    default:
                        console.log('â„¹ï¸ Unknown message type:', message.message_type);
                }
            } catch (error) {
                console.error('âŒ Failed to parse WebSocket message:', error);
            }
        }

        /**
         * Update UI with partial (in-progress) transcript
         */
        function updatePartialTranscriptUI(text) {
            // Check if partial transcript bubble already exists
            let partialBubble = document.getElementById('partial-transcript-bubble');

            if (!partialBubble) {
                // Create new partial transcript bubble
                const messageDiv = document.createElement('div');
                messageDiv.id = 'partial-transcript-container';
                messageDiv.className = `flex items-start gap-2 mb-3 fade-in ${currentSpeaker === 'client' ? 'flex-row-reverse' : ''}`;

                const avatarDiv = document.createElement('div');
                avatarDiv.className = `w-8 h-8 ${currentSpeaker === 'counselor' ? 'bg-blue-500' : 'bg-green-500'} rounded-full flex items-center justify-center flex-shrink-0 shadow-md opacity-60`;
                avatarDiv.innerHTML = `<span class="text-white text-sm">${currentSpeaker === 'counselor' ? 'ğŸ‘¨â€âš•ï¸' : 'ğŸ§‘'}</span>`;

                const bubbleWrapper = document.createElement('div');
                bubbleWrapper.className = `flex-1 flex flex-col ${currentSpeaker === 'client' ? 'items-end' : 'items-start'}`;

                const bubble = document.createElement('div');
                bubble.id = 'partial-transcript-bubble';
                bubble.className = `chat-bubble ${currentSpeaker === 'counselor' ? 'bg-blue-100 rounded-2xl rounded-tl-none' : 'bg-green-100 rounded-2xl rounded-tr-none'} px-4 py-2 shadow-sm border-2 border-dashed ${currentSpeaker === 'counselor' ? 'border-blue-300' : 'border-green-300'} opacity-75`;
                bubble.innerHTML = `<p class="text-sm text-gray-700 leading-relaxed italic">${text}</p>`;

                bubbleWrapper.appendChild(bubble);
                messageDiv.appendChild(avatarDiv);
                messageDiv.appendChild(bubbleWrapper);

                transcript.appendChild(messageDiv);
            } else {
                // Update existing partial transcript
                partialBubble.querySelector('p').textContent = text;
            }

            // Auto-scroll to bottom
            transcript.scrollTop = transcript.scrollHeight;
        }

        /**
         * Clear partial transcript UI when committed
         */
        function clearPartialTranscriptUI() {
            const partialContainer = document.getElementById('partial-transcript-container');
            if (partialContainer) {
                partialContainer.remove();
            }
        }

        /**
         * Reset inactivity timer when user is active
         */
        function resetInactivityTimer() {
            lastActivityTime = Date.now();
            console.log('â° Inactivity timer reset');
        }

        /**
         * Start monitoring for inactivity (check every 10 seconds)
         */
        function startInactivityMonitoring() {
            console.log('ğŸ” Starting inactivity monitoring');
            inactivityCheckInterval = setInterval(() => {
                const inactiveTime = Date.now() - lastActivityTime;
                const inactiveSeconds = Math.floor(inactiveTime / 1000);

                // Check if inactive for more than 60 seconds
                if (inactiveTime > 60000 && !document.getElementById('inactivityModal')) {
                    console.warn(`âš ï¸ User inactive for ${inactiveSeconds} seconds, showing warning`);
                    showInactivityWarning();
                }
            }, 10000); // Check every 10 seconds
        }

        /**
         * Stop inactivity monitoring and cleanup
         */
        function stopInactivityMonitoring() {
            console.log('ğŸ›‘ Stopping inactivity monitoring');
            if (inactivityCheckInterval) {
                clearInterval(inactivityCheckInterval);
                inactivityCheckInterval = null;
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            // Remove modal if exists
            const modal = document.getElementById('inactivityModal');
            if (modal) {
                modal.remove();
            }
        }

        /**
         * Show inactivity warning modal with 10-second countdown
         */
        function showInactivityWarning() {
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'inactivityModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-8 max-w-md mx-4 text-center shadow-2xl">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800">é‚„åœ¨å—ï¼Ÿ</h2>
                        <p class="mb-4 text-gray-600">å·²ç¶“ 1 åˆ†é˜æ²’æœ‰å°è©±äº†ï¼Œæ˜¯å¦è¦ç¹¼çºŒï¼Ÿ</p>
                        <p class="text-red-500 font-bold mb-6 text-lg">
                            å°‡åœ¨ <span id="countdownSeconds" class="text-2xl">10</span> ç§’å¾Œè‡ªå‹•çµæŸ
                        </p>
                        <div class="flex gap-4">
                            <button onclick="continueSession()"
                                class="flex-1 bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors font-semibold">
                                ç¹¼çºŒå°è©±
                            </button>
                            <button onclick="endSessionFromModal()"
                                class="flex-1 bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition-colors font-semibold">
                                çµæŸå°è©±
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Start 10-second countdown
            let secondsLeft = 10;
            countdownInterval = setInterval(() => {
                secondsLeft--;
                const countdownEl = document.getElementById('countdownSeconds');
                if (countdownEl) {
                    countdownEl.textContent = secondsLeft;
                }

                // Auto-end if countdown reaches 0
                if (secondsLeft <= 0) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    console.log('â±ï¸ Countdown reached 0, auto-ending session');
                    endSessionFromModal();
                }
            }, 1000);
        }

        /**
         * User chose to continue session
         */
        function continueSession() {
            console.log('âœ… User chose to continue session');
            const modal = document.getElementById('inactivityModal');
            if (modal) {
                modal.remove();
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            resetInactivityTimer();
        }

        /**
         * User chose to end session or countdown expired
         */
        function endSessionFromModal() {
            console.log('ğŸ›‘ Ending session from inactivity modal');
            const modal = document.getElementById('inactivityModal');
            if (modal) {
                modal.remove();
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            stopSession();
        }

        /**
         * Stop real recording and cleanup resources
         */
        function stopRealRecording() {
            // Stop AudioContext
            if (audioContext) {
                audioContext.close();
                audioContext = null;
                console.log('â¹ï¸ AudioContext stopped');
            }

            // Stop audio stream
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
                audioStream = null;
                console.log('ğŸ¤ Microphone released');
            }

            // Close WebSocket
            if (elevenLabsWs && elevenLabsWs.readyState === WebSocket.OPEN) {
                elevenLabsWs.close();
                elevenLabsWs = null;
                console.log('ğŸ”Œ WebSocket closed');
            }

            // Clear partial transcript
            clearPartialTranscriptUI();
            partialTranscriptText = '';
        }

        /**
         * Convert Blob to Base64
         */
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // === Settings Modal Functions ===
        function openSettingsModal() {
            if (!settingsModal) return;

            // Show modal
            settingsModal.classList.remove('hidden');

            // Prevent body scroll
            document.body.style.overflow = 'hidden';

            // Trigger animation (slide up from bottom)
            requestAnimationFrame(() => {
                settingsModalContent.style.transform = 'translateY(0)';
                settingsModalBackdrop.style.opacity = '1';
            });

            console.log('âš™ï¸ Settings modal opened');
        }

        function closeSettingsModal() {
            if (!settingsModal) return;

            // Trigger animation (slide down)
            settingsModalContent.style.transform = 'translateY(100%)';
            settingsModalBackdrop.style.opacity = '0';

            // Hide modal after animation
            setTimeout(() => {
                settingsModal.classList.add('hidden');
                document.body.style.overflow = '';
            }, 300);

            console.log('âš™ï¸ Settings modal closed');
        }

        // === Core Functions ===
        async function startSession() {
            // Generate unique session ID
            const sessionId = `session-${Date.now()}-${Math.random().toString(36).substring(7)}`;
            currentSessionId = sessionId;
            localStorage.setItem('currentSessionId', sessionId);
            console.log(`ğŸ¯ Session ID: ${sessionId}`);

            console.log(`ğŸ¯ Session mode: ${sessionMode}`);
            isRecording = true;
            isPaused = false; // Reset pause state
            pausedTime = 0; // Reset paused duration
            pauseStartTime = null; // Reset pause start time
            startTime = Date.now();
            transcriptSegments = [];
            analysisHistory = [];
            lastQuickFeedbackTime = 0; // Reset quick feedback timer for new session
            lastAutoAnalysisTime = 0; // Reset deep analysis timer for new session

            // REAL RECORDING MODE: Start ElevenLabs WebSocket + Microphone
            if (!isDemoMode) {
                try {
                    await startRealRecording();
                    console.log('ğŸ¤ Real recording started with ElevenLabs STT');
                } catch (error) {
                    console.error('âŒ Failed to start real recording:', error);
                    alert(`ç„¡æ³•å•Ÿå‹•éº¥å…‹é¢¨æˆ–é€£æ¥èªéŸ³è¾¨è­˜æœå‹™ï¼š${error.message}\n\nå°‡åˆ‡æ›åˆ° Demo æ¨¡å¼`);
                    isDemoMode = true; // Fallback to demo mode
                }
            }

            // DEMO MODE: Initialize audio simulation
            if (isDemoMode) {
                initializeAudioSimulation();

                // Auto-play audio if voice simulation is enabled
                if (isVoiceSimEnabled) {
                    playAudioSimulation();
                    console.log('ğŸµ è‡ªå‹•é–‹å§‹æ’­æ”¾éŸ³è¨Šï¼ˆæ¨¡æ“¬äººè²å·²å•Ÿç”¨ï¼‰');
                }
            }

            // UI Updates - Desktop
            startBtn.disabled = true;
            startBtn.classList.add('opacity-50', 'cursor-not-allowed');
            stopBtn.disabled = false;
            stopBtn.classList.remove('opacity-50', 'cursor-not-allowed');

            // UI Updates - Mobile (pauseBtnMobile and stopBtnMobile are already visible in recordingBottomBar)
            if (pauseBtnMobile) {
                pauseBtnMobile.disabled = false;
                pauseBtnMobile.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            if (stopBtnMobile) {
                stopBtnMobile.disabled = false;
                stopBtnMobile.classList.remove('opacity-50', 'cursor-not-allowed');
            }

            // Analysis buttons
            triggerAnalysisBtn.disabled = false;
            triggerAnalysisBtn.classList.remove('opacity-50', 'cursor-not-allowed');

            // Show/hide indicators
            liveIndicator.classList.remove('hidden');
            transcriptEmpty.style.display = 'none';

            // REQUIREMENT 1: Enable bottom analyze button (remove disabled state)
            if (fabAnalyzeMobile) {
                fabAnalyzeMobile.disabled = false;
                fabAnalyzeMobile.classList.remove('opacity-50', 'cursor-not-allowed');
            }

            // REQUIREMENT 3: Hide all UI cards when recording starts
            // é¡¯ç¤ºæ‰‹æ©Ÿç‰ˆéŒ„éŸ³ä¸­çš„æ¥µç°¡ UIï¼Œéš±è—å…¶ä»– UI
            const recordingUI = document.getElementById('recordingUI');
            if (recordingUI && window.innerWidth < 768) {
                recordingUI.classList.remove('hidden');
            }
            if (initialUI) {
                initialUI.classList.add('hidden');
            }
            if (practiceIntroUI) {
                practiceIntroUI.classList.add('hidden');
            }
            // é¡¯ç¤ºæ‰‹æ©Ÿç‰ˆåº•éƒ¨æŒ‰éˆ•åˆ— (pauseBtnMobile and stopBtnMobile are inside recordingBottomBar)
            if (recordingBottomBar && window.innerWidth < 768) {
                recordingBottomBar.classList.remove('hidden');
            }

            // Header is now hidden on mobile via CSS (hidden md:block)
            // No need for JavaScript header manipulation on mobile

            // Show waveform and recording timer
            waveformContainer.classList.add('active');
            recordingTimerDisplay.style.display = 'block';
            recordingTimerDisplayMobile.style.display = 'block';

            // Start waveform animations
            updateWaveformAnimations();

            // Auto-expand transcript section when recording starts
            const transcriptSection = document.getElementById('transcriptSection');
            const transcriptToggle = document.getElementById('transcriptToggle');
            if (transcriptSection.classList.contains('hidden')) {
                transcriptSection.classList.remove('hidden');
                transcriptToggle.textContent = 'â–²';
                transcriptToggle.style.transform = 'rotate(180deg)';
            }

            status.textContent = 'ğŸ”´ éŒ„éŸ³ä¸­';
            status.classList.add('pulse-recording');
            transcript.innerHTML = '';
            analysisCards.innerHTML = '';
            if (analysisEmpty) analysisEmpty.style.display = 'none';

            // Start Timer
            timerInterval = setInterval(updateTimer, 1000);

            // Show next analysis countdown
            updateNextAnalysisCountdown();
        }

        function stopSession() {
            isRecording = false;
            isPaused = false; // Reset pause state
            pausedTime = 0; // Reset paused duration
            pauseStartTime = null; // Reset pause start time

            // Stop inactivity monitoring
            stopInactivityMonitoring();

            // Stop real recording if active
            if (!isDemoMode) {
                stopRealRecording();
            }

            // Final analysis
            analyzeTranscript();

            // Stop audio playback and speech (demo mode)
            if (audioSimulation.isPlaying) {
                pauseAudioSimulation();
            }
            stopSpeech();

            // Hide audio player
            if (audioPlayerSection) {
                audioPlayerSection.style.display = 'none';
            }

            // Cleanup
            clearInterval(timerInterval);
            clearInterval(analysisInterval);
            lastAutoAnalysisTime = 0; // Reset auto-analysis tracker

            // UI Updates - Desktop
            startBtn.disabled = false;
            startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            stopBtn.disabled = true;
            stopBtn.classList.add('opacity-50', 'cursor-not-allowed');

            // UI Updates - Mobile (disable buttons since session stopped)
            if (pauseBtnMobile) {
                pauseBtnMobile.disabled = true;
                pauseBtnMobile.classList.add('opacity-50', 'cursor-not-allowed');
                // Reset pause button text
                pauseBtnMobile.innerHTML = `
                    <span class="text-2xl">â¸</span>
                    <span>æš«åœ</span>
                `;
            }
            if (stopBtnMobile) {
                stopBtnMobile.disabled = true;
                stopBtnMobile.classList.add('opacity-50', 'cursor-not-allowed');
            }

            // Hide indicators
            liveIndicator.classList.add('hidden');

            // REQUIREMENT 1: Disable bottom analyze button again
            if (fabAnalyzeMobile) {
                fabAnalyzeMobile.disabled = true;
                fabAnalyzeMobile.classList.add('opacity-50', 'cursor-not-allowed');
            }

            // REQUIREMENT 3: Show initial UI when recording stops (return to homepage)
            // éš±è—æ‰‹æ©Ÿç‰ˆéŒ„éŸ³ä¸­çš„æ¥µç°¡ UIï¼Œé¡¯ç¤ºé¦–é 
            const recordingUI = document.getElementById('recordingUI');
            if (recordingUI) {
                recordingUI.classList.add('hidden');
            }
            if (practiceIntroUI) {
                practiceIntroUI.classList.add('hidden');
            }

            // Show completion screen on mobile, otherwise show initial UI
            if (window.innerWidth < 768) {
                // Mobile: Check if there's a transcript
                const hasTranscript = transcriptSegments && transcriptSegments.length > 0;

                if (hasTranscript && completionScreen && sessionDuration) {
                    // Has transcript: Show completion screen
                    // Calculate and display session duration
                    const duration = calculateSessionDuration();
                    sessionDuration.textContent = duration;

                    // CRITICAL: Hide carousel before showing completion screen
                    if (mobileCarousel) mobileCarousel.classList.add('hidden');

                    // Show completion screen
                    completionScreen.classList.remove('hidden');
                } else {
                    // No transcript: Return to initial UI (home page)
                    if (mobileCarousel) mobileCarousel.classList.add('hidden');
                    if (completionScreen) completionScreen.classList.add('hidden');
                    if (initialUI) initialUI.classList.remove('hidden');
                }
            } else {
                // Only show initialUI if no analysis cards exist (desktop behavior)
                if (initialUI && mobileAnalysisCards.length === 0) {
                    initialUI.classList.remove('hidden');
                }
            }

            // éš±è—æ‰‹æ©Ÿç‰ˆåº•éƒ¨æŒ‰éˆ•åˆ—
            if (recordingBottomBar) {
                recordingBottomBar.classList.add('hidden');
            }

            // Header is now hidden on mobile via CSS (hidden md:block)
            // No need for JavaScript header manipulation on mobile

            // Hide waveform and recording timer
            waveformContainer.classList.remove('active');
            recordingTimerDisplay.style.display = 'none';
            recordingTimerDisplayMobile.style.display = 'none';

            // Stop waveform animations
            updateWaveformAnimations();

            status.textContent = 'â¹ï¸ å·²çµæŸ';
            status.classList.remove('pulse-recording');
            nextAnalysis.textContent = '-';

            // Save to localStorage
            saveToHistory();
        }

        // NEW: Toggle pause/resume
        function togglePause() {
            if (isPaused) {
                resumeSession();
            } else {
                pauseSession();
            }
        }

        // NEW: Pause the session
        function pauseSession() {
            if (!isRecording || isPaused) return;

            isPaused = true;
            pauseStartTime = Date.now();

            // Pause timer
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            // Pause audio simulation if playing (demo mode)
            if (isDemoMode && audioSimulation.isPlaying) {
                pauseAudioSimulation();
            }

            // In real mode, we can't truly "pause" ElevenLabs WebSocket
            // But we can stop sending audio and ignore incoming messages
            // The WebSocket stays connected but inactive

            // Update UI - Mobile pause button
            if (pauseBtnMobile) {
                pauseBtnMobile.innerHTML = `
                    <span class="text-2xl">â–¶ï¸</span>
                    <span>ç¹¼çºŒ</span>
                `;
            }

            // Update status
            status.textContent = 'â¸ï¸ å·²æš«åœ';
            status.classList.remove('pulse-recording');

            // Stop waveform animations
            updateWaveformAnimations();

            console.log('â¸ï¸ Session paused');
        }

        // NEW: Resume the session
        function resumeSession() {
            if (!isRecording || !isPaused) return;

            // Calculate paused duration and add to total
            if (pauseStartTime) {
                pausedTime += (Date.now() - pauseStartTime);
                pauseStartTime = null;
            }

            isPaused = false;

            // Resume timer
            timerInterval = setInterval(updateTimer, 1000);

            // Resume audio simulation if was playing (demo mode)
            if (isDemoMode && isVoiceSimEnabled && audioPlayerSection) {
                playAudioSimulation();
            }

            // In real mode, WebSocket is still connected, just resume normal operation

            // Update UI - Mobile pause button
            if (pauseBtnMobile) {
                pauseBtnMobile.innerHTML = `
                    <span class="text-2xl">â¸</span>
                    <span>æš«åœ</span>
                `;
            }

            // Update status
            status.textContent = 'ğŸ”´ éŒ„éŸ³ä¸­';
            status.classList.add('pulse-recording');

            // Resume waveform animations
            updateWaveformAnimations();

            console.log('â–¶ï¸ Session resumed');
        }

        function switchSpeaker(speaker) {
            currentSpeaker = speaker;

            // Guard: Skip UI updates if speaker buttons don't exist (e.g., in demo mode)
            if (!speakerCounselorBtn || !speakerClientBtn) {
                return;
            }

            if (speaker === 'counselor') {
                speakerCounselorBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300', 'shadow-sm');
                speakerCounselorBtn.classList.add('bg-gradient-to-br', 'from-blue-500', 'to-indigo-600', 'text-white', 'shadow-md', 'hover:shadow-lg');
                speakerClientBtn.classList.remove('bg-gradient-to-br', 'from-blue-500', 'to-indigo-600', 'text-white', 'shadow-md', 'hover:shadow-lg');
                speakerClientBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300', 'shadow-sm');
            } else {
                speakerClientBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300', 'shadow-sm');
                speakerClientBtn.classList.add('bg-gradient-to-br', 'from-blue-500', 'to-indigo-600', 'text-white', 'shadow-md', 'hover:shadow-lg');
                speakerCounselorBtn.classList.remove('bg-gradient-to-br', 'from-blue-500', 'to-indigo-600', 'text-white', 'shadow-md', 'hover:shadow-lg');
                speakerCounselorBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300', 'shadow-sm');
            }
        }

        function toggleRecordingMode() {
            // Prevent mode change during recording
            if (isRecording) {
                alert('è«‹å…ˆåœæ­¢éŒ„éŸ³å†åˆ‡æ›æ¨¡å¼');
                return;
            }

            // Toggle mode
            isDemoMode = !isDemoMode;

            // Update all toggle switches (mobile + desktop)
            const toggles = [modeToggle, modeToggleDesktop].filter(t => t);
            const labels = [
                { elem: modeToggleLabel, hintElem: modeHint },
                { elem: modeToggleLabelDesktop, hintElem: modeHintDesktop }
            ].filter(l => l.elem);

            toggles.forEach(toggleBtn => {
                const toggleCircle = toggleBtn.querySelector('span');

                if (!isDemoMode) {
                    // Real recording mode: green background, circle to right
                    toggleBtn.classList.remove('bg-gray-300');
                    toggleBtn.classList.add('bg-green-600');
                    toggleBtn.setAttribute('aria-checked', 'true');
                    toggleCircle.classList.remove('translate-x-1');
                    toggleCircle.classList.add('translate-x-6');
                } else {
                    // Demo mode: gray background, circle to left
                    toggleBtn.classList.remove('bg-green-600');
                    toggleBtn.classList.add('bg-gray-300');
                    toggleBtn.setAttribute('aria-checked', 'false');
                    toggleCircle.classList.remove('translate-x-6');
                    toggleCircle.classList.add('translate-x-1');
                }
            });

            // Update labels
            labels.forEach(({ elem, hintElem }) => {
                if (!isDemoMode) {
                    elem.textContent = 'çœŸå¯¦éŒ„éŸ³';
                    hintElem.textContent = 'é–‹å•Ÿ = çœŸå¯¦';
                } else {
                    elem.textContent = 'Demo æ¨¡å¼';
                    hintElem.textContent = 'é—œé–‰ = Demo';
                }
            });

            // Show/Hide demo mode hints
            const demoHintMobile = document.getElementById('demoModeHintMobile');
            const demoHintDesktop = document.getElementById('demoModeHintDesktop');
            if (demoHintMobile) demoHintMobile.style.display = isDemoMode ? '' : 'none';
            if (demoHintDesktop) demoHintDesktop.style.display = isDemoMode ? '' : 'none';

            // Log mode change
            console.log(`ğŸ”„ Mode switched to: ${isDemoMode ? 'Demo' : 'Real Recording'}`);

            // Show notification
            const modeText = isDemoMode ? 'Demo æ¨¡å¼ï¼ˆæ¨¡æ“¬å°è©±ï¼‰' : 'çœŸå¯¦éŒ„éŸ³æ¨¡å¼ï¼ˆéœ€è¦éº¥å…‹é¢¨æ¬Šé™ï¼‰';
            showNotification(`å·²åˆ‡æ›åˆ° ${modeText}`, isDemoMode ? 'info' : 'success');
        }

        function showNotification(message, type = 'info') {
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-4 ${bgColor} text-white px-6 py-3 rounded-xl shadow-lg z-50 fade-in`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Provider toggle functionality
        function setupProviderToggle() {
            const toggleMobile = document.getElementById('providerToggle');
            const toggleDesktop = document.getElementById('providerToggleDesktop');

            if (toggleMobile) {
                toggleMobile.addEventListener('click', () => {
                    currentProvider = currentProvider === 'gemini' ? 'codeer' : 'gemini';
                    updateProviderUI();
                });
            }

            if (toggleDesktop) {
                toggleDesktop.addEventListener('click', () => {
                    currentProvider = currentProvider === 'gemini' ? 'codeer' : 'gemini';
                    updateProviderUI();
                });
            }
        }

        function updateProviderUI() {
            // Mobile elements
            const toggle = document.getElementById('providerToggle');
            const circle = document.getElementById('providerToggleCircle');
            const label = document.getElementById('providerLabel');
            const description = document.getElementById('providerDescription');
            const latency = document.getElementById('providerLatency');
            const modelSelector = document.getElementById('codeerModelSelector');

            // Desktop elements
            const toggleDesktop = document.getElementById('providerToggleDesktop');
            const circleDesktop = document.getElementById('providerToggleCircleDesktop');
            const labelDesktop = document.getElementById('providerLabelDesktop');
            const descriptionDesktop = document.getElementById('providerDescriptionDesktop');
            const latencyDesktop = document.getElementById('providerLatencyDesktop');
            const modelSelectorDesktop = document.getElementById('codeerModelSelectorDesktop');

            if (currentProvider === 'codeer') {
                // Codeer selected - Mobile
                if (toggle) {
                    toggle.classList.remove('bg-gray-300');
                    toggle.classList.add('bg-purple-600');
                }
                if (circle) {
                    circle.classList.remove('translate-x-1');
                    circle.classList.add('translate-x-6');
                }
                if (label) label.textContent = 'è¦ªå­å°ˆå®¶';
                if (description) description.textContent = 'Codeer AI Â· å°ˆæ¥­è¦ªå­æ•™é¤Š';
                if (modelSelector) modelSelector.classList.remove('hidden'); // Show model selector

                // Codeer selected - Desktop
                if (toggleDesktop) {
                    toggleDesktop.classList.remove('bg-gray-300');
                    toggleDesktop.classList.add('bg-purple-600');
                }
                if (circleDesktop) {
                    circleDesktop.classList.remove('translate-x-1');
                    circleDesktop.classList.add('translate-x-6');
                }
                if (labelDesktop) labelDesktop.textContent = 'è¦ªå­å°ˆå®¶';
                if (descriptionDesktop) descriptionDesktop.textContent = 'Codeer AI Â· å°ˆæ¥­è¦ªå­æ•™é¤Š';
                if (modelSelectorDesktop) modelSelectorDesktop.classList.remove('hidden'); // Show model selector
            } else {
                // Gemini selected - Mobile
                if (toggle) {
                    toggle.classList.remove('bg-purple-600');
                    toggle.classList.add('bg-gray-300');
                }
                if (circle) {
                    circle.classList.remove('translate-x-6');
                    circle.classList.add('translate-x-1');
                }
                if (label) label.textContent = 'Gemini';
                if (description) description.textContent = 'é€Ÿåº¦å¿« Â· æ”¯æ´å¿«å–';
                if (modelSelector) modelSelector.classList.add('hidden'); // Hide model selector

                // Gemini selected - Desktop
                if (toggleDesktop) {
                    toggleDesktop.classList.remove('bg-purple-600');
                    toggleDesktop.classList.add('bg-gray-300');
                }
                if (circleDesktop) {
                    circleDesktop.classList.remove('translate-x-6');
                    circleDesktop.classList.add('translate-x-1');
                }
                if (labelDesktop) labelDesktop.textContent = 'Gemini';
                if (descriptionDesktop) descriptionDesktop.textContent = 'é€Ÿåº¦å¿« Â· æ”¯æ´å¿«å–';
                if (modelSelectorDesktop) modelSelectorDesktop.classList.add('hidden'); // Hide model selector
            }

            console.log(`Provider switched to: ${currentProvider}`);
        }

        // Setup Codeer model selector event listeners
        function setupCodeerModelSelector() {
            // Mobile model selector
            const modelRadios = document.querySelectorAll('input[name="codeerModel"]');
            modelRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    currentCodeerModel = e.target.value;
                    console.log(`Codeer model changed to: ${currentCodeerModel}`);

                    // Sync with desktop selector
                    const desktopRadio = document.querySelector(`input[name="codeerModelDesktop"][value="${currentCodeerModel}"]`);
                    if (desktopRadio) desktopRadio.checked = true;
                });
            });

            // Desktop model selector
            const modelRadiosDesktop = document.querySelectorAll('input[name="codeerModelDesktop"]');
            modelRadiosDesktop.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    currentCodeerModel = e.target.value;
                    console.log(`Codeer model changed to: ${currentCodeerModel}`);

                    // Sync with mobile selector
                    const mobileRadio = document.querySelector(`input[name="codeerModel"][value="${currentCodeerModel}"]`);
                    if (mobileRadio) mobileRadio.checked = true;
                });
            });
        }

        function toggleVoiceSimulation() {
            isVoiceSimEnabled = !isVoiceSimEnabled;

            // Update both mobile and desktop toggles
            const toggles = [voiceSimToggle, voiceSimToggleDesktop].filter(t => t);

            toggles.forEach(toggleBtn => {
                const toggleCircle = toggleBtn.querySelector('span');

                if (isVoiceSimEnabled) {
                    // Enabled state: indigo background, circle moved to right
                    toggleBtn.classList.remove('bg-gray-300');
                    toggleBtn.classList.add('bg-indigo-600');
                    toggleBtn.setAttribute('aria-checked', 'true');
                    toggleCircle.classList.remove('translate-x-1');
                    toggleCircle.classList.add('translate-x-6');
                } else {
                    // Disabled state: gray background, circle moved to left
                    toggleBtn.classList.remove('bg-indigo-600');
                    toggleBtn.classList.add('bg-gray-300');
                    toggleBtn.setAttribute('aria-checked', 'false');
                    toggleCircle.classList.remove('translate-x-6');
                    toggleCircle.classList.add('translate-x-1');
                }
            });

            if (isVoiceSimEnabled) {
                console.log('ğŸ­ Voice Simulation: ENABLED');

                // If recording, show audio player and start playback
                if (isRecording && audioPlayerSection) {
                    audioPlayerSection.style.display = 'block';
                    if (!audioSimulation.isPlaying) {
                        playAudioSimulation();
                        console.log('ğŸµ è‡ªå‹•é–‹å§‹æ’­æ”¾éŸ³è¨Šï¼ˆåˆ‡æ›è‡³æ¨¡æ“¬äººè²ï¼‰');
                    }
                }
            } else {
                console.log('ğŸ­ Voice Simulation: DISABLED');

                // If recording, hide audio player and stop playback
                if (isRecording) {
                    if (audioSimulation.isPlaying) {
                        pauseAudioSimulation();
                        console.log('â¸ï¸ åœæ­¢æ’­æ”¾éŸ³è¨Šï¼ˆåˆ‡æ›è‡³é—œé–‰æ¨¡æ“¬äººè²ï¼‰');
                    }
                    if (audioPlayerSection) {
                        audioPlayerSection.style.display = 'none';
                    }
                }
            }
        }

        function updateWaveformAnimations() {
            const containers = [waveformContainer, waveformContainerMobile];
            containers.forEach(container => {
                if (!container) return;
                const bars = container.querySelectorAll('.waveform-bar');
                bars.forEach(bar => {
                    // Animation enabled when recording
                    if (isRecording) {
                        bar.style.animationPlayState = 'running';
                    } else {
                        bar.style.animationPlayState = 'paused';
                    }
                });
            });
        }

        function calculateSessionDuration() {
            // Subtract paused time from total elapsed time
            const totalPausedMs = pausedTime + (isPaused && pauseStartTime ? (Date.now() - pauseStartTime) : 0);
            const elapsed = Math.floor((Date.now() - startTime - totalPausedMs) / 1000);
            const hours = Math.floor(elapsed / 3600);
            const displayMinutes = Math.floor((elapsed % 3600) / 60);
            const seconds = elapsed % 60;
            return `${String(hours).padStart(2, '0')}:${String(displayMinutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function updateTimer() {
            // Subtract paused time from total elapsed time
            const totalPausedMs = pausedTime + (isPaused && pauseStartTime ? (Date.now() - pauseStartTime) : 0);
            const elapsed = Math.floor((Date.now() - startTime - totalPausedMs) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            const hours = Math.floor(elapsed / 3600);
            const displayMinutes = Math.floor((elapsed % 3600) / 60);

            // Format: MM:SS for compact displays
            const timeString = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            // Format: HH:MM:SS for mobile recording UI
            const timeStringLong = `${String(hours).padStart(2, '0')}:${String(displayMinutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            // Update main timer (desktop)
            timer.textContent = timeString;

            // Update recording timer displays
            if (recordingTimer) recordingTimer.textContent = timeStringLong; // Mobile recording UI (å·²è«‡è©± HH:MM:SS)
            if (recordingTimerDesktop) recordingTimerDesktop.textContent = timeString; // Desktop recording timer display
            if (recordingTimerMobile) recordingTimerMobile.textContent = timeString; // Mobile compact waveform timer

            // === Dual-API Auto-Analysis System ===
            // 1. Quick Feedback (é›æ¹¯æ–‡): Every 20 seconds (except during red light)
            // 2. Deep Analysis: Adaptive intervals (green=60s, yellow=30s, red=15s)

            // Quick Feedback Timer (every 20 seconds, except red light)
            const shouldQuickFeedback = (elapsed > 0 && elapsed % 20 === 0 && elapsed !== lastQuickFeedbackTime)
                && lastSafetyLevel !== 'red' // Disable during red light (already fast enough)
                && transcriptSegments.length > 0;

            if (shouldQuickFeedback) {
                lastQuickFeedbackTime = elapsed;
                console.log(`ğŸ’¡ [Quick Feedback] Triggered at ${elapsed}s (safety: ${lastSafetyLevel})`);

                // Show yellow toast for quick analysis
                showAutoAnalysisNotification(true); // true = quick analysis

                // Call quick feedback API
                getQuickFeedback();
            }

            // Deep Analysis Timer (adaptive intervals based on safety level)
            const shouldDeepAnalyze = (elapsed > 0 && elapsed % nextAnalysisInterval === 0 && elapsed !== lastAutoAnalysisTime)
                && transcriptSegments.length > 0;

            if (shouldDeepAnalyze) {
                lastAutoAnalysisTime = elapsed;
                console.log(`ğŸ” [Deep Analysis] Triggered at ${elapsed}s (interval: ${nextAnalysisInterval}s, safety: ${lastSafetyLevel})`);

                // Show purple toast for deep analysis
                showAutoAnalysisNotification(false); // false = deep analysis

                // Call full analysis API
                analyzeTranscript();
            }
        }

        function updateNextAnalysisCountdown() {
            if (!isRecording) return;

            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const remaining = nextAnalysisInterval - (elapsed % nextAnalysisInterval);
            nextAnalysis.textContent = `${remaining} ç§’`;

            setTimeout(() => updateNextAnalysisCountdown(), 1000);
        }

        // Update analysis interval based on safety_level
        function updateAnalysisInterval(safetyLevel) {
            const intervalMap = {
                green: 60,   // Safe: check every 60 seconds
                yellow: 30,  // Warning: check every 30 seconds
                red: 15      // Critical: check every 15 seconds
            };

            const newInterval = intervalMap[safetyLevel] || 60;

            // Only log and notify if interval actually changed
            if (newInterval !== nextAnalysisInterval) {
                nextAnalysisInterval = newInterval;
                lastSafetyLevel = safetyLevel;

                const emoji = {green: 'ğŸŸ¢', yellow: 'ğŸŸ¡', red: 'ğŸ”´'}[safetyLevel] || 'âšª';
                const levelText = {green: 'å®‰å…¨', yellow: 'è­¦ç¤º', red: 'é«˜é¢¨éšª'}[safetyLevel] || 'æœªçŸ¥';
                console.log(`â±ï¸ Analysis interval updated: ${nextAnalysisInterval}s (${safetyLevel.toUpperCase()} - ${levelText})`);

                // Show visual notification
                showIntervalChangeNotification(safetyLevel, newInterval);
            }
        }

        // Show notification when interval changes
        function showIntervalChangeNotification(safetyLevel, interval) {
            const emoji = {green: 'ğŸŸ¢', yellow: 'ğŸŸ¡', red: 'ğŸ”´'}[safetyLevel] || 'âšª';
            const levelText = {
                green: 'å®‰å…¨å°è©±',
                yellow: 'è­¦ç¤ºå°è©±',
                red: 'é«˜é¢¨éšªå°è©±'
            }[safetyLevel] || 'å°è©±';

            const message = `${emoji} åµæ¸¬åˆ°${levelText}ï¼Œä¸‹æ¬¡åˆ†ææ™‚é–“èª¿æ•´ç‚º ${interval} ç§’`;

            console.log(`ğŸ“¢ ${message}`);

            // If toast notification system exists, use it; otherwise just log
            // You could add a toast notification here if needed
        }

        // Update mobile suggestion circle with AI analysis results
        function updateMobileSuggestionCircle(safetyLevel, suggestion) {
            console.log(`ğŸ” updateMobileSuggestionCircle called with safetyLevel="${safetyLevel}", suggestion="${suggestion.substring(0, 100)}..."`);
            console.log(`ğŸ” Current viewport width: ${window.innerWidth}px`);

            // Get both circle elements (recording UI and carousel UI)
            const liveSuggestion = document.getElementById('liveSuggestion');
            const suggestionCircle = document.getElementById('suggestionCircle');
            const carouselLiveSuggestion = document.getElementById('carouselLiveSuggestion');
            const carouselCircle = document.getElementById('carouselCircle');

            console.log(`ğŸ” liveSuggestion element:`, liveSuggestion ? 'FOUND' : 'NOT FOUND');
            console.log(`ğŸ” suggestionCircle element:`, suggestionCircle ? 'FOUND' : 'NOT FOUND');
            console.log(`ğŸ” carouselLiveSuggestion element:`, carouselLiveSuggestion ? 'FOUND' : 'NOT FOUND');
            console.log(`ğŸ” carouselCircle element:`, carouselCircle ? 'FOUND' : 'NOT FOUND');

            // Only update on mobile viewport
            if (window.innerWidth >= 768) {
                console.log('âš ï¸ Skipping mobile circle update - viewport width >= 768px (desktop mode)');
                return;
            }

            // Update text (replace \n or \\n with <br> for HTML display)
            const formattedSuggestion = suggestion.replace(/\\n|\n/g, '<br>');
            console.log(`ğŸ” Formatted suggestion: "${formattedSuggestion}"`);

            // Update color based on safety level
            const gradients = {
                red: 'radial-gradient(circle, #ef4444 0%, #f87171 40%, #fca5a5 70%, #fecaca 100%)',
                yellow: 'radial-gradient(circle, #f59e0b 0%, #fbbf24 40%, #fcd34d 70%, #fef3c7 100%)',
                green: 'radial-gradient(circle, #67e8f9 0%, #99f6e4 40%, #ccfbf1 70%, #f0fdfa 100%)'
            };

            // Update text color for better contrast
            const textColors = {
                red: 'text-red-900',
                yellow: 'text-orange-900',
                green: 'text-teal-900'
            };

            const selectedGradient = gradients[safetyLevel] || gradients.green;
            const selectedTextColor = textColors[safetyLevel] || textColors.green;

            console.log(`ğŸ” Applying gradient: ${selectedGradient}`);
            console.log(`ğŸ” Applying text color: ${selectedTextColor}`);

            // Update recording UI circle (large version)
            if (liveSuggestion && suggestionCircle) {
                liveSuggestion.innerHTML = formattedSuggestion;
                suggestionCircle.style.background = selectedGradient;
                liveSuggestion.className = `text-2xl font-bold leading-tight ${selectedTextColor}`;
                console.log(`âœ… Recording UI circle updated`);
            }

            // Update carousel UI circle (compact version)
            if (carouselLiveSuggestion && carouselCircle) {
                carouselLiveSuggestion.innerHTML = formattedSuggestion;
                carouselCircle.style.background = selectedGradient;
                carouselLiveSuggestion.className = `text-sm font-bold leading-tight ${selectedTextColor}`;
                console.log(`âœ… Carousel UI circle updated`);
            }

            console.log(`âœ… Mobile circles updated successfully: ${safetyLevel} - ${suggestion.substring(0, 50)}...`);
        }

        // === Transcript Management ===
        function addTranscriptLine(speaker, text) {
            // Hide empty state on first transcript line
            if (transcriptEmpty) {
                transcriptEmpty.style.display = 'none';
            }

            // Chat-style bubble
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex items-start gap-2 mb-3 fade-in ${speaker === 'client' ? 'flex-row-reverse' : ''}`;

            const avatarDiv = document.createElement('div');
            avatarDiv.className = `w-8 h-8 ${speaker === 'counselor' ? 'bg-blue-500' : 'bg-green-500'} rounded-full flex items-center justify-center flex-shrink-0 shadow-md`;
            avatarDiv.innerHTML = `<span class="text-white text-sm">${speaker === 'counselor' ? 'ğŸ‘¨â€âš•ï¸' : 'ğŸ§‘'}</span>`;

            const bubbleWrapper = document.createElement('div');
            bubbleWrapper.className = `flex-1 flex flex-col ${speaker === 'client' ? 'items-end' : 'items-start'}`;

            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${speaker === 'counselor' ? 'bg-blue-50 rounded-2xl rounded-tl-none' : 'bg-green-50 rounded-2xl rounded-tr-none'} px-4 py-2 shadow-sm`;
            bubble.innerHTML = `<p class="text-sm text-gray-800 leading-relaxed">${text}</p>`;

            const timestamp = document.createElement('span');
            timestamp.className = `text-xs text-gray-400 ${speaker === 'client' ? 'mr-2' : 'ml-2'} mt-1`;
            const now = new Date();
            timestamp.textContent = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });

            bubbleWrapper.appendChild(bubble);
            bubbleWrapper.appendChild(timestamp);

            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(bubbleWrapper);

            transcript.appendChild(messageDiv);
            transcript.scrollTop = transcript.scrollHeight;

            // Save to segments
            transcriptSegments.push({ speaker, text });
        }

        // === AI Analysis ===
        async function analyzeTranscript() {
            // Prevent concurrent API calls
            if (isAnalyzing) {
                console.log('â³ Analysis already in progress, ignoring duplicate request');
                return;
            }

            // Set analyzing flag and loading state for all analyze buttons (do this first for user feedback)
            isAnalyzing = true;
            setAnalyzeButtonsLoading(true);

            if (transcriptSegments.length === 0) {
                // Restore button state and show error
                isAnalyzing = false;
                setAnalyzeButtonsLoading(false);
                alert('ç›®å‰æ²’æœ‰é€å­—ç¨¿å…§å®¹ï¼Œè«‹å…ˆé–‹å§‹éŒ„éŸ³');
                return;
            }

            try {
                // Build transcript text
                const transcriptText = transcriptSegments.map(s =>
                    `${s.speaker === 'counselor' ? 'è«®è©¢å¸«' : 'æ¡ˆä¸»'}ï¼š${s.text}`
                ).join('\n');

                // Skip analysis if transcript is too short (less than 10 characters)
                if (!transcriptText || transcriptText.trim().length < 10) {
                    console.log('â­ï¸ Skipping analysis: transcript too short');
                    isAnalyzing = false;
                    setAnalyzeButtonsLoading(false);
                    return;
                }

                // Calculate time range and capture recording timestamp
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                const timeRange = `${Math.max(0, minutes - 1)}:00-${minutes}:00`;
                const recordingTimestamp = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                // === ä½¿ç”¨å‡è³‡æ–™æ¨¡å¼ï¼ˆDemoï¼‰ ===
                const useMockData = false; // è¨­ç‚º false ä½¿ç”¨çœŸå¯¦ API

                if (useMockData) {
                    // æ™ºæ…§ç”Ÿæˆå‡è³‡æ–™
                    const mockAnalysis = generateMockAnalysis(transcriptText, timeRange, recordingTimestamp);
                    displayAnalysisCard(mockAnalysis);
                    return;
                }

                // === API è·¯å¾‘é¸æ“‡ï¼šNew Session Workflow vs Legacy Realtime API ===
                let analysis;

                if (USE_NEW_SESSION_WORKFLOW && sessionWorkflow) {
                    // === NEW: Use modular Session Workflow (iOS-style) ===
                    console.log('ğŸš€ Using NEW Session Workflow (modular architecture)');

                    // Initialize session if not already done
                    if (!sessionWorkflow.isSessionActive()) {
                        console.log('[Web] Initializing session...');

                        // Use selected client from onboarding (island_parents flow)
                        const selectedClientId = localStorage.getItem('selectedClientId');
                        const selectedClientName = localStorage.getItem('selectedClientName') || 'å­©å­';
                        const authToken = localStorage.getItem('authToken');

                        // If client was selected in onboarding, create case and session for that client
                        if (selectedClientId && authToken) {
                            console.log('[Web] Using selected client:', selectedClientName, selectedClientId);

                            try {
                                // Create case for existing client
                                const caseResponse = await fetch('/api/v1/cases', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${authToken}`
                                    },
                                    body: JSON.stringify({
                                        client_id: selectedClientId,
                                        summary: `å³æ™‚è«®è©¢ - ${selectedClientName} - ${new Date().toLocaleString('zh-TW')}`,
                                        goals: 'è¦ªå­æºé€šç·´ç¿’',
                                        problem_description: counselingMode === 'practice' ? 'ç·´ç¿’æ¨¡å¼' : 'ç·Šæ€¥æ¨¡å¼'
                                    })
                                });

                                if (!caseResponse.ok) {
                                    throw new Error('Failed to create case');
                                }

                                const caseData = await caseResponse.json();
                                const caseId = caseData.id;

                                // Create session for the case
                                const sessionResponse = await fetch('/api/v1/sessions', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${authToken}`
                                    },
                                    body: JSON.stringify({
                                        case_id: caseId,
                                        session_date: new Date().toISOString().split('T')[0],
                                        name: `Web å³æ™‚è«®è©¢ ${new Date().toLocaleString('zh-TW')}`
                                    })
                                });

                                if (!sessionResponse.ok) {
                                    throw new Error('Failed to create session');
                                }

                                const sessionData = await sessionResponse.json();
                                sessionWorkflow.currentSessionId = sessionData.id;
                                sessionWorkflow.currentCaseId = caseId;
                                sessionWorkflow.currentClientId = selectedClientId;

                                console.log('[Web] Session initialized for existing client:', sessionData.id);

                            } catch (error) {
                                console.error('[Web] Failed to create case/session for client:', error);
                                throw new Error(`Session åˆå§‹åŒ–å¤±æ•—: ${error.message}`);
                            }

                        } else {
                            // Fallback: Create new client+case+session (for non-island_parents tenants)
                            console.log('[Web] No client selected, creating new client+case');

                            const clientData = {
                                name: 'ç¶²é å³æ™‚è«®è©¢ç”¨æˆ¶',
                                email: `web-${Date.now()}@example.com`,
                                gender: 'ä¸é€éœ²',
                                birth_date: '2010-01-01',
                                phone: '0900000000',
                                identity_option: 'å®¶é•·',
                                current_status: 'å³æ™‚è«®è©¢ä¸­',
                                case_summary: `å³æ™‚è¦ªå­è«®è©¢ - ${new Date().toLocaleString('zh-TW')}`,
                                case_goals: 'æ”¹å–„è¦ªå­é—œä¿‚',
                                problem_description: 'ç¶²é å³æ™‚è«®è©¢'
                            };

                            try {
                                const sessionId = await sessionWorkflow.initializeSession(clientData);
                                console.log('[Web] Session initialized with new client:', sessionId);
                            } catch (error) {
                                console.error('[Web] Session initialization failed:', error);
                                throw new Error(`Session åˆå§‹åŒ–å¤±æ•—: ${error.message}`);
                            }
                        }
                    }

                    // Perform analysis using new workflow
                    try {
                        analysis = await sessionWorkflow.performAnalysis(transcriptText, counselingMode);
                        console.log('[Web] Analysis complete (new workflow):', analysis);
                    } catch (error) {
                        console.error('[Web] Analysis failed:', error);
                        throw new Error(`æ–°æ¶æ§‹åˆ†æå¤±æ•—: ${error.message}`);
                    }

                } else {
                    // === LEGACY: Use Realtime Analyze API ===
                    console.log('ğŸ“¡ Using LEGACY Realtime API');

                    const requestBody = {
                        mode: counselingMode,  // Emergency or Practice mode
                        transcript: transcriptText,
                        speakers: transcriptSegments,
                        time_range: timeRange,
                        recording_timestamp: recordingTimestamp,
                        provider: currentProvider,
                        session_id: currentSessionId,  // Unified session ID
                        use_cache: true  // Enable Gemini caching
                    };

                    // Add codeer_model parameter when using Codeer provider
                    if (currentProvider === 'codeer') {
                        requestBody.codeer_model = currentCodeerModel;
                    }

                    const response = await fetch('/api/v1/realtime/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`API error ${response.status}:`, errorText);
                        throw new Error(`åˆ†æå¤±æ•— (HTTP ${response.status})`);
                    }

                    analysis = await response.json();
                }

                // Check if this is an error response (backend returned error structure)
                if (analysis.summary && analysis.summary.includes('å¤±æ•—')) {
                    console.warn('Backend returned error analysis:', analysis);
                    // Display error card with clear indication
                    analysis.is_error = true;
                }

                // Add recording timestamp if not provided by API
                if (!analysis.recording_timestamp) {
                    analysis.recording_timestamp = recordingTimestamp;
                }

                // Update analysis interval based on safety_level
                if (analysis.safety_level) {
                    updateAnalysisInterval(analysis.safety_level);
                }

                displayAnalysisCard(analysis);

            } catch (error) {
                console.error('Analysis error:', error);

                // Show error message to user (don't silently fall back to mock data)
                alert(`åˆ†æå¤±æ•—: ${error.message}\n\nè«‹æª¢æŸ¥:\n1. Codeer API é€£ç·šæ˜¯å¦æ­£å¸¸\n2. é¸æ“‡çš„æ¨¡å‹æ˜¯å¦å·²è¨­å®š\n3. æŸ¥çœ‹ Console äº†è§£è©³ç´°éŒ¯èª¤`);

                // Log detailed error for debugging
                console.warn('åˆ†æå¤±æ•—ï¼ŒéŒ¯èª¤è©³æƒ…:', {
                    provider: currentProvider,
                    model: currentCodeerModel,
                    error: error.message
                });
            } finally {
                // Always restore analyzing flag and button states, even if error occurs
                isAnalyzing = false;
                setAnalyzeButtonsLoading(false);
            }
        }

        // === Quick Feedback (é›æ¹¯æ–‡) - Every 20 seconds during green/yellow ===
        async function getQuickFeedback() {
            try {
                // Get last 20 seconds of transcript
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const recentSegments = transcriptSegments.slice(-8); // Last 8 segments (~20 seconds)

                if (recentSegments.length === 0) {
                    console.log('â­ï¸ Skipping quick feedback: no recent transcript');
                    return;
                }

                const recentTranscript = recentSegments.map(s =>
                    `${s.speaker === 'counselor' ? 'å®¶é•·' : 'å­©å­'}ï¼š${s.text}`
                ).join('\n');

                console.log(`ğŸ’¡ Requesting quick feedback for recent transcript (${recentTranscript.length} chars)`);

                // Call quick-feedback API
                const response = await fetch('/api/v1/realtime/quick-feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recent_transcript: recentTranscript })
                });

                if (!response.ok) {
                    console.error(`Quick feedback API error: ${response.status}`);
                    return;
                }

                const data = await response.json();
                console.log(`âœ… Quick feedback received (${data.latency_ms}ms): ${data.message}`);

                // Display quick feedback (you can customize display location)
                showQuickFeedbackMessage(data.message);

            } catch (error) {
                console.error('âŒ Quick feedback failed:', error);
            }
        }

        // Display quick feedback message (minimal UI update)
        // Shows below the deep analysis text, doesn't overwrite it
        function showQuickFeedbackMessage(message) {
            const quickFeedbackText = document.getElementById('quickFeedbackText');
            const carouselQuickFeedbackText = document.getElementById('carouselQuickFeedbackText');

            if (window.innerWidth < 768) {
                // Mobile: Update quick feedback text (below deep analysis) in both circles
                if (quickFeedbackText) {
                    quickFeedbackText.textContent = `ğŸ’¡ ${message}`;
                }
                if (carouselQuickFeedbackText) {
                    carouselQuickFeedbackText.textContent = `ğŸ’¡ ${message}`;
                }
                console.log(`ğŸ’¬ Quick feedback displayed: ${message}`);
            } else {
                console.log(`âš ï¸ Quick feedback not shown (desktop mode)`);
            }
        }

        // Helper function to set loading state for analyze buttons
        function setAnalyzeButtonsLoading(isLoading) {
            const buttons = [
                { btn: fabAnalyzeMobile, icon: 'âš¡', text: 'å³æ™‚åˆ†æ' },
                { btn: triggerAnalysisBtn, icon: 'âš¡', text: 'ç«‹å³åˆ†æ' },
                { btn: quickTestAnalyzeBtn, icon: 'âš¡', text: 'ç«‹å³åˆ†æ' },
                { btn: quickTestAnalyzeBtnDesktop, icon: 'âš¡', text: 'ç«‹å³åˆ†æ' }
            ];

            buttons.forEach(({ btn, icon, text }) => {
                if (!btn) return;

                if (isLoading) {
                    // Set loading state
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    btn.classList.remove('hover:shadow-xl');

                    // Update button content with spinner
                    const isFabMobile = btn.id === 'fabAnalyzeMobile';
                    if (isFabMobile) {
                        btn.innerHTML = `
                            <span class="text-3xl spinner">âš™ï¸</span>
                            <span class="text-lg tracking-wide">åˆ†æä¸­...</span>
                        `;
                    } else {
                        btn.innerHTML = `
                            <span class="spinner">âš™ï¸</span>
                            <span class="hidden sm:inline">åˆ†æä¸­...</span>
                            <span class="sm:hidden">...</span>
                        `;
                    }
                } else {
                    // Restore normal state (only if recording is active)
                    if (isRecording) {
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }

                    // Restore original button content
                    const isFabMobile = btn.id === 'fabAnalyzeMobile';
                    if (isFabMobile) {
                        btn.innerHTML = `
                            <span class="text-3xl">${icon}</span>
                            <span class="text-lg tracking-wide">${text}</span>
                        `;
                    } else {
                        btn.innerHTML = `
                            <span>${icon}</span>
                            <span class="hidden sm:inline">${text}</span>
                            <span class="sm:hidden">åˆ†æ</span>
                        `;
                    }
                }
            });
        }

        // === Mock Data Generator ===
        function generateMockAnalysis(transcriptText, timeRange, recordingTimestamp) {
            const lowerText = transcriptText.toLowerCase();

            // åµæ¸¬é—œéµè­°é¡Œ
            const hasSuicideRisk = /è‡ªæ®º|æƒ³æ­»|æ´»è‘—æ²’æ„ç¾©|ä¸æƒ³æ´»|çµæŸç”Ÿå‘½/.test(transcriptText);
            const hasAnxiety = /ç„¦æ…®|å£“åŠ›|ç·Šå¼µ|å®³æ€•|æ“”å¿ƒ/.test(transcriptText);
            const hasDepression = /æ†‚é¬±|æ²®å–ª|ç„¡åŠ›|ç–²ç´¯|å¤±çœ /.test(transcriptText);
            const hasWork = /å·¥ä½œ|ä¸»ç®¡|è€é—†|åŒäº‹|è·å ´/.test(transcriptText);
            const hasFamily = /å®¶äºº|çˆ¶æ¯|é…å¶|å°å­©|å®¶åº­/.test(transcriptText);
            const hasRelationship = /é—œä¿‚|æœ‹å‹|ä¼´ä¾¶|æ„Ÿæƒ…/.test(transcriptText);

            // ç”Ÿæˆæ‘˜è¦
            let summary = '';
            if (hasSuicideRisk) {
                summary = 'âš ï¸ æ¡ˆä¸»è¡¨é”è‡ªæ®ºæ„å¿µï¼Œè«®è©¢å¸«æ­£åœ¨è©•ä¼°é¢¨éšªç¨‹åº¦ã€‚éœ€ç«‹å³é—œæ³¨æ¡ˆä¸»å®‰å…¨ã€‚';
            } else if (hasDepression && hasWork) {
                summary = 'æ¡ˆä¸»è¡¨é”å·¥ä½œç›¸é—œçš„æ†‚é¬±ç—‡ç‹€ï¼Œè«®è©¢å¸«åŒç†æ¡ˆä¸»è™•å¢ƒï¼Œæ¢ç´¢å£“åŠ›ä¾†æºã€‚';
            } else if (hasAnxiety && hasFamily) {
                summary = 'æ¡ˆä¸»è«‡åŠå®¶åº­è­°é¡Œå¼•ç™¼çš„ç„¦æ…®æ„Ÿå—ï¼Œè«®è©¢å¸«ä½¿ç”¨åæ˜ æŠ€å·§å»ºç«‹é—œä¿‚ã€‚';
            } else if (hasWork) {
                summary = 'æ¡ˆä¸»åˆ†äº«å·¥ä½œå›°æ“¾ï¼Œè«®è©¢å¸«å¼•å°æ¡ˆä¸»æ¢ç´¢å…·é«”æƒ…å¢ƒèˆ‡æ„Ÿå—ã€‚';
            } else if (hasRelationship) {
                summary = 'æ¡ˆä¸»è«‡è«–äººéš›é—œä¿‚è­°é¡Œï¼Œè«®è©¢å¸«å”åŠ©æ¡ˆä¸»è¦ºå¯Ÿäº’å‹•æ¨¡å¼ã€‚';
            } else {
                summary = 'è«®è©¢å¸«èˆ‡æ¡ˆä¸»å»ºç«‹åˆæ­¥é—œä¿‚ï¼Œé–‹å§‹æ¢ç´¢æ¡ˆä¸»ç•¶å‰é—œæ³¨è­°é¡Œã€‚';
            }

            // ç”Ÿæˆè­¦ç¤º
            const alerts = [];
            if (hasSuicideRisk) {
                alerts.push('âš ï¸ é«˜é¢¨éšªï¼šæ¡ˆä¸»æåŠè‡ªæ®ºç›¸é—œå­—çœ¼ï¼Œéœ€ç«‹å³è©•ä¼°è‡ªæ®ºé¢¨éšªï¼ˆè¨ˆç•«ã€æ–¹æ³•ã€æ™‚é–“ï¼‰');
                alerts.push('âš ï¸ å®‰å…¨è©•ä¼°ï¼šè€ƒæ…®æ˜¯å¦éœ€è¦å±æ©Ÿè™•ç†ã€è¯çµ¡ç·Šæ€¥è¯çµ¡äººæˆ–è½‰ä»‹ç²¾ç¥ç§‘');
                alerts.push('âš ï¸ æŒçºŒè¿½è¹¤ï¼šæœ¬æ¬¡æœƒè«‡çµæŸå‰ç¢ºèªæ¡ˆä¸»å®‰å…¨ï¼Œå®‰æ’å¯†é›†è¿½è¹¤');
            } else if (hasDepression) {
                alerts.push('âš ï¸ æ³¨æ„æ¡ˆä¸»æƒ…ç·’ç‹€æ…‹ï¼Œè©•ä¼°æ†‚é¬±ç¨‹åº¦ï¼ˆæŒçºŒæ™‚é–“ã€åš´é‡åº¦ã€åŠŸèƒ½å½±éŸ¿ï¼‰');
                alerts.push('âš ï¸ å¦‚ç—‡ç‹€æŒçºŒå…©é€±ä»¥ä¸Šï¼Œå»ºè­°è©•ä¼°æ˜¯å¦éœ€è¦ç²¾ç¥ç§‘æœƒè¨º');
            } else if (hasAnxiety) {
                alerts.push('âš ï¸ æ¡ˆä¸»ç„¦æ…®ç¨‹åº¦è¼ƒé«˜ï¼Œæ³¨æ„ç”Ÿç†ç—‡ç‹€ï¼ˆå¿ƒè·³ã€å‘¼å¸ã€è‚Œè‚‰ç·Šç¹ƒï¼‰');
            }

            // ä¸€èˆ¬æé†’
            if (transcriptSegments.filter(s => s.speaker === 'counselor').length < transcriptSegments.length * 0.3) {
                alerts.push('ğŸ’¡ è«®è©¢å¸«ç™¼è¨€æ¯”ä¾‹è¼ƒå°‘ï¼Œå¯é©åº¦å¼•å°å°è©±æ–¹å‘');
            }
            if (transcriptSegments.length > 10) {
                alerts.push('âœ… å°è©±æŒçºŒé€²è¡Œä¸­ï¼Œæ³¨æ„æ™‚é–“ç®¡ç†èˆ‡æœƒè«‡çµæ§‹');
            }

            // ç”Ÿæˆå»ºè­°
            const suggestions = [];
            if (hasSuicideRisk) {
                suggestions.push('ğŸ’¡ ç›´æ¥è©•ä¼°ï¼šã€Œç•¶ä½ èªªä¸æƒ³æ´»äº†ï¼Œæ˜¯å¦æ›¾æƒ³éè¦å¦‚ä½•çµæŸç”Ÿå‘½ï¼Ÿã€');
                suggestions.push('ğŸ’¡ è©•ä¼°ä¿è­·å› å­ï¼šã€Œæœ‰ä»€éº¼äº‹æƒ…æˆ–äººï¼Œè®“ä½ åˆ°ç¾åœ¨é‚„é¡˜æ„æ´»è‘—ï¼Ÿã€');
                suggestions.push('ğŸ’¡ å»ºç«‹å®‰å…¨è¨ˆç•«ï¼šèˆ‡æ¡ˆä¸»è¨è«–å±æ©Ÿæ™‚å¯ä»¥åšä»€éº¼ã€å¯ä»¥æ‰¾èª°');
            } else if (hasDepression && hasWork) {
                suggestions.push('ğŸ’¡ æ¢ç´¢å·¥ä½œå£“åŠ›æºï¼šã€Œå·¥ä½œä¸­å“ªäº›å…·é«”æƒ…æ³è®“ä½ æ„Ÿåˆ°ç‰¹åˆ¥æ²®å–ªï¼Ÿã€');
                suggestions.push('ğŸ’¡ è©•ä¼°åŠŸèƒ½å½±éŸ¿ï¼šã€Œé€™äº›æ„Ÿå—å¦‚ä½•å½±éŸ¿ä½ çš„æ—¥å¸¸ç”Ÿæ´»å’Œå·¥ä½œè¡¨ç¾ï¼Ÿã€');
                suggestions.push('ğŸ’¡ æ‰¾å‡ºå› æ‡‰è³‡æºï¼šã€Œéå»é‡åˆ°é¡ä¼¼å›°é›£æ™‚ï¼Œä½ æ˜¯æ€éº¼åº¦éçš„ï¼Ÿã€');
            } else if (hasAnxiety) {
                suggestions.push('ğŸ’¡ å¼•å°å…·é«”åŒ–ï¼šã€Œç•¶ç„¦æ…®å‡ºç¾æ™‚ï¼Œä½ çš„èº«é«”æœ‰ä»€éº¼æ„Ÿè¦ºï¼Ÿã€');
                suggestions.push('ğŸ’¡ æ•™å°æ”¾é¬†æŠ€å·§ï¼šè€ƒæ…®å¼•å…¥å‘¼å¸ç·´ç¿’æˆ–æ­£å¿µæŠ€å·§');
                suggestions.push('ğŸ’¡ æ¢ç´¢ç„¦æ…®è§¸ç™¼é»ï¼šã€Œä»€éº¼æƒ…æ³ä¸‹ç„¦æ…®æ„Ÿæœƒç‰¹åˆ¥å¼·çƒˆï¼Ÿã€');
            } else if (hasWork) {
                suggestions.push('ğŸ’¡ å…·é«”åŒ–æ¢ç´¢ï¼šã€Œå¯ä»¥èªªèªªæœ€è¿‘ä¸€æ¬¡å›°æ“¾çš„å…·é«”æƒ…æ³å—ï¼Ÿã€');
                suggestions.push('ğŸ’¡ æƒ…ç·’åæ˜ ï¼šã€Œè½èµ·ä¾†é€™è®“ä½ æ„Ÿåˆ°...ï¼ˆæŒ«æŠ˜/æ†¤æ€’/ç„¡åŠ›ï¼‰ã€');
                suggestions.push('ğŸ’¡ è©•ä¼°æ”¯æŒç³»çµ±ï¼šã€Œå·¥ä½œä¹‹å¤–ï¼Œä½ æœ‰å¯ä»¥è«‡å¿ƒçš„å°è±¡å—ï¼Ÿã€');
            } else {
                suggestions.push('ğŸ’¡ é–‹æ”¾å¼æå•ï¼šã€Œä»Šå¤©æœ€æƒ³è«‡çš„æ˜¯ä»€éº¼ï¼Ÿã€');
                suggestions.push('ğŸ’¡ å»ºç«‹é—œä¿‚ï¼šä½¿ç”¨åŒç†å¿ƒå›æ‡‰ï¼Œè®“æ¡ˆä¸»æ„Ÿåˆ°è¢«ç†è§£');
                suggestions.push('ğŸ’¡ æ¾„æ¸…ç›®æ¨™ï¼šã€Œä½ å¸Œæœ›é€éè«®è©¢é”åˆ°ä»€éº¼ï¼Ÿã€');
            }

            return {
                summary: summary,
                alerts: alerts.slice(0, 3), // æœ€å¤š3å€‹è­¦ç¤º
                suggestions: suggestions.slice(0, 3), // æœ€å¤š3å€‹å»ºè­°
                time_range: timeRange,
                recording_timestamp: recordingTimestamp,
                timestamp: new Date().toISOString()
            };
        }

        function displayAnalysisCard(analysis) {
            // Build Safety Level configuration with radial gradient backgrounds
            let riskConfig = {
                'red': {
                    emoji: 'ğŸ”´',
                    label: 'å±éšª',
                    cardBg: 'bg-red-50',  // Fallback for web
                    gradientBg: 'radial-gradient(circle, #f9a8d4 0%, #fbcfe8 40%, #fce7f3 70%, #fdf2f8 100%)',  // Pink radial
                    borderColor: 'border-red-300',
                    headerBg: 'bg-white/10 backdrop-blur-sm',  // Transparent header
                    textColor: 'text-red-900',  // Darker for better contrast
                    title: 'å±éšªï¼šç«‹å³ä¿®æ­£'
                },
                'yellow': {
                    emoji: 'ğŸ’›',
                    label: 'è­¦ç¤º',
                    cardBg: 'bg-yellow-50',  // Fallback for web
                    gradientBg: 'radial-gradient(circle, #fde047 0%, #fef08a 40%, #fef9c3 70%, #fefce8 100%)',  // Yellow radial
                    borderColor: 'border-yellow-300',
                    headerBg: 'bg-white/10 backdrop-blur-sm',  // Transparent header
                    textColor: 'text-yellow-900',  // Darker for better contrast
                    title: 'è­¦ç¤ºï¼šéœ€è¦èª¿æ•´'
                },
                'green': {
                    emoji: 'ğŸ’š',
                    label: 'å®‰å…¨',
                    cardBg: 'bg-green-50',  // Fallback for web
                    gradientBg: 'radial-gradient(circle, #67e8f9 0%, #99f6e4 40%, #ccfbf1 70%, #f0fdfa 100%)',  // Teal/Cyan radial
                    borderColor: 'border-green-300',
                    headerBg: 'bg-white/10 backdrop-blur-sm',  // Transparent header
                    textColor: 'text-teal-900',  // Darker for better contrast
                    title: 'å®‰å…¨ï¼šæºé€šè‰¯å¥½'
                }
            };

            // Clear placeholder/empty state
            if (analysisEmpty) analysisEmpty.style.display = 'none';

            const card = document.createElement('div');

            // Use error styling if this is an error response
            const isError = analysis.is_error || (analysis.summary && analysis.summary.includes('å¤±æ•—'));

            // Get current risk config
            const currentRiskConfig = analysis.safety_level ? (riskConfig[analysis.safety_level] || riskConfig['green']) : riskConfig['green'];

            // Set card background and border based on safety level
            // Mobile: full-screen with radial gradient background
            // Desktop: right panel card with solid background
            const cardBgColor = currentRiskConfig.cardBg;
            const cardBorderColor = currentRiskConfig.borderColor;

            // Apply responsive classes
            // Mobile: fixed positioning for full-screen with radial gradient
            // Desktop: normal card in right panel with radial gradient
            card.className = `rounded-xl shadow-md hover:shadow-lg transition-shadow p-6 md:p-5 border-2 ${cardBorderColor} fade-in card-hover fixed md:relative inset-0 md:inset-auto z-50 md:z-auto overflow-y-auto md:overflow-visible`;

            // Apply radial gradient background for both mobile and desktop
            card.style.background = currentRiskConfig.gradientBg;

            // Determine severity for alerts
            const hasCritical = analysis.alerts.some(a => a.includes('ğŸ”´') || a.includes('é«˜é¢¨éšª'));
            const hasWarning = analysis.alerts.some(a => a.includes('âš ï¸'));

            // Display model badge if provider_metadata is available
            const modelBadge = analysis.provider_metadata && analysis.provider_metadata.model
                ? `<span class="inline-flex items-center gap-1 px-2 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-medium">
                    <span>ğŸ¤–</span>
                    <span>${analysis.provider_metadata.model}</span>
                   </span>`
                : '';

            // Build token usage badge
            let tokenUsageBadge = '';
            if (analysis.cache_metadata) {
                // Gemini with cache - show actual token count
                const cache = analysis.cache_metadata;
                const totalTokens = cache.cached_tokens + cache.prompt_tokens;
                const cachePercentage = totalTokens > 0 ? Math.round((cache.cached_tokens / totalTokens) * 100) : 0;
                tokenUsageBadge = `<span class="inline-flex items-center gap-1 px-2 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-medium" title="Cache: ${cache.cached_tokens.toLocaleString()} | New: ${cache.prompt_tokens.toLocaleString()} | Cache Hit: ${cachePercentage}%">
                    <span>ğŸ¯</span>
                    <span>${cache.cached_tokens.toLocaleString()} by cache</span>
                   </span>`;
            } else if (analysis.provider_metadata) {
                // Check provider type
                if (analysis.provider_metadata.provider === 'codeer') {
                    // Codeer with real token usage
                    if (analysis.provider_metadata.codeer_token_usage) {
                        const tokens = analysis.provider_metadata.codeer_token_usage;
                        tokenUsageBadge = `<span class="inline-flex items-center gap-1 px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-medium" title="Prompt: ${tokens.total_prompt_tokens.toLocaleString()} | Completion: ${tokens.total_completion_tokens.toLocaleString()} | Calls: ${tokens.total_calls}">
                            <span>ğŸ“Š</span>
                            <span>${tokens.total_tokens.toLocaleString()} tokens</span>
                           </span>`;
                    } else {
                        // Fallback if token usage is not available
                        tokenUsageBadge = `<span class="inline-flex items-center gap-1 px-2 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-medium" title="Token usage unavailable">
                            <span>ğŸ“Š</span>
                            <span>ç„¡è³‡æ–™</span>
                           </span>`;
                    }
                } else if (analysis.provider_metadata.provider === 'gemini') {
                    // Gemini without cache (content too short)
                    tokenUsageBadge = `<span class="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-600 rounded-full text-xs font-medium" title="å°è©±è¼ƒçŸ­ï¼Œæœªå•Ÿç”¨ cache">
                        <span>ğŸ’¬</span>
                        <span>0 by cache</span>
                       </span>`;
                }
            }

            // Build RAG badge based on actual usage
            let ragBadge = '';
            if (analysis.rag_sources && analysis.rag_sources.length > 0) {
                // Has RAG sources - show green checkmark
                ragBadge = `<span class="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium" title="ä½¿ç”¨çŸ¥è­˜åº«ï¼š${analysis.rag_sources.length} ç­†è³‡æ–™">
                    <span>âœ…</span>
                    <span>RAG</span>
                   </span>`;
            } else {
                // No RAG sources - show gray X
                ragBadge = `<span class="inline-flex items-center gap-1 px-2 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-medium" title="æœªä½¿ç”¨çŸ¥è­˜åº«">
                    <span>âŒ</span>
                    <span>RAG</span>
                   </span>`;
            }

            card.innerHTML = `
                <!-- Safety Level Header - Prominent Display -->
                <div class="flex items-center justify-between ${currentRiskConfig.headerBg} -mx-6 -mt-6 md:-mx-5 md:-mt-5 px-6 py-4 md:px-5 md:py-3 rounded-t-xl mb-4 border-b-2 ${currentRiskConfig.borderColor}">
                    <div class="flex items-center gap-3">
                        <span class="text-5xl md:text-4xl">${currentRiskConfig.emoji}</span>
                        <div>
                            <div class="font-bold text-xl md:text-lg ${currentRiskConfig.textColor}">${currentRiskConfig.label}</div>
                            <div class="text-sm md:text-xs ${currentRiskConfig.textColor} opacity-75">${currentRiskConfig.title}</div>
                        </div>
                    </div>
                    <span class="text-xs text-gray-500">${new Date(analysis.timestamp).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })}</span>
                </div>

                <!-- Meta Information - Collapsible -->
                <details class="mb-3">
                    <summary class="cursor-pointer text-xs text-gray-500 hover:text-gray-700 transition-colors inline-flex items-center gap-1">
                        <span>è©³ç´°è³‡è¨Š</span>
                        <span class="text-[10px]">â–¼</span>
                    </summary>
                    <div class="flex items-center gap-2 flex-wrap mt-2 pt-2 border-t border-gray-200/50">
                        <span class="inline-block px-3 py-1 bg-purple-100/50 text-purple-700 text-xs font-semibold rounded-full">
                            ${analysis.time_range}
                        </span>
                        ${analysis.recording_timestamp ? `
                            <span class="inline-flex items-center gap-1 px-2 py-1 bg-teal-100/50 text-teal-700 rounded-full text-xs font-medium">
                                <span>â±</span>
                                <span>${analysis.recording_timestamp}</span>
                            </span>
                        ` : ''}
                        ${modelBadge}
                        ${tokenUsageBadge}
                        ${ragBadge}
                    </div>
                </details>

                <!-- Summary Section (Practice mode only) -->
                ${analysis.alerts && analysis.alerts.length > 0 ? `
                <div class="mb-4">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-6 h-6 bg-blue-100 rounded flex items-center justify-center">
                            ğŸ“‹
                        </div>
                        <h3 class="font-bold text-sm md:text-base text-gray-800">æ‘˜è¦</h3>
                    </div>
                    <p class="text-sm text-gray-700 leading-relaxed pl-8">${analysis.summary}</p>
                </div>

                <!-- Alerts Section -->
                ` : ''}
                ${analysis.alerts && analysis.alerts.length > 0 ? `
                    <div class="mb-4">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-6 h-6 ${hasCritical ? 'bg-red-100' : 'bg-yellow-100'} rounded flex items-center justify-center">
                                ${hasCritical ? 'ğŸ”´' : 'âš ï¸'}
                            </div>
                            <h3 class="font-bold text-sm md:text-base text-gray-800">è­¦ç¤º</h3>
                        </div>
                        <div class="space-y-2 pl-8">
                            ${analysis.alerts.map(alert => {
                                const isCritical = alert.includes('ğŸ”´') || alert.includes('é«˜é¢¨éšª');
                                const isWarning = alert.includes('âš ï¸');
                                const bgColor = isCritical ? 'bg-red-50 border-red-200' : isWarning ? 'bg-yellow-50 border-yellow-200' : 'bg-blue-50 border-blue-200';
                                const textColor = isCritical ? 'text-red-700' : isWarning ? 'text-yellow-700' : 'text-blue-700';
                                const badgeClass = isCritical ? 'badge-critical' : isWarning ? 'badge-warning' : 'badge-info';
                                const severity = isCritical ? 'é«˜' : isWarning ? 'ä¸­' : 'ä½';

                                return `
                                    <div class="flex items-start gap-2 p-2 ${bgColor} rounded-lg border transition-smooth hover:shadow-sm">
                                        <span class="px-2 py-0.5 ${badgeClass} text-white text-xs rounded font-bold shadow-sm">${severity}</span>
                                        <p class="text-xs md:text-sm ${textColor} flex-1 leading-relaxed">${alert}</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- Suggestions Section -->
                ${analysis.suggestions.length > 0 ? `
                    <div class="mb-4">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-6 h-6 bg-green-100 rounded flex items-center justify-center">
                                ğŸ’¡
                            </div>
                            <h3 class="font-bold text-sm md:text-base text-gray-800">å³æ™‚å»ºè­°</h3>
                            <span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded-full font-medium">åˆ†æå®Œæˆ</span>
                        </div>
                        <div class="space-y-2">
                            ${analysis.suggestions.map(sug => {
                                // Unified single-line format for all suggestions (200 expert suggestions)
                                return `
                                    <div class="p-4 md:p-6 bg-white/10 backdrop-blur-sm rounded-lg hover:bg-white/20 transition-smooth cursor-pointer">
                                        <p class="text-xl md:text-2xl text-green-900 leading-relaxed font-semibold">${sug}</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- RAG Knowledge Sources Section -->
                ${analysis.rag_sources && analysis.rag_sources.length > 0 ? `
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-6 h-6 bg-purple-100 rounded flex items-center justify-center">
                                ğŸ“š
                            </div>
                            <h3 class="font-bold text-sm md:text-base text-gray-800">åƒè€ƒç†è«–</h3>
                        </div>
                        <div class="space-y-2 pl-8">
                            ${analysis.rag_sources.map(source => {
                                // Theory-based color mapping
                                const theoryColors = {
                                    'æ­£å‘æ•™é¤Š': { bg: 'bg-purple-50', border: 'border-purple-300', badge: 'bg-purple-500', text: 'text-purple-700' },
                                    'æƒ…ç·’æ•™é¤Š': { bg: 'bg-blue-50', border: 'border-blue-300', badge: 'bg-blue-500', text: 'text-blue-700' },
                                    'ä¾é™„ç†è«–': { bg: 'bg-green-50', border: 'border-green-300', badge: 'bg-green-500', text: 'text-green-700' },
                                    'èªçŸ¥ç™¼å±•ç†è«–': { bg: 'bg-orange-50', border: 'border-orange-300', badge: 'bg-orange-500', text: 'text-orange-700' },
                                    'è‡ªæˆ‘æ±ºå®šè«–': { bg: 'bg-pink-50', border: 'border-pink-300', badge: 'bg-pink-500', text: 'text-pink-700' },
                                    'å…¶ä»–': { bg: 'bg-gray-50', border: 'border-gray-300', badge: 'bg-gray-500', text: 'text-gray-700' }
                                };
                                const colors = theoryColors[source.theory] || theoryColors['å…¶ä»–'];

                                return `
                                    <div class="p-3 ${colors.bg} border ${colors.border} rounded-lg hover:shadow-sm transition-smooth">
                                        <div class="flex items-start gap-2 mb-2">
                                            <span class="inline-flex items-center px-2 py-1 ${colors.badge} text-white text-xs font-semibold rounded-full shadow-sm">
                                                ${source.theory}
                                            </span>
                                            <span class="inline-flex items-center px-2 py-0.5 bg-white/80 text-gray-600 text-xs rounded-full">
                                                ç›¸ä¼¼åº¦ ${(source.score * 100).toFixed(0)}%
                                            </span>
                                        </div>
                                        <p class="text-xs font-semibold ${colors.text} mb-1">${source.title}</p>
                                        <p class="text-xs ${colors.text} opacity-80 leading-relaxed">${source.content}</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}
            `;

            // Display provider metadata if available
            if (analysis.provider_metadata) {
                const meta = analysis.provider_metadata;
                const latencySpan = document.getElementById('providerLatency');
                const latencySpanDesktop = document.getElementById('providerLatencyDesktop');

                const latencyText = `${(meta.latency_ms / 1000).toFixed(1)}s`;

                if (latencySpan) {
                    latencySpan.textContent = latencyText;
                    latencySpan.classList.remove('hidden');
                }

                if (latencySpanDesktop) {
                    latencySpanDesktop.textContent = latencyText;
                    latencySpanDesktop.classList.remove('hidden');
                }

                console.log(`Provider: ${meta.provider}, Latency: ${meta.latency_ms}ms, Model: ${meta.model}`);
            }

            // Desktop: Animate card entrance
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            analysisCards.insertBefore(card, analysisCards.firstChild);

            setTimeout(() => {
                card.style.transition = 'all 0.3s ease-out';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, 10);

            // REQUIREMENT 6: Mobile carousel implementation
            // Always create mobile card (regardless of current screen size)
            // This ensures cards persist when switching between desktop/mobile views
            if (mobileCarouselTrack) {
                // Hide initial UI when first analysis appears
                if (initialUI && mobileAnalysisCards.length === 0) {
                    initialUI.classList.add('hidden');
                }
                // Also hide practice intro UI
                if (practiceIntroUI && mobileAnalysisCards.length === 0) {
                    practiceIntroUI.classList.add('hidden');
                }

                // Show carousel container
                if (mobileCarousel) {
                    mobileCarousel.classList.remove('hidden');
                }

                // Create mobile card (full width and height for carousel)
                const mobileCard = document.createElement('div');
                mobileCard.className = 'flex-shrink-0 w-full h-full bg-white rounded-2xl shadow-md p-5 border-l-4 border-purple-500 overflow-y-auto';
                mobileCard.innerHTML = card.innerHTML;

                // Add to carousel track (append to maintain chronological order)
                // Index 0 = oldest (1/4), Index length-1 = newest (4/4)
                mobileCarouselTrack.appendChild(mobileCard);
                mobileAnalysisCards.push(analysis);

                // Jump to newest card (last index)
                currentCarouselIndex = mobileAnalysisCards.length - 1;
                updateCarousel();
            }

            // Save to history
            analysisHistory.push(analysis);

            // Update mobile suggestion circle with first suggestion
            if (analysis.suggestions && analysis.suggestions.length > 0) {
                const safetyLevel = analysis.safety_level || 'green';
                console.log(`ğŸ” displayAnalysisCard: About to call updateMobileSuggestionCircle`);
                console.log(`ğŸ” - safety_level: "${safetyLevel}"`);
                console.log(`ğŸ” - suggestions[0]: "${analysis.suggestions[0]}"`);
                console.log(`ğŸ” - suggestions array length: ${analysis.suggestions.length}`);
                updateMobileSuggestionCircle(safetyLevel, analysis.suggestions[0]);
            } else {
                console.log(`âš ï¸ displayAnalysisCard: No suggestions found in analysis`);
                console.log(`ğŸ” - analysis.suggestions:`, analysis.suggestions);
            }
        }

        function showError(message) {
            const card = document.createElement('div');
            card.className = 'bg-red-50 rounded-lg p-4 border-l-4 border-red-500';
            card.innerHTML = `<p class="text-sm text-red-700">âŒ ${message}</p>`;
            analysisCards.insertBefore(card, analysisCards.firstChild);
        }

        // === Auto-Analysis Notification ===
        function showAutoAnalysisNotification(isQuickAnalysis = false) {
            // Different styles for quick vs deep analysis
            const bgGradient = isQuickAnalysis
                ? 'from-yellow-400 to-yellow-200'  // Quick: Yellow gradient
                : 'from-purple-500 to-indigo-600'; // Deep: Purple-blue gradient

            const textColor = isQuickAnalysis
                ? 'text-yellow-900'  // Darker text for yellow background
                : 'text-white';      // White text for purple background

            const message = isQuickAnalysis
                ? 'âš¡ å¿«é€Ÿåˆ†æä¸­...'
                : 'âš¡ è‡ªå‹•åˆ†æä¸­...';

            // Create toast notification
            const toast = document.createElement('div');
            toast.className = `fixed top-20 right-4 bg-gradient-to-r ${bgGradient} ${textColor} px-6 py-3 rounded-lg shadow-xl z-50 flex items-center gap-2 animate-slide-in-right`;
            toast.innerHTML = `
                <span class="text-lg">âš¡</span>
                <span class="font-medium">${message}</span>
            `;

            document.body.appendChild(toast);

            // Auto-remove after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                toast.style.transition = 'all 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // === Manual Analysis Triggers ===
        function manuallyTriggerAnalysis() {
            if (transcriptSegments.length === 0) {
                alert('è«‹å…ˆæŒ‰ T éµæ–°å¢å°è©±å…§å®¹');
                return;
            }
            analyzeTranscript();
        }

        // === localStorage Management ===
        function saveToHistory() {
            const session = {
                timestamp: new Date().toISOString(),
                duration: timer.textContent,
                transcript: transcriptSegments,
                analyses: analysisHistory
            };

            const history = JSON.parse(localStorage.getItem('realtimeCounselingHistory') || '[]');
            history.unshift(session);

            // Keep last 10 sessions
            localStorage.setItem('realtimeCounselingHistory', JSON.stringify(history.slice(0, 10)));
        }

        function toggleHistory() {
            const section = document.getElementById('historySection');
            const toggle = document.getElementById('historyToggle');

            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                toggle.textContent = 'â–²';
                toggle.style.transform = 'rotate(180deg)';
                loadHistory();
            } else {
                section.classList.add('hidden');
                toggle.textContent = 'â–¼';
                toggle.style.transform = 'rotate(0deg)';
            }
        }

        function toggleTranscript() {
            const section = document.getElementById('transcriptSection');
            const toggle = document.getElementById('transcriptToggle');

            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                toggle.textContent = 'â–²';
                toggle.style.transform = 'rotate(180deg)';
            } else {
                section.classList.add('hidden');
                toggle.textContent = 'â–¼';
                toggle.style.transform = 'rotate(0deg)';
            }
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('realtimeCounselingHistory') || '[]');
            const list = document.getElementById('historyList');

            if (history.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-8">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <span class="text-3xl">ğŸ“‚</span>
                        </div>
                        <p class="text-gray-400 font-medium">å°šç„¡æ­·å²è¨˜éŒ„</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = history.map((session, index) => `
                <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-4 border border-gray-200 hover:shadow-md transition-smooth">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <span class="w-8 h-8 bg-indigo-500 text-white rounded-lg flex items-center justify-center text-sm font-bold">#${index + 1}</span>
                            <div>
                                <p class="font-bold text-gray-800 text-sm">${new Date(session.timestamp).toLocaleString('zh-TW', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                                <p class="text-xs text-gray-500">æœƒè«‡æ™‚é•·ï¼š${session.duration}</p>
                            </div>
                        </div>
                        <span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full font-bold">
                            ${session.analyses.length} æ¬¡åˆ†æ
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function clearHistory() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ­·å²è¨˜éŒ„å—ï¼Ÿ')) {
                localStorage.removeItem('realtimeCounselingHistory');
                loadHistory();
            }
        }

        // === REQUIREMENT 6: Carousel Navigation Functions ===
        function navigateCarousel(direction) {
            if (mobileAnalysisCards.length === 0) return;

            currentCarouselIndex += direction;

            // Wrap around
            if (currentCarouselIndex < 0) {
                currentCarouselIndex = mobileAnalysisCards.length - 1;
            } else if (currentCarouselIndex >= mobileAnalysisCards.length) {
                currentCarouselIndex = 0;
            }

            updateCarousel();
        }

        function updateCarousel() {
            if (!mobileCarouselTrack || mobileAnalysisCards.length === 0) return;

            // Update transform to show current card
            const offset = -currentCarouselIndex * 100;
            mobileCarouselTrack.style.transform = `translateX(${offset}%)`;

            // Update counter
            if (carouselCounter) {
                carouselCounter.textContent = `${currentCarouselIndex + 1} / ${mobileAnalysisCards.length}`;
            }

            // Update button states
            if (carouselPrev && carouselNext) {
                // Enable/disable buttons based on position
                if (mobileAnalysisCards.length <= 1) {
                    carouselPrev.disabled = true;
                    carouselNext.disabled = true;
                } else {
                    carouselPrev.disabled = false;
                    carouselNext.disabled = false;
                }
            }
        }

        // === Report Screen: Populate Report Function (NEW - Using API Data) ===
        function populateReportFromAPI(reportData) {
            if (!highlightCards) return;

            console.log('ğŸ“Š Populating report with API data:', reportData);

            // Populate summary
            const summaryElement = document.getElementById('reportSummary');
            if (summaryElement && reportData.summary) {
                summaryElement.textContent = reportData.summary;
            }

            // Clear existing cards
            highlightCards.innerHTML = '';

            // Create highlight cards from API response
            const highlights = reportData.highlights || [];

            highlights.forEach((highlight, index) => {
                const card = document.createElement('div');
                card.className = 'bg-amber-50 rounded-2xl p-6 shadow-sm border border-amber-100 relative';
                card.innerHTML = `
                    <p class="text-gray-800 leading-relaxed pr-12">${highlight}</p>
                    <div class="absolute top-4 right-4 w-8 h-8 bg-green-600 rounded-full flex items-center justify-center">
                        <span class="text-white text-xl">âœ“</span>
                    </div>
                `;
                highlightCards.appendChild(card);
            });

            // Add improvement suggestions section (if we want to show them)
            if (reportData.improvements && reportData.improvements.length > 0) {
                const improvementsSection = document.createElement('div');
                improvementsSection.className = 'mt-8';
                improvementsSection.innerHTML = `
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ’¡ å¯ä»¥æ›´å¥½çš„åœ°æ–¹</h2>
                    <div class="space-y-4">
                        ${reportData.improvements.map(item => `
                            <div class="bg-blue-50 rounded-2xl p-6 border border-blue-100">
                                <p class="text-gray-700 font-medium mb-2">ğŸ“Œ ${item.issue}</p>
                                <p class="text-gray-600 pl-6">ğŸ’¬ ${item.suggestion}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
                highlightCards.parentElement.appendChild(improvementsSection);
            }

            // Log RAG references (could be displayed later if needed)
            if (reportData.rag_references && reportData.rag_references.length > 0) {
                console.log('ğŸ“š RAG References:', reportData.rag_references);
            }
        }

        // === LEGACY: Old populate function (kept for fallback) ===
        function populateReport() {
            if (!highlightCards) return;

            // Clear existing cards
            highlightCards.innerHTML = '';

            // Extract highlights from analysis cards
            const highlights = [];

            // Get data from mobileAnalysisCards array
            mobileAnalysisCards.forEach(card => {
                // Extract suggestions from each analysis card
                const suggestions = card.querySelectorAll('.suggestion-card');
                suggestions.forEach(suggestion => {
                    const text = suggestion.textContent.trim();
                    if (text && text.length > 0) {
                        highlights.push(text);
                    }
                });

                // Also extract from analysis text if available
                const analysisText = card.querySelector('.analysis-content');
                if (analysisText) {
                    const text = analysisText.textContent.trim();
                    // Split by common delimiters and extract key points
                    const points = text.split(/[ã€‚ï¼]/g).filter(p => p.trim().length > 10);
                    points.forEach(point => {
                        if (point.trim() && !highlights.includes(point.trim())) {
                            highlights.push(point.trim());
                        }
                    });
                }
            });

            // Fallback: Create default highlights if none found
            if (highlights.length === 0) {
                highlights.push(
                    'ä½ æœ‰è©¦è‘—èªªæ˜è‡ªå·±åœ¨æ„çš„æ˜¯ã€æœªä¾†ã€è€Œä¸æ˜¯åªèªªæˆç¸¾ã€‚',
                    'ä½ åœ¨å°è©±ä¸­è¡¨ç¾å‡ºé¡˜æ„ç†è§£å­©å­çš„æ…‹åº¦ã€‚',
                    'ä½ å˜—è©¦ç”¨è¼ƒæº«å’Œçš„æ–¹å¼é–‹å•Ÿå°è©±ã€‚'
                );
            }

            // Limit to maximum 5 highlights
            const displayHighlights = highlights.slice(0, 5);

            // Create cards for each highlight
            displayHighlights.forEach((highlight, index) => {
                const card = document.createElement('div');
                card.className = 'bg-amber-50 rounded-2xl p-6 shadow-sm border border-amber-100 relative';
                card.innerHTML = `
                    <p class="text-gray-800 leading-relaxed pr-12">${highlight}</p>
                    <div class="absolute top-4 right-4 w-8 h-8 bg-green-600 rounded-full flex items-center justify-center">
                        <span class="text-white text-xl">âœ“</span>
                    </div>
                `;
                highlightCards.appendChild(card);
            });
        }

        // Add swipe gesture support for carousel
        if (mobileCarouselTrack) {
            let touchStartX = 0;
            let touchEndX = 0;

            mobileCarouselTrack.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            mobileCarouselTrack.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, { passive: true });

            function handleSwipe() {
                const swipeThreshold = 50; // minimum distance for swipe
                const diff = touchStartX - touchEndX;

                if (Math.abs(diff) < swipeThreshold) return;

                if (diff > 0) {
                    // Swipe left â†’ earlier time (lower index)
                    navigateCarousel(-1);
                } else {
                    // Swipe right â†’ later time (higher index)
                    navigateCarousel(1);
                }
            }
        }

        // === Demo Mode (Simulate transcript input) ===
        let demoScriptIndex = 0;
        const demoScripts = {
            // åŠ‡æœ¬ 1: å·¥ä½œå£“åŠ›èˆ‡ç„¦æ…®ï¼ˆå«è‡ªæ®ºé¢¨éšªè©•ä¼°ï¼‰- 30åˆ†é˜å®Œæ•´ç‰ˆ
            // æ¯å¥è©±éƒ½æœ‰æ™‚é–“æˆ³ï¼ˆç§’ï¼‰ï¼Œç”¨æ–¼åŒæ­¥éŸ³è¨Šæ’­æ”¾
            workStress: [
                // Phase 1: é–‹å ´èˆ‡å»ºç«‹é—œä¿‚ (0-5åˆ†é˜)
                { speaker: 'counselor', text: 'ä½ å¥½ï¼Œä»Šå¤©æƒ³èŠä»€éº¼å‘¢ï¼Ÿ', time: 2 },
                { speaker: 'client', text: 'æˆ‘æœ€è¿‘å·¥ä½œå£“åŠ›å¾ˆå¤§ï¼Œå¸¸å¸¸ç„¦æ…®åˆ°ç¡ä¸è‘—...', time: 6 },
                { speaker: 'counselor', text: 'è½èµ·ä¾†å£“åŠ›çœŸçš„å¾ˆå¤§ã€‚èƒ½è·Ÿæˆ‘å¤šèªªä¸€äº›ï¼Œä½ éƒ½å¹¾é»ç¡è¦ºï¼Ÿ', time: 12 },
                { speaker: 'client', text: 'æˆ‘å¸¸å¸¸èººåœ¨åºŠä¸Šç¿»ä¾†è¦†å»åˆ°å‡Œæ™¨å…©ã€ä¸‰é»ã€‚', time: 18 },
                { speaker: 'counselor', text: 'å¤±çœ å°ä½ çš„å½±éŸ¿ä¸€å®šå¾ˆå¤§ã€‚ä½ èººåœ¨åºŠä¸Šçš„æ™‚å€™ï¼Œè…¦è¢‹éƒ½åœ¨æƒ³ä»€éº¼ï¼Ÿ', time: 24 },
                { speaker: 'client', text: 'å°±æƒ³è‘—æ˜å¤©çš„å·¥ä½œï¼Œæƒ³è‘—æˆ‘åˆè¦é¢å°ä¸»ç®¡...', time: 31 },
                { speaker: 'counselor', text: 'ä¸»ç®¡æ˜¯ä½ å£“åŠ›çš„ä¸»è¦ä¾†æºå—ï¼Ÿ', time: 37 },
                { speaker: 'client', text: 'å°ï¼Œæˆ‘è¦ºå¾—ä¸ç®¡æ€éº¼åšï¼Œä»–éƒ½ä¸æ»¿æ„ã€‚', time: 41 },
                { speaker: 'counselor', text: 'é€™è®“ä½ æ„Ÿåˆ°å¾ˆæŒ«æŠ˜ï¼Œæ˜¯å—ï¼Ÿèƒ½èˆ‰å€‹æœ€è¿‘çš„ä¾‹å­å—ï¼Ÿ', time: 47 },
                { speaker: 'client', text: 'ä¸Šç¦®æ‹œæˆ‘ç†¬å¤œè¶•å‡ºä¾†çš„ä¼åŠƒæ¡ˆï¼Œä»–åªçœ‹äº†å…©åˆ†é˜å°±èªªè¦é‡åšã€‚', time: 54 },
                { speaker: 'counselor', text: 'ä½ é‚£æ™‚å€™çš„æ„Ÿå—æ˜¯ä»€éº¼ï¼Ÿ', time: 62 },
                { speaker: 'client', text: 'æˆ‘ç•¶ä¸‹çœŸçš„å¾ˆç”Ÿæ°£ï¼Œä½†åˆä¸æ•¢èªªä»€éº¼ï¼Œå°±åä¸‹ä¾†äº†ã€‚', time: 66 },
                { speaker: 'counselor', text: 'ç”Ÿæ°£ä½†åˆä¸èƒ½è¡¨é”ï¼Œé€™ç¨®æ„Ÿè¦ºä¸€å®šå¾ˆé›£å—ã€‚', time: 73 },
                { speaker: 'client', text: 'å°...æˆ‘å›åˆ°åº§ä½ä¸Šçœ¼æ·šå°±æ‰ä¸‹ä¾†äº†ï¼Œé‚„å¥½æ²’äººçœ‹åˆ°ã€‚', time: 79 },

                // Phase 2: æ¢ç´¢å·¥ä½œå£“åŠ›èˆ‡æƒ…ç·’ (5-12åˆ†é˜)
                { speaker: 'counselor', text: 'é€™ç¨®æƒ…æ³æŒçºŒå¤šä¹…äº†ï¼Ÿ', time: 86 },
                { speaker: 'client', text: 'å¤§æ¦‚åŠå¹´å§ï¼Œå¾ä»–èª¿ä¾†ç•¶æˆ‘å€‘ä¸»ç®¡ä¹‹å¾Œã€‚', time: 90 },
                { speaker: 'counselor', text: 'é€™åŠå¹´ä¾†ï¼Œä½ çš„å·¥ä½œå’Œç”Ÿæ´»æœ‰ä»€éº¼æ”¹è®Šå—ï¼Ÿ', time: 96 },
                { speaker: 'client', text: 'æˆ‘è®Šå¾—å¾ˆæ²’è‡ªä¿¡ï¼Œå¸¸å¸¸æ‡·ç–‘è‡ªå·±çš„èƒ½åŠ›...', time: 102 },
                { speaker: 'counselor', text: 'ç•¶ä½ èªªã€Œæ‡·ç–‘è‡ªå·±ã€ï¼Œå…·é«”æ˜¯æŒ‡ä»€éº¼å‘¢ï¼Ÿ', time: 108 },
                { speaker: 'client', text: 'æˆ‘è¦ºå¾—è‡ªå·±ä»€éº¼éƒ½åšä¸å¥½ï¼Œå¯èƒ½æ ¹æœ¬ä¸é©åˆé€™ä»½å·¥ä½œã€‚', time: 114 },
                { speaker: 'counselor', text: 'åœ¨é€™å€‹ä¸»ç®¡ä¾†ä¹‹å‰ï¼Œä½ å°è‡ªå·±çš„å·¥ä½œè¡¨ç¾æœ‰é€™æ¨£çš„æ„Ÿè¦ºå—ï¼Ÿ', time: 121 },
                { speaker: 'client', text: 'æ²’æœ‰...ä»¥å‰æˆ‘åšå¾—é‚„ä¸éŒ¯ï¼Œå‰ä¸€å€‹ä¸»ç®¡é‚„æ»¿è‚¯å®šæˆ‘çš„ã€‚', time: 128 },
                { speaker: 'counselor', text: 'æ‰€ä»¥é€™å€‹æ‡·ç–‘ï¼Œä¸»è¦æ˜¯æœ€è¿‘é€™åŠå¹´æ‰é–‹å§‹çš„ã€‚', time: 135 },
                { speaker: 'client', text: 'å°ï¼Œæˆ‘ç¾åœ¨é€£ç°¡å–®çš„äº‹æƒ…éƒ½æœƒå®³æ€•åšéŒ¯ã€‚', time: 141 },
                { speaker: 'counselor', text: 'é€™ç¨®å®³æ€•ï¼Œé™¤äº†åœ¨å·¥ä½œä¸Šï¼Œæœƒä¸æœƒå½±éŸ¿åˆ°ä½ çš„ç”Ÿæ´»å…¶ä»–éƒ¨åˆ†ï¼Ÿ', time: 147 },
                { speaker: 'client', text: 'æœƒ...æˆ‘ç¾åœ¨ä¸å¤ªæƒ³è·Ÿæœ‹å‹å‡ºå»ï¼Œä¹Ÿä¸æƒ³è·Ÿå®¶äººèŠå¤©ã€‚', time: 154 },
                { speaker: 'counselor', text: 'è½èµ·ä¾†ä½ æœ‰é»æŠŠè‡ªå·±å­¤ç«‹èµ·ä¾†äº†ã€‚', time: 161 },
                { speaker: 'client', text: 'æˆ‘åªæ˜¯è¦ºå¾—å¾ˆç´¯ï¼Œä¸æƒ³è®“åˆ¥äººçœ‹åˆ°æˆ‘é€™å€‹æ¨£å­ã€‚', time: 166 },
                { speaker: 'counselor', text: 'ä½ æ“”å¿ƒåˆ¥äººæ€éº¼çœ‹ä½ ï¼Ÿ', time: 172 },
                { speaker: 'client', text: 'æ€•ä»–å€‘è¦ºå¾—æˆ‘å¾ˆå¼±ï¼Œé€£å·¥ä½œéƒ½åšä¸å¥½ã€‚', time: 176 },
                { speaker: 'counselor', text: 'é™¤äº†ç–²ç´¯å’Œå®³æ€•ï¼Œä½ é‚„æœ‰å…¶ä»–èº«é«”çš„æ„Ÿè¦ºå—ï¼Ÿ', time: 182 },
                { speaker: 'client', text: 'æˆ‘å¸¸å¸¸èƒ¸æ‚¶ï¼Œæœ‰æ™‚å€™æœƒçªç„¶å–˜ä¸éæ°£ã€‚', time: 188 },
                { speaker: 'counselor', text: 'é€™è½èµ·ä¾†åƒæ˜¯ç„¦æ…®ç™¼ä½œã€‚ç™¼ä½œçš„æ™‚å€™ä½ æœƒæ€éº¼åšï¼Ÿ', time: 194 },
                { speaker: 'client', text: 'æˆ‘å°±...èº²åˆ°å»æ‰€æ·±å‘¼å¸ï¼Œç­‰å®ƒéå»ã€‚', time: 200 },
                { speaker: 'counselor', text: 'ä½ æœ‰è©¦éå…¶ä»–æ–¹æ³•å—ï¼Ÿæˆ–æ˜¯æœ‰è·Ÿèª°è«‡éé€™ä»¶äº‹ï¼Ÿ', time: 206 },
                { speaker: 'client', text: 'æ²’æœ‰...æˆ‘ä¸çŸ¥é“è¦è·Ÿèª°èªªã€‚', time: 212 },

                // Phase 3: æ†‚é¬±ç—‡ç‹€æµ®ç¾ (12-17åˆ†é˜)
                { speaker: 'counselor', text: 'é™¤äº†ç¡çœ å•é¡Œå’Œç„¦æ…®ï¼Œä½ çš„èƒƒå£æœ‰æ”¹è®Šå—ï¼Ÿ', time: 218 },
                { speaker: 'client', text: 'æˆ‘æœ€è¿‘éƒ½ä¸å¤ªæƒ³åƒæ±è¥¿ï¼Œé«”é‡æ‰äº†äº”ã€å…­å…¬æ–¤ã€‚', time: 224 },
                { speaker: 'counselor', text: 'é‚£ä½ å¹³å¸¸æœ‰æ²’æœ‰ä»€éº¼äº‹æƒ…æ˜¯è®“ä½ é–‹å¿ƒçš„ï¼Ÿ', time: 231 },
                { speaker: 'client', text: 'ä»¥å‰æˆ‘å¾ˆå–œæ­¡ç•«ç•«ï¼Œä½†ç¾åœ¨å®Œå…¨æä¸èµ·å‹ã€‚', time: 236 },
                { speaker: 'counselor', text: 'é€£åŸæœ¬å–œæ­¡çš„äº‹æƒ…éƒ½å¤±å»èˆˆè¶£äº†...é€™ç¨®æƒ…æ³æŒçºŒå¤šä¹…äº†ï¼Ÿ', time: 242 },
                { speaker: 'client', text: 'å¤§æ¦‚å…©ã€ä¸‰å€‹æœˆå§ï¼Œæˆ‘è¦ºå¾—åšä»€éº¼éƒ½æ²’æ„æ€ã€‚', time: 249 },
                { speaker: 'counselor', text: 'è½èµ·ä¾†ä½ ç¾åœ¨çš„ç‹€æ…‹çœŸçš„å¾ˆè¾›è‹¦ã€‚', time: 255 },
                { speaker: 'client', text: 'å—¯...', time: 260 },
                { speaker: 'counselor', text: 'ä½ æ—©ä¸Šèµ·åºŠçš„æ™‚å€™ï¼Œæœƒä¸æœƒç‰¹åˆ¥é›£ç†¬ï¼Ÿ', time: 263 },
                { speaker: 'client', text: 'æœƒï¼Œæˆ‘æ¯å¤©çœé–‹çœ¼ç›ç¬¬ä¸€å€‹æƒ³æ³•å°±æ˜¯ã€Œåˆè¦é¢å°æ–°çš„ä¸€å¤©ã€ã€‚', time: 269 },
                { speaker: 'counselor', text: 'é€™è½èµ·ä¾†åƒæ˜¯ä¸€ç¨®è² æ“”ã€‚', time: 276 },
                { speaker: 'client', text: 'å°ï¼Œæˆ‘è¦ºå¾—æ´»è‘—å¥½åƒåªæ˜¯åœ¨æ‡‰ä»˜ï¼Œæ²’ä»€éº¼æ„ç¾©ã€‚', time: 280 },

                // Phase 4: è‡ªæ®ºæ„å¿µè©•ä¼° (17-22åˆ†é˜) - CRITICAL SECTION
                { speaker: 'counselor', text: 'ä½ å‰›æ‰èªªã€Œæ´»è‘—æ²’æ„ç¾©ã€ï¼Œé€™æ˜¯æœ€è¿‘æ‰æœ‰çš„æƒ³æ³•å—ï¼Ÿ', time: 287 },
                { speaker: 'client', text: 'å—¯...æœ€è¿‘ç‰¹åˆ¥å¼·çƒˆã€‚', time: 293 },
                { speaker: 'counselor', text: 'æˆ‘æƒ³ç›´æ¥å•ä½ ï¼Œç•¶ä½ èªªæ´»è‘—æ²’æ„ç¾©ï¼Œä½ æœ‰æ²’æœ‰æƒ³éè¦çµæŸç”Ÿå‘½ï¼Ÿ', time: 297 },
                { speaker: 'client', text: '...', time: 305 },
                { speaker: 'counselor', text: 'æˆ‘çŸ¥é“é€™å€‹å•é¡Œå¾ˆç›´æ¥ï¼Œä½†é€™å°æˆ‘äº†è§£ä½ çš„ç‹€æ³å¾ˆé‡è¦ã€‚', time: 308 },
                { speaker: 'client', text: 'æœ‰...æœ‰æƒ³éã€‚', time: 315 },
                { speaker: 'counselor', text: 'è¬è¬ä½ é¡˜æ„è·Ÿæˆ‘èªªã€‚ä½ èƒ½è·Ÿæˆ‘å¤šèªªä¸€é»å—ï¼Ÿé€™å€‹æƒ³æ³•å¤šå¸¸å‡ºç¾ï¼Ÿ', time: 319 },
                { speaker: 'client', text: 'æœ€è¿‘å¹¾ä¹æ¯å¤©éƒ½æœƒæƒ³åˆ°ã€‚', time: 326 },
                { speaker: 'counselor', text: 'ç•¶é€™å€‹æƒ³æ³•å‡ºç¾çš„æ™‚å€™ï¼Œå®ƒæœ‰å¤šå¼·çƒˆï¼Ÿå¾0åˆ°10ï¼Œ10æ˜¯éå¸¸å¼·çƒˆã€‚', time: 331 },
                { speaker: 'client', text: 'å¤§æ¦‚...7ã€8å§ã€‚', time: 339 },
                { speaker: 'counselor', text: 'é€™ç¢ºå¯¦æ˜¯å¾ˆå¼·çš„ç¨‹åº¦ã€‚ä½ æœ‰æƒ³éå…·é«”çš„æ–¹æ³•å—ï¼Ÿ', time: 343 },
                { speaker: 'client', text: 'æœ‰æƒ³é...ä½†æˆ‘ä¸ç¢ºå®šæœƒä¸æœƒçœŸçš„å»åšã€‚', time: 349 },
                { speaker: 'counselor', text: 'ä½ æƒ³éä»€éº¼æ–¹æ³•ï¼Ÿ', time: 355 },
                { speaker: 'client', text: 'å°±...åƒå®‰çœ è—¥ã€‚æˆ‘å®¶è£¡æœ‰ä¸€äº›ã€‚', time: 358 },
                { speaker: 'counselor', text: 'ä½ æœ‰æƒ³éä»€éº¼æ™‚å€™åšé€™ä»¶äº‹å—ï¼Ÿ', time: 364 },
                { speaker: 'client', text: 'æ²’æœ‰æ˜ç¢ºçš„æ™‚é–“ï¼Œä½†æœ‰æ™‚å€™çœŸçš„å¾ˆæƒ³å°±é€™æ¨£çµæŸã€‚', time: 369 },
                { speaker: 'counselor', text: 'é‚£æœ‰ä»€éº¼äº‹æƒ…æˆ–äººï¼Œè®“ä½ åˆ°ç¾åœ¨é‚„é¡˜æ„æ´»è‘—ï¼Ÿ', time: 376 },
                { speaker: 'client', text: 'æˆ‘åª½...å¥¹èº«é«”ä¸å¥½ï¼Œå¦‚æœæˆ‘å‡ºäº‹ï¼Œå¥¹ä¸€å®šå—ä¸äº†ã€‚', time: 382 },
                { speaker: 'counselor', text: 'ä½ åª½åª½å°ä½ ä¾†èªªå¾ˆé‡è¦ã€‚', time: 389 },
                { speaker: 'client', text: 'å°ï¼Œå¥¹æ˜¯æˆ‘å”¯ä¸€çš„ç‰½æ›ã€‚', time: 393 },

                // Phase 5: é¢¨éšªè©•ä¼°æ·±å…¥ (22-27åˆ†é˜)
                { speaker: 'counselor', text: 'é™¤äº†åª½åª½ï¼Œé‚„æœ‰å…¶ä»–è®“ä½ è¦ºå¾—å€¼å¾—æ´»ä¸‹å»çš„äº‹æƒ…å—ï¼Ÿ', time: 400 },
                { speaker: 'client', text: 'æˆ‘æƒ³ä¸åˆ°äº†...å¯èƒ½å°±åªæœ‰å¥¹ã€‚', time: 407 },
                { speaker: 'counselor', text: 'ç•¶ä½ æƒ³åˆ°è¦çµæŸç”Ÿå‘½çš„æ™‚å€™ï¼Œæœ‰æ²’æœ‰ä»€éº¼äº‹æƒ…å¯ä»¥è®“ä½ åœä¸‹ä¾†ï¼Ÿ' },
                { speaker: 'client', text: 'å°±æƒ³åˆ°æˆ‘åª½ï¼Œé‚„æœ‰...æˆ‘ä¹Ÿæœ‰é»å®³æ€•æ­»äº¡ã€‚' },
                { speaker: 'counselor', text: 'ä½ èªªçš„å®³æ€•æ˜¯ä»€éº¼æ¨£çš„å®³æ€•ï¼Ÿ' },
                { speaker: 'client', text: 'ä¸çŸ¥é“æ­»äº†ä¹‹å¾Œæœƒæ€æ¨£ï¼Œè€Œä¸”æˆ‘ä¹Ÿä¸æƒ³è®“å®¶äººå‚·å¿ƒã€‚' },
                { speaker: 'counselor', text: 'é€™äº›éƒ½æ˜¯å¾ˆé‡è¦çš„ä¿è­·å› å­ã€‚ä½ æœ‰è·Ÿä»»ä½•äººè«‡éé€™äº›æƒ³æ³•å—ï¼Ÿ' },
                { speaker: 'client', text: 'æ²’æœ‰...é€™æ˜¯æˆ‘ç¬¬ä¸€æ¬¡èªªå‡ºä¾†ã€‚' },
                { speaker: 'counselor', text: 'æˆ‘å¾ˆæ…¶å¹¸ä½ ä»Šå¤©é¡˜æ„ä¾†é€™è£¡ï¼Œä¹Ÿé¡˜æ„è·Ÿæˆ‘èªªé€™äº›ã€‚' },
                { speaker: 'client', text: 'å—¯...å…¶å¯¦æˆ‘ä¹Ÿä¸çŸ¥é“è©²æ€éº¼è¾¦äº†ã€‚' },
                { speaker: 'counselor', text: 'ä½ éå»æœ‰è©¦åœ–å‚·å®³è‡ªå·±æˆ–è‡ªæ®ºçš„ç¶“é©—å—ï¼Ÿ' },
                { speaker: 'client', text: 'æ²’æœ‰ï¼Œé€™æ˜¯ç¬¬ä¸€æ¬¡é€™éº¼åš´é‡ã€‚' },
                { speaker: 'counselor', text: 'é‚£ç¾åœ¨æ­¤åˆ»ï¼Œå¦‚æœå¾0åˆ°10ä¾†è©•ä¼°ï¼Œä½ è¦ºå¾—è‡ªå·±åœ¨æ¥ä¸‹ä¾†ä¸€é€±å…§æœƒçœŸçš„åŸ·è¡Œçš„å¯èƒ½æ€§æœ‰å¤šé«˜ï¼Ÿ' },
                { speaker: 'client', text: 'å¯èƒ½...3ã€4å§ã€‚æˆ‘ä¸ç¢ºå®šã€‚' },
                { speaker: 'counselor', text: 'æˆ‘è½åˆ°ä½ èªªä¸ç¢ºå®šï¼Œé€™ä»£è¡¨ä½ å…§å¿ƒé‚„åœ¨æ™æ‰ã€‚' },
                { speaker: 'client', text: 'å°ï¼Œæœ‰æ™‚å€™å¾ˆæƒ³çµæŸï¼Œä½†åˆè¦ºå¾—ä¸èƒ½é€™æ¨£åšã€‚' },

                // Phase 6: å®‰å…¨è¨ˆç•«èˆ‡è³‡æº (27-30åˆ†é˜)
                { speaker: 'counselor', text: 'æˆ‘æƒ³è·Ÿä½ ä¸€èµ·åˆ¶å®šä¸€å€‹å®‰å…¨è¨ˆç•«ï¼Œç•¶ä½ æœ‰å¼·çƒˆçš„è‡ªæ®ºå¿µé ­æ™‚å¯ä»¥æ€éº¼åšã€‚' },
                { speaker: 'client', text: 'å¥½...' },
                { speaker: 'counselor', text: 'é¦–å…ˆï¼Œç•¶é€™å€‹å¿µé ­å‡ºç¾æ™‚ï¼Œä½ å¯ä»¥åšä»€éº¼äº‹æƒ…ä¾†è½‰ç§»æ³¨æ„åŠ›ï¼Ÿ' },
                { speaker: 'client', text: 'æˆ‘å¯èƒ½...å»æ•£æ­¥ï¼Ÿæˆ–æ˜¯è½éŸ³æ¨‚ï¼Ÿ' },
                { speaker: 'counselor', text: 'é€™äº›éƒ½æ˜¯å¥½æ–¹æ³•ã€‚æ¥ä¸‹ä¾†ï¼Œä½ æœ‰å¯ä»¥æ‰“é›»è©±æ±‚åŠ©çš„äººå—ï¼Ÿ' },
                { speaker: 'client', text: 'æˆ‘æœ‰ä¸€å€‹å¤§å­¸åŒå­¸ï¼Œæˆ‘å€‘é—œä¿‚é‚„ä¸éŒ¯ã€‚' },
                { speaker: 'counselor', text: 'å¾ˆå¥½ã€‚å¦‚æœæƒ…æ³æ›´ç·Šæ€¥ï¼Œä½ çŸ¥é“å¯ä»¥æ‰“1925å®‰å¿ƒå°ˆç·šå—ï¼Ÿ' },
                { speaker: 'client', text: 'è½éï¼Œä½†æ²’æ‰“éã€‚' },
                { speaker: 'counselor', text: 'é€™æ˜¯24å°æ™‚çš„å¿ƒç†è«®è©¢å°ˆç·šï¼Œéš¨æ™‚éƒ½å¯ä»¥æ‰“ã€‚é‚„æœ‰ï¼Œé—œæ–¼å®¶è£¡çš„å®‰çœ è—¥...' },
                { speaker: 'client', text: 'å—¯ï¼Ÿ' },
                { speaker: 'counselor', text: 'ç‚ºäº†ä½ çš„å®‰å…¨ï¼Œæˆ‘å»ºè­°ä½ æŠŠå®ƒå€‘äº¤çµ¦ä¿¡ä»»çš„äººä¿ç®¡ï¼Œä½ è¦ºå¾—å¯ä»¥å—ï¼Ÿ' },
                { speaker: 'client', text: 'å¯ä»¥...æˆ‘å¯ä»¥çµ¦æˆ‘åª½ä¿ç®¡ã€‚' },
                { speaker: 'counselor', text: 'å¥½çš„ï¼Œé€™å¾ˆé‡è¦ã€‚æˆ‘ä¹Ÿå»ºè­°ä½ è€ƒæ…®å»èº«å¿ƒç§‘è©•ä¼°ï¼Œçœ‹æ˜¯å¦éœ€è¦è—¥ç‰©å”åŠ©ã€‚' },
                { speaker: 'client', text: 'ä½ è¦ºå¾—æˆ‘éœ€è¦åƒè—¥å—ï¼Ÿ' },
                { speaker: 'counselor', text: 'é€™éœ€è¦é†«ç”Ÿè©•ä¼°ï¼Œä½†å¾ä½ çš„ç—‡ç‹€ä¾†çœ‹ï¼Œè—¥ç‰©å¯èƒ½å¯ä»¥å¹«åŠ©ä½ ç©©å®šæƒ…ç·’å’Œç¡çœ ã€‚' },
                { speaker: 'client', text: 'å¥½...æˆ‘æœƒè€ƒæ…®çš„ã€‚' },
                { speaker: 'counselor', text: 'æˆ‘å¸Œæœ›æˆ‘å€‘èƒ½å¯†é›†åœ°è¦‹é¢ï¼Œæ¯é€±è‡³å°‘å…©æ¬¡ï¼Œä½ è¦ºå¾—å¯ä»¥å—ï¼Ÿ' },
                { speaker: 'client', text: 'å¯ä»¥ï¼Œæˆ‘éœ€è¦æœ‰äººå¹«æˆ‘ã€‚' },
                { speaker: 'counselor', text: 'æˆ‘æœƒé™ªè‘—ä½ åº¦éé€™æ®µæ™‚é–“ã€‚åœ¨ä¸‹æ¬¡è¦‹é¢ä¹‹å‰ï¼Œå¦‚æœä½ æœ‰å¼·çƒˆçš„è‡ªæ®ºå¿µé ­ï¼Œè«‹ä¸€å®šè¦æ‰“1925æˆ–è¯çµ¡æˆ‘ã€‚' },
                { speaker: 'client', text: 'å¥½ï¼Œè¬è¬ä½ ã€‚' },
                { speaker: 'counselor', text: 'ä¸å®¢æ°£ã€‚æˆ‘å€‘ç´„ä¸‹é€±äºŒåŒä¸€æ™‚é–“ï¼Œä½ è¦ºå¾—å¯ä»¥å—ï¼Ÿ' },
                { speaker: 'client', text: 'å¯ä»¥ã€‚' },
                { speaker: 'counselor', text: 'é‚£ä»Šå¤©å°±åˆ°é€™è£¡ã€‚è¨˜å¾—ï¼Œä½ ä¸æ˜¯ä¸€å€‹äººï¼Œæˆ‘å€‘æœƒä¸€èµ·é¢å°é€™å€‹å›°é›£ã€‚' },
                { speaker: 'client', text: 'è¬è¬...' }
            ],

            // åŠ‡æœ¬ 2: ä¸€èˆ¬è«®è©¢ï¼ˆé—œä¿‚ã€å®¶åº­ã€ç”Ÿæ¶¯æ¢ç´¢ï¼‰- 30åˆ†é˜å®Œæ•´ç‰ˆ
            general: [
                // Phase 1: é–‹å ´èˆ‡è¿‘æ³ (0-5åˆ†é˜)
                { speaker: 'counselor', text: 'ä»Šå¤©éå¾—å¦‚ä½•ï¼Ÿ' },
                { speaker: 'client', text: 'é‚„å¥½ï¼Œå°±æ˜¯æœ‰é»ç´¯ã€‚' },
                { speaker: 'counselor', text: 'ä»€éº¼è®“ä½ æ„Ÿåˆ°ç´¯å‘¢ï¼Ÿ' },
                { speaker: 'client', text: 'å·¥ä½œçš„äº‹æƒ…ï¼Œé‚„æœ‰å®¶è£¡çš„äº‹ã€‚' },
                { speaker: 'counselor', text: 'èƒ½å…·é«”èªªèªªæ˜¯ä»€éº¼äº‹å—ï¼Ÿæˆ‘å€‘å…ˆå¾å“ªä¸€å€‹é–‹å§‹èŠï¼Ÿ' },
                { speaker: 'client', text: 'å…ˆèªªå·¥ä½œå¥½äº†ï¼Œä¸»ç®¡æœ€è¿‘ä¸€ç›´ç›¯æˆ‘ï¼Œè®“æˆ‘å£“åŠ›å¾ˆå¤§ã€‚' },
                { speaker: 'counselor', text: 'ä¸»ç®¡ç›¯è‘—ä½ çš„æ„Ÿè¦ºï¼Œèƒ½æè¿°ä¸€ä¸‹å—ï¼Ÿ' },
                { speaker: 'client', text: 'å°±æ˜¯è¦ºå¾—è¢«ç›£è¦–ï¼Œä»€éº¼éƒ½è¦å ±å‘Šï¼Œè®“æˆ‘å¾ˆä¸èˆ’æœã€‚' },
                { speaker: 'counselor', text: 'è½èµ·ä¾†é€™è®“ä½ è¦ºå¾—ä¸è¢«ä¿¡ä»»ã€‚' },
                { speaker: 'client', text: 'å°ï¼Œæ˜æ˜æˆ‘å·¥ä½œéƒ½æœ‰åšå¥½ï¼Œä½†ä»–é‚„æ˜¯ä¸€ç›´å•æ±å•è¥¿ã€‚' },
                { speaker: 'counselor', text: 'é€™ç¨®ç‹€æ³æŒçºŒå¤šä¹…äº†ï¼Ÿ' },
                { speaker: 'client', text: 'å¤§æ¦‚ä¸€å€‹æœˆå§ï¼Œå¾ä¸Šæ¬¡å°ˆæ¡ˆå‡ºäº†é»å°å•é¡Œä¹‹å¾Œã€‚' },
                { speaker: 'counselor', text: 'é‚£æ¬¡çš„å°å•é¡Œï¼Œå°ä½ å½±éŸ¿å¾ˆå¤§å—ï¼Ÿ' },
                { speaker: 'client', text: 'å…¶å¯¦é‚„å¥½ï¼Œä½†ä¸»ç®¡å¥½åƒå¾é‚£ä¹‹å¾Œå°±é–‹å§‹ç‰¹åˆ¥æ³¨æ„æˆ‘ã€‚' },

                // Phase 2: å·¥ä½œå£“åŠ›èˆ‡å› æ‡‰ (5-10åˆ†é˜)
                { speaker: 'counselor', text: 'ä½ æœ‰è©¦è‘—è·Ÿä¸»ç®¡æºé€šéå—ï¼Ÿ' },
                { speaker: 'client', text: 'æ²’æœ‰...æˆ‘ä¸å¤ªæ•¢ï¼Œæ€•ä»–è¦ºå¾—æˆ‘åœ¨æŠ±æ€¨ã€‚' },
                { speaker: 'counselor', text: 'ä½ æ“”å¿ƒè¡¨é”è‡ªå·±çš„æ„Ÿå—æœƒå¸¶ä¾†è² é¢å¾Œæœã€‚' },
                { speaker: 'client', text: 'å°ï¼Œè€Œä¸”æˆ‘ä¹Ÿä¸çŸ¥é“è©²æ€éº¼èªªã€‚' },
                { speaker: 'counselor', text: 'å¦‚æœæœ‰æ©Ÿæœƒè·Ÿä»–èªªï¼Œä½ æœ€æƒ³è®“ä»–çŸ¥é“ä»€éº¼ï¼Ÿ' },
                { speaker: 'client', text: 'æˆ‘å¸Œæœ›ä»–çŸ¥é“æˆ‘æ˜¯æœ‰èƒ½åŠ›çš„ï¼Œä¸éœ€è¦ä¸€ç›´è¢«ç›£ç£ã€‚' },
                { speaker: 'counselor', text: 'é€™æ˜¯å¾ˆåˆç†çš„éœ€æ±‚ã€‚ä½ è¦ºå¾—ä»€éº¼é˜»ç¤™äº†ä½ è¡¨é”é€™å€‹éœ€æ±‚ï¼Ÿ' },
                { speaker: 'client', text: 'å¯èƒ½æ˜¯...æˆ‘ä¸æƒ³æƒ¹éº»ç…©ï¼Œä¹Ÿæ€•ç ´å£é—œä¿‚ã€‚' },
                { speaker: 'counselor', text: 'ä¿æŒå’Œå¹³å°ä½ ä¾†èªªå¾ˆé‡è¦ã€‚é€™ç¨®æ¨¡å¼åœ¨ä½ ç”Ÿæ´»çš„å…¶ä»–éƒ¨åˆ†ä¹Ÿæœƒå‡ºç¾å—ï¼Ÿ' },
                { speaker: 'client', text: 'æœƒ...æˆ‘è·Ÿå®¶äººä¹Ÿæ˜¯é€™æ¨£ã€‚' },
                { speaker: 'counselor', text: 'èƒ½å¤šèªªä¸€é»å—ï¼Ÿ' },
                { speaker: 'client', text: 'æˆ‘åª½å¸¸å¸¸å¿µæˆ‘è©²çµå©šäº†ï¼Œä½†æˆ‘ä¸æƒ³è½ï¼Œå°±éƒ½ä¸å›æ‡‰ã€‚' },

                // Phase 3: å®¶åº­é—œä¿‚æ¢ç´¢ (10-17åˆ†é˜)
                { speaker: 'counselor', text: 'ä½ ä¸æƒ³å›æ‡‰çš„åŸå› æ˜¯ä»€éº¼ï¼Ÿ' },
                { speaker: 'client', text: 'å› ç‚ºæˆ‘é‚„æ²’æº–å‚™å¥½ï¼Œä½†èªªäº†å¥¹ä¹Ÿä¸æœƒæ‡‚ã€‚' },
                { speaker: 'counselor', text: 'ä½ è¦ºå¾—åª½åª½ä¸ç†è§£ä½ çš„æƒ³æ³•ã€‚' },
                { speaker: 'client', text: 'å°ï¼Œå¥¹é‚£å€‹å¹´ä»£çš„äººï¼Œè¦ºå¾—åˆ°äº†å¹´ç´€å°±è©²çµå©šã€‚' },
                { speaker: 'counselor', text: 'é‚£ä½ è‡ªå·±å°å©šå§»çš„æƒ³æ³•æ˜¯ä»€éº¼ï¼Ÿ' },
                { speaker: 'client', text: 'æˆ‘è¦ºå¾—...å¦‚æœé‡åˆ°å°çš„äººç•¶ç„¶å¥½ï¼Œä½†ä¸æƒ³ç‚ºäº†çµå©šè€Œçµå©šã€‚' },
                { speaker: 'counselor', text: 'é€™æ˜¯å¾ˆæˆç†Ÿçš„æƒ³æ³•ã€‚ä½ è·Ÿåª½åª½çš„é—œä¿‚ï¼Œé™¤äº†é€™å€‹è©±é¡Œï¼Œå…¶ä»–æ–¹é¢å¦‚ä½•ï¼Ÿ' },
                { speaker: 'client', text: 'å…¶å¯¦é‚„ä¸éŒ¯ï¼Œå¥¹å°æˆ‘å¾ˆå¥½ï¼Œå°±æ˜¯æœ‰æ™‚å€™æœƒç¢å¿µã€‚' },
                { speaker: 'counselor', text: 'è½èµ·ä¾†ä½ å€‘é—œä¿‚çš„åŸºç¤æ˜¯å¥½çš„ï¼Œåªæ˜¯åœ¨æŸäº›è­°é¡Œä¸Šæœ‰ä¸åŒçœ‹æ³•ã€‚' },
                { speaker: 'client', text: 'å°ï¼Œä½†æ¯æ¬¡å¥¹ä¸€è¬›åˆ°çµå©šï¼Œæˆ‘å°±æœƒå¾ˆç…©èºã€‚' },
                { speaker: 'counselor', text: 'é€™å€‹ç…©èºèƒŒå¾Œï¼Œé™¤äº†ä¸æƒ³è¢«å‚¬å©šï¼Œé‚„æœ‰å…¶ä»–æ„Ÿå—å—ï¼Ÿ' },
                { speaker: 'client', text: 'å¯èƒ½æœ‰ä¸€é»...å£“åŠ›å§ï¼Œè¦ºå¾—å¥½åƒæˆ‘ä¸ç¬¦åˆæœŸå¾…ã€‚' },
                { speaker: 'counselor', text: 'ä½ åœ¨æ„åª½åª½æ€éº¼çœ‹ä½ ã€‚' },
                { speaker: 'client', text: 'å—¯...æˆ‘ä¸æƒ³è®“å¥¹å¤±æœ›ã€‚' },
                { speaker: 'counselor', text: 'é‚£å¦‚æœåª½åª½çŸ¥é“ä½ çš„æƒ³æ³•ï¼Œä½ è¦ºå¾—å¥¹æœƒå¤±æœ›å—ï¼Ÿ' },
                { speaker: 'client', text: 'å¯èƒ½æœƒå§...ä½†æˆ‘ä¹Ÿä¸ç¢ºå®šã€‚' },
                { speaker: 'counselor', text: 'æ‰€ä»¥ä½ é‚„æ²’æœ‰çœŸæ­£è©¦è‘—è®“å¥¹ç†è§£ä½ çš„æƒ³æ³•ã€‚' },
                { speaker: 'client', text: 'å°ï¼Œå› ç‚ºæˆ‘è¦ºå¾—èªªäº†ä¹Ÿæ²’ç”¨ã€‚' },
                { speaker: 'counselor', text: 'é€™è½èµ·ä¾†æœ‰é»åƒè‡ªæˆ‘è¨­é™ï¼Œåœ¨é‚„æ²’è©¦ä¹‹å‰å°±å‡è¨­çµæœäº†ã€‚' },
                { speaker: 'client', text: 'å—¯...ä½ é€™æ¨£èªªå¥½åƒæœ‰é“ç†ã€‚' },

                // Phase 4: äººéš›é—œä¿‚æ¨¡å¼ (17-22åˆ†é˜)
                { speaker: 'counselor', text: 'æˆ‘æ³¨æ„åˆ°ï¼Œä¸ç®¡æ˜¯ä¸»ç®¡é‚„æ˜¯åª½åª½ï¼Œä½ éƒ½å‚¾å‘ä¸è¡¨é”è‡ªå·±çš„æ„Ÿå—ã€‚' },
                { speaker: 'client', text: 'å¥½åƒæ˜¯...æˆ‘å¾å°å°±é€™æ¨£ã€‚' },
                { speaker: 'counselor', text: 'ä½ è¨˜å¾—æ˜¯å¾ä»€éº¼æ™‚å€™é–‹å§‹çš„å—ï¼Ÿ' },
                { speaker: 'client', text: 'å°æ™‚å€™æˆ‘çˆ¸è„¾æ°£å¾ˆä¸å¥½ï¼Œæˆ‘å­¸æœƒä¸è¦æƒ¹ä»–ç”Ÿæ°£ã€‚' },
                { speaker: 'counselor', text: 'æ‰€ä»¥ä½ å­¸æœƒäº†ä¿è­·è‡ªå·±çš„æ–¹å¼æ˜¯ä¸è¡¨é”ã€ä¸å¼•ç™¼è¡çªã€‚' },
                { speaker: 'client', text: 'å°...ä½†é€™æ¨£å¥½åƒä¹Ÿè®“æˆ‘å¾ˆç´¯ã€‚' },
                { speaker: 'counselor', text: 'å› ç‚ºä½ çš„éœ€æ±‚å’Œæ„Ÿå—æ²’æœ‰è¢«çœ‹è¦‹ã€‚' },
                { speaker: 'client', text: 'å—¯ï¼Œæœ‰æ™‚å€™æˆ‘ä¹Ÿä¸çŸ¥é“è‡ªå·±è¦ä»€éº¼äº†ã€‚' },
                { speaker: 'counselor', text: 'é€™æ˜¯é•·æœŸå£“æŠ‘çš„çµæœã€‚é‚£åœ¨æœ‹å‹é—œä¿‚ä¸­å‘¢ï¼Ÿä½ æœƒè¡¨é”è‡ªå·±å—ï¼Ÿ' },
                { speaker: 'client', text: 'è·Ÿæœ‹å‹æ¯”è¼ƒè‡ªåœ¨ä¸€é»ï¼Œä½†ä¹Ÿä¸æ˜¯å®Œå…¨æ”¾é¬†ã€‚' },
                { speaker: 'counselor', text: 'ä»€éº¼æ¨£çš„æƒ…æ³ä¸‹ä½ æœƒæ¯”è¼ƒæ”¾é¬†ï¼Ÿ' },
                { speaker: 'client', text: 'å¦‚æœå°æ–¹å…ˆåˆ†äº«ä»–çš„ç…©æƒ±ï¼Œæˆ‘å°±æœƒè¦ºå¾—æ¯”è¼ƒå®‰å…¨ã€‚' },
                { speaker: 'counselor', text: 'æ‰€ä»¥ä½ éœ€è¦å…ˆç¢ºèªé€™æ˜¯ä¸€å€‹å®‰å…¨çš„ç’°å¢ƒã€‚' },
                { speaker: 'client', text: 'å°ï¼Œæˆ‘æ€•è‡ªå·±èªªå¤ªå¤šæœƒé€ æˆåˆ¥äººçš„è² æ“”ã€‚' },
                { speaker: 'counselor', text: 'ä½ å¾ˆåœ¨æ„åˆ¥äººçš„æ„Ÿå—ï¼Œä½†ç›¸å°ä¾†èªªï¼Œæ¯”è¼ƒå¿½ç•¥è‡ªå·±çš„éœ€æ±‚ã€‚' },
                { speaker: 'client', text: 'å¥½åƒæ˜¯é€™æ¨£...æˆ‘è©²æ€éº¼æ”¹è®Šï¼Ÿ' },

                // Phase 5: è‡ªæˆ‘æ¢ç´¢èˆ‡åƒ¹å€¼è§€ (22-27åˆ†é˜)
                { speaker: 'counselor', text: 'æ”¹è®Šæ˜¯ä¸€å€‹éç¨‹ã€‚æˆ‘å€‘å¯ä»¥å…ˆå¾è¦ºå¯Ÿé–‹å§‹ï¼Œä½ é¡˜æ„è©¦è©¦çœ‹å—ï¼Ÿ' },
                { speaker: 'client', text: 'é¡˜æ„ï¼Œä½†è¦æ€éº¼åšï¼Ÿ' },
                { speaker: 'counselor', text: 'ä¸‹æ¬¡ç•¶ä½ åˆæƒ³å£“æŠ‘è‡ªå·±çš„æ„Ÿå—æ™‚ï¼Œå…ˆåœä¸‹ä¾†ï¼Œå•è‡ªå·±ï¼šæˆ‘ç¾åœ¨çœŸæ­£çš„æ„Ÿå—æ˜¯ä»€éº¼ï¼Ÿ' },
                { speaker: 'client', text: 'å¥½ï¼Œæˆ‘è©¦è©¦çœ‹ã€‚' },
                { speaker: 'counselor', text: 'é‚„æœ‰ï¼Œæˆ‘æƒ³å•ä½ ï¼Œåœ¨ä½ çš„ç”Ÿæ´»ä¸­ï¼Œä»€éº¼äº‹æƒ…æ˜¯çœŸæ­£é‡è¦çš„ï¼Ÿ' },
                { speaker: 'client', text: 'é‡è¦çš„...å®¶äººã€å·¥ä½œ...é‚„æœ‰è‡ªå·±çš„å¥åº·å§ã€‚' },
                { speaker: 'counselor', text: 'é€™äº›éƒ½å¾ˆé‡è¦ã€‚é‚£ä½ ç¾åœ¨çš„ç”Ÿæ´»ï¼Œæœ‰ç¬¦åˆé€™äº›åƒ¹å€¼å—ï¼Ÿ' },
                { speaker: 'client', text: 'å¥½åƒæ²’æœ‰...æˆ‘ç‚ºäº†å·¥ä½œçŠ§ç‰²å¥åº·ï¼Œç‚ºäº†å®¶äººå£“æŠ‘è‡ªå·±ã€‚' },
                { speaker: 'counselor', text: 'ä½ çœ‹åˆ°é€™å€‹å¤±è¡¡äº†ã€‚' },
                { speaker: 'client', text: 'å°ï¼Œä½†æˆ‘ä¸çŸ¥é“è¦æ€éº¼å¹³è¡¡ã€‚' },
                { speaker: 'counselor', text: 'å¦‚æœå¯ä»¥é‡æ–°å®‰æ’ï¼Œä½ å¸Œæœ›ä½ çš„ç”Ÿæ´»æ˜¯ä»€éº¼æ¨£å­ï¼Ÿ' },
                { speaker: 'client', text: 'æˆ‘å¸Œæœ›...å¯ä»¥åšè‡ªå·±å–œæ­¡çš„äº‹ï¼Œä¹Ÿèƒ½å¥½å¥½ç…§é¡§èº«é«”ã€‚' },
                { speaker: 'counselor', text: 'é‚£ä½ å–œæ­¡åšä»€éº¼äº‹ï¼Ÿ' },
                { speaker: 'client', text: 'æˆ‘å–œæ­¡ç™»å±±ï¼Œé‚„æœ‰æ”å½±ï¼Œä½†å·²ç¶“å¾ˆä¹…æ²’åšäº†ã€‚' },
                { speaker: 'counselor', text: 'æ˜¯ä»€éº¼é˜»æ­¢ä½ åšé€™äº›äº‹ï¼Ÿ' },
                { speaker: 'client', text: 'ç¸½è¦ºå¾—æ²’æ™‚é–“ï¼Œå·¥ä½œå¤ªå¿™äº†ã€‚' },
                { speaker: 'counselor', text: 'å¦‚æœæŠŠé€™äº›äº‹æƒ…ä¹Ÿæ’é€²ä½ çš„è¡Œç¨‹ï¼Œä½ è¦ºå¾—å¯è¡Œå—ï¼Ÿ' },
                { speaker: 'client', text: 'å¯èƒ½...é€±æœ«å¯ä»¥è©¦è©¦çœ‹ã€‚' },

                // Phase 6: ç›®æ¨™è¨­å®šèˆ‡ç¸½çµ (27-30åˆ†é˜)
                { speaker: 'counselor', text: 'é€™æ˜¯å€‹å¾ˆå¥½çš„é–‹å§‹ã€‚é‚£æˆ‘å€‘ä¾†è¨­å®šä¸€äº›å°ç›®æ¨™ï¼Œé€™é€±ä½ æƒ³è©¦è‘—åšä»€éº¼ï¼Ÿ' },
                { speaker: 'client', text: 'é€™é€±æœ«æˆ‘æƒ³å»çˆ¬å€‹å°å±±ï¼Œå¸¶è‘—ç›¸æ©Ÿã€‚' },
                { speaker: 'counselor', text: 'è½èµ·ä¾†æ˜¯å€‹å¾ˆæ£’çš„è¨ˆç•«ã€‚é‚£é—œæ–¼è·Ÿåª½åª½æºé€šçš„éƒ¨åˆ†å‘¢ï¼Ÿ' },
                { speaker: 'client', text: 'æˆ‘æƒ³...æ‰¾å€‹æ™‚é–“å¥½å¥½è·Ÿå¥¹èŠèŠæˆ‘çš„æƒ³æ³•ã€‚' },
                { speaker: 'counselor', text: 'å¾ˆå¥½ã€‚ä½ æƒ³æ€éº¼é–‹å§‹é€™å€‹å°è©±ï¼Ÿ' },
                { speaker: 'client', text: 'å¯èƒ½å¾è¬è¬å¥¹çš„é—œå¿ƒé–‹å§‹ï¼Œç„¶å¾Œèªªæˆ‘æœ‰è‡ªå·±çš„è¦åŠƒã€‚' },
                { speaker: 'counselor', text: 'é€™å€‹é–‹å ´å¾ˆæº«å’Œã€‚è¨˜å¾—ï¼Œè¡¨é”è‡ªå·±ä¸ä»£è¡¨è¡çªï¼Œè€Œæ˜¯è®“å°æ–¹æ›´äº†è§£ä½ ã€‚' },
                { speaker: 'client', text: 'å—¯ï¼Œæˆ‘æœƒè©¦è©¦çœ‹ã€‚' },
                { speaker: 'counselor', text: 'é‚£å·¥ä½œçš„éƒ¨åˆ†ï¼Œä½ è¦ºå¾—éœ€è¦è·Ÿä¸»ç®¡è«‡å—ï¼Ÿ' },
                { speaker: 'client', text: 'æˆ‘æƒ³å†è§€å¯Ÿçœ‹çœ‹ï¼Œå¦‚æœæƒ…æ³æ²’æ”¹å–„ï¼Œæˆ‘å†æ‰¾æ©Ÿæœƒè·Ÿä»–èªªã€‚' },
                { speaker: 'counselor', text: 'å¥½çš„ï¼Œé€™æ˜¯ä½ çš„æ±ºå®šã€‚æˆ‘å€‘ä¸‹æ¬¡è¦‹é¢æ™‚å¯ä»¥å†è¨è«–é€²å±•ã€‚' },
                { speaker: 'client', text: 'å¥½ã€‚' },
                { speaker: 'counselor', text: 'ä»Šå¤©æˆ‘å€‘èŠäº†å¾ˆå¤šï¼Œä½ å°å·¥ä½œã€å®¶åº­ã€é‚„æœ‰è‡ªå·±çš„éœ€æ±‚éƒ½æœ‰äº†æ›´å¤šè¦ºå¯Ÿã€‚' },
                { speaker: 'client', text: 'å°ï¼Œæˆ‘è¦ºå¾—é‡æ¸…äº†ä¸€äº›äº‹æƒ…ã€‚' },
                { speaker: 'counselor', text: 'é€™å¾ˆå¥½ã€‚è¨˜å¾—ï¼Œæ”¹è®Šéœ€è¦æ™‚é–“ï¼Œå°è‡ªå·±æœ‰è€å¿ƒä¸€é»ã€‚' },
                { speaker: 'client', text: 'æˆ‘æœƒçš„ï¼Œè¬è¬ä½ ã€‚' },
                { speaker: 'counselor', text: 'ä¸å®¢æ°£ã€‚æˆ‘å€‘ä¸‹é€±åŒä¸€æ™‚é–“è¦‹ï¼Œä½ è¦ºå¾—å¯ä»¥å—ï¼Ÿ' },
                { speaker: 'client', text: 'å¯ä»¥ï¼Œä¸‹é€±è¦‹ã€‚' },
                { speaker: 'counselor', text: 'å¥½çš„ï¼Œé‚£å°±ä¸‹é€±è¦‹ã€‚è¨˜å¾—ç…§é¡§å¥½è‡ªå·±ã€‚' },
                { speaker: 'client', text: 'å¥½ï¼Œä½ ä¹Ÿæ˜¯ã€‚' }
            ]
        };

        let currentScript = demoScripts.workStress; // é è¨­ä½¿ç”¨å·¥ä½œå£“åŠ›åŠ‡æœ¬

        function simulateTranscriptInput() {
            // Test mode: Allow manual transcript simulation
            // Works independently of recording state - useful for testing UI

            // å¾ªåºæ’­æ”¾åŠ‡æœ¬
            if (demoScriptIndex < currentScript.length) {
                const line = currentScript[demoScriptIndex];

                // è‡ªå‹•åˆ‡æ›èªªè©±è€…
                if (line.speaker !== currentSpeaker) {
                    switchSpeaker(line.speaker);
                }

                addTranscriptLine(line.speaker, line.text);
                demoScriptIndex++;

                console.log(`ğŸ“ Test mode: Added line ${demoScriptIndex}/${currentScript.length} - ${line.speaker}: ${line.text.substring(0, 30)}...`);
            } else {
                // åŠ‡æœ¬æ’­å®Œï¼Œé‡ç½®æˆ–æç¤º
                console.log('âœ… Demo åŠ‡æœ¬å·²æ’­æ”¾å®Œç•¢ï¼ŒæŒ‰ R éµé‡æ–°é–‹å§‹');
            }
        }

        // === Audio Simulation Functions ===
        function initializeAudioSimulation() {
            // Calculate total duration from script timestamps
            const lastLine = currentScript[currentScript.length - 1];
            audioSimulation.duration = lastLine.time || 400; // Default 400 seconds (~6.7 minutes)

            // Reset state
            audioSimulation.currentTime = 0;
            audioSimulation.lastDisplayedIndex = 0;
            audioSimulation.isPlaying = false;

            // Update UI - only show player if voice simulation is enabled
            if (audioPlayerSection) {
                audioPlayerSection.style.display = isVoiceSimEnabled ? 'block' : 'none';
                audioStatus.textContent = 'æº–å‚™å°±ç·’';
                audioDuration.textContent = formatTime(audioSimulation.duration);
                audioCurrentTime.textContent = '0:00';
                audioProgress.style.width = '0%';
            }

            console.log(`ğŸµ éŸ³è¨Šæ¨¡æ“¬å·²åˆå§‹åŒ–ï¼Œç¸½æ™‚é•·: ${formatTime(audioSimulation.duration)}`);
        }

        // === Web Speech API (TTS) Functions ===
        function initializeSpeechSynthesis() {
            if (!ttsState.isSupported) {
                console.warn('âš ï¸ æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Speech API (TTS)');
                return;
            }

            // Wait for voices to be loaded
            function loadVoices() {
                ttsState.voices = speechSynthesis.getVoices();
                selectVoices();
            }

            // Voices may load asynchronously
            speechSynthesis.onvoiceschanged = loadVoices;

            // Try loading immediately (some browsers have voices ready)
            loadVoices();

            console.log('ğŸ”Š Web Speech API (TTS) å·²åˆå§‹åŒ–');
        }

        function selectVoices() {
            if (ttsState.voices.length === 0) {
                console.warn('âš ï¸ å°šæœªè¼‰å…¥èªéŸ³åˆ—è¡¨');
                return;
            }

            // Try to find Traditional Chinese (zh-TW) voices
            const zhTWVoices = ttsState.voices.filter(v => v.lang.includes('zh-TW'));
            const zhVoices = ttsState.voices.filter(v => v.lang.includes('zh'));

            // Select counselor voice (prefer female voice for Traditional Chinese)
            ttsState.counselorVoice = zhTWVoices.find(v => v.name.includes('Female') || v.name.includes('å¥³')) ||
                                     zhTWVoices.find(v => v.name.includes('Meijia') || v.name.includes('ç¾ä½³')) ||
                                     zhVoices.find(v => v.name.includes('Female') || v.name.includes('å¥³')) ||
                                     zhTWVoices[0] ||
                                     zhVoices[0] ||
                                     ttsState.voices[0]; // Fallback to any voice

            // Select client voice (prefer male voice for Traditional Chinese)
            ttsState.clientVoice = zhTWVoices.find(v => v.name.includes('Male') || v.name.includes('ç”·')) ||
                                  zhTWVoices.find(v => v.name.includes('Zhiwei') || v.name.includes('å¿—å¨')) ||
                                  zhVoices.find(v => v.name.includes('Male') || v.name.includes('ç”·')) ||
                                  zhTWVoices[1] || // Try different voice from counselor
                                  zhVoices[1] ||
                                  ttsState.voices[1] || // Fallback to different voice
                                  ttsState.voices[0]; // Last resort

            console.log(`ğŸ™ï¸ è«®è©¢å¸«èªéŸ³: ${ttsState.counselorVoice?.name || 'æœªé¸æ“‡'} (${ttsState.counselorVoice?.lang || 'N/A'})`);
            console.log(`ğŸ™ï¸ æ¡ˆä¸»èªéŸ³: ${ttsState.clientVoice?.name || 'æœªé¸æ“‡'} (${ttsState.clientVoice?.lang || 'N/A'})`);
            console.log(`ğŸ“‹ å¯ç”¨èªéŸ³æ•¸é‡: ${ttsState.voices.length}`);
        }

        function speakText(text, speaker) {
            if (!ttsState.isSupported) return;
            if (!isVoiceSimEnabled) return; // Only speak if voice simulation is enabled
            if (!audioSimulation.isPlaying) return; // Only speak if audio is playing

            // Cancel any ongoing speech
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-TW'; // Traditional Chinese

            // Select voice and adjust pitch based on speaker
            if (speaker === 'counselor') {
                utterance.voice = ttsState.counselorVoice;
                utterance.pitch = 1.1; // Slightly higher pitch for counselor
            } else {
                utterance.voice = ttsState.clientVoice;
                utterance.pitch = 0.9; // Slightly lower pitch for client
            }

            // Speech settings
            utterance.rate = 1.0; // Normal speed
            utterance.volume = 1.0; // Full volume

            // Error handling
            utterance.onerror = (event) => {
                console.error('ğŸ”‡ TTS éŒ¯èª¤:', event.error);
            };

            // Store reference and speak
            ttsState.currentUtterance = utterance;
            speechSynthesis.speak(utterance);

            console.log(`ğŸ—£ï¸ TTS: ${speaker === 'counselor' ? 'è«®è©¢å¸«' : 'æ¡ˆä¸»'} - "${text.substring(0, 20)}${text.length > 20 ? '...' : ''}"`);
        }

        function stopSpeech() {
            if (ttsState.isSupported && speechSynthesis.speaking) {
                speechSynthesis.cancel();
                console.log('ğŸ”‡ TTS å·²åœæ­¢');
            }
        }

        function toggleAudioPlayback() {
            if (!isRecording) {
                alert('è«‹å…ˆé»æ“Šã€Œé–‹å§‹æœƒè«‡ã€');
                return;
            }

            if (audioSimulation.isPlaying) {
                pauseAudioSimulation();
            } else {
                playAudioSimulation();
            }
        }

        function playAudioSimulation() {
            // If finished, restart from beginning
            if (audioSimulation.currentTime >= audioSimulation.duration) {
                audioSimulation.currentTime = 0;
                audioSimulation.lastDisplayedIndex = 0;
                transcriptSegments = [];
                transcript.innerHTML = '';
                console.log('â†º é‡æ–°é–‹å§‹æ’­æ”¾');
            }

            audioSimulation.isPlaying = true;
            audioSimulation.startTimeMs = performance.now() - (audioSimulation.currentTime * 1000);

            // Update UI
            audioPlayIcon.textContent = 'â¸ï¸';
            audioPlayText.textContent = 'æš«åœ';
            audioStatus.textContent = 'æ’­æ”¾ä¸­';

            // Start animation loop
            updateAudioProgress();

            console.log('â–¶ï¸ é–‹å§‹æ’­æ”¾æ¨¡æ“¬éŸ³è¨Š');
        }

        function pauseAudioSimulation() {
            audioSimulation.isPlaying = false;

            if (audioSimulation.animationFrame) {
                cancelAnimationFrame(audioSimulation.animationFrame);
                audioSimulation.animationFrame = null;
            }

            // Stop speech synthesis
            stopSpeech();

            // Update UI
            audioPlayIcon.textContent = 'â–¶ï¸';
            audioPlayText.textContent = 'ç¹¼çºŒæ’­æ”¾';
            audioStatus.textContent = 'å·²æš«åœ';

            console.log('â¸ï¸ æš«åœæ’­æ”¾');
        }

        function seekAudio(percentage) {
            const newTime = audioSimulation.duration * percentage;
            audioSimulation.currentTime = newTime;
            audioSimulation.startTimeMs = performance.now() - (newTime * 1000);

            // Stop any ongoing speech when seeking
            stopSpeech();

            // Update which lines should be displayed
            audioSimulation.lastDisplayedIndex = 0;
            transcriptSegments = [];
            transcript.innerHTML = '';

            // Display all lines up to current time
            for (let i = 0; i < currentScript.length; i++) {
                const line = currentScript[i];
                if (line.time && line.time <= newTime) {
                    if (line.speaker !== currentSpeaker) {
                        switchSpeaker(line.speaker);
                    }
                    addTranscriptLine(line.speaker, line.text);
                    audioSimulation.lastDisplayedIndex = i + 1;
                } else {
                    break;
                }
            }

            updateAudioUI();
            console.log(`â© è·³è½‰åˆ° ${formatTime(newTime)}`);
        }

        function updateAudioProgress() {
            if (!audioSimulation.isPlaying) return;

            const elapsed = performance.now() - audioSimulation.startTimeMs;
            audioSimulation.currentTime = Math.min(elapsed / 1000, audioSimulation.duration);

            // Display new transcript lines based on timestamp
            displayTranscriptAtTime(audioSimulation.currentTime);

            // Update UI
            updateAudioUI();

            // Check if finished
            if (audioSimulation.currentTime >= audioSimulation.duration) {
                audioSimulation.isPlaying = false;
                audioStatus.textContent = 'æ’­æ”¾å®Œç•¢';
                audioPlayIcon.textContent = 'â†º';
                audioPlayText.textContent = 'é‡æ–°æ’­æ”¾';
                console.log('âœ… éŸ³è¨Šæ’­æ”¾å®Œç•¢');
                return;
            }

            // Continue loop
            audioSimulation.animationFrame = requestAnimationFrame(updateAudioProgress);
        }

        function displayTranscriptAtTime(currentTime) {
            // Display all lines that should appear by current time
            for (let i = audioSimulation.lastDisplayedIndex; i < currentScript.length; i++) {
                const line = currentScript[i];

                if (line.time && line.time <= currentTime) {
                    // Switch speaker if needed
                    if (line.speaker !== currentSpeaker) {
                        switchSpeaker(line.speaker);
                    }

                    // Add transcript line
                    addTranscriptLine(line.speaker, line.text);

                    // Speak the text using TTS if voice simulation is enabled
                    if (isVoiceSimEnabled && audioSimulation.isPlaying) {
                        speakText(line.text, line.speaker);
                    }

                    audioSimulation.lastDisplayedIndex = i + 1;
                } else {
                    // Not yet time for this line
                    break;
                }
            }
        }

        function updateAudioUI() {
            const progress = (audioSimulation.currentTime / audioSimulation.duration) * 100;
            audioProgress.style.width = `${progress}%`;
            audioCurrentTime.textContent = formatTime(audioSimulation.currentTime);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${String(secs).padStart(2, '0')}`;
        }

        // Demo: Press 'T' to add next transcript line
        // Press 'R' to reset script
        // Press '1' for work stress script, '2' for general script
        document.addEventListener('keydown', (e) => {
            if (e.key === 't' || e.key === 'T') {
                simulateTranscriptInput();
            } else if (e.key === 'r' || e.key === 'R') {
                demoScriptIndex = 0;
                console.log('Demo åŠ‡æœ¬å·²é‡ç½®');
            } else if (e.key === '1') {
                currentScript = demoScripts.workStress;
                demoScriptIndex = 0;
                console.log('åˆ‡æ›åˆ°åŠ‡æœ¬ 1: å·¥ä½œå£“åŠ›èˆ‡ç„¦æ…®');
            } else if (e.key === '2') {
                currentScript = demoScripts.general;
                demoScriptIndex = 0;
                console.log('åˆ‡æ›åˆ°åŠ‡æœ¬ 2: ä¸€èˆ¬è«®è©¢');
            }
        });

        // === Initialize ===
        // Initialize waveform animations as paused on page load
        updateWaveformAnimations();

        // Hide speaker toggle in demo mode (scripted conversations auto-switch speaker)
        if (isDemoMode && speakerToggleSection) {
            speakerToggleSection.style.display = 'none';
        }

        // Hide history section in demo mode
        const historyContainer = document.getElementById('historyContainer');
        if (isDemoMode && historyContainer) {
            historyContainer.style.display = 'none';
        }

        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log('ğŸ¤ AI å³æ™‚è¦ªå­è«®è©¢åˆ†æç³»çµ± - Demo æ¨¡å¼ï¼ˆéŸ³è¨ŠåŒæ­¥ç‰ˆï¼‰');
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log('');
        console.log('ğŸµ éŸ³è¨Šæ’­æ”¾æ¨¡å¼ï¼š');
        console.log('  1. é»æ“Šã€Œé–‹å§‹æœƒè«‡ã€');
        console.log('  2. é»æ“Šã€Œæ’­æ”¾å°è©±ã€æŒ‰éˆ•');
        console.log('  3. é€å­—ç¨¿æœƒæ ¹æ“šéŸ³è¨Šæ™‚é–“æˆ³è‡ªå‹•é¡¯ç¤º');
        console.log('  4. éš¨æ™‚é»æ“Šã€Œå³æ™‚åˆ†æã€åˆ†æç•¶å‰å·²é¡¯ç¤ºçš„å°è©±');
        console.log('');
        console.log('ğŸ“Œ å¿«æ·éµèªªæ˜ï¼ˆå‚™ç”¨æ‰‹å‹•æ¨¡å¼ï¼‰ï¼š');
        console.log('  T - æ‰‹å‹•æ’­æ”¾ä¸‹ä¸€å¥å°è©±');
        console.log('  R - é‡ç½®åŠ‡æœ¬');
        console.log('  1 - å·¥ä½œå£“åŠ›åŠ‡æœ¬ï¼ˆå«è‡ªæ®ºé¢¨éšªï¼‰');
        console.log('  2 - ä¸€èˆ¬è«®è©¢åŠ‡æœ¬');
        console.log('');
        console.log('ğŸ¤– AI åˆ†æï¼š');
        console.log('  â€¢ è‡ªå‹•æ¨¡å¼ï¼šæ¯ 60 ç§’è‡ªå‹•è§¸ç™¼');
        console.log('  â€¢ æ‰‹å‹•æ¨¡å¼ï¼šéš¨æ™‚é»æ“Šã€Œå³æ™‚åˆ†æã€æŒ‰éˆ•');
        console.log('  â€¢ åˆ†æç¯„åœï¼šåƒ…åˆ†æç•¶å‰å·²é¡¯ç¤ºçš„é€å­—ç¨¿');
        console.log('');
        console.log('âœ¨ ç•¶å‰åŠ‡æœ¬ï¼šå·¥ä½œå£“åŠ›èˆ‡ç„¦æ…®ï¼ˆåŠ‡æœ¬ 1ï¼‰');
        console.log('ğŸ’¡ Demo æ¨¡å¼ï¼šæ¨¡æ“¬å³æ™‚å°è©±ï¼Œèªªè©±è€…è‡ªå‹•åˆ‡æ›');
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

        // ==================== Login/Logout Functionality ====================
        // Check if user is logged in on page load
        function checkAuth() {
            const token = localStorage.getItem('authToken');
            const email = localStorage.getItem('userEmail');

            if (token && email) {
                // User is logged in
                document.getElementById('loginContainer').style.display = 'none';

                // Show mobile global navigation (only on mobile)
                document.getElementById('mobileGlobalNav').style.display = 'block';

                // Mobile: Show onboarding (client selection) first
                // Desktop: Show main content directly
                const isMobile = window.innerWidth < 768;
                if (isMobile) {
                    document.getElementById('onboardingContainer').style.display = 'block';
                    document.getElementById('mainContent').style.display = 'none';

                    // Show onboarding screen 1 (client selection)
                    document.getElementById('onboardingScreen1').style.display = 'flex';
                    document.getElementById('onboardingScreen2').style.display = 'none';
                    document.getElementById('clientListMode').style.display = 'flex';
                    document.getElementById('clientFormMode').style.display = 'none';
                } else {
                    document.getElementById('mainContent').style.display = 'block';
                    document.getElementById('onboardingContainer').style.display = 'none';
                }

                // Display user email in header
                const emailDisplay = document.getElementById('userEmailDisplay');
                if (emailDisplay) {
                    emailDisplay.textContent = email;
                }
            } else {
                // User is not logged in, show login form
                document.getElementById('loginContainer').style.display = 'flex';
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('onboardingContainer').style.display = 'none';
                document.getElementById('mobileGlobalNav').style.display = 'none';
            }
        }

        // Debug Mode: Long-press handler
        let longPressTimer = null;
        let isDebugMode = localStorage.getItem('debugMode') === 'true';

        // Show debug indicator if already in debug mode
        if (isDebugMode) {
            document.getElementById('debugIndicator').classList.remove('hidden');
        }

        const loginSubmitBtn = document.getElementById('loginSubmitBtn');

        // Long-press start (works for both touch and mouse)
        function startLongPress(e) {
            longPressTimer = setTimeout(() => {
                // Enable debug mode after 3 seconds
                isDebugMode = true;
                localStorage.setItem('debugMode', 'true');
                document.getElementById('debugIndicator').classList.remove('hidden');
                showLoginAlert('Debug mode activated! Click to skip login.', 'success');

                // Vibrate if supported (mobile)
                if (navigator.vibrate) {
                    navigator.vibrate(200);
                }
            }, 3000);
        }

        // Long-press end
        function endLongPress() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }

        // Add event listeners for long-press
        loginSubmitBtn.addEventListener('mousedown', startLongPress);
        loginSubmitBtn.addEventListener('mouseup', endLongPress);
        loginSubmitBtn.addEventListener('mouseleave', endLongPress);
        loginSubmitBtn.addEventListener('touchstart', startLongPress);
        loginSubmitBtn.addEventListener('touchend', endLongPress);
        loginSubmitBtn.addEventListener('touchcancel', endLongPress);

        // Toggle advanced options
        function toggleAdvancedOptions() {
            const advancedPanel = document.getElementById('advancedOptions');
            const toggleBtn = document.getElementById('showAdvancedBtn');
            if (advancedPanel.classList.contains('hidden')) {
                advancedPanel.classList.remove('hidden');
                toggleBtn.textContent = 'é€²éšé¸é … â–²';
            } else {
                advancedPanel.classList.add('hidden');
                toggleBtn.textContent = 'é€²éšé¸é … â–¼';
            }
        }

        // Handle login form submission
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('loginEmail').value;
            const tenantId = document.getElementById('loginTenantId').value;

            const submitBtn = document.getElementById('loginSubmitBtn');
            const btnText = document.getElementById('loginBtnText');
            const btnSpinner = document.getElementById('loginBtnSpinner');

            // Debug mode: Skip login
            if (isDebugMode) {
                console.log('[DEBUG MODE] Skipping login, using fake token');
                localStorage.setItem('authToken', 'DEBUG_FAKE_TOKEN_' + Date.now());
                localStorage.setItem('userEmail', email || 'debug@example.com');
                localStorage.setItem('tenantId', tenantId);

                // Hide login form
                document.getElementById('loginContainer').style.display = 'none';

                // Show mobile global navigation
                document.getElementById('mobileGlobalNav').style.display = 'block';

                // In debug mode, always show onboarding for island_parents (for testing)
                if (tenantId === 'island_parents') {
                    document.getElementById('onboardingContainer').style.display = 'block';
                    document.getElementById('onboardingScreen1').style.display = 'flex';
                    document.getElementById('onboardingScreen2').style.display = 'none';
                } else {
                    document.getElementById('mainContent').style.display = 'block';
                }

                showLoginAlert('Debug login successful!', 'success');
                return;
            }

            // Normal login flow
            const password = document.getElementById('loginPassword').value;

            if (!password) {
                showLoginAlert('è«‹è¼¸å…¥å¯†ç¢¼', 'error');
                return;
            }

            // Show loading state
            submitBtn.disabled = true;
            btnText.classList.add('hidden');
            btnSpinner.classList.remove('hidden');

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        tenant_id: tenantId
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Login successful
                    localStorage.setItem('authToken', data.access_token);
                    localStorage.setItem('userEmail', email);
                    localStorage.setItem('tenantId', tenantId);

                    // Hide login form
                    document.getElementById('loginContainer').style.display = 'none';

                    // Show mobile global navigation
                    document.getElementById('mobileGlobalNav').style.display = 'block';

                    // island_parents: Always show client selection/creation screen
                    console.log('[LOGIN] Tenant ID:', tenantId);

                    if (tenantId === 'island_parents') {
                        // Load and show client list for island_parents
                        console.log('[LOGIN] island_parents - loading client list');
                        await loadAndShowClientList();
                    } else {
                        // Other tenants - show main content directly
                        console.log('[LOGIN] Other tenant, showing main content');
                        document.getElementById('mainContent').style.display = 'block';
                    }

                    showLoginAlert('ç™»å…¥æˆåŠŸï¼', 'success');
                } else {
                    // Login failed
                    showLoginAlert(data.detail || 'ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ‚¨çš„å¸³è™Ÿå¯†ç¢¼', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showLoginAlert('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                btnText.classList.remove('hidden');
                btnSpinner.classList.add('hidden');
            }
        });

        // Show alert message in login form
        function showLoginAlert(message, type) {
            const alertContainer = document.getElementById('loginAlertContainer');
            const alertClass = type === 'error' ? 'bg-red-100 border-red-400 text-red-700' : 'bg-green-100 border-green-400 text-green-700';

            alertContainer.innerHTML = `
                <div class="${alertClass} border px-4 py-3 rounded mb-4" role="alert">
                    <span class="block sm:inline">${message}</span>
                </div>
            `;

            // Auto-dismiss success messages
            if (type === 'success') {
                setTimeout(() => {
                    alertContainer.innerHTML = '';
                }, 3000);
            }
        }

        // Load clients and show client list
        async function loadAndShowClientList() {
            try {
                const authToken = localStorage.getItem('authToken');
                console.log('[CLIENT_LIST] Fetching clients...');

                const response = await fetch('/api/v1/clients', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const clients = data.items || data || [];
                    console.log('[CLIENT_LIST] Loaded clients:', clients.length);

                    // Show onboarding container
                    document.getElementById('onboardingContainer').style.display = 'block';

                    // If no clients, show client form
                    if (clients.length === 0) {
                        console.log('[CLIENT_LIST] No clients, showing form');
                        showClientForm();
                        return;
                    }

                    // Show client list mode
                    console.log('[CLIENT_LIST] Showing client list');
                    document.getElementById('onboardingScreen1').style.display = 'flex';
                    document.getElementById('clientListMode').style.display = 'flex';
                    document.getElementById('clientFormMode').style.display = 'none';
                    document.getElementById('onboardingScreen2').style.display = 'none';

                    // Render client list
                    renderClientList(clients);
                } else {
                    console.error('[CLIENT_LIST] Failed to fetch clients');
                    // Show form as fallback
                    showClientForm();
                }
            } catch (error) {
                console.error('[CLIENT_LIST] Error:', error);
                // Show form as fallback
                showClientForm();
            }
        }

        // Render client list
        function renderClientList(clients) {
            const container = document.getElementById('clientListContainer');
            container.innerHTML = '';

            clients.forEach(client => {
                const clientCard = document.createElement('div');
                clientCard.className = 'p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-black hover:bg-gray-50 transition-all';
                clientCard.onclick = () => selectClient(client);

                const grade = client.island_parents?.child_grade || 'æœªè¨­å®šå¹´ç´š';
                const relation = client.island_parents?.parent_relation || 'æœªè¨­å®šé—œä¿‚';

                clientCard.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-lg font-bold text-gray-800">${client.name}</div>
                            <div class="text-sm text-gray-600 mt-1">${grade} Â· ${relation}</div>
                        </div>
                        <div class="text-2xl">ğŸ‘¤</div>
                    </div>
                `;

                container.appendChild(clientCard);
            });
        }

        // Select a client
        function selectClient(client) {
            console.log('[CLIENT_SELECT] Selected client:', client.name);

            // Store selected client info
            localStorage.setItem('selectedClientId', client.id);
            localStorage.setItem('selectedClientName', client.name);

            // Hide onboarding container
            document.getElementById('onboardingContainer').style.display = 'none';

            // Show main content with practice/real choice
            document.getElementById('mainContent').style.display = 'block';
        }

        // Show client form
        function showClientForm() {
            console.log('[CLIENT_FORM] Showing client creation form');
            document.getElementById('onboardingContainer').style.display = 'block';
            document.getElementById('onboardingScreen1').style.display = 'flex';
            document.getElementById('clientListMode').style.display = 'none';
            document.getElementById('clientFormMode').style.display = 'flex';
            document.getElementById('onboardingScreen2').style.display = 'none';
        }

        // Check if user has client with island_parents data
        async function checkClientExists(authToken) {
            try {
                console.log('[CHECK_CLIENT] Fetching clients...');
                const response = await fetch('/api/v1/clients', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                console.log('[CHECK_CLIENT] Response status:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    const clients = data.items || data || [];

                    console.log('[CHECK_CLIENT] Total clients:', clients.length);
                    console.log('[CHECK_CLIENT] Clients data:', clients);

                    // Check if user has at least one client with island_parents data
                    const hasValidClient = clients.length > 0 && clients.some(client => {
                        const hasData = client.island_parents &&
                               client.island_parents.child_grade &&
                               client.island_parents.parent_relation;
                        console.log('[CHECK_CLIENT] Client', client.id || client.name, 'has island_parents data:', hasData);
                        return hasData;
                    });

                    console.log('[CHECK_CLIENT] Has valid client:', hasValidClient);
                    return hasValidClient;
                }

                console.log('[CHECK_CLIENT] API call failed, returning false');
                return false;
            } catch (error) {
                console.error('[CHECK_CLIENT] Error:', error);
                return false;
            }
        }

        // Onboarding: Skip onboarding and go to main content
        function skipOnboarding() {
            document.getElementById('onboardingContainer').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        // Onboarding: Back to client selection from mode selection screen
        function backToClientSelection() {
            console.log('[ONBOARDING] Going back to client selection');

            // Hide screen 2 (mode selection)
            document.getElementById('onboardingScreen2').style.display = 'none';

            // Show screen 1 with client list
            document.getElementById('onboardingScreen1').style.display = 'flex';
            document.getElementById('clientListMode').style.display = 'flex';
            document.getElementById('clientFormMode').style.display = 'none';

            // Clear selected client info from localStorage
            localStorage.removeItem('selectedClientId');
            localStorage.removeItem('selectedClientName');

            console.log('[ONBOARDING] Back to client selection complete');
        }

        // Onboarding: Set counseling mode (emergency or practice)
        function setOnboardingMode(mode) {
            console.log(`[ONBOARDING] Setting mode to: ${mode}`);
            counselingMode = mode;

            // Update button styles
            const emergencyBtn = document.getElementById('onboardingEmergencyBtn');
            const practiceBtn = document.getElementById('onboardingPracticeBtn');

            if (mode === 'emergency') {
                emergencyBtn.classList.remove('bg-gray-200', 'text-gray-700');
                emergencyBtn.classList.add('bg-red-500', 'text-white');
                practiceBtn.classList.remove('bg-green-500', 'text-white');
                practiceBtn.classList.add('bg-gray-200', 'text-gray-700');
            } else {
                practiceBtn.classList.remove('bg-gray-200', 'text-gray-700');
                practiceBtn.classList.add('bg-green-500', 'text-white');
                emergencyBtn.classList.remove('bg-red-500', 'text-white');
                emergencyBtn.classList.add('bg-gray-200', 'text-gray-700');
            }

            console.log(`[ONBOARDING] Mode set to: ${counselingMode}`);
        }

        // Onboarding: Complete onboarding and go to main content
        function completeOnboarding() {
            console.log(`[ONBOARDING] Completing with mode: ${counselingMode}`);

            // Apply the selected mode to the main session
            setCounselingMode(counselingMode);

            document.getElementById('onboardingContainer').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';

            console.log('[ONBOARDING] Complete, mode applied to session');
        }

        // Onboarding: Handle client setup form submission
        document.getElementById('clientSetupForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const childNickname = document.getElementById('childNickname').value;
            const childGrade = document.getElementById('childGrade').value;
            const parentRelation = document.getElementById('parentRelation').value;

            const submitBtn = document.getElementById('clientSetupSubmitBtn');
            const btnText = document.getElementById('clientSetupBtnText');
            const btnSpinner = document.getElementById('clientSetupBtnSpinner');

            // Show loading state
            submitBtn.disabled = true;
            btnText.classList.add('hidden');
            btnSpinner.classList.remove('hidden');

            try {
                const authToken = localStorage.getItem('authToken');
                const tenantId = localStorage.getItem('tenantId');

                // Create client via API
                const response = await fetch('/api/v1/clients', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        tenant_id: tenantId,
                        name: childNickname,
                        code: `CHILD_${Date.now()}`, // Auto-generate code
                        email: `${childNickname.toLowerCase()}@island-parents.local`,
                        gender: 'ä¸é€éœ²',
                        birth_date: '2015-01-01', // Default birth date
                        phone: '0900000000',
                        identity_option: 'å…¶ä»–',
                        current_status: 'é€²è¡Œä¸­',
                        island_parents: {
                            child_grade: childGrade,
                            parent_relation: parentRelation
                        }
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Client created successfully
                    console.log('Client created:', data);

                    // Clear form
                    document.getElementById('clientSetupForm').reset();

                    // Reload client list
                    await loadAndShowClientList();

                    // Show success message
                    alert(`${childNickname} å·²æˆåŠŸæ–°å¢ï¼`);
                } else {
                    // Client creation failed
                    alert(data.detail || 'å»ºç«‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                    console.error('Client creation failed:', data);
                }
            } catch (error) {
                console.error('Client setup error:', error);
                alert('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                btnText.classList.remove('hidden');
                btnSpinner.classList.add('hidden');
            }
        });

        // Go to Home function (navigate back to onboarding screen 1 - client selection)
        function goToHome() {
            // Hide all screens
            document.getElementById('mainContent').style.display = 'none';

            // Hide all onboarding screens
            const onboardingScreens = document.querySelectorAll('[id^="onboardingScreen"]');
            onboardingScreens.forEach(screen => {
                screen.style.display = 'none';
            });

            // Show onboarding container and screen 1
            document.getElementById('onboardingContainer').style.display = 'block';
            document.getElementById('onboardingScreen1').style.display = 'flex';

            // Reset any active recording or analysis
            if (typeof stopRecording === 'function') {
                try {
                    stopRecording();
                } catch (e) {
                    console.log('No active recording to stop');
                }
            }
        }

        // Logout function (called by logout button)
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('tenantId');
            localStorage.removeItem('debugMode'); // Clear debug mode on logout

            // Hide main content and onboarding, show login form
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('onboardingContainer').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'flex';

            // Hide mobile global nav
            document.getElementById('mobileGlobalNav').style.display = 'none';

            // Reset debug mode state
            isDebugMode = false;
            document.getElementById('debugIndicator').classList.add('hidden');
        }

        // Check auth on page load
        checkAuth();
    </script>
</body>
</html>
