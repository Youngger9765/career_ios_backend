<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>AI Âç≥ÊôÇË¶™Â≠êË´ÆË©¢ÂàÜÊûê - Parenting Counseling</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Session Workflow Modules (New Architecture) -->
    <script type="module" src="/static/js/api-client.js"></script>
    <script type="module" src="/static/js/session-workflow.js"></script>
    <style>
        /* Custom CSS for commercial-grade UI */
        * {
            -webkit-tap-highlight-color: transparent;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Safe area for mobile notches */
        .safe-area-inset-bottom {
            padding-bottom: max(1rem, env(safe-area-inset-bottom));
        }

        /* Smooth transitions */
        .transition-smooth {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Card hover effects */
        .card-hover {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
        }

        /* Animated gradient backgrounds */
        .gradient-animate {
            background-size: 200% 200%;
            animation: gradientShift 8s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Pulse animation for recording */
        .pulse-recording {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Fade in animation */
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Slide in from right animation */
        .animate-slide-in-right {
            animation: slideInRight 0.4s ease-out;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Chat bubble styles */
        .chat-bubble {
            max-width: 85%;
            word-wrap: break-word;
        }

        @media (min-width: 768px) {
            .chat-bubble {
                max-width: 75%;
            }
        }

        /* Touch-friendly button sizes */
        .btn-touch {
            min-height: 44px;
            min-width: 44px;
        }

        /* Badge severity colors */
        .badge-critical {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .badge-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .badge-info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .badge-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        /* Audio waveform animation */
        .waveform-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            height: 60px;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .waveform-bar {
            width: 6px;
            background: linear-gradient(180deg, #10b981 0%, #14b8a6 100%);
            border-radius: 3px;
            animation: waveform 1.2s ease-in-out infinite;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }

        .waveform-bar:nth-child(1) { animation-delay: 0s; }
        .waveform-bar:nth-child(2) { animation-delay: 0.1s; }
        .waveform-bar:nth-child(3) { animation-delay: 0.2s; }
        .waveform-bar:nth-child(4) { animation-delay: 0.3s; }
        .waveform-bar:nth-child(5) { animation-delay: 0.4s; }
        .waveform-bar:nth-child(6) { animation-delay: 0.3s; }
        .waveform-bar:nth-child(7) { animation-delay: 0.2s; }
        .waveform-bar:nth-child(8) { animation-delay: 0.1s; }

        @keyframes waveform {
            0%, 100% {
                height: 20px;
                background: linear-gradient(180deg, #10b981 0%, #14b8a6 100%);
            }
            50% {
                height: 50px;
                background: linear-gradient(180deg, #14b8a6 0%, #06b6d4 100%);
            }
        }

        /* REQUIREMENT 5: Compact waveform for mobile */
        @keyframes waveform-compact {
            0%, 100% {
                height: 8px;
                background: linear-gradient(180deg, #10b981 0%, #14b8a6 100%);
            }
            50% {
                height: 20px;
                background: linear-gradient(180deg, #14b8a6 0%, #06b6d4 100%);
            }
        }

        /* Recording timer */
        .recording-timer {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Courier New', monospace;
            font-variant-numeric: tabular-nums;
            letter-spacing: 0.05em;
        }

        /* iOS-Style Frosted Glass Effect */
        .ios-frosted {
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
        }

        /* iOS Safe Area - Top */
        .safe-area-inset-top {
            padding-top: max(1rem, env(safe-area-inset-top));
        }

        /* Mobile: Additional padding for fixed mobile nav header */
        @media (max-width: 767px) {
            .mobile-nav-padding {
                padding-top: calc(60px + max(1rem, env(safe-area-inset-top)));
            }
        }

        /* iOS Button Active State */
        .ios-button-active {
            transform: scale(0.96);
        }

        /* iOS Card Shadow */
        .ios-card-shadow {
            box-shadow: 0 2px 16px rgba(0, 0, 0, 0.08), 0 1px 4px rgba(0, 0, 0, 0.04);
        }

        /* Mobile Content Padding for Fixed Bars - REMOVED, using spacer blocks instead */

        /* Haptic Feedback Animation */
        @keyframes haptic-tap {
            0% { transform: scale(1); }
            50% { transform: scale(0.96); }
            100% { transform: scale(1); }
        }

        /* Spinner Animation for Loading State */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        .haptic-feedback:active {
            animation: haptic-tap 0.15s ease-out;
        }

        /* Disabled button styles */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Bouncing dots animation */
        @keyframes bounce-dot {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-8px);
            }
        }

        .loading-dot {
            display: inline-block;
            animation: bounce-dot 1.4s infinite ease-in-out;
        }

        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        /* Pure color concentric circles - fade between red, yellow, green */
        @keyframes color-cycle {
            0%, 25% {
                background: radial-gradient(circle,
                    rgba(239, 68, 68, 0.6) 0%,      /* Solid red center */
                    rgba(239, 68, 68, 0.3) 50%,     /* Light red */
                    rgba(239, 68, 68, 0.1) 80%,     /* Very light red */
                    transparent 100%
                );
            }
            33%, 58% {
                background: radial-gradient(circle,
                    rgba(251, 191, 36, 0.6) 0%,     /* Solid yellow center */
                    rgba(251, 191, 36, 0.3) 50%,    /* Light yellow */
                    rgba(251, 191, 36, 0.1) 80%,    /* Very light yellow */
                    transparent 100%
                );
            }
            66%, 91% {
                background: radial-gradient(circle,
                    rgba(34, 197, 94, 0.6) 0%,      /* Solid green center */
                    rgba(34, 197, 94, 0.3) 50%,     /* Light green */
                    rgba(34, 197, 94, 0.1) 80%,     /* Very light green */
                    transparent 100%
                );
            }
            100% {
                background: radial-gradient(circle,
                    rgba(239, 68, 68, 0.6) 0%,
                    rgba(239, 68, 68, 0.3) 50%,
                    rgba(239, 68, 68, 0.1) 80%,
                    transparent 100%
                );
            }
        }

        @keyframes pulse-scale {
            0%, 100% {
                transform: scale(1);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.1);
                opacity: 1;
            }
        }

        .concentric-circles {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            animation: color-cycle 6s ease-in-out infinite, pulse-scale 3s ease-in-out infinite;
        }

        /* Header is now controlled via Tailwind classes (hidden md:block) */

        /* Custom Alert Modal Styles */
        .custom-modal-overlay {
            position: fixed;
            inset: 0;
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            opacity: 0;
            transition: opacity 0.2s ease-out;
        }

        .custom-modal-overlay.show {
            opacity: 1;
        }

        .custom-modal-container {
            width: 100%;
            max-width: 380px;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.95) translateY(10px);
            transition: transform 0.2s ease-out;
            overflow: hidden;
        }

        .custom-modal-overlay.show .custom-modal-container {
            transform: scale(1) translateY(0);
        }

        .custom-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .custom-modal-header.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-bottom: none;
        }

        .custom-modal-header.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border-bottom: none;
        }

        .custom-modal-header.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border-bottom: none;
        }

        .custom-modal-header.info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border-bottom: none;
        }

        .custom-modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .custom-modal-close {
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            cursor: pointer;
            transition: background 0.15s ease;
            color: inherit;
        }

        .custom-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .custom-modal-body {
            padding: 1.25rem;
            font-size: 0.9375rem;
            line-height: 1.6;
            color: #374151;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 50vh;
            overflow-y: auto;
        }

        .custom-modal-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
        }

        .custom-modal-btn {
            padding: 0.625rem 1.5rem;
            font-size: 0.9375rem;
            font-weight: 500;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: all 0.15s ease;
            min-width: 80px;
        }

        .custom-modal-btn.primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .custom-modal-btn.primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }

        .custom-modal-btn.primary:active {
            transform: scale(0.97);
        }

        /* Mobile optimization for modal */
        @media (max-width: 430px) {
            .custom-modal-container {
                max-width: calc(100% - 2rem);
            }

            .custom-modal-body {
                font-size: 0.875rem;
            }

            .custom-modal-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <!-- MOBILE-ONLY: Global Navigation Header (Fixed at top, shows on ALL screens) -->
    <div id="mobileGlobalNav" class="md:hidden fixed top-0 left-0 right-0 z-[9999] bg-white/95 ios-frosted border-b border-gray-200/50 ios-card-shadow" style="display: none;">
        <div class="flex items-center justify-between px-4 py-3 safe-area-inset-top">
            <!-- Left: Home Button -->
            <button
                type="button"
                onclick="goToHome()"
                class="flex items-center gap-2 px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm font-medium rounded-lg transition-all active:scale-95"
            >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                <span>ÂõûÂà∞È¶ñÈ†Å</span>
            </button>

            <!-- Right: Logout Button -->
            <button
                type="button"
                onclick="logout()"
                class="flex items-center gap-2 px-3 py-2 bg-red-50 hover:bg-red-100 text-red-600 text-sm font-medium rounded-lg transition-all active:scale-95"
            >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                </svg>
                <span>ÁôªÂá∫</span>
            </button>
        </div>
    </div>

    <!-- Early function definitions for mobile nav buttons -->
    <script>
        /**
         * Custom Modal Function - Replaces native alert()
         * @param {string} title - Modal title
         * @param {string} message - Modal message (supports \n for line breaks)
         * @param {string} type - 'success' | 'error' | 'warning' | 'info'
         * @returns {Promise<void>} - Resolves when modal is closed
         */
        function showModal(title, message, type = 'info') {
            return new Promise((resolve) => {
                // Get icon based on type
                const icons = {
                    success: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>',
                    error: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>',
                    warning: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>',
                    info: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
                };

                // Create modal overlay
                const overlay = document.createElement('div');
                overlay.className = 'custom-modal-overlay';
                overlay.innerHTML = `
                    <div class="custom-modal-container">
                        <div class="custom-modal-header ${type}">
                            <div class="custom-modal-title">
                                ${icons[type] || icons.info}
                                <span>${title}</span>
                            </div>
                            <button class="custom-modal-close" aria-label="Close">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="custom-modal-body">${message}</div>
                        <div class="custom-modal-footer">
                            <button class="custom-modal-btn primary">OK</button>
                        </div>
                    </div>
                `;

                // Close modal function
                const closeModal = () => {
                    overlay.classList.remove('show');
                    setTimeout(() => {
                        overlay.remove();
                        resolve();
                    }, 200);
                };

                // Event listeners
                overlay.querySelector('.custom-modal-close').addEventListener('click', closeModal);
                overlay.querySelector('.custom-modal-btn').addEventListener('click', closeModal);
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) closeModal();
                });

                // Keyboard support (Escape to close)
                const handleKeydown = (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                        document.removeEventListener('keydown', handleKeydown);
                    }
                };
                document.addEventListener('keydown', handleKeydown);

                // Add to DOM and show
                document.body.appendChild(overlay);
                requestAnimationFrame(() => {
                    overlay.classList.add('show');
                });
            });
        }

        // Go to Home function (navigate back to onboarding screen 1 - client selection)
        async function goToHome() {
            console.log('[ONBOARDING] Going back to home (client selection)');

            // Hide main content
            document.getElementById('mainContent').style.display = 'none';

            // Reset any active recording or analysis
            if (typeof stopRecording === 'function') {
                try {
                    stopRecording();
                } catch (e) {
                    console.log('No active recording to stop');
                }
            }

            // Reload client list from API
            try {
                const authToken = localStorage.getItem('authToken');
                console.log('[CLIENT_LIST] Fetching clients...');

                const response = await fetch('/api/v1/clients', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const clients = data.items || data || [];
                    console.log('[CLIENT_LIST] Loaded clients:', clients.length);

                    // Show onboarding container
                    document.getElementById('onboardingContainer').style.display = 'block';

                    // If no clients, show client form
                    if (clients.length === 0) {
                        console.log('[CLIENT_LIST] No clients, showing form');
                        if (typeof showClientForm === 'function') {
                            showClientForm();
                        }
                        return;
                    }

                    // Show client list mode
                    console.log('[CLIENT_LIST] Showing client list');
                    document.getElementById('onboardingScreen1').style.display = 'flex';
                    document.getElementById('clientListMode').style.display = 'flex';
                    document.getElementById('clientFormMode').style.display = 'none';
                    document.getElementById('onboardingScreen2').style.display = 'none';

                    // Render client list (will be defined later in the page)
                    if (typeof window.renderClientList === 'function') {
                        window.renderClientList(clients);
                    } else {
                        console.error('[CLIENT_LIST] renderClientList function not found');
                    }
                } else {
                    console.error('[CLIENT_LIST] Failed to fetch clients');
                }
            } catch (error) {
                console.error('[CLIENT_LIST] Error loading clients:', error);
            }
        }

        // Logout function (called by logout button)
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('tenantId');
            localStorage.removeItem('debugMode'); // Clear debug mode on logout

            // Hide main content and onboarding, show login form
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('onboardingContainer').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'flex';

            // Hide mobile global nav
            document.getElementById('mobileGlobalNav').style.display = 'none';

            // Reset debug mode state
            if (typeof isDebugMode !== 'undefined') {
                isDebugMode = false;
                const debugIndicator = document.getElementById('debugIndicator');
                if (debugIndicator) {
                    debugIndicator.classList.add('hidden');
                }
            }
        }

        // Onboarding: Show client form
        function showClientForm() {
            console.log('[CLIENT_FORM] Showing client creation form');
            document.getElementById('onboardingContainer').style.display = 'block';
            document.getElementById('onboardingScreen1').style.display = 'flex';
            document.getElementById('clientListMode').style.display = 'none';
            document.getElementById('clientFormMode').style.display = 'flex';
            document.getElementById('onboardingScreen2').style.display = 'none';
        }

        // Onboarding: Back to client selection from mode selection screen
        function backToClientSelection() {
            console.log('[ONBOARDING] Going back to client selection');
            document.getElementById('onboardingScreen2').style.display = 'none';
            document.getElementById('onboardingScreen1').style.display = 'flex';
            document.getElementById('clientListMode').style.display = 'flex';
            document.getElementById('clientFormMode').style.display = 'none';
            localStorage.removeItem('selectedClientId');
            localStorage.removeItem('selectedClientName');
        }

        // Counseling mode variable (will be set by setOnboardingMode)
        var counselingMode = 'practice'; // default

        // Onboarding: Set counseling mode (emergency or practice)
        function setOnboardingMode(mode) {
            console.log(`[ONBOARDING] Setting mode to: ${mode}`);
            counselingMode = mode;

            const emergencyBtn = document.getElementById('onboardingEmergencyBtn');
            const practiceBtn = document.getElementById('onboardingPracticeBtn');

            if (mode === 'emergency') {
                emergencyBtn.classList.remove('bg-gray-200', 'text-gray-700');
                emergencyBtn.classList.add('bg-red-500', 'text-white');
                practiceBtn.classList.remove('bg-green-500', 'text-white');
                practiceBtn.classList.add('bg-gray-200', 'text-gray-700');
            } else {
                practiceBtn.classList.remove('bg-gray-200', 'text-gray-700');
                practiceBtn.classList.add('bg-green-500', 'text-white');
                emergencyBtn.classList.remove('bg-red-500', 'text-white');
                emergencyBtn.classList.add('bg-gray-200', 'text-gray-700');
            }
        }

        // Onboarding: Complete onboarding and go to main content
        function completeOnboarding() {
            console.log(`[ONBOARDING] Completing with mode: ${counselingMode}`);

            // Apply the selected mode if setCounselingMode exists
            if (typeof setCounselingMode === 'function') {
                setCounselingMode(counselingMode);
            }

            document.getElementById('onboardingContainer').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }
    </script>

    <!-- Login Form (shown when not logged in) - Mobile-Friendly Design -->
    <div id="loginContainer" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-white">
        <div class="w-full max-w-md px-6 py-8 fade-in">
            <!-- Alert Messages -->
            <div id="loginAlertContainer" class="mb-4"></div>

            <!-- Login Form -->
            <form id="loginForm" class="space-y-6">
                <!-- Email Section -->
                <div>
                    <label for="loginEmail" class="block text-gray-800 font-medium text-base mb-3">Ëº∏ÂÖ•ÈõªÂ≠êÈÉµ‰ª∂</label>
                    <input
                        type="email"
                        id="loginEmail"
                        class="w-full px-4 py-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 transition-all text-base"
                        placeholder="your.email@example.com"
                        required
                    >
                </div>

                <!-- Password Section -->
                <div>
                    <label for="loginPassword" class="block text-gray-800 font-medium text-base mb-3">Ëº∏ÂÖ•ÂØÜÁ¢º</label>
                    <input
                        type="password"
                        id="loginPassword"
                        class="w-full px-4 py-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 transition-all text-base"
                        placeholder="Ë´ãËº∏ÂÖ•ÂØÜÁ¢º"
                        required
                    >
                    <div class="mt-2 text-right">
                        <a href="/forgot-password?tenant=island_parents" class="text-xs text-gray-500 hover:text-gray-700 transition-colors">ÂøòË®òÂØÜÁ¢ºÔºü</a>
                    </div>
                </div>

                <!-- Tenant Selector (Hidden by default) -->
                <input type="hidden" id="loginTenantId" value="island_parents">

                <!-- Submit Button - Large Black Button at Bottom -->
                <div class="mt-auto pt-8">
                    <button
                        type="submit"
                        id="loginSubmitBtn"
                        class="w-full py-4 bg-black text-white font-semibold rounded-lg hover:bg-gray-800 transition-all duration-300 text-lg relative"
                    >
                        <span id="loginBtnText">ÈñãÂßãË´ÆË©¢</span>
                        <span id="loginBtnSpinner" class="hidden">ÁôªÂÖ•‰∏≠...</span>
                    </button>
                </div>

                <!-- Debug Indicator (Hidden by default) -->
                <div id="debugIndicator" class="hidden text-center mt-4">
                    <span class="text-xs text-red-500 font-mono">üêõ DEBUG MODE</span>
                </div>
            </form>

            <!-- Advanced Options Toggle (Optional) -->
            <div class="text-center mt-6">
                <button
                    type="button"
                    id="showAdvancedBtn"
                    class="text-sm text-gray-500 hover:text-gray-700 transition-colors"
                    onclick="toggleAdvancedOptions()"
                >
                    ÈÄ≤ÈöéÈÅ∏È†Ö ‚ñº
                </button>
            </div>

            <!-- Advanced Options Panel (Hidden by default) -->
            <div id="advancedOptions" class="hidden mt-4 p-4 bg-gray-50 rounded-lg space-y-3">
                <div>
                    <label for="tenantSelector" class="block text-gray-600 text-sm mb-1">ÁßüÊà∂ÈÅ∏Êìá</label>
                    <select
                        id="tenantSelector"
                        class="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                        onchange="document.getElementById('loginTenantId').value = this.value"
                    >
                        <option value="island_parents" selected>Island Parents</option>
                        <option value="career">Career</option>
                        <option value="island">Island</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Onboarding Container (shown after login for island_parents) -->
    <div id="onboardingContainer" class="fixed inset-0 z-50 bg-white" style="display: none;">
        <!-- Screen 1: Client Selection or Creation -->
        <div id="onboardingScreen1" class="h-full flex flex-col p-6 mobile-nav-padding safe-area-inset-bottom">
            <!-- Top Right Buttons -->
            <div class="flex justify-end items-center gap-4 mb-6">
                <!-- Logout button: Only show on desktop (mobile uses global nav) -->
                <button
                    type="button"
                    onclick="logout()"
                    class="hidden md:inline-block text-red-500 hover:text-red-700 text-sm font-medium transition-colors"
                >
                    ÁôªÂá∫
                </button>
                <!-- Skip button: Always visible -->
                <button
                    type="button"
                    id="skipOnboardingBtn"
                    class="text-gray-500 hover:text-gray-700 text-sm font-medium transition-colors"
                    onclick="skipOnboarding()"
                >
                    Ë∑≥ÈÅé
                </button>
            </div>

            <!-- Mode 1: Client List (shown when user has existing clients) -->
            <div id="clientListMode" class="flex-1 flex flex-col" style="display: none;">
                <h2 class="text-2xl font-bold text-gray-800 mb-8">ÈÅ∏ÊìáÂ≠©Â≠ê</h2>

                <!-- Client List Container -->
                <div id="clientListContainer" class="flex-1 overflow-y-auto space-y-3 mb-6">
                    <!-- Client items will be dynamically inserted here -->
                </div>

                <!-- Add New Client Button -->
                <div class="mt-auto">
                    <button
                        type="button"
                        id="addNewClientBtn"
                        class="w-full py-4 border-2 border-black text-black font-semibold rounded-lg hover:bg-gray-100 transition-all duration-300 text-lg"
                        onclick="showClientForm()"
                    >
                        + Êñ∞Â¢ûÂÖ∂‰ªñÂ≠©Â≠ê
                    </button>
                </div>
            </div>

            <!-- Mode 2: Client Creation Form (shown when no clients or adding new) -->
            <div id="clientFormMode" class="flex-1 flex flex-col" style="display: none;">
                <h2 class="text-2xl font-bold text-gray-800 mb-8">Ë®≠ÂÆöÂ≠©Â≠êË≥áÊñô</h2>

                <form id="clientSetupForm" class="space-y-6 flex-1 flex flex-col">
                    <!-- Child Name Input -->
                    <div>
                        <label for="childNickname" class="block text-gray-800 font-medium text-base mb-3">Ëº∏ÂÖ•Â≠©Â≠êÊö±Á®±</label>
                        <input
                            type="text"
                            id="childNickname"
                            class="w-full px-4 py-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 transition-all text-base"
                            placeholder="ex.Â∞èÂØ∂"
                            required
                        >
                    </div>

                    <!-- Child Grade Dropdown -->
                    <div>
                        <label for="childGrade" class="block text-gray-800 font-medium text-base mb-3">Â≠©Â≠êÂπ¥Á¥ö</label>
                        <select
                            id="childGrade"
                            class="w-full px-4 py-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 transition-all text-base appearance-none bg-white"
                            required
                        >
                            <option value="" disabled selected>Ëº∏ÂÖ•Âπ¥Á¥ö</option>
                            <option value="ÂπºÂÖíÂúí">ÂπºÂÖíÂúí</option>
                            <option value="Â∞èÂ≠∏1Âπ¥Á¥ö">Â∞èÂ≠∏1Âπ¥Á¥ö</option>
                            <option value="Â∞èÂ≠∏2Âπ¥Á¥ö">Â∞èÂ≠∏2Âπ¥Á¥ö</option>
                            <option value="Â∞èÂ≠∏3Âπ¥Á¥ö">Â∞èÂ≠∏3Âπ¥Á¥ö</option>
                            <option value="Â∞èÂ≠∏4Âπ¥Á¥ö">Â∞èÂ≠∏4Âπ¥Á¥ö</option>
                            <option value="Â∞èÂ≠∏5Âπ¥Á¥ö">Â∞èÂ≠∏5Âπ¥Á¥ö</option>
                            <option value="Â∞èÂ≠∏6Âπ¥Á¥ö">Â∞èÂ≠∏6Âπ¥Á¥ö</option>
                            <option value="Âúã‰∏≠1Âπ¥Á¥ö">Âúã‰∏≠1Âπ¥Á¥ö</option>
                            <option value="Âúã‰∏≠2Âπ¥Á¥ö">Âúã‰∏≠2Âπ¥Á¥ö</option>
                            <option value="Âúã‰∏≠3Âπ¥Á¥ö">Âúã‰∏≠3Âπ¥Á¥ö</option>
                            <option value="È´ò‰∏≠1Âπ¥Á¥ö">È´ò‰∏≠1Âπ¥Á¥ö</option>
                            <option value="È´ò‰∏≠2Âπ¥Á¥ö">È´ò‰∏≠2Âπ¥Á¥ö</option>
                            <option value="È´ò‰∏≠3Âπ¥Á¥ö">È´ò‰∏≠3Âπ¥Á¥ö</option>
                            <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
                        </select>
                    </div>

                    <!-- Parent Relationship Dropdown -->
                    <div>
                        <label for="parentRelation" class="block text-gray-800 font-medium text-base mb-3">‰Ω†ÊòØÂ≠©Â≠êÁöÑ</label>
                        <select
                            id="parentRelation"
                            class="w-full px-4 py-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 transition-all text-base appearance-none bg-white"
                            required
                        >
                            <option value="" disabled selected>ÈÅ∏ÊìáÈóú‰øÇ</option>
                            <option value="Áà∏Áà∏">Áà∏Áà∏</option>
                            <option value="Â™ΩÂ™Ω">Â™ΩÂ™Ω</option>
                            <option value="Áà∫Áà∫">Áà∫Áà∫</option>
                            <option value="Â•∂Â•∂">Â•∂Â•∂</option>
                            <option value="Â§ñÂÖ¨">Â§ñÂÖ¨</option>
                            <option value="Â§ñÂ©Ü">Â§ñÂ©Ü</option>
                            <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
                        </select>
                    </div>

                    <!-- Submit Button - Large Black Button at Bottom -->
                    <div class="mt-auto pt-8">
                        <button
                            type="submit"
                            id="clientSetupSubmitBtn"
                            class="w-full py-4 bg-black text-white font-semibold rounded-lg hover:bg-gray-800 transition-all duration-300 text-lg relative"
                        >
                            <span id="clientSetupBtnText">‰∏ã‰∏ÄÊ≠•</span>
                            <span id="clientSetupBtnSpinner" class="hidden">Âª∫Á´ã‰∏≠...</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Screen 2: Mode Selection & Confirmation -->
        <div id="onboardingScreen2" class="h-full flex flex-col p-6 mobile-nav-padding safe-area-inset-bottom" style="display: none;">
            <!-- Back Button (Top Left) -->
            <div class="flex justify-start mb-6">
                <button
                    type="button"
                    onclick="backToClientSelection()"
                    class="text-gray-500 hover:text-gray-700 text-sm font-medium transition-colors flex items-center gap-2"
                >
                    ‚Üê ÈáçÊñ∞ÈÅ∏ÊìáÂ≠©Â≠ê
                </button>
            </div>

            <!-- Content Container (Centered) -->
            <div class="flex-1 flex flex-col items-center justify-center">
                <!-- Success Header -->
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Âª∫Á´ãÂÆåÊàêüéâ</h2>
                </div>

                <!-- Avatar Circle -->
                <div class="mb-6">
                    <div class="w-24 h-24 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center shadow-lg">
                        <span class="text-white text-4xl font-bold">üë∂</span>
                    </div>
                </div>

                <!-- Child Name Display with context -->
                <div class="mb-8 text-center">
                    <p class="text-lg text-gray-600 mb-2">ÁèæÂú®Ë¶ÅË∑ü</p>
                    <p id="childNameDisplay" class="text-3xl font-bold text-gray-800 mb-2"></p>
                    <p class="text-lg text-gray-600">Â∞çË©±</p>
                </div>

                <!-- Mode Selection -->
                <div class="w-full max-w-md mb-8">
                    <label class="text-sm font-semibold text-gray-700 flex items-center gap-2 mb-3 justify-center">
                        <span class="text-xl">üéØ</span>
                        <span>ÈÅ∏ÊìáÊ®°Âºè</span>
                    </label>
                    <div class="grid grid-cols-2 gap-4">
                        <button
                            id="onboardingEmergencyBtn"
                            class="px-6 py-4 rounded-lg bg-red-500 text-white font-semibold text-base transition-all hover:bg-red-600 shadow-md"
                            onclick="setOnboardingMode('emergency')"
                        >
                            üö® ÂØ¶Êà∞Ê®°Âºè
                        </button>
                        <button
                            id="onboardingPracticeBtn"
                            class="px-6 py-4 rounded-lg bg-gray-200 text-gray-700 font-semibold text-base transition-all hover:bg-gray-300 shadow-md"
                            onclick="setOnboardingMode('practice')"
                        >
                            üéì Á∑¥ÁøíÊ®°Âºè
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-3 text-center">
                        ÂØ¶Êà∞ÔºöÂç≥ÊôÇ‰ªãÂÖ•ÔºåÂø´ÈÄüÂª∫Ë≠∞<br>
                        Á∑¥ÁøíÔºö‰∫ãÂâçÊ∫ñÂÇôÔºåË©≥Á¥∞ÊåáÂ∞é
                    </p>
                </div>

                <!-- Next Button - Large Black Button -->
                <div class="w-full max-w-md">
                    <button
                        type="button"
                        id="completeOnboardingBtn"
                        class="w-full py-4 bg-black text-white font-semibold rounded-lg hover:bg-gray-800 transition-all duration-300 text-lg shadow-lg"
                        onclick="completeOnboarding()"
                    >
                        ÈñãÂßãÂ∞çË©±
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content (hidden until logged in) -->
    <div id="mainContent" style="display: none;">
    <!-- Header - Commercial Grade with Gradient - Hidden on mobile, visible on desktop -->
    <nav id="mainHeader" class="hidden md:block sticky top-0 z-50 shadow-lg gradient-animate" style="background: linear-gradient(135deg, #8bd1a8 0%, #7dbf9b 45%, #6fb1a1 100%);">
        <div class="container mx-auto max-w-7xl px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 md:w-12 md:h-12 bg-white rounded-xl flex items-center justify-center shadow-md">
                        <span class="text-2xl">üé§</span>
                    </div>
                    <div>
                        <h1 class="text-white font-bold text-lg md:text-xl">AI Âç≥ÊôÇË¶™Â≠êË´ÆË©¢ÂàÜÊûê</h1>
                        <p class="text-green-900 text-xs hidden md:block">Ë¶™Â≠êÊïôÈ§äÂ∞àÊ•≠Áâà - Êú¨Á≥ªÁµ±‰ΩøÁî®Ë¶™Â≠êÊïôÈ§äÁêÜË´ñÁü•Ë≠òÂ∫´ÔºåÊèê‰æõÂç≥ÊôÇ AI ÂàÜÊûêËàáÂª∫Ë≠∞ÔºåÂπ´Âä©Ë´ÆÂïÜÂ∏´Âú®Ë¶™Â≠êË´ÆË©¢ÈÅéÁ®ã‰∏≠Áç≤ÂæóÂ∞àÊ•≠ÊîØÊè¥„ÄÇ</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="userEmailDisplay" class="text-white text-sm"></span>
                    <button onclick="logout()" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg transition-all duration-300 hover:shadow-lg font-semibold">
                        ÁôªÂá∫
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- MOBILE-ONLY: Non-scrollable Block Layout (100vh, no position: fixed) -->
    <div class="md:hidden h-screen flex flex-col overflow-hidden">
        <!-- TOP BLOCK: Timer and Waveform only (buttons moved to bottom) -->
        <div class="bg-white/95 ios-frosted border-b border-gray-200/50 ios-card-shadow mobile-nav-padding">
            <div class="px-4 py-3">

                <!-- Recording Waveform & Timer (shown when recording) -->
                <div id="recordingTimerDisplayMobile" class="bg-gradient-to-r from-teal-50/90 to-cyan-50/90 rounded-xl p-2.5 border border-teal-200/50" style="display: none;">
                    <div class="flex items-center justify-between gap-2">
                        <!-- Compact Waveform -->
                        <div id="waveformContainerMobile" class="flex items-center justify-center gap-1 flex-1" style="height: 20px;">
                            <div class="waveform-bar" style="width: 3px; animation: waveform-compact 1.2s ease-in-out infinite; animation-delay: 0s;"></div>
                            <div class="waveform-bar" style="width: 3px; animation: waveform-compact 1.2s ease-in-out infinite; animation-delay: 0.1s;"></div>
                            <div class="waveform-bar" style="width: 3px; animation: waveform-compact 1.2s ease-in-out infinite; animation-delay: 0.2s;"></div>
                            <div class="waveform-bar" style="width: 3px; animation: waveform-compact 1.2s ease-in-out infinite; animation-delay: 0.3s;"></div>
                            <div class="waveform-bar" style="width: 3px; animation: waveform-compact 1.2s ease-in-out infinite; animation-delay: 0.2s;"></div>
                            <div class="waveform-bar" style="width: 3px; animation: waveform-compact 1.2s ease-in-out infinite; animation-delay: 0.1s;"></div>
                        </div>
                        <!-- Compact Timer -->
                        <div class="flex items-center gap-1 flex-shrink-0">
                            <div class="w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse"></div>
                            <span id="recordingTimerMobile" class="text-xs font-mono font-bold text-gray-700">00:00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- iOS-style Settings Modal (Bottom Sheet) -->
        <div id="settingsModal" class="fixed inset-0 z-50 hidden">
            <!-- Backdrop -->
            <div id="settingsModalBackdrop" class="absolute inset-0 bg-black/50 opacity-0 transition-opacity duration-300"></div>

            <!-- Modal Content (slides up from bottom) -->
            <div id="settingsModalContent" class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl max-h-[70vh] overflow-y-auto transform translate-y-full transition-transform duration-300 mb-20">
                <!-- Modal Header -->
                <div class="sticky top-0 bg-white/95 backdrop-blur-md border-b border-gray-200 px-6 py-4 flex items-center justify-between rounded-t-3xl">
                    <h3 class="text-lg font-bold text-gray-800">Ë®≠ÂÆö</h3>
                    <button id="settingsModalClose" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 active:bg-gray-200 transition-colors">
                        <span class="text-2xl text-gray-500">√ó</span>
                    </button>
                </div>

                <!-- Modal Body -->
                <div class="px-6 py-4 space-y-4">
                    <!-- AI Model Selection -->
                    <div id="aiModelSectionMobile" class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-2xl p-4 border border-purple-200">
                        <label class="text-sm font-semibold text-gray-700 flex items-center gap-2 mb-3">
                            <span class="text-xl">ü§ñ</span>
                            <span>AI Ê®°Âûã</span>
                        </label>

                        <!-- Provider Toggle -->
                        <div id="aiModelToggleRowMobile" class="flex items-center justify-between mb-3 pb-3 border-b border-purple-200">
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-700" id="providerLabel">Gemini</span>
                            </div>
                            <button id="providerToggle" class="relative inline-flex h-7 w-12 items-center rounded-full bg-gray-300 transition-colors focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <span id="providerToggleCircle" class="inline-block h-5 w-5 transform rounded-full bg-white shadow-lg transition-transform translate-x-1"></span>
                            </button>
                        </div>

                        <div class="text-xs text-gray-600">
                            <span id="providerDescription">ÈÄüÂ∫¶Âø´ ¬∑ ÊîØÊè¥Âø´Âèñ</span>
                            <span id="providerLatency" class="ml-2 text-purple-600 font-mono hidden"></span>
                        </div>

                        <!-- Codeer Model Selector -->
                        <div id="codeerModelSelector" class="mt-3 pt-3 border-t border-purple-200 hidden">
                            <label class="text-xs font-semibold text-gray-600 mb-2 block">ÈÅ∏Êìá Codeer Ê®°Âûã</label>
                            <div class="space-y-2">
                                <label class="flex items-center gap-2 p-3 rounded-xl hover:bg-white/50 cursor-pointer transition-colors border border-transparent hover:border-purple-200">
                                    <input type="radio" name="codeerModel" value="gemini-flash" checked class="text-purple-600 focus:ring-purple-500">
                                    <span class="text-sm">üîÆ Gemini 2.5 Flash<span class="ml-1 text-green-600 font-semibold text-xs">Êé®Ëñ¶</span></span>
                                </label>
                                <label class="flex items-center gap-2 p-3 rounded-xl hover:bg-white/50 cursor-pointer transition-colors border border-transparent hover:border-purple-200">
                                    <input type="radio" name="codeerModel" value="claude-sonnet" class="text-purple-600 focus:ring-purple-500">
                                    <span class="text-sm">ü§ñ Claude Sonnet 4.5<span class="ml-1 text-blue-600 text-xs">È´òÂìÅË≥™</span></span>
                                </label>
                                <label class="flex items-center gap-2 p-3 rounded-xl hover:bg-white/50 cursor-pointer transition-colors border border-transparent hover:border-purple-200">
                                    <input type="radio" name="codeerModel" value="gpt5-mini" class="text-purple-600 focus:ring-purple-500">
                                    <span class="text-sm">‚ö° GPT-5 Mini<span class="ml-1 text-gray-500 text-xs">Á©©ÂÆö</span></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Recording Mode Toggle -->
                    <div class="bg-gray-50 rounded-2xl p-4 border border-gray-200">
                        <div class="flex items-center justify-between">
                            <label class="text-sm font-semibold text-gray-700 flex items-center gap-2">
                                <span class="text-xl">üé§</span>
                                <span id="modeToggleLabel">ÁúüÂØ¶ÈåÑÈü≥</span>
                            </label>
                            <button id="modeToggle" class="relative inline-flex h-7 w-12 items-center rounded-full bg-green-600 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500" role="switch" aria-checked="true" title="ÂàáÊèõÁúüÂØ¶ÈåÑÈü≥/DemoÊ®°Âºè">
                                <span class="inline-block h-5 w-5 transform rounded-full bg-white shadow-lg transition-transform translate-x-6"></span>
                            </button>
                        </div>
                        <span id="modeHint" class="text-xs text-gray-500 mt-2 block">ÈñãÂïü = ÁúüÂØ¶ÈåÑÈü≥ / ÈóúÈñâ = Demo Ê®°Âºè</span>
                    </div>

                    <!-- Counseling Mode Toggle (Emergency/Practice) -->
                    <div class="bg-gray-50 rounded-2xl p-4 border border-gray-200 mt-4">
                        <label class="text-sm font-semibold text-gray-700 flex items-center gap-2 mb-3">
                            <span class="text-xl">üéØ</span>
                            <span>Ë´ÆË©¢Ê®°Âºè</span>
                        </label>
                        <div class="flex gap-2">
                            <button id="emergencyModeBtn" class="flex-1 px-3 py-2 rounded-lg bg-red-500 text-white font-semibold text-sm transition-all hover:bg-red-600">
                                üö® ÂØ¶Êà∞
                            </button>
                            <button id="practiceModeBtn" class="flex-1 px-3 py-2 rounded-lg bg-gray-200 text-gray-700 font-semibold text-sm transition-all hover:bg-gray-300">
                                üéì Á∑¥Áøí
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            Á∑äÊÄ•Ôºö1-2 Âè•Â∞àÂÆ∂Âª∫Ë≠∞ÔºàÂæû 200 Âè•‰∏≠ÈÅ∏ÊìáÔºâ<br>
                            Á∑¥ÁøíÔºö3-4 Âè•Â∞àÂÆ∂Âª∫Ë≠∞ÔºàÂæû 200 Âè•‰∏≠ÈÅ∏ÊìáÔºâ
                        </p>
                    </div>

                    <!-- Transcript Testing Shortcuts (Mobile) -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-4 border border-blue-200 mt-4">
                        <label class="text-sm font-semibold text-gray-700 flex items-center gap-2 mb-3">
                            <span class="text-xl">üß™</span>
                            <span>Âø´ÈÄüÊ∏¨Ë©¶</span>
                        </label>
                        <div class="grid grid-cols-3 gap-2 mb-2">
                            <button id="loadGreenBtn" class="px-2 py-2 rounded-lg bg-green-500 text-white font-semibold text-xs transition-all hover:bg-green-600 shadow-sm">
                                üü¢ Á∂†Ááà
                            </button>
                            <button id="loadYellowBtn" class="px-2 py-2 rounded-lg bg-yellow-500 text-white font-semibold text-xs transition-all hover:bg-yellow-600 shadow-sm">
                                üü° ÈªÉÁáà
                            </button>
                            <button id="loadRedBtn" class="px-2 py-2 rounded-lg bg-red-500 text-white font-semibold text-xs transition-all hover:bg-red-600 shadow-sm">
                                üî¥ Á¥ÖÁáà
                            </button>
                        </div>
                        <button id="quickTestAnalyzeBtn" class="w-full px-3 py-2.5 rounded-lg bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white font-semibold text-xs transition-all mb-2 shadow-md hover:shadow-lg">
                            ‚ö° Á´ãÂç≥ÂàÜÊûê
                        </button>
                        <div class="flex gap-2">
                            <button id="clearTranscriptBtn" class="flex-1 px-2 py-1.5 rounded-lg bg-gray-200 text-gray-700 font-semibold text-xs transition-all hover:bg-gray-300">
                                Ê∏ÖÈô§
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            Âø´ÈÄüËºâÂÖ•Ê∏¨Ë©¶Â∞çË©±ÔºåÁÑ°ÈúÄË™ûÈü≥Ëæ®Ë≠ò
                        </p>
                    </div>
                </div>

                <!-- Safe Area Bottom Padding -->
                <div class="h-6 bg-white"></div>
            </div>
        </div>

        <!-- MIDDLE BLOCK: Content Area (flex-1, fills remaining space) -->
        <div class="flex-1 overflow-hidden bg-gradient-to-br from-gray-50 to-gray-100 p-4">
            <!-- Initial UI (ÊâãÊ©üÁâàÈ¶ñÈ†Å) -->
            <div id="initialUI" class="h-full bg-gradient-to-br from-gray-50 to-white flex flex-col items-center justify-center px-8 py-12 space-y-12">
                <!-- È†ÇÈÉ®Ê®ôÈ°å -->
                <h1 class="text-2xl font-bold text-gray-900 text-center">
                    Ê∫ñÂÇôÂ•ΩË∑üÂ≠©Â≠êË´áË´á‰∫ÜÂóéÔºü
                </h1>

                <!-- ÊåâÈàïÂçÄÂüü -->
                <div class="w-full max-w-sm space-y-6">
                    <!-- Á∑¥ÁøíÊåâÈàï -->
                    <button id="practiceBtn" class="haptic-feedback btn-touch w-full bg-black active:bg-gray-800 text-white py-6 px-8 rounded-3xl font-bold text-lg transition-smooth shadow-xl">
                        È†êÂÖàÁ∑¥Áøí
                    </button>

                    <!-- ÂØ¶Êà∞ÊåâÈàï -->
                    <button id="realTalkBtn" class="haptic-feedback btn-touch w-full bg-black active:bg-gray-800 text-white py-6 px-8 rounded-3xl font-bold text-lg transition-smooth shadow-xl">
                        ÂíåÂ≠©Â≠êË´áË´á
                    </button>
                </div>
            </div>

            <!-- Practice Intro UI (Á∑¥Áøí‰ªãÁ¥πÈ†ÅÈù¢) -->
            <div id="practiceIntroUI" class="hidden h-full bg-gradient-to-br from-gray-50 to-white flex flex-col items-center justify-between px-8 py-12 relative">
                <!-- Navigation buttons -->
                <div class="absolute top-4 left-4 right-4 flex justify-between z-10">
                    <!-- Home button (left) -->
                    <button id="homeBtn" class="haptic-feedback px-4 py-2 bg-white/90 hover:bg-white active:bg-gray-50 rounded-full text-gray-700 font-medium text-sm shadow-md transition-smooth flex items-center gap-2">
                        <span>üè†</span>
                        <span>È¶ñÈ†Å</span>
                    </button>

                    <!-- Back button (right) -->
                    <button id="backToInitialBtn" class="haptic-feedback px-4 py-2 bg-white/90 hover:bg-white active:bg-gray-50 rounded-full text-gray-700 font-medium text-sm shadow-md transition-smooth flex items-center gap-2">
                        <span>‚Üê</span>
                        <span>‰∏ä‰∏ÄÈ†Å</span>
                    </button>
                </div>

                <!-- ‰∏≠Â§ÆÂêåÂøÉÂúìÊº∏Â±§ÂçÄÂüü -->
                <div class="flex-1 flex items-center justify-center w-full">
                    <div class="relative w-80 h-80 flex items-center justify-center">
                        <!-- ÂêåÂøÉÂúìÊº∏Â±§ËÉåÊôØ (4 Â±§ teal/cyan) -->
                        <div class="absolute inset-0 rounded-full" style="background: radial-gradient(circle, #2dd4bf 0%, #5eead4 25%, #99f6e4 50%, #ccfbf1 75%, transparent 100%);"></div>

                        <!-- ‰∏≠Â§ÆÊñáÂ≠ó -->
                        <div class="relative z-10 text-center space-y-6">
                            <h2 class="text-2xl font-bold text-teal-900">
                                Ê∫ñÂÇôÂ•ΩË∑üÂ≠©Â≠êË´áË´á‰∫ÜÂóéÔºü
                            </h2>
                        </div>
                    </div>
                </div>

                <!-- Â∫ïÈÉ®ÊñáÂ≠óÂíåÊåâÈàï -->
                <div class="w-full max-w-sm space-y-8">
                    <!-- ÊèèËø∞ÊñáÂ≠ó -->
                    <div class="text-center space-y-2">
                        <p class="text-lg font-semibold text-gray-800">ÁÇ∫ÁæéÂ•ΩÂ∞çË©±ÂÅöÊ∫ñÂÇô</p>
                        <p class="text-base text-gray-600">Ê∫ñÂÇôÂ•Ω‰∫ÜÔºåÊ∫ùÈÄöÊõ¥ËºïÈ¨Ü</p>
                    </div>

                    <!-- ÂâµÂª∫Á∑¥ÁøíÊåâÈàï -->
                    <button id="createPracticeBtn" class="haptic-feedback btn-touch w-full bg-black active:bg-gray-800 text-white py-6 px-8 rounded-3xl font-bold text-lg transition-smooth shadow-xl">
                        ÂâµÂª∫Á∑¥Áøí
                    </button>
                </div>
            </div>

            <!-- Recording UI (ÊâãÊ©üÁâàÈåÑÈü≥‰∏≠ÁöÑÊ•µÁ∞°ÁïåÈù¢) -->
            <div id="recordingUI" class="hidden h-full flex flex-col items-center justify-between py-8 px-4">
                <!-- È†ÇÈÉ®ÁãÄÊÖãÂíåË®àÊôÇÂô® -->
                <div class="text-center space-y-2">
                    <h2 class="text-lg font-semibold text-gray-800" id="recordingStatusText">Á∑¥ÁøíËàáÂ≠©Â≠êÂ∞çË©±‰∏≠</h2>
                    <p class="text-sm text-gray-600">
                        Â∑≤Ë´áË©± <span id="recordingTimer">00:00:00</span>
                    </p>
                </div>

                <!-- ‰∏≠Â§ÆÂêåÂøÉÂúìÊº∏Â±§ÂíåÂª∫Ë≠∞ÊñáÂ≠ó -->
                <div class="flex-1 flex items-center justify-center w-full max-w-md">
                    <div id="suggestionCircle" class="relative w-80 h-80 rounded-full flex items-center justify-center shadow-2xl" style="background: radial-gradient(circle, #67e8f9 0%, #99f6e4 40%, #ccfbf1 70%, #f0fdfa 100%);">
                        <!-- Âª∫Ë≠∞ÊñáÂ≠ó - ÂàÜÁÇ∫ Deep Âíå Quick ÂÖ©Ë°å -->
                        <div class="text-center px-8 space-y-3">
                            <!-- Deep Analysis (‰∏ªË¶ÅÂª∫Ë≠∞) -->
                            <p id="liveSuggestion" class="text-2xl font-bold text-teal-900 leading-tight">
                                ËÆìÂ≠©Â≠êÁü•ÈÅì<br>‰Ω†Á´ôÂú®‰ªñÈÄôÈÇä
                            </p>
                            <!-- Quick Feedback (Âç≥ÊôÇÈºìÂãµ) -->
                            <p id="quickFeedbackText" class="text-sm font-medium text-teal-700 leading-tight opacity-80">

                            </p>
                        </div>
                    </div>
                </div>

                <!-- Â∫ïÈÉ®È†êÁïôÁ©∫ÈñìÔºàÊåâÈàïÂú® fixed bottom barÔºâ -->
                <div class="h-4"></div>
            </div>

            <!-- REQUIREMENT 6: Carousel Container with Persistent Circle (hidden initially, shown when analysis cards appear) -->
            <div id="mobileCarousel" class="hidden h-full flex flex-col">
                <!-- Top Section: Compact Suggestion Circle (shown when carousel is active) -->
                <div id="carouselSuggestionCircle" class="flex-shrink-0 mb-3 flex items-center justify-center">
                    <div id="carouselCircle" class="relative w-32 h-32 rounded-full flex items-center justify-center shadow-lg transition-all duration-300" style="background: radial-gradient(circle, #67e8f9 0%, #99f6e4 40%, #ccfbf1 70%, #f0fdfa 100%);">
                        <!-- Compact suggestion text - ÂàÜÁÇ∫ Deep Âíå Quick ÂÖ©Ë°å -->
                        <div class="text-center px-4 space-y-1">
                            <!-- Deep Analysis -->
                            <p id="carouselLiveSuggestion" class="text-sm font-bold text-teal-900 leading-tight">
                                ËÆìÂ≠©Â≠êÁü•ÈÅì<br>‰Ω†Á´ôÂú®‰ªñÈÄôÈÇä
                            </p>
                            <!-- Quick Feedback -->
                            <p id="carouselQuickFeedbackText" class="text-xs font-medium text-teal-700 leading-tight opacity-80">

                            </p>
                        </div>
                    </div>
                </div>
                <!-- Carousel Header with Navigation -->
                <div class="flex items-center justify-between mb-3 flex-shrink-0">
                    <h3 class="text-base font-bold text-gray-800 flex items-center gap-2">
                        <span class="text-lg">ü§ñ</span>
                        <span>AI ÂàÜÊûê</span>
                    </h3>
                    <div class="flex items-center gap-2">
                        <span id="carouselCounter" class="text-xs text-gray-500 font-medium">1 / 1</span>
                    </div>
                </div>

                <!-- Carousel Navigation Buttons -->
                <div class="relative flex-1 min-h-0">
                    <!-- Previous Button -->
                    <button id="carouselPrev" class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-2 z-10 w-10 h-10 bg-white/95 ios-frosted rounded-full ios-card-shadow flex items-center justify-center text-gray-700 hover:bg-gray-50 transition-smooth disabled:opacity-30 disabled:cursor-not-allowed" disabled>
                        <span class="text-xl">‚Üê</span>
                    </button>

                    <!-- Card Container -->
                    <div class="overflow-hidden rounded-2xl h-full">
                        <div id="mobileCarouselTrack" class="flex transition-transform duration-300 ease-out h-full">
                            <!-- Cards will be inserted here via JavaScript -->
                        </div>
                    </div>

                    <!-- Next Button -->
                    <button id="carouselNext" class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-2 z-10 w-10 h-10 bg-white/95 ios-frosted rounded-full ios-card-shadow flex items-center justify-center text-gray-700 hover:bg-gray-50 transition-smooth disabled:opacity-30 disabled:cursor-not-allowed" disabled>
                        <span class="text-xl">‚Üí</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- MOBILE-ONLY: Fixed Bottom Navigation Bar (Âè™Âú®ÈåÑÈü≥ÊôÇÈ°ØÁ§∫) -->
        <div id="recordingBottomBar" class="hidden md:hidden fixed bottom-0 left-0 right-0 bg-white/95 ios-frosted border-t border-gray-200/50 ios-card-shadow safe-area-inset-bottom z-50">
            <div class="px-4 py-4 flex gap-3">
                <!-- Êö´ÂÅúÊåâÈàï -->
                <button id="pauseBtnMobile" class="haptic-feedback btn-touch flex-1 bg-black active:bg-gray-800 text-white py-4 px-6 rounded-full font-bold text-base transition-smooth shadow-xl flex items-center justify-center gap-2">
                    <span class="text-2xl">‚è∏</span>
                    <span>Êö´ÂÅú</span>
                </button>

                <!-- ÁµêÊùüÂ∞çË©±ÊåâÈàï -->
                <button id="stopBtnMobile" class="haptic-feedback btn-touch flex-1 bg-white border-2 border-gray-800 text-gray-900 py-4 px-6 rounded-full font-semibold transition-smooth shadow-lg flex items-center justify-center gap-2">
                    <span class="text-xl">‚èπ</span>
                    <span>ÁµêÊùüÂ∞çË©±</span>
                </button>
            </div>
        </div>

        <!-- MOBILE-ONLY: Completion Screen (È°ØÁ§∫Âú®ÁµêÊùüÂ∞çË©±Âæå) -->
        <div id="completionScreen" class="hidden fixed inset-0 bg-gray-50 flex flex-col items-center justify-center px-8 z-50">
            <!-- Title -->
            <h1 class="text-4xl font-bold mb-4 text-gray-900">Â§™Ê£í‰∫ÜÔºÅ</h1>

            <!-- Subtitle with session duration -->
            <p class="text-gray-600 text-lg mb-12">
                Â∑≤ÂÆåÊàê <span id="sessionDuration" class="font-semibold text-gray-900">00:00:00</span> ÁöÑÁ∑¥Áøí
            </p>

            <!-- Buttons -->
            <div class="space-y-4 w-full max-w-xs">
                <!-- View Report Button (Black) -->
                <button id="viewReportBtn" class="haptic-feedback btn-touch w-full bg-black active:bg-gray-800 text-white rounded-full py-4 px-8 text-lg font-medium transition-smooth shadow-xl">
                    Êü•ÁúãÂ†±Âëä
                </button>

                <!-- Return to Home Button (White with border) -->
                <button id="returnHomeBtn" class="haptic-feedback btn-touch w-full bg-white text-black border-2 border-black rounded-full py-4 px-8 text-lg font-medium transition-smooth shadow-lg">
                    ÂõûÂà∞È¶ñÈ†Å
                </button>
            </div>
        </div>

        <!-- MOBILE Loading Overlay for Report Generation -->
        <div id="reportLoadingOverlay" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50" style="z-index: 9999 !important; pointer-events: auto; display: none;">
            <div class="bg-white rounded-2xl p-8 shadow-2xl flex flex-col items-center space-y-6 max-w-md mx-4">
                <!-- Concentric circles gradient animation -->
                <div class="concentric-circles"></div>
                <!-- Loading text (removed "AI") -->
                <p class="text-2xl font-semibold text-gray-800">
                    ÁîüÊàêÂ†±Âëä‰∏≠<span class="loading-dot">.</span><span class="loading-dot">.</span><span class="loading-dot">.</span>
                </p>
                <p class="text-sm text-gray-500 text-center">Ë´ãÁ®çÂÄôÁâáÂàª</p>
            </div>
        </div>

        <!-- MOBILE-ONLY: Report Screen (È°ØÁ§∫Âú®ÈªûÊìäÊü•ÁúãÂ†±ÂëäÂæå) -->
        <div id="reportScreen" class="hidden fixed inset-0 bg-gray-50 overflow-y-auto z-50 px-6 py-8">
            <div class="max-w-2xl mx-auto">
                <!-- Back button (top left) -->
                <button id="reportBackBtn" class="haptic-feedback btn-touch mb-6 text-gray-600 flex items-center gap-2 hover:text-gray-900 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                    <span class="font-medium">ËøîÂõû</span>
                </button>

                <!-- Summary Section (populated from API) -->
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-6 mb-8 shadow-sm border border-blue-100">
                    <div class="flex items-start gap-3">
                        <div class="flex-shrink-0 mt-1">
                            <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="flex-1">
                            <h2 class="text-lg font-semibold text-gray-900 mb-2">Â∞çË©±ÊëòË¶Å</h2>
                            <p id="reportSummary" class="text-gray-700 leading-relaxed">
                                <!-- Summary will be populated by JavaScript -->
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Highlights Section -->
                <h2 class="text-xl font-bold mb-6 text-center text-gray-900">
                    ÈÄôÊ¨°Â∞çË©±ÁöÑ‰∫ÆÈªû
                </h2>

                <!-- Highlight Cards Container -->
                <div id="highlightCards" class="space-y-4 mb-8">
                    <!-- Cards will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- DESKTOP LAYOUT (unchanged) -->
    <div class="container mx-auto px-4 md:px-6 py-4 md:py-6 max-w-7xl md:pb-6 hidden md:block">

        <!-- Demo Mode Instructions - Collapsible on Mobile -->
        <div class="bg-gradient-to-r from-yellow-50 to-amber-50 border-l-4 border-yellow-400 p-4 mb-4 md:mb-6 rounded-xl shadow-md card-hover" style="display: none">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-yellow-400 rounded-lg flex items-center justify-center">
                        <svg class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
                <div class="ml-3 flex-1">
                    <h3 class="text-sm md:text-base font-bold text-yellow-800 flex items-center gap-2">
                        <span>üé≠ Demo Ê®°ÂºèË™™Êòé</span>
                        <span class="text-xs bg-yellow-200 text-yellow-800 px-2 py-0.5 rounded-full">ÁÑ°ÈúÄ API Key</span>
                    </h3>
                    <div class="mt-2 text-sm text-yellow-700 leading-relaxed">
                        <p class="mb-2">Ê≠§ÁÇ∫Â±ïÁ§∫Ê®°ÂºèÔºå‰ΩøÁî®Êô∫ÊÖßÂÅáË≥áÊñôÊ®°Êì¨ÂÆåÊï¥ÂäüËÉΩÔºö</p>
                        <ul class="space-y-1 ml-2">
                            <li class="flex items-center gap-2">
                                <kbd class="px-2 py-1 bg-white rounded border shadow-sm font-mono text-xs">T</kbd>
                                <span>Êí≠Êîæ‰∏ã‰∏ÄÂè•Â∞çË©±ÔºàËá™ÂãïÂàáÊèõË™™Ë©±ËÄÖÔºâ</span>
                            </li>
                            <li class="flex items-center gap-2">
                                <kbd class="px-2 py-1 bg-white rounded border shadow-sm font-mono text-xs">R</kbd>
                                <span>ÈáçÁΩÆÂäáÊú¨ÂæûÈ†≠ÈñãÂßã</span>
                            </li>
                            <li class="flex items-center gap-2">
                                <kbd class="px-2 py-1 bg-white rounded border shadow-sm font-mono text-xs">1</kbd>
                                <span>ÂàáÊèõÂà∞„ÄåÂ∑•‰ΩúÂ£ìÂäõ„ÄçÂäáÊú¨ÔºàÂê´Ëá™ÊÆ∫È¢®Èö™ÂÅµÊ∏¨Ôºâ</span>
                            </li>
                            <li class="flex items-center gap-2">
                                <kbd class="px-2 py-1 bg-white rounded border shadow-sm font-mono text-xs">2</kbd>
                                <span>ÂàáÊèõÂà∞„Äå‰∏ÄËà¨Ë´ÆË©¢„ÄçÂäáÊú¨</span>
                            </li>
                        </ul>
                        <p class="mt-3 font-bold bg-yellow-100 p-2 rounded-lg">üí° AI ÂàÜÊûêÊØè 60 ÁßíËá™ÂãïËß∏ÁôºÔºåÊ†πÊìöÈÄêÂ≠óÁ®øÂÖßÂÆπÊô∫ÊÖßÁîüÊàêÊëòË¶Å„ÄÅË≠¶Á§∫„ÄÅÂª∫Ë≠∞„ÄÇ</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Left Panel: Recording Controls -->
            <div class="space-y-4">
                <!-- Recording Controls - Enhanced -->
                <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 card-hover border border-gray-100">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-8 h-8 bg-gradient-to-br from-red-500 to-pink-500 rounded-lg flex items-center justify-center">
                            <span class="text-white text-lg">üéôÔ∏è</span>
                        </div>
                        <h2 class="text-lg md:text-xl font-bold text-gray-800">ÈåÑÈü≥ÊéßÂà∂</h2>
                    </div>

                    <!-- Timer Display - More Prominent -->
                    <div class="text-center mb-6 bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-4 md:p-6">
                        <div class="text-4xl md:text-5xl font-mono font-bold text-gray-800" id="timer">00:00</div>
                        <div class="text-xs md:text-sm text-gray-500 mt-2 font-medium">ÊúÉË´áÊôÇÈñì</div>
                    </div>

                    <!-- Start/Stop Buttons - Desktop -->
                    <div class="hidden md:grid md:grid-cols-2 gap-4 mb-6">
                        <button id="startBtn" class="btn-touch bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white py-4 px-6 rounded-xl font-bold transition-smooth shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                            <span class="text-xl">‚ñ∂Ô∏è</span>
                            <span>ÈñãÂßãÊúÉË´á</span>
                        </button>
                        <button id="stopBtn" class="btn-touch bg-gradient-to-r from-red-500 to-rose-600 text-white py-4 px-6 rounded-xl font-bold opacity-50 cursor-not-allowed shadow-md flex items-center justify-center gap-2" disabled>
                            <span class="text-xl">‚èπÔ∏è</span>
                            <span>ÁµêÊùüÊúÉË´á</span>
                        </button>
                    </div>

                    <!-- Audio Waveform Animation -->
                    <div id="waveformContainer" class="waveform-container mb-4" style="display: none;">
                        <div class="waveform-bar"></div>
                        <div class="waveform-bar"></div>
                        <div class="waveform-bar"></div>
                        <div class="waveform-bar"></div>
                        <div class="waveform-bar"></div>
                        <div class="waveform-bar"></div>
                        <div class="waveform-bar"></div>
                        <div class="waveform-bar"></div>
                    </div>

                    <!-- Recording Timer Display -->
                    <div id="recordingTimerDisplay" class="text-center mb-6 bg-gradient-to-r from-teal-50 to-cyan-50 rounded-xl p-4 border border-teal-200" style="display: none;">
                        <div class="flex items-center justify-center gap-3">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                                <span class="text-sm font-medium text-gray-700">ÈåÑÈü≥‰∏≠</span>
                            </div>
                            <div class="recording-timer text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-teal-600 to-cyan-600" id="recordingTimerDesktop">00:00</div>
                        </div>
                    </div>

                    <!-- Audio Playback Controls (Demo Mode) -->
                    <div id="audioPlayerSection" class="mb-6 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-4 border border-purple-200" style="display: none;">
                        <div class="flex flex-col gap-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span class="text-lg">üéµ</span>
                                    <span class="text-sm font-bold text-gray-700">Ê®°Êì¨Èü≥Ë®äÊí≠Êîæ</span>
                                </div>
                                <span id="audioStatus" class="text-xs text-purple-600 font-medium">Ê∫ñÂÇô‰∏≠</span>
                            </div>

                            <!-- Audio Progress Bar -->
                            <div class="w-full bg-purple-200 rounded-full h-2 cursor-pointer" id="audioProgressContainer">
                                <div id="audioProgress" class="bg-gradient-to-r from-purple-500 to-indigo-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>

                            <!-- Playback Controls -->
                            <div class="flex items-center justify-between gap-2">
                                <button id="audioPlayBtn" class="btn-touch bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md flex items-center gap-2">
                                    <span id="audioPlayIcon">‚ñ∂Ô∏è</span>
                                    <span id="audioPlayText">Êí≠ÊîæÂ∞çË©±</span>
                                </button>
                                <div class="flex items-center gap-2 text-xs font-mono text-gray-600">
                                    <span id="audioCurrentTime">0:00</span>
                                    <span>/</span>
                                    <span id="audioDuration">0:00</span>
                                </div>
                            </div>

                            <p class="text-xs text-purple-700">
                                üí° Èü≥Ë®äÊí≠ÊîæÊôÇÔºåÈÄêÂ≠óÁ®øÊúÉÂêåÊ≠•È°ØÁ§∫„ÄÇÈªûÊìä„ÄåÂç≥ÊôÇÂàÜÊûê„ÄçÂèØÂàÜÊûêÁï∂ÂâçÂ∑≤È°ØÁ§∫ÁöÑÂ∞çË©±ÂÖßÂÆπ„ÄÇ
                            </p>
                        </div>
                    </div>

                    <!-- Provider Selection Toggle - Desktop -->
                    <div id="aiModelSectionDesktop" class="mb-4">
                        <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-4 border border-purple-200">
                            <div id="aiModelToggleRowDesktop" class="flex items-center justify-between">
                                <label class="text-sm font-bold text-gray-800 flex items-center gap-2">
                                    <span class="text-lg">ü§ñ</span>
                                    <span>AI Ê®°Âûã</span>
                                </label>
                                <div class="flex items-center gap-3">
                                    <span class="text-xs text-gray-600" id="providerDescriptionDesktop">ÈÄüÂ∫¶Âø´ ¬∑ ÊîØÊè¥Âø´Âèñ</span>
                                    <span class="text-sm text-gray-500" id="providerLabelDesktop">Gemini</span>
                                    <button id="providerToggleDesktop" class="relative inline-flex h-7 w-12 items-center rounded-full bg-gray-300 transition-colors focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2">
                                        <span id="providerToggleCircleDesktop" class="inline-block h-5 w-5 transform rounded-full bg-white shadow-lg transition-transform translate-x-1"></span>
                                    </button>
                                    <span id="providerLatencyDesktop" class="text-purple-600 font-mono text-sm hidden"></span>
                                </div>
                            </div>

                            <!-- Codeer Model Selector Desktop (shown only when Codeer is selected) -->
                            <div id="codeerModelSelectorDesktop" class="mt-4 pt-4 border-t border-purple-200 hidden">
                                <label class="text-xs font-semibold text-gray-700 mb-3 block">ÈÅ∏Êìá Codeer Ê®°Âûã <span class="text-gray-500 font-normal">¬∑ ÊâÄÊúâÊ®°ÂûãÂùáÂ∑≤È©óË≠â</span></label>
                                <div class="grid grid-cols-3 gap-3">
                                    <label class="flex flex-col gap-1 p-3 rounded-lg bg-white/70 hover:bg-white cursor-pointer transition-colors border border-purple-100">
                                        <div class="flex items-center gap-2">
                                            <input type="radio" name="codeerModelDesktop" value="gemini-flash" checked class="text-purple-600 focus:ring-purple-500">
                                            <span class="text-xs font-medium">üîÆ Gemini Flash</span>
                                        </div>
                                        <span class="text-xs text-green-600 font-semibold ml-5">Êé®Ëñ¶ ¬∑ ~10.6s</span>
                                    </label>
                                    <label class="flex flex-col gap-1 p-3 rounded-lg bg-white/70 hover:bg-white cursor-pointer transition-colors border border-purple-100">
                                        <div class="flex items-center gap-2">
                                            <input type="radio" name="codeerModelDesktop" value="claude-sonnet" class="text-purple-600 focus:ring-purple-500">
                                            <span class="text-xs font-medium">ü§ñ Claude Sonnet</span>
                                        </div>
                                        <span class="text-xs text-blue-600 ml-5">È´òÂìÅË≥™ ¬∑ ~10.3s</span>
                                    </label>
                                    <label class="flex flex-col gap-1 p-3 rounded-lg bg-white/70 hover:bg-white cursor-pointer transition-colors border border-purple-100">
                                        <div class="flex items-center gap-2">
                                            <input type="radio" name="codeerModelDesktop" value="gpt5-mini" class="text-purple-600 focus:ring-purple-500">
                                            <span class="text-xs font-medium">‚ö° GPT-5 Mini</span>
                                        </div>
                                        <span class="text-xs text-gray-600 ml-5">Á©©ÂÆö ¬∑ ~22.6s</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mode Toggle - Desktop -->
                    <div class="mb-4">
                        <div class="flex items-center justify-between bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-4 border border-purple-200">
                            <label class="text-sm font-bold text-gray-800 flex items-center gap-2">
                                <span class="text-lg">üé§</span>
                                <span id="modeToggleLabelDesktop">ÁúüÂØ¶ÈåÑÈü≥</span>
                            </label>
                            <div class="flex items-center gap-2">
                                <span id="modeHintDesktop" class="text-xs text-gray-600">ÈñãÂïü = ÁúüÂØ¶</span>
                                <button id="modeToggleDesktop" class="relative inline-flex h-7 w-12 items-center rounded-full bg-green-600 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" role="switch" aria-checked="true" title="ÂàáÊèõÁúüÂØ¶ÈåÑÈü≥/DemoÊ®°Âºè">
                                    <span class="inline-block h-5 w-5 transform rounded-full bg-white shadow transition-transform translate-x-6"></span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Counseling Mode Toggle - Desktop -->
                    <div class="mb-4">
                        <div class="bg-gradient-to-r from-orange-50 to-red-50 rounded-xl p-4 border border-orange-200">
                            <label class="text-sm font-bold text-gray-800 flex items-center gap-2 mb-3">
                                <span class="text-lg">üéØ</span>
                                <span>Ë´ÆË©¢Ê®°Âºè</span>
                            </label>
                            <div class="grid grid-cols-2 gap-3">
                                <button id="emergencyModeBtnDesktop" class="px-4 py-3 rounded-lg bg-red-500 text-white font-bold text-sm transition-all hover:bg-red-600 shadow-md hover:shadow-lg">
                                    üö® ÂØ¶Êà∞
                                </button>
                                <button id="practiceModeBtnDesktop" class="px-4 py-3 rounded-lg bg-gray-200 text-gray-700 font-bold text-sm transition-all hover:bg-gray-300">
                                    üéì Á∑¥Áøí
                                </button>
                            </div>
                            <p class="text-xs text-gray-600 mt-3">
                                Á∑äÊÄ•Ôºö1-2 Âè•Â∞àÂÆ∂Âª∫Ë≠∞ÔºàÂæû 200 Âè•‰∏≠ÈÅ∏ÊìáÔºâ<br>
                                Á∑¥ÁøíÔºö3-4 Âè•Â∞àÂÆ∂Âª∫Ë≠∞ÔºàÂæû 200 Âè•‰∏≠ÈÅ∏ÊìáÔºâ
                            </p>
                        </div>
                    </div>

                    <!-- Transcript Testing Shortcuts (Desktop) -->
                    <div class="mb-4">
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-200">
                            <label class="text-sm font-bold text-gray-800 flex items-center gap-2 mb-3">
                                <span class="text-lg">üß™</span>
                                <span>Âø´ÈÄüÊ∏¨Ë©¶</span>
                            </label>
                            <div class="grid grid-cols-3 gap-2 mb-3">
                                <button id="loadGreenBtnDesktop" class="px-3 py-2 rounded-lg bg-green-500 text-white font-bold text-sm transition-all hover:bg-green-600 shadow-md hover:shadow-lg">
                                    üü¢ Á∂†Ááà
                                </button>
                                <button id="loadYellowBtnDesktop" class="px-3 py-2 rounded-lg bg-yellow-500 text-white font-bold text-sm transition-all hover:bg-yellow-600 shadow-md hover:shadow-lg">
                                    üü° ÈªÉÁáà
                                </button>
                                <button id="loadRedBtnDesktop" class="px-3 py-2 rounded-lg bg-red-500 text-white font-bold text-sm transition-all hover:bg-red-600 shadow-md hover:shadow-lg">
                                    üî¥ Á¥ÖÁáà
                                </button>
                            </div>
                            <button id="quickTestAnalyzeBtnDesktop" class="w-full px-4 py-3 rounded-lg bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white font-semibold transition-all mb-3 shadow-md hover:shadow-lg">
                                ‚ö° Á´ãÂç≥ÂàÜÊûê
                            </button>
                            <button id="clearTranscriptBtnDesktop" class="w-full px-3 py-2 rounded-lg bg-gray-200 text-gray-700 font-bold text-sm transition-all hover:bg-gray-300">
                                Ê∏ÖÈô§Â∞çË©±Ë®òÈåÑ
                            </button>
                            <p class="text-xs text-gray-600 mt-3">
                                Âø´ÈÄüËºâÂÖ•Ê∏¨Ë©¶Â∞çË©±ÔºåÁÑ°ÈúÄË™ûÈü≥Ëæ®Ë≠ò
                            </p>
                        </div>
                    </div>

                    <!-- Status Indicator - Enhanced -->
                    <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-4 border border-gray-200">
                        <div class="flex items-center justify-between text-sm mb-2">
                            <span class="font-bold text-gray-700">ÁãÄÊÖãÔºö</span>
                            <span id="status" class="text-gray-600 font-medium">ÂæÖÊ©ü‰∏≠</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="font-bold text-gray-700">‰∏ãÊ¨°ÂàÜÊûêÔºö</span>
                            <span id="nextAnalysis" class="text-gray-600 font-medium">Êú™ÈñãÂßã</span>
                        </div>
                    </div>

                    <!-- Demo Mode Hint - Enhanced (hidden by default) -->
                    <div id="demoModeHintDesktop" class="mt-4 p-3 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl" style="display: none;">
                        <p class="text-xs md:text-sm text-blue-700 leading-relaxed">
                            üí° <strong>Ê∏¨Ë©¶Ê®°Âºè</strong>ÔºöÈªûÊìä‰∏äÊñπ„ÄåÊí≠ÊîæÂ∞çË©±„ÄçÊåâÈàïÔºåÊàñÊåâ <kbd class="bg-blue-200 px-2 py-1 rounded font-mono text-xs">T</kbd> ÈçµÊâãÂãïÊí≠Êîæ‰∏ã‰∏ÄÂè•
                        </p>
                    </div>
                </div>
            </div>

            <!-- Right Panel: AI Analysis Cards -->
            <div class="space-y-4">
                <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 card-hover border border-gray-100">
                <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-3 mb-4">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-lg flex items-center justify-center">
                            <span class="text-white text-lg">ü§ñ</span>
                        </div>
                        <h2 class="text-lg md:text-xl font-bold text-gray-800">AI Âç≥ÊôÇÂàÜÊûê</h2>
                    </div>
                    <div class="hidden md:flex gap-2 flex-wrap">
                        <button id="triggerAnalysisBtn" class="btn-touch bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white px-3 md:px-4 py-2 rounded-lg text-xs md:text-sm font-bold transition-smooth shadow-md opacity-50 cursor-not-allowed flex items-center gap-1" disabled>
                            <span>‚ö°</span>
                            <span>Á´ãÂç≥ÂàÜÊûê</span>
                        </button>
                    </div>
                </div>

                <!-- Analysis Cards Container -->
                <div id="analysisCards" class="space-y-4 max-h-[600px] md:max-h-[800px] overflow-y-auto custom-scrollbar">
                    <!-- Empty State -->
                    <div class="flex flex-col items-center justify-center py-12 text-center" id="analysisEmpty">
                        <div class="w-16 h-16 md:w-20 md:h-20 bg-gradient-to-br from-purple-100 to-indigo-100 rounded-full flex items-center justify-center mb-4">
                            <span class="text-3xl md:text-4xl">üí°</span>
                        </div>
                        <h3 class="text-base md:text-lg font-bold text-gray-800 mb-2">Á≠âÂæÖÂàÜÊûê</h3>
                        <p class="text-gray-600 text-xs md:text-sm max-w-xs">
                            ÈªûÊìä„ÄåÁ´ãÂç≥ÂàÜÊûê„ÄçÊü•Áúã AI Áù£Â∞éÂª∫Ë≠∞
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Transcript Section - Collapsible (Moved to Bottom) -->
        <div class="mt-6 bg-white rounded-xl shadow-lg p-4 md:p-6 card-hover border border-gray-100 hidden md:block">
            <h2 class="text-lg md:text-xl font-bold mb-4 cursor-pointer flex justify-between items-center transition-smooth hover:text-teal-600" onclick="toggleTranscript()">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-gradient-to-br from-teal-500 to-cyan-500 rounded-lg flex items-center justify-center">
                        <span class="text-white text-lg">üìù</span>
                    </div>
                    <span>Âç≥ÊôÇÈÄêÂ≠óÁ®ø</span>
                    <!-- Live Indicator -->
                    <div class="hidden" id="liveIndicator">
                        <span class="flex items-center gap-1 px-2 py-1 bg-red-500 text-white text-xs rounded-full animate-pulse">
                            <span class="w-2 h-2 bg-white rounded-full"></span>
                            <span class="font-bold">LIVE</span>
                        </span>
                    </div>
                </div>
                <span id="transcriptToggle" class="text-gray-400 transition-transform duration-300">‚ñº</span>
            </h2>
            <div id="transcriptSection" class="hidden">
                <!-- Transcript Container - Chat-like -->
                <div id="transcript" class="h-[400px] md:h-[500px] overflow-y-auto bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 md:p-4 custom-scrollbar">
                    <!-- Empty State -->
                    <div class="flex flex-col items-center justify-center h-full text-center" id="transcriptEmpty">
                        <div class="w-16 h-16 md:w-20 md:h-20 bg-gray-200 rounded-full flex items-center justify-center mb-4">
                            <span class="text-3xl md:text-4xl">üí¨</span>
                        </div>
                        <h3 class="text-base md:text-lg font-bold text-gray-800 mb-2">ÈñãÂßãÊñ∞ÊúÉË´á</h3>
                        <p class="text-gray-600 text-xs md:text-sm">ÈªûÊìä„ÄåÈñãÂßãÊúÉË´á„ÄçÔºåÈñãÂßãË®òÈåÑÂ∞çË©±</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Section (Collapsed by default) - Enhanced -->
        <div id="historyContainer" class="mt-6 bg-white rounded-xl shadow-lg p-4 md:p-6 card-hover border border-gray-100">
            <h2 class="text-lg md:text-xl font-bold mb-4 cursor-pointer flex justify-between items-center transition-smooth hover:text-indigo-600" onclick="toggleHistory()">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-gradient-to-br from-gray-500 to-gray-600 rounded-lg flex items-center justify-center">
                        <span class="text-white text-lg">üìä</span>
                    </div>
                    <span>Ê≠∑Âè≤Ë®òÈåÑ</span>
                </div>
                <span id="historyToggle" class="text-gray-400 transition-transform duration-300">‚ñº</span>
            </h2>
            <div id="historySection" class="hidden">
                <button onclick="clearHistory()" class="btn-touch bg-gradient-to-r from-red-500 to-rose-600 hover:from-red-600 hover:to-rose-700 text-white px-4 py-2 rounded-lg mb-4 transition-smooth shadow-md hover:shadow-lg flex items-center gap-2">
                    <span>üóëÔ∏è</span>
                    <span>Ê∏ÖÈô§Ê≠∑Âè≤</span>
                </button>
                <div id="historyList" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <script type="module">
        // === Feature Flags ===
        // Check URL parameter for Codeer feature flag
        const urlParams = new URLSearchParams(window.location.search);
        const SHOW_CODEER = urlParams.get('show_codeer') === 'true';

        if (!SHOW_CODEER) {
            console.log('üîí Codeer models hidden (default). Use ?show_codeer=true to enable.');
        } else {
            console.log('üîì Codeer models enabled via URL parameter');
        }

        // === New Session Workflow Feature Flag ===
        // Set to true to use new modular session workflow (iOS-style)
        // Set to false to use legacy realtime analyze API
        const USE_NEW_SESSION_WORKFLOW = true;
        console.log(`üîß Session Workflow: ${USE_NEW_SESSION_WORKFLOW ? 'NEW (modular)' : 'LEGACY (realtime)'}`);

        // Import SessionWorkflow module dynamically
        let SessionWorkflow = null;
        let sessionWorkflow = null;

        if (USE_NEW_SESSION_WORKFLOW) {
            import('/static/js/session-workflow.js').then(module => {
                SessionWorkflow = module.SessionWorkflow;
                sessionWorkflow = new SessionWorkflow();
                console.log('‚úÖ SessionWorkflow module loaded');
            }).catch(error => {
                console.error('‚ùå Failed to load SessionWorkflow module:', error);
            });
        }

        // === State Management ===
        let isRecording = false;
        let isPaused = false; // NEW: Track pause state
        let pausedTime = 0; // NEW: Track paused duration
        let pauseStartTime = null; // NEW: Track when pause started
        let currentSpeaker = 'counselor';
        let startTime = null;
        let timerInterval = null;
        let analysisInterval = null;
        let transcriptSegments = []; // Only stores DISPLAYED transcript segments
        let lastAutoAnalysisTime = 0; // Track last auto-analysis to prevent duplicates
        let analysisHistory = [];
        let isDemoMode = false; // Default to real recording, toggle switches to demo mode

        // Dynamic analysis interval based on safety_level
        let nextAnalysisInterval = 60; // Default 60 seconds
        let lastSafetyLevel = 'green';
        let lastQuickFeedbackTime = 0; // Track last quick feedback call (every 10 seconds)
        let isVoiceSimEnabled = false; // Voice simulation toggle state (demo mode only)
        let currentProvider = 'gemini'; // 'gemini' or 'codeer' - Force to 'gemini' if Codeer is hidden
        let currentCodeerModel = 'gemini-flash'; // Codeer model selection (default: Gemini 2.5 Flash - fastest + best quality balance)
        let counselingMode = 'emergency'; // 'emergency' or 'practice' - Default to emergency for real-time counseling

        // === ElevenLabs Real-time STT State ===
        let elevenLabsWs = null; // WebSocket connection
        let audioContext = null; // Web Audio API context
        let audioWorkletNode = null; // AudioWorklet for PCM processing
        let audioStream = null; // MediaStream from microphone
        let partialTranscriptText = ''; // Temporary storage for partial transcript
        let elevenlabsToken = null; // Token from backend

        // === Audio Simulation State ===
        let audioSimulation = {
            isPlaying: false,
            currentTime: 0,
            duration: 0,
            lastDisplayedIndex: 0, // Track which script lines have been displayed
            animationFrame: null,
            startTimeMs: 0 // When playback started (performance.now())
        };

        // === Web Speech API (TTS) State ===
        let ttsState = {
            voices: [],
            counselorVoice: null,
            clientVoice: null,
            isSupported: 'speechSynthesis' in window,
            currentUtterance: null
        };

        // === Inactivity Timeout State ===
        let lastActivityTime = Date.now();
        let inactivityCheckInterval = null;
        let countdownInterval = null;

        // === Analysis State ===
        let isAnalyzing = false; // Global flag to prevent concurrent analysis
        let sessionMode = 'practice'; // 'practice' or 'realTalk'
        let currentSessionId = null; // Global session ID for unified tracking

        // === DOM Elements ===
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const practiceBtn = document.getElementById('practiceBtn');
        const realTalkBtn = document.getElementById('realTalkBtn');
        const pauseBtnMobile = document.getElementById('pauseBtnMobile');
        const stopBtnMobile = document.getElementById('stopBtnMobile');
        const timer = document.getElementById('timer');
        const status = document.getElementById('status');
        const nextAnalysis = document.getElementById('nextAnalysis');
        const transcript = document.getElementById('transcript');
        const analysisCards = document.getElementById('analysisCards');
        const speakerCounselorBtn = document.getElementById('speakerCounselor');
        const speakerClientBtn = document.getElementById('speakerClient');
        const speakerToggleSection = document.getElementById('speakerToggleSection');
        const triggerAnalysisBtn = document.getElementById('triggerAnalysisBtn');
        const liveIndicator = document.getElementById('liveIndicator');
        const transcriptEmpty = document.getElementById('transcriptEmpty');
        const analysisEmpty = document.getElementById('analysisEmpty');
        const fabAnalyzeMobile = document.getElementById('fabAnalyzeMobile');
        const waveformContainer = document.getElementById('waveformContainer');
        const waveformContainerMobile = document.getElementById('waveformContainerMobile');
        const recordingTimerDisplay = document.getElementById('recordingTimerDisplay');
        const recordingTimerDisplayMobile = document.getElementById('recordingTimerDisplayMobile');
        const recordingTimer = document.getElementById('recordingTimer'); // Mobile recording UI timer
        const recordingTimerDesktop = document.getElementById('recordingTimerDesktop'); // Desktop recording timer display
        const recordingTimerMobile = document.getElementById('recordingTimerMobile'); // Mobile compact waveform timer
        const modeToggle = document.getElementById('modeToggle');
        const modeToggleDesktop = document.getElementById('modeToggleDesktop');
        const modeToggleLabel = document.getElementById('modeToggleLabel');
        const modeToggleLabelDesktop = document.getElementById('modeToggleLabelDesktop');
        const modeHint = document.getElementById('modeHint');
        const modeHintDesktop = document.getElementById('modeHintDesktop');

        // NEW: Mobile-specific elements for requirements 3, 4, 6
        const mainHeader = document.getElementById('mainHeader');
        const initialUI = document.getElementById('initialUI');
        const practiceIntroUI = document.getElementById('practiceIntroUI');
        const createPracticeBtn = document.getElementById('createPracticeBtn');
        const homeBtn = document.getElementById('homeBtn');
        const backToInitialBtn = document.getElementById('backToInitialBtn');
        const recordingUI = document.getElementById('recordingUI');
        const recordingBottomBar = document.getElementById('recordingBottomBar');
        const mobileCarousel = document.getElementById('mobileCarousel');
        const mobileCarouselTrack = document.getElementById('mobileCarouselTrack');
        const carouselPrev = document.getElementById('carouselPrev');
        const carouselNext = document.getElementById('carouselNext');
        const carouselCounter = document.getElementById('carouselCounter');

        // Completion Screen Elements
        const completionScreen = document.getElementById('completionScreen');
        const sessionDuration = document.getElementById('sessionDuration');
        const viewReportBtn = document.getElementById('viewReportBtn');
        const returnHomeBtn = document.getElementById('returnHomeBtn');

        // Report Screen Elements
        const reportScreen = document.getElementById('reportScreen');
        const reportBackBtn = document.getElementById('reportBackBtn');
        const highlightCards = document.getElementById('highlightCards');

        // Settings Modal Elements
        const settingsBtnMobile = document.getElementById('settingsBtnMobile');
        const settingsModal = document.getElementById('settingsModal');
        const settingsModalBackdrop = document.getElementById('settingsModalBackdrop');
        const settingsModalContent = document.getElementById('settingsModalContent');
        const settingsModalClose = document.getElementById('settingsModalClose');

        // Audio Player Elements
        const audioPlayerSection = document.getElementById('audioPlayerSection');
        const audioPlayBtn = document.getElementById('audioPlayBtn');
        const audioPlayIcon = document.getElementById('audioPlayIcon');
        const audioPlayText = document.getElementById('audioPlayText');
        const audioProgress = document.getElementById('audioProgress');
        const audioProgressContainer = document.getElementById('audioProgressContainer');
        const audioCurrentTime = document.getElementById('audioCurrentTime');
        const audioDuration = document.getElementById('audioDuration');
        const audioStatus = document.getElementById('audioStatus');

        // Carousel state
        let mobileAnalysisCards = [];
        let currentCarouselIndex = 0;

        // === Counseling Mode Setup (must be before event listeners) ===
        const emergencyModeBtn = document.getElementById('emergencyModeBtn');
        const practiceModeBtn = document.getElementById('practiceModeBtn');
        const emergencyModeBtnDesktop = document.getElementById('emergencyModeBtnDesktop');
        const practiceModeBtnDesktop = document.getElementById('practiceModeBtnDesktop');

        function setCounselingMode(mode) {
            counselingMode = mode;

            // Update mobile button styles with consistent hover effects
            if (emergencyModeBtn && practiceModeBtn) {
                if (mode === 'emergency') {
                    emergencyModeBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                    emergencyModeBtn.classList.add('bg-red-500', 'text-white', 'hover:bg-red-600');
                    practiceModeBtn.classList.remove('bg-green-500', 'text-white', 'hover:bg-green-600');
                    practiceModeBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                } else {
                    practiceModeBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                    practiceModeBtn.classList.add('bg-green-500', 'text-white', 'hover:bg-green-600');
                    emergencyModeBtn.classList.remove('bg-red-500', 'text-white', 'hover:bg-red-600');
                    emergencyModeBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                }
            }

            // Update desktop button styles
            if (emergencyModeBtnDesktop && practiceModeBtnDesktop) {
                if (mode === 'emergency') {
                    emergencyModeBtnDesktop.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                    emergencyModeBtnDesktop.classList.add('bg-red-500', 'text-white', 'hover:bg-red-600');
                    practiceModeBtnDesktop.classList.remove('bg-green-500', 'text-white', 'hover:bg-green-600');
                    practiceModeBtnDesktop.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                } else {
                    practiceModeBtnDesktop.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                    practiceModeBtnDesktop.classList.add('bg-green-500', 'text-white', 'hover:bg-green-600');
                    emergencyModeBtnDesktop.classList.remove('bg-red-500', 'text-white', 'hover:bg-red-600');
                    emergencyModeBtnDesktop.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                }
            }

            console.log(`‚úÖ ÂàáÊèõË´ÆË©¢Ê®°Âºè: ${mode}`);
        }

        // === Event Listeners ===
        startBtn.addEventListener('click', startSession);
        stopBtn.addEventListener('click', stopSession);

        // Mobile flow: Practice button shows intro screen
        if (practiceBtn) {
            practiceBtn.addEventListener('click', () => {
                sessionMode = 'practice';
                // Sync consultation mode to 'practice'
                setCounselingMode('practice');
                if (initialUI) initialUI.classList.add('hidden');
                if (practiceIntroUI) practiceIntroUI.classList.remove('hidden');
                // Update button text for practice mode
                if (createPracticeBtn) {
                    createPracticeBtn.textContent = 'ÂâµÂª∫Á∑¥Áøí';
                }
            });
        }

        // Mobile flow: Real talk button shows intro screen
        if (realTalkBtn) {
            realTalkBtn.addEventListener('click', () => {
                sessionMode = 'realTalk';
                // Sync consultation mode to 'emergency' (ÂØ¶Êà∞)
                setCounselingMode('emergency');
                if (initialUI) initialUI.classList.add('hidden');
                if (practiceIntroUI) practiceIntroUI.classList.remove('hidden');
                // Update button text for real talk mode
                if (createPracticeBtn) {
                    createPracticeBtn.textContent = 'ÈñãÂßãÂ∞çË©±';
                }
            });
        }

        // Mobile flow: Create practice/real talk button starts recording
        if (createPracticeBtn) {
            createPracticeBtn.addEventListener('click', () => {
                if (practiceIntroUI) practiceIntroUI.classList.add('hidden');
                startSession();
            });
        }

        // Navigation buttons for Practice Intro UI
        if (homeBtn) {
            homeBtn.addEventListener('click', () => {
                location.reload();
            });
        }

        if (backToInitialBtn) {
            backToInitialBtn.addEventListener('click', () => {
                if (practiceIntroUI) practiceIntroUI.classList.add('hidden');
                if (initialUI) initialUI.classList.remove('hidden');
            });
        }

        if (pauseBtnMobile) pauseBtnMobile.addEventListener('click', togglePause);
        if (stopBtnMobile) stopBtnMobile.addEventListener('click', stopSession);
        // Speaker buttons removed (AI auto-detects speakers)
        triggerAnalysisBtn.addEventListener('click', manuallyTriggerAnalysis);
        if (fabAnalyzeMobile) fabAnalyzeMobile.addEventListener('click', manuallyTriggerAnalysis);

        // NEW: Carousel navigation
        if (carouselPrev) carouselPrev.addEventListener('click', () => navigateCarousel(-1));
        if (carouselNext) carouselNext.addEventListener('click', () => navigateCarousel(1));

        // Completion Screen Buttons
        if (viewReportBtn) {
            viewReportBtn.addEventListener('click', async () => {
                console.log('üîò Êü•ÁúãÂ†±ÂëäÊåâÈàïË¢´ÈªûÊìä‰∫ÜÔºÅ');

                // Show loading overlay
                const loadingOverlay = document.getElementById('reportLoadingOverlay');
                console.log('üì¶ Loading overlay element:', loadingOverlay);

                if (loadingOverlay) {
                    loadingOverlay.classList.remove('hidden');
                    loadingOverlay.style.display = 'flex';  // Force flex display
                    loadingOverlay.style.position = 'fixed';
                    loadingOverlay.style.inset = '0';
                    loadingOverlay.style.zIndex = '9999';
                    loadingOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                    loadingOverlay.style.alignItems = 'center';
                    loadingOverlay.style.justifyContent = 'center';
                    console.log('‚úÖ Loading overlay È°ØÁ§∫ÊàêÂäü with forced styles');
                } else {
                    console.error('‚ùå Êâæ‰∏çÂà∞ loading overlay element!');
                }

                // Disable all buttons
                viewReportBtn.disabled = true;
                if (returnHomeBtn) returnHomeBtn.disabled = true;
                console.log('üîí ÊåâÈàïÂ∑≤Á¶ÅÁî®');

                // Change button text to "ÁîüÊàêÂ†±Âëä‰∏≠..." with bouncing dots
                viewReportBtn.innerHTML = 'ÁîüÊàêÂ†±Âëä‰∏≠<span class="loading-dot">.</span><span class="loading-dot">.</span><span class="loading-dot">.</span>';
                console.log('üìù ÊåâÈàïÊñáÂ≠óÂ∑≤ËÆäÊõ¥ÁÇ∫„ÄåÁîüÊàêÂ†±Âëä‰∏≠...„Äç');

                try {
                    // Call new parents-report API
                    const fullTranscript = transcriptSegments.map(seg =>
                        `${seg.speaker === 'counselor' ? 'ÂÆ∂Èï∑' : 'Â≠©Â≠ê'}Ôºö${seg.text}`
                    ).join('\n');

                    const response = await fetch('/api/v1/realtime/parents-report', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            transcript: fullTranscript,
                            session_id: currentSessionId  // Use unified session ID
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }

                    const reportData = await response.json();
                    console.log('üìä Parents report generated:', reportData);

                    // Hide loading overlay
                    if (loadingOverlay) {
                        loadingOverlay.classList.add('hidden');
                        loadingOverlay.style.display = 'none';  // Force hide
                    }

                    // Hide completion screen
                    if (completionScreen) completionScreen.classList.add('hidden');

                    // Populate report with real API data
                    populateReportFromAPI(reportData);

                    // Show report screen
                    if (reportScreen) reportScreen.classList.remove('hidden');

                } catch (error) {
                    console.error('Failed to generate report:', error);

                    // Hide loading overlay
                    if (loadingOverlay) {
                        loadingOverlay.classList.add('hidden');
                        loadingOverlay.style.display = 'none';  // Force hide
                    }

                    showModal('Â†±ÂëäÁîüÊàêÂ§±Êïó', 'Ë´ãÁ®çÂæåÂÜçË©¶', 'error');
                } finally {
                    // Reset button text back to "Êü•ÁúãÂ†±Âëä"
                    viewReportBtn.innerHTML = 'Êü•ÁúãÂ†±Âëä';
                    // Re-enable buttons
                    viewReportBtn.disabled = false;
                    if (returnHomeBtn) returnHomeBtn.disabled = false;
                }
            });
        }

        // Report Screen Back Button
        if (reportBackBtn) {
            reportBackBtn.addEventListener('click', () => {
                // Hide report screen
                if (reportScreen) reportScreen.classList.add('hidden');

                // Show completion screen
                if (completionScreen) completionScreen.classList.remove('hidden');
            });
        }

        if (returnHomeBtn) {
            returnHomeBtn.addEventListener('click', () => {
                location.reload();
            });
        }

        // Settings Modal Control
        if (settingsBtnMobile) {
            settingsBtnMobile.addEventListener('click', openSettingsModal);
        }
        if (settingsModalBackdrop) {
            settingsModalBackdrop.addEventListener('click', closeSettingsModal);
        }
        if (settingsModalClose) {
            settingsModalClose.addEventListener('click', closeSettingsModal);
        }

        // Mode Toggle (Demo/Real)
        modeToggle.addEventListener('click', toggleRecordingMode);
        if (modeToggleDesktop) modeToggleDesktop.addEventListener('click', toggleRecordingMode);

        // Counseling Mode Toggle event listeners (Emergency/Practice)
        // (Function definition and DOM elements are above, before all event listeners)
        if (emergencyModeBtn) emergencyModeBtn.addEventListener('click', () => setCounselingMode('emergency'));
        if (practiceModeBtn) practiceModeBtn.addEventListener('click', () => setCounselingMode('practice'));
        if (emergencyModeBtnDesktop) emergencyModeBtnDesktop.addEventListener('click', () => setCounselingMode('emergency'));
        if (practiceModeBtnDesktop) practiceModeBtnDesktop.addEventListener('click', () => setCounselingMode('practice'));

        // === Preset Transcript Testing Shortcuts ===
        // Preset transcripts based on test_10min_realtime_simulation.py
        const PRESET_TRANSCRIPTS = {
            green: [
                { speaker: 'counselor', text: 'ÂØ∂Ë≤ùÔºå‰ªäÂ§©Âú®Â≠∏Ê†°ÊÄéÈ∫ºÊ®£Ôºü', time: 0 },
                { speaker: 'client', text: 'ÈÇÑÂ•ΩÂï¶„ÄÇ', time: 3 },
                { speaker: 'counselor', text: 'ËÄÅÂ∏´ÊúâË™™‰ªÄÈ∫ºÂóéÔºü', time: 5 },
                { speaker: 'client', text: 'Ê≤íÊúâÁâπÂà•Ë™™‰ªÄÈ∫º„ÄÇ', time: 8 },
                { speaker: 'counselor', text: 'ÈÇ£Êï∏Â≠∏ËÄÉË©¶ÊÄéÈ∫ºÊ®£Ôºü', time: 11 },
                { speaker: 'client', text: 'ÈÇÑÊ≤íÁôº‰∏ã‰æÜ„ÄÇ', time: 14 },
                { speaker: 'counselor', text: 'ÂñîÔºåÈÇ£Á≠âÁôº‰∏ã‰æÜË∑üÂ™ΩÂ™ΩË™™‰∏ÄËÅ≤„ÄÇ', time: 17 },
                { speaker: 'client', text: 'Â•Ω„ÄÇ', time: 20 }
            ],
            yellow: [
                { speaker: 'counselor', text: 'Âí¶ÔºåÈÄôÊòØ‰ªÄÈ∫ºÔºüÊï∏Â≠∏ËÄÉÂç∑ÂóéÔºü', time: 0 },
                { speaker: 'client', text: 'ÂïäÈÇ£ÂÄã', time: 3 },
                { speaker: 'counselor', text: '65ÂàÜÔºü‰Ω†Ê∞£Ê≠ªÊàë‰∫ÜÔºÅ‰∏äÊ¨°‰∏çÊòØËÄÉ85ÂàÜÂóéÔºü', time: 5 },
                { speaker: 'client', text: 'ÈÄôÊ¨°ÊØîËºÉÈõ£Âï¶', time: 9 },
                { speaker: 'counselor', text: '‰Ω†ÁÖ©Ê≠ªÊàë‰∫ÜÔºÅÂèà‰∏ÄÁõ¥Áé©ÊâãÊ©ü‰∏çËÅΩË©±', time: 12 },
                { speaker: 'client', text: 'ÊàëÊúâË™çÁúüËÆÄÂïä', time: 16 },
                { speaker: 'counselor', text: '‰Ω†Ë™™Ë¨äÔºÅÊàëÂèóÂ§†‰∫ÜÔºÅÊØèÊ¨°ÈÉΩÈÄôÊ®£', time: 19 },
                { speaker: 'client', text: 'ÊàëÂø´Â¥©ÊΩ∞‰∫ÜÔºÅÁÇ∫‰ªÄÈ∫º‰Ω†ÈÉΩ‰∏çÁõ∏‰ø°ÊàëÔºÅ', time: 24 }
            ],
            red: [
                { speaker: 'counselor', text: '‰Ω†Áµ¶ÊàëÊªæÂá∫ÂéªÔºÅÈÄôÊòØ‰ªÄÈ∫ºÊàêÁ∏æÔºü', time: 0 },
                { speaker: 'client', text: 'Êàë...', time: 3 },
                { speaker: 'counselor', text: '50ÂàÜÔºÅÊâìÊ≠ª‰Ω†ÁÆó‰∫ÜÔºÅ‰Ω†ÈÇÑÊÉ≥‰∏çÊÉ≥ËÆÄÊõ∏Ôºü', time: 5 },
                { speaker: 'client', text: 'ÊàëÂèó‰∏ç‰∫Ü‰∫Ü...', time: 10 },
                { speaker: 'counselor', text: 'Âèó‰∏ç‰∫ÜÔºüÊàëÊâçÂèó‰∏ç‰∫Ü‰Ω†ÈÄôÊ®£ÔºÅ', time: 13 },
                { speaker: 'client', text: 'Êàë‰∏çÊÉ≥Ê¥ª‰∫Ü', time: 18 },
                { speaker: 'counselor', text: '‰Ω†Ë™™‰ªÄÈ∫ºÔºü‰∏çÊÉ≥Ê¥ªÔºü‰Ω†Áü•ÈÅì‰Ω†Âú®Ë™™‰ªÄÈ∫ºÂóéÔºü', time: 21 },
                { speaker: 'client', text: 'ÊàëÁúüÁöÑ‰∏çÊÉ≥Ê¥ª‰∫Ü...', time: 27 },
                { speaker: 'counselor', text: '‰Ω†ÈÄôÊ®£Ë™™ÊàëÊÅ®Ê≠ª‰Ω†‰∫ÜÔºÅ', time: 32 }
            ]
        };

        // Function to load preset transcript
        function loadPresetTranscript(safetyLevel) {
            const preset = PRESET_TRANSCRIPTS[safetyLevel];
            if (!preset) {
                console.error(`Unknown safety level: ${safetyLevel}`);
                return;
            }

            console.log(`üß™ Loading ${safetyLevel.toUpperCase()} preset transcript (${preset.length} segments)`);

            // Clear existing transcript
            clearTranscript();

            // Load preset segments
            preset.forEach(segment => {
                addTranscriptLine(segment.speaker, segment.text);
            });

            console.log(`‚úÖ Loaded ${preset.length} transcript segments`);
        }

        // Function to clear transcript
        function clearTranscript() {
            transcriptSegments = [];
            const transcript = document.getElementById('transcript');
            if (transcript) {
                // Keep only the header
                const header = transcript.querySelector('.text-xs.text-gray-500.mb-3');
                transcript.innerHTML = '';
                if (header) {
                    transcript.appendChild(header);
                }
            }

            console.log('üóëÔ∏è Transcript cleared');
        }

        // Event listeners for mobile shortcut buttons
        const loadGreenBtn = document.getElementById('loadGreenBtn');
        const loadYellowBtn = document.getElementById('loadYellowBtn');
        const loadRedBtn = document.getElementById('loadRedBtn');
        const quickTestAnalyzeBtn = document.getElementById('quickTestAnalyzeBtn');
        const quickTestAnalyzeBtnDesktop = document.getElementById('quickTestAnalyzeBtnDesktop');
        const clearTranscriptBtn = document.getElementById('clearTranscriptBtn');

        if (loadGreenBtn) loadGreenBtn.addEventListener('click', () => loadPresetTranscript('green'));
        if (loadYellowBtn) loadYellowBtn.addEventListener('click', () => loadPresetTranscript('yellow'));
        if (loadRedBtn) loadRedBtn.addEventListener('click', () => loadPresetTranscript('red'));
        if (quickTestAnalyzeBtn) quickTestAnalyzeBtn.addEventListener('click', analyzeTranscript);
        if (clearTranscriptBtn) clearTranscriptBtn.addEventListener('click', clearTranscript);

        // Event listeners for desktop shortcut buttons
        const loadGreenBtnDesktop = document.getElementById('loadGreenBtnDesktop');
        const loadYellowBtnDesktop = document.getElementById('loadYellowBtnDesktop');
        const loadRedBtnDesktop = document.getElementById('loadRedBtnDesktop');
        const clearTranscriptBtnDesktop = document.getElementById('clearTranscriptBtnDesktop');

        if (loadGreenBtnDesktop) loadGreenBtnDesktop.addEventListener('click', () => loadPresetTranscript('green'));
        if (loadYellowBtnDesktop) loadYellowBtnDesktop.addEventListener('click', () => loadPresetTranscript('yellow'));
        if (loadRedBtnDesktop) loadRedBtnDesktop.addEventListener('click', () => loadPresetTranscript('red'));
        if (quickTestAnalyzeBtnDesktop) quickTestAnalyzeBtnDesktop.addEventListener('click', analyzeTranscript);
        if (clearTranscriptBtnDesktop) clearTranscriptBtnDesktop.addEventListener('click', clearTranscript);

        // Audio Player Controls
        if (audioPlayBtn) audioPlayBtn.addEventListener('click', toggleAudioPlayback);
        if (audioProgressContainer) {
            audioProgressContainer.addEventListener('click', (e) => {
                const rect = audioProgressContainer.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const percentage = clickX / rect.width;
                seekAudio(percentage);
            });
        }

        // === Initialization ===
        // Initialize Web Speech API (TTS)
        initializeSpeechSynthesis();

        // Initialize provider toggle
        setupProviderToggle();
        setupCodeerModelSelector();
        updateProviderUI();

        // Hide Codeer-related UI if feature flag is not set
        if (!SHOW_CODEER) {
            // Hide mobile AI model toggle (Gemini/Codeer buttons)
            const aiModelToggleMobile = document.getElementById('aiModelToggleRowMobile');
            if (aiModelToggleMobile) {
                aiModelToggleMobile.style.display = 'none';
            }

            // Hide mobile Codeer sub-model selector
            const codeerModelSelectorMobile = document.getElementById('codeerModelSelector');
            if (codeerModelSelectorMobile) {
                codeerModelSelectorMobile.style.display = 'none';
            }

            // Hide desktop AI model toggle (Gemini/Codeer buttons)
            const aiModelToggleDesktop = document.getElementById('aiModelToggleRowDesktop');
            if (aiModelToggleDesktop) {
                aiModelToggleDesktop.style.display = 'none';
            }

            // Hide desktop Codeer sub-model selector
            const codeerModelSelectorDesktop = document.getElementById('codeerModelSelectorDesktop');
            if (codeerModelSelectorDesktop) {
                codeerModelSelectorDesktop.style.display = 'none';
            }

            // Force provider to Gemini
            currentProvider = 'gemini';

            console.log('‚úÖ Codeer UI elements hidden. Provider locked to Gemini.');
        }

        // === ElevenLabs Real-time STT Functions ===

        /**
         * Start real recording with ElevenLabs WebSocket + MediaRecorder
         */
        async function startRealRecording() {
            // Step 1: Get single-use token from backend
            console.log('üìû ÂëºÂè´ÂæåÁ´ØÂèñÂæó ElevenLabs token...');
            const tokenResponse = await fetch('/api/v1/realtime/elevenlabs-token', {
                method: 'POST'
            });

            if (!tokenResponse.ok) {
                throw new Error(`Token ÁîüÊàêÂ§±Êïó: ${tokenResponse.status}`);
            }

            const { token } = await tokenResponse.json();
            elevenlabsToken = token;
            console.log('‚úÖ Token ÂèñÂæóÊàêÂäü');

            // Step 2: Request microphone access
            try {
                audioStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        channelCount: 1,
                        sampleRate: 16000, // 16kHz for speech (ElevenLabs supports 8-48kHz)
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                console.log('‚úÖ Microphone access granted');
            } catch (error) {
                throw new Error(`È∫•ÂÖãÈ¢®Â≠òÂèñÂ§±Êïó: ${error.message}`);
            }

            // Step 3: Establish WebSocket connection to ElevenLabs
            // All configuration goes in query parameters, not as JSON message
            // Use "token" parameter (browsers can't set custom headers in WebSocket)
            const wsUrl = `wss://api.elevenlabs.io/v1/speech-to-text/realtime?` +
                `token=${elevenlabsToken}` +
                `&audio_format=pcm_16000` +
                `&language=zh` +  // Chinese (same as test page)
                `&commit_strategy=vad`;  // Auto-commit with Voice Activity Detection

            console.log('üîå Connecting to ElevenLabs WebSocket...');
            elevenLabsWs = new WebSocket(wsUrl);

            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    reject(new Error('WebSocket ÈÄ£Á∑öË∂ÖÊôÇ'));
                }, 10000); // 10 second timeout

                elevenLabsWs.onopen = () => {
                    clearTimeout(timeout);
                    console.log('‚úÖ ElevenLabs WebSocket connected');
                    console.log('‚è≥ Waiting for session_started message...');

                    // No need to send config - it's all in the URL query parameters
                    // Wait for session_started confirmation before starting audio

                    // Step 3: Start AudioContext to capture PCM audio
                    startAudioCapture();

                    // Start inactivity monitoring
                    startInactivityMonitoring();
                    resetInactivityTimer();

                    resolve();
                };

                elevenLabsWs.onmessage = (event) => {
                    handleElevenLabsMessage(event.data);
                };

                elevenLabsWs.onerror = (error) => {
                    clearTimeout(timeout);
                    console.error('‚ùå WebSocket error:', error);
                    reject(new Error('WebSocket ÈÄ£Á∑öÈåØË™§'));
                };

                elevenLabsWs.onclose = (event) => {
                    console.log('üîå WebSocket closed:', event.code, event.reason);
                    if (!event.wasClean) {
                        console.warn('‚ö†Ô∏è WebSocket closed unexpectedly');
                    }
                };
            });
        }

        /**
         * Start AudioContext to capture and stream PCM audio
         */
        function startAudioCapture() {
            // Create AudioContext with 16kHz sample rate (ElevenLabs requirement)
            audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
            const source = audioContext.createMediaStreamSource(audioStream);

            // Create ScriptProcessorNode for audio processing (4096 buffer size)
            const bufferSize = 4096;
            const processor = audioContext.createScriptProcessor(bufferSize, 1, 1);

            processor.onaudioprocess = (e) => {
                // Don't send audio if paused
                if (isPaused) return;

                if (elevenLabsWs && elevenLabsWs.readyState === WebSocket.OPEN) {
                    // Get PCM float32 audio data
                    const inputData = e.inputBuffer.getChannelData(0);

                    // Calculate RMS (Root Mean Square) to detect if there's actual audio
                    const rms = Math.sqrt(inputData.reduce((sum, val) => sum + val * val, 0) / inputData.length);
                    if (rms > 0.01) {  // Only log if there's actual audio signal
                        console.log('üéµ Audio chunk captured - RMS:', rms.toFixed(4), 'samples:', inputData.length);
                    }

                    // Convert Float32 to Int16 (PCM S16LE)
                    const pcmData = new Int16Array(inputData.length);
                    for (let i = 0; i < inputData.length; i++) {
                        // Clamp to [-1, 1] and convert to 16-bit
                        const s = Math.max(-1, Math.min(1, inputData[i]));
                        pcmData[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                    }

                    // Convert to Base64
                    const base64Audio = arrayBufferToBase64(pcmData.buffer);

                    // Send to ElevenLabs (correct JSON format)
                    const message = {
                        message_type: 'input_audio_chunk',
                        audio_base_64: base64Audio,
                        commit: false,  // Auto-commit handled by VAD
                        sample_rate: 16000
                    };
                    elevenLabsWs.send(JSON.stringify(message));

                    // Log that chunk was sent
                    if (rms > 0.01) {
                        console.log('üì§ Audio chunk sent to ElevenLabs - size:', base64Audio.length, 'chars');
                    }
                }
            };

            // Connect audio graph: source -> processor -> destination
            source.connect(processor);
            processor.connect(audioContext.destination);

            console.log('‚úÖ AudioContext started (PCM 16kHz streaming)');
        }

        /**
         * Convert ArrayBuffer to Base64
         */
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        /**
         * Handle messages from ElevenLabs WebSocket
         */
        function handleElevenLabsMessage(data) {
            try {
                const message = JSON.parse(data);

                // Debug: Log raw message to understand ElevenLabs response format
                console.log('üì® ElevenLabs raw message:', JSON.stringify(message, null, 2));
                console.log('üì® Message type:', message.message_type);
                console.log('üì® Message keys:', Object.keys(message));

                switch (message.message_type) {
                    case 'session_started':
                        console.log('‚úÖ ElevenLabs session started:', message);
                        break;

                    case 'partial_transcript':
                        // Real-time transcription (not yet finalized)
                        if (message.text) {
                            partialTranscriptText = message.text;
                            updatePartialTranscriptUI(message.text);
                            console.log('üìù Partial:', message.text);
                            resetInactivityTimer(); // Reset timer on any transcript activity
                        }
                        break;

                    case 'committed_transcript':
                        // Finalized transcription - add to chat
                        if (message.text && message.text.trim()) {
                            // Clear partial transcript UI
                            clearPartialTranscriptUI();

                            // Add to transcript with current speaker
                            addTranscriptLine(currentSpeaker, message.text.trim());
                            console.log('‚úÖ Committed:', message.text);

                            // Reset partial text
                            partialTranscriptText = '';

                            // Reset inactivity timer on committed transcript
                            resetInactivityTimer();
                        }
                        break;

                    case 'committed_transcript_with_timestamps':
                        // Finalized transcription with word-level timestamps
                        if (message.text && message.text.trim()) {
                            clearPartialTranscriptUI();
                            addTranscriptLine(currentSpeaker, message.text.trim());
                            console.log('‚úÖ Committed (with timestamps):', message.text);

                            // You can use message.words for word-level timing if needed
                            if (message.words) {
                                console.log('‚è±Ô∏è Word timestamps:', message.words);
                            }

                            partialTranscriptText = '';

                            // Reset inactivity timer on committed transcript
                            resetInactivityTimer();
                        }
                        break;

                    case 'error':
                        console.error('‚ùå ElevenLabs error:', message);
                        showModal('Ë™ûÈü≥Ëæ®Ë≠òÈåØË™§', message.message || message.error || 'Êú™Áü•ÈåØË™§', 'error');
                        break;

                    default:
                        console.log('‚ÑπÔ∏è Unknown message type:', message.message_type);
                }
            } catch (error) {
                console.error('‚ùå Failed to parse WebSocket message:', error);
            }
        }

        /**
         * Update UI with partial (in-progress) transcript
         */
        function updatePartialTranscriptUI(text) {
            // Check if partial transcript bubble already exists
            let partialBubble = document.getElementById('partial-transcript-bubble');

            if (!partialBubble) {
                // Create new partial transcript bubble
                const messageDiv = document.createElement('div');
                messageDiv.id = 'partial-transcript-container';
                messageDiv.className = `flex items-start gap-2 mb-3 fade-in ${currentSpeaker === 'client' ? 'flex-row-reverse' : ''}`;

                const avatarDiv = document.createElement('div');
                avatarDiv.className = `w-8 h-8 ${currentSpeaker === 'counselor' ? 'bg-blue-500' : 'bg-green-500'} rounded-full flex items-center justify-center flex-shrink-0 shadow-md opacity-60`;
                avatarDiv.innerHTML = `<span class="text-white text-sm">${currentSpeaker === 'counselor' ? 'üë®‚Äç‚öïÔ∏è' : 'üßë'}</span>`;

                const bubbleWrapper = document.createElement('div');
                bubbleWrapper.className = `flex-1 flex flex-col ${currentSpeaker === 'client' ? 'items-end' : 'items-start'}`;

                const bubble = document.createElement('div');
                bubble.id = 'partial-transcript-bubble';
                bubble.className = `chat-bubble ${currentSpeaker === 'counselor' ? 'bg-blue-100 rounded-2xl rounded-tl-none' : 'bg-green-100 rounded-2xl rounded-tr-none'} px-4 py-2 shadow-sm border-2 border-dashed ${currentSpeaker === 'counselor' ? 'border-blue-300' : 'border-green-300'} opacity-75`;
                bubble.innerHTML = `<p class="text-sm text-gray-700 leading-relaxed italic">${text}</p>`;

                bubbleWrapper.appendChild(bubble);
                messageDiv.appendChild(avatarDiv);
                messageDiv.appendChild(bubbleWrapper);

                transcript.appendChild(messageDiv);
            } else {
                // Update existing partial transcript
                partialBubble.querySelector('p').textContent = text;
            }

            // Auto-scroll to bottom
            transcript.scrollTop = transcript.scrollHeight;
        }

        /**
         * Clear partial transcript UI when committed
         */
        function clearPartialTranscriptUI() {
            const partialContainer = document.getElementById('partial-transcript-container');
            if (partialContainer) {
                partialContainer.remove();
            }
        }

        /**
         * Reset inactivity timer when user is active
         */
        function resetInactivityTimer() {
            lastActivityTime = Date.now();
            console.log('‚è∞ Inactivity timer reset');
        }

        /**
         * Start monitoring for inactivity (check every 10 seconds)
         */
        function startInactivityMonitoring() {
            console.log('üîç Starting inactivity monitoring');
            inactivityCheckInterval = setInterval(() => {
                const inactiveTime = Date.now() - lastActivityTime;
                const inactiveSeconds = Math.floor(inactiveTime / 1000);

                // Check if inactive for more than 60 seconds
                if (inactiveTime > 60000 && !document.getElementById('inactivityModal')) {
                    console.warn(`‚ö†Ô∏è User inactive for ${inactiveSeconds} seconds, showing warning`);
                    showInactivityWarning();
                }
            }, 10000); // Check every 10 seconds
        }

        /**
         * Stop inactivity monitoring and cleanup
         */
        function stopInactivityMonitoring() {
            console.log('üõë Stopping inactivity monitoring');
            if (inactivityCheckInterval) {
                clearInterval(inactivityCheckInterval);
                inactivityCheckInterval = null;
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            // Remove modal if exists
            const modal = document.getElementById('inactivityModal');
            if (modal) {
                modal.remove();
            }
        }

        /**
         * Show inactivity warning modal with 10-second countdown
         */
        function showInactivityWarning() {
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'inactivityModal';
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-8 max-w-md mx-4 text-center shadow-2xl">
                        <h2 class="text-2xl font-bold mb-4 text-gray-800">ÈÇÑÂú®ÂóéÔºü</h2>
                        <p class="mb-4 text-gray-600">Â∑≤Á∂ì 1 ÂàÜÈêòÊ≤íÊúâÂ∞çË©±‰∫ÜÔºåÊòØÂê¶Ë¶ÅÁπºÁ∫åÔºü</p>
                        <p class="text-red-500 font-bold mb-6 text-lg">
                            Â∞áÂú® <span id="countdownSeconds" class="text-2xl">10</span> ÁßíÂæåËá™ÂãïÁµêÊùü
                        </p>
                        <div class="flex gap-4">
                            <button onclick="continueSession()"
                                class="flex-1 bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors font-semibold">
                                ÁπºÁ∫åÂ∞çË©±
                            </button>
                            <button onclick="endSessionFromModal()"
                                class="flex-1 bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition-colors font-semibold">
                                ÁµêÊùüÂ∞çË©±
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Start 10-second countdown
            let secondsLeft = 10;
            countdownInterval = setInterval(() => {
                secondsLeft--;
                const countdownEl = document.getElementById('countdownSeconds');
                if (countdownEl) {
                    countdownEl.textContent = secondsLeft;
                }

                // Auto-end if countdown reaches 0
                if (secondsLeft <= 0) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    console.log('‚è±Ô∏è Countdown reached 0, auto-ending session');
                    endSessionFromModal();
                }
            }, 1000);
        }

        /**
         * User chose to continue session
         */
        function continueSession() {
            console.log('‚úÖ User chose to continue session');
            const modal = document.getElementById('inactivityModal');
            if (modal) {
                modal.remove();
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            resetInactivityTimer();
        }

        /**
         * User chose to end session or countdown expired
         */
        function endSessionFromModal() {
            console.log('üõë Ending session from inactivity modal');
            const modal = document.getElementById('inactivityModal');
            if (modal) {
                modal.remove();
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            stopSession();
        }

        /**
         * Stop real recording and cleanup resources
         */
        function stopRealRecording() {
            // Stop AudioContext
            if (audioContext) {
                audioContext.close();
                audioContext = null;
                console.log('‚èπÔ∏è AudioContext stopped');
            }

            // Stop audio stream
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
                audioStream = null;
                console.log('üé§ Microphone released');
            }

            // Close WebSocket
            if (elevenLabsWs && elevenLabsWs.readyState === WebSocket.OPEN) {
                elevenLabsWs.close();
                elevenLabsWs = null;
                console.log('üîå WebSocket closed');
            }

            // Clear partial transcript
            clearPartialTranscriptUI();
            partialTranscriptText = '';
        }

        /**
         * Convert Blob to Base64
         */
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // === Settings Modal Functions ===
        function openSettingsModal() {
            if (!settingsModal) return;

            // Show modal
            settingsModal.classList.remove('hidden');

            // Prevent body scroll
            document.body.style.overflow = 'hidden';

            // Trigger animation (slide up from bottom)
            requestAnimationFrame(() => {
                settingsModalContent.style.transform = 'translateY(0)';
                settingsModalBackdrop.style.opacity = '1';
            });

            console.log('‚öôÔ∏è Settings modal opened');
        }

        function closeSettingsModal() {
            if (!settingsModal) return;

            // Trigger animation (slide down)
            settingsModalContent.style.transform = 'translateY(100%)';
            settingsModalBackdrop.style.opacity = '0';

            // Hide modal after animation
            setTimeout(() => {
                settingsModal.classList.add('hidden');
                document.body.style.overflow = '';
            }, 300);

            console.log('‚öôÔ∏è Settings modal closed');
        }

        // === Core Functions ===
        async function startSession() {
            // Generate unique session ID
            const sessionId = `session-${Date.now()}-${Math.random().toString(36).substring(7)}`;
            currentSessionId = sessionId;
            localStorage.setItem('currentSessionId', sessionId);
            console.log(`üéØ Session ID: ${sessionId}`);

            console.log(`üéØ Session mode: ${sessionMode}`);
            isRecording = true;
            isPaused = false; // Reset pause state
            pausedTime = 0; // Reset paused duration
            pauseStartTime = null; // Reset pause start time
            startTime = Date.now();
            transcriptSegments = [];
            analysisHistory = [];
            lastQuickFeedbackTime = 0; // Reset quick feedback timer for new session
            lastAutoAnalysisTime = 0; // Reset deep analysis timer for new session

            // REAL RECORDING MODE: Start ElevenLabs WebSocket + Microphone
            if (!isDemoMode) {
                try {
                    await startRealRecording();
                    console.log('üé§ Real recording started with ElevenLabs STT');
                } catch (error) {
                    console.error('‚ùå Failed to start real recording:', error);
                    showModal('È∫•ÂÖãÈ¢®ÂïüÂãïÂ§±Êïó', `ÁÑ°Ê≥ïÂïüÂãïÈ∫•ÂÖãÈ¢®ÊàñÈÄ£Êé•Ë™ûÈü≥Ëæ®Ë≠òÊúçÂãôÔºö${error.message}\n\nÂ∞áÂàáÊèõÂà∞ Demo Ê®°Âºè`, 'warning');
                    isDemoMode = true; // Fallback to demo mode
                }
            }

            // DEMO MODE: Initialize audio simulation
            if (isDemoMode) {
                initializeAudioSimulation();

                // Auto-play audio if voice simulation is enabled
                if (isVoiceSimEnabled) {
                    playAudioSimulation();
                    console.log('üéµ Ëá™ÂãïÈñãÂßãÊí≠ÊîæÈü≥Ë®äÔºàÊ®°Êì¨‰∫∫ËÅ≤Â∑≤ÂïüÁî®Ôºâ');
                }
            }

            // UI Updates - Desktop
            startBtn.disabled = true;
            startBtn.classList.add('opacity-50', 'cursor-not-allowed');
            stopBtn.disabled = false;
            stopBtn.classList.remove('opacity-50', 'cursor-not-allowed');

            // UI Updates - Mobile (pauseBtnMobile and stopBtnMobile are already visible in recordingBottomBar)
            if (pauseBtnMobile) {
                pauseBtnMobile.disabled = false;
                pauseBtnMobile.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            if (stopBtnMobile) {
                stopBtnMobile.disabled = false;
                stopBtnMobile.classList.remove('opacity-50', 'cursor-not-allowed');
            }

            // Analysis buttons
            triggerAnalysisBtn.disabled = false;
            triggerAnalysisBtn.classList.remove('opacity-50', 'cursor-not-allowed');

            // Show/hide indicators
            liveIndicator.classList.remove('hidden');
            transcriptEmpty.style.display = 'none';

            // REQUIREMENT 1: Enable bottom analyze button (remove disabled state)
            if (fabAnalyzeMobile) {
                fabAnalyzeMobile.disabled = false;
                fabAnalyzeMobile.classList.remove('opacity-50', 'cursor-not-allowed');
            }

            // REQUIREMENT 3: Hide all UI cards when recording starts
            // È°ØÁ§∫ÊâãÊ©üÁâàÈåÑÈü≥‰∏≠ÁöÑÊ•µÁ∞° UIÔºåÈö±ËóèÂÖ∂‰ªñ UI
            const recordingUI = document.getElementById('recordingUI');
            if (recordingUI && window.innerWidth < 768) {
                recordingUI.classList.remove('hidden');
            }
            if (initialUI) {
                initialUI.classList.add('hidden');
            }
            if (practiceIntroUI) {
                practiceIntroUI.classList.add('hidden');
            }
            // È°ØÁ§∫ÊâãÊ©üÁâàÂ∫ïÈÉ®ÊåâÈàïÂàó (pauseBtnMobile and stopBtnMobile are inside recordingBottomBar)
            if (recordingBottomBar && window.innerWidth < 768) {
                recordingBottomBar.classList.remove('hidden');
            }

            // Header is now hidden on mobile via CSS (hidden md:block)
            // No need for JavaScript header manipulation on mobile

            // Show waveform and recording timer
            waveformContainer.classList.add('active');
            recordingTimerDisplay.style.display = 'block';
            recordingTimerDisplayMobile.style.display = 'block';

            // Start waveform animations
            updateWaveformAnimations();

            // Auto-expand transcript section when recording starts
            const transcriptSection = document.getElementById('transcriptSection');
            const transcriptToggle = document.getElementById('transcriptToggle');
            if (transcriptSection.classList.contains('hidden')) {
                transcriptSection.classList.remove('hidden');
                transcriptToggle.textContent = '‚ñ≤';
                transcriptToggle.style.transform = 'rotate(180deg)';
            }

            status.textContent = 'üî¥ ÈåÑÈü≥‰∏≠';
            status.classList.add('pulse-recording');
            transcript.innerHTML = '';
            analysisCards.innerHTML = '';
            if (analysisEmpty) analysisEmpty.style.display = 'none';

            // Start Timer
            timerInterval = setInterval(updateTimer, 1000);

            // Show next analysis countdown
            updateNextAnalysisCountdown();
        }

        function stopSession() {
            isRecording = false;
            isPaused = false; // Reset pause state
            pausedTime = 0; // Reset paused duration
            pauseStartTime = null; // Reset pause start time

            // Stop inactivity monitoring
            stopInactivityMonitoring();

            // Stop real recording if active
            if (!isDemoMode) {
                stopRealRecording();
            }

            // Final analysis
            analyzeTranscript();

            // Stop audio playback and speech (demo mode)
            if (audioSimulation.isPlaying) {
                pauseAudioSimulation();
            }
            stopSpeech();

            // Hide audio player
            if (audioPlayerSection) {
                audioPlayerSection.style.display = 'none';
            }

            // Cleanup
            clearInterval(timerInterval);
            clearInterval(analysisInterval);
            lastAutoAnalysisTime = 0; // Reset auto-analysis tracker

            // UI Updates - Desktop
            startBtn.disabled = false;
            startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            stopBtn.disabled = true;
            stopBtn.classList.add('opacity-50', 'cursor-not-allowed');

            // UI Updates - Mobile (disable buttons since session stopped)
            if (pauseBtnMobile) {
                pauseBtnMobile.disabled = true;
                pauseBtnMobile.classList.add('opacity-50', 'cursor-not-allowed');
                // Reset pause button text
                pauseBtnMobile.innerHTML = `
                    <span class="text-2xl">‚è∏</span>
                    <span>Êö´ÂÅú</span>
                `;
            }
            if (stopBtnMobile) {
                stopBtnMobile.disabled = true;
                stopBtnMobile.classList.add('opacity-50', 'cursor-not-allowed');
            }

            // Hide indicators
            liveIndicator.classList.add('hidden');

            // REQUIREMENT 1: Disable bottom analyze button again
            if (fabAnalyzeMobile) {
                fabAnalyzeMobile.disabled = true;
                fabAnalyzeMobile.classList.add('opacity-50', 'cursor-not-allowed');
            }

            // REQUIREMENT 3: Show initial UI when recording stops (return to homepage)
            // Èö±ËóèÊâãÊ©üÁâàÈåÑÈü≥‰∏≠ÁöÑÊ•µÁ∞° UIÔºåÈ°ØÁ§∫È¶ñÈ†Å
            const recordingUI = document.getElementById('recordingUI');
            if (recordingUI) {
                recordingUI.classList.add('hidden');
            }
            if (practiceIntroUI) {
                practiceIntroUI.classList.add('hidden');
            }

            // Show completion screen on mobile, otherwise show initial UI
            if (window.innerWidth < 768) {
                // Mobile: Check if there's a transcript
                const hasTranscript = transcriptSegments && transcriptSegments.length > 0;

                if (hasTranscript && completionScreen && sessionDuration) {
                    // Has transcript: Show completion screen
                    // Calculate and display session duration
                    const duration = calculateSessionDuration();
                    sessionDuration.textContent = duration;

                    // CRITICAL: Hide carousel before showing completion screen
                    if (mobileCarousel) mobileCarousel.classList.add('hidden');

                    // Show completion screen
                    completionScreen.classList.remove('hidden');
                } else {
                    // No transcript: Return to initial UI (home page)
                    if (mobileCarousel) mobileCarousel.classList.add('hidden');
                    if (completionScreen) completionScreen.classList.add('hidden');
                    if (initialUI) initialUI.classList.remove('hidden');
                }
            } else {
                // Only show initialUI if no analysis cards exist (desktop behavior)
                if (initialUI && mobileAnalysisCards.length === 0) {
                    initialUI.classList.remove('hidden');
                }
            }

            // Èö±ËóèÊâãÊ©üÁâàÂ∫ïÈÉ®ÊåâÈàïÂàó
            if (recordingBottomBar) {
                recordingBottomBar.classList.add('hidden');
            }

            // Header is now hidden on mobile via CSS (hidden md:block)
            // No need for JavaScript header manipulation on mobile

            // Hide waveform and recording timer
            waveformContainer.classList.remove('active');
            recordingTimerDisplay.style.display = 'none';
            recordingTimerDisplayMobile.style.display = 'none';

            // Stop waveform animations
            updateWaveformAnimations();

            status.textContent = '‚èπÔ∏è Â∑≤ÁµêÊùü';
            status.classList.remove('pulse-recording');
            nextAnalysis.textContent = '-';

            // Save to localStorage
            saveToHistory();
        }

        // NEW: Toggle pause/resume
        function togglePause() {
            if (isPaused) {
                resumeSession();
            } else {
                pauseSession();
            }
        }

        // NEW: Pause the session
        function pauseSession() {
            if (!isRecording || isPaused) return;

            isPaused = true;
            pauseStartTime = Date.now();

            // Pause timer
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            // Pause audio simulation if playing (demo mode)
            if (isDemoMode && audioSimulation.isPlaying) {
                pauseAudioSimulation();
            }

            // In real mode, we can't truly "pause" ElevenLabs WebSocket
            // But we can stop sending audio and ignore incoming messages
            // The WebSocket stays connected but inactive

            // Update UI - Mobile pause button
            if (pauseBtnMobile) {
                pauseBtnMobile.innerHTML = `
                    <span class="text-2xl">‚ñ∂Ô∏è</span>
                    <span>ÁπºÁ∫å</span>
                `;
            }

            // Update status
            status.textContent = '‚è∏Ô∏è Â∑≤Êö´ÂÅú';
            status.classList.remove('pulse-recording');

            // Stop waveform animations
            updateWaveformAnimations();

            console.log('‚è∏Ô∏è Session paused');
        }

        // NEW: Resume the session
        function resumeSession() {
            if (!isRecording || !isPaused) return;

            // Calculate paused duration and add to total
            if (pauseStartTime) {
                pausedTime += (Date.now() - pauseStartTime);
                pauseStartTime = null;
            }

            isPaused = false;

            // Resume timer
            timerInterval = setInterval(updateTimer, 1000);

            // Resume audio simulation if was playing (demo mode)
            if (isDemoMode && isVoiceSimEnabled && audioPlayerSection) {
                playAudioSimulation();
            }

            // In real mode, WebSocket is still connected, just resume normal operation

            // Update UI - Mobile pause button
            if (pauseBtnMobile) {
                pauseBtnMobile.innerHTML = `
                    <span class="text-2xl">‚è∏</span>
                    <span>Êö´ÂÅú</span>
                `;
            }

            // Update status
            status.textContent = 'üî¥ ÈåÑÈü≥‰∏≠';
            status.classList.add('pulse-recording');

            // Resume waveform animations
            updateWaveformAnimations();

            console.log('‚ñ∂Ô∏è Session resumed');
        }

        function switchSpeaker(speaker) {
            currentSpeaker = speaker;

            // Guard: Skip UI updates if speaker buttons don't exist (e.g., in demo mode)
            if (!speakerCounselorBtn || !speakerClientBtn) {
                return;
            }

            if (speaker === 'counselor') {
                speakerCounselorBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300', 'shadow-sm');
                speakerCounselorBtn.classList.add('bg-gradient-to-br', 'from-blue-500', 'to-indigo-600', 'text-white', 'shadow-md', 'hover:shadow-lg');
                speakerClientBtn.classList.remove('bg-gradient-to-br', 'from-blue-500', 'to-indigo-600', 'text-white', 'shadow-md', 'hover:shadow-lg');
                speakerClientBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300', 'shadow-sm');
            } else {
                speakerClientBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300', 'shadow-sm');
                speakerClientBtn.classList.add('bg-gradient-to-br', 'from-blue-500', 'to-indigo-600', 'text-white', 'shadow-md', 'hover:shadow-lg');
                speakerCounselorBtn.classList.remove('bg-gradient-to-br', 'from-blue-500', 'to-indigo-600', 'text-white', 'shadow-md', 'hover:shadow-lg');
                speakerCounselorBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300', 'shadow-sm');
            }
        }

        function toggleRecordingMode() {
            // Prevent mode change during recording
            if (isRecording) {
                showModal('ÁÑ°Ê≥ïÂàáÊèõÊ®°Âºè', 'Ë´ãÂÖàÂÅúÊ≠¢ÈåÑÈü≥ÂÜçÂàáÊèõÊ®°Âºè', 'warning');
                return;
            }

            // Toggle mode
            isDemoMode = !isDemoMode;

            // Update all toggle switches (mobile + desktop)
            const toggles = [modeToggle, modeToggleDesktop].filter(t => t);
            const labels = [
                { elem: modeToggleLabel, hintElem: modeHint },
                { elem: modeToggleLabelDesktop, hintElem: modeHintDesktop }
            ].filter(l => l.elem);

            toggles.forEach(toggleBtn => {
                const toggleCircle = toggleBtn.querySelector('span');

                if (!isDemoMode) {
                    // Real recording mode: green background, circle to right
                    toggleBtn.classList.remove('bg-gray-300');
                    toggleBtn.classList.add('bg-green-600');
                    toggleBtn.setAttribute('aria-checked', 'true');
                    toggleCircle.classList.remove('translate-x-1');
                    toggleCircle.classList.add('translate-x-6');
                } else {
                    // Demo mode: gray background, circle to left
                    toggleBtn.classList.remove('bg-green-600');
                    toggleBtn.classList.add('bg-gray-300');
                    toggleBtn.setAttribute('aria-checked', 'false');
                    toggleCircle.classList.remove('translate-x-6');
                    toggleCircle.classList.add('translate-x-1');
                }
            });

            // Update labels
            labels.forEach(({ elem, hintElem }) => {
                if (!isDemoMode) {
                    elem.textContent = 'ÁúüÂØ¶ÈåÑÈü≥';
                    hintElem.textContent = 'ÈñãÂïü = ÁúüÂØ¶';
                } else {
                    elem.textContent = 'Demo Ê®°Âºè';
                    hintElem.textContent = 'ÈóúÈñâ = Demo';
                }
            });

            // Show/Hide demo mode hints
            const demoHintMobile = document.getElementById('demoModeHintMobile');
            const demoHintDesktop = document.getElementById('demoModeHintDesktop');
            if (demoHintMobile) demoHintMobile.style.display = isDemoMode ? '' : 'none';
            if (demoHintDesktop) demoHintDesktop.style.display = isDemoMode ? '' : 'none';

            // Log mode change
            console.log(`üîÑ Mode switched to: ${isDemoMode ? 'Demo' : 'Real Recording'}`);

            // Show notification
            const modeText = isDemoMode ? 'Demo Ê®°ÂºèÔºàÊ®°Êì¨Â∞çË©±Ôºâ' : 'ÁúüÂØ¶ÈåÑÈü≥Ê®°ÂºèÔºàÈúÄË¶ÅÈ∫•ÂÖãÈ¢®Ê¨äÈôêÔºâ';
            showNotification(`Â∑≤ÂàáÊèõÂà∞ ${modeText}`, isDemoMode ? 'info' : 'success');
        }

        function showNotification(message, type = 'info') {
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-4 ${bgColor} text-white px-6 py-3 rounded-xl shadow-lg z-50 fade-in`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Provider toggle functionality
        function setupProviderToggle() {
            const toggleMobile = document.getElementById('providerToggle');
            const toggleDesktop = document.getElementById('providerToggleDesktop');

            if (toggleMobile) {
                toggleMobile.addEventListener('click', () => {
                    currentProvider = currentProvider === 'gemini' ? 'codeer' : 'gemini';
                    updateProviderUI();
                });
            }

            if (toggleDesktop) {
                toggleDesktop.addEventListener('click', () => {
                    currentProvider = currentProvider === 'gemini' ? 'codeer' : 'gemini';
                    updateProviderUI();
                });
            }
        }

        function updateProviderUI() {
            // Mobile elements
            const toggle = document.getElementById('providerToggle');
            const circle = document.getElementById('providerToggleCircle');
            const label = document.getElementById('providerLabel');
            const description = document.getElementById('providerDescription');
            const latency = document.getElementById('providerLatency');
            const modelSelector = document.getElementById('codeerModelSelector');

            // Desktop elements
            const toggleDesktop = document.getElementById('providerToggleDesktop');
            const circleDesktop = document.getElementById('providerToggleCircleDesktop');
            const labelDesktop = document.getElementById('providerLabelDesktop');
            const descriptionDesktop = document.getElementById('providerDescriptionDesktop');
            const latencyDesktop = document.getElementById('providerLatencyDesktop');
            const modelSelectorDesktop = document.getElementById('codeerModelSelectorDesktop');

            if (currentProvider === 'codeer') {
                // Codeer selected - Mobile
                if (toggle) {
                    toggle.classList.remove('bg-gray-300');
                    toggle.classList.add('bg-purple-600');
                }
                if (circle) {
                    circle.classList.remove('translate-x-1');
                    circle.classList.add('translate-x-6');
                }
                if (label) label.textContent = 'Ë¶™Â≠êÂ∞àÂÆ∂';
                if (description) description.textContent = 'Codeer AI ¬∑ Â∞àÊ•≠Ë¶™Â≠êÊïôÈ§ä';
                if (modelSelector) modelSelector.classList.remove('hidden'); // Show model selector

                // Codeer selected - Desktop
                if (toggleDesktop) {
                    toggleDesktop.classList.remove('bg-gray-300');
                    toggleDesktop.classList.add('bg-purple-600');
                }
                if (circleDesktop) {
                    circleDesktop.classList.remove('translate-x-1');
                    circleDesktop.classList.add('translate-x-6');
                }
                if (labelDesktop) labelDesktop.textContent = 'Ë¶™Â≠êÂ∞àÂÆ∂';
                if (descriptionDesktop) descriptionDesktop.textContent = 'Codeer AI ¬∑ Â∞àÊ•≠Ë¶™Â≠êÊïôÈ§ä';
                if (modelSelectorDesktop) modelSelectorDesktop.classList.remove('hidden'); // Show model selector
            } else {
                // Gemini selected - Mobile
                if (toggle) {
                    toggle.classList.remove('bg-purple-600');
                    toggle.classList.add('bg-gray-300');
                }
                if (circle) {
                    circle.classList.remove('translate-x-6');
                    circle.classList.add('translate-x-1');
                }
                if (label) label.textContent = 'Gemini';
                if (description) description.textContent = 'ÈÄüÂ∫¶Âø´ ¬∑ ÊîØÊè¥Âø´Âèñ';
                if (modelSelector) modelSelector.classList.add('hidden'); // Hide model selector

                // Gemini selected - Desktop
                if (toggleDesktop) {
                    toggleDesktop.classList.remove('bg-purple-600');
                    toggleDesktop.classList.add('bg-gray-300');
                }
                if (circleDesktop) {
                    circleDesktop.classList.remove('translate-x-6');
                    circleDesktop.classList.add('translate-x-1');
                }
                if (labelDesktop) labelDesktop.textContent = 'Gemini';
                if (descriptionDesktop) descriptionDesktop.textContent = 'ÈÄüÂ∫¶Âø´ ¬∑ ÊîØÊè¥Âø´Âèñ';
                if (modelSelectorDesktop) modelSelectorDesktop.classList.add('hidden'); // Hide model selector
            }

            console.log(`Provider switched to: ${currentProvider}`);
        }

        // Setup Codeer model selector event listeners
        function setupCodeerModelSelector() {
            // Mobile model selector
            const modelRadios = document.querySelectorAll('input[name="codeerModel"]');
            modelRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    currentCodeerModel = e.target.value;
                    console.log(`Codeer model changed to: ${currentCodeerModel}`);

                    // Sync with desktop selector
                    const desktopRadio = document.querySelector(`input[name="codeerModelDesktop"][value="${currentCodeerModel}"]`);
                    if (desktopRadio) desktopRadio.checked = true;
                });
            });

            // Desktop model selector
            const modelRadiosDesktop = document.querySelectorAll('input[name="codeerModelDesktop"]');
            modelRadiosDesktop.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    currentCodeerModel = e.target.value;
                    console.log(`Codeer model changed to: ${currentCodeerModel}`);

                    // Sync with mobile selector
                    const mobileRadio = document.querySelector(`input[name="codeerModel"][value="${currentCodeerModel}"]`);
                    if (mobileRadio) mobileRadio.checked = true;
                });
            });
        }

        function toggleVoiceSimulation() {
            isVoiceSimEnabled = !isVoiceSimEnabled;

            // Update both mobile and desktop toggles
            const toggles = [voiceSimToggle, voiceSimToggleDesktop].filter(t => t);

            toggles.forEach(toggleBtn => {
                const toggleCircle = toggleBtn.querySelector('span');

                if (isVoiceSimEnabled) {
                    // Enabled state: indigo background, circle moved to right
                    toggleBtn.classList.remove('bg-gray-300');
                    toggleBtn.classList.add('bg-indigo-600');
                    toggleBtn.setAttribute('aria-checked', 'true');
                    toggleCircle.classList.remove('translate-x-1');
                    toggleCircle.classList.add('translate-x-6');
                } else {
                    // Disabled state: gray background, circle moved to left
                    toggleBtn.classList.remove('bg-indigo-600');
                    toggleBtn.classList.add('bg-gray-300');
                    toggleBtn.setAttribute('aria-checked', 'false');
                    toggleCircle.classList.remove('translate-x-6');
                    toggleCircle.classList.add('translate-x-1');
                }
            });

            if (isVoiceSimEnabled) {
                console.log('üé≠ Voice Simulation: ENABLED');

                // If recording, show audio player and start playback
                if (isRecording && audioPlayerSection) {
                    audioPlayerSection.style.display = 'block';
                    if (!audioSimulation.isPlaying) {
                        playAudioSimulation();
                        console.log('üéµ Ëá™ÂãïÈñãÂßãÊí≠ÊîæÈü≥Ë®äÔºàÂàáÊèõËá≥Ê®°Êì¨‰∫∫ËÅ≤Ôºâ');
                    }
                }
            } else {
                console.log('üé≠ Voice Simulation: DISABLED');

                // If recording, hide audio player and stop playback
                if (isRecording) {
                    if (audioSimulation.isPlaying) {
                        pauseAudioSimulation();
                        console.log('‚è∏Ô∏è ÂÅúÊ≠¢Êí≠ÊîæÈü≥Ë®äÔºàÂàáÊèõËá≥ÈóúÈñâÊ®°Êì¨‰∫∫ËÅ≤Ôºâ');
                    }
                    if (audioPlayerSection) {
                        audioPlayerSection.style.display = 'none';
                    }
                }
            }
        }

        function updateWaveformAnimations() {
            const containers = [waveformContainer, waveformContainerMobile];
            containers.forEach(container => {
                if (!container) return;
                const bars = container.querySelectorAll('.waveform-bar');
                bars.forEach(bar => {
                    // Animation enabled when recording
                    if (isRecording) {
                        bar.style.animationPlayState = 'running';
                    } else {
                        bar.style.animationPlayState = 'paused';
                    }
                });
            });
        }

        function calculateSessionDuration() {
            // Subtract paused time from total elapsed time
            const totalPausedMs = pausedTime + (isPaused && pauseStartTime ? (Date.now() - pauseStartTime) : 0);
            const elapsed = Math.floor((Date.now() - startTime - totalPausedMs) / 1000);
            const hours = Math.floor(elapsed / 3600);
            const displayMinutes = Math.floor((elapsed % 3600) / 60);
            const seconds = elapsed % 60;
            return `${String(hours).padStart(2, '0')}:${String(displayMinutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function updateTimer() {
            // Subtract paused time from total elapsed time
            const totalPausedMs = pausedTime + (isPaused && pauseStartTime ? (Date.now() - pauseStartTime) : 0);
            const elapsed = Math.floor((Date.now() - startTime - totalPausedMs) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            const hours = Math.floor(elapsed / 3600);
            const displayMinutes = Math.floor((elapsed % 3600) / 60);

            // Format: MM:SS for compact displays
            const timeString = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            // Format: HH:MM:SS for mobile recording UI
            const timeStringLong = `${String(hours).padStart(2, '0')}:${String(displayMinutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            // Update main timer (desktop)
            timer.textContent = timeString;

            // Update recording timer displays
            if (recordingTimer) recordingTimer.textContent = timeStringLong; // Mobile recording UI (Â∑≤Ë´áË©± HH:MM:SS)
            if (recordingTimerDesktop) recordingTimerDesktop.textContent = timeString; // Desktop recording timer display
            if (recordingTimerMobile) recordingTimerMobile.textContent = timeString; // Mobile compact waveform timer

            // === Dual-API Auto-Analysis System ===
            // 1. Quick Feedback (ÈõûÊπØÊñá): Every 20 seconds (except during red light)
            // 2. Deep Analysis: Adaptive intervals (green=60s, yellow=30s, red=15s)

            // Quick Feedback Timer (every 20 seconds, except red light)
            const shouldQuickFeedback = (elapsed > 0 && elapsed % 20 === 0 && elapsed !== lastQuickFeedbackTime)
                && lastSafetyLevel !== 'red' // Disable during red light (already fast enough)
                && transcriptSegments.length > 0;

            if (shouldQuickFeedback) {
                lastQuickFeedbackTime = elapsed;
                console.log(`üí° [Quick Feedback] Triggered at ${elapsed}s (safety: ${lastSafetyLevel})`);

                // Show yellow toast for quick analysis
                showAutoAnalysisNotification(true); // true = quick analysis

                // Call quick feedback API
                getQuickFeedback();
            }

            // Deep Analysis Timer (adaptive intervals based on safety level)
            const shouldDeepAnalyze = (elapsed > 0 && elapsed % nextAnalysisInterval === 0 && elapsed !== lastAutoAnalysisTime)
                && transcriptSegments.length > 0;

            if (shouldDeepAnalyze) {
                lastAutoAnalysisTime = elapsed;
                console.log(`üîç [Deep Analysis] Triggered at ${elapsed}s (interval: ${nextAnalysisInterval}s, safety: ${lastSafetyLevel})`);

                // Show purple toast for deep analysis
                showAutoAnalysisNotification(false); // false = deep analysis

                // Call full analysis API
                analyzeTranscript();
            }
        }

        function updateNextAnalysisCountdown() {
            if (!isRecording) return;

            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const remaining = nextAnalysisInterval - (elapsed % nextAnalysisInterval);
            nextAnalysis.textContent = `${remaining} Áßí`;

            setTimeout(() => updateNextAnalysisCountdown(), 1000);
        }

        // Update analysis interval based on safety_level
        function updateAnalysisInterval(safetyLevel) {
            const intervalMap = {
                green: 60,   // Safe: check every 60 seconds
                yellow: 30,  // Warning: check every 30 seconds
                red: 15      // Critical: check every 15 seconds
            };

            const newInterval = intervalMap[safetyLevel] || 60;

            // Only log and notify if interval actually changed
            if (newInterval !== nextAnalysisInterval) {
                nextAnalysisInterval = newInterval;
                lastSafetyLevel = safetyLevel;

                const emoji = {green: 'üü¢', yellow: 'üü°', red: 'üî¥'}[safetyLevel] || '‚ö™';
                const levelText = {green: 'ÂÆâÂÖ®', yellow: 'Ë≠¶Á§∫', red: 'È´òÈ¢®Èö™'}[safetyLevel] || 'Êú™Áü•';
                console.log(`‚è±Ô∏è Analysis interval updated: ${nextAnalysisInterval}s (${safetyLevel.toUpperCase()} - ${levelText})`);

                // Show visual notification
                showIntervalChangeNotification(safetyLevel, newInterval);
            }
        }

        // Show notification when interval changes
        function showIntervalChangeNotification(safetyLevel, interval) {
            const emoji = {green: 'üü¢', yellow: 'üü°', red: 'üî¥'}[safetyLevel] || '‚ö™';
            const levelText = {
                green: 'ÂÆâÂÖ®Â∞çË©±',
                yellow: 'Ë≠¶Á§∫Â∞çË©±',
                red: 'È´òÈ¢®Èö™Â∞çË©±'
            }[safetyLevel] || 'Â∞çË©±';

            const message = `${emoji} ÂÅµÊ∏¨Âà∞${levelText}Ôºå‰∏ãÊ¨°ÂàÜÊûêÊôÇÈñìË™øÊï¥ÁÇ∫ ${interval} Áßí`;

            console.log(`üì¢ ${message}`);

            // If toast notification system exists, use it; otherwise just log
            // You could add a toast notification here if needed
        }

        // Update mobile suggestion circle with AI analysis results
        function updateMobileSuggestionCircle(safetyLevel, suggestion) {
            console.log(`üîç updateMobileSuggestionCircle called with safetyLevel="${safetyLevel}", suggestion="${suggestion.substring(0, 100)}..."`);
            console.log(`üîç Current viewport width: ${window.innerWidth}px`);

            // Get both circle elements (recording UI and carousel UI)
            const liveSuggestion = document.getElementById('liveSuggestion');
            const suggestionCircle = document.getElementById('suggestionCircle');
            const carouselLiveSuggestion = document.getElementById('carouselLiveSuggestion');
            const carouselCircle = document.getElementById('carouselCircle');

            console.log(`üîç liveSuggestion element:`, liveSuggestion ? 'FOUND' : 'NOT FOUND');
            console.log(`üîç suggestionCircle element:`, suggestionCircle ? 'FOUND' : 'NOT FOUND');
            console.log(`üîç carouselLiveSuggestion element:`, carouselLiveSuggestion ? 'FOUND' : 'NOT FOUND');
            console.log(`üîç carouselCircle element:`, carouselCircle ? 'FOUND' : 'NOT FOUND');

            // Only update on mobile viewport
            if (window.innerWidth >= 768) {
                console.log('‚ö†Ô∏è Skipping mobile circle update - viewport width >= 768px (desktop mode)');
                return;
            }

            // Update text (replace \n or \\n with <br> for HTML display)
            const formattedSuggestion = suggestion.replace(/\\n|\n/g, '<br>');
            console.log(`üîç Formatted suggestion: "${formattedSuggestion}"`);

            // Update color based on safety level
            const gradients = {
                red: 'radial-gradient(circle, #ef4444 0%, #f87171 40%, #fca5a5 70%, #fecaca 100%)',
                yellow: 'radial-gradient(circle, #f59e0b 0%, #fbbf24 40%, #fcd34d 70%, #fef3c7 100%)',
                green: 'radial-gradient(circle, #67e8f9 0%, #99f6e4 40%, #ccfbf1 70%, #f0fdfa 100%)'
            };

            // Update text color for better contrast
            const textColors = {
                red: 'text-red-900',
                yellow: 'text-orange-900',
                green: 'text-teal-900'
            };

            const selectedGradient = gradients[safetyLevel] || gradients.green;
            const selectedTextColor = textColors[safetyLevel] || textColors.green;

            console.log(`üîç Applying gradient: ${selectedGradient}`);
            console.log(`üîç Applying text color: ${selectedTextColor}`);

            // Update recording UI circle (large version)
            if (liveSuggestion && suggestionCircle) {
                liveSuggestion.innerHTML = formattedSuggestion;
                suggestionCircle.style.background = selectedGradient;
                liveSuggestion.className = `text-2xl font-bold leading-tight ${selectedTextColor}`;
                console.log(`‚úÖ Recording UI circle updated`);
            }

            // Update carousel UI circle (compact version)
            if (carouselLiveSuggestion && carouselCircle) {
                carouselLiveSuggestion.innerHTML = formattedSuggestion;
                carouselCircle.style.background = selectedGradient;
                carouselLiveSuggestion.className = `text-sm font-bold leading-tight ${selectedTextColor}`;
                console.log(`‚úÖ Carousel UI circle updated`);
            }

            console.log(`‚úÖ Mobile circles updated successfully: ${safetyLevel} - ${suggestion.substring(0, 50)}...`);
        }

        // === Transcript Management ===
        function addTranscriptLine(speaker, text) {
            // Hide empty state on first transcript line
            if (transcriptEmpty) {
                transcriptEmpty.style.display = 'none';
            }

            // Chat-style bubble
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex items-start gap-2 mb-3 fade-in ${speaker === 'client' ? 'flex-row-reverse' : ''}`;

            const avatarDiv = document.createElement('div');
            avatarDiv.className = `w-8 h-8 ${speaker === 'counselor' ? 'bg-blue-500' : 'bg-green-500'} rounded-full flex items-center justify-center flex-shrink-0 shadow-md`;
            avatarDiv.innerHTML = `<span class="text-white text-sm">${speaker === 'counselor' ? 'üë®‚Äç‚öïÔ∏è' : 'üßë'}</span>`;

            const bubbleWrapper = document.createElement('div');
            bubbleWrapper.className = `flex-1 flex flex-col ${speaker === 'client' ? 'items-end' : 'items-start'}`;

            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${speaker === 'counselor' ? 'bg-blue-50 rounded-2xl rounded-tl-none' : 'bg-green-50 rounded-2xl rounded-tr-none'} px-4 py-2 shadow-sm`;
            bubble.innerHTML = `<p class="text-sm text-gray-800 leading-relaxed">${text}</p>`;

            const timestamp = document.createElement('span');
            timestamp.className = `text-xs text-gray-400 ${speaker === 'client' ? 'mr-2' : 'ml-2'} mt-1`;
            const now = new Date();
            timestamp.textContent = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });

            bubbleWrapper.appendChild(bubble);
            bubbleWrapper.appendChild(timestamp);

            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(bubbleWrapper);

            transcript.appendChild(messageDiv);
            transcript.scrollTop = transcript.scrollHeight;

            // Save to segments
            transcriptSegments.push({ speaker, text });
        }

        // === AI Analysis ===
        async function analyzeTranscript() {
            // Prevent concurrent API calls
            if (isAnalyzing) {
                console.log('‚è≥ Analysis already in progress, ignoring duplicate request');
                return;
            }

            // Set analyzing flag and loading state for all analyze buttons (do this first for user feedback)
            isAnalyzing = true;
            setAnalyzeButtonsLoading(true);

            if (transcriptSegments.length === 0) {
                // Restore button state and show error
                isAnalyzing = false;
                setAnalyzeButtonsLoading(false);
                showModal('ÁÑ°Ê≥ïÂàÜÊûê', 'ÁõÆÂâçÊ≤íÊúâÈÄêÂ≠óÁ®øÂÖßÂÆπÔºåË´ãÂÖàÈñãÂßãÈåÑÈü≥', 'warning');
                return;
            }

            try {
                // Build transcript text
                const transcriptText = transcriptSegments.map(s =>
                    `${s.speaker === 'counselor' ? 'Ë´ÆË©¢Â∏´' : 'Ê°à‰∏ª'}Ôºö${s.text}`
                ).join('\n');

                // Skip analysis if transcript is too short (less than 10 characters)
                if (!transcriptText || transcriptText.trim().length < 10) {
                    console.log('‚è≠Ô∏è Skipping analysis: transcript too short');
                    isAnalyzing = false;
                    setAnalyzeButtonsLoading(false);
                    return;
                }

                // Calculate time range and capture recording timestamp
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                const timeRange = `${Math.max(0, minutes - 1)}:00-${minutes}:00`;
                const recordingTimestamp = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                // === ‰ΩøÁî®ÂÅáË≥áÊñôÊ®°ÂºèÔºàDemoÔºâ ===
                const useMockData = false; // Ë®≠ÁÇ∫ false ‰ΩøÁî®ÁúüÂØ¶ API

                if (useMockData) {
                    // Êô∫ÊÖßÁîüÊàêÂÅáË≥áÊñô
                    const mockAnalysis = generateMockAnalysis(transcriptText, timeRange, recordingTimestamp);
                    displayAnalysisCard(mockAnalysis);
                    return;
                }

                // === API Ë∑ØÂæëÈÅ∏ÊìáÔºöNew Session Workflow vs Legacy Realtime API ===
                let analysis;

                if (USE_NEW_SESSION_WORKFLOW && sessionWorkflow) {
                    // === NEW: Use modular Session Workflow (iOS-style) ===
                    console.log('üöÄ Using NEW Session Workflow (modular architecture)');

                    // Initialize session if not already done
                    if (!sessionWorkflow.isSessionActive()) {
                        console.log('[Web] Initializing session...');

                        // Use selected client from onboarding (island_parents flow)
                        const selectedClientId = localStorage.getItem('selectedClientId');
                        const selectedClientName = localStorage.getItem('selectedClientName') || 'Â≠©Â≠ê';
                        const authToken = localStorage.getItem('authToken');

                        // If client was selected in onboarding, create case and session for that client
                        if (selectedClientId && authToken) {
                            console.log('[Web] Using selected client:', selectedClientName, selectedClientId);

                            try {
                                // Create case for existing client
                                const caseResponse = await fetch('/api/v1/cases', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${authToken}`
                                    },
                                    body: JSON.stringify({
                                        client_id: selectedClientId,
                                        summary: `Âç≥ÊôÇË´ÆË©¢ - ${selectedClientName} - ${new Date().toLocaleString('zh-TW')}`,
                                        goals: 'Ë¶™Â≠êÊ∫ùÈÄöÁ∑¥Áøí',
                                        problem_description: counselingMode === 'practice' ? 'Á∑¥ÁøíÊ®°Âºè' : 'Á∑äÊÄ•Ê®°Âºè'
                                    })
                                });

                                if (!caseResponse.ok) {
                                    throw new Error('Failed to create case');
                                }

                                const caseData = await caseResponse.json();
                                const caseId = caseData.id;

                                // Create session for the case
                                const sessionResponse = await fetch('/api/v1/sessions', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${authToken}`
                                    },
                                    body: JSON.stringify({
                                        case_id: caseId,
                                        session_date: new Date().toISOString().split('T')[0],
                                        name: `Web Âç≥ÊôÇË´ÆË©¢ ${new Date().toLocaleString('zh-TW')}`
                                    })
                                });

                                if (!sessionResponse.ok) {
                                    throw new Error('Failed to create session');
                                }

                                const sessionData = await sessionResponse.json();
                                sessionWorkflow.currentSessionId = sessionData.id;
                                sessionWorkflow.currentCaseId = caseId;
                                sessionWorkflow.currentClientId = selectedClientId;

                                console.log('[Web] Session initialized for existing client:', sessionData.id);

                            } catch (error) {
                                console.error('[Web] Failed to create case/session for client:', error);
                                throw new Error(`Session ÂàùÂßãÂåñÂ§±Êïó: ${error.message}`);
                            }

                        } else {
                            // Fallback: Create new client+case+session (for non-island_parents tenants)
                            console.log('[Web] No client selected, creating new client+case');

                            const clientData = {
                                name: 'Á∂≤È†ÅÂç≥ÊôÇË´ÆË©¢Áî®Êà∂',
                                email: `web-${Date.now()}@example.com`,
                                gender: '‰∏çÈÄèÈú≤',
                                birth_date: '2010-01-01',
                                phone: '0900000000',
                                identity_option: 'ÂÆ∂Èï∑',
                                current_status: 'Âç≥ÊôÇË´ÆË©¢‰∏≠',
                                case_summary: `Âç≥ÊôÇË¶™Â≠êË´ÆË©¢ - ${new Date().toLocaleString('zh-TW')}`,
                                case_goals: 'ÊîπÂñÑË¶™Â≠êÈóú‰øÇ',
                                problem_description: 'Á∂≤È†ÅÂç≥ÊôÇË´ÆË©¢'
                            };

                            try {
                                const sessionId = await sessionWorkflow.initializeSession(clientData);
                                console.log('[Web] Session initialized with new client:', sessionId);
                            } catch (error) {
                                console.error('[Web] Session initialization failed:', error);
                                throw new Error(`Session ÂàùÂßãÂåñÂ§±Êïó: ${error.message}`);
                            }
                        }
                    }

                    // Perform analysis using new workflow
                    try {
                        analysis = await sessionWorkflow.performAnalysis(transcriptText, counselingMode);
                        console.log('[Web] Analysis complete (new workflow):', analysis);
                    } catch (error) {
                        console.error('[Web] Analysis failed:', error);
                        throw new Error(`Êñ∞Êû∂ÊßãÂàÜÊûêÂ§±Êïó: ${error.message}`);
                    }

                } else {
                    // === LEGACY: Use Realtime Analyze API ===
                    console.log('üì° Using LEGACY Realtime API');

                    const requestBody = {
                        mode: counselingMode,  // Emergency or Practice mode
                        transcript: transcriptText,
                        speakers: transcriptSegments,
                        time_range: timeRange,
                        recording_timestamp: recordingTimestamp,
                        provider: currentProvider,
                        session_id: currentSessionId,  // Unified session ID
                        use_cache: true  // Enable Gemini caching
                    };

                    // Add codeer_model parameter when using Codeer provider
                    if (currentProvider === 'codeer') {
                        requestBody.codeer_model = currentCodeerModel;
                    }

                    const response = await fetch('/api/v1/realtime/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`API error ${response.status}:`, errorText);
                        throw new Error(`ÂàÜÊûêÂ§±Êïó (HTTP ${response.status})`);
                    }

                    analysis = await response.json();
                }

                // Check if this is an error response (backend returned error structure)
                if (analysis.summary && analysis.summary.includes('Â§±Êïó')) {
                    console.warn('Backend returned error analysis:', analysis);
                    // Display error card with clear indication
                    analysis.is_error = true;
                }

                // Add recording timestamp if not provided by API
                if (!analysis.recording_timestamp) {
                    analysis.recording_timestamp = recordingTimestamp;
                }

                // Update analysis interval based on safety_level
                if (analysis.safety_level) {
                    updateAnalysisInterval(analysis.safety_level);
                }

                displayAnalysisCard(analysis);

            } catch (error) {
                console.error('Analysis error:', error);

                // Show error message to user (don't silently fall back to mock data)
                showModal('ÂàÜÊûêÂ§±Êïó', `${error.message}\n\nË´ãÊ™¢Êü•:\n1. Codeer API ÈÄ£Á∑öÊòØÂê¶Ê≠£Â∏∏\n2. ÈÅ∏ÊìáÁöÑÊ®°ÂûãÊòØÂê¶Â∑≤Ë®≠ÂÆö\n3. Êü•Áúã Console ‰∫ÜËß£Ë©≥Á¥∞ÈåØË™§`, 'error');

                // Log detailed error for debugging
                console.warn('ÂàÜÊûêÂ§±ÊïóÔºåÈåØË™§Ë©≥ÊÉÖ:', {
                    provider: currentProvider,
                    model: currentCodeerModel,
                    error: error.message
                });
            } finally {
                // Always restore analyzing flag and button states, even if error occurs
                isAnalyzing = false;
                setAnalyzeButtonsLoading(false);
            }
        }

        // === Quick Feedback (ÈõûÊπØÊñá) - Every 20 seconds during green/yellow ===
        async function getQuickFeedback() {
            try {
                // Get last 20 seconds of transcript
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const recentSegments = transcriptSegments.slice(-8); // Last 8 segments (~20 seconds)

                if (recentSegments.length === 0) {
                    console.log('‚è≠Ô∏è Skipping quick feedback: no recent transcript');
                    return;
                }

                const recentTranscript = recentSegments.map(s =>
                    `${s.speaker === 'counselor' ? 'ÂÆ∂Èï∑' : 'Â≠©Â≠ê'}Ôºö${s.text}`
                ).join('\n');

                console.log(`üí° Requesting quick feedback for recent transcript (${recentTranscript.length} chars)`);

                // Call quick-feedback API
                const response = await fetch('/api/v1/realtime/quick-feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recent_transcript: recentTranscript })
                });

                if (!response.ok) {
                    console.error(`Quick feedback API error: ${response.status}`);
                    return;
                }

                const data = await response.json();
                console.log(`‚úÖ Quick feedback received (${data.latency_ms}ms): ${data.message}`);

                // Display quick feedback (you can customize display location)
                showQuickFeedbackMessage(data.message);

            } catch (error) {
                console.error('‚ùå Quick feedback failed:', error);
            }
        }

        // Display quick feedback message (minimal UI update)
        // Shows below the deep analysis text, doesn't overwrite it
        function showQuickFeedbackMessage(message) {
            const quickFeedbackText = document.getElementById('quickFeedbackText');
            const carouselQuickFeedbackText = document.getElementById('carouselQuickFeedbackText');

            if (window.innerWidth < 768) {
                // Mobile: Update quick feedback text (below deep analysis) in both circles
                if (quickFeedbackText) {
                    quickFeedbackText.textContent = `üí° ${message}`;
                }
                if (carouselQuickFeedbackText) {
                    carouselQuickFeedbackText.textContent = `üí° ${message}`;
                }
                console.log(`üí¨ Quick feedback displayed: ${message}`);
            } else {
                console.log(`‚ö†Ô∏è Quick feedback not shown (desktop mode)`);
            }
        }

        // Helper function to set loading state for analyze buttons
        function setAnalyzeButtonsLoading(isLoading) {
            const buttons = [
                { btn: fabAnalyzeMobile, icon: '‚ö°', text: 'Âç≥ÊôÇÂàÜÊûê' },
                { btn: triggerAnalysisBtn, icon: '‚ö°', text: 'Á´ãÂç≥ÂàÜÊûê' },
                { btn: quickTestAnalyzeBtn, icon: '‚ö°', text: 'Á´ãÂç≥ÂàÜÊûê' },
                { btn: quickTestAnalyzeBtnDesktop, icon: '‚ö°', text: 'Á´ãÂç≥ÂàÜÊûê' }
            ];

            buttons.forEach(({ btn, icon, text }) => {
                if (!btn) return;

                if (isLoading) {
                    // Set loading state
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    btn.classList.remove('hover:shadow-xl');

                    // Update button content with spinner
                    const isFabMobile = btn.id === 'fabAnalyzeMobile';
                    if (isFabMobile) {
                        btn.innerHTML = `
                            <span class="text-3xl spinner">‚öôÔ∏è</span>
                            <span class="text-lg tracking-wide">ÂàÜÊûê‰∏≠...</span>
                        `;
                    } else {
                        btn.innerHTML = `
                            <span class="spinner">‚öôÔ∏è</span>
                            <span class="hidden sm:inline">ÂàÜÊûê‰∏≠...</span>
                            <span class="sm:hidden">...</span>
                        `;
                    }
                } else {
                    // Restore normal state (only if recording is active)
                    if (isRecording) {
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }

                    // Restore original button content
                    const isFabMobile = btn.id === 'fabAnalyzeMobile';
                    if (isFabMobile) {
                        btn.innerHTML = `
                            <span class="text-3xl">${icon}</span>
                            <span class="text-lg tracking-wide">${text}</span>
                        `;
                    } else {
                        btn.innerHTML = `
                            <span>${icon}</span>
                            <span class="hidden sm:inline">${text}</span>
                            <span class="sm:hidden">ÂàÜÊûê</span>
                        `;
                    }
                }
            });
        }

        // === Mock Data Generator ===
        function generateMockAnalysis(transcriptText, timeRange, recordingTimestamp) {
            const lowerText = transcriptText.toLowerCase();

            // ÂÅµÊ∏¨ÈóúÈçµË≠∞È°å
            const hasSuicideRisk = /Ëá™ÊÆ∫|ÊÉ≥Ê≠ª|Ê¥ªËëóÊ≤íÊÑèÁæ©|‰∏çÊÉ≥Ê¥ª|ÁµêÊùüÁîüÂëΩ/.test(transcriptText);
            const hasAnxiety = /ÁÑ¶ÊÖÆ|Â£ìÂäõ|Á∑äÂºµ|ÂÆ≥ÊÄï|ÊìîÂøÉ/.test(transcriptText);
            const hasDepression = /ÊÜÇÈ¨±|Ê≤ÆÂñ™|ÁÑ°Âäõ|Áñ≤Á¥Ø|Â§±Áú†/.test(transcriptText);
            const hasWork = /Â∑•‰Ωú|‰∏ªÁÆ°|ËÄÅÈóÜ|Âêå‰∫ã|ËÅ∑Â†¥/.test(transcriptText);
            const hasFamily = /ÂÆ∂‰∫∫|Áà∂ÊØç|ÈÖçÂÅ∂|Â∞èÂ≠©|ÂÆ∂Â∫≠/.test(transcriptText);
            const hasRelationship = /Èóú‰øÇ|ÊúãÂèã|‰º¥‰æ∂|ÊÑüÊÉÖ/.test(transcriptText);

            // ÁîüÊàêÊëòË¶Å
            let summary = '';
            if (hasSuicideRisk) {
                summary = '‚ö†Ô∏è Ê°à‰∏ªË°®ÈÅîËá™ÊÆ∫ÊÑèÂøµÔºåË´ÆË©¢Â∏´Ê≠£Âú®Ë©ï‰º∞È¢®Èö™Á®ãÂ∫¶„ÄÇÈúÄÁ´ãÂç≥ÈóúÊ≥®Ê°à‰∏ªÂÆâÂÖ®„ÄÇ';
            } else if (hasDepression && hasWork) {
                summary = 'Ê°à‰∏ªË°®ÈÅîÂ∑•‰ΩúÁõ∏ÈóúÁöÑÊÜÇÈ¨±ÁóáÁãÄÔºåË´ÆË©¢Â∏´ÂêåÁêÜÊ°à‰∏ªËôïÂ¢ÉÔºåÊé¢Á¥¢Â£ìÂäõ‰æÜÊ∫ê„ÄÇ';
            } else if (hasAnxiety && hasFamily) {
                summary = 'Ê°à‰∏ªË´áÂèäÂÆ∂Â∫≠Ë≠∞È°åÂºïÁôºÁöÑÁÑ¶ÊÖÆÊÑüÂèóÔºåË´ÆË©¢Â∏´‰ΩøÁî®ÂèçÊò†ÊäÄÂ∑ßÂª∫Á´ãÈóú‰øÇ„ÄÇ';
            } else if (hasWork) {
                summary = 'Ê°à‰∏ªÂàÜ‰∫´Â∑•‰ΩúÂõ∞ÊìæÔºåË´ÆË©¢Â∏´ÂºïÂ∞éÊ°à‰∏ªÊé¢Á¥¢ÂÖ∑È´îÊÉÖÂ¢ÉËàáÊÑüÂèó„ÄÇ';
            } else if (hasRelationship) {
                summary = 'Ê°à‰∏ªË´áË´ñ‰∫∫ÈöõÈóú‰øÇË≠∞È°åÔºåË´ÆË©¢Â∏´ÂçîÂä©Ê°à‰∏ªË¶∫ÂØü‰∫íÂãïÊ®°Âºè„ÄÇ';
            } else {
                summary = 'Ë´ÆË©¢Â∏´ËàáÊ°à‰∏ªÂª∫Á´ãÂàùÊ≠•Èóú‰øÇÔºåÈñãÂßãÊé¢Á¥¢Ê°à‰∏ªÁï∂ÂâçÈóúÊ≥®Ë≠∞È°å„ÄÇ';
            }

            // ÁîüÊàêË≠¶Á§∫
            const alerts = [];
            if (hasSuicideRisk) {
                alerts.push('‚ö†Ô∏è È´òÈ¢®Èö™ÔºöÊ°à‰∏ªÊèêÂèäËá™ÊÆ∫Áõ∏ÈóúÂ≠óÁúºÔºåÈúÄÁ´ãÂç≥Ë©ï‰º∞Ëá™ÊÆ∫È¢®Èö™ÔºàË®àÁï´„ÄÅÊñπÊ≥ï„ÄÅÊôÇÈñìÔºâ');
                alerts.push('‚ö†Ô∏è ÂÆâÂÖ®Ë©ï‰º∞ÔºöËÄÉÊÖÆÊòØÂê¶ÈúÄË¶ÅÂç±Ê©üËôïÁêÜ„ÄÅËÅØÁµ°Á∑äÊÄ•ËÅØÁµ°‰∫∫ÊàñËΩâ‰ªãÁ≤æÁ•ûÁßë');
                alerts.push('‚ö†Ô∏è ÊåÅÁ∫åËøΩËπ§ÔºöÊú¨Ê¨°ÊúÉË´áÁµêÊùüÂâçÁ¢∫Ë™çÊ°à‰∏ªÂÆâÂÖ®ÔºåÂÆâÊéíÂØÜÈõÜËøΩËπ§');
            } else if (hasDepression) {
                alerts.push('‚ö†Ô∏è Ê≥®ÊÑèÊ°à‰∏ªÊÉÖÁ∑íÁãÄÊÖãÔºåË©ï‰º∞ÊÜÇÈ¨±Á®ãÂ∫¶ÔºàÊåÅÁ∫åÊôÇÈñì„ÄÅÂö¥ÈáçÂ∫¶„ÄÅÂäüËÉΩÂΩ±ÈüøÔºâ');
                alerts.push('‚ö†Ô∏è Â¶ÇÁóáÁãÄÊåÅÁ∫åÂÖ©ÈÄ±‰ª•‰∏äÔºåÂª∫Ë≠∞Ë©ï‰º∞ÊòØÂê¶ÈúÄË¶ÅÁ≤æÁ•ûÁßëÊúÉË®∫');
            } else if (hasAnxiety) {
                alerts.push('‚ö†Ô∏è Ê°à‰∏ªÁÑ¶ÊÖÆÁ®ãÂ∫¶ËºÉÈ´òÔºåÊ≥®ÊÑèÁîüÁêÜÁóáÁãÄÔºàÂøÉË∑≥„ÄÅÂëºÂê∏„ÄÅËÇåËÇâÁ∑äÁπÉÔºâ');
            }

            // ‰∏ÄËà¨ÊèêÈÜí
            if (transcriptSegments.filter(s => s.speaker === 'counselor').length < transcriptSegments.length * 0.3) {
                alerts.push('üí° Ë´ÆË©¢Â∏´ÁôºË®ÄÊØî‰æãËºÉÂ∞ëÔºåÂèØÈÅ©Â∫¶ÂºïÂ∞éÂ∞çË©±ÊñπÂêë');
            }
            if (transcriptSegments.length > 10) {
                alerts.push('‚úÖ Â∞çË©±ÊåÅÁ∫åÈÄ≤Ë°å‰∏≠ÔºåÊ≥®ÊÑèÊôÇÈñìÁÆ°ÁêÜËàáÊúÉË´áÁµêÊßã');
            }

            // ÁîüÊàêÂª∫Ë≠∞
            const suggestions = [];
            if (hasSuicideRisk) {
                suggestions.push('üí° Áõ¥Êé•Ë©ï‰º∞Ôºö„ÄåÁï∂‰Ω†Ë™™‰∏çÊÉ≥Ê¥ª‰∫ÜÔºåÊòØÂê¶ÊõæÊÉ≥ÈÅéË¶ÅÂ¶Ç‰ΩïÁµêÊùüÁîüÂëΩÔºü„Äç');
                suggestions.push('üí° Ë©ï‰º∞‰øùË≠∑Âõ†Â≠êÔºö„ÄåÊúâ‰ªÄÈ∫º‰∫ãÊÉÖÊàñ‰∫∫ÔºåËÆì‰Ω†Âà∞ÁèæÂú®ÈÇÑÈ°òÊÑèÊ¥ªËëóÔºü„Äç');
                suggestions.push('üí° Âª∫Á´ãÂÆâÂÖ®Ë®àÁï´ÔºöËàáÊ°à‰∏ªË®éË´ñÂç±Ê©üÊôÇÂèØ‰ª•ÂÅö‰ªÄÈ∫º„ÄÅÂèØ‰ª•ÊâæË™∞');
            } else if (hasDepression && hasWork) {
                suggestions.push('üí° Êé¢Á¥¢Â∑•‰ΩúÂ£ìÂäõÊ∫êÔºö„ÄåÂ∑•‰Ωú‰∏≠Âì™‰∫õÂÖ∑È´îÊÉÖÊ≥ÅËÆì‰Ω†ÊÑüÂà∞ÁâπÂà•Ê≤ÆÂñ™Ôºü„Äç');
                suggestions.push('üí° Ë©ï‰º∞ÂäüËÉΩÂΩ±ÈüøÔºö„ÄåÈÄô‰∫õÊÑüÂèóÂ¶Ç‰ΩïÂΩ±Èüø‰Ω†ÁöÑÊó•Â∏∏ÁîüÊ¥ªÂíåÂ∑•‰ΩúË°®ÁèæÔºü„Äç');
                suggestions.push('üí° ÊâæÂá∫Âõ†ÊáâË≥áÊ∫êÔºö„ÄåÈÅéÂéªÈÅáÂà∞È°û‰ººÂõ∞Èõ£ÊôÇÔºå‰Ω†ÊòØÊÄéÈ∫ºÂ∫¶ÈÅéÁöÑÔºü„Äç');
            } else if (hasAnxiety) {
                suggestions.push('üí° ÂºïÂ∞éÂÖ∑È´îÂåñÔºö„ÄåÁï∂ÁÑ¶ÊÖÆÂá∫ÁèæÊôÇÔºå‰Ω†ÁöÑË∫´È´îÊúâ‰ªÄÈ∫ºÊÑüË¶∫Ôºü„Äç');
                suggestions.push('üí° ÊïôÂ∞éÊîæÈ¨ÜÊäÄÂ∑ßÔºöËÄÉÊÖÆÂºïÂÖ•ÂëºÂê∏Á∑¥ÁøíÊàñÊ≠£ÂøµÊäÄÂ∑ß');
                suggestions.push('üí° Êé¢Á¥¢ÁÑ¶ÊÖÆËß∏ÁôºÈªûÔºö„Äå‰ªÄÈ∫ºÊÉÖÊ≥Å‰∏ãÁÑ¶ÊÖÆÊÑüÊúÉÁâπÂà•Âº∑ÁÉàÔºü„Äç');
            } else if (hasWork) {
                suggestions.push('üí° ÂÖ∑È´îÂåñÊé¢Á¥¢Ôºö„ÄåÂèØ‰ª•Ë™™Ë™™ÊúÄËøë‰∏ÄÊ¨°Âõ∞ÊìæÁöÑÂÖ∑È´îÊÉÖÊ≥ÅÂóéÔºü„Äç');
                suggestions.push('üí° ÊÉÖÁ∑íÂèçÊò†Ôºö„ÄåËÅΩËµ∑‰æÜÈÄôËÆì‰Ω†ÊÑüÂà∞...ÔºàÊå´Êäò/ÊÜ§ÊÄí/ÁÑ°ÂäõÔºâ„Äç');
                suggestions.push('üí° Ë©ï‰º∞ÊîØÊåÅÁ≥ªÁµ±Ôºö„ÄåÂ∑•‰Ωú‰πãÂ§ñÔºå‰Ω†ÊúâÂèØ‰ª•Ë´áÂøÉÁöÑÂ∞çË±°ÂóéÔºü„Äç');
            } else {
                suggestions.push('üí° ÈñãÊîæÂºèÊèêÂïèÔºö„Äå‰ªäÂ§©ÊúÄÊÉ≥Ë´áÁöÑÊòØ‰ªÄÈ∫ºÔºü„Äç');
                suggestions.push('üí° Âª∫Á´ãÈóú‰øÇÔºö‰ΩøÁî®ÂêåÁêÜÂøÉÂõûÊáâÔºåËÆìÊ°à‰∏ªÊÑüÂà∞Ë¢´ÁêÜËß£');
                suggestions.push('üí° ÊæÑÊ∏ÖÁõÆÊ®ôÔºö„Äå‰Ω†Â∏åÊúõÈÄèÈÅéË´ÆË©¢ÈÅîÂà∞‰ªÄÈ∫ºÔºü„Äç');
            }

            return {
                summary: summary,
                alerts: alerts.slice(0, 3), // ÊúÄÂ§ö3ÂÄãË≠¶Á§∫
                suggestions: suggestions.slice(0, 3), // ÊúÄÂ§ö3ÂÄãÂª∫Ë≠∞
                time_range: timeRange,
                recording_timestamp: recordingTimestamp,
                timestamp: new Date().toISOString()
            };
        }

        function displayAnalysisCard(analysis) {
            // Build Safety Level configuration with radial gradient backgrounds
            let riskConfig = {
                'red': {
                    emoji: 'üî¥',
                    label: 'Âç±Èö™',
                    cardBg: 'bg-red-50',  // Fallback for web
                    gradientBg: 'radial-gradient(circle, #f9a8d4 0%, #fbcfe8 40%, #fce7f3 70%, #fdf2f8 100%)',  // Pink radial
                    borderColor: 'border-red-300',
                    headerBg: 'bg-white/10 backdrop-blur-sm',  // Transparent header
                    textColor: 'text-red-900',  // Darker for better contrast
                    title: 'Âç±Èö™ÔºöÁ´ãÂç≥‰øÆÊ≠£'
                },
                'yellow': {
                    emoji: 'üíõ',
                    label: 'Ë≠¶Á§∫',
                    cardBg: 'bg-yellow-50',  // Fallback for web
                    gradientBg: 'radial-gradient(circle, #fde047 0%, #fef08a 40%, #fef9c3 70%, #fefce8 100%)',  // Yellow radial
                    borderColor: 'border-yellow-300',
                    headerBg: 'bg-white/10 backdrop-blur-sm',  // Transparent header
                    textColor: 'text-yellow-900',  // Darker for better contrast
                    title: 'Ë≠¶Á§∫ÔºöÈúÄË¶ÅË™øÊï¥'
                },
                'green': {
                    emoji: 'üíö',
                    label: 'ÂÆâÂÖ®',
                    cardBg: 'bg-green-50',  // Fallback for web
                    gradientBg: 'radial-gradient(circle, #67e8f9 0%, #99f6e4 40%, #ccfbf1 70%, #f0fdfa 100%)',  // Teal/Cyan radial
                    borderColor: 'border-green-300',
                    headerBg: 'bg-white/10 backdrop-blur-sm',  // Transparent header
                    textColor: 'text-teal-900',  // Darker for better contrast
                    title: 'ÂÆâÂÖ®ÔºöÊ∫ùÈÄöËâØÂ•Ω'
                }
            };

            // Clear placeholder/empty state
            if (analysisEmpty) analysisEmpty.style.display = 'none';

            const card = document.createElement('div');

            // Use error styling if this is an error response
            const isError = analysis.is_error || (analysis.summary && analysis.summary.includes('Â§±Êïó'));

            // Get current risk config
            const currentRiskConfig = analysis.safety_level ? (riskConfig[analysis.safety_level] || riskConfig['green']) : riskConfig['green'];

            // Set card background and border based on safety level
            // Mobile: full-screen with radial gradient background
            // Desktop: right panel card with solid background
            const cardBgColor = currentRiskConfig.cardBg;
            const cardBorderColor = currentRiskConfig.borderColor;

            // Apply responsive classes
            // Mobile: fixed positioning for full-screen with radial gradient
            // Desktop: normal card in right panel with radial gradient
            card.className = `rounded-xl shadow-md hover:shadow-lg transition-shadow p-6 md:p-5 border-2 ${cardBorderColor} fade-in card-hover fixed md:relative inset-0 md:inset-auto z-50 md:z-auto overflow-y-auto md:overflow-visible`;

            // Apply radial gradient background for both mobile and desktop
            card.style.background = currentRiskConfig.gradientBg;

            // Determine severity for alerts
            const hasCritical = analysis.alerts.some(a => a.includes('üî¥') || a.includes('È´òÈ¢®Èö™'));
            const hasWarning = analysis.alerts.some(a => a.includes('‚ö†Ô∏è'));

            // Display model badge if provider_metadata is available
            const modelBadge = analysis.provider_metadata && analysis.provider_metadata.model
                ? `<span class="inline-flex items-center gap-1 px-2 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-medium">
                    <span>ü§ñ</span>
                    <span>${analysis.provider_metadata.model}</span>
                   </span>`
                : '';

            // Build token usage badge
            let tokenUsageBadge = '';
            if (analysis.cache_metadata) {
                // Gemini with cache - show actual token count
                const cache = analysis.cache_metadata;
                const totalTokens = cache.cached_tokens + cache.prompt_tokens;
                const cachePercentage = totalTokens > 0 ? Math.round((cache.cached_tokens / totalTokens) * 100) : 0;
                tokenUsageBadge = `<span class="inline-flex items-center gap-1 px-2 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-medium" title="Cache: ${cache.cached_tokens.toLocaleString()} | New: ${cache.prompt_tokens.toLocaleString()} | Cache Hit: ${cachePercentage}%">
                    <span>üéØ</span>
                    <span>${cache.cached_tokens.toLocaleString()} by cache</span>
                   </span>`;
            } else if (analysis.provider_metadata) {
                // Check provider type
                if (analysis.provider_metadata.provider === 'codeer') {
                    // Codeer with real token usage
                    if (analysis.provider_metadata.codeer_token_usage) {
                        const tokens = analysis.provider_metadata.codeer_token_usage;
                        tokenUsageBadge = `<span class="inline-flex items-center gap-1 px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-medium" title="Prompt: ${tokens.total_prompt_tokens.toLocaleString()} | Completion: ${tokens.total_completion_tokens.toLocaleString()} | Calls: ${tokens.total_calls}">
                            <span>üìä</span>
                            <span>${tokens.total_tokens.toLocaleString()} tokens</span>
                           </span>`;
                    } else {
                        // Fallback if token usage is not available
                        tokenUsageBadge = `<span class="inline-flex items-center gap-1 px-2 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-medium" title="Token usage unavailable">
                            <span>üìä</span>
                            <span>ÁÑ°Ë≥áÊñô</span>
                           </span>`;
                    }
                } else if (analysis.provider_metadata.provider === 'gemini') {
                    // Gemini without cache (content too short)
                    tokenUsageBadge = `<span class="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-600 rounded-full text-xs font-medium" title="Â∞çË©±ËºÉÁü≠ÔºåÊú™ÂïüÁî® cache">
                        <span>üí¨</span>
                        <span>0 by cache</span>
                       </span>`;
                }
            }

            // Build RAG badge based on actual usage
            let ragBadge = '';
            if (analysis.rag_sources && analysis.rag_sources.length > 0) {
                // Has RAG sources - show green checkmark
                ragBadge = `<span class="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium" title="‰ΩøÁî®Áü•Ë≠òÂ∫´Ôºö${analysis.rag_sources.length} Á≠ÜË≥áÊñô">
                    <span>‚úÖ</span>
                    <span>RAG</span>
                   </span>`;
            } else {
                // No RAG sources - show gray X
                ragBadge = `<span class="inline-flex items-center gap-1 px-2 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-medium" title="Êú™‰ΩøÁî®Áü•Ë≠òÂ∫´">
                    <span>‚ùå</span>
                    <span>RAG</span>
                   </span>`;
            }

            card.innerHTML = `
                <!-- Safety Level Header - Prominent Display -->
                <div class="flex items-center justify-between ${currentRiskConfig.headerBg} -mx-6 -mt-6 md:-mx-5 md:-mt-5 px-6 py-4 md:px-5 md:py-3 rounded-t-xl mb-4 border-b-2 ${currentRiskConfig.borderColor}">
                    <div class="flex items-center gap-3">
                        <span class="text-5xl md:text-4xl">${currentRiskConfig.emoji}</span>
                        <div>
                            <div class="font-bold text-xl md:text-lg ${currentRiskConfig.textColor}">${currentRiskConfig.label}</div>
                            <div class="text-sm md:text-xs ${currentRiskConfig.textColor} opacity-75">${currentRiskConfig.title}</div>
                        </div>
                    </div>
                    <span class="text-xs text-gray-500">${new Date(analysis.timestamp).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })}</span>
                </div>

                <!-- Meta Information - Collapsible -->
                <details class="mb-3">
                    <summary class="cursor-pointer text-xs text-gray-500 hover:text-gray-700 transition-colors inline-flex items-center gap-1">
                        <span>Ë©≥Á¥∞Ë≥áË®ä</span>
                        <span class="text-[10px]">‚ñº</span>
                    </summary>
                    <div class="flex items-center gap-2 flex-wrap mt-2 pt-2 border-t border-gray-200/50">
                        <span class="inline-block px-3 py-1 bg-purple-100/50 text-purple-700 text-xs font-semibold rounded-full">
                            ${analysis.time_range}
                        </span>
                        ${analysis.recording_timestamp ? `
                            <span class="inline-flex items-center gap-1 px-2 py-1 bg-teal-100/50 text-teal-700 rounded-full text-xs font-medium">
                                <span>‚è±</span>
                                <span>${analysis.recording_timestamp}</span>
                            </span>
                        ` : ''}
                        ${modelBadge}
                        ${tokenUsageBadge}
                        ${ragBadge}
                    </div>
                </details>

                <!-- Summary Section (Practice mode only) -->
                ${analysis.alerts && analysis.alerts.length > 0 ? `
                <div class="mb-4">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-6 h-6 bg-blue-100 rounded flex items-center justify-center">
                            üìã
                        </div>
                        <h3 class="font-bold text-sm md:text-base text-gray-800">ÊëòË¶Å</h3>
                    </div>
                    <p class="text-sm text-gray-700 leading-relaxed pl-8">${analysis.summary}</p>
                </div>

                <!-- Alerts Section -->
                ` : ''}
                ${analysis.alerts && analysis.alerts.length > 0 ? `
                    <div class="mb-4">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-6 h-6 ${hasCritical ? 'bg-red-100' : 'bg-yellow-100'} rounded flex items-center justify-center">
                                ${hasCritical ? 'üî¥' : '‚ö†Ô∏è'}
                            </div>
                            <h3 class="font-bold text-sm md:text-base text-gray-800">Ë≠¶Á§∫</h3>
                        </div>
                        <div class="space-y-2 pl-8">
                            ${analysis.alerts.map(alert => {
                                const isCritical = alert.includes('üî¥') || alert.includes('È´òÈ¢®Èö™');
                                const isWarning = alert.includes('‚ö†Ô∏è');
                                const bgColor = isCritical ? 'bg-red-50 border-red-200' : isWarning ? 'bg-yellow-50 border-yellow-200' : 'bg-blue-50 border-blue-200';
                                const textColor = isCritical ? 'text-red-700' : isWarning ? 'text-yellow-700' : 'text-blue-700';
                                const badgeClass = isCritical ? 'badge-critical' : isWarning ? 'badge-warning' : 'badge-info';
                                const severity = isCritical ? 'È´ò' : isWarning ? '‰∏≠' : '‰Ωé';

                                return `
                                    <div class="flex items-start gap-2 p-2 ${bgColor} rounded-lg border transition-smooth hover:shadow-sm">
                                        <span class="px-2 py-0.5 ${badgeClass} text-white text-xs rounded font-bold shadow-sm">${severity}</span>
                                        <p class="text-xs md:text-sm ${textColor} flex-1 leading-relaxed">${alert}</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- Suggestions Section -->
                ${analysis.suggestions.length > 0 ? `
                    <div class="mb-4">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-6 h-6 bg-green-100 rounded flex items-center justify-center">
                                üí°
                            </div>
                            <h3 class="font-bold text-sm md:text-base text-gray-800">Âç≥ÊôÇÂª∫Ë≠∞</h3>
                            <span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded-full font-medium">ÂàÜÊûêÂÆåÊàê</span>
                        </div>
                        <div class="space-y-2">
                            ${analysis.suggestions.map(sug => {
                                // Unified single-line format for all suggestions (200 expert suggestions)
                                return `
                                    <div class="p-4 md:p-6 bg-white/10 backdrop-blur-sm rounded-lg hover:bg-white/20 transition-smooth cursor-pointer">
                                        <p class="text-xl md:text-2xl text-green-900 leading-relaxed font-semibold">${sug}</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- RAG Knowledge Sources Section -->
                ${analysis.rag_sources && analysis.rag_sources.length > 0 ? `
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-6 h-6 bg-purple-100 rounded flex items-center justify-center">
                                üìö
                            </div>
                            <h3 class="font-bold text-sm md:text-base text-gray-800">ÂèÉËÄÉÁêÜË´ñ</h3>
                        </div>
                        <div class="space-y-2 pl-8">
                            ${analysis.rag_sources.map(source => {
                                // Theory-based color mapping
                                const theoryColors = {
                                    'Ê≠£ÂêëÊïôÈ§ä': { bg: 'bg-purple-50', border: 'border-purple-300', badge: 'bg-purple-500', text: 'text-purple-700' },
                                    'ÊÉÖÁ∑íÊïôÈ§ä': { bg: 'bg-blue-50', border: 'border-blue-300', badge: 'bg-blue-500', text: 'text-blue-700' },
                                    '‰æùÈôÑÁêÜË´ñ': { bg: 'bg-green-50', border: 'border-green-300', badge: 'bg-green-500', text: 'text-green-700' },
                                    'Ë™çÁü•ÁôºÂ±ïÁêÜË´ñ': { bg: 'bg-orange-50', border: 'border-orange-300', badge: 'bg-orange-500', text: 'text-orange-700' },
                                    'Ëá™ÊàëÊ±∫ÂÆöË´ñ': { bg: 'bg-pink-50', border: 'border-pink-300', badge: 'bg-pink-500', text: 'text-pink-700' },
                                    'ÂÖ∂‰ªñ': { bg: 'bg-gray-50', border: 'border-gray-300', badge: 'bg-gray-500', text: 'text-gray-700' }
                                };
                                const colors = theoryColors[source.theory] || theoryColors['ÂÖ∂‰ªñ'];

                                return `
                                    <div class="p-3 ${colors.bg} border ${colors.border} rounded-lg hover:shadow-sm transition-smooth">
                                        <div class="flex items-start gap-2 mb-2">
                                            <span class="inline-flex items-center px-2 py-1 ${colors.badge} text-white text-xs font-semibold rounded-full shadow-sm">
                                                ${source.theory}
                                            </span>
                                            <span class="inline-flex items-center px-2 py-0.5 bg-white/80 text-gray-600 text-xs rounded-full">
                                                Áõ∏‰ººÂ∫¶ ${(source.score * 100).toFixed(0)}%
                                            </span>
                                        </div>
                                        <p class="text-xs font-semibold ${colors.text} mb-1">${source.title}</p>
                                        <p class="text-xs ${colors.text} opacity-80 leading-relaxed">${source.content}</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}
            `;

            // Display provider metadata if available
            if (analysis.provider_metadata) {
                const meta = analysis.provider_metadata;
                const latencySpan = document.getElementById('providerLatency');
                const latencySpanDesktop = document.getElementById('providerLatencyDesktop');

                const latencyText = `${(meta.latency_ms / 1000).toFixed(1)}s`;

                if (latencySpan) {
                    latencySpan.textContent = latencyText;
                    latencySpan.classList.remove('hidden');
                }

                if (latencySpanDesktop) {
                    latencySpanDesktop.textContent = latencyText;
                    latencySpanDesktop.classList.remove('hidden');
                }

                console.log(`Provider: ${meta.provider}, Latency: ${meta.latency_ms}ms, Model: ${meta.model}`);
            }

            // Desktop: Animate card entrance
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            analysisCards.insertBefore(card, analysisCards.firstChild);

            setTimeout(() => {
                card.style.transition = 'all 0.3s ease-out';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, 10);

            // REQUIREMENT 6: Mobile carousel implementation
            // Always create mobile card (regardless of current screen size)
            // This ensures cards persist when switching between desktop/mobile views
            if (mobileCarouselTrack) {
                // Hide initial UI when first analysis appears
                if (initialUI && mobileAnalysisCards.length === 0) {
                    initialUI.classList.add('hidden');
                }
                // Also hide practice intro UI
                if (practiceIntroUI && mobileAnalysisCards.length === 0) {
                    practiceIntroUI.classList.add('hidden');
                }

                // Show carousel container
                if (mobileCarousel) {
                    mobileCarousel.classList.remove('hidden');
                }

                // Create mobile card (full width and height for carousel)
                const mobileCard = document.createElement('div');
                mobileCard.className = 'flex-shrink-0 w-full h-full bg-white rounded-2xl shadow-md p-5 border-l-4 border-purple-500 overflow-y-auto';
                mobileCard.innerHTML = card.innerHTML;

                // Add to carousel track (append to maintain chronological order)
                // Index 0 = oldest (1/4), Index length-1 = newest (4/4)
                mobileCarouselTrack.appendChild(mobileCard);
                mobileAnalysisCards.push(analysis);

                // Jump to newest card (last index)
                currentCarouselIndex = mobileAnalysisCards.length - 1;
                updateCarousel();
            }

            // Save to history
            analysisHistory.push(analysis);

            // Update mobile suggestion circle with first suggestion
            if (analysis.suggestions && analysis.suggestions.length > 0) {
                const safetyLevel = analysis.safety_level || 'green';
                console.log(`üîç displayAnalysisCard: About to call updateMobileSuggestionCircle`);
                console.log(`üîç - safety_level: "${safetyLevel}"`);
                console.log(`üîç - suggestions[0]: "${analysis.suggestions[0]}"`);
                console.log(`üîç - suggestions array length: ${analysis.suggestions.length}`);
                updateMobileSuggestionCircle(safetyLevel, analysis.suggestions[0]);
            } else {
                console.log(`‚ö†Ô∏è displayAnalysisCard: No suggestions found in analysis`);
                console.log(`üîç - analysis.suggestions:`, analysis.suggestions);
            }
        }

        function showError(message) {
            const card = document.createElement('div');
            card.className = 'bg-red-50 rounded-lg p-4 border-l-4 border-red-500';
            card.innerHTML = `<p class="text-sm text-red-700">‚ùå ${message}</p>`;
            analysisCards.insertBefore(card, analysisCards.firstChild);
        }

        // === Auto-Analysis Notification ===
        function showAutoAnalysisNotification(isQuickAnalysis = false) {
            // Different styles for quick vs deep analysis
            const bgGradient = isQuickAnalysis
                ? 'from-yellow-400 to-yellow-200'  // Quick: Yellow gradient
                : 'from-purple-500 to-indigo-600'; // Deep: Purple-blue gradient

            const textColor = isQuickAnalysis
                ? 'text-yellow-900'  // Darker text for yellow background
                : 'text-white';      // White text for purple background

            const message = isQuickAnalysis
                ? '‚ö° Âø´ÈÄüÂàÜÊûê‰∏≠...'
                : '‚ö° Ëá™ÂãïÂàÜÊûê‰∏≠...';

            // Create toast notification
            const toast = document.createElement('div');
            toast.className = `fixed top-20 right-4 bg-gradient-to-r ${bgGradient} ${textColor} px-6 py-3 rounded-lg shadow-xl z-50 flex items-center gap-2 animate-slide-in-right`;
            toast.innerHTML = `
                <span class="text-lg">‚ö°</span>
                <span class="font-medium">${message}</span>
            `;

            document.body.appendChild(toast);

            // Auto-remove after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                toast.style.transition = 'all 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // === Manual Analysis Triggers ===
        function manuallyTriggerAnalysis() {
            if (transcriptSegments.length === 0) {
                showModal('ÁÑ°Ê≥ïÂàÜÊûê', 'Ë´ãÂÖàÊåâ T ÈçµÊñ∞Â¢ûÂ∞çË©±ÂÖßÂÆπ', 'info');
                return;
            }
            analyzeTranscript();
        }

        // === localStorage Management ===
        function saveToHistory() {
            const session = {
                timestamp: new Date().toISOString(),
                duration: timer.textContent,
                transcript: transcriptSegments,
                analyses: analysisHistory
            };

            const history = JSON.parse(localStorage.getItem('realtimeCounselingHistory') || '[]');
            history.unshift(session);

            // Keep last 10 sessions
            localStorage.setItem('realtimeCounselingHistory', JSON.stringify(history.slice(0, 10)));
        }

        function toggleHistory() {
            const section = document.getElementById('historySection');
            const toggle = document.getElementById('historyToggle');

            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                toggle.textContent = '‚ñ≤';
                toggle.style.transform = 'rotate(180deg)';
                loadHistory();
            } else {
                section.classList.add('hidden');
                toggle.textContent = '‚ñº';
                toggle.style.transform = 'rotate(0deg)';
            }
        }

        function toggleTranscript() {
            const section = document.getElementById('transcriptSection');
            const toggle = document.getElementById('transcriptToggle');

            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                toggle.textContent = '‚ñ≤';
                toggle.style.transform = 'rotate(180deg)';
            } else {
                section.classList.add('hidden');
                toggle.textContent = '‚ñº';
                toggle.style.transform = 'rotate(0deg)';
            }
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('realtimeCounselingHistory') || '[]');
            const list = document.getElementById('historyList');

            if (history.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-8">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <span class="text-3xl">üìÇ</span>
                        </div>
                        <p class="text-gray-400 font-medium">Â∞öÁÑ°Ê≠∑Âè≤Ë®òÈåÑ</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = history.map((session, index) => `
                <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-4 border border-gray-200 hover:shadow-md transition-smooth">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <span class="w-8 h-8 bg-indigo-500 text-white rounded-lg flex items-center justify-center text-sm font-bold">#${index + 1}</span>
                            <div>
                                <p class="font-bold text-gray-800 text-sm">${new Date(session.timestamp).toLocaleString('zh-TW', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                                <p class="text-xs text-gray-500">ÊúÉË´áÊôÇÈï∑Ôºö${session.duration}</p>
                            </div>
                        </div>
                        <span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full font-bold">
                            ${session.analyses.length} Ê¨°ÂàÜÊûê
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function clearHistory() {
            if (confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÊ≠∑Âè≤Ë®òÈåÑÂóéÔºü')) {
                localStorage.removeItem('realtimeCounselingHistory');
                loadHistory();
            }
        }

        // === REQUIREMENT 6: Carousel Navigation Functions ===
        function navigateCarousel(direction) {
            if (mobileAnalysisCards.length === 0) return;

            currentCarouselIndex += direction;

            // Wrap around
            if (currentCarouselIndex < 0) {
                currentCarouselIndex = mobileAnalysisCards.length - 1;
            } else if (currentCarouselIndex >= mobileAnalysisCards.length) {
                currentCarouselIndex = 0;
            }

            updateCarousel();
        }

        function updateCarousel() {
            if (!mobileCarouselTrack || mobileAnalysisCards.length === 0) return;

            // Update transform to show current card
            const offset = -currentCarouselIndex * 100;
            mobileCarouselTrack.style.transform = `translateX(${offset}%)`;

            // Update counter
            if (carouselCounter) {
                carouselCounter.textContent = `${currentCarouselIndex + 1} / ${mobileAnalysisCards.length}`;
            }

            // Update button states
            if (carouselPrev && carouselNext) {
                // Enable/disable buttons based on position
                if (mobileAnalysisCards.length <= 1) {
                    carouselPrev.disabled = true;
                    carouselNext.disabled = true;
                } else {
                    carouselPrev.disabled = false;
                    carouselNext.disabled = false;
                }
            }
        }

        // === Report Screen: Populate Report Function (NEW - Using API Data) ===
        function populateReportFromAPI(reportData) {
            if (!highlightCards) return;

            console.log('üìä Populating report with API data:', reportData);

            // Populate summary
            const summaryElement = document.getElementById('reportSummary');
            if (summaryElement && reportData.summary) {
                summaryElement.textContent = reportData.summary;
            }

            // Clear existing cards
            highlightCards.innerHTML = '';

            // Create highlight cards from API response
            const highlights = reportData.highlights || [];

            highlights.forEach((highlight, index) => {
                const card = document.createElement('div');
                card.className = 'bg-amber-50 rounded-2xl p-6 shadow-sm border border-amber-100 relative';
                card.innerHTML = `
                    <p class="text-gray-800 leading-relaxed pr-12">${highlight}</p>
                    <div class="absolute top-4 right-4 w-8 h-8 bg-green-600 rounded-full flex items-center justify-center">
                        <span class="text-white text-xl">‚úì</span>
                    </div>
                `;
                highlightCards.appendChild(card);
            });

            // Add improvement suggestions section (if we want to show them)
            if (reportData.improvements && reportData.improvements.length > 0) {
                const improvementsSection = document.createElement('div');
                improvementsSection.className = 'mt-8';
                improvementsSection.innerHTML = `
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üí° ÂèØ‰ª•Êõ¥Â•ΩÁöÑÂú∞Êñπ</h2>
                    <div class="space-y-4">
                        ${reportData.improvements.map(item => `
                            <div class="bg-blue-50 rounded-2xl p-6 border border-blue-100">
                                <p class="text-gray-700 font-medium mb-2">üìå ${item.issue}</p>
                                <p class="text-gray-600 pl-6">üí¨ ${item.suggestion}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
                highlightCards.parentElement.appendChild(improvementsSection);
            }

            // Log RAG references (could be displayed later if needed)
            if (reportData.rag_references && reportData.rag_references.length > 0) {
                console.log('üìö RAG References:', reportData.rag_references);
            }
        }

        // === LEGACY: Old populate function (kept for fallback) ===
        function populateReport() {
            if (!highlightCards) return;

            // Clear existing cards
            highlightCards.innerHTML = '';

            // Extract highlights from analysis cards
            const highlights = [];

            // Get data from mobileAnalysisCards array
            mobileAnalysisCards.forEach(card => {
                // Extract suggestions from each analysis card
                const suggestions = card.querySelectorAll('.suggestion-card');
                suggestions.forEach(suggestion => {
                    const text = suggestion.textContent.trim();
                    if (text && text.length > 0) {
                        highlights.push(text);
                    }
                });

                // Also extract from analysis text if available
                const analysisText = card.querySelector('.analysis-content');
                if (analysisText) {
                    const text = analysisText.textContent.trim();
                    // Split by common delimiters and extract key points
                    const points = text.split(/[„ÄÇÔºÅ]/g).filter(p => p.trim().length > 10);
                    points.forEach(point => {
                        if (point.trim() && !highlights.includes(point.trim())) {
                            highlights.push(point.trim());
                        }
                    });
                }
            });

            // Fallback: Create default highlights if none found
            if (highlights.length === 0) {
                highlights.push(
                    '‰Ω†ÊúâË©¶ËëóË™™ÊòéËá™Â∑±Âú®ÊÑèÁöÑÊòØ„ÄéÊú™‰æÜ„ÄèËÄå‰∏çÊòØÂè™Ë™™ÊàêÁ∏æ„ÄÇ',
                    '‰Ω†Âú®Â∞çË©±‰∏≠Ë°®ÁèæÂá∫È°òÊÑèÁêÜËß£Â≠©Â≠êÁöÑÊÖãÂ∫¶„ÄÇ',
                    '‰Ω†ÂòóË©¶Áî®ËºÉÊ∫´ÂíåÁöÑÊñπÂºèÈñãÂïüÂ∞çË©±„ÄÇ'
                );
            }

            // Limit to maximum 5 highlights
            const displayHighlights = highlights.slice(0, 5);

            // Create cards for each highlight
            displayHighlights.forEach((highlight, index) => {
                const card = document.createElement('div');
                card.className = 'bg-amber-50 rounded-2xl p-6 shadow-sm border border-amber-100 relative';
                card.innerHTML = `
                    <p class="text-gray-800 leading-relaxed pr-12">${highlight}</p>
                    <div class="absolute top-4 right-4 w-8 h-8 bg-green-600 rounded-full flex items-center justify-center">
                        <span class="text-white text-xl">‚úì</span>
                    </div>
                `;
                highlightCards.appendChild(card);
            });
        }

        // Add swipe gesture support for carousel
        if (mobileCarouselTrack) {
            let touchStartX = 0;
            let touchEndX = 0;

            mobileCarouselTrack.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            mobileCarouselTrack.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, { passive: true });

            function handleSwipe() {
                const swipeThreshold = 50; // minimum distance for swipe
                const diff = touchStartX - touchEndX;

                if (Math.abs(diff) < swipeThreshold) return;

                if (diff > 0) {
                    // Swipe left ‚Üí earlier time (lower index)
                    navigateCarousel(-1);
                } else {
                    // Swipe right ‚Üí later time (higher index)
                    navigateCarousel(1);
                }
            }
        }

        // === Demo Mode (Simulate transcript input) ===
        let demoScriptIndex = 0;
        const demoScripts = {
            // ÂäáÊú¨ 1: Â∑•‰ΩúÂ£ìÂäõËàáÁÑ¶ÊÖÆÔºàÂê´Ëá™ÊÆ∫È¢®Èö™Ë©ï‰º∞Ôºâ- 30ÂàÜÈêòÂÆåÊï¥Áâà
            // ÊØèÂè•Ë©±ÈÉΩÊúâÊôÇÈñìÊà≥ÔºàÁßíÔºâÔºåÁî®ÊñºÂêåÊ≠•Èü≥Ë®äÊí≠Êîæ
            workStress: [
                // Phase 1: ÈñãÂ†¥ËàáÂª∫Á´ãÈóú‰øÇ (0-5ÂàÜÈêò)
                { speaker: 'counselor', text: '‰Ω†Â•ΩÔºå‰ªäÂ§©ÊÉ≥ËÅä‰ªÄÈ∫ºÂë¢Ôºü', time: 2 },
                { speaker: 'client', text: 'ÊàëÊúÄËøëÂ∑•‰ΩúÂ£ìÂäõÂæàÂ§ßÔºåÂ∏∏Â∏∏ÁÑ¶ÊÖÆÂà∞Áù°‰∏çËëó...', time: 6 },
                { speaker: 'counselor', text: 'ËÅΩËµ∑‰æÜÂ£ìÂäõÁúüÁöÑÂæàÂ§ß„ÄÇËÉΩË∑üÊàëÂ§öË™™‰∏Ä‰∫õÔºå‰Ω†ÈÉΩÂπæÈªûÁù°Ë¶∫Ôºü', time: 12 },
                { speaker: 'client', text: 'ÊàëÂ∏∏Â∏∏Ë∫∫Âú®Â∫ä‰∏äÁøª‰æÜË¶ÜÂéªÂà∞ÂáåÊô®ÂÖ©„ÄÅ‰∏âÈªû„ÄÇ', time: 18 },
                { speaker: 'counselor', text: 'Â§±Áú†Â∞ç‰Ω†ÁöÑÂΩ±Èüø‰∏ÄÂÆöÂæàÂ§ß„ÄÇ‰Ω†Ë∫∫Âú®Â∫ä‰∏äÁöÑÊôÇÂÄôÔºåËÖ¶Ë¢ãÈÉΩÂú®ÊÉ≥‰ªÄÈ∫ºÔºü', time: 24 },
                { speaker: 'client', text: 'Â∞±ÊÉ≥ËëóÊòéÂ§©ÁöÑÂ∑•‰ΩúÔºåÊÉ≥ËëóÊàëÂèàË¶ÅÈù¢Â∞ç‰∏ªÁÆ°...', time: 31 },
                { speaker: 'counselor', text: '‰∏ªÁÆ°ÊòØ‰Ω†Â£ìÂäõÁöÑ‰∏ªË¶Å‰æÜÊ∫êÂóéÔºü', time: 37 },
                { speaker: 'client', text: 'Â∞çÔºåÊàëË¶∫Âæó‰∏çÁÆ°ÊÄéÈ∫ºÂÅöÔºå‰ªñÈÉΩ‰∏çÊªøÊÑè„ÄÇ', time: 41 },
                { speaker: 'counselor', text: 'ÈÄôËÆì‰Ω†ÊÑüÂà∞ÂæàÊå´ÊäòÔºåÊòØÂóéÔºüËÉΩËàâÂÄãÊúÄËøëÁöÑ‰æãÂ≠êÂóéÔºü', time: 47 },
                { speaker: 'client', text: '‰∏äÁ¶ÆÊãúÊàëÁÜ¨Â§úË∂ïÂá∫‰æÜÁöÑ‰ºÅÂäÉÊ°àÔºå‰ªñÂè™Áúã‰∫ÜÂÖ©ÂàÜÈêòÂ∞±Ë™™Ë¶ÅÈáçÂÅö„ÄÇ', time: 54 },
                { speaker: 'counselor', text: '‰Ω†ÈÇ£ÊôÇÂÄôÁöÑÊÑüÂèóÊòØ‰ªÄÈ∫ºÔºü', time: 62 },
                { speaker: 'client', text: 'ÊàëÁï∂‰∏ãÁúüÁöÑÂæàÁîüÊ∞£Ôºå‰ΩÜÂèà‰∏çÊï¢Ë™™‰ªÄÈ∫ºÔºåÂ∞±Âêû‰∏ã‰æÜ‰∫Ü„ÄÇ', time: 66 },
                { speaker: 'counselor', text: 'ÁîüÊ∞£‰ΩÜÂèà‰∏çËÉΩË°®ÈÅîÔºåÈÄôÁ®ÆÊÑüË¶∫‰∏ÄÂÆöÂæàÈõ£Âèó„ÄÇ', time: 73 },
                { speaker: 'client', text: 'Â∞ç...ÊàëÂõûÂà∞Â∫ß‰Ωç‰∏äÁúºÊ∑öÂ∞±Êéâ‰∏ã‰æÜ‰∫ÜÔºåÈÇÑÂ•ΩÊ≤í‰∫∫ÁúãÂà∞„ÄÇ', time: 79 },

                // Phase 2: Êé¢Á¥¢Â∑•‰ΩúÂ£ìÂäõËàáÊÉÖÁ∑í (5-12ÂàÜÈêò)
                { speaker: 'counselor', text: 'ÈÄôÁ®ÆÊÉÖÊ≥ÅÊåÅÁ∫åÂ§ö‰πÖ‰∫ÜÔºü', time: 86 },
                { speaker: 'client', text: 'Â§ßÊ¶ÇÂçäÂπ¥ÂêßÔºåÂæû‰ªñË™ø‰æÜÁï∂ÊàëÂÄë‰∏ªÁÆ°‰πãÂæå„ÄÇ', time: 90 },
                { speaker: 'counselor', text: 'ÈÄôÂçäÂπ¥‰æÜÔºå‰Ω†ÁöÑÂ∑•‰ΩúÂíåÁîüÊ¥ªÊúâ‰ªÄÈ∫ºÊîπËÆäÂóéÔºü', time: 96 },
                { speaker: 'client', text: 'ÊàëËÆäÂæóÂæàÊ≤íËá™‰ø°ÔºåÂ∏∏Â∏∏Êá∑ÁñëËá™Â∑±ÁöÑËÉΩÂäõ...', time: 102 },
                { speaker: 'counselor', text: 'Áï∂‰Ω†Ë™™„ÄåÊá∑ÁñëËá™Â∑±„ÄçÔºåÂÖ∑È´îÊòØÊåá‰ªÄÈ∫ºÂë¢Ôºü', time: 108 },
                { speaker: 'client', text: 'ÊàëË¶∫ÂæóËá™Â∑±‰ªÄÈ∫ºÈÉΩÂÅö‰∏çÂ•ΩÔºåÂèØËÉΩÊ†πÊú¨‰∏çÈÅ©ÂêàÈÄô‰ªΩÂ∑•‰Ωú„ÄÇ', time: 114 },
                { speaker: 'counselor', text: 'Âú®ÈÄôÂÄã‰∏ªÁÆ°‰æÜ‰πãÂâçÔºå‰Ω†Â∞çËá™Â∑±ÁöÑÂ∑•‰ΩúË°®ÁèæÊúâÈÄôÊ®£ÁöÑÊÑüË¶∫ÂóéÔºü', time: 121 },
                { speaker: 'client', text: 'Ê≤íÊúâ...‰ª•ÂâçÊàëÂÅöÂæóÈÇÑ‰∏çÈåØÔºåÂâç‰∏ÄÂÄã‰∏ªÁÆ°ÈÇÑÊªøËÇØÂÆöÊàëÁöÑ„ÄÇ', time: 128 },
                { speaker: 'counselor', text: 'ÊâÄ‰ª•ÈÄôÂÄãÊá∑ÁñëÔºå‰∏ªË¶ÅÊòØÊúÄËøëÈÄôÂçäÂπ¥ÊâçÈñãÂßãÁöÑ„ÄÇ', time: 135 },
                { speaker: 'client', text: 'Â∞çÔºåÊàëÁèæÂú®ÈÄ£Á∞°ÂñÆÁöÑ‰∫ãÊÉÖÈÉΩÊúÉÂÆ≥ÊÄïÂÅöÈåØ„ÄÇ', time: 141 },
                { speaker: 'counselor', text: 'ÈÄôÁ®ÆÂÆ≥ÊÄïÔºåÈô§‰∫ÜÂú®Â∑•‰Ωú‰∏äÔºåÊúÉ‰∏çÊúÉÂΩ±ÈüøÂà∞‰Ω†ÁöÑÁîüÊ¥ªÂÖ∂‰ªñÈÉ®ÂàÜÔºü', time: 147 },
                { speaker: 'client', text: 'ÊúÉ...ÊàëÁèæÂú®‰∏çÂ§™ÊÉ≥Ë∑üÊúãÂèãÂá∫ÂéªÔºå‰πü‰∏çÊÉ≥Ë∑üÂÆ∂‰∫∫ËÅäÂ§©„ÄÇ', time: 154 },
                { speaker: 'counselor', text: 'ËÅΩËµ∑‰æÜ‰Ω†ÊúâÈªûÊääËá™Â∑±Â≠§Á´ãËµ∑‰æÜ‰∫Ü„ÄÇ', time: 161 },
                { speaker: 'client', text: 'ÊàëÂè™ÊòØË¶∫ÂæóÂæàÁ¥ØÔºå‰∏çÊÉ≥ËÆìÂà•‰∫∫ÁúãÂà∞ÊàëÈÄôÂÄãÊ®£Â≠ê„ÄÇ', time: 166 },
                { speaker: 'counselor', text: '‰Ω†ÊìîÂøÉÂà•‰∫∫ÊÄéÈ∫ºÁúã‰Ω†Ôºü', time: 172 },
                { speaker: 'client', text: 'ÊÄï‰ªñÂÄëË¶∫ÂæóÊàëÂæàÂº±ÔºåÈÄ£Â∑•‰ΩúÈÉΩÂÅö‰∏çÂ•Ω„ÄÇ', time: 176 },
                { speaker: 'counselor', text: 'Èô§‰∫ÜÁñ≤Á¥ØÂíåÂÆ≥ÊÄïÔºå‰Ω†ÈÇÑÊúâÂÖ∂‰ªñË∫´È´îÁöÑÊÑüË¶∫ÂóéÔºü', time: 182 },
                { speaker: 'client', text: 'ÊàëÂ∏∏Â∏∏ËÉ∏ÊÇ∂ÔºåÊúâÊôÇÂÄôÊúÉÁ™ÅÁÑ∂Âñò‰∏çÈÅéÊ∞£„ÄÇ', time: 188 },
                { speaker: 'counselor', text: 'ÈÄôËÅΩËµ∑‰æÜÂÉèÊòØÁÑ¶ÊÖÆÁôº‰Ωú„ÄÇÁôº‰ΩúÁöÑÊôÇÂÄô‰Ω†ÊúÉÊÄéÈ∫ºÂÅöÔºü', time: 194 },
                { speaker: 'client', text: 'ÊàëÂ∞±...Ë∫≤Âà∞ÂªÅÊâÄÊ∑±ÂëºÂê∏ÔºåÁ≠âÂÆÉÈÅéÂéª„ÄÇ', time: 200 },
                { speaker: 'counselor', text: '‰Ω†ÊúâË©¶ÈÅéÂÖ∂‰ªñÊñπÊ≥ïÂóéÔºüÊàñÊòØÊúâË∑üË™∞Ë´áÈÅéÈÄô‰ª∂‰∫ãÔºü', time: 206 },
                { speaker: 'client', text: 'Ê≤íÊúâ...Êàë‰∏çÁü•ÈÅìË¶ÅË∑üË™∞Ë™™„ÄÇ', time: 212 },

                // Phase 3: ÊÜÇÈ¨±ÁóáÁãÄÊµÆÁèæ (12-17ÂàÜÈêò)
                { speaker: 'counselor', text: 'Èô§‰∫ÜÁù°Áú†ÂïèÈ°åÂíåÁÑ¶ÊÖÆÔºå‰Ω†ÁöÑËÉÉÂè£ÊúâÊîπËÆäÂóéÔºü', time: 218 },
                { speaker: 'client', text: 'ÊàëÊúÄËøëÈÉΩ‰∏çÂ§™ÊÉ≥ÂêÉÊù±Ë•øÔºåÈ´îÈáçÊéâ‰∫Ü‰∫î„ÄÅÂÖ≠ÂÖ¨Êñ§„ÄÇ', time: 224 },
                { speaker: 'counselor', text: 'ÈÇ£‰Ω†Âπ≥Â∏∏ÊúâÊ≤íÊúâ‰ªÄÈ∫º‰∫ãÊÉÖÊòØËÆì‰Ω†ÈñãÂøÉÁöÑÔºü', time: 231 },
                { speaker: 'client', text: '‰ª•ÂâçÊàëÂæàÂñúÊ≠°Áï´Áï´Ôºå‰ΩÜÁèæÂú®ÂÆåÂÖ®Êèê‰∏çËµ∑ÂãÅ„ÄÇ', time: 236 },
                { speaker: 'counselor', text: 'ÈÄ£ÂéüÊú¨ÂñúÊ≠°ÁöÑ‰∫ãÊÉÖÈÉΩÂ§±ÂéªËààË∂£‰∫Ü...ÈÄôÁ®ÆÊÉÖÊ≥ÅÊåÅÁ∫åÂ§ö‰πÖ‰∫ÜÔºü', time: 242 },
                { speaker: 'client', text: 'Â§ßÊ¶ÇÂÖ©„ÄÅ‰∏âÂÄãÊúàÂêßÔºåÊàëË¶∫ÂæóÂÅö‰ªÄÈ∫ºÈÉΩÊ≤íÊÑèÊÄù„ÄÇ', time: 249 },
                { speaker: 'counselor', text: 'ËÅΩËµ∑‰æÜ‰Ω†ÁèæÂú®ÁöÑÁãÄÊÖãÁúüÁöÑÂæàËæõËã¶„ÄÇ', time: 255 },
                { speaker: 'client', text: 'ÂóØ...', time: 260 },
                { speaker: 'counselor', text: '‰Ω†Êó©‰∏äËµ∑Â∫äÁöÑÊôÇÂÄôÔºåÊúÉ‰∏çÊúÉÁâπÂà•Èõ£ÁÜ¨Ôºü', time: 263 },
                { speaker: 'client', text: 'ÊúÉÔºåÊàëÊØèÂ§©ÁùúÈñãÁúºÁùõÁ¨¨‰∏ÄÂÄãÊÉ≥Ê≥ïÂ∞±ÊòØ„ÄåÂèàË¶ÅÈù¢Â∞çÊñ∞ÁöÑ‰∏ÄÂ§©„Äç„ÄÇ', time: 269 },
                { speaker: 'counselor', text: 'ÈÄôËÅΩËµ∑‰æÜÂÉèÊòØ‰∏ÄÁ®ÆË≤†Êìî„ÄÇ', time: 276 },
                { speaker: 'client', text: 'Â∞çÔºåÊàëË¶∫ÂæóÊ¥ªËëóÂ•ΩÂÉèÂè™ÊòØÂú®Êáâ‰ªòÔºåÊ≤í‰ªÄÈ∫ºÊÑèÁæ©„ÄÇ', time: 280 },

                // Phase 4: Ëá™ÊÆ∫ÊÑèÂøµË©ï‰º∞ (17-22ÂàÜÈêò) - CRITICAL SECTION
                { speaker: 'counselor', text: '‰Ω†ÂâõÊâçË™™„ÄåÊ¥ªËëóÊ≤íÊÑèÁæ©„ÄçÔºåÈÄôÊòØÊúÄËøëÊâçÊúâÁöÑÊÉ≥Ê≥ïÂóéÔºü', time: 287 },
                { speaker: 'client', text: 'ÂóØ...ÊúÄËøëÁâπÂà•Âº∑ÁÉà„ÄÇ', time: 293 },
                { speaker: 'counselor', text: 'ÊàëÊÉ≥Áõ¥Êé•Âïè‰Ω†ÔºåÁï∂‰Ω†Ë™™Ê¥ªËëóÊ≤íÊÑèÁæ©Ôºå‰Ω†ÊúâÊ≤íÊúâÊÉ≥ÈÅéË¶ÅÁµêÊùüÁîüÂëΩÔºü', time: 297 },
                { speaker: 'client', text: '...', time: 305 },
                { speaker: 'counselor', text: 'ÊàëÁü•ÈÅìÈÄôÂÄãÂïèÈ°åÂæàÁõ¥Êé•Ôºå‰ΩÜÈÄôÂ∞çÊàë‰∫ÜËß£‰Ω†ÁöÑÁãÄÊ≥ÅÂæàÈáçË¶Å„ÄÇ', time: 308 },
                { speaker: 'client', text: 'Êúâ...ÊúâÊÉ≥ÈÅé„ÄÇ', time: 315 },
                { speaker: 'counselor', text: 'Ë¨ùË¨ù‰Ω†È°òÊÑèË∑üÊàëË™™„ÄÇ‰Ω†ËÉΩË∑üÊàëÂ§öË™™‰∏ÄÈªûÂóéÔºüÈÄôÂÄãÊÉ≥Ê≥ïÂ§öÂ∏∏Âá∫ÁèæÔºü', time: 319 },
                { speaker: 'client', text: 'ÊúÄËøëÂπæ‰πéÊØèÂ§©ÈÉΩÊúÉÊÉ≥Âà∞„ÄÇ', time: 326 },
                { speaker: 'counselor', text: 'Áï∂ÈÄôÂÄãÊÉ≥Ê≥ïÂá∫ÁèæÁöÑÊôÇÂÄôÔºåÂÆÉÊúâÂ§öÂº∑ÁÉàÔºüÂæû0Âà∞10Ôºå10ÊòØÈùûÂ∏∏Âº∑ÁÉà„ÄÇ', time: 331 },
                { speaker: 'client', text: 'Â§ßÊ¶Ç...7„ÄÅ8Âêß„ÄÇ', time: 339 },
                { speaker: 'counselor', text: 'ÈÄôÁ¢∫ÂØ¶ÊòØÂæàÂº∑ÁöÑÁ®ãÂ∫¶„ÄÇ‰Ω†ÊúâÊÉ≥ÈÅéÂÖ∑È´îÁöÑÊñπÊ≥ïÂóéÔºü', time: 343 },
                { speaker: 'client', text: 'ÊúâÊÉ≥ÈÅé...‰ΩÜÊàë‰∏çÁ¢∫ÂÆöÊúÉ‰∏çÊúÉÁúüÁöÑÂéªÂÅö„ÄÇ', time: 349 },
                { speaker: 'counselor', text: '‰Ω†ÊÉ≥ÈÅé‰ªÄÈ∫ºÊñπÊ≥ïÔºü', time: 355 },
                { speaker: 'client', text: 'Â∞±...ÂêÉÂÆâÁú†Ëó•„ÄÇÊàëÂÆ∂Ë£°Êúâ‰∏Ä‰∫õ„ÄÇ', time: 358 },
                { speaker: 'counselor', text: '‰Ω†ÊúâÊÉ≥ÈÅé‰ªÄÈ∫ºÊôÇÂÄôÂÅöÈÄô‰ª∂‰∫ãÂóéÔºü', time: 364 },
                { speaker: 'client', text: 'Ê≤íÊúâÊòéÁ¢∫ÁöÑÊôÇÈñìÔºå‰ΩÜÊúâÊôÇÂÄôÁúüÁöÑÂæàÊÉ≥Â∞±ÈÄôÊ®£ÁµêÊùü„ÄÇ', time: 369 },
                { speaker: 'counselor', text: 'ÈÇ£Êúâ‰ªÄÈ∫º‰∫ãÊÉÖÊàñ‰∫∫ÔºåËÆì‰Ω†Âà∞ÁèæÂú®ÈÇÑÈ°òÊÑèÊ¥ªËëóÔºü', time: 376 },
                { speaker: 'client', text: 'ÊàëÂ™Ω...Â•πË∫´È´î‰∏çÂ•ΩÔºåÂ¶ÇÊûúÊàëÂá∫‰∫ãÔºåÂ•π‰∏ÄÂÆöÂèó‰∏ç‰∫Ü„ÄÇ', time: 382 },
                { speaker: 'counselor', text: '‰Ω†Â™ΩÂ™ΩÂ∞ç‰Ω†‰æÜË™™ÂæàÈáçË¶Å„ÄÇ', time: 389 },
                { speaker: 'client', text: 'Â∞çÔºåÂ•πÊòØÊàëÂîØ‰∏ÄÁöÑÁâΩÊéõ„ÄÇ', time: 393 },

                // Phase 5: È¢®Èö™Ë©ï‰º∞Ê∑±ÂÖ• (22-27ÂàÜÈêò)
                { speaker: 'counselor', text: 'Èô§‰∫ÜÂ™ΩÂ™ΩÔºåÈÇÑÊúâÂÖ∂‰ªñËÆì‰Ω†Ë¶∫ÂæóÂÄºÂæóÊ¥ª‰∏ãÂéªÁöÑ‰∫ãÊÉÖÂóéÔºü', time: 400 },
                { speaker: 'client', text: 'ÊàëÊÉ≥‰∏çÂà∞‰∫Ü...ÂèØËÉΩÂ∞±Âè™ÊúâÂ•π„ÄÇ', time: 407 },
                { speaker: 'counselor', text: 'Áï∂‰Ω†ÊÉ≥Âà∞Ë¶ÅÁµêÊùüÁîüÂëΩÁöÑÊôÇÂÄôÔºåÊúâÊ≤íÊúâ‰ªÄÈ∫º‰∫ãÊÉÖÂèØ‰ª•ËÆì‰Ω†ÂÅú‰∏ã‰æÜÔºü' },
                { speaker: 'client', text: 'Â∞±ÊÉ≥Âà∞ÊàëÂ™ΩÔºåÈÇÑÊúâ...Êàë‰πüÊúâÈªûÂÆ≥ÊÄïÊ≠ª‰∫°„ÄÇ' },
                { speaker: 'counselor', text: '‰Ω†Ë™™ÁöÑÂÆ≥ÊÄïÊòØ‰ªÄÈ∫ºÊ®£ÁöÑÂÆ≥ÊÄïÔºü' },
                { speaker: 'client', text: '‰∏çÁü•ÈÅìÊ≠ª‰∫Ü‰πãÂæåÊúÉÊÄéÊ®£ÔºåËÄå‰∏îÊàë‰πü‰∏çÊÉ≥ËÆìÂÆ∂‰∫∫ÂÇ∑ÂøÉ„ÄÇ' },
                { speaker: 'counselor', text: 'ÈÄô‰∫õÈÉΩÊòØÂæàÈáçË¶ÅÁöÑ‰øùË≠∑Âõ†Â≠ê„ÄÇ‰Ω†ÊúâË∑ü‰ªª‰Ωï‰∫∫Ë´áÈÅéÈÄô‰∫õÊÉ≥Ê≥ïÂóéÔºü' },
                { speaker: 'client', text: 'Ê≤íÊúâ...ÈÄôÊòØÊàëÁ¨¨‰∏ÄÊ¨°Ë™™Âá∫‰æÜ„ÄÇ' },
                { speaker: 'counselor', text: 'ÊàëÂæàÊÖ∂Âπ∏‰Ω†‰ªäÂ§©È°òÊÑè‰æÜÈÄôË£°Ôºå‰πüÈ°òÊÑèË∑üÊàëË™™ÈÄô‰∫õ„ÄÇ' },
                { speaker: 'client', text: 'ÂóØ...ÂÖ∂ÂØ¶Êàë‰πü‰∏çÁü•ÈÅìË©≤ÊÄéÈ∫ºËæ¶‰∫Ü„ÄÇ' },
                { speaker: 'counselor', text: '‰Ω†ÈÅéÂéªÊúâË©¶ÂúñÂÇ∑ÂÆ≥Ëá™Â∑±ÊàñËá™ÊÆ∫ÁöÑÁ∂ìÈ©óÂóéÔºü' },
                { speaker: 'client', text: 'Ê≤íÊúâÔºåÈÄôÊòØÁ¨¨‰∏ÄÊ¨°ÈÄôÈ∫ºÂö¥Èáç„ÄÇ' },
                { speaker: 'counselor', text: 'ÈÇ£ÁèæÂú®Ê≠§ÂàªÔºåÂ¶ÇÊûúÂæû0Âà∞10‰æÜË©ï‰º∞Ôºå‰Ω†Ë¶∫ÂæóËá™Â∑±Âú®Êé•‰∏ã‰æÜ‰∏ÄÈÄ±ÂÖßÊúÉÁúüÁöÑÂü∑Ë°åÁöÑÂèØËÉΩÊÄßÊúâÂ§öÈ´òÔºü' },
                { speaker: 'client', text: 'ÂèØËÉΩ...3„ÄÅ4Âêß„ÄÇÊàë‰∏çÁ¢∫ÂÆö„ÄÇ' },
                { speaker: 'counselor', text: 'ÊàëËÅΩÂà∞‰Ω†Ë™™‰∏çÁ¢∫ÂÆöÔºåÈÄô‰ª£Ë°®‰Ω†ÂÖßÂøÉÈÇÑÂú®ÊéôÊâé„ÄÇ' },
                { speaker: 'client', text: 'Â∞çÔºåÊúâÊôÇÂÄôÂæàÊÉ≥ÁµêÊùüÔºå‰ΩÜÂèàË¶∫Âæó‰∏çËÉΩÈÄôÊ®£ÂÅö„ÄÇ' },

                // Phase 6: ÂÆâÂÖ®Ë®àÁï´ËàáË≥áÊ∫ê (27-30ÂàÜÈêò)
                { speaker: 'counselor', text: 'ÊàëÊÉ≥Ë∑ü‰Ω†‰∏ÄËµ∑Âà∂ÂÆö‰∏ÄÂÄãÂÆâÂÖ®Ë®àÁï´ÔºåÁï∂‰Ω†ÊúâÂº∑ÁÉàÁöÑËá™ÊÆ∫ÂøµÈ†≠ÊôÇÂèØ‰ª•ÊÄéÈ∫ºÂÅö„ÄÇ' },
                { speaker: 'client', text: 'Â•Ω...' },
                { speaker: 'counselor', text: 'È¶ñÂÖàÔºåÁï∂ÈÄôÂÄãÂøµÈ†≠Âá∫ÁèæÊôÇÔºå‰Ω†ÂèØ‰ª•ÂÅö‰ªÄÈ∫º‰∫ãÊÉÖ‰æÜËΩâÁßªÊ≥®ÊÑèÂäõÔºü' },
                { speaker: 'client', text: 'ÊàëÂèØËÉΩ...ÂéªÊï£Ê≠•ÔºüÊàñÊòØËÅΩÈü≥Ê®ÇÔºü' },
                { speaker: 'counselor', text: 'ÈÄô‰∫õÈÉΩÊòØÂ•ΩÊñπÊ≥ï„ÄÇÊé•‰∏ã‰æÜÔºå‰Ω†ÊúâÂèØ‰ª•ÊâìÈõªË©±Ê±ÇÂä©ÁöÑ‰∫∫ÂóéÔºü' },
                { speaker: 'client', text: 'ÊàëÊúâ‰∏ÄÂÄãÂ§ßÂ≠∏ÂêåÂ≠∏ÔºåÊàëÂÄëÈóú‰øÇÈÇÑ‰∏çÈåØ„ÄÇ' },
                { speaker: 'counselor', text: 'ÂæàÂ•Ω„ÄÇÂ¶ÇÊûúÊÉÖÊ≥ÅÊõ¥Á∑äÊÄ•Ôºå‰Ω†Áü•ÈÅìÂèØ‰ª•Êâì1925ÂÆâÂøÉÂ∞àÁ∑öÂóéÔºü' },
                { speaker: 'client', text: 'ËÅΩÈÅéÔºå‰ΩÜÊ≤íÊâìÈÅé„ÄÇ' },
                { speaker: 'counselor', text: 'ÈÄôÊòØ24Â∞èÊôÇÁöÑÂøÉÁêÜË´ÆË©¢Â∞àÁ∑öÔºåÈö®ÊôÇÈÉΩÂèØ‰ª•Êâì„ÄÇÈÇÑÊúâÔºåÈóúÊñºÂÆ∂Ë£°ÁöÑÂÆâÁú†Ëó•...' },
                { speaker: 'client', text: 'ÂóØÔºü' },
                { speaker: 'counselor', text: 'ÁÇ∫‰∫Ü‰Ω†ÁöÑÂÆâÂÖ®ÔºåÊàëÂª∫Ë≠∞‰Ω†ÊääÂÆÉÂÄë‰∫§Áµ¶‰ø°‰ªªÁöÑ‰∫∫‰øùÁÆ°Ôºå‰Ω†Ë¶∫ÂæóÂèØ‰ª•ÂóéÔºü' },
                { speaker: 'client', text: 'ÂèØ‰ª•...ÊàëÂèØ‰ª•Áµ¶ÊàëÂ™Ω‰øùÁÆ°„ÄÇ' },
                { speaker: 'counselor', text: 'Â•ΩÁöÑÔºåÈÄôÂæàÈáçË¶Å„ÄÇÊàë‰πüÂª∫Ë≠∞‰Ω†ËÄÉÊÖÆÂéªË∫´ÂøÉÁßëË©ï‰º∞ÔºåÁúãÊòØÂê¶ÈúÄË¶ÅËó•Áâ©ÂçîÂä©„ÄÇ' },
                { speaker: 'client', text: '‰Ω†Ë¶∫ÂæóÊàëÈúÄË¶ÅÂêÉËó•ÂóéÔºü' },
                { speaker: 'counselor', text: 'ÈÄôÈúÄË¶ÅÈÜ´ÁîüË©ï‰º∞Ôºå‰ΩÜÂæû‰Ω†ÁöÑÁóáÁãÄ‰æÜÁúãÔºåËó•Áâ©ÂèØËÉΩÂèØ‰ª•Âπ´Âä©‰Ω†Á©©ÂÆöÊÉÖÁ∑íÂíåÁù°Áú†„ÄÇ' },
                { speaker: 'client', text: 'Â•Ω...ÊàëÊúÉËÄÉÊÖÆÁöÑ„ÄÇ' },
                { speaker: 'counselor', text: 'ÊàëÂ∏åÊúõÊàëÂÄëËÉΩÂØÜÈõÜÂú∞Ë¶ãÈù¢ÔºåÊØèÈÄ±Ëá≥Â∞ëÂÖ©Ê¨°Ôºå‰Ω†Ë¶∫ÂæóÂèØ‰ª•ÂóéÔºü' },
                { speaker: 'client', text: 'ÂèØ‰ª•ÔºåÊàëÈúÄË¶ÅÊúâ‰∫∫Âπ´Êàë„ÄÇ' },
                { speaker: 'counselor', text: 'ÊàëÊúÉÈô™Ëëó‰Ω†Â∫¶ÈÅéÈÄôÊÆµÊôÇÈñì„ÄÇÂú®‰∏ãÊ¨°Ë¶ãÈù¢‰πãÂâçÔºåÂ¶ÇÊûú‰Ω†ÊúâÂº∑ÁÉàÁöÑËá™ÊÆ∫ÂøµÈ†≠ÔºåË´ã‰∏ÄÂÆöË¶ÅÊâì1925ÊàñËÅØÁµ°Êàë„ÄÇ' },
                { speaker: 'client', text: 'Â•ΩÔºåË¨ùË¨ù‰Ω†„ÄÇ' },
                { speaker: 'counselor', text: '‰∏çÂÆ¢Ê∞£„ÄÇÊàëÂÄëÁ¥Ñ‰∏ãÈÄ±‰∫åÂêå‰∏ÄÊôÇÈñìÔºå‰Ω†Ë¶∫ÂæóÂèØ‰ª•ÂóéÔºü' },
                { speaker: 'client', text: 'ÂèØ‰ª•„ÄÇ' },
                { speaker: 'counselor', text: 'ÈÇ£‰ªäÂ§©Â∞±Âà∞ÈÄôË£°„ÄÇË®òÂæóÔºå‰Ω†‰∏çÊòØ‰∏ÄÂÄã‰∫∫ÔºåÊàëÂÄëÊúÉ‰∏ÄËµ∑Èù¢Â∞çÈÄôÂÄãÂõ∞Èõ£„ÄÇ' },
                { speaker: 'client', text: 'Ë¨ùË¨ù...' }
            ],

            // ÂäáÊú¨ 2: ‰∏ÄËà¨Ë´ÆË©¢ÔºàÈóú‰øÇ„ÄÅÂÆ∂Â∫≠„ÄÅÁîüÊ∂ØÊé¢Á¥¢Ôºâ- 30ÂàÜÈêòÂÆåÊï¥Áâà
            general: [
                // Phase 1: ÈñãÂ†¥ËàáËøëÊ≥Å (0-5ÂàÜÈêò)
                { speaker: 'counselor', text: '‰ªäÂ§©ÈÅéÂæóÂ¶Ç‰ΩïÔºü' },
                { speaker: 'client', text: 'ÈÇÑÂ•ΩÔºåÂ∞±ÊòØÊúâÈªûÁ¥Ø„ÄÇ' },
                { speaker: 'counselor', text: '‰ªÄÈ∫ºËÆì‰Ω†ÊÑüÂà∞Á¥ØÂë¢Ôºü' },
                { speaker: 'client', text: 'Â∑•‰ΩúÁöÑ‰∫ãÊÉÖÔºåÈÇÑÊúâÂÆ∂Ë£°ÁöÑ‰∫ã„ÄÇ' },
                { speaker: 'counselor', text: 'ËÉΩÂÖ∑È´îË™™Ë™™ÊòØ‰ªÄÈ∫º‰∫ãÂóéÔºüÊàëÂÄëÂÖàÂæûÂì™‰∏ÄÂÄãÈñãÂßãËÅäÔºü' },
                { speaker: 'client', text: 'ÂÖàË™™Â∑•‰ΩúÂ•Ω‰∫ÜÔºå‰∏ªÁÆ°ÊúÄËøë‰∏ÄÁõ¥ÁõØÊàëÔºåËÆìÊàëÂ£ìÂäõÂæàÂ§ß„ÄÇ' },
                { speaker: 'counselor', text: '‰∏ªÁÆ°ÁõØËëó‰Ω†ÁöÑÊÑüË¶∫ÔºåËÉΩÊèèËø∞‰∏Ä‰∏ãÂóéÔºü' },
                { speaker: 'client', text: 'Â∞±ÊòØË¶∫ÂæóË¢´Áõ£Ë¶ñÔºå‰ªÄÈ∫ºÈÉΩË¶ÅÂ†±ÂëäÔºåËÆìÊàëÂæà‰∏çËàíÊúç„ÄÇ' },
                { speaker: 'counselor', text: 'ËÅΩËµ∑‰æÜÈÄôËÆì‰Ω†Ë¶∫Âæó‰∏çË¢´‰ø°‰ªª„ÄÇ' },
                { speaker: 'client', text: 'Â∞çÔºåÊòéÊòéÊàëÂ∑•‰ΩúÈÉΩÊúâÂÅöÂ•ΩÔºå‰ΩÜ‰ªñÈÇÑÊòØ‰∏ÄÁõ¥ÂïèÊù±ÂïèË•ø„ÄÇ' },
                { speaker: 'counselor', text: 'ÈÄôÁ®ÆÁãÄÊ≥ÅÊåÅÁ∫åÂ§ö‰πÖ‰∫ÜÔºü' },
                { speaker: 'client', text: 'Â§ßÊ¶Ç‰∏ÄÂÄãÊúàÂêßÔºåÂæû‰∏äÊ¨°Â∞àÊ°àÂá∫‰∫ÜÈªûÂ∞èÂïèÈ°å‰πãÂæå„ÄÇ' },
                { speaker: 'counselor', text: 'ÈÇ£Ê¨°ÁöÑÂ∞èÂïèÈ°åÔºåÂ∞ç‰Ω†ÂΩ±ÈüøÂæàÂ§ßÂóéÔºü' },
                { speaker: 'client', text: 'ÂÖ∂ÂØ¶ÈÇÑÂ•ΩÔºå‰ΩÜ‰∏ªÁÆ°Â•ΩÂÉèÂæûÈÇ£‰πãÂæåÂ∞±ÈñãÂßãÁâπÂà•Ê≥®ÊÑèÊàë„ÄÇ' },

                // Phase 2: Â∑•‰ΩúÂ£ìÂäõËàáÂõ†Êáâ (5-10ÂàÜÈêò)
                { speaker: 'counselor', text: '‰Ω†ÊúâË©¶ËëóË∑ü‰∏ªÁÆ°Ê∫ùÈÄöÈÅéÂóéÔºü' },
                { speaker: 'client', text: 'Ê≤íÊúâ...Êàë‰∏çÂ§™Êï¢ÔºåÊÄï‰ªñË¶∫ÂæóÊàëÂú®Êä±ÊÄ®„ÄÇ' },
                { speaker: 'counselor', text: '‰Ω†ÊìîÂøÉË°®ÈÅîËá™Â∑±ÁöÑÊÑüÂèóÊúÉÂ∏∂‰æÜË≤†Èù¢ÂæåÊûú„ÄÇ' },
                { speaker: 'client', text: 'Â∞çÔºåËÄå‰∏îÊàë‰πü‰∏çÁü•ÈÅìË©≤ÊÄéÈ∫ºË™™„ÄÇ' },
                { speaker: 'counselor', text: 'Â¶ÇÊûúÊúâÊ©üÊúÉË∑ü‰ªñË™™Ôºå‰Ω†ÊúÄÊÉ≥ËÆì‰ªñÁü•ÈÅì‰ªÄÈ∫ºÔºü' },
                { speaker: 'client', text: 'ÊàëÂ∏åÊúõ‰ªñÁü•ÈÅìÊàëÊòØÊúâËÉΩÂäõÁöÑÔºå‰∏çÈúÄË¶Å‰∏ÄÁõ¥Ë¢´Áõ£Áù£„ÄÇ' },
                { speaker: 'counselor', text: 'ÈÄôÊòØÂæàÂêàÁêÜÁöÑÈúÄÊ±Ç„ÄÇ‰Ω†Ë¶∫Âæó‰ªÄÈ∫ºÈòªÁ§ô‰∫Ü‰Ω†Ë°®ÈÅîÈÄôÂÄãÈúÄÊ±ÇÔºü' },
                { speaker: 'client', text: 'ÂèØËÉΩÊòØ...Êàë‰∏çÊÉ≥ÊÉπÈ∫ªÁÖ©Ôºå‰πüÊÄïÁ†¥Â£ûÈóú‰øÇ„ÄÇ' },
                { speaker: 'counselor', text: '‰øùÊåÅÂíåÂπ≥Â∞ç‰Ω†‰æÜË™™ÂæàÈáçË¶Å„ÄÇÈÄôÁ®ÆÊ®°ÂºèÂú®‰Ω†ÁîüÊ¥ªÁöÑÂÖ∂‰ªñÈÉ®ÂàÜ‰πüÊúÉÂá∫ÁèæÂóéÔºü' },
                { speaker: 'client', text: 'ÊúÉ...ÊàëË∑üÂÆ∂‰∫∫‰πüÊòØÈÄôÊ®£„ÄÇ' },
                { speaker: 'counselor', text: 'ËÉΩÂ§öË™™‰∏ÄÈªûÂóéÔºü' },
                { speaker: 'client', text: 'ÊàëÂ™ΩÂ∏∏Â∏∏ÂøµÊàëË©≤ÁµêÂ©ö‰∫ÜÔºå‰ΩÜÊàë‰∏çÊÉ≥ËÅΩÔºåÂ∞±ÈÉΩ‰∏çÂõûÊáâ„ÄÇ' },

                // Phase 3: ÂÆ∂Â∫≠Èóú‰øÇÊé¢Á¥¢ (10-17ÂàÜÈêò)
                { speaker: 'counselor', text: '‰Ω†‰∏çÊÉ≥ÂõûÊáâÁöÑÂéüÂõ†ÊòØ‰ªÄÈ∫ºÔºü' },
                { speaker: 'client', text: 'Âõ†ÁÇ∫ÊàëÈÇÑÊ≤íÊ∫ñÂÇôÂ•ΩÔºå‰ΩÜË™™‰∫ÜÂ•π‰πü‰∏çÊúÉÊáÇ„ÄÇ' },
                { speaker: 'counselor', text: '‰Ω†Ë¶∫ÂæóÂ™ΩÂ™Ω‰∏çÁêÜËß£‰Ω†ÁöÑÊÉ≥Ê≥ï„ÄÇ' },
                { speaker: 'client', text: 'Â∞çÔºåÂ•πÈÇ£ÂÄãÂπ¥‰ª£ÁöÑ‰∫∫ÔºåË¶∫ÂæóÂà∞‰∫ÜÂπ¥Á¥ÄÂ∞±Ë©≤ÁµêÂ©ö„ÄÇ' },
                { speaker: 'counselor', text: 'ÈÇ£‰Ω†Ëá™Â∑±Â∞çÂ©öÂßªÁöÑÊÉ≥Ê≥ïÊòØ‰ªÄÈ∫ºÔºü' },
                { speaker: 'client', text: 'ÊàëË¶∫Âæó...Â¶ÇÊûúÈÅáÂà∞Â∞çÁöÑ‰∫∫Áï∂ÁÑ∂Â•ΩÔºå‰ΩÜ‰∏çÊÉ≥ÁÇ∫‰∫ÜÁµêÂ©öËÄåÁµêÂ©ö„ÄÇ' },
                { speaker: 'counselor', text: 'ÈÄôÊòØÂæàÊàêÁÜüÁöÑÊÉ≥Ê≥ï„ÄÇ‰Ω†Ë∑üÂ™ΩÂ™ΩÁöÑÈóú‰øÇÔºåÈô§‰∫ÜÈÄôÂÄãË©±È°åÔºåÂÖ∂‰ªñÊñπÈù¢Â¶Ç‰ΩïÔºü' },
                { speaker: 'client', text: 'ÂÖ∂ÂØ¶ÈÇÑ‰∏çÈåØÔºåÂ•πÂ∞çÊàëÂæàÂ•ΩÔºåÂ∞±ÊòØÊúâÊôÇÂÄôÊúÉÁ¢éÂøµ„ÄÇ' },
                { speaker: 'counselor', text: 'ËÅΩËµ∑‰æÜ‰Ω†ÂÄëÈóú‰øÇÁöÑÂü∫Á§éÊòØÂ•ΩÁöÑÔºåÂè™ÊòØÂú®Êüê‰∫õË≠∞È°å‰∏äÊúâ‰∏çÂêåÁúãÊ≥ï„ÄÇ' },
                { speaker: 'client', text: 'Â∞çÔºå‰ΩÜÊØèÊ¨°Â•π‰∏ÄË¨õÂà∞ÁµêÂ©öÔºåÊàëÂ∞±ÊúÉÂæàÁÖ©Ë∫Å„ÄÇ' },
                { speaker: 'counselor', text: 'ÈÄôÂÄãÁÖ©Ë∫ÅËÉåÂæåÔºåÈô§‰∫Ü‰∏çÊÉ≥Ë¢´ÂÇ¨Â©öÔºåÈÇÑÊúâÂÖ∂‰ªñÊÑüÂèóÂóéÔºü' },
                { speaker: 'client', text: 'ÂèØËÉΩÊúâ‰∏ÄÈªû...Â£ìÂäõÂêßÔºåË¶∫ÂæóÂ•ΩÂÉèÊàë‰∏çÁ¨¶ÂêàÊúüÂæÖ„ÄÇ' },
                { speaker: 'counselor', text: '‰Ω†Âú®ÊÑèÂ™ΩÂ™ΩÊÄéÈ∫ºÁúã‰Ω†„ÄÇ' },
                { speaker: 'client', text: 'ÂóØ...Êàë‰∏çÊÉ≥ËÆìÂ•πÂ§±Êúõ„ÄÇ' },
                { speaker: 'counselor', text: 'ÈÇ£Â¶ÇÊûúÂ™ΩÂ™ΩÁü•ÈÅì‰Ω†ÁöÑÊÉ≥Ê≥ïÔºå‰Ω†Ë¶∫ÂæóÂ•πÊúÉÂ§±ÊúõÂóéÔºü' },
                { speaker: 'client', text: 'ÂèØËÉΩÊúÉÂêß...‰ΩÜÊàë‰πü‰∏çÁ¢∫ÂÆö„ÄÇ' },
                { speaker: 'counselor', text: 'ÊâÄ‰ª•‰Ω†ÈÇÑÊ≤íÊúâÁúüÊ≠£Ë©¶ËëóËÆìÂ•πÁêÜËß£‰Ω†ÁöÑÊÉ≥Ê≥ï„ÄÇ' },
                { speaker: 'client', text: 'Â∞çÔºåÂõ†ÁÇ∫ÊàëË¶∫ÂæóË™™‰∫Ü‰πüÊ≤íÁî®„ÄÇ' },
                { speaker: 'counselor', text: 'ÈÄôËÅΩËµ∑‰æÜÊúâÈªûÂÉèËá™ÊàëË®≠ÈôêÔºåÂú®ÈÇÑÊ≤íË©¶‰πãÂâçÂ∞±ÂÅáË®≠ÁµêÊûú‰∫Ü„ÄÇ' },
                { speaker: 'client', text: 'ÂóØ...‰Ω†ÈÄôÊ®£Ë™™Â•ΩÂÉèÊúâÈÅìÁêÜ„ÄÇ' },

                // Phase 4: ‰∫∫ÈöõÈóú‰øÇÊ®°Âºè (17-22ÂàÜÈêò)
                { speaker: 'counselor', text: 'ÊàëÊ≥®ÊÑèÂà∞Ôºå‰∏çÁÆ°ÊòØ‰∏ªÁÆ°ÈÇÑÊòØÂ™ΩÂ™ΩÔºå‰Ω†ÈÉΩÂÇæÂêë‰∏çË°®ÈÅîËá™Â∑±ÁöÑÊÑüÂèó„ÄÇ' },
                { speaker: 'client', text: 'Â•ΩÂÉèÊòØ...ÊàëÂæûÂ∞èÂ∞±ÈÄôÊ®£„ÄÇ' },
                { speaker: 'counselor', text: '‰Ω†Ë®òÂæóÊòØÂæû‰ªÄÈ∫ºÊôÇÂÄôÈñãÂßãÁöÑÂóéÔºü' },
                { speaker: 'client', text: 'Â∞èÊôÇÂÄôÊàëÁà∏ËÑæÊ∞£Âæà‰∏çÂ•ΩÔºåÊàëÂ≠∏ÊúÉ‰∏çË¶ÅÊÉπ‰ªñÁîüÊ∞£„ÄÇ' },
                { speaker: 'counselor', text: 'ÊâÄ‰ª•‰Ω†Â≠∏ÊúÉ‰∫Ü‰øùË≠∑Ëá™Â∑±ÁöÑÊñπÂºèÊòØ‰∏çË°®ÈÅî„ÄÅ‰∏çÂºïÁôºË°ùÁ™Å„ÄÇ' },
                { speaker: 'client', text: 'Â∞ç...‰ΩÜÈÄôÊ®£Â•ΩÂÉè‰πüËÆìÊàëÂæàÁ¥Ø„ÄÇ' },
                { speaker: 'counselor', text: 'Âõ†ÁÇ∫‰Ω†ÁöÑÈúÄÊ±ÇÂíåÊÑüÂèóÊ≤íÊúâË¢´ÁúãË¶ã„ÄÇ' },
                { speaker: 'client', text: 'ÂóØÔºåÊúâÊôÇÂÄôÊàë‰πü‰∏çÁü•ÈÅìËá™Â∑±Ë¶Å‰ªÄÈ∫º‰∫Ü„ÄÇ' },
                { speaker: 'counselor', text: 'ÈÄôÊòØÈï∑ÊúüÂ£ìÊäëÁöÑÁµêÊûú„ÄÇÈÇ£Âú®ÊúãÂèãÈóú‰øÇ‰∏≠Âë¢Ôºü‰Ω†ÊúÉË°®ÈÅîËá™Â∑±ÂóéÔºü' },
                { speaker: 'client', text: 'Ë∑üÊúãÂèãÊØîËºÉËá™Âú®‰∏ÄÈªûÔºå‰ΩÜ‰πü‰∏çÊòØÂÆåÂÖ®ÊîæÈ¨Ü„ÄÇ' },
                { speaker: 'counselor', text: '‰ªÄÈ∫ºÊ®£ÁöÑÊÉÖÊ≥Å‰∏ã‰Ω†ÊúÉÊØîËºÉÊîæÈ¨ÜÔºü' },
                { speaker: 'client', text: 'Â¶ÇÊûúÂ∞çÊñπÂÖàÂàÜ‰∫´‰ªñÁöÑÁÖ©ÊÉ±ÔºåÊàëÂ∞±ÊúÉË¶∫ÂæóÊØîËºÉÂÆâÂÖ®„ÄÇ' },
                { speaker: 'counselor', text: 'ÊâÄ‰ª•‰Ω†ÈúÄË¶ÅÂÖàÁ¢∫Ë™çÈÄôÊòØ‰∏ÄÂÄãÂÆâÂÖ®ÁöÑÁí∞Â¢É„ÄÇ' },
                { speaker: 'client', text: 'Â∞çÔºåÊàëÊÄïËá™Â∑±Ë™™Â§™Â§öÊúÉÈÄ†ÊàêÂà•‰∫∫ÁöÑË≤†Êìî„ÄÇ' },
                { speaker: 'counselor', text: '‰Ω†ÂæàÂú®ÊÑèÂà•‰∫∫ÁöÑÊÑüÂèóÔºå‰ΩÜÁõ∏Â∞ç‰æÜË™™ÔºåÊØîËºÉÂøΩÁï•Ëá™Â∑±ÁöÑÈúÄÊ±Ç„ÄÇ' },
                { speaker: 'client', text: 'Â•ΩÂÉèÊòØÈÄôÊ®£...ÊàëË©≤ÊÄéÈ∫ºÊîπËÆäÔºü' },

                // Phase 5: Ëá™ÊàëÊé¢Á¥¢ËàáÂÉπÂÄºËßÄ (22-27ÂàÜÈêò)
                { speaker: 'counselor', text: 'ÊîπËÆäÊòØ‰∏ÄÂÄãÈÅéÁ®ã„ÄÇÊàëÂÄëÂèØ‰ª•ÂÖàÂæûË¶∫ÂØüÈñãÂßãÔºå‰Ω†È°òÊÑèË©¶Ë©¶ÁúãÂóéÔºü' },
                { speaker: 'client', text: 'È°òÊÑèÔºå‰ΩÜË¶ÅÊÄéÈ∫ºÂÅöÔºü' },
                { speaker: 'counselor', text: '‰∏ãÊ¨°Áï∂‰Ω†ÂèàÊÉ≥Â£ìÊäëËá™Â∑±ÁöÑÊÑüÂèóÊôÇÔºåÂÖàÂÅú‰∏ã‰æÜÔºåÂïèËá™Â∑±ÔºöÊàëÁèæÂú®ÁúüÊ≠£ÁöÑÊÑüÂèóÊòØ‰ªÄÈ∫ºÔºü' },
                { speaker: 'client', text: 'Â•ΩÔºåÊàëË©¶Ë©¶Áúã„ÄÇ' },
                { speaker: 'counselor', text: 'ÈÇÑÊúâÔºåÊàëÊÉ≥Âïè‰Ω†ÔºåÂú®‰Ω†ÁöÑÁîüÊ¥ª‰∏≠Ôºå‰ªÄÈ∫º‰∫ãÊÉÖÊòØÁúüÊ≠£ÈáçË¶ÅÁöÑÔºü' },
                { speaker: 'client', text: 'ÈáçË¶ÅÁöÑ...ÂÆ∂‰∫∫„ÄÅÂ∑•‰Ωú...ÈÇÑÊúâËá™Â∑±ÁöÑÂÅ•Â∫∑Âêß„ÄÇ' },
                { speaker: 'counselor', text: 'ÈÄô‰∫õÈÉΩÂæàÈáçË¶Å„ÄÇÈÇ£‰Ω†ÁèæÂú®ÁöÑÁîüÊ¥ªÔºåÊúâÁ¨¶ÂêàÈÄô‰∫õÂÉπÂÄºÂóéÔºü' },
                { speaker: 'client', text: 'Â•ΩÂÉèÊ≤íÊúâ...ÊàëÁÇ∫‰∫ÜÂ∑•‰ΩúÁäßÁâ≤ÂÅ•Â∫∑ÔºåÁÇ∫‰∫ÜÂÆ∂‰∫∫Â£ìÊäëËá™Â∑±„ÄÇ' },
                { speaker: 'counselor', text: '‰Ω†ÁúãÂà∞ÈÄôÂÄãÂ§±Ë°°‰∫Ü„ÄÇ' },
                { speaker: 'client', text: 'Â∞çÔºå‰ΩÜÊàë‰∏çÁü•ÈÅìË¶ÅÊÄéÈ∫ºÂπ≥Ë°°„ÄÇ' },
                { speaker: 'counselor', text: 'Â¶ÇÊûúÂèØ‰ª•ÈáçÊñ∞ÂÆâÊéíÔºå‰Ω†Â∏åÊúõ‰Ω†ÁöÑÁîüÊ¥ªÊòØ‰ªÄÈ∫ºÊ®£Â≠êÔºü' },
                { speaker: 'client', text: 'ÊàëÂ∏åÊúõ...ÂèØ‰ª•ÂÅöËá™Â∑±ÂñúÊ≠°ÁöÑ‰∫ãÔºå‰πüËÉΩÂ•ΩÂ•ΩÁÖßÈ°ßË∫´È´î„ÄÇ' },
                { speaker: 'counselor', text: 'ÈÇ£‰Ω†ÂñúÊ≠°ÂÅö‰ªÄÈ∫º‰∫ãÔºü' },
                { speaker: 'client', text: 'ÊàëÂñúÊ≠°ÁôªÂ±±ÔºåÈÇÑÊúâÊîùÂΩ±Ôºå‰ΩÜÂ∑≤Á∂ìÂæà‰πÖÊ≤íÂÅö‰∫Ü„ÄÇ' },
                { speaker: 'counselor', text: 'ÊòØ‰ªÄÈ∫ºÈòªÊ≠¢‰Ω†ÂÅöÈÄô‰∫õ‰∫ãÔºü' },
                { speaker: 'client', text: 'Á∏ΩË¶∫ÂæóÊ≤íÊôÇÈñìÔºåÂ∑•‰ΩúÂ§™Âøô‰∫Ü„ÄÇ' },
                { speaker: 'counselor', text: 'Â¶ÇÊûúÊääÈÄô‰∫õ‰∫ãÊÉÖ‰πüÊéíÈÄ≤‰Ω†ÁöÑË°åÁ®ãÔºå‰Ω†Ë¶∫ÂæóÂèØË°åÂóéÔºü' },
                { speaker: 'client', text: 'ÂèØËÉΩ...ÈÄ±Êú´ÂèØ‰ª•Ë©¶Ë©¶Áúã„ÄÇ' },

                // Phase 6: ÁõÆÊ®ôË®≠ÂÆöËàáÁ∏ΩÁµê (27-30ÂàÜÈêò)
                { speaker: 'counselor', text: 'ÈÄôÊòØÂÄãÂæàÂ•ΩÁöÑÈñãÂßã„ÄÇÈÇ£ÊàëÂÄë‰æÜË®≠ÂÆö‰∏Ä‰∫õÂ∞èÁõÆÊ®ôÔºåÈÄôÈÄ±‰Ω†ÊÉ≥Ë©¶ËëóÂÅö‰ªÄÈ∫ºÔºü' },
                { speaker: 'client', text: 'ÈÄôÈÄ±Êú´ÊàëÊÉ≥ÂéªÁà¨ÂÄãÂ∞èÂ±±ÔºåÂ∏∂ËëóÁõ∏Ê©ü„ÄÇ' },
                { speaker: 'counselor', text: 'ËÅΩËµ∑‰æÜÊòØÂÄãÂæàÊ£íÁöÑË®àÁï´„ÄÇÈÇ£ÈóúÊñºË∑üÂ™ΩÂ™ΩÊ∫ùÈÄöÁöÑÈÉ®ÂàÜÂë¢Ôºü' },
                { speaker: 'client', text: 'ÊàëÊÉ≥...ÊâæÂÄãÊôÇÈñìÂ•ΩÂ•ΩË∑üÂ•πËÅäËÅäÊàëÁöÑÊÉ≥Ê≥ï„ÄÇ' },
                { speaker: 'counselor', text: 'ÂæàÂ•Ω„ÄÇ‰Ω†ÊÉ≥ÊÄéÈ∫ºÈñãÂßãÈÄôÂÄãÂ∞çË©±Ôºü' },
                { speaker: 'client', text: 'ÂèØËÉΩÂæûË¨ùË¨ùÂ•πÁöÑÈóúÂøÉÈñãÂßãÔºåÁÑ∂ÂæåË™™ÊàëÊúâËá™Â∑±ÁöÑË¶èÂäÉ„ÄÇ' },
                { speaker: 'counselor', text: 'ÈÄôÂÄãÈñãÂ†¥ÂæàÊ∫´Âíå„ÄÇË®òÂæóÔºåË°®ÈÅîËá™Â∑±‰∏ç‰ª£Ë°®Ë°ùÁ™ÅÔºåËÄåÊòØËÆìÂ∞çÊñπÊõ¥‰∫ÜËß£‰Ω†„ÄÇ' },
                { speaker: 'client', text: 'ÂóØÔºåÊàëÊúÉË©¶Ë©¶Áúã„ÄÇ' },
                { speaker: 'counselor', text: 'ÈÇ£Â∑•‰ΩúÁöÑÈÉ®ÂàÜÔºå‰Ω†Ë¶∫ÂæóÈúÄË¶ÅË∑ü‰∏ªÁÆ°Ë´áÂóéÔºü' },
                { speaker: 'client', text: 'ÊàëÊÉ≥ÂÜçËßÄÂØüÁúãÁúãÔºåÂ¶ÇÊûúÊÉÖÊ≥ÅÊ≤íÊîπÂñÑÔºåÊàëÂÜçÊâæÊ©üÊúÉË∑ü‰ªñË™™„ÄÇ' },
                { speaker: 'counselor', text: 'Â•ΩÁöÑÔºåÈÄôÊòØ‰Ω†ÁöÑÊ±∫ÂÆö„ÄÇÊàëÂÄë‰∏ãÊ¨°Ë¶ãÈù¢ÊôÇÂèØ‰ª•ÂÜçË®éË´ñÈÄ≤Â±ï„ÄÇ' },
                { speaker: 'client', text: 'Â•Ω„ÄÇ' },
                { speaker: 'counselor', text: '‰ªäÂ§©ÊàëÂÄëËÅä‰∫ÜÂæàÂ§öÔºå‰Ω†Â∞çÂ∑•‰Ωú„ÄÅÂÆ∂Â∫≠„ÄÅÈÇÑÊúâËá™Â∑±ÁöÑÈúÄÊ±ÇÈÉΩÊúâ‰∫ÜÊõ¥Â§öË¶∫ÂØü„ÄÇ' },
                { speaker: 'client', text: 'Â∞çÔºåÊàëË¶∫ÂæóÈáêÊ∏Ö‰∫Ü‰∏Ä‰∫õ‰∫ãÊÉÖ„ÄÇ' },
                { speaker: 'counselor', text: 'ÈÄôÂæàÂ•Ω„ÄÇË®òÂæóÔºåÊîπËÆäÈúÄË¶ÅÊôÇÈñìÔºåÂ∞çËá™Â∑±ÊúâËÄêÂøÉ‰∏ÄÈªû„ÄÇ' },
                { speaker: 'client', text: 'ÊàëÊúÉÁöÑÔºåË¨ùË¨ù‰Ω†„ÄÇ' },
                { speaker: 'counselor', text: '‰∏çÂÆ¢Ê∞£„ÄÇÊàëÂÄë‰∏ãÈÄ±Âêå‰∏ÄÊôÇÈñìË¶ãÔºå‰Ω†Ë¶∫ÂæóÂèØ‰ª•ÂóéÔºü' },
                { speaker: 'client', text: 'ÂèØ‰ª•Ôºå‰∏ãÈÄ±Ë¶ã„ÄÇ' },
                { speaker: 'counselor', text: 'Â•ΩÁöÑÔºåÈÇ£Â∞±‰∏ãÈÄ±Ë¶ã„ÄÇË®òÂæóÁÖßÈ°ßÂ•ΩËá™Â∑±„ÄÇ' },
                { speaker: 'client', text: 'Â•ΩÔºå‰Ω†‰πüÊòØ„ÄÇ' }
            ]
        };

        let currentScript = demoScripts.workStress; // È†êË®≠‰ΩøÁî®Â∑•‰ΩúÂ£ìÂäõÂäáÊú¨

        function simulateTranscriptInput() {
            // Test mode: Allow manual transcript simulation
            // Works independently of recording state - useful for testing UI

            // Âæ™Â∫èÊí≠ÊîæÂäáÊú¨
            if (demoScriptIndex < currentScript.length) {
                const line = currentScript[demoScriptIndex];

                // Ëá™ÂãïÂàáÊèõË™™Ë©±ËÄÖ
                if (line.speaker !== currentSpeaker) {
                    switchSpeaker(line.speaker);
                }

                addTranscriptLine(line.speaker, line.text);
                demoScriptIndex++;

                console.log(`üìù Test mode: Added line ${demoScriptIndex}/${currentScript.length} - ${line.speaker}: ${line.text.substring(0, 30)}...`);
            } else {
                // ÂäáÊú¨Êí≠ÂÆåÔºåÈáçÁΩÆÊàñÊèêÁ§∫
                console.log('‚úÖ Demo ÂäáÊú¨Â∑≤Êí≠ÊîæÂÆåÁï¢ÔºåÊåâ R ÈçµÈáçÊñ∞ÈñãÂßã');
            }
        }

        // === Audio Simulation Functions ===
        function initializeAudioSimulation() {
            // Calculate total duration from script timestamps
            const lastLine = currentScript[currentScript.length - 1];
            audioSimulation.duration = lastLine.time || 400; // Default 400 seconds (~6.7 minutes)

            // Reset state
            audioSimulation.currentTime = 0;
            audioSimulation.lastDisplayedIndex = 0;
            audioSimulation.isPlaying = false;

            // Update UI - only show player if voice simulation is enabled
            if (audioPlayerSection) {
                audioPlayerSection.style.display = isVoiceSimEnabled ? 'block' : 'none';
                audioStatus.textContent = 'Ê∫ñÂÇôÂ∞±Á∑í';
                audioDuration.textContent = formatTime(audioSimulation.duration);
                audioCurrentTime.textContent = '0:00';
                audioProgress.style.width = '0%';
            }

            console.log(`üéµ Èü≥Ë®äÊ®°Êì¨Â∑≤ÂàùÂßãÂåñÔºåÁ∏ΩÊôÇÈï∑: ${formatTime(audioSimulation.duration)}`);
        }

        // === Web Speech API (TTS) Functions ===
        function initializeSpeechSynthesis() {
            if (!ttsState.isSupported) {
                console.warn('‚ö†Ô∏è Ê≠§ÁÄèË¶ΩÂô®‰∏çÊîØÊè¥ Web Speech API (TTS)');
                return;
            }

            // Wait for voices to be loaded
            function loadVoices() {
                ttsState.voices = speechSynthesis.getVoices();
                selectVoices();
            }

            // Voices may load asynchronously
            speechSynthesis.onvoiceschanged = loadVoices;

            // Try loading immediately (some browsers have voices ready)
            loadVoices();

            console.log('üîä Web Speech API (TTS) Â∑≤ÂàùÂßãÂåñ');
        }

        function selectVoices() {
            if (ttsState.voices.length === 0) {
                console.warn('‚ö†Ô∏è Â∞öÊú™ËºâÂÖ•Ë™ûÈü≥ÂàóË°®');
                return;
            }

            // Try to find Traditional Chinese (zh-TW) voices
            const zhTWVoices = ttsState.voices.filter(v => v.lang.includes('zh-TW'));
            const zhVoices = ttsState.voices.filter(v => v.lang.includes('zh'));

            // Select counselor voice (prefer female voice for Traditional Chinese)
            ttsState.counselorVoice = zhTWVoices.find(v => v.name.includes('Female') || v.name.includes('Â•≥')) ||
                                     zhTWVoices.find(v => v.name.includes('Meijia') || v.name.includes('Áæé‰Ω≥')) ||
                                     zhVoices.find(v => v.name.includes('Female') || v.name.includes('Â•≥')) ||
                                     zhTWVoices[0] ||
                                     zhVoices[0] ||
                                     ttsState.voices[0]; // Fallback to any voice

            // Select client voice (prefer male voice for Traditional Chinese)
            ttsState.clientVoice = zhTWVoices.find(v => v.name.includes('Male') || v.name.includes('Áî∑')) ||
                                  zhTWVoices.find(v => v.name.includes('Zhiwei') || v.name.includes('ÂøóÂ®Å')) ||
                                  zhVoices.find(v => v.name.includes('Male') || v.name.includes('Áî∑')) ||
                                  zhTWVoices[1] || // Try different voice from counselor
                                  zhVoices[1] ||
                                  ttsState.voices[1] || // Fallback to different voice
                                  ttsState.voices[0]; // Last resort

            console.log(`üéôÔ∏è Ë´ÆË©¢Â∏´Ë™ûÈü≥: ${ttsState.counselorVoice?.name || 'Êú™ÈÅ∏Êìá'} (${ttsState.counselorVoice?.lang || 'N/A'})`);
            console.log(`üéôÔ∏è Ê°à‰∏ªË™ûÈü≥: ${ttsState.clientVoice?.name || 'Êú™ÈÅ∏Êìá'} (${ttsState.clientVoice?.lang || 'N/A'})`);
            console.log(`üìã ÂèØÁî®Ë™ûÈü≥Êï∏Èáè: ${ttsState.voices.length}`);
        }

        function speakText(text, speaker) {
            if (!ttsState.isSupported) return;
            if (!isVoiceSimEnabled) return; // Only speak if voice simulation is enabled
            if (!audioSimulation.isPlaying) return; // Only speak if audio is playing

            // Cancel any ongoing speech
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-TW'; // Traditional Chinese

            // Select voice and adjust pitch based on speaker
            if (speaker === 'counselor') {
                utterance.voice = ttsState.counselorVoice;
                utterance.pitch = 1.1; // Slightly higher pitch for counselor
            } else {
                utterance.voice = ttsState.clientVoice;
                utterance.pitch = 0.9; // Slightly lower pitch for client
            }

            // Speech settings
            utterance.rate = 1.0; // Normal speed
            utterance.volume = 1.0; // Full volume

            // Error handling
            utterance.onerror = (event) => {
                console.error('üîá TTS ÈåØË™§:', event.error);
            };

            // Store reference and speak
            ttsState.currentUtterance = utterance;
            speechSynthesis.speak(utterance);

            console.log(`üó£Ô∏è TTS: ${speaker === 'counselor' ? 'Ë´ÆË©¢Â∏´' : 'Ê°à‰∏ª'} - "${text.substring(0, 20)}${text.length > 20 ? '...' : ''}"`);
        }

        function stopSpeech() {
            if (ttsState.isSupported && speechSynthesis.speaking) {
                speechSynthesis.cancel();
                console.log('üîá TTS Â∑≤ÂÅúÊ≠¢');
            }
        }

        function toggleAudioPlayback() {
            if (!isRecording) {
                showModal('Â∞öÊú™ÈñãÂßãÊúÉË´á', 'Ë´ãÂÖàÈªûÊìä„ÄåÈñãÂßãÊúÉË´á„Äç', 'info');
                return;
            }

            if (audioSimulation.isPlaying) {
                pauseAudioSimulation();
            } else {
                playAudioSimulation();
            }
        }

        function playAudioSimulation() {
            // If finished, restart from beginning
            if (audioSimulation.currentTime >= audioSimulation.duration) {
                audioSimulation.currentTime = 0;
                audioSimulation.lastDisplayedIndex = 0;
                transcriptSegments = [];
                transcript.innerHTML = '';
                console.log('‚Ü∫ ÈáçÊñ∞ÈñãÂßãÊí≠Êîæ');
            }

            audioSimulation.isPlaying = true;
            audioSimulation.startTimeMs = performance.now() - (audioSimulation.currentTime * 1000);

            // Update UI
            audioPlayIcon.textContent = '‚è∏Ô∏è';
            audioPlayText.textContent = 'Êö´ÂÅú';
            audioStatus.textContent = 'Êí≠Êîæ‰∏≠';

            // Start animation loop
            updateAudioProgress();

            console.log('‚ñ∂Ô∏è ÈñãÂßãÊí≠ÊîæÊ®°Êì¨Èü≥Ë®ä');
        }

        function pauseAudioSimulation() {
            audioSimulation.isPlaying = false;

            if (audioSimulation.animationFrame) {
                cancelAnimationFrame(audioSimulation.animationFrame);
                audioSimulation.animationFrame = null;
            }

            // Stop speech synthesis
            stopSpeech();

            // Update UI
            audioPlayIcon.textContent = '‚ñ∂Ô∏è';
            audioPlayText.textContent = 'ÁπºÁ∫åÊí≠Êîæ';
            audioStatus.textContent = 'Â∑≤Êö´ÂÅú';

            console.log('‚è∏Ô∏è Êö´ÂÅúÊí≠Êîæ');
        }

        function seekAudio(percentage) {
            const newTime = audioSimulation.duration * percentage;
            audioSimulation.currentTime = newTime;
            audioSimulation.startTimeMs = performance.now() - (newTime * 1000);

            // Stop any ongoing speech when seeking
            stopSpeech();

            // Update which lines should be displayed
            audioSimulation.lastDisplayedIndex = 0;
            transcriptSegments = [];
            transcript.innerHTML = '';

            // Display all lines up to current time
            for (let i = 0; i < currentScript.length; i++) {
                const line = currentScript[i];
                if (line.time && line.time <= newTime) {
                    if (line.speaker !== currentSpeaker) {
                        switchSpeaker(line.speaker);
                    }
                    addTranscriptLine(line.speaker, line.text);
                    audioSimulation.lastDisplayedIndex = i + 1;
                } else {
                    break;
                }
            }

            updateAudioUI();
            console.log(`‚è© Ë∑≥ËΩâÂà∞ ${formatTime(newTime)}`);
        }

        function updateAudioProgress() {
            if (!audioSimulation.isPlaying) return;

            const elapsed = performance.now() - audioSimulation.startTimeMs;
            audioSimulation.currentTime = Math.min(elapsed / 1000, audioSimulation.duration);

            // Display new transcript lines based on timestamp
            displayTranscriptAtTime(audioSimulation.currentTime);

            // Update UI
            updateAudioUI();

            // Check if finished
            if (audioSimulation.currentTime >= audioSimulation.duration) {
                audioSimulation.isPlaying = false;
                audioStatus.textContent = 'Êí≠ÊîæÂÆåÁï¢';
                audioPlayIcon.textContent = '‚Ü∫';
                audioPlayText.textContent = 'ÈáçÊñ∞Êí≠Êîæ';
                console.log('‚úÖ Èü≥Ë®äÊí≠ÊîæÂÆåÁï¢');
                return;
            }

            // Continue loop
            audioSimulation.animationFrame = requestAnimationFrame(updateAudioProgress);
        }

        function displayTranscriptAtTime(currentTime) {
            // Display all lines that should appear by current time
            for (let i = audioSimulation.lastDisplayedIndex; i < currentScript.length; i++) {
                const line = currentScript[i];

                if (line.time && line.time <= currentTime) {
                    // Switch speaker if needed
                    if (line.speaker !== currentSpeaker) {
                        switchSpeaker(line.speaker);
                    }

                    // Add transcript line
                    addTranscriptLine(line.speaker, line.text);

                    // Speak the text using TTS if voice simulation is enabled
                    if (isVoiceSimEnabled && audioSimulation.isPlaying) {
                        speakText(line.text, line.speaker);
                    }

                    audioSimulation.lastDisplayedIndex = i + 1;
                } else {
                    // Not yet time for this line
                    break;
                }
            }
        }

        function updateAudioUI() {
            const progress = (audioSimulation.currentTime / audioSimulation.duration) * 100;
            audioProgress.style.width = `${progress}%`;
            audioCurrentTime.textContent = formatTime(audioSimulation.currentTime);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${String(secs).padStart(2, '0')}`;
        }

        // Demo: Press 'T' to add next transcript line
        // Press 'R' to reset script
        // Press '1' for work stress script, '2' for general script
        document.addEventListener('keydown', (e) => {
            if (e.key === 't' || e.key === 'T') {
                simulateTranscriptInput();
            } else if (e.key === 'r' || e.key === 'R') {
                demoScriptIndex = 0;
                console.log('Demo ÂäáÊú¨Â∑≤ÈáçÁΩÆ');
            } else if (e.key === '1') {
                currentScript = demoScripts.workStress;
                demoScriptIndex = 0;
                console.log('ÂàáÊèõÂà∞ÂäáÊú¨ 1: Â∑•‰ΩúÂ£ìÂäõËàáÁÑ¶ÊÖÆ');
            } else if (e.key === '2') {
                currentScript = demoScripts.general;
                demoScriptIndex = 0;
                console.log('ÂàáÊèõÂà∞ÂäáÊú¨ 2: ‰∏ÄËà¨Ë´ÆË©¢');
            }
        });

        // === Initialize ===
        // Initialize waveform animations as paused on page load
        updateWaveformAnimations();

        // Hide speaker toggle in demo mode (scripted conversations auto-switch speaker)
        if (isDemoMode && speakerToggleSection) {
            speakerToggleSection.style.display = 'none';
        }

        // Hide history section in demo mode
        const historyContainer = document.getElementById('historyContainer');
        if (isDemoMode && historyContainer) {
            historyContainer.style.display = 'none';
        }

        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        console.log('üé§ AI Âç≥ÊôÇË¶™Â≠êË´ÆË©¢ÂàÜÊûêÁ≥ªÁµ± - Demo Ê®°ÂºèÔºàÈü≥Ë®äÂêåÊ≠•ÁâàÔºâ');
        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        console.log('');
        console.log('üéµ Èü≥Ë®äÊí≠ÊîæÊ®°ÂºèÔºö');
        console.log('  1. ÈªûÊìä„ÄåÈñãÂßãÊúÉË´á„Äç');
        console.log('  2. ÈªûÊìä„ÄåÊí≠ÊîæÂ∞çË©±„ÄçÊåâÈàï');
        console.log('  3. ÈÄêÂ≠óÁ®øÊúÉÊ†πÊìöÈü≥Ë®äÊôÇÈñìÊà≥Ëá™ÂãïÈ°ØÁ§∫');
        console.log('  4. Èö®ÊôÇÈªûÊìä„ÄåÂç≥ÊôÇÂàÜÊûê„ÄçÂàÜÊûêÁï∂ÂâçÂ∑≤È°ØÁ§∫ÁöÑÂ∞çË©±');
        console.log('');
        console.log('üìå Âø´Êç∑ÈçµË™™ÊòéÔºàÂÇôÁî®ÊâãÂãïÊ®°ÂºèÔºâÔºö');
        console.log('  T - ÊâãÂãïÊí≠Êîæ‰∏ã‰∏ÄÂè•Â∞çË©±');
        console.log('  R - ÈáçÁΩÆÂäáÊú¨');
        console.log('  1 - Â∑•‰ΩúÂ£ìÂäõÂäáÊú¨ÔºàÂê´Ëá™ÊÆ∫È¢®Èö™Ôºâ');
        console.log('  2 - ‰∏ÄËà¨Ë´ÆË©¢ÂäáÊú¨');
        console.log('');
        console.log('ü§ñ AI ÂàÜÊûêÔºö');
        console.log('  ‚Ä¢ Ëá™ÂãïÊ®°ÂºèÔºöÊØè 60 ÁßíËá™ÂãïËß∏Áôº');
        console.log('  ‚Ä¢ ÊâãÂãïÊ®°ÂºèÔºöÈö®ÊôÇÈªûÊìä„ÄåÂç≥ÊôÇÂàÜÊûê„ÄçÊåâÈàï');
        console.log('  ‚Ä¢ ÂàÜÊûêÁØÑÂúçÔºöÂÉÖÂàÜÊûêÁï∂ÂâçÂ∑≤È°ØÁ§∫ÁöÑÈÄêÂ≠óÁ®ø');
        console.log('');
        console.log('‚ú® Áï∂ÂâçÂäáÊú¨ÔºöÂ∑•‰ΩúÂ£ìÂäõËàáÁÑ¶ÊÖÆÔºàÂäáÊú¨ 1Ôºâ');
        console.log('üí° Demo Ê®°ÂºèÔºöÊ®°Êì¨Âç≥ÊôÇÂ∞çË©±ÔºåË™™Ë©±ËÄÖËá™ÂãïÂàáÊèõ');
        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

        // ==================== Login/Logout Functionality ====================
        // Check if user is logged in on page load
        function checkAuth() {
            const token = localStorage.getItem('authToken');
            const email = localStorage.getItem('userEmail');

            if (token && email) {
                // User is logged in
                document.getElementById('loginContainer').style.display = 'none';

                // Show mobile global navigation (only on mobile)
                document.getElementById('mobileGlobalNav').style.display = 'block';

                // Mobile: Show onboarding (client selection) first
                // Desktop: Show main content directly
                const isMobile = window.innerWidth < 768;
                if (isMobile) {
                    document.getElementById('onboardingContainer').style.display = 'block';
                    document.getElementById('mainContent').style.display = 'none';

                    // Show onboarding screen 1 (client selection)
                    document.getElementById('onboardingScreen1').style.display = 'flex';
                    document.getElementById('onboardingScreen2').style.display = 'none';
                    document.getElementById('clientListMode').style.display = 'flex';
                    document.getElementById('clientFormMode').style.display = 'none';
                } else {
                    document.getElementById('mainContent').style.display = 'block';
                    document.getElementById('onboardingContainer').style.display = 'none';
                }

                // Display user email in header
                const emailDisplay = document.getElementById('userEmailDisplay');
                if (emailDisplay) {
                    emailDisplay.textContent = email;
                }
            } else {
                // User is not logged in, show login form
                document.getElementById('loginContainer').style.display = 'flex';
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('onboardingContainer').style.display = 'none';
                document.getElementById('mobileGlobalNav').style.display = 'none';
            }
        }

        // Debug Mode: Long-press handler
        let longPressTimer = null;
        let isDebugMode = localStorage.getItem('debugMode') === 'true';

        // Show debug indicator if already in debug mode
        if (isDebugMode) {
            document.getElementById('debugIndicator').classList.remove('hidden');
        }

        const loginSubmitBtn = document.getElementById('loginSubmitBtn');

        // Long-press start (works for both touch and mouse)
        function startLongPress(e) {
            longPressTimer = setTimeout(() => {
                // Enable debug mode after 3 seconds
                isDebugMode = true;
                localStorage.setItem('debugMode', 'true');
                document.getElementById('debugIndicator').classList.remove('hidden');
                showLoginAlert('Debug mode activated! Click to skip login.', 'success');

                // Vibrate if supported (mobile)
                if (navigator.vibrate) {
                    navigator.vibrate(200);
                }
            }, 3000);
        }

        // Long-press end
        function endLongPress() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }

        // Add event listeners for long-press
        loginSubmitBtn.addEventListener('mousedown', startLongPress);
        loginSubmitBtn.addEventListener('mouseup', endLongPress);
        loginSubmitBtn.addEventListener('mouseleave', endLongPress);
        loginSubmitBtn.addEventListener('touchstart', startLongPress);
        loginSubmitBtn.addEventListener('touchend', endLongPress);
        loginSubmitBtn.addEventListener('touchcancel', endLongPress);

        // Toggle advanced options
        function toggleAdvancedOptions() {
            const advancedPanel = document.getElementById('advancedOptions');
            const toggleBtn = document.getElementById('showAdvancedBtn');
            if (advancedPanel.classList.contains('hidden')) {
                advancedPanel.classList.remove('hidden');
                toggleBtn.textContent = 'ÈÄ≤ÈöéÈÅ∏È†Ö ‚ñ≤';
            } else {
                advancedPanel.classList.add('hidden');
                toggleBtn.textContent = 'ÈÄ≤ÈöéÈÅ∏È†Ö ‚ñº';
            }
        }

        // Handle login form submission
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('loginEmail').value;
            const tenantId = document.getElementById('loginTenantId').value;

            const submitBtn = document.getElementById('loginSubmitBtn');
            const btnText = document.getElementById('loginBtnText');
            const btnSpinner = document.getElementById('loginBtnSpinner');

            // Debug mode: Skip login
            if (isDebugMode) {
                console.log('[DEBUG MODE] Skipping login, using fake token');
                localStorage.setItem('authToken', 'DEBUG_FAKE_TOKEN_' + Date.now());
                localStorage.setItem('userEmail', email || 'debug@example.com');
                localStorage.setItem('tenantId', tenantId);

                // Hide login form
                document.getElementById('loginContainer').style.display = 'none';

                // Show mobile global navigation
                document.getElementById('mobileGlobalNav').style.display = 'block';

                // In debug mode, always show onboarding for island_parents (for testing)
                if (tenantId === 'island_parents') {
                    document.getElementById('onboardingContainer').style.display = 'block';
                    document.getElementById('onboardingScreen1').style.display = 'flex';
                    document.getElementById('onboardingScreen2').style.display = 'none';
                } else {
                    document.getElementById('mainContent').style.display = 'block';
                }

                showLoginAlert('Debug login successful!', 'success');
                return;
            }

            // Normal login flow
            const password = document.getElementById('loginPassword').value;

            if (!password) {
                showLoginAlert('Ë´ãËº∏ÂÖ•ÂØÜÁ¢º', 'error');
                return;
            }

            // Show loading state
            submitBtn.disabled = true;
            btnText.classList.add('hidden');
            btnSpinner.classList.remove('hidden');

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        tenant_id: tenantId
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Login successful
                    localStorage.setItem('authToken', data.access_token);
                    localStorage.setItem('userEmail', email);
                    localStorage.setItem('tenantId', tenantId);

                    // Hide login form
                    document.getElementById('loginContainer').style.display = 'none';

                    // Show mobile global navigation
                    document.getElementById('mobileGlobalNav').style.display = 'block';

                    // island_parents: Always show client selection/creation screen
                    console.log('[LOGIN] Tenant ID:', tenantId);

                    if (tenantId === 'island_parents') {
                        // Load and show client list for island_parents
                        console.log('[LOGIN] island_parents - loading client list');
                        await loadAndShowClientList();
                    } else {
                        // Other tenants - show main content directly
                        console.log('[LOGIN] Other tenant, showing main content');
                        document.getElementById('mainContent').style.display = 'block';
                    }

                    showLoginAlert('ÁôªÂÖ•ÊàêÂäüÔºÅ', 'success');
                } else {
                    // Login failed
                    showLoginAlert(data.detail || 'ÁôªÂÖ•Â§±ÊïóÔºåË´ãÊ™¢Êü•ÊÇ®ÁöÑÂ∏≥ËôüÂØÜÁ¢º', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showLoginAlert('Á∂≤Ë∑ØÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                btnText.classList.remove('hidden');
                btnSpinner.classList.add('hidden');
            }
        });

        // Show alert message in login form
        function showLoginAlert(message, type) {
            const alertContainer = document.getElementById('loginAlertContainer');
            const alertClass = type === 'error' ? 'bg-red-100 border-red-400 text-red-700' : 'bg-green-100 border-green-400 text-green-700';

            alertContainer.innerHTML = `
                <div class="${alertClass} border px-4 py-3 rounded mb-4" role="alert">
                    <span class="block sm:inline">${message}</span>
                </div>
            `;

            // Auto-dismiss success messages
            if (type === 'success') {
                setTimeout(() => {
                    alertContainer.innerHTML = '';
                }, 3000);
            }
        }

        // Load clients and show client list
        async function loadAndShowClientList() {
            try {
                const authToken = localStorage.getItem('authToken');
                console.log('[CLIENT_LIST] Fetching clients...');

                const response = await fetch('/api/v1/clients', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const clients = data.items || data || [];
                    console.log('[CLIENT_LIST] Loaded clients:', clients.length);

                    // Show onboarding container
                    document.getElementById('onboardingContainer').style.display = 'block';

                    // If no clients, show client form
                    if (clients.length === 0) {
                        console.log('[CLIENT_LIST] No clients, showing form');
                        showClientForm();
                        return;
                    }

                    // Show client list mode
                    console.log('[CLIENT_LIST] Showing client list');
                    document.getElementById('onboardingScreen1').style.display = 'flex';
                    document.getElementById('clientListMode').style.display = 'flex';
                    document.getElementById('clientFormMode').style.display = 'none';
                    document.getElementById('onboardingScreen2').style.display = 'none';

                    // Render client list
                    renderClientList(clients);
                } else {
                    console.error('[CLIENT_LIST] Failed to fetch clients');
                    // Show form as fallback
                    showClientForm();
                }
            } catch (error) {
                console.error('[CLIENT_LIST] Error:', error);
                // Show form as fallback
                showClientForm();
            }
        }

        // Render client list
        function renderClientList(clients) {
            const container = document.getElementById('clientListContainer');
            container.innerHTML = '';

            clients.forEach(client => {
                const clientCard = document.createElement('div');
                clientCard.className = 'p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-black hover:bg-gray-50 transition-all';
                clientCard.onclick = () => selectClient(client);

                const grade = client.island_parents?.child_grade || 'Êú™Ë®≠ÂÆöÂπ¥Á¥ö';
                const relation = client.island_parents?.parent_relation || 'Êú™Ë®≠ÂÆöÈóú‰øÇ';

                clientCard.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-lg font-bold text-gray-800">${client.name}</div>
                            <div class="text-sm text-gray-600 mt-1">${grade} ¬∑ ${relation}</div>
                        </div>
                        <div class="text-2xl">üë§</div>
                    </div>
                `;

                container.appendChild(clientCard);
            });
        }

        // Select a client
        function selectClient(client) {
            console.log('[CLIENT_SELECT] Selected client:', client.name);

            // Store selected client info
            localStorage.setItem('selectedClientId', client.id);
            localStorage.setItem('selectedClientName', client.name);

            // Hide onboarding container
            document.getElementById('onboardingContainer').style.display = 'none';

            // Show main content with practice/real choice
            document.getElementById('mainContent').style.display = 'block';
        }

        // NOTE: showClientForm() is defined early in the page (line ~490)
        // Do not redefine it here

        // Check if user has client with island_parents data
        async function checkClientExists(authToken) {
            try {
                console.log('[CHECK_CLIENT] Fetching clients...');
                const response = await fetch('/api/v1/clients', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                console.log('[CHECK_CLIENT] Response status:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    const clients = data.items || data || [];

                    console.log('[CHECK_CLIENT] Total clients:', clients.length);
                    console.log('[CHECK_CLIENT] Clients data:', clients);

                    // Check if user has at least one client with island_parents data
                    const hasValidClient = clients.length > 0 && clients.some(client => {
                        const hasData = client.island_parents &&
                               client.island_parents.child_grade &&
                               client.island_parents.parent_relation;
                        console.log('[CHECK_CLIENT] Client', client.id || client.name, 'has island_parents data:', hasData);
                        return hasData;
                    });

                    console.log('[CHECK_CLIENT] Has valid client:', hasValidClient);
                    return hasValidClient;
                }

                console.log('[CHECK_CLIENT] API call failed, returning false');
                return false;
            } catch (error) {
                console.error('[CHECK_CLIENT] Error:', error);
                return false;
            }
        }

        // Onboarding: Skip onboarding and go to main content
        function skipOnboarding() {
            document.getElementById('onboardingContainer').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        // NOTE: backToClientSelection() is defined early in the page (line ~500)
        // Do not redefine it here

        // Onboarding: Set counseling mode (emergency or practice)
        function setOnboardingMode(mode) {
            console.log(`[ONBOARDING] Setting mode to: ${mode}`);
            counselingMode = mode;

            // Update button styles
            const emergencyBtn = document.getElementById('onboardingEmergencyBtn');
            const practiceBtn = document.getElementById('onboardingPracticeBtn');

            if (mode === 'emergency') {
                emergencyBtn.classList.remove('bg-gray-200', 'text-gray-700');
                emergencyBtn.classList.add('bg-red-500', 'text-white');
                practiceBtn.classList.remove('bg-green-500', 'text-white');
                practiceBtn.classList.add('bg-gray-200', 'text-gray-700');
            } else {
                practiceBtn.classList.remove('bg-gray-200', 'text-gray-700');
                practiceBtn.classList.add('bg-green-500', 'text-white');
                emergencyBtn.classList.remove('bg-red-500', 'text-white');
                emergencyBtn.classList.add('bg-gray-200', 'text-gray-700');
            }

            console.log(`[ONBOARDING] Mode set to: ${counselingMode}`);
        }

        // Onboarding: Complete onboarding and go to main content
        function completeOnboarding() {
            console.log(`[ONBOARDING] Completing with mode: ${counselingMode}`);

            // Apply the selected mode to the main session
            setCounselingMode(counselingMode);

            document.getElementById('onboardingContainer').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';

            console.log('[ONBOARDING] Complete, mode applied to session');
        }

        // Onboarding: Handle client setup form submission
        document.getElementById('clientSetupForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const childNickname = document.getElementById('childNickname').value;
            const childGrade = document.getElementById('childGrade').value;
            const parentRelation = document.getElementById('parentRelation').value;

            const submitBtn = document.getElementById('clientSetupSubmitBtn');
            const btnText = document.getElementById('clientSetupBtnText');
            const btnSpinner = document.getElementById('clientSetupBtnSpinner');

            // Show loading state
            submitBtn.disabled = true;
            btnText.classList.add('hidden');
            btnSpinner.classList.remove('hidden');

            try {
                const authToken = localStorage.getItem('authToken');
                const tenantId = localStorage.getItem('tenantId');

                // Create client via API
                const response = await fetch('/api/v1/clients', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        tenant_id: tenantId,
                        name: childNickname,
                        // email ÈÅ∏Â°´ÔºåË¶™Â≠êÁâà‰∏çÈúÄË¶Å
                        gender: '‰∏çÈÄèÈú≤',
                        birth_date: '2015-01-01',
                        phone: '0000000000',
                        identity_option: 'Â≠©Â≠ê',
                        current_status: `Âπ¥Á¥ö: ${childGrade}`,
                        notes: `Èóú‰øÇ: ${parentRelation}`,
                        case_summary: `Ë¶™Â≠êÊ∫ùÈÄöÁ∑¥Áøí - ${new Date().toLocaleString('zh-TW')}`,
                        case_goals: 'ÊîπÂñÑË¶™Â≠êÈóú‰øÇ',
                        problem_description: 'Á∂≤È†ÅÂç≥ÊôÇË´ÆË©¢'
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Client created successfully
                    console.log('Client created:', data);

                    // Clear form
                    document.getElementById('clientSetupForm').reset();

                    // Reload client list
                    await loadAndShowClientList();

                    // Show success message
                    showModal('Êñ∞Â¢ûÊàêÂäü', `${childNickname} Â∑≤ÊàêÂäüÊñ∞Â¢ûÔºÅ`, 'success');
                } else {
                    // Client creation failed
                    showModal('Âª∫Á´ãÂ§±Êïó', data.detail || 'Âª∫Á´ãÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
                    console.error('Client creation failed:', data);
                }
            } catch (error) {
                console.error('Client setup error:', error);
                showModal('Á∂≤Ë∑ØÈåØË™§', 'Á∂≤Ë∑ØÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                btnText.classList.remove('hidden');
                btnSpinner.classList.add('hidden');
            }
        });

        // NOTE: goToHome() and logout() are defined early in the page (line ~399, ~465)
        // to support mobile nav buttons. Do not redefine them here.

        // Check auth on page load
        checkAuth();
    </script>
</body>
</html>
