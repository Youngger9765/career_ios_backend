<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>å³æ™‚è«®å•†è¼”åŠ©ç³»çµ± - Realtime Counseling</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS for commercial-grade UI */
        * {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
        }

        /* Safe area for mobile notches */
        .safe-area-inset-bottom {
            padding-bottom: max(1rem, env(safe-area-inset-bottom));
        }

        /* Smooth transitions */
        .transition-smooth {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Card hover effects */
        .card-hover {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
        }

        /* Animated gradient backgrounds */
        .gradient-animate {
            background-size: 200% 200%;
            animation: gradientShift 8s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Pulse animation for recording */
        .pulse-recording {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Fade in animation */
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Chat bubble styles */
        .chat-bubble {
            max-width: 85%;
            word-wrap: break-word;
        }

        @media (min-width: 768px) {
            .chat-bubble {
                max-width: 75%;
            }
        }

        /* Touch-friendly button sizes */
        .btn-touch {
            min-height: 44px;
            min-width: 44px;
        }

        /* Badge severity colors */
        .badge-critical {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .badge-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .badge-info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .badge-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <!-- Header - Commercial Grade with Gradient -->
    <nav class="sticky top-0 z-50 bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-700 shadow-lg gradient-animate">
        <div class="container mx-auto max-w-7xl px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 md:w-12 md:h-12 bg-white rounded-xl flex items-center justify-center shadow-md">
                        <span class="text-2xl">ğŸ¤</span>
                    </div>
                    <div>
                        <h1 class="text-white font-bold text-lg md:text-xl">å³æ™‚è«®å•†è¼”åŠ©</h1>
                        <p class="text-indigo-200 text-xs hidden md:block">AI-Powered Counseling Assistant</p>
                    </div>
                </div>
                <a href="/console" class="text-white hover:bg-white/20 px-3 md:px-4 py-2 rounded-lg transition-smooth text-sm font-medium backdrop-blur-sm bg-white/10">
                    <span class="hidden md:inline">â† è¿”å›æ§åˆ¶å°</span>
                    <span class="md:hidden">â† è¿”å›</span>
                </a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 md:px-6 py-4 md:py-6 max-w-7xl pb-24 md:pb-6">
        <!-- Demo Mode Instructions - Collapsible on Mobile -->
        <div class="bg-gradient-to-r from-yellow-50 to-amber-50 border-l-4 border-yellow-400 p-4 mb-4 md:mb-6 rounded-xl shadow-md card-hover" style="display: none">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-yellow-400 rounded-lg flex items-center justify-center">
                        <svg class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
                <div class="ml-3 flex-1">
                    <h3 class="text-sm md:text-base font-bold text-yellow-800 flex items-center gap-2">
                        <span>ğŸ­ Demo æ¨¡å¼èªªæ˜</span>
                        <span class="text-xs bg-yellow-200 text-yellow-800 px-2 py-0.5 rounded-full">ç„¡éœ€ API Key</span>
                    </h3>
                    <div class="mt-2 text-sm text-yellow-700 leading-relaxed">
                        <p class="mb-2">æ­¤ç‚ºå±•ç¤ºæ¨¡å¼ï¼Œä½¿ç”¨æ™ºæ…§å‡è³‡æ–™æ¨¡æ“¬å®Œæ•´åŠŸèƒ½ï¼š</p>
                        <ul class="space-y-1 ml-2">
                            <li class="flex items-center gap-2">
                                <kbd class="px-2 py-1 bg-white rounded border shadow-sm font-mono text-xs">T</kbd>
                                <span>æ’­æ”¾ä¸‹ä¸€å¥å°è©±ï¼ˆè‡ªå‹•åˆ‡æ›èªªè©±è€…ï¼‰</span>
                            </li>
                            <li class="flex items-center gap-2">
                                <kbd class="px-2 py-1 bg-white rounded border shadow-sm font-mono text-xs">R</kbd>
                                <span>é‡ç½®åŠ‡æœ¬å¾é ­é–‹å§‹</span>
                            </li>
                            <li class="flex items-center gap-2">
                                <kbd class="px-2 py-1 bg-white rounded border shadow-sm font-mono text-xs">1</kbd>
                                <span>åˆ‡æ›åˆ°ã€Œå·¥ä½œå£“åŠ›ã€åŠ‡æœ¬ï¼ˆå«è‡ªæ®ºé¢¨éšªåµæ¸¬ï¼‰</span>
                            </li>
                            <li class="flex items-center gap-2">
                                <kbd class="px-2 py-1 bg-white rounded border shadow-sm font-mono text-xs">2</kbd>
                                <span>åˆ‡æ›åˆ°ã€Œä¸€èˆ¬è«®è©¢ã€åŠ‡æœ¬</span>
                            </li>
                        </ul>
                        <p class="mt-3 font-bold bg-yellow-100 p-2 rounded-lg">ğŸ’¡ AI åˆ†ææ¯ 60 ç§’è‡ªå‹•è§¸ç™¼ï¼Œæ ¹æ“šé€å­—ç¨¿å…§å®¹æ™ºæ…§ç”Ÿæˆæ‘˜è¦ã€è­¦ç¤ºã€å»ºè­°ã€‚</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Left Panel: Recording Controls -->
            <div class="space-y-4">
                <!-- Recording Controls - Enhanced -->
                <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 card-hover border border-gray-100">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-8 h-8 bg-gradient-to-br from-red-500 to-pink-500 rounded-lg flex items-center justify-center">
                            <span class="text-white text-lg">ğŸ™ï¸</span>
                        </div>
                        <h2 class="text-lg md:text-xl font-bold text-gray-800">éŒ„éŸ³æ§åˆ¶</h2>
                    </div>

                    <!-- Timer Display - More Prominent -->
                    <div class="text-center mb-6 bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-4 md:p-6">
                        <div class="text-4xl md:text-5xl font-mono font-bold text-gray-800" id="timer">00:00</div>
                        <div class="text-xs md:text-sm text-gray-500 mt-2 font-medium">æœƒè«‡æ™‚é–“</div>
                    </div>

                    <!-- Start/Stop Buttons - Desktop -->
                    <div class="hidden md:grid md:grid-cols-2 gap-4 mb-6">
                        <button id="startBtn" class="btn-touch bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white py-4 px-6 rounded-xl font-bold transition-smooth shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                            <span class="text-xl">â–¶ï¸</span>
                            <span>é–‹å§‹æœƒè«‡</span>
                        </button>
                        <button id="stopBtn" class="btn-touch bg-gradient-to-r from-red-500 to-rose-600 text-white py-4 px-6 rounded-xl font-bold opacity-50 cursor-not-allowed shadow-md flex items-center justify-center gap-2" disabled>
                            <span class="text-xl">â¹ï¸</span>
                            <span>çµæŸæœƒè«‡</span>
                        </button>
                    </div>

                    <!-- Speaker Toggle (Manual) - Enhanced -->
                    <!-- Hidden in Demo mode since scripted conversations include speaker info -->
                    <div class="mb-4" id="speakerToggleSection">
                        <label class="block text-sm font-bold mb-3 text-gray-700">ç•¶å‰èªªè©±è€…</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button id="speakerCounselor" class="btn-touch py-3 px-4 rounded-xl font-bold bg-gradient-to-br from-blue-500 to-indigo-600 text-white transition-smooth shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                                <span class="text-lg">ğŸ‘¨â€âš•ï¸</span>
                                <span class="text-sm md:text-base">è«®å•†å¸«</span>
                            </button>
                            <button id="speakerClient" class="btn-touch py-3 px-4 rounded-xl font-bold bg-gray-200 text-gray-700 transition-smooth hover:bg-gray-300 shadow-sm flex items-center justify-center gap-2">
                                <span class="text-lg">ğŸ§‘</span>
                                <span class="text-sm md:text-base">æ¡ˆä¸»</span>
                            </button>
                        </div>
                    </div>

                    <!-- Status Indicator - Enhanced -->
                    <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-4 border border-gray-200">
                        <div class="flex items-center justify-between text-sm mb-2">
                            <span class="font-bold text-gray-700">ç‹€æ…‹ï¼š</span>
                            <span id="status" class="text-gray-600 font-medium">å¾…æ©Ÿä¸­</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="font-bold text-gray-700">ä¸‹æ¬¡åˆ†æï¼š</span>
                            <span id="nextAnalysis" class="text-gray-600 font-medium">æœªé–‹å§‹</span>
                        </div>
                    </div>

                    <!-- Demo Mode Hint - Enhanced -->
                    <div class="mt-4 p-3 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl">
                        <p class="text-xs md:text-sm text-blue-700 leading-relaxed">
                            ğŸ’¡ <strong>æ¸¬è©¦æ¨¡å¼</strong>ï¼šæŒ‰ <kbd class="bg-blue-200 px-2 py-1 rounded font-mono text-xs">T</kbd> éµå¯æ¨¡æ“¬è¼¸å…¥å°è©±æ–‡å­—
                        </p>
                    </div>
                </div>
            </div>

            <!-- Right Panel: AI Analysis Cards -->
            <div class="space-y-4">
                <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 card-hover border border-gray-100">
                    <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-3 mb-4">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-lg flex items-center justify-center">
                                <span class="text-white text-lg">ğŸ¤–</span>
                            </div>
                            <h2 class="text-lg md:text-xl font-bold text-gray-800">AI å³æ™‚åˆ†æ</h2>
                        </div>
                        <div class="flex gap-2 flex-wrap">
                            <button id="triggerAnalysisBtn" class="btn-touch bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white px-3 md:px-4 py-2 rounded-lg text-xs md:text-sm font-bold transition-smooth shadow-md opacity-50 cursor-not-allowed flex items-center gap-1" disabled>
                                <span>âš¡</span>
                                <span class="hidden sm:inline">ç«‹å³åˆ†æ</span>
                                <span class="sm:hidden">åˆ†æ</span>
                            </button>
                            <button id="generateMultipleBtn" class="btn-touch bg-gradient-to-r from-indigo-500 to-blue-600 hover:from-indigo-600 hover:to-blue-700 text-white px-3 md:px-4 py-2 rounded-lg text-xs md:text-sm font-bold transition-smooth shadow-md hover:shadow-lg flex items-center gap-1">
                                <span>ğŸ¬</span>
                                <span class="hidden sm:inline">ç”Ÿæˆé€£çºŒåˆ†æ</span>
                                <span class="sm:hidden">Demo</span>
                            </button>
                        </div>
                    </div>

                    <!-- Analysis Cards Container -->
                    <div id="analysisCards" class="space-y-4 max-h-[600px] md:max-h-[800px] overflow-y-auto custom-scrollbar">
                        <!-- Empty State -->
                        <div class="flex flex-col items-center justify-center py-12 text-center" id="analysisEmpty">
                            <div class="w-16 h-16 md:w-20 md:h-20 bg-gradient-to-br from-purple-100 to-indigo-100 rounded-full flex items-center justify-center mb-4">
                                <span class="text-3xl md:text-4xl">ğŸ’¡</span>
                            </div>
                            <h3 class="text-base md:text-lg font-bold text-gray-800 mb-2">ç­‰å¾…åˆ†æ</h3>
                            <p class="text-gray-600 text-xs md:text-sm max-w-xs">
                                é»æ“Šã€Œç«‹å³åˆ†æã€æˆ–ã€Œç”Ÿæˆé€£çºŒåˆ†æã€æŸ¥çœ‹ AI ç£å°å»ºè­°
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Transcript Section - Collapsible (Moved to Bottom) -->
        <div class="mt-6 bg-white rounded-xl shadow-lg p-4 md:p-6 card-hover border border-gray-100">
            <h2 class="text-lg md:text-xl font-bold mb-4 cursor-pointer flex justify-between items-center transition-smooth hover:text-teal-600" onclick="toggleTranscript()">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-gradient-to-br from-teal-500 to-cyan-500 rounded-lg flex items-center justify-center">
                        <span class="text-white text-lg">ğŸ“</span>
                    </div>
                    <span>å³æ™‚é€å­—ç¨¿</span>
                    <!-- Live Indicator -->
                    <div class="hidden" id="liveIndicator">
                        <span class="flex items-center gap-1 px-2 py-1 bg-red-500 text-white text-xs rounded-full animate-pulse">
                            <span class="w-2 h-2 bg-white rounded-full"></span>
                            <span class="font-bold">LIVE</span>
                        </span>
                    </div>
                </div>
                <span id="transcriptToggle" class="text-gray-400 transition-transform duration-300">â–¼</span>
            </h2>
            <div id="transcriptSection" class="hidden">
                <!-- Transcript Container - Chat-like -->
                <div id="transcript" class="h-[400px] md:h-[500px] overflow-y-auto bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 md:p-4 custom-scrollbar">
                    <!-- Empty State -->
                    <div class="flex flex-col items-center justify-center h-full text-center" id="transcriptEmpty">
                        <div class="w-16 h-16 md:w-20 md:h-20 bg-gray-200 rounded-full flex items-center justify-center mb-4">
                            <span class="text-3xl md:text-4xl">ğŸ’¬</span>
                        </div>
                        <h3 class="text-base md:text-lg font-bold text-gray-800 mb-2">é–‹å§‹æ–°æœƒè«‡</h3>
                        <p class="text-gray-600 text-xs md:text-sm">é»æ“Šã€Œé–‹å§‹æœƒè«‡ã€ï¼Œé–‹å§‹è¨˜éŒ„å°è©±</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Bottom Fixed Bar -->
        <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t shadow-2xl safe-area-inset-bottom z-40">
            <div class="px-4 py-3">
                <div class="grid grid-cols-2 gap-3">
                    <button id="startBtnMobile" class="btn-touch bg-gradient-to-r from-green-500 to-emerald-600 active:from-green-600 active:to-emerald-700 text-white py-3 px-4 rounded-xl font-bold transition-smooth shadow-lg flex items-center justify-center gap-2">
                        <span class="text-lg">â–¶ï¸</span>
                        <span class="text-sm">é–‹å§‹</span>
                    </button>
                    <button id="stopBtnMobile" class="btn-touch bg-gradient-to-r from-red-500 to-rose-600 text-white py-3 px-4 rounded-xl font-bold opacity-50 cursor-not-allowed shadow-lg flex items-center justify-center gap-2" disabled>
                        <span class="text-lg">â¹ï¸</span>
                        <span class="text-sm">çµæŸ</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Floating Action Button (Mobile) - Trigger Analysis -->
        <button id="fabAnalyze" class="md:hidden fixed bottom-24 right-4 w-14 h-14 bg-gradient-to-br from-purple-500 to-indigo-600 text-white rounded-full shadow-lg flex items-center justify-center z-40 hover:scale-110 active:scale-95 transition-smooth hidden" aria-label="Trigger Analysis">
            <span class="text-2xl">âš¡</span>
        </button>

        <!-- History Section (Collapsed by default) - Enhanced -->
        <div id="historyContainer" class="mt-6 bg-white rounded-xl shadow-lg p-4 md:p-6 card-hover border border-gray-100">
            <h2 class="text-lg md:text-xl font-bold mb-4 cursor-pointer flex justify-between items-center transition-smooth hover:text-indigo-600" onclick="toggleHistory()">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-gradient-to-br from-gray-500 to-gray-600 rounded-lg flex items-center justify-center">
                        <span class="text-white text-lg">ğŸ“Š</span>
                    </div>
                    <span>æ­·å²è¨˜éŒ„</span>
                </div>
                <span id="historyToggle" class="text-gray-400 transition-transform duration-300">â–¼</span>
            </h2>
            <div id="historySection" class="hidden">
                <button onclick="clearHistory()" class="btn-touch bg-gradient-to-r from-red-500 to-rose-600 hover:from-red-600 hover:to-rose-700 text-white px-4 py-2 rounded-lg mb-4 transition-smooth shadow-md hover:shadow-lg flex items-center gap-2">
                    <span>ğŸ—‘ï¸</span>
                    <span>æ¸…é™¤æ­·å²</span>
                </button>
                <div id="historyList" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <script>
        // === State Management ===
        let isRecording = false;
        let currentSpeaker = 'counselor';
        let startTime = null;
        let timerInterval = null;
        let analysisInterval = null;
        let transcriptSegments = [];
        let analysisHistory = [];
        let isDemoMode = true; // Always in demo mode (no real recording)

        // === DOM Elements ===
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const startBtnMobile = document.getElementById('startBtnMobile');
        const stopBtnMobile = document.getElementById('stopBtnMobile');
        const timer = document.getElementById('timer');
        const status = document.getElementById('status');
        const nextAnalysis = document.getElementById('nextAnalysis');
        const transcript = document.getElementById('transcript');
        const analysisCards = document.getElementById('analysisCards');
        const speakerCounselorBtn = document.getElementById('speakerCounselor');
        const speakerClientBtn = document.getElementById('speakerClient');
        const speakerToggleSection = document.getElementById('speakerToggleSection');
        const triggerAnalysisBtn = document.getElementById('triggerAnalysisBtn');
        const generateMultipleBtn = document.getElementById('generateMultipleBtn');
        const liveIndicator = document.getElementById('liveIndicator');
        const transcriptEmpty = document.getElementById('transcriptEmpty');
        const analysisEmpty = document.getElementById('analysisEmpty');
        const fabAnalyze = document.getElementById('fabAnalyze');

        // === Event Listeners ===
        startBtn.addEventListener('click', startSession);
        stopBtn.addEventListener('click', stopSession);
        startBtnMobile.addEventListener('click', startSession);
        stopBtnMobile.addEventListener('click', stopSession);
        speakerCounselorBtn.addEventListener('click', () => switchSpeaker('counselor'));
        speakerClientBtn.addEventListener('click', () => switchSpeaker('client'));
        triggerAnalysisBtn.addEventListener('click', manuallyTriggerAnalysis);
        generateMultipleBtn.addEventListener('click', generateMultipleAnalyses);
        fabAnalyze.addEventListener('click', manuallyTriggerAnalysis);

        // === Core Functions ===
        function startSession() {
            isRecording = true;
            startTime = Date.now();
            transcriptSegments = [];
            analysisHistory = [];

            // UI Updates - Desktop
            startBtn.disabled = true;
            startBtn.classList.add('opacity-50', 'cursor-not-allowed');
            stopBtn.disabled = false;
            stopBtn.classList.remove('opacity-50', 'cursor-not-allowed');

            // UI Updates - Mobile
            startBtnMobile.disabled = true;
            startBtnMobile.classList.add('opacity-50', 'cursor-not-allowed');
            stopBtnMobile.disabled = false;
            stopBtnMobile.classList.remove('opacity-50', 'cursor-not-allowed');

            // Analysis buttons
            triggerAnalysisBtn.disabled = false;
            triggerAnalysisBtn.classList.remove('opacity-50', 'cursor-not-allowed');

            // Show/hide indicators
            liveIndicator.classList.remove('hidden');
            transcriptEmpty.style.display = 'none';
            fabAnalyze.classList.remove('hidden');

            // Auto-expand transcript section when recording starts
            const transcriptSection = document.getElementById('transcriptSection');
            const transcriptToggle = document.getElementById('transcriptToggle');
            if (transcriptSection.classList.contains('hidden')) {
                transcriptSection.classList.remove('hidden');
                transcriptToggle.textContent = 'â–²';
                transcriptToggle.style.transform = 'rotate(180deg)';
            }

            status.textContent = 'ğŸ”´ éŒ„éŸ³ä¸­';
            status.classList.add('pulse-recording');
            transcript.innerHTML = '';
            analysisCards.innerHTML = '';
            if (analysisEmpty) analysisEmpty.style.display = 'none';

            // Start Timer
            timerInterval = setInterval(updateTimer, 1000);

            // Show next analysis countdown
            updateNextAnalysisCountdown();
        }

        function stopSession() {
            isRecording = false;

            // Final analysis
            analyzeTranscript();

            // Cleanup
            clearInterval(timerInterval);
            clearInterval(analysisInterval);

            // UI Updates - Desktop
            startBtn.disabled = false;
            startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            stopBtn.disabled = true;
            stopBtn.classList.add('opacity-50', 'cursor-not-allowed');

            // UI Updates - Mobile
            startBtnMobile.disabled = false;
            startBtnMobile.classList.remove('opacity-50', 'cursor-not-allowed');
            stopBtnMobile.disabled = true;
            stopBtnMobile.classList.add('opacity-50', 'cursor-not-allowed');

            // Hide indicators
            liveIndicator.classList.add('hidden');
            fabAnalyze.classList.add('hidden');

            status.textContent = 'â¹ï¸ å·²çµæŸ';
            status.classList.remove('pulse-recording');
            nextAnalysis.textContent = '-';

            // Save to localStorage
            saveToHistory();
        }

        function switchSpeaker(speaker) {
            currentSpeaker = speaker;

            if (speaker === 'counselor') {
                speakerCounselorBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300', 'shadow-sm');
                speakerCounselorBtn.classList.add('bg-gradient-to-br', 'from-blue-500', 'to-indigo-600', 'text-white', 'shadow-md', 'hover:shadow-lg');
                speakerClientBtn.classList.remove('bg-gradient-to-br', 'from-blue-500', 'to-indigo-600', 'text-white', 'shadow-md', 'hover:shadow-lg');
                speakerClientBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300', 'shadow-sm');
            } else {
                speakerClientBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300', 'shadow-sm');
                speakerClientBtn.classList.add('bg-gradient-to-br', 'from-blue-500', 'to-indigo-600', 'text-white', 'shadow-md', 'hover:shadow-lg');
                speakerCounselorBtn.classList.remove('bg-gradient-to-br', 'from-blue-500', 'to-indigo-600', 'text-white', 'shadow-md', 'hover:shadow-lg');
                speakerCounselorBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300', 'shadow-sm');
            }
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            timer.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function updateNextAnalysisCountdown() {
            if (!isRecording) return;

            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const remaining = 60 - (elapsed % 60);
            nextAnalysis.textContent = `${remaining} ç§’`;

            setTimeout(() => updateNextAnalysisCountdown(), 1000);
        }

        // === Transcript Management ===
        function addTranscriptLine(speaker, text) {
            // Chat-style bubble
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex items-start gap-2 mb-3 fade-in ${speaker === 'client' ? 'flex-row-reverse' : ''}`;

            const avatarDiv = document.createElement('div');
            avatarDiv.className = `w-8 h-8 ${speaker === 'counselor' ? 'bg-blue-500' : 'bg-green-500'} rounded-full flex items-center justify-center flex-shrink-0 shadow-md`;
            avatarDiv.innerHTML = `<span class="text-white text-sm">${speaker === 'counselor' ? 'ğŸ‘¨â€âš•ï¸' : 'ğŸ§‘'}</span>`;

            const bubbleWrapper = document.createElement('div');
            bubbleWrapper.className = `flex-1 flex flex-col ${speaker === 'client' ? 'items-end' : 'items-start'}`;

            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${speaker === 'counselor' ? 'bg-blue-50 rounded-2xl rounded-tl-none' : 'bg-green-50 rounded-2xl rounded-tr-none'} px-4 py-2 shadow-sm`;
            bubble.innerHTML = `<p class="text-sm text-gray-800 leading-relaxed">${text}</p>`;

            const timestamp = document.createElement('span');
            timestamp.className = `text-xs text-gray-400 ${speaker === 'client' ? 'mr-2' : 'ml-2'} mt-1`;
            const now = new Date();
            timestamp.textContent = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });

            bubbleWrapper.appendChild(bubble);
            bubbleWrapper.appendChild(timestamp);

            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(bubbleWrapper);

            transcript.appendChild(messageDiv);
            transcript.scrollTop = transcript.scrollHeight;

            // Save to segments
            transcriptSegments.push({ speaker, text });
        }

        // === AI Analysis ===
        async function analyzeTranscript() {
            if (transcriptSegments.length === 0) return;

            // Build transcript text
            const transcriptText = transcriptSegments.map(s =>
                `${s.speaker === 'counselor' ? 'è«®å•†å¸«' : 'æ¡ˆä¸»'}ï¼š${s.text}`
            ).join('\n');

            // Calculate time range
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const timeRange = `${Math.max(0, minutes - 1)}:00-${minutes}:00`;

            // === ä½¿ç”¨å‡è³‡æ–™æ¨¡å¼ï¼ˆDemoï¼‰ ===
            const useMockData = true; // è¨­ç‚º false ä½¿ç”¨çœŸå¯¦ API

            if (useMockData) {
                // æ™ºæ…§ç”Ÿæˆå‡è³‡æ–™
                const mockAnalysis = generateMockAnalysis(transcriptText, timeRange);
                displayAnalysisCard(mockAnalysis);
                return;
            }

            // === çœŸå¯¦ API å‘¼å«ï¼ˆéœ€è¦èªè­‰ï¼‰ ===
            try {
                const response = await fetch('/api/v1/realtime/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        transcript: transcriptText,
                        speakers: transcriptSegments,
                        time_range: timeRange
                    })
                });

                if (!response.ok) throw new Error('åˆ†æå¤±æ•—');

                const analysis = await response.json();
                displayAnalysisCard(analysis);

            } catch (error) {
                console.error('Analysis error:', error);
                // Fallback to mock data
                const mockAnalysis = generateMockAnalysis(transcriptText, timeRange);
                displayAnalysisCard(mockAnalysis);
            }
        }

        // === Mock Data Generator ===
        function generateMockAnalysis(transcriptText, timeRange) {
            const lowerText = transcriptText.toLowerCase();

            // åµæ¸¬é—œéµè­°é¡Œ
            const hasSuicideRisk = /è‡ªæ®º|æƒ³æ­»|æ´»è‘—æ²’æ„ç¾©|ä¸æƒ³æ´»|çµæŸç”Ÿå‘½/.test(transcriptText);
            const hasAnxiety = /ç„¦æ…®|å£“åŠ›|ç·Šå¼µ|å®³æ€•|æ“”å¿ƒ/.test(transcriptText);
            const hasDepression = /æ†‚é¬±|æ²®å–ª|ç„¡åŠ›|ç–²ç´¯|å¤±çœ /.test(transcriptText);
            const hasWork = /å·¥ä½œ|ä¸»ç®¡|è€é—†|åŒäº‹|è·å ´/.test(transcriptText);
            const hasFamily = /å®¶äºº|çˆ¶æ¯|é…å¶|å°å­©|å®¶åº­/.test(transcriptText);
            const hasRelationship = /é—œä¿‚|æœ‹å‹|ä¼´ä¾¶|æ„Ÿæƒ…/.test(transcriptText);

            // ç”Ÿæˆæ‘˜è¦
            let summary = '';
            if (hasSuicideRisk) {
                summary = 'âš ï¸ æ¡ˆä¸»è¡¨é”è‡ªæ®ºæ„å¿µï¼Œè«®å•†å¸«æ­£åœ¨è©•ä¼°é¢¨éšªç¨‹åº¦ã€‚éœ€ç«‹å³é—œæ³¨æ¡ˆä¸»å®‰å…¨ã€‚';
            } else if (hasDepression && hasWork) {
                summary = 'æ¡ˆä¸»è¡¨é”å·¥ä½œç›¸é—œçš„æ†‚é¬±ç—‡ç‹€ï¼Œè«®å•†å¸«åŒç†æ¡ˆä¸»è™•å¢ƒï¼Œæ¢ç´¢å£“åŠ›ä¾†æºã€‚';
            } else if (hasAnxiety && hasFamily) {
                summary = 'æ¡ˆä¸»è«‡åŠå®¶åº­è­°é¡Œå¼•ç™¼çš„ç„¦æ…®æ„Ÿå—ï¼Œè«®å•†å¸«ä½¿ç”¨åæ˜ æŠ€å·§å»ºç«‹é—œä¿‚ã€‚';
            } else if (hasWork) {
                summary = 'æ¡ˆä¸»åˆ†äº«å·¥ä½œå›°æ“¾ï¼Œè«®å•†å¸«å¼•å°æ¡ˆä¸»æ¢ç´¢å…·é«”æƒ…å¢ƒèˆ‡æ„Ÿå—ã€‚';
            } else if (hasRelationship) {
                summary = 'æ¡ˆä¸»è«‡è«–äººéš›é—œä¿‚è­°é¡Œï¼Œè«®å•†å¸«å”åŠ©æ¡ˆä¸»è¦ºå¯Ÿäº’å‹•æ¨¡å¼ã€‚';
            } else {
                summary = 'è«®å•†å¸«èˆ‡æ¡ˆä¸»å»ºç«‹åˆæ­¥é—œä¿‚ï¼Œé–‹å§‹æ¢ç´¢æ¡ˆä¸»ç•¶å‰é—œæ³¨è­°é¡Œã€‚';
            }

            // ç”Ÿæˆè­¦ç¤º
            const alerts = [];
            if (hasSuicideRisk) {
                alerts.push('âš ï¸ é«˜é¢¨éšªï¼šæ¡ˆä¸»æåŠè‡ªæ®ºç›¸é—œå­—çœ¼ï¼Œéœ€ç«‹å³è©•ä¼°è‡ªæ®ºé¢¨éšªï¼ˆè¨ˆç•«ã€æ–¹æ³•ã€æ™‚é–“ï¼‰');
                alerts.push('âš ï¸ å®‰å…¨è©•ä¼°ï¼šè€ƒæ…®æ˜¯å¦éœ€è¦å±æ©Ÿè™•ç†ã€è¯çµ¡ç·Šæ€¥è¯çµ¡äººæˆ–è½‰ä»‹ç²¾ç¥ç§‘');
                alerts.push('âš ï¸ æŒçºŒè¿½è¹¤ï¼šæœ¬æ¬¡æœƒè«‡çµæŸå‰ç¢ºèªæ¡ˆä¸»å®‰å…¨ï¼Œå®‰æ’å¯†é›†è¿½è¹¤');
            } else if (hasDepression) {
                alerts.push('âš ï¸ æ³¨æ„æ¡ˆä¸»æƒ…ç·’ç‹€æ…‹ï¼Œè©•ä¼°æ†‚é¬±ç¨‹åº¦ï¼ˆæŒçºŒæ™‚é–“ã€åš´é‡åº¦ã€åŠŸèƒ½å½±éŸ¿ï¼‰');
                alerts.push('âš ï¸ å¦‚ç—‡ç‹€æŒçºŒå…©é€±ä»¥ä¸Šï¼Œå»ºè­°è©•ä¼°æ˜¯å¦éœ€è¦ç²¾ç¥ç§‘æœƒè¨º');
            } else if (hasAnxiety) {
                alerts.push('âš ï¸ æ¡ˆä¸»ç„¦æ…®ç¨‹åº¦è¼ƒé«˜ï¼Œæ³¨æ„ç”Ÿç†ç—‡ç‹€ï¼ˆå¿ƒè·³ã€å‘¼å¸ã€è‚Œè‚‰ç·Šç¹ƒï¼‰');
            }

            // ä¸€èˆ¬æé†’
            if (transcriptSegments.filter(s => s.speaker === 'counselor').length < transcriptSegments.length * 0.3) {
                alerts.push('ğŸ’¡ è«®å•†å¸«ç™¼è¨€æ¯”ä¾‹è¼ƒå°‘ï¼Œå¯é©åº¦å¼•å°å°è©±æ–¹å‘');
            }
            if (transcriptSegments.length > 10) {
                alerts.push('âœ… å°è©±æŒçºŒé€²è¡Œä¸­ï¼Œæ³¨æ„æ™‚é–“ç®¡ç†èˆ‡æœƒè«‡çµæ§‹');
            }

            // ç”Ÿæˆå»ºè­°
            const suggestions = [];
            if (hasSuicideRisk) {
                suggestions.push('ğŸ’¡ ç›´æ¥è©•ä¼°ï¼šã€Œç•¶ä½ èªªä¸æƒ³æ´»äº†ï¼Œæ˜¯å¦æ›¾æƒ³éè¦å¦‚ä½•çµæŸç”Ÿå‘½ï¼Ÿã€');
                suggestions.push('ğŸ’¡ è©•ä¼°ä¿è­·å› å­ï¼šã€Œæœ‰ä»€éº¼äº‹æƒ…æˆ–äººï¼Œè®“ä½ åˆ°ç¾åœ¨é‚„é¡˜æ„æ´»è‘—ï¼Ÿã€');
                suggestions.push('ğŸ’¡ å»ºç«‹å®‰å…¨è¨ˆç•«ï¼šèˆ‡æ¡ˆä¸»è¨è«–å±æ©Ÿæ™‚å¯ä»¥åšä»€éº¼ã€å¯ä»¥æ‰¾èª°');
            } else if (hasDepression && hasWork) {
                suggestions.push('ğŸ’¡ æ¢ç´¢å·¥ä½œå£“åŠ›æºï¼šã€Œå·¥ä½œä¸­å“ªäº›å…·é«”æƒ…æ³è®“ä½ æ„Ÿåˆ°ç‰¹åˆ¥æ²®å–ªï¼Ÿã€');
                suggestions.push('ğŸ’¡ è©•ä¼°åŠŸèƒ½å½±éŸ¿ï¼šã€Œé€™äº›æ„Ÿå—å¦‚ä½•å½±éŸ¿ä½ çš„æ—¥å¸¸ç”Ÿæ´»å’Œå·¥ä½œè¡¨ç¾ï¼Ÿã€');
                suggestions.push('ğŸ’¡ æ‰¾å‡ºå› æ‡‰è³‡æºï¼šã€Œéå»é‡åˆ°é¡ä¼¼å›°é›£æ™‚ï¼Œä½ æ˜¯æ€éº¼åº¦éçš„ï¼Ÿã€');
            } else if (hasAnxiety) {
                suggestions.push('ğŸ’¡ å¼•å°å…·é«”åŒ–ï¼šã€Œç•¶ç„¦æ…®å‡ºç¾æ™‚ï¼Œä½ çš„èº«é«”æœ‰ä»€éº¼æ„Ÿè¦ºï¼Ÿã€');
                suggestions.push('ğŸ’¡ æ•™å°æ”¾é¬†æŠ€å·§ï¼šè€ƒæ…®å¼•å…¥å‘¼å¸ç·´ç¿’æˆ–æ­£å¿µæŠ€å·§');
                suggestions.push('ğŸ’¡ æ¢ç´¢ç„¦æ…®è§¸ç™¼é»ï¼šã€Œä»€éº¼æƒ…æ³ä¸‹ç„¦æ…®æ„Ÿæœƒç‰¹åˆ¥å¼·çƒˆï¼Ÿã€');
            } else if (hasWork) {
                suggestions.push('ğŸ’¡ å…·é«”åŒ–æ¢ç´¢ï¼šã€Œå¯ä»¥èªªèªªæœ€è¿‘ä¸€æ¬¡å›°æ“¾çš„å…·é«”æƒ…æ³å—ï¼Ÿã€');
                suggestions.push('ğŸ’¡ æƒ…ç·’åæ˜ ï¼šã€Œè½èµ·ä¾†é€™è®“ä½ æ„Ÿåˆ°...ï¼ˆæŒ«æŠ˜/æ†¤æ€’/ç„¡åŠ›ï¼‰ã€');
                suggestions.push('ğŸ’¡ è©•ä¼°æ”¯æŒç³»çµ±ï¼šã€Œå·¥ä½œä¹‹å¤–ï¼Œä½ æœ‰å¯ä»¥è«‡å¿ƒçš„å°è±¡å—ï¼Ÿã€');
            } else {
                suggestions.push('ğŸ’¡ é–‹æ”¾å¼æå•ï¼šã€Œä»Šå¤©æœ€æƒ³è«‡çš„æ˜¯ä»€éº¼ï¼Ÿã€');
                suggestions.push('ğŸ’¡ å»ºç«‹é—œä¿‚ï¼šä½¿ç”¨åŒç†å¿ƒå›æ‡‰ï¼Œè®“æ¡ˆä¸»æ„Ÿåˆ°è¢«ç†è§£');
                suggestions.push('ğŸ’¡ æ¾„æ¸…ç›®æ¨™ï¼šã€Œä½ å¸Œæœ›é€éè«®å•†é”åˆ°ä»€éº¼ï¼Ÿã€');
            }

            return {
                summary: summary,
                alerts: alerts.slice(0, 3), // æœ€å¤š3å€‹è­¦ç¤º
                suggestions: suggestions.slice(0, 3), // æœ€å¤š3å€‹å»ºè­°
                time_range: timeRange,
                timestamp: new Date().toISOString()
            };
        }

        function displayAnalysisCard(analysis) {
            // Clear placeholder/empty state
            if (analysisEmpty) analysisEmpty.style.display = 'none';

            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-md hover:shadow-lg transition-shadow p-4 md:p-5 border-l-4 border-purple-500 fade-in card-hover';

            // Determine severity for alerts
            const hasCritical = analysis.alerts.some(a => a.includes('ğŸ”´') || a.includes('é«˜é¢¨éšª'));
            const hasWarning = analysis.alerts.some(a => a.includes('âš ï¸'));

            card.innerHTML = `
                <div class="flex items-start justify-between mb-3">
                    <span class="inline-block px-3 py-1 bg-purple-100 text-purple-700 text-xs font-semibold rounded-full">
                        ${analysis.time_range}
                    </span>
                    <span class="text-xs text-gray-400">${new Date(analysis.timestamp).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })}</span>
                </div>

                <!-- Summary Section -->
                <div class="mb-4">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-6 h-6 bg-blue-100 rounded flex items-center justify-center">
                            ğŸ“‹
                        </div>
                        <h3 class="font-bold text-sm md:text-base text-gray-800">æ‘˜è¦</h3>
                    </div>
                    <p class="text-sm text-gray-700 leading-relaxed pl-8">${analysis.summary}</p>
                </div>

                <!-- Alerts Section -->
                ${analysis.alerts.length > 0 ? `
                    <div class="mb-4">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-6 h-6 ${hasCritical ? 'bg-red-100' : 'bg-yellow-100'} rounded flex items-center justify-center">
                                ${hasCritical ? 'ğŸ”´' : 'âš ï¸'}
                            </div>
                            <h3 class="font-bold text-sm md:text-base text-gray-800">è­¦ç¤º</h3>
                        </div>
                        <div class="space-y-2 pl-8">
                            ${analysis.alerts.map(alert => {
                                const isCritical = alert.includes('ğŸ”´') || alert.includes('é«˜é¢¨éšª');
                                const isWarning = alert.includes('âš ï¸');
                                const bgColor = isCritical ? 'bg-red-50 border-red-200' : isWarning ? 'bg-yellow-50 border-yellow-200' : 'bg-blue-50 border-blue-200';
                                const textColor = isCritical ? 'text-red-700' : isWarning ? 'text-yellow-700' : 'text-blue-700';
                                const badgeClass = isCritical ? 'badge-critical' : isWarning ? 'badge-warning' : 'badge-info';
                                const severity = isCritical ? 'é«˜' : isWarning ? 'ä¸­' : 'ä½';

                                return `
                                    <div class="flex items-start gap-2 p-2 ${bgColor} rounded-lg border transition-smooth hover:shadow-sm">
                                        <span class="px-2 py-0.5 ${badgeClass} text-white text-xs rounded font-bold shadow-sm">${severity}</span>
                                        <p class="text-xs md:text-sm ${textColor} flex-1 leading-relaxed">${alert}</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- Suggestions Section -->
                ${analysis.suggestions.length > 0 ? `
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-6 h-6 bg-green-100 rounded flex items-center justify-center">
                                ğŸ’¡
                            </div>
                            <h3 class="font-bold text-sm md:text-base text-gray-800">å»ºè­°</h3>
                        </div>
                        <div class="space-y-2 pl-8">
                            ${analysis.suggestions.map(sug => `
                                <div class="p-2 bg-green-50 border border-green-200 rounded-lg hover:bg-green-100 transition-smooth cursor-pointer">
                                    <p class="text-xs md:text-sm text-green-700 leading-relaxed">${sug}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;

            // Animate card entrance
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            analysisCards.insertBefore(card, analysisCards.firstChild);

            setTimeout(() => {
                card.style.transition = 'all 0.3s ease-out';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, 10);

            // Save to history
            analysisHistory.push(analysis);
        }

        function showError(message) {
            const card = document.createElement('div');
            card.className = 'bg-red-50 rounded-lg p-4 border-l-4 border-red-500';
            card.innerHTML = `<p class="text-sm text-red-700">âŒ ${message}</p>`;
            analysisCards.insertBefore(card, analysisCards.firstChild);
        }

        // === Manual Analysis Triggers ===
        function manuallyTriggerAnalysis() {
            if (transcriptSegments.length === 0) {
                alert('è«‹å…ˆæŒ‰ T éµæ–°å¢å°è©±å…§å®¹');
                return;
            }
            analyzeTranscript();
        }

        function generateMultipleAnalyses() {
            // Clear existing cards and show loading
            analysisCards.innerHTML = '';
            if (analysisEmpty) analysisEmpty.style.display = 'none';

            // Show loading skeleton
            for (let i = 0; i < 3; i++) {
                const skeleton = document.createElement('div');
                skeleton.className = 'bg-white rounded-xl p-5 border border-gray-200 animate-pulse';
                skeleton.innerHTML = `
                    <div class="flex justify-between mb-3">
                        <div class="h-6 bg-gray-200 rounded-full w-20"></div>
                        <div class="h-4 bg-gray-200 rounded w-12"></div>
                    </div>
                    <div class="space-y-2">
                        <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                        <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                    </div>
                `;
                analysisCards.appendChild(skeleton);
            }

            // Clear skeletons after 1 second
            setTimeout(() => {
                analysisCards.innerHTML = '';
            }, 1000);

            // Generate 5 progressive analyses (simulating 5 minutes of conversation)
            const mockProgressiveData = [
                {
                    timeRange: '0:00-1:00',
                    transcript: 'è«®å•†å¸«ï¼šä½ å¥½ï¼Œä»Šå¤©æƒ³èŠä»€éº¼å‘¢ï¼Ÿ\næ¡ˆä¸»ï¼šæˆ‘æœ€è¿‘å·¥ä½œå£“åŠ›å¾ˆå¤§...',
                    hasIssue: { anxiety: true }
                },
                {
                    timeRange: '1:00-2:00',
                    transcript: 'è«®å•†å¸«ï¼šè½èµ·ä¾†å£“åŠ›çœŸçš„å¾ˆå¤§ï¼Œèƒ½è·Ÿæˆ‘å¤šèªªä¸€äº›å—ï¼Ÿ\næ¡ˆä¸»ï¼šæˆ‘è¦ºå¾—ä¸ç®¡æ€éº¼åšï¼Œä¸»ç®¡éƒ½ä¸æ»¿æ„ã€‚\nè«®å•†å¸«ï¼šé€™è®“ä½ æ„Ÿåˆ°å¾ˆæŒ«æŠ˜ï¼Œæ˜¯å—ï¼Ÿ',
                    hasIssue: { anxiety: true, work: true }
                },
                {
                    timeRange: '2:00-3:00',
                    transcript: 'æ¡ˆä¸»ï¼šå°ï¼Œè€Œä¸”æˆ‘é–‹å§‹æ‡·ç–‘è‡ªå·±çš„èƒ½åŠ›...\nè«®å•†å¸«ï¼šç•¶ä½ èªªã€Œæ‡·ç–‘è‡ªå·±ã€ï¼Œå…·é«”æ˜¯æŒ‡ä»€éº¼å‘¢ï¼Ÿ\næ¡ˆä¸»ï¼šæˆ‘è¦ºå¾—è‡ªå·±ä»€éº¼éƒ½åšä¸å¥½ã€‚',
                    hasIssue: { anxiety: true, work: true, depression: true }
                },
                {
                    timeRange: '3:00-4:00',
                    transcript: 'æ¡ˆä¸»ï¼šæœ‰æ™‚å€™è¦ºå¾—æ´»è‘—å¥½åƒæ²’ä»€éº¼æ„ç¾©ã€‚\nè«®å•†å¸«ï¼šä½ å‰›æ‰èªªã€Œæ´»è‘—æ²’æ„ç¾©ã€ï¼Œé€™æ˜¯æœ€è¿‘æ‰æœ‰çš„æƒ³æ³•å—ï¼Ÿ\næ¡ˆä¸»ï¼šå—¯...æœ€è¿‘ç‰¹åˆ¥å¼·çƒˆã€‚',
                    hasIssue: { anxiety: true, work: true, depression: true, suicideRisk: true }
                },
                {
                    timeRange: '4:00-5:00',
                    transcript: 'è«®å•†å¸«ï¼šç•¶ä½ èªªã€Œæ´»è‘—æ²’æ„ç¾©ã€ï¼Œæœ‰æƒ³éè¦çµæŸç”Ÿå‘½å—ï¼Ÿ\næ¡ˆä¸»ï¼šæœ‰æƒ³é...ä½†æˆ‘ä¸ç¢ºå®šæœƒä¸æœƒçœŸçš„å»åšã€‚\nè«®å•†å¸«ï¼šæœ‰ä»€éº¼äº‹æƒ…æˆ–äººï¼Œè®“ä½ åˆ°ç¾åœ¨é‚„é¡˜æ„æ´»è‘—ï¼Ÿ',
                    hasIssue: { suicideRisk: true, assessment: true }
                }
            ];

            // Generate analyses for each segment with staggered animation
            mockProgressiveData.forEach((data, index) => {
                const mockAnalysis = generateProgressiveAnalysis(data, index + 1);
                setTimeout(() => {
                    displayAnalysisCard(mockAnalysis);
                }, 1000 + (index * 400)); // Start after skeleton clears, stagger by 400ms
            });
        }

        function generateProgressiveAnalysis(data, minute) {
            const { timeRange, transcript, hasIssue } = data;

            let summary = '';
            const alerts = [];
            const suggestions = [];

            // Progressive summary
            if (hasIssue.suicideRisk && hasIssue.assessment) {
                summary = 'âš ï¸ è«®å•†å¸«æ­£é€²è¡Œè‡ªæ®ºé¢¨éšªè©•ä¼°ï¼Œæ¡ˆä¸»è¡¨é”æœ‰è‡ªæ®ºæ„å¿µä½†å°šæœªæœ‰å…·é«”è¨ˆç•«ã€‚æ­£åœ¨æ¢ç´¢ä¿è­·å› å­ã€‚';
                alerts.push('ğŸ”´ ç«‹å³è¡Œå‹•ï¼šæ¡ˆä¸»ç¢ºèªæœ‰è‡ªæ®ºæ„å¿µï¼Œéœ€å®Œæ•´è©•ä¼°è¨ˆç•«ã€æ–¹æ³•ã€æ™‚é–“');
                alerts.push('âš ï¸ å®‰å…¨è¨ˆç•«ï¼šå»ºç«‹å±æ©Ÿè™•ç†è¯çµ¡äººã€ç§»é™¤å±éšªç‰©å“');
                alerts.push('âš ï¸ å¾ŒçºŒè¿½è¹¤ï¼šå®‰æ’å¯†é›†æœƒè«‡ï¼ˆæ¯é€±2-3æ¬¡ï¼‰ï¼Œè€ƒæ…®ç²¾ç¥ç§‘æœƒè¨º');
                suggestions.push('ğŸ’¡ ç¹¼çºŒè©•ä¼°ï¼šã€Œä½ æ˜¯å¦æœ‰æƒ³éå…·é«”çš„æ–¹æ³•ï¼Ÿã€ã€Œä»€éº¼æ™‚å€™é€™å€‹æƒ³æ³•æœ€å¼·çƒˆï¼Ÿã€');
                suggestions.push('ğŸ’¡ å¼·åŒ–ä¿è­·å› å­ï¼šæ·±å…¥æ¢ç´¢æ”¯æŒç³»çµ±ã€ç”Ÿæ´»ç›®æ¨™ã€é‡è¦é—œä¿‚');
                suggestions.push('ğŸ’¡ å»ºç«‹å®‰å…¨å¥‘ç´„ï¼šèˆ‡æ¡ˆä¸»å…±åŒåˆ¶å®šå±æ©Ÿæ™‚çš„å› æ‡‰è¨ˆç•«');
            } else if (hasIssue.suicideRisk) {
                summary = 'âš ï¸ æ¡ˆä¸»é¦–æ¬¡æåŠã€Œæ´»è‘—æ²’æ„ç¾©ã€ï¼Œè«®å•†å¸«è­¦è¦ºä¸¦é–‹å§‹è©•ä¼°è‡ªæ®ºé¢¨éšªç¨‹åº¦ã€‚';
                alerts.push('ğŸ”´ é«˜é¢¨éšªè­¦ç¤ºï¼šæ¡ˆä¸»æåŠã€Œæ´»è‘—æ²’æ„ç¾©ã€ï¼Œéœ€ç«‹å³è©•ä¼°è‡ªæ®ºæ„å¿µ');
                alerts.push('âš ï¸ ä¸‹ä¸€æ­¥ï¼šç›´æ¥è©¢å•æ˜¯å¦æœ‰è‡ªæ®ºæƒ³æ³•æˆ–è¨ˆç•«');
                suggestions.push('ğŸ’¡ ç›´æ¥è©•ä¼°ï¼šã€Œç•¶ä½ èªªæ´»è‘—æ²’æ„ç¾©ï¼Œæ˜¯å¦æ›¾æƒ³éè¦çµæŸç”Ÿå‘½ï¼Ÿã€');
                suggestions.push('ğŸ’¡ æ¾„æ¸…åš´é‡åº¦ï¼šã€Œé€™å€‹æƒ³æ³•æœ‰å¤šå¼·çƒˆï¼Ÿå¤šå¸¸å‡ºç¾ï¼Ÿã€');
            } else if (hasIssue.depression) {
                summary = `æ¡ˆä¸»è¡¨é”æ†‚é¬±ç—‡ç‹€ï¼ˆè‡ªæˆ‘æ‡·ç–‘ã€ç„¡åƒ¹å€¼æ„Ÿï¼‰ï¼Œè«®å•†å¸«æ¢ç´¢å…·é«”æ„Ÿå—èˆ‡æƒ³æ³•ã€‚`;
                alerts.push('âš ï¸ æ³¨æ„æ†‚é¬±æŒ‡æ¨™ï¼šè‡ªæˆ‘å¦å®šã€ç„¡åƒ¹å€¼æ„Ÿï¼Œéœ€è©•ä¼°æŒçºŒæ™‚é–“èˆ‡åš´é‡åº¦');
                alerts.push('ğŸ’¡ å»ºè­°è©•ä¼°ï¼šè©¢å•ç¡çœ ã€é£Ÿæ…¾ã€èˆˆè¶£ã€ç²¾åŠ›ç­‰å…¶ä»–æ†‚é¬±ç—‡ç‹€');
                suggestions.push('ğŸ’¡ æ¢ç´¢èªçŸ¥æ¨¡å¼ï¼šã€Œä»€éº¼è®“ä½ è¦ºå¾—è‡ªå·±ä»€éº¼éƒ½åšä¸å¥½ï¼Ÿã€');
                suggestions.push('ğŸ’¡ å°‹æ‰¾ä¾‹å¤–ï¼šã€Œæœ‰æ²’æœ‰åšå¾—é‚„ä¸éŒ¯çš„æ™‚å€™ï¼Ÿã€');
            } else if (hasIssue.work) {
                summary = `æ¡ˆä¸»è«‡è«–å·¥ä½œå£“åŠ›èˆ‡æŒ«æŠ˜æ„Ÿï¼Œè«®å•†å¸«ä½¿ç”¨åæ˜ æŠ€å·§å»ºç«‹åŒç†é€£çµã€‚`;
                alerts.push('âœ… è«®å•†å¸«ä½¿ç”¨åæ˜ æŠ€å·§é©ç•¶ï¼ˆã€Œé€™è®“ä½ æ„Ÿåˆ°å¾ˆæŒ«æŠ˜ã€ï¼‰');
                alerts.push('ğŸ’¡ å¯æ·±å…¥æ¢ç´¢ï¼šä¸»ç®¡çš„å…·é«”è¡Œç‚ºã€æ¡ˆä¸»çš„å› æ‡‰æ–¹å¼');
                suggestions.push('ğŸ’¡ å…·é«”åŒ–ï¼šã€Œä¸»ç®¡å“ªäº›è¡Œç‚ºè®“ä½ è¦ºå¾—ä¸è¢«æ»¿æ„ï¼Ÿã€');
                suggestions.push('ğŸ’¡ è©•ä¼°å½±éŸ¿ï¼šã€Œé€™ç¨®ç‹€æ³æŒçºŒå¤šä¹…äº†ï¼Ÿå°ä½ çš„å½±éŸ¿æœ‰å¤šå¤§ï¼Ÿã€');
            } else {
                summary = `æœƒè«‡é–‹å§‹ï¼Œè«®å•†å¸«å¼•å°æ¡ˆä¸»è«‡è«–è¿‘æ³ï¼Œæ¡ˆä¸»æåŠå·¥ä½œå£“åŠ›è­°é¡Œã€‚`;
                alerts.push('âœ… è‰¯å¥½çš„é–‹æ”¾å¼æå•');
                alerts.push('ğŸ’¡ å»ºè­°æ–¹å‘ï¼šæŒçºŒæ¢ç´¢å£“åŠ›ä¾†æºèˆ‡å½±éŸ¿');
                suggestions.push('ğŸ’¡ æ·±å…¥äº†è§£ï¼šã€Œå£“åŠ›å¤§çš„æ™‚å€™ï¼Œä½ æœƒæœ‰ä»€éº¼æ„Ÿè¦ºæˆ–åæ‡‰ï¼Ÿã€');
                suggestions.push('ğŸ’¡ è©•ä¼°å› æ‡‰ï¼šã€Œä½ å¹³å¸¸æ€éº¼è™•ç†é€™äº›å£“åŠ›ï¼Ÿã€');
            }

            return {
                summary: summary,
                alerts: alerts.slice(0, 3),
                suggestions: suggestions.slice(0, 3),
                time_range: timeRange,
                timestamp: new Date(Date.now() + minute * 60000).toISOString()
            };
        }

        // === localStorage Management ===
        function saveToHistory() {
            const session = {
                timestamp: new Date().toISOString(),
                duration: timer.textContent,
                transcript: transcriptSegments,
                analyses: analysisHistory
            };

            const history = JSON.parse(localStorage.getItem('realtimeCounselingHistory') || '[]');
            history.unshift(session);

            // Keep last 10 sessions
            localStorage.setItem('realtimeCounselingHistory', JSON.stringify(history.slice(0, 10)));
        }

        function toggleHistory() {
            const section = document.getElementById('historySection');
            const toggle = document.getElementById('historyToggle');

            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                toggle.textContent = 'â–²';
                toggle.style.transform = 'rotate(180deg)';
                loadHistory();
            } else {
                section.classList.add('hidden');
                toggle.textContent = 'â–¼';
                toggle.style.transform = 'rotate(0deg)';
            }
        }

        function toggleTranscript() {
            const section = document.getElementById('transcriptSection');
            const toggle = document.getElementById('transcriptToggle');

            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                toggle.textContent = 'â–²';
                toggle.style.transform = 'rotate(180deg)';
            } else {
                section.classList.add('hidden');
                toggle.textContent = 'â–¼';
                toggle.style.transform = 'rotate(0deg)';
            }
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('realtimeCounselingHistory') || '[]');
            const list = document.getElementById('historyList');

            if (history.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-8">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <span class="text-3xl">ğŸ“‚</span>
                        </div>
                        <p class="text-gray-400 font-medium">å°šç„¡æ­·å²è¨˜éŒ„</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = history.map((session, index) => `
                <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-4 border border-gray-200 hover:shadow-md transition-smooth">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <span class="w-8 h-8 bg-indigo-500 text-white rounded-lg flex items-center justify-center text-sm font-bold">#${index + 1}</span>
                            <div>
                                <p class="font-bold text-gray-800 text-sm">${new Date(session.timestamp).toLocaleString('zh-TW', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                                <p class="text-xs text-gray-500">æœƒè«‡æ™‚é•·ï¼š${session.duration}</p>
                            </div>
                        </div>
                        <span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full font-bold">
                            ${session.analyses.length} æ¬¡åˆ†æ
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function clearHistory() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ­·å²è¨˜éŒ„å—ï¼Ÿ')) {
                localStorage.removeItem('realtimeCounselingHistory');
                loadHistory();
            }
        }

        // === Demo Mode (Simulate transcript input) ===
        let demoScriptIndex = 0;
        const demoScripts = {
            // åŠ‡æœ¬ 1: å·¥ä½œå£“åŠ›èˆ‡ç„¦æ…®
            workStress: [
                { speaker: 'counselor', text: 'ä½ å¥½ï¼Œä»Šå¤©æƒ³èŠä»€éº¼å‘¢ï¼Ÿ' },
                { speaker: 'client', text: 'æˆ‘æœ€è¿‘å·¥ä½œå£“åŠ›å¾ˆå¤§ï¼Œå¸¸å¸¸ç„¦æ…®åˆ°ç¡ä¸è‘—...' },
                { speaker: 'counselor', text: 'è½èµ·ä¾†å£“åŠ›çœŸçš„å¾ˆå¤§ï¼Œèƒ½è·Ÿæˆ‘å¤šèªªä¸€äº›å—ï¼Ÿ' },
                { speaker: 'client', text: 'æˆ‘è¦ºå¾—ä¸ç®¡æ€éº¼åšï¼Œä¸»ç®¡éƒ½ä¸æ»¿æ„ã€‚' },
                { speaker: 'counselor', text: 'é€™è®“ä½ æ„Ÿåˆ°å¾ˆæŒ«æŠ˜ï¼Œæ˜¯å—ï¼Ÿ' },
                { speaker: 'client', text: 'å°ï¼Œè€Œä¸”æˆ‘é–‹å§‹æ‡·ç–‘è‡ªå·±çš„èƒ½åŠ›...' },
                { speaker: 'counselor', text: 'ç•¶ä½ èªªã€Œæ‡·ç–‘è‡ªå·±ã€ï¼Œå…·é«”æ˜¯æŒ‡ä»€éº¼å‘¢ï¼Ÿ' },
                { speaker: 'client', text: 'æˆ‘è¦ºå¾—è‡ªå·±ä»€éº¼éƒ½åšä¸å¥½ï¼Œæ´»è‘—å¥½åƒæ²’ä»€éº¼æ„ç¾©ã€‚' },
                { speaker: 'counselor', text: 'ä½ å‰›æ‰èªªã€Œæ´»è‘—æ²’æ„ç¾©ã€ï¼Œé€™æ˜¯æœ€è¿‘æ‰æœ‰çš„æƒ³æ³•å—ï¼Ÿ' },
                { speaker: 'client', text: 'å—¯...æœ€è¿‘ç‰¹åˆ¥å¼·çƒˆã€‚' }
            ],

            // åŠ‡æœ¬ 2: ä¸€èˆ¬è«®è©¢
            general: [
                { speaker: 'counselor', text: 'ä»Šå¤©éå¾—å¦‚ä½•ï¼Ÿ' },
                { speaker: 'client', text: 'é‚„å¥½ï¼Œå°±æ˜¯æœ‰é»ç´¯ã€‚' },
                { speaker: 'counselor', text: 'ä»€éº¼è®“ä½ æ„Ÿåˆ°ç´¯å‘¢ï¼Ÿ' },
                { speaker: 'client', text: 'å·¥ä½œçš„äº‹æƒ…ï¼Œé‚„æœ‰å®¶è£¡çš„äº‹ã€‚' },
                { speaker: 'counselor', text: 'èƒ½å…·é«”èªªèªªæ˜¯ä»€éº¼äº‹å—ï¼Ÿ' },
                { speaker: 'client', text: 'ä¸»ç®¡æœ€è¿‘ä¸€ç›´ç›¯æˆ‘ï¼Œè®“æˆ‘å£“åŠ›å¾ˆå¤§ã€‚' },
                { speaker: 'counselor', text: 'ä¸»ç®¡ç›¯è‘—ä½ çš„æ„Ÿè¦ºï¼Œèƒ½æè¿°ä¸€ä¸‹å—ï¼Ÿ' },
                { speaker: 'client', text: 'å°±æ˜¯è¦ºå¾—è¢«ç›£è¦–ï¼Œä»€éº¼éƒ½è¦å ±å‘Šã€‚' }
            ]
        };

        let currentScript = demoScripts.workStress; // é è¨­ä½¿ç”¨å·¥ä½œå£“åŠ›åŠ‡æœ¬

        function simulateTranscriptInput() {
            if (!isRecording) return;

            // å¾ªåºæ’­æ”¾åŠ‡æœ¬
            if (demoScriptIndex < currentScript.length) {
                const line = currentScript[demoScriptIndex];

                // è‡ªå‹•åˆ‡æ›èªªè©±è€…
                if (line.speaker !== currentSpeaker) {
                    switchSpeaker(line.speaker);
                }

                addTranscriptLine(line.speaker, line.text);
                demoScriptIndex++;
            } else {
                // åŠ‡æœ¬æ’­å®Œï¼Œé‡ç½®æˆ–æç¤º
                console.log('Demo åŠ‡æœ¬å·²æ’­æ”¾å®Œç•¢ï¼ŒæŒ‰ R éµé‡æ–°é–‹å§‹');
            }
        }

        // Demo: Press 'T' to add next transcript line
        // Press 'R' to reset script
        // Press '1' for work stress script, '2' for general script
        document.addEventListener('keydown', (e) => {
            if (e.key === 't' || e.key === 'T') {
                simulateTranscriptInput();
            } else if (e.key === 'r' || e.key === 'R') {
                demoScriptIndex = 0;
                console.log('Demo åŠ‡æœ¬å·²é‡ç½®');
            } else if (e.key === '1') {
                currentScript = demoScripts.workStress;
                demoScriptIndex = 0;
                console.log('åˆ‡æ›åˆ°åŠ‡æœ¬ 1: å·¥ä½œå£“åŠ›èˆ‡ç„¦æ…®');
            } else if (e.key === '2') {
                currentScript = demoScripts.general;
                demoScriptIndex = 0;
                console.log('åˆ‡æ›åˆ°åŠ‡æœ¬ 2: ä¸€èˆ¬è«®è©¢');
            }
        });

        // === Initialize ===
        // Hide speaker toggle in demo mode (scripted conversations auto-switch speaker)
        if (isDemoMode && speakerToggleSection) {
            speakerToggleSection.style.display = 'none';
        }

        // Hide history section in demo mode
        const historyContainer = document.getElementById('historyContainer');
        if (isDemoMode && historyContainer) {
            historyContainer.style.display = 'none';
        }

        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log('ğŸ¤ å³æ™‚è«®å•†è¼”åŠ©ç³»çµ± - Demo æ¨¡å¼');
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log('');
        console.log('ğŸ“Œ å¿«æ·éµèªªæ˜ï¼š');
        console.log('  T - æ’­æ”¾ä¸‹ä¸€å¥å°è©±');
        console.log('  R - é‡ç½®åŠ‡æœ¬');
        console.log('  1 - å·¥ä½œå£“åŠ›åŠ‡æœ¬ï¼ˆå«è‡ªæ®ºé¢¨éšªï¼‰');
        console.log('  2 - ä¸€èˆ¬è«®è©¢åŠ‡æœ¬');
        console.log('');
        console.log('ğŸ¤– AI åˆ†æï¼šæ¯ 60 ç§’è‡ªå‹•è§¸ç™¼');
        console.log('ğŸ’¾ æ­·å²è¨˜éŒ„ï¼šè‡ªå‹•å„²å­˜åˆ° localStorage');
        console.log('');
        console.log('âœ¨ ç•¶å‰åŠ‡æœ¬ï¼šå·¥ä½œå£“åŠ›èˆ‡ç„¦æ…®ï¼ˆåŠ‡æœ¬ 1ï¼‰');
        console.log('ğŸ’¡ Demo æ¨¡å¼ï¼šèªªè©±è€…è‡ªå‹•åˆ‡æ›ï¼Œç„¡éœ€æ‰‹å‹•é¸æ“‡');
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    </script>
</body>
</html>
