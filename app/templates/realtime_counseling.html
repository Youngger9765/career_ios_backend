<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å³æ™‚è«®å•†è¼”åŠ©ç³»çµ± - Realtime Counseling</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <nav class="bg-indigo-600 text-white p-4">
        <div class="container mx-auto max-w-7xl flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold">ğŸ¤ å³æ™‚è«®å•†è¼”åŠ©ç³»çµ±</h1>
                <p class="text-sm opacity-90">AI-Powered Realtime Counseling Assistant</p>
            </div>
            <a href="/console" class="bg-white text-indigo-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition">
                â† è¿”å›æ§åˆ¶å°
            </a>
        </div>
    </nav>

    <div class="container mx-auto p-6 max-w-7xl">
        <!-- Demo Mode Instructions -->
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-lg">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-bold text-yellow-800">ğŸ­ Demo æ¨¡å¼èªªæ˜ï¼ˆç„¡éœ€ API Keyï¼‰</h3>
                    <div class="mt-2 text-sm text-yellow-700">
                        <p class="mb-2">æ­¤ç‚ºå±•ç¤ºæ¨¡å¼ï¼Œä½¿ç”¨æ™ºæ…§å‡è³‡æ–™æ¨¡æ“¬å®Œæ•´åŠŸèƒ½ï¼š</p>
                        <ul class="list-disc list-inside space-y-1 ml-2">
                            <li><kbd class="px-2 py-1 bg-white rounded border">T</kbd> - æ’­æ”¾ä¸‹ä¸€å¥å°è©±ï¼ˆè‡ªå‹•åˆ‡æ›èªªè©±è€…ï¼‰</li>
                            <li><kbd class="px-2 py-1 bg-white rounded border">R</kbd> - é‡ç½®åŠ‡æœ¬å¾é ­é–‹å§‹</li>
                            <li><kbd class="px-2 py-1 bg-white rounded border">1</kbd> - åˆ‡æ›åˆ°ã€Œå·¥ä½œå£“åŠ›ã€åŠ‡æœ¬ï¼ˆå«è‡ªæ®ºé¢¨éšªåµæ¸¬ï¼‰</li>
                            <li><kbd class="px-2 py-1 bg-white rounded border">2</kbd> - åˆ‡æ›åˆ°ã€Œä¸€èˆ¬è«®è©¢ã€åŠ‡æœ¬</li>
                        </ul>
                        <p class="mt-2 font-bold">ğŸ’¡ AI åˆ†ææ¯ 60 ç§’è‡ªå‹•è§¸ç™¼ï¼Œæ ¹æ“šé€å­—ç¨¿å…§å®¹æ™ºæ…§ç”Ÿæˆæ‘˜è¦ã€è­¦ç¤ºã€å»ºè­°ã€‚</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- Left Panel: Recording & Transcript -->
            <div class="space-y-4">
                <!-- Recording Controls -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold mb-4">ğŸ™ï¸ éŒ„éŸ³æ§åˆ¶</h2>

                    <!-- Timer Display -->
                    <div class="text-center mb-4">
                        <div class="text-4xl font-mono" id="timer">00:00</div>
                        <div class="text-sm text-gray-500">æœƒè«‡æ™‚é–“</div>
                    </div>

                    <!-- Start/Stop Buttons -->
                    <div class="flex gap-4">
                        <button id="startBtn" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 px-6 rounded-lg font-bold transition">
                            â–¶ï¸ é–‹å§‹æœƒè«‡
                        </button>
                        <button id="stopBtn" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 px-6 rounded-lg font-bold opacity-50 cursor-not-allowed" disabled>
                            â¹ï¸ çµæŸæœƒè«‡
                        </button>
                    </div>

                    <!-- Speaker Toggle (Manual) -->
                    <div class="mt-6">
                        <label class="block text-sm font-medium mb-2">ç•¶å‰èªªè©±è€…</label>
                        <div class="flex gap-2">
                            <button id="speakerCounselor" class="flex-1 py-3 px-4 rounded-lg font-bold bg-blue-500 text-white transition">
                                ğŸ‘¨â€âš•ï¸ è«®å•†å¸«
                            </button>
                            <button id="speakerClient" class="flex-1 py-3 px-4 rounded-lg font-bold bg-gray-300 text-gray-700 transition">
                                ğŸ§‘ æ¡ˆä¸»
                            </button>
                        </div>
                    </div>

                    <!-- Status Indicator -->
                    <div class="mt-4 p-3 bg-gray-100 rounded-lg">
                        <div class="flex items-center justify-between text-sm">
                            <span class="font-medium">ç‹€æ…‹ï¼š</span>
                            <span id="status" class="text-gray-600">å¾…æ©Ÿä¸­</span>
                        </div>
                        <div class="flex items-center justify-between text-sm mt-2">
                            <span class="font-medium">ä¸‹æ¬¡åˆ†æï¼š</span>
                            <span id="nextAnalysis" class="text-gray-600">æœªé–‹å§‹</span>
                        </div>
                    </div>

                    <!-- Demo Mode Hint -->
                    <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-sm text-blue-700">
                            ğŸ’¡ <strong>æ¸¬è©¦æ¨¡å¼</strong>ï¼šæŒ‰ <kbd class="bg-blue-200 px-2 py-1 rounded">T</kbd> éµå¯æ¨¡æ“¬è¼¸å…¥å°è©±æ–‡å­—
                        </p>
                    </div>
                </div>

                <!-- Live Transcript -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold mb-4">ğŸ“ å³æ™‚é€å­—ç¨¿</h2>
                    <div id="transcript" class="h-96 overflow-y-auto bg-gray-50 rounded-lg p-4 font-mono text-sm space-y-2">
                        <p class="text-gray-400 italic">ç­‰å¾…æœƒè«‡é–‹å§‹...</p>
                    </div>
                </div>
            </div>

            <!-- Right Panel: AI Analysis Cards -->
            <div class="space-y-4">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold mb-4">ğŸ¤– AI å³æ™‚åˆ†æ</h2>

                    <!-- Analysis Cards Container -->
                    <div id="analysisCards" class="space-y-4 max-h-[800px] overflow-y-auto">
                        <p class="text-gray-400 italic">åˆ†æå°‡æ¯ 60 ç§’è‡ªå‹•ç”¢ç”Ÿ...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Section (Collapsed by default) -->
        <div class="mt-6 bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold mb-4 cursor-pointer flex justify-between items-center" onclick="toggleHistory()">
                <span>ğŸ“Š æ­·å²è¨˜éŒ„</span>
                <span id="historyToggle">â–¼</span>
            </h2>
            <div id="historySection" class="hidden">
                <button onclick="clearHistory()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded mb-4 transition">
                    ğŸ—‘ï¸ æ¸…é™¤æ­·å²
                </button>
                <div id="historyList" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <script>
        // === State Management ===
        let isRecording = false;
        let currentSpeaker = 'counselor';
        let startTime = null;
        let timerInterval = null;
        let analysisInterval = null;
        let transcriptSegments = [];
        let analysisHistory = [];

        // === DOM Elements ===
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const timer = document.getElementById('timer');
        const status = document.getElementById('status');
        const nextAnalysis = document.getElementById('nextAnalysis');
        const transcript = document.getElementById('transcript');
        const analysisCards = document.getElementById('analysisCards');
        const speakerCounselorBtn = document.getElementById('speakerCounselor');
        const speakerClientBtn = document.getElementById('speakerClient');

        // === Event Listeners ===
        startBtn.addEventListener('click', startSession);
        stopBtn.addEventListener('click', stopSession);
        speakerCounselorBtn.addEventListener('click', () => switchSpeaker('counselor'));
        speakerClientBtn.addEventListener('click', () => switchSpeaker('client'));

        // === Core Functions ===
        function startSession() {
            isRecording = true;
            startTime = Date.now();
            transcriptSegments = [];
            analysisHistory = [];

            // UI Updates
            startBtn.disabled = true;
            startBtn.classList.add('opacity-50', 'cursor-not-allowed');
            stopBtn.disabled = false;
            stopBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            status.textContent = 'ğŸ”´ éŒ„éŸ³ä¸­';
            transcript.innerHTML = '';
            analysisCards.innerHTML = '<p class="text-gray-400 italic">ç­‰å¾…ç¬¬ä¸€æ¬¡åˆ†æï¼ˆ60ç§’å¾Œï¼‰...</p>';

            // Start Timer
            timerInterval = setInterval(updateTimer, 1000);

            // Start Analysis Interval (every 60 seconds)
            analysisInterval = setInterval(analyzeTranscript, 60000);

            // Show next analysis countdown
            updateNextAnalysisCountdown();
        }

        function stopSession() {
            isRecording = false;

            // Final analysis
            analyzeTranscript();

            // Cleanup
            clearInterval(timerInterval);
            clearInterval(analysisInterval);

            // UI Updates
            startBtn.disabled = false;
            startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            stopBtn.disabled = true;
            stopBtn.classList.add('opacity-50', 'cursor-not-allowed');
            status.textContent = 'â¹ï¸ å·²çµæŸ';
            nextAnalysis.textContent = '-';

            // Save to localStorage
            saveToHistory();
        }

        function switchSpeaker(speaker) {
            currentSpeaker = speaker;

            if (speaker === 'counselor') {
                speakerCounselorBtn.classList.remove('bg-gray-300', 'text-gray-700');
                speakerCounselorBtn.classList.add('bg-blue-500', 'text-white');
                speakerClientBtn.classList.remove('bg-blue-500', 'text-white');
                speakerClientBtn.classList.add('bg-gray-300', 'text-gray-700');
            } else {
                speakerClientBtn.classList.remove('bg-gray-300', 'text-gray-700');
                speakerClientBtn.classList.add('bg-blue-500', 'text-white');
                speakerCounselorBtn.classList.remove('bg-blue-500', 'text-white');
                speakerCounselorBtn.classList.add('bg-gray-300', 'text-gray-700');
            }
        }

        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            timer.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function updateNextAnalysisCountdown() {
            if (!isRecording) return;

            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const remaining = 60 - (elapsed % 60);
            nextAnalysis.textContent = `${remaining} ç§’`;

            setTimeout(() => updateNextAnalysisCountdown(), 1000);
        }

        // === Transcript Management ===
        function addTranscriptLine(speaker, text) {
            const line = document.createElement('div');
            line.className = speaker === 'counselor' ? 'text-blue-700' : 'text-green-700';
            line.innerHTML = `<strong>${speaker === 'counselor' ? 'ğŸ‘¨â€âš•ï¸ è«®å•†å¸«' : 'ğŸ§‘ æ¡ˆä¸»'}ï¼š</strong>${text}`;
            transcript.appendChild(line);
            transcript.scrollTop = transcript.scrollHeight;

            // Save to segments
            transcriptSegments.push({ speaker, text });
        }

        // === AI Analysis ===
        async function analyzeTranscript() {
            if (transcriptSegments.length === 0) return;

            // Build transcript text
            const transcriptText = transcriptSegments.map(s =>
                `${s.speaker === 'counselor' ? 'è«®å•†å¸«' : 'æ¡ˆä¸»'}ï¼š${s.text}`
            ).join('\n');

            // Calculate time range
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const timeRange = `${Math.max(0, minutes - 1)}:00-${minutes}:00`;

            // === ä½¿ç”¨å‡è³‡æ–™æ¨¡å¼ï¼ˆDemoï¼‰ ===
            const useMockData = true; // è¨­ç‚º false ä½¿ç”¨çœŸå¯¦ API

            if (useMockData) {
                // æ™ºæ…§ç”Ÿæˆå‡è³‡æ–™
                const mockAnalysis = generateMockAnalysis(transcriptText, timeRange);
                displayAnalysisCard(mockAnalysis);
                return;
            }

            // === çœŸå¯¦ API å‘¼å«ï¼ˆéœ€è¦èªè­‰ï¼‰ ===
            try {
                const response = await fetch('/api/v1/realtime/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        transcript: transcriptText,
                        speakers: transcriptSegments,
                        time_range: timeRange
                    })
                });

                if (!response.ok) throw new Error('åˆ†æå¤±æ•—');

                const analysis = await response.json();
                displayAnalysisCard(analysis);

            } catch (error) {
                console.error('Analysis error:', error);
                // Fallback to mock data
                const mockAnalysis = generateMockAnalysis(transcriptText, timeRange);
                displayAnalysisCard(mockAnalysis);
            }
        }

        // === Mock Data Generator ===
        function generateMockAnalysis(transcriptText, timeRange) {
            const lowerText = transcriptText.toLowerCase();

            // åµæ¸¬é—œéµè­°é¡Œ
            const hasSuicideRisk = /è‡ªæ®º|æƒ³æ­»|æ´»è‘—æ²’æ„ç¾©|ä¸æƒ³æ´»|çµæŸç”Ÿå‘½/.test(transcriptText);
            const hasAnxiety = /ç„¦æ…®|å£“åŠ›|ç·Šå¼µ|å®³æ€•|æ“”å¿ƒ/.test(transcriptText);
            const hasDepression = /æ†‚é¬±|æ²®å–ª|ç„¡åŠ›|ç–²ç´¯|å¤±çœ /.test(transcriptText);
            const hasWork = /å·¥ä½œ|ä¸»ç®¡|è€é—†|åŒäº‹|è·å ´/.test(transcriptText);
            const hasFamily = /å®¶äºº|çˆ¶æ¯|é…å¶|å°å­©|å®¶åº­/.test(transcriptText);
            const hasRelationship = /é—œä¿‚|æœ‹å‹|ä¼´ä¾¶|æ„Ÿæƒ…/.test(transcriptText);

            // ç”Ÿæˆæ‘˜è¦
            let summary = '';
            if (hasSuicideRisk) {
                summary = 'âš ï¸ æ¡ˆä¸»è¡¨é”è‡ªæ®ºæ„å¿µï¼Œè«®å•†å¸«æ­£åœ¨è©•ä¼°é¢¨éšªç¨‹åº¦ã€‚éœ€ç«‹å³é—œæ³¨æ¡ˆä¸»å®‰å…¨ã€‚';
            } else if (hasDepression && hasWork) {
                summary = 'æ¡ˆä¸»è¡¨é”å·¥ä½œç›¸é—œçš„æ†‚é¬±ç—‡ç‹€ï¼Œè«®å•†å¸«åŒç†æ¡ˆä¸»è™•å¢ƒï¼Œæ¢ç´¢å£“åŠ›ä¾†æºã€‚';
            } else if (hasAnxiety && hasFamily) {
                summary = 'æ¡ˆä¸»è«‡åŠå®¶åº­è­°é¡Œå¼•ç™¼çš„ç„¦æ…®æ„Ÿå—ï¼Œè«®å•†å¸«ä½¿ç”¨åæ˜ æŠ€å·§å»ºç«‹é—œä¿‚ã€‚';
            } else if (hasWork) {
                summary = 'æ¡ˆä¸»åˆ†äº«å·¥ä½œå›°æ“¾ï¼Œè«®å•†å¸«å¼•å°æ¡ˆä¸»æ¢ç´¢å…·é«”æƒ…å¢ƒèˆ‡æ„Ÿå—ã€‚';
            } else if (hasRelationship) {
                summary = 'æ¡ˆä¸»è«‡è«–äººéš›é—œä¿‚è­°é¡Œï¼Œè«®å•†å¸«å”åŠ©æ¡ˆä¸»è¦ºå¯Ÿäº’å‹•æ¨¡å¼ã€‚';
            } else {
                summary = 'è«®å•†å¸«èˆ‡æ¡ˆä¸»å»ºç«‹åˆæ­¥é—œä¿‚ï¼Œé–‹å§‹æ¢ç´¢æ¡ˆä¸»ç•¶å‰é—œæ³¨è­°é¡Œã€‚';
            }

            // ç”Ÿæˆè­¦ç¤º
            const alerts = [];
            if (hasSuicideRisk) {
                alerts.push('âš ï¸ é«˜é¢¨éšªï¼šæ¡ˆä¸»æåŠè‡ªæ®ºç›¸é—œå­—çœ¼ï¼Œéœ€ç«‹å³è©•ä¼°è‡ªæ®ºé¢¨éšªï¼ˆè¨ˆç•«ã€æ–¹æ³•ã€æ™‚é–“ï¼‰');
                alerts.push('âš ï¸ å®‰å…¨è©•ä¼°ï¼šè€ƒæ…®æ˜¯å¦éœ€è¦å±æ©Ÿè™•ç†ã€è¯çµ¡ç·Šæ€¥è¯çµ¡äººæˆ–è½‰ä»‹ç²¾ç¥ç§‘');
                alerts.push('âš ï¸ æŒçºŒè¿½è¹¤ï¼šæœ¬æ¬¡æœƒè«‡çµæŸå‰ç¢ºèªæ¡ˆä¸»å®‰å…¨ï¼Œå®‰æ’å¯†é›†è¿½è¹¤');
            } else if (hasDepression) {
                alerts.push('âš ï¸ æ³¨æ„æ¡ˆä¸»æƒ…ç·’ç‹€æ…‹ï¼Œè©•ä¼°æ†‚é¬±ç¨‹åº¦ï¼ˆæŒçºŒæ™‚é–“ã€åš´é‡åº¦ã€åŠŸèƒ½å½±éŸ¿ï¼‰');
                alerts.push('âš ï¸ å¦‚ç—‡ç‹€æŒçºŒå…©é€±ä»¥ä¸Šï¼Œå»ºè­°è©•ä¼°æ˜¯å¦éœ€è¦ç²¾ç¥ç§‘æœƒè¨º');
            } else if (hasAnxiety) {
                alerts.push('âš ï¸ æ¡ˆä¸»ç„¦æ…®ç¨‹åº¦è¼ƒé«˜ï¼Œæ³¨æ„ç”Ÿç†ç—‡ç‹€ï¼ˆå¿ƒè·³ã€å‘¼å¸ã€è‚Œè‚‰ç·Šç¹ƒï¼‰');
            }

            // ä¸€èˆ¬æé†’
            if (transcriptSegments.filter(s => s.speaker === 'counselor').length < transcriptSegments.length * 0.3) {
                alerts.push('ğŸ’¡ è«®å•†å¸«ç™¼è¨€æ¯”ä¾‹è¼ƒå°‘ï¼Œå¯é©åº¦å¼•å°å°è©±æ–¹å‘');
            }
            if (transcriptSegments.length > 10) {
                alerts.push('âœ… å°è©±æŒçºŒé€²è¡Œä¸­ï¼Œæ³¨æ„æ™‚é–“ç®¡ç†èˆ‡æœƒè«‡çµæ§‹');
            }

            // ç”Ÿæˆå»ºè­°
            const suggestions = [];
            if (hasSuicideRisk) {
                suggestions.push('ğŸ’¡ ç›´æ¥è©•ä¼°ï¼šã€Œç•¶ä½ èªªä¸æƒ³æ´»äº†ï¼Œæ˜¯å¦æ›¾æƒ³éè¦å¦‚ä½•çµæŸç”Ÿå‘½ï¼Ÿã€');
                suggestions.push('ğŸ’¡ è©•ä¼°ä¿è­·å› å­ï¼šã€Œæœ‰ä»€éº¼äº‹æƒ…æˆ–äººï¼Œè®“ä½ åˆ°ç¾åœ¨é‚„é¡˜æ„æ´»è‘—ï¼Ÿã€');
                suggestions.push('ğŸ’¡ å»ºç«‹å®‰å…¨è¨ˆç•«ï¼šèˆ‡æ¡ˆä¸»è¨è«–å±æ©Ÿæ™‚å¯ä»¥åšä»€éº¼ã€å¯ä»¥æ‰¾èª°');
            } else if (hasDepression && hasWork) {
                suggestions.push('ğŸ’¡ æ¢ç´¢å·¥ä½œå£“åŠ›æºï¼šã€Œå·¥ä½œä¸­å“ªäº›å…·é«”æƒ…æ³è®“ä½ æ„Ÿåˆ°ç‰¹åˆ¥æ²®å–ªï¼Ÿã€');
                suggestions.push('ğŸ’¡ è©•ä¼°åŠŸèƒ½å½±éŸ¿ï¼šã€Œé€™äº›æ„Ÿå—å¦‚ä½•å½±éŸ¿ä½ çš„æ—¥å¸¸ç”Ÿæ´»å’Œå·¥ä½œè¡¨ç¾ï¼Ÿã€');
                suggestions.push('ğŸ’¡ æ‰¾å‡ºå› æ‡‰è³‡æºï¼šã€Œéå»é‡åˆ°é¡ä¼¼å›°é›£æ™‚ï¼Œä½ æ˜¯æ€éº¼åº¦éçš„ï¼Ÿã€');
            } else if (hasAnxiety) {
                suggestions.push('ğŸ’¡ å¼•å°å…·é«”åŒ–ï¼šã€Œç•¶ç„¦æ…®å‡ºç¾æ™‚ï¼Œä½ çš„èº«é«”æœ‰ä»€éº¼æ„Ÿè¦ºï¼Ÿã€');
                suggestions.push('ğŸ’¡ æ•™å°æ”¾é¬†æŠ€å·§ï¼šè€ƒæ…®å¼•å…¥å‘¼å¸ç·´ç¿’æˆ–æ­£å¿µæŠ€å·§');
                suggestions.push('ğŸ’¡ æ¢ç´¢ç„¦æ…®è§¸ç™¼é»ï¼šã€Œä»€éº¼æƒ…æ³ä¸‹ç„¦æ…®æ„Ÿæœƒç‰¹åˆ¥å¼·çƒˆï¼Ÿã€');
            } else if (hasWork) {
                suggestions.push('ğŸ’¡ å…·é«”åŒ–æ¢ç´¢ï¼šã€Œå¯ä»¥èªªèªªæœ€è¿‘ä¸€æ¬¡å›°æ“¾çš„å…·é«”æƒ…æ³å—ï¼Ÿã€');
                suggestions.push('ğŸ’¡ æƒ…ç·’åæ˜ ï¼šã€Œè½èµ·ä¾†é€™è®“ä½ æ„Ÿåˆ°...ï¼ˆæŒ«æŠ˜/æ†¤æ€’/ç„¡åŠ›ï¼‰ã€');
                suggestions.push('ğŸ’¡ è©•ä¼°æ”¯æŒç³»çµ±ï¼šã€Œå·¥ä½œä¹‹å¤–ï¼Œä½ æœ‰å¯ä»¥è«‡å¿ƒçš„å°è±¡å—ï¼Ÿã€');
            } else {
                suggestions.push('ğŸ’¡ é–‹æ”¾å¼æå•ï¼šã€Œä»Šå¤©æœ€æƒ³è«‡çš„æ˜¯ä»€éº¼ï¼Ÿã€');
                suggestions.push('ğŸ’¡ å»ºç«‹é—œä¿‚ï¼šä½¿ç”¨åŒç†å¿ƒå›æ‡‰ï¼Œè®“æ¡ˆä¸»æ„Ÿåˆ°è¢«ç†è§£');
                suggestions.push('ğŸ’¡ æ¾„æ¸…ç›®æ¨™ï¼šã€Œä½ å¸Œæœ›é€éè«®å•†é”åˆ°ä»€éº¼ï¼Ÿã€');
            }

            return {
                summary: summary,
                alerts: alerts.slice(0, 3), // æœ€å¤š3å€‹è­¦ç¤º
                suggestions: suggestions.slice(0, 3), // æœ€å¤š3å€‹å»ºè­°
                time_range: timeRange,
                timestamp: new Date().toISOString()
            };
        }

        function displayAnalysisCard(analysis) {
            // Clear placeholder
            if (analysisCards.querySelector('.text-gray-400')) {
                analysisCards.innerHTML = '';
            }

            const card = document.createElement('div');
            card.className = 'bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-4 border-l-4 border-purple-500';
            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <span class="text-xs text-gray-500">${analysis.time_range}</span>
                    <span class="text-xs text-gray-500">${new Date(analysis.timestamp).toLocaleTimeString('zh-TW')}</span>
                </div>

                <div class="mb-3">
                    <h3 class="font-bold text-sm text-gray-700 mb-1">ğŸ“‹ æ‘˜è¦</h3>
                    <p class="text-sm">${analysis.summary}</p>
                </div>

                ${analysis.alerts.length > 0 ? `
                    <div class="mb-3">
                        <h3 class="font-bold text-sm text-gray-700 mb-1">âš ï¸ è­¦ç¤º</h3>
                        <ul class="text-sm space-y-1">
                            ${analysis.alerts.map(alert => `<li class="text-red-600">â€¢ ${alert}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}

                ${analysis.suggestions.length > 0 ? `
                    <div>
                        <h3 class="font-bold text-sm text-gray-700 mb-1">ğŸ’¡ å»ºè­°</h3>
                        <ul class="text-sm space-y-1">
                            ${analysis.suggestions.map(sug => `<li class="text-green-600">â€¢ ${sug}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            `;

            // Insert at top
            analysisCards.insertBefore(card, analysisCards.firstChild);

            // Save to history
            analysisHistory.push(analysis);
        }

        function showError(message) {
            const card = document.createElement('div');
            card.className = 'bg-red-50 rounded-lg p-4 border-l-4 border-red-500';
            card.innerHTML = `<p class="text-sm text-red-700">âŒ ${message}</p>`;
            analysisCards.insertBefore(card, analysisCards.firstChild);
        }

        // === localStorage Management ===
        function saveToHistory() {
            const session = {
                timestamp: new Date().toISOString(),
                duration: timer.textContent,
                transcript: transcriptSegments,
                analyses: analysisHistory
            };

            const history = JSON.parse(localStorage.getItem('realtimeCounselingHistory') || '[]');
            history.unshift(session);

            // Keep last 10 sessions
            localStorage.setItem('realtimeCounselingHistory', JSON.stringify(history.slice(0, 10)));
        }

        function toggleHistory() {
            const section = document.getElementById('historySection');
            const toggle = document.getElementById('historyToggle');

            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                toggle.textContent = 'â–²';
                loadHistory();
            } else {
                section.classList.add('hidden');
                toggle.textContent = 'â–¼';
            }
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('realtimeCounselingHistory') || '[]');
            const list = document.getElementById('historyList');

            if (history.length === 0) {
                list.innerHTML = '<p class="text-gray-400 italic">å°šç„¡æ­·å²è¨˜éŒ„</p>';
                return;
            }

            list.innerHTML = history.map((session, index) => `
                <div class="bg-gray-50 rounded p-3">
                    <div class="flex justify-between items-center">
                        <span class="font-bold">#${index + 1} - ${new Date(session.timestamp).toLocaleString('zh-TW')}</span>
                        <span class="text-sm text-gray-600">æ™‚é•·ï¼š${session.duration}</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-1">åˆ†ææ¬¡æ•¸ï¼š${session.analyses.length} æ¬¡</p>
                </div>
            `).join('');
        }

        function clearHistory() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ­·å²è¨˜éŒ„å—ï¼Ÿ')) {
                localStorage.removeItem('realtimeCounselingHistory');
                document.getElementById('historyList').innerHTML = '<p class="text-gray-400 italic">å°šç„¡æ­·å²è¨˜éŒ„</p>';
            }
        }

        // === Demo Mode (Simulate transcript input) ===
        let demoScriptIndex = 0;
        const demoScripts = {
            // åŠ‡æœ¬ 1: å·¥ä½œå£“åŠ›èˆ‡ç„¦æ…®
            workStress: [
                { speaker: 'counselor', text: 'ä½ å¥½ï¼Œä»Šå¤©æƒ³èŠä»€éº¼å‘¢ï¼Ÿ' },
                { speaker: 'client', text: 'æˆ‘æœ€è¿‘å·¥ä½œå£“åŠ›å¾ˆå¤§ï¼Œå¸¸å¸¸ç„¦æ…®åˆ°ç¡ä¸è‘—...' },
                { speaker: 'counselor', text: 'è½èµ·ä¾†å£“åŠ›çœŸçš„å¾ˆå¤§ï¼Œèƒ½è·Ÿæˆ‘å¤šèªªä¸€äº›å—ï¼Ÿ' },
                { speaker: 'client', text: 'æˆ‘è¦ºå¾—ä¸ç®¡æ€éº¼åšï¼Œä¸»ç®¡éƒ½ä¸æ»¿æ„ã€‚' },
                { speaker: 'counselor', text: 'é€™è®“ä½ æ„Ÿåˆ°å¾ˆæŒ«æŠ˜ï¼Œæ˜¯å—ï¼Ÿ' },
                { speaker: 'client', text: 'å°ï¼Œè€Œä¸”æˆ‘é–‹å§‹æ‡·ç–‘è‡ªå·±çš„èƒ½åŠ›...' },
                { speaker: 'counselor', text: 'ç•¶ä½ èªªã€Œæ‡·ç–‘è‡ªå·±ã€ï¼Œå…·é«”æ˜¯æŒ‡ä»€éº¼å‘¢ï¼Ÿ' },
                { speaker: 'client', text: 'æˆ‘è¦ºå¾—è‡ªå·±ä»€éº¼éƒ½åšä¸å¥½ï¼Œæ´»è‘—å¥½åƒæ²’ä»€éº¼æ„ç¾©ã€‚' },
                { speaker: 'counselor', text: 'ä½ å‰›æ‰èªªã€Œæ´»è‘—æ²’æ„ç¾©ã€ï¼Œé€™æ˜¯æœ€è¿‘æ‰æœ‰çš„æƒ³æ³•å—ï¼Ÿ' },
                { speaker: 'client', text: 'å—¯...æœ€è¿‘ç‰¹åˆ¥å¼·çƒˆã€‚' }
            ],

            // åŠ‡æœ¬ 2: ä¸€èˆ¬è«®è©¢
            general: [
                { speaker: 'counselor', text: 'ä»Šå¤©éå¾—å¦‚ä½•ï¼Ÿ' },
                { speaker: 'client', text: 'é‚„å¥½ï¼Œå°±æ˜¯æœ‰é»ç´¯ã€‚' },
                { speaker: 'counselor', text: 'ä»€éº¼è®“ä½ æ„Ÿåˆ°ç´¯å‘¢ï¼Ÿ' },
                { speaker: 'client', text: 'å·¥ä½œçš„äº‹æƒ…ï¼Œé‚„æœ‰å®¶è£¡çš„äº‹ã€‚' },
                { speaker: 'counselor', text: 'èƒ½å…·é«”èªªèªªæ˜¯ä»€éº¼äº‹å—ï¼Ÿ' },
                { speaker: 'client', text: 'ä¸»ç®¡æœ€è¿‘ä¸€ç›´ç›¯æˆ‘ï¼Œè®“æˆ‘å£“åŠ›å¾ˆå¤§ã€‚' },
                { speaker: 'counselor', text: 'ä¸»ç®¡ç›¯è‘—ä½ çš„æ„Ÿè¦ºï¼Œèƒ½æè¿°ä¸€ä¸‹å—ï¼Ÿ' },
                { speaker: 'client', text: 'å°±æ˜¯è¦ºå¾—è¢«ç›£è¦–ï¼Œä»€éº¼éƒ½è¦å ±å‘Šã€‚' }
            ]
        };

        let currentScript = demoScripts.workStress; // é è¨­ä½¿ç”¨å·¥ä½œå£“åŠ›åŠ‡æœ¬

        function simulateTranscriptInput() {
            if (!isRecording) return;

            // å¾ªåºæ’­æ”¾åŠ‡æœ¬
            if (demoScriptIndex < currentScript.length) {
                const line = currentScript[demoScriptIndex];

                // è‡ªå‹•åˆ‡æ›èªªè©±è€…
                if (line.speaker !== currentSpeaker) {
                    switchSpeaker(line.speaker);
                }

                addTranscriptLine(line.speaker, line.text);
                demoScriptIndex++;
            } else {
                // åŠ‡æœ¬æ’­å®Œï¼Œé‡ç½®æˆ–æç¤º
                console.log('Demo åŠ‡æœ¬å·²æ’­æ”¾å®Œç•¢ï¼ŒæŒ‰ R éµé‡æ–°é–‹å§‹');
            }
        }

        // Demo: Press 'T' to add next transcript line
        // Press 'R' to reset script
        // Press '1' for work stress script, '2' for general script
        document.addEventListener('keydown', (e) => {
            if (e.key === 't' || e.key === 'T') {
                simulateTranscriptInput();
            } else if (e.key === 'r' || e.key === 'R') {
                demoScriptIndex = 0;
                console.log('Demo åŠ‡æœ¬å·²é‡ç½®');
            } else if (e.key === '1') {
                currentScript = demoScripts.workStress;
                demoScriptIndex = 0;
                console.log('åˆ‡æ›åˆ°åŠ‡æœ¬ 1: å·¥ä½œå£“åŠ›èˆ‡ç„¦æ…®');
            } else if (e.key === '2') {
                currentScript = demoScripts.general;
                demoScriptIndex = 0;
                console.log('åˆ‡æ›åˆ°åŠ‡æœ¬ 2: ä¸€èˆ¬è«®è©¢');
            }
        });

        // === Initialize ===
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log('ğŸ¤ å³æ™‚è«®å•†è¼”åŠ©ç³»çµ± - Demo æ¨¡å¼');
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log('');
        console.log('ğŸ“Œ å¿«æ·éµèªªæ˜ï¼š');
        console.log('  T - æ’­æ”¾ä¸‹ä¸€å¥å°è©±');
        console.log('  R - é‡ç½®åŠ‡æœ¬');
        console.log('  1 - å·¥ä½œå£“åŠ›åŠ‡æœ¬ï¼ˆå«è‡ªæ®ºé¢¨éšªï¼‰');
        console.log('  2 - ä¸€èˆ¬è«®è©¢åŠ‡æœ¬');
        console.log('');
        console.log('ğŸ¤– AI åˆ†æï¼šæ¯ 60 ç§’è‡ªå‹•è§¸ç™¼');
        console.log('ğŸ’¾ æ­·å²è¨˜éŒ„ï¼šè‡ªå‹•å„²å­˜åˆ° localStorage');
        console.log('');
        console.log('âœ¨ ç•¶å‰åŠ‡æœ¬ï¼šå·¥ä½œå£“åŠ›èˆ‡ç„¦æ…®ï¼ˆåŠ‡æœ¬ 1ï¼‰');
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    </script>
</body>
</html>
