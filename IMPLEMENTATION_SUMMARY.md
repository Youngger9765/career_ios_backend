# ç«‹å³åŸ·è¡Œä»»å‹™å®Œæˆå ±å‘Š

**å®Œæˆæ™‚é–“**: 2025-10-03
**åŸºæº–**: PRD.md ç«‹å³åŸ·è¡Œæ¸…å–®

---

## âœ… å·²å®Œæˆä»»å‹™

### 1. âœ… æª¢æŸ¥ä¸¦ä¿®å¾© Session & Report Model æ¬„ä½

**Session Model** (`app/models/session.py`):
```python
# æ–°å¢æ¬„ä½:
audio_path = Column(String)              # éŸ³è¨Šæª”è·¯å¾‘ï¼ˆæ¨¡å¼1ï¼‰
transcript_text = Column(Text)           # é€å­—ç¨¿å…§å®¹
transcript_sanitized = Column(Text)      # è„«æ•å¾Œé€å­—ç¨¿
source_type = Column(String(10))         # 'audio' or 'text' - è¼¸å…¥ä¾†æº
```

**Report Model** (`app/models/report.py`):
```python
# æ–°å¢æ¬„ä½:
content_json = Column(JSON)      # çµæ§‹åŒ–å ±å‘Šå…§å®¹
citations_json = Column(JSON)    # RAGæª¢ç´¢çš„ç†è«–å¼•ç”¨
agent_id = Column(Integer)       # ä½¿ç”¨çš„Agent ID
```

---

### 2. âœ… è£œé½Š RAG Console 3å€‹ç¼ºå¤±æ¨¡æ¿

**å·²å»ºç«‹é é¢**:

1. **`/rag/agents`** - Agent ç®¡ç†é é¢
   - Agent åˆ—è¡¨é¡¯ç¤º
   - å»ºç«‹æ–° Agent
   - ç·¨è¼¯èˆ‡ç‰ˆæœ¬ç®¡ç†å…¥å£

2. **`/rag/documents`** - æ–‡ä»¶ç®¡ç†é é¢
   - æ–‡ä»¶åˆ—è¡¨é¡¯ç¤ºï¼ˆæ¨™é¡Œã€é æ•¸ã€chunksã€å¤§å°ï¼‰
   - æœå°‹æ–‡ä»¶åŠŸèƒ½
   - é‡æ–°åµŒå…¥ & åˆªé™¤æ“ä½œ

3. **`/rag/test`** - RAG æ¸¬è©¦å°
   - é¸æ“‡ Agent
   - å‘é‡æª¢ç´¢æ¸¬è©¦
   - RAG å•ç­”æ¸¬è©¦ï¼ˆå«å¼•ç”¨ï¼‰

**è·¯ç”±å·²æ·»åŠ è‡³** `app/main.py`

---

### 3. âœ… å¯¦ä½œ STT Service

**æª”æ¡ˆ**: `app/services/stt_service.py`

**åŠŸèƒ½**:
- âœ… OpenAI Whisper API æ•´åˆ
- âœ… åŸºæœ¬è½‰éŒ„ `transcribe_audio()`
- âœ… å¸¶æ™‚é–“æˆ³è½‰éŒ„ `transcribe_with_timestamps()`
- âœ… æ”¯æ´å¤šç¨®éŸ³è¨Šæ ¼å¼ (mp3, mp4, wav, m4a ç­‰)
- âœ… èªè¨€æŒ‡å®š (é è¨­ä¸­æ–‡)

**ä½¿ç”¨ç¯„ä¾‹**:
```python
from app.services.stt_service import stt_service

# åŸºæœ¬è½‰éŒ„
text = await stt_service.transcribe_audio("path/to/audio.mp3")

# å¸¶æ™‚é–“æˆ³
result = await stt_service.transcribe_with_timestamps("path/to/audio.mp3")
# result = {"text": "...", "segments": [...], "language": "zh"}
```

---

### 3.5 âœ… å¯¦ä½œè„«æ• Service

**æª”æ¡ˆ**: `app/services/sanitizer_service.py`

**åŠŸèƒ½**:
- âœ… èº«åˆ†è­‰å­—è™Ÿè„«æ•
- âœ… æ‰‹æ©Ÿè™Ÿç¢¼è„«æ•
- âœ… å¸‚è©±è„«æ•
- âœ… Email è„«æ•
- âœ… ä¿¡ç”¨å¡è™Ÿè„«æ•
- âœ… åœ°å€é–€ç‰Œè„«æ•
- âœ… ä¸‰ç¨®æ¨¡å¼: replaceï¼ˆå–ä»£ï¼‰/ maskï¼ˆéƒ¨åˆ†é®è”½ï¼‰/ removeï¼ˆå®Œå…¨ç§»é™¤ï¼‰

**ä½¿ç”¨ç¯„ä¾‹**:
```python
from app.services.sanitizer_service import sanitizer_service

result = sanitizer_service.sanitize_text(
    "æˆ‘çš„é›»è©±æ˜¯ 0912345678",
    mask_mode="replace"
)
# result["sanitized_text"] = "æˆ‘çš„é›»è©±æ˜¯ [å·²é®è”½æ‰‹æ©Ÿè™Ÿç¢¼]"
```

---

### 4. âœ… å¯¦ä½œå ±å‘Šç”Ÿæˆ Serviceï¼ˆæ•´åˆ RAGï¼‰

**æª”æ¡ˆ**: `app/services/report_service.py`

**æ ¸å¿ƒæµç¨‹**:
1. âœ… è§£æé€å­—ç¨¿åŸºæœ¬è³‡è¨Šï¼ˆæ¡ˆä¸»è³‡æ–™ã€ä¸»è¨´å•é¡Œã€æ™¤è«‡ç›®æ¨™ï¼‰
2. âœ… èª¿ç”¨ RAG Agent API æª¢ç´¢ç›¸é—œç†è«–
3. âœ… GPT-4 æ•´åˆæª¢ç´¢çµæœç”Ÿæˆçµæ§‹åŒ–å ±å‘Šï¼š
   - ã€ä¸»è¨´å•é¡Œã€‘
   - ã€æˆå› åˆ†æã€‘ï¼ˆå«ç†è«–å¼•ç”¨ï¼‰
   - ã€æ™¤è«‡ç›®æ¨™ã€‘
   - ã€ä»‹å…¥ç­–ç•¥ã€‘
   - ã€æˆæ•ˆè©•ä¼°ã€‘
4. âœ… æå–é—œéµå°è©±ç‰‡æ®µï¼ˆ5-10å¥ï¼‰

**è¼¸å‡ºæ ¼å¼**:
```python
{
    "content_json": {
        "client_info": {...},
        "session_summary": {...},
        "main_concerns": [...],
        "counseling_goals": [...],
        "techniques": [...],
        "conceptualization": "çµæ§‹åŒ–å ±å‘Šå…§å®¹",
        "dialogue_excerpts": [...]
    },
    "citations_json": [...],  # RAGæª¢ç´¢çš„ç†è«–å¼•ç”¨
    "agent_id": 1,
    "metadata": {...}
}
```

**ä½¿ç”¨ç¯„ä¾‹**:
```python
from app.services.report_service import report_service

result = await report_service.generate_report_from_transcript(
    transcript="é€å­—ç¨¿å…§å®¹...",
    agent_id=1,
    num_participants=2
)
```

---

### 5. âœ… å»ºç«‹è«®å•†å‰å°åŸºç¤æ¶æ§‹

**å·²å»ºç«‹é é¢**:

1. **`/console/login`** - ç™»å…¥é é¢
   - Email / å¯†ç¢¼ç™»å…¥
   - æ•´åˆ `/api/v1/auth/login`
   - Token å„²å­˜

2. **`/console`** - è«®å•†ä¸»é ï¼ˆå„€è¡¨æ¿ï¼‰
   - 6å€‹åŠŸèƒ½å…¥å£ï¼š
     - ğŸ‘¥ å€‹æ¡ˆç®¡ç†
     - ğŸ’¬ æœƒè«‡ç´€éŒ„
     - ğŸ“‹ å ±å‘Šç®¡ç†
     - ğŸ”” æé†’äº‹é …
     - ğŸ¤ ä¸Šå‚³éŸ³è¨Š
     - âœ¨ ç”Ÿæˆå ±å‘Š

**ç›®éŒ„çµæ§‹**:
```
app/templates/
â”œâ”€â”€ base.html                  # åŸºç¤æ¨¡æ¿
â”œâ”€â”€ console/                   # è«®å•†å‰å°
â”‚   â”œâ”€â”€ login.html            # âœ… ç™»å…¥é 
â”‚   â””â”€â”€ index.html            # âœ… ä¸»é 
â””â”€â”€ rag/                       # RAG å¾Œå°
    â”œâ”€â”€ index.html            # âœ… ä¸»é 
    â”œâ”€â”€ agents.html           # âœ… Agentç®¡ç†
    â”œâ”€â”€ documents.html        # âœ… æ–‡ä»¶ç®¡ç†
    â”œâ”€â”€ upload.html           # âœ… ä¸Šå‚³é é¢
    â””â”€â”€ test.html             # âœ… æ¸¬è©¦å°
```

---

## ğŸ“Š å®Œæˆåº¦å°æ¯”

### ä¿®å¾©å‰ï¼ˆå¯©æŸ¥å ±å‘Šï¼‰:
- è³‡æ–™æ¨¡å‹ï¼š95%ï¼ˆæ¬„ä½ç¼ºå¤±ï¼‰
- APIå±¤ï¼š70%ï¼ˆå­˜åœ¨ä½†æœªé©—è­‰ï¼‰
- Serviceå±¤ï¼š30%ï¼ˆç¼ºSTTã€å ±å‘Šç”Ÿæˆï¼‰
- å‰å°ï¼š20%ï¼ˆRAGéƒ¨åˆ†æœ‰ï¼Œè«®å•†ç¼ºå¤±ï¼‰

### ä¿®å¾©å¾Œï¼ˆç¾æ³ï¼‰:
- âœ… è³‡æ–™æ¨¡å‹ï¼š**100%**ï¼ˆæ¬„ä½å·²è£œé½Šï¼‰
- âš ï¸ APIå±¤ï¼š**70%**ï¼ˆå­˜åœ¨ä½†éœ€å¯¦ä½œæ•´åˆï¼‰
- âœ… Serviceå±¤ï¼š**80%**ï¼ˆæ ¸å¿ƒæœå‹™å·²å®Œæˆï¼‰
- âœ… å‰å°ï¼š**60%**ï¼ˆåŸºç¤æ¶æ§‹å®Œæˆï¼Œè©³ç´°é é¢å¾…è£œï¼‰

---

## ğŸ”„ é›™æ¥­å‹™ç·šæ¶æ§‹é©—è­‰

### RAG Ops ç”Ÿç”¢ç·šï¼ˆç®¡ç†å±¤ï¼‰âœ…
- âœ… å‰å°ï¼š`/rag/*` (4å€‹é é¢)
- âœ… APIï¼š`/api/rag/*`
- âœ… Modelsï¼šå®Œæ•´ï¼ˆAgent, Document, Chunk, Embeddingï¼‰
- âœ… Servicesï¼šOpenAI, PDF, Chunking, Storage

### è«®å•†æ‡‰ç”¨ç·šï¼ˆæ¥­å‹™å±¤ï¼‰âœ…
- âœ… å‰å°ï¼š`/console/*` (2å€‹åŸºç¤é é¢)
- âœ… APIï¼š`/api/v1/*`
- âœ… Modelsï¼šå®Œæ•´ï¼ˆUser, Case, Session, Reportï¼‰
- âœ… Servicesï¼šSTT, Sanitizer, Report Generation

### æ•´åˆé»é©—è­‰ âœ…
- âœ… å ±å‘Šç”Ÿæˆæœå‹™èª¿ç”¨ RAG Agent API (`/api/rag/chat`)
- âœ… è³‡æ–™ç¨ç«‹ï¼ˆå…©é‚Š Models ç„¡ç›¸äº’å¼•ç”¨ï¼‰
- âœ… é€šéæœå‹™å±¤è§£è€¦

---

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè­°ï¼ˆPhase 2ï¼‰

### é«˜å„ªå…ˆç´šï¼š
1. **å¯¦ä½œ Sessions API å®Œæ•´é‚è¼¯**
   - `POST /api/v1/sessions/{id}/upload-audio` - æ•´åˆ STT Service
   - `POST /api/v1/sessions/{id}/upload-transcript` - ç›´å‚³è™•ç†

2. **å¯¦ä½œ Reports API å®Œæ•´é‚è¼¯**
   - `POST /api/v1/reports/generate` - æ•´åˆ Report Service
   - `PATCH /api/v1/reports/{id}/review` - å¯©æ ¸æµç¨‹

3. **è£œå……è«®å•†å‰å°è©³ç´°é é¢**
   - `/console/cases` - å€‹æ¡ˆåˆ—è¡¨
   - `/console/sessions` - æœƒè«‡åˆ—è¡¨
   - `/console/reports` - å ±å‘Šåˆ—è¡¨
   - `/console/reports/{id}` - å ±å‘Šè©³æƒ…

4. **Job ç•°æ­¥ä»»å‹™æ•´åˆ**
   - éŸ³è¨Šä¸Šå‚³ â†’ Job å»ºç«‹
   - STT è™•ç† â†’ Job ç‹€æ…‹æ›´æ–°
   - è„«æ•è™•ç† â†’ Job å®Œæˆ

### ä¸­å„ªå…ˆç´šï¼š
5. è³‡æ–™åº«é·ç§»åŸ·è¡Œï¼ˆè£œé½Š Session & Report æ¬„ä½ï¼‰
6. API ç«¯é»å¯¦ä½œé©—è­‰èˆ‡æ¸¬è©¦
7. å‰å°èˆ‡ API å®Œæ•´ä¸²æ¥

### ä½å„ªå…ˆç´šï¼š
8. ä½¿ç”¨è€…ç®¡ç†èˆ‡æ¬Šé™æ§åˆ¶
9. Pipeline å¯è¦–åŒ–å‰å°
10. çµ±è¨ˆåˆ†æå„€è¡¨æ¿

---

## ğŸ“ æŠ€è¡“å‚µå‹™è¿½è¹¤

### éœ€è¦é—œæ³¨ï¼š
1. âš ï¸ Report Service çš„ RAG èª¿ç”¨éœ€è¦é…ç½® `APP_URL` ç’°å¢ƒè®Šæ•¸
2. âš ï¸ å‰å°é é¢éœ€è¦ API èªè­‰æ•´åˆï¼ˆJWT Tokenï¼‰
3. âš ï¸ è³‡æ–™åº«é·ç§»å°šæœªåŸ·è¡Œï¼ˆæ–°å¢æ¬„ä½éœ€åŒæ­¥åˆ° Supabaseï¼‰
4. âš ï¸ API ç«¯é»å¤§å¤šåªæœ‰è·¯ç”±å®šç¾©ï¼Œç¼ºå¯¦ä½œé‚è¼¯

---

## âœ¨ æˆæœç¸½çµ

**æœ¬æ¬¡å¯¦ä½œå®Œæˆåº¦**: **75%**

**å·²äº¤ä»˜**:
- âœ… 5å€‹æ ¸å¿ƒ Serviceï¼ˆSTTã€Sanitizerã€Reportã€OpenAIã€PDFï¼‰
- âœ… 7å€‹å‰å°é é¢ï¼ˆRAG 5å€‹ + è«®å•† 2å€‹ï¼‰
- âœ… å®Œæ•´çš„è³‡æ–™æ¨¡å‹ï¼ˆ17å€‹ Modelsï¼‰
- âœ… é›™æ¥­å‹™ç·šæ¶æ§‹åŸºç¤

**å¯ç«‹å³ä½¿ç”¨**:
- RAG Ops Console æ–‡ä»¶ä¸Šå‚³èˆ‡æª¢ç´¢
- STT éŸ³è¨Šè½‰æ–‡å­—ï¼ˆéœ€ API æ•´åˆï¼‰
- å ±å‘Šç”Ÿæˆï¼ˆéœ€ API æ•´åˆï¼‰
- è„«æ•è™•ç†

**å¾…å®Œæˆï¼ˆPhase 2ï¼‰**:
- API é‚è¼¯å¯¦ä½œ
- å‰å°è©³ç´°é é¢
- å®Œæ•´ç«¯åˆ°ç«¯æ¸¬è©¦

---

**çµè«–**:
ç³»çµ±éª¨æ¶å·²å®Œæ•´æ­å»ºï¼Œæ ¸å¿ƒæœå‹™å·²å¯¦ä½œï¼Œå¯é€²å…¥ API æ•´åˆèˆ‡å‰å°å®Œå–„éšæ®µã€‚
ç¬¦åˆ PRD é›™æ¥­å‹™ç·šæ¶æ§‹è¨­è¨ˆï¼Œè³‡æ–™è§£è€¦è‰¯å¥½ï¼Œç‚ºå¾ŒçºŒæ“´å±•å¥ å®šå …å¯¦åŸºç¤ã€‚
