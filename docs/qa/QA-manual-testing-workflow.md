# 親子諮詢系統 - 手動測試 QA 流程

**測試範圍**: 八大流派分析、Prompt、AI 鼓勵訊息
**版本**: v1.0
**日期**: 2026-01-01
**測試環境**: http://localhost:8080

---

## 📋 測試前準備

### 1. 啟動測試環境
```bash
cd /Users/young/project/career_ios_backend
poetry run uvicorn app.main:app --reload --port 8080
```

### 2. 準備測試數據
- **測試帳號**: 已註冊的 counselor 帳號
- **測試案主**: 預先建立的 client 和 case
- **測試逐字稿**: 準備多種情境的親子對話逐字稿

### 3. 測試工具
- 瀏覽器: Chrome
- API 測試: Swagger UI (`http://localhost:8080/docs`)
- 前端頁面: `http://localhost:8080/realtime-counseling`

---

## 🎯 測試流程 1: 八大流派分析驗證

### 目標
驗證系統能正確整合並應用八大教養流派，提供準確的親子互動分析。

### 八大流派清單
1. ✅ 阿德勒正向教養 (Positive Discipline)
2. ✅ 薩提爾模式 (Satir Model)
3. ✅ 行為分析學派 (ABA, ABC 模式)
4. ⚠️ 人際神經生物學 (Dan Siegel) - 有科學爭議警告
5. ✅ 情緒輔導 (Emotion Coaching - John Gottman)
6. ✅ 協作解決問題 (Collaborative Problem Solving - Ross Greene)
7. ✅ 現代依附與內在觀點 (Dr. Becky Kennedy)
8. ✅ 社會意識與價值觀教養

---

### 測試案例 1.1: 紅燈情境 (Red - Severity 3)

**測試逐字稿**:
```
家長：你為什麼這麼不聽話！再不寫功課我就打你！
孩子：我不想寫！你很煩！（開始大哭）
家長：（提高音量）你給我閉嘴！現在就去寫！
孩子：（哭得更大聲）我討厭你！
```

**測試步驟**:
1. 登入系統 → 開啟 `/realtime-counseling`
2. 選擇模式：`Practice Mode` (事前練習)
3. 貼上測試逐字稿
4. 點擊「開始分析」按鈕
5. 等待分析結果 (~5 秒)

**預期結果** (檢查清單):
- [ ] `safety_level`: **"red"**
- [ ] `severity`: **3**
- [ ] `display_text`: 包含「情緒崩潰」或「衝突升級」等關鍵字
- [ ] `action_suggestion`: 提供立即降溫建議
- [ ] `detailed_scripts`: 包含具體話術 (150-300 字)
  - [ ] 肢體語言描述 (例如：蹲下與孩子平視)
  - [ ] 同理猜測 (例如：「我猜你可能是因為...」)
  - [ ] 停頓等待
  - [ ] 提供選擇
- [ ] `theoretical_frameworks`: 至少包含 2-3 個流派
  - [ ] 應包含: 薩提爾模式 (同理連結)
  - [ ] 應包含: 情緒輔導 (Emotion Coaching)
  - [ ] 可能包含: Dr. Becky Kennedy (具體話術)
- [ ] **Dan Siegel 警告**: 若使用人際神經生物學，應有科學爭議警告

**驗證重點**:
1. **流派整合**: 分析中是否整合多個流派的觀點？
2. **話術品質**: 是否提供逐字稿級別的具體對話範例？
3. **理論標註**: 每個建議是否清楚標註理論來源？
4. **科學嚴謹性**: Dan Siegel 相關建議是否有警告？

---

### 測試案例 1.2: 黃燈情境 (Yellow - Severity 2)

**測試逐字稿**:
```
家長：快點去寫功課，不要一直玩手機。
孩子：等一下啦，我在看東西。
家長：（語氣不耐煩）你每次都說等一下，到底要等多久？
孩子：煩死了，知道了啦。
```

**預期結果** (檢查清單):
- [ ] `safety_level`: **"yellow"**
- [ ] `severity`: **2**
- [ ] `display_text`: 包含「溝通不良」或「情緒緊張」
- [ ] `action_suggestion`: 建議改善溝通方式
- [ ] `detailed_scripts`: 包含以下元素
  - [ ] **阿德勒**: 提供選擇、溫和而堅定
  - [ ] **薩提爾**: 冰山探索 (行為背後的感受)
  - [ ] **協作問題解決**: 三步驟協商
- [ ] `keywords`: 包含相關關鍵詞 (例如：「手機」、「拖延」、「界線」)
- [ ] `categories`: 分類標籤 (例如：「時間管理」、「3C 使用」)

**驗證重點**:
1. **ABC 模式**: 是否分析了前因 (Antecedent)、行為 (Behavior)、後果 (Consequence)？
2. **冰山理論**: 是否探索行為背後的深層需求？
3. **性別框架檢核**: 是否檢查家長期待是否受性別框架影響？

---

### 測試案例 1.3: 綠燈情境 (Green - Severity 1)

**測試逐字稿**:
```
家長：我看到你在寫功課了，很棒！你覺得今天寫到哪裡可以休息一下？
孩子：嗯...我想寫完數學就休息。
家長：聽起來是個好計畫。如果寫累了可以隨時跟我說。
孩子：好，謝謝媽媽。
```

**預期結果** (檢查清單):
- [ ] `safety_level`: **"green"**
- [ ] `severity`: **1**
- [ ] `display_text`: 包含「溝通順暢」或「互相尊重」
- [ ] `action_suggestion`: 鼓勵維持良好互動模式
- [ ] `theoretical_frameworks`: 應標註使用的流派
  - [ ] 阿德勒 (提供選擇、鼓勵)
  - [ ] Dr. Becky Kennedy (具體肯定)
- [ ] `detailed_scripts`: 即使是綠燈，仍提供進階話術建議

**驗證重點**:
1. 系統是否能識別良好的親子互動？
2. 是否提供「維持」而非「修正」的建議？

---

## 🎯 測試流程 2: Practice vs Emergency 模式差異驗證

### 目標
確認兩種模式的輸出符合設計規格 (詳細 vs 簡潔)

### 測試案例 2.1: Practice Mode (事前練習)

**測試步驟**:
1. 開啟 `/realtime-counseling`
2. 選擇 **Practice Mode**
3. 貼上測試逐字稿 (任意紅/黃/綠燈情境)
4. 點擊「開始分析」

**預期結果** (檢查清單):
- [ ] `detailed_scripts`: **150-300 字** 的詳細話術
- [ ] 包含完整的 5 步驟分析架構痕跡:
  - [ ] 步驟 1: 分析狀態
  - [ ] 步驟 2: 意識檢核
  - [ ] 步驟 3: 同理連結
  - [ ] 步驟 4: 解決策略
  - [ ] 步驟 5: 具體話術
- [ ] 話術包含:
  - [ ] 肢體語言描述
  - [ ] 觀察陳述
  - [ ] 同理猜測
  - [ ] 停頓等待提示
  - [ ] 提供選擇
  - [ ] 協商邀請
- [ ] `theory_basis`: 清楚標註理論來源
- [ ] `child_likely_response`: 預期孩子的回應
- [ ] `suggested_interval_seconds`: **30 秒** (較長)

**驗證重點**:
- Practice Mode 應該是**教學性質**，幫助家長理解「為什麼」和「如何」
- 輸出應該詳細、完整、有教育價值

---

### 測試案例 2.2: Emergency Mode (即時介入)

**測試步驟**:
1. 開啟 `/realtime-counseling`
2. 選擇 **Emergency Mode**
3. 貼上**相同的測試逐字稿** (與 Practice Mode 相同)
4. 點擊「開始分析」

**預期結果** (檢查清單):
- [ ] `detailed_scripts`: **100-200 字** 的簡潔話術 (比 Practice Mode 短)
- [ ] 3 步驟快速思考架構:
  - [ ] 步驟 1: 狀態判斷
  - [ ] 步驟 2: 同理 + 解決
  - [ ] 步驟 3: 具體話術
- [ ] 話術特點:
  - [ ] 立即可用
  - [ ] 聚焦當下
  - [ ] **不包含詳細理論解釋**
- [ ] `theory_basis`: 仍然標註，但更簡潔
- [ ] `suggested_interval_seconds`: **15 秒** (較短)

**驗證重點**:
- Emergency Mode 應該是**行動導向**，快速、精準、即時可用
- 輸出應該簡潔，家長可在現場快速閱讀和執行

---

### 測試案例 2.3: 兩種模式對比測試

**對比項目**:

| 項目 | Practice Mode | Emergency Mode | 驗證狀態 |
|------|---------------|----------------|---------|
| 話術長度 | 150-300 字 | 100-200 字 | [ ] |
| 分析架構 | 5 步驟詳細 | 3 步驟快速 | [ ] |
| 理論解釋 | 詳細說明 | 簡潔標註 | [ ] |
| 輪詢間隔 | 30 秒 | 15 秒 | [ ] |
| 教學性質 | 強 (幫助學習) | 弱 (快速行動) | [ ] |
| 使用情境 | 獨自練習 | 現場互動 | [ ] |

**驗證方法**:
1. 使用**相同逐字稿**分別測試兩種模式
2. 比較 `detailed_scripts` 的字數和內容深度
3. 確認 `suggested_interval_seconds` 符合預期值
4. 確認話術風格符合模式定位

---

## 🎯 測試流程 3: AI 鼓勵訊息 (Quick Feedback)

### 目標
驗證 10-15 秒輪詢的快速鼓勵訊息功能，提供即時反饋。

### 測試案例 3.1: 快速鼓勵訊息基本功能

**API Endpoint**: `POST /api/realtime/quick-feedback`

**測試步驟**:
1. 開啟 Swagger UI: `http://localhost:8080/docs`
2. 找到 `POST /api/realtime/quick-feedback` 端點
3. 點擊「Try it out」
4. 輸入測試 payload:

```json
{
  "recent_transcript": "家長：你今天在學校怎麼樣？\n孩子：還好啦...",
  "context": {
    "mode": "practice",
    "child_age": 8,
    "current_mood": "neutral"
  }
}
```

5. 點擊「Execute」

**預期結果** (檢查清單):
- [ ] HTTP 狀態碼: **200 OK**
- [ ] Response 包含以下欄位:
  - [ ] `message`: 鼓勵訊息 **(< 20 個字)**
  - [ ] `type`: 訊息類型 (例如：`"encouragement"`, `"observation"`, `"reflection"`)
  - [ ] `timestamp`: ISO 8601 格式時間戳
  - [ ] `latency_ms`: 回應時間 **(< 2000ms)**
- [ ] `message` 特性:
  - [ ] 簡短、正向
  - [ ] 與逐字稿內容相關
  - [ ] 使用繁體中文
  - [ ] 適合 10-15 秒輪詢顯示

**鼓勵訊息範例** (參考):
- ✅ 「很好的開始 👍」
- ✅ 「繼續保持耐心」
- ✅ 「孩子正在打開心房」
- ✅ 「情緒穩定，很棒」
- ❌ 「你應該使用薩提爾模式冰山理論探索孩子行為背後的深層需求...」(太長)

---

### 測試案例 3.2: 不同情境的鼓勵訊息

測試系統能否根據不同情境提供適當的鼓勵訊息。

**測試情境 A: 良好互動**
```json
{
  "recent_transcript": "家長：我看到你在努力了，很棒！\n孩子：謝謝爸爸。",
  "context": {"mode": "practice"}
}
```
**預期**: 正向鼓勵 (例如：「互動很順利 ✨」)

**測試情境 B: 衝突升級**
```json
{
  "recent_transcript": "家長：你為什麼這麼不聽話！\n孩子：我討厭你！",
  "context": {"mode": "emergency"}
}
```
**預期**: 安撫提醒 (例如：「深呼吸，保持冷靜」)

**測試情境 C: 沉默互動**
```json
{
  "recent_transcript": "家長：你今天怎麼不說話？\n孩子：...",
  "context": {"mode": "practice"}
}
```
**預期**: 耐心提醒 (例如：「給孩子一些時間」)

**驗證清單**:
- [ ] 情境 A: 鼓勵訊息是否正向、肯定？
- [ ] 情境 B: 鼓勵訊息是否溫和、安撫？
- [ ] 情境 C: 鼓勵訊息是否耐心、支持？
- [ ] 所有訊息長度 < 20 字？
- [ ] 回應時間 < 2 秒？

---

### 測試案例 3.3: Quick Feedback 與完整分析整合

**測試情境**: 模擬真實使用流程

**測試步驟**:
1. 開啟 `/realtime-counseling`
2. 啟動對話後，每 **10-15 秒**呼叫一次 Quick Feedback
3. 每 **60 秒**呼叫一次完整分析 (analyze-partial)
4. 觀察兩種訊息的配合

**預期行為**:
```
0 秒  → Quick: 「開始對話了 👍」
10 秒 → Quick: 「繼續保持耐心」
20 秒 → Quick: 「孩子正在打開心房」
30 秒 → Quick: 「情緒穩定，很棒」
40 秒 → Quick: 「互動很順利」
50 秒 → Quick: 「快要有結果了」
60 秒 → 完整分析結果 (detailed_scripts + safety_level)
```

**驗證清單**:
- [ ] Quick Feedback 訊息間隔合理 (10-15 秒)？
- [ ] 完整分析間隔合理 (60 秒)？
- [ ] Quick Feedback 不會干擾完整分析顯示？
- [ ] 訊息之間有連貫性和節奏感？

---

## 🎯 測試流程 4: Prompt 正確性驗證

### 目標
驗證系統使用的 AI Prompt 是否符合設計規格，包含所有必要元素。

### 測試案例 4.1: Practice Mode Prompt 結構檢查

**檢查檔案**: `app/prompts/parenting.py`

**驗證清單**:
- [ ] Prompt 包含八大流派完整說明
- [ ] 每個流派有清楚的核心理念描述
- [ ] Dan Siegel 流派有科學爭議警告 (⚠️)
- [ ] 包含 5 步驟分析架構
- [ ] 包含紅黃綠燈判斷標準
- [ ] JSON 輸出格式定義清楚
- [ ] 包含 `detailed_scripts` 格式規範
- [ ] 包含 `theoretical_frameworks` 追蹤

**手動檢查方法**:
```bash
# 開啟檔案檢查
cat app/prompts/parenting.py | grep -A 5 "Dan Siegel"
# 應該看到警告訊息：⚠️ 注意：此理論部分概念有科學爭議
```

---

### 測試案例 4.2: Emergency Mode Prompt 簡潔性檢查

**驗證清單**:
- [ ] Prompt 包含八大流派 (與 Practice Mode 相同)
- [ ] 使用 3 步驟簡潔架構 (而非 5 步驟)
- [ ] 輸出格式更簡潔
- [ ] 話術長度限制為 100-200 字
- [ ] `suggested_interval_seconds` 預設為 15 秒

**對比驗證**:
```python
# Practice Mode
RESPONSE_FRAMEWORK_DETAILED  # 應該是 5 步驟
PRACTICE_MODE_PROMPT         # 應該包含 detailed 架構

# Emergency Mode
RESPONSE_FRAMEWORK_CONCISE   # 應該是 3 步驟
EMERGENCY_MODE_PROMPT        # 應該包含 concise 架構
```

---

### 測試案例 4.3: Prompt 變數替換測試

**驗證 Prompt 中的變數是否正確替換**

**測試步驟**:
1. 呼叫分析 API
2. 檢查系統 log (如果有記錄 prompt)
3. 或使用 debugger 查看實際發送給 AI 的 prompt

**預期變數替換**:
- [ ] `{context}` → 實際背景資訊
- [ ] `{full_transcript}` → 完整逐字稿 (Practice Mode)
- [ ] `{transcript_segment}` → 最近對話區塊
- [ ] `{EIGHT_SCHOOLS_CORE}` → 八大流派完整文字
- [ ] `{RESPONSE_FRAMEWORK_DETAILED}` / `{RESPONSE_FRAMEWORK_CONCISE}` → 對應架構
- [ ] `{SAFETY_LEVELS}` → 紅黃綠燈標準

**驗證方法**:
```bash
# 手動觸發分析，檢查 log
poetry run uvicorn app.main:app --reload --log-level debug

# 觀察 log 輸出的 prompt 內容
# 確認所有變數都被正確替換
```

---

## 🎯 測試流程 5: 完整 Web Session Workflow

### 目標
驗證從建立案主到完整分析的完整流程。

### 測試案例 5.1: 端到端流程測試

**測試步驟**:
1. **登入系統**
   ```
   http://localhost:8080/admin
   使用測試帳號登入
   ```

2. **建立案主 + 案例**
   - 點擊「新增案主」
   - 填寫基本資料 (姓名、email、性別、出生日期等)
   - 點擊「建立」
   - 記錄返回的 `client_id` 和 `case_id`

3. **開啟即時諮詢頁面**
   ```
   http://localhost:8080/realtime-counseling
   ```

4. **選擇剛建立的案主**
   - 從下拉選單選擇案主
   - 確認案主資訊正確顯示

5. **建立 Session**
   - 選擇模式: Practice Mode 或 Emergency Mode
   - 點擊「開始會談」
   - 確認 session 建立成功 (顯示 session_id)

6. **輸入逐字稿 + 分析**
   - 在文字框輸入測試逐字稿
   - 點擊「開始分析」
   - 等待分析結果

7. **驗證分析結果顯示**
   - [ ] 紅黃綠燈顯示正確
   - [ ] Severity 等級正確
   - [ ] Display text 清楚易懂
   - [ ] Action suggestion 實用
   - [ ] Detailed scripts 完整
   - [ ] 理論來源標註清楚
   - [ ] 關鍵詞標籤正確

8. **追加逐字稿**
   - 輸入第二段逐字稿
   - 點擊「繼續分析」
   - 確認系統能記錄累積的對話歷史

9. **結束 Session**
   - 點擊「結束會談」
   - 確認 session 狀態變為 `completed`
   - 確認所有分析結果已儲存

**驗證清單**:
- [ ] 所有 API 呼叫成功 (無 404, 500 錯誤)
- [ ] 前端顯示流暢，無錯誤訊息
- [ ] 資料正確儲存到資料庫
- [ ] Session 狀態轉換正確 (pending → active → completed)
- [ ] 分析結果符合預期品質

---

## 🎯 測試流程 6: 邊界案例與錯誤處理

### 測試案例 6.1: 空逐字稿

**測試輸入**:
```
(空字串)
```

**預期結果**:
- [ ] 系統返回友善錯誤訊息
- [ ] 不會 crash
- [ ] 提示使用者輸入內容

---

### 測試案例 6.2: 超長逐字稿

**測試輸入**:
```
(超過 5000 字的長篇對話)
```

**預期結果**:
- [ ] 系統能正常處理
- [ ] 回應時間在可接受範圍內 (< 10 秒)
- [ ] 或返回友善的長度限制提示

---

### 測試案例 6.3: 特殊字元

**測試輸入**:
```
家長：你$%^&*()這麼不聽話！
孩子：<script>alert('test')</script>
```

**預期結果**:
- [ ] 系統正確處理特殊字元
- [ ] 不會產生 XSS 漏洞
- [ ] 分析結果正常

---

### 測試案例 6.4: 非中文逐字稿

**測試輸入**:
```
Parent: Why don't you do your homework?
Child: I don't want to.
```

**預期結果**:
- [ ] 系統能辨識語言
- [ ] 返回對應語言的分析結果
- [ ] 或提示僅支援中文

---

## 📊 測試報告模板

### 測試執行記錄

| 測試案例 | 執行日期 | 測試人員 | 結果 | 備註 |
|---------|---------|---------|------|------|
| 1.1 紅燈情境 | 2026-01-01 | | ✅ / ❌ | |
| 1.2 黃燈情境 | 2026-01-01 | | ✅ / ❌ | |
| 1.3 綠燈情境 | 2026-01-01 | | ✅ / ❌ | |
| 2.1 Practice Mode | 2026-01-01 | | ✅ / ❌ | |
| 2.2 Emergency Mode | 2026-01-01 | | ✅ / ❌ | |
| 2.3 模式對比 | 2026-01-01 | | ✅ / ❌ | |
| 3.1 Quick Feedback 基本功能 | 2026-01-01 | | ✅ / ❌ | |
| 3.2 不同情境鼓勵訊息 | 2026-01-01 | | ✅ / ❌ | |
| 3.3 Quick Feedback 整合 | 2026-01-01 | | ✅ / ❌ | |
| 4.1 Practice Prompt 結構 | 2026-01-01 | | ✅ / ❌ | |
| 4.2 Emergency Prompt 簡潔性 | 2026-01-01 | | ✅ / ❌ | |
| 4.3 Prompt 變數替換 | 2026-01-01 | | ✅ / ❌ | |
| 5.1 端到端流程 | 2026-01-01 | | ✅ / ❌ | |
| 6.1 空逐字稿 | 2026-01-01 | | ✅ / ❌ | |
| 6.2 超長逐字稿 | 2026-01-01 | | ✅ / ❌ | |
| 6.3 特殊字元 | 2026-01-01 | | ✅ / ❌ | |
| 6.4 非中文逐字稿 | 2026-01-01 | | ✅ / ❌ | |

---

### 問題追蹤

| 問題編號 | 發現日期 | 測試案例 | 問題描述 | 嚴重程度 | 狀態 | 修復日期 |
|---------|---------|---------|---------|---------|------|---------|
| BUG-001 | | | | P0/P1/P2/P3 | Open/Fixed | |
| BUG-002 | | | | P0/P1/P2/P3 | Open/Fixed | |

**嚴重程度定義**:
- **P0 (Critical)**: 系統無法使用，影響核心功能
- **P1 (High)**: 重要功能受影響，但有 workaround
- **P2 (Medium)**: 次要功能問題，使用體驗受影響
- **P3 (Low)**: 小問題，不影響主要功能

---

## 🔄 迴歸測試清單

每次更新後，必須重新執行以下測試:

### 核心功能測試
- [ ] 八大流派分析 (紅黃綠燈各 1 個案例)
- [ ] Practice vs Emergency 模式差異
- [ ] Quick Feedback 功能
- [ ] 端到端 Web Session Workflow

### 整合測試
- [ ] API 端點全部正常回應 (200 OK)
- [ ] 前端頁面無 JavaScript 錯誤
- [ ] 資料庫操作正確執行

### 效能測試
- [ ] 分析回應時間 < 5 秒
- [ ] Quick Feedback 回應時間 < 2 秒
- [ ] 頁面載入時間 < 3 秒

---

## 📝 測試心得與改進建議

**測試心得** (由測試人員填寫):
```
[填寫測試過程中的發現、感受、建議]
```

**改進建議**:
```
[建議系統改進方向]
```

---

**文檔版本**: v1.0
**最後更新**: 2026-01-01
**負責人**: QA Team / Product Owner
