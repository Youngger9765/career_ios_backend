# 報告生成改善 - 施工計畫（唯一版本）

> **TL;DR**: 2.5 天完成，只做無風險改善，成本 0 增加，品質分數 80+

---

## 🎯 一句話目標

**11 月底前：讓 AI 從 1,986 個理論片段中，快速找到最適合個案的 5-7 個理論，生成結構完整的報告。**

---

## 📊 改善前 vs 改善後

| 項目 | 改善前 | 改善後 | 確定性 |
|------|--------|--------|--------|
| 段落完整性 | 60% | ✅ **100%** | 100% |
| 理論引用覆蓋 | 60% | ✅ **100%** | 100% |
| 理論數量 | 2-3 個 | ✅ **6 個** | 90% |
| 理論相關性 | 50% | ✅ **65%** | 80% |
| 品質可追蹤 | ❌ 無 | ✅ **有分數** | 100% |
| 成本增加 | - | ✅ **0%** | 100% |
| 工作量 | - | 18 小時 | - |

---

## 🏗️ 施工里程碑

### Milestone 1: 結構化與驗證基礎（Day 1-2）⭐⭐⭐

**目標**：確保報告結構 100% 完整 + 可追蹤品質

**工作項目**：

#### 1.1 結構化段落強制要求（2h）

**檔案**：`app/api/rag_report.py` Line 567-618

**任務**：
- [ ] 改寫 `report_prompt`，明確要求 10 個段落
- [ ] 每個段落加上明確的子項目說明
- [ ] 增加格式要求（【】標題、不用 markdown）

**驗證函數**：
```python
def validate_report_structure(report_text: str) -> dict:
    """檢查報告結構完整性"""
    required_sections = [
        "【一、案主基本資料】",
        "【二、主訴問題】",
        "【三、問題發展脈絡】",
        "【四、求助動機與期待】",
        "【五、多層次因素分析】",
        "【六、個案優勢與資源評估】",
        "【七、諮詢師的專業判斷】",
        "【八、諮商目標與介入策略】",
        "【九、預期成效與評估】",
        "【十、諮詢師自我反思】"
    ]

    missing = [s for s in required_sections if s not in report_text]

    return {
        "complete": len(missing) == 0,
        "missing_sections": missing,
        "coverage": (10 - len(missing)) / 10 * 100
    }
```

**預期成果**：段落完整性 60% → **100%**

---

#### 1.2 理論引用格式檢查（3h）

**檔案**：`app/utils/report_validators.py`（新增）

**任務**：
- [ ] 建立 `validate_citations()` 函數
- [ ] 檢查核心段落（五、七、八）是否有引用
- [ ] 統計引用總數
- [ ] 檢查是否有說明理由（「根據」「基於」「從...觀點」）

**核心程式碼**：
```python
def validate_citations(report_text: str) -> dict:
    """檢查理論引用品質"""

    critical_sections = {
        "【五、多層次因素分析】": "因素分析需要理論支持",
        "【七、諮詢師的專業判斷】": "專業判斷需要理論依據",
        "【八、諮商目標與介入策略】": "介入策略需要技術引用"
    }

    results = {}
    for section, reason in critical_sections.items():
        section_text = extract_section(report_text, section)
        citations = re.findall(r'\[(\d+)\]', section_text)

        results[section] = {
            "has_citations": len(citations) > 0,
            "citation_count": len(citations),
            "reason": reason,
            "status": "✅" if len(citations) > 0 else "❌"
        }

    total_citations = len(re.findall(r'\[(\d+)\]', report_text))

    # 檢查是否有說明理由
    has_rationale = any(keyword in report_text for keyword in
                       ["根據", "基於", "從", "理論指出", "顯示"])

    return {
        "section_details": results,
        "total_citations": total_citations,
        "has_rationale": has_rationale,
        "all_critical_sections_cited": all(r["has_citations"] for r in results.values())
    }

def extract_section(report_text: str, section_title: str) -> str:
    """提取特定段落文字"""
    start_match = re.search(re.escape(section_title), report_text)
    if not start_match:
        return ""

    start = start_match.end()
    next_section = re.search(r'【.+?】', report_text[start:])

    if next_section:
        end = start + next_section.start()
    else:
        end = len(report_text)

    return report_text[start:end]
```

**預期成果**：引用覆蓋率 60% → **100%**

---

#### 1.3 品質摘要報告（2h）

**檔案**：`app/utils/report_quality.py`（新增）

**任務**：
- [ ] 建立 `generate_quality_summary()` 函數
- [ ] 整合結構驗證和引用驗證結果
- [ ] 計算整體品質分數（0-100）
- [ ] 修改 API response 加入 `quality_summary`

**核心程式碼**：
```python
def generate_quality_summary(report: dict, report_text: str, theories: List[Citation]) -> dict:
    """生成報告品質摘要"""

    structure_validation = validate_report_structure(report_text)
    citation_validation = validate_citations(report_text)

    return {
        "structure_quality": {
            "completeness": structure_validation["coverage"],
            "missing_sections": structure_validation["missing_sections"]
        },
        "citation_quality": {
            "total_citations": citation_validation["total_citations"],
            "critical_sections_cited": citation_validation["all_critical_sections_cited"],
            "has_rationale": citation_validation["has_rationale"],
            "section_details": citation_validation["section_details"]
        },
        "content_metrics": {
            "total_length": len(report_text),
            "theory_count": len(theories)
        },
        "overall_score": calculate_quality_score(structure_validation, citation_validation),
        "timestamp": datetime.now().isoformat()
    }

def calculate_quality_score(structure: dict, citation: dict) -> float:
    """計算整體品質分數（0-100）"""
    score = 0

    # 結構完整性 (40%)
    score += structure["coverage"] * 0.4

    # 引用覆蓋率 (40%)
    if citation["all_critical_sections_cited"]:
        score += 40
    else:
        cited = sum(1 for r in citation["section_details"].values() if r["has_citations"])
        score += (cited / 3) * 40

    # 引用品質 (20%)
    if citation["has_rationale"]:
        score += 10
    citation_score = min(citation["total_citations"] / 7, 1.0) * 10
    score += citation_score

    return round(score, 1)
```

**API Response 範例**：
```json
{
  "report": { ... },
  "quality_summary": {
    "structure_quality": {
      "completeness": 100,
      "missing_sections": []
    },
    "citation_quality": {
      "total_citations": 6,
      "critical_sections_cited": true,
      "has_rationale": true,
      "section_details": {
        "【五、多層次因素分析】": {"has_citations": true, "citation_count": 2, "status": "✅"},
        "【七、諮詢師的專業判斷】": {"has_citations": true, "citation_count": 2, "status": "✅"},
        "【八、諮商目標與介入策略】": {"has_citations": true, "citation_count": 2, "status": "✅"}
      }
    },
    "overall_score": 88.5,
    "timestamp": "2025-10-19T15:00:00"
  }
}
```

**預期成果**：可追蹤性 0% → **100%**

---

**Milestone 1 完成標準**：
- ✅ 所有報告必須包含 10 個段落
- ✅ 核心段落（五、七、八）100% 有理論引用
- ✅ 每份報告都有品質分數
- ✅ 單元測試覆蓋率 80%+

**預計完成時間**：Day 1-2（7 小時）

---

### Milestone 2: 改善 RAG 檢索品質（Day 3）⭐⭐

**目標**：提升理論相關性，不增加成本

**工作項目**：

#### 2.1 改善 RAG Query（1h）

**檔案**：`app/api/rag_report.py` Line 519-561

**任務**：
- [ ] 改寫 `search_query` 構建邏輯
- [ ] 加入案主年齡、發展階段資訊
- [ ] 明確說明需要的理論類型
- [ ] 調整 `top_k` 從 7 → 10

**當前代碼**：
```python
# Line 522-526
search_terms = main_concerns[:3] + techniques[:2]
search_query = " ".join(search_terms)
```

**改善後**：
```python
# 提取關鍵資訊
client_age = parsed_data.get('age', '未提及')
main_concerns_text = ', '.join(main_concerns)
techniques_text = ', '.join(techniques)

# 構建更結構化的 query
search_query = f"""
職涯諮詢個案分析：
- 年齡：{client_age}
- 主要困擾：{main_concerns_text}

需要檢索的理論類型：
1. 生涯發展階段理論（如 Super, Gottfredson）- 解釋年齡與發展任務
2. 問題成因理論（如 Maslow, 動機理論）- 解釋困擾的根源
3. 介入策略與技術（{techniques_text}）- 實務方法與案例

請提供相關理論文獻和實務技巧。
""".strip()

# 調整參數
theories = await rag_search(
    query=search_query,
    top_k=10,        # 增加候選理論
    threshold=0.30   # 放寬閾值，確保找到足夠理論
)
```

**預期成果**：理論相關性 50% → **65%**，成本 **0 增加**

---

#### 2.2 Prompt 要求說明理由（1h）

**檔案**：`app/api/rag_report.py` Line 567-618

**任務**：
- [ ] 在 prompt 中加入「引用要求」說明
- [ ] 提供引用範例
- [ ] 明確要求說明「為何適用」

**Prompt 範例片段**：
```python
report_prompt = f"""
...

【五、多層次因素分析】⭐ 核心段落
請從以下四個層次分析，並引用相關理論 [1], [2]：
- 個人因素（含生涯發展階段、人格特質、能力認知）
- 人際因素（家庭關係、社會支持）
- 環境因素（職場/學校、經濟狀況）
- 發展因素（早期經驗、生涯成熟度）

**引用要求**：
✓ 必須說明：「根據理論 [X]，案主的狀況顯示...」
✓ 或：「從理論 [X] 的觀點來看，案主...」
✗ 不可只列出 [1] 而不說明適用原因

**範例**：
「根據 Super 的生涯發展理論 [1]，案主目前 28 歲，正處於探索期晚期至建立期早期的過渡階段。
然而，案主表現出的生涯不確定性與頻繁轉職，可能反映其生涯成熟度尚未達到同齡應有的水準...」

【七、諮詢師的專業判斷】⭐ 核心段落
- 對問題的假設（為何會有這些困擾）：...
- 理論依據（用什麼理論支持你的假設）：引用 [3], [4]
- 理論取向：...

**引用要求**：必須說明「基於...理論，我認為案主的問題可能源於...」

【八、諮商目標與介入策略】⭐ 核心段落
- 諮商目標（SMART 格式）：...
- 擬用技術：... 引用 [5], [6]
- 技術選擇理由：（為何這個技術適合此個案）

**引用要求**：說明「選擇此技術是因為...，理論 [X] 指出...」

**格式要求**：
1. 使用【】標題格式
2. 必須在第五、七、八段落引用理論 [1], [2] 格式
3. 每個引用都要說明「為何適用此個案」
4. 不使用 markdown 格式（##, **, -）
"""
```

**預期成果**：引用品質從「機械式」→「有理由說明」

---

**Milestone 2 完成標準**：
- ✅ RAG query 包含年齡、發展階段、需求類型
- ✅ 理論候選數量從 7 → 10 個
- ✅ Prompt 明確要求說明理由，並提供範例
- ✅ 測試 3-5 個案例，理論相關性提升

**預計完成時間**：Day 3（2 小時）

---

### Milestone 3: 整合測試與調優（Day 4-5）⭐

**目標**：用真實逐字稿測試，調整參數

**工作項目**：

#### 3.1 端到端測試（2h）

**任務**：
- [ ] 準備 5 個不同類型的真實逐字稿
  - 年齡跨度：20-40 歲
  - 問題類型：迷茫、轉職、興趣探索、職涯規劃
- [ ] 對每個案例生成報告
- [ ] 記錄品質分數和問題

**測試案例範本**：
```python
test_cases = [
    {
        "name": "案例1：25歲職場新人迷茫",
        "transcript": "...",
        "expected_theories": ["Super 生涯發展", "職涯適應"],
        "expected_score": "> 80"
    },
    {
        "name": "案例2：35歲中年轉職",
        "transcript": "...",
        "expected_theories": ["轉職策略", "生涯轉換"],
        "expected_score": "> 80"
    },
    # ... 3 more cases
]

for case in test_cases:
    report = await generate_report(case["transcript"])
    quality = report["quality_summary"]

    print(f"\n案例：{case['name']}")
    print(f"品質分數：{quality['overall_score']}")
    print(f"理論引用數：{quality['citation_quality']['total_citations']}")
    print(f"核心段落覆蓋：{quality['citation_quality']['critical_sections_cited']}")
    print(f"理論：{[t['document'] for t in report['theories'][:5]]}")
```

---

#### 3.2 參數調優（2h）

**任務**：
- [ ] 調整 `similarity_threshold`（當前 0.25）
  - 測試 0.25, 0.30, 0.35
  - 找到最佳召回率與精確度平衡點
- [ ] 調整 `top_k`（當前改為 10）
  - 測試 7, 10, 12
  - 避免過多無關理論
- [ ] 調整 LLM `temperature`
  - 報告生成：測試 0.5, 0.6, 0.7
  - 找到創意與穩定性平衡點

**調優記錄範本**：
```markdown
## 參數調優記錄

### Similarity Threshold
| 閾值 | 平均召回理論數 | 相關性評分 | 建議 |
|------|--------------|-----------|------|
| 0.25 | 12 | 6.5/10 | 太多無關 |
| 0.30 | 10 | 7.5/10 | ✅ 最佳 |
| 0.35 | 7 | 7.8/10 | 召回不足 |

### Top K
| 值 | 平均引用數 | 重複率 | 建議 |
|----|----------|--------|------|
| 7  | 4.2 | 10% | 太少 |
| 10 | 6.5 | 15% | ✅ 最佳 |
| 12 | 7.1 | 25% | 重複多 |

**最終決策**：threshold=0.30, top_k=10, temperature=0.6
```

---

#### 3.3 單元測試（2h）

**檔案**：`tests/unit/test_report_quality.py`（新增）

**任務**：
- [ ] 測試 `validate_report_structure()`
- [ ] 測試 `validate_citations()`
- [ ] 測試 `extract_section()`
- [ ] 測試 `calculate_quality_score()`

**測試範例**：
```python
def test_validate_report_structure_complete():
    """測試完整報告結構驗證"""
    report_text = """
    【一、案主基本資料】
    ...
    【二、主訴問題】
    ...
    【十、諮詢師自我反思】
    ...
    """

    result = validate_report_structure(report_text)

    assert result["complete"] == True
    assert result["coverage"] == 100
    assert len(result["missing_sections"]) == 0

def test_validate_citations_critical_sections():
    """測試核心段落引用驗證"""
    report_text = """
    【五、多層次因素分析】
    根據 Super 理論 [1]，案主...

    【七、諮詢師的專業判斷】
    基於發展理論 [2][3]...

    【八、諮商目標與介入策略】
    採用卡片排序 [4]...
    """

    result = validate_citations(report_text)

    assert result["all_critical_sections_cited"] == True
    assert result["total_citations"] >= 4
    assert result["has_rationale"] == True

def test_quality_score_calculation():
    """測試品質分數計算"""
    structure = {"coverage": 100}
    citation = {
        "all_critical_sections_cited": True,
        "total_citations": 7,
        "has_rationale": True
    }

    score = calculate_quality_score(structure, citation)

    assert score >= 90  # 完美報告應該 90 分以上
    assert score <= 100
```

**目標覆蓋率**：80%+

---

**Milestone 3 完成標準**：
- ✅ 5 個測試案例平均分數 > 80
- ✅ 理論相關性人工評分 > 7/10
- ✅ 參數調優記錄完整
- ✅ 單元測試覆蓋率 > 80%
- ✅ 無關鍵 bug

**預計完成時間**：Day 4-5（6 小時）

---

### Milestone 4: 部署與文檔（Day 6）⭐

**目標**：部署到 staging，完成文檔

**工作項目**：

#### 4.1 部署到 Staging（1h）

**任務**：
- [ ] 確認所有測試通過
- [ ] 更新 `requirements.txt`（如有新依賴）
- [ ] 部署到 staging 環境
- [ ] Smoke test（基本功能驗證）

**Smoke Test 檢查清單**：
```
✅ API /api/report/generate 正常回應
✅ 報告包含 10 個段落
✅ quality_summary 正確返回
✅ 理論引用數量 >= 5
✅ 回應時間 < 30 秒
```

---

#### 4.2 使用文檔更新（1h）

**檔案**：`docs/API.md` 或 README

**任務**：
- [ ] 更新 API response schema（加入 `quality_summary`）
- [ ] 說明品質分數計算方式
- [ ] 提供範例 request/response

**文檔範例**：
```markdown
### POST /api/report/generate

生成個案概念化報告（v2 - 增強版）

**新功能**：
- ✅ 10 個結構化段落（確保完整性）
- ✅ 理論引用品質檢查
- ✅ 品質分數回傳（0-100）

**Response**:
```json
{
  "report": {
    "client_info": { ... },
    "conceptualization": "【一、案主基本資料】...",
    "theories": [ ... ],
    ...
  },
  "quality_summary": {
    "structure_quality": {
      "completeness": 100,
      "missing_sections": []
    },
    "citation_quality": {
      "total_citations": 6,
      "critical_sections_cited": true
    },
    "overall_score": 85.7
  }
}
```

**品質分數說明**：
- 90-100: 優秀（結構完整 + 理論引用充分）
- 75-89: 良好（結構完整，理論引用可加強）
- 60-74: 及格（有缺失段落或引用不足）
- < 60: 需改進
```

---

#### 4.3 週報更新（1h）

**檔案**：`WEEKLY_REPORT_20251020-20251026.md`（新增）

**任務**：
- [ ] 記錄本週完成的改善項目
- [ ] 更新系統效能指標
- [ ] 記錄參數調優結果
- [ ] 列出下週計畫（如有高風險項目要測試）

---

**Milestone 4 完成標準**：
- ✅ Staging 環境運作正常
- ✅ API 文檔更新
- ✅ 週報完成
- ✅ 準備好展示給客戶（心理師）

**預計完成時間**：Day 6（3 小時）

---

## 📅 總時程規劃

| 里程碑 | 時間 | 工作量 | 成果 |
|--------|------|--------|------|
| M1: 結構化與驗證 | Day 1-2 | 7h | 完整性 100%、可追蹤 100% |
| M2: RAG 改善 | Day 3 | 2h | 相關性 +15%、引用品質 ↑ |
| M3: 測試與調優 | Day 4-5 | 6h | 品質分數 >80、參數最佳化 |
| M4: 部署與文檔 | Day 6 | 3h | 上線 staging、文檔完成 |

**總工作量**：18 小時（約 2.5 個工作天）

**預計完成日期**：2025-10-25

---

## ✅ 交付清單

### 程式碼

- [x] `app/api/rag_report.py` - 改善 prompt 和 RAG query
- [x] `app/utils/report_validators.py` - 結構和引用驗證
- [x] `app/utils/report_quality.py` - 品質摘要計算
- [x] `tests/unit/test_report_quality.py` - 單元測試

### 文檔

- [x] API 文檔更新（quality_summary）
- [x] 參數調優記錄
- [x] 週報（WEEKLY_REPORT_20251020-20251026.md）

### 測試

- [x] 5 個真實案例測試報告
- [x] 單元測試覆蓋率 > 80%
- [x] Staging smoke test 通過

---

## 🚫 明確不做的項目（延後或取消）

| 項目 | 原因 | 狀態 |
|------|------|------|
| 三次段落級 RAG | 成本 +200%，效果不確定 | ⏸️ 延後驗證 |
| 36 欄位 Pydantic Schema | 過度工程化，實用性低 | ❌ 取消 |
| Multi-stage Generation | 複雜度高，時間成本大 | ⏸️ 延後到 12 月 |
| Few-shot Learning | 需要準備優質範例，時間成本大 | ⏸️ 延後 |
| Quality Scoring AI | 需要訓練評分模型 | ⏸️ 延後到 12 月 |

---

## 📊 成功指標

### 技術指標

- ✅ 報告結構完整性：**100%**
- ✅ 核心段落引用覆蓋率：**100%**
- ✅ 平均理論引用數：**6+**
- ✅ 平均品質分數：**80+**
- ✅ API 成本增加：**0%**

### 業務指標

- ✅ 心理師滿意度：> 7/10（主觀評分）
- ✅ 報告可用性：80%+（不需要大幅修改）
- ✅ 系統穩定性：99%+（無 critical bug）

---

## 🔄 風險與應對

| 風險 | 可能性 | 影響 | 應對措施 |
|------|--------|------|---------|
| 理論引用仍不相關 | 中 | 中 | 人工評分，如 <6/10 則調整 query |
| LLM 不遵守格式 | 低 | 低 | 驗證不通過則重試（max 2 次）|
| 測試案例不足 | 中 | 低 | 向心理師索取更多真實逐字稿 |
| Staging 部署問題 | 低 | 中 | 先在 local 完整測試再部署 |

---

**文件版本**：v1.0 (施工計畫合併版)
**建立日期**：2025-10-19
**負責人**：Backend Team
**目標完成日**：2025-10-25
**下次檢查點**：Day 2 結束（M1 完成驗收）
