# Markdown æ›´æ–°æµç¨‹è©³è§£

## ğŸ“Š å®Œæ•´æµç¨‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯ (iOS App)                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  ä½¿ç”¨è€…ç·¨è¼¯ Markdown                    â”‚                 â”‚
â”‚  â”‚  ã€Œ# å€‹æ¡ˆå ±å‘Š\n\n## å€‹æ¡ˆæ¦‚å¿µåŒ–\n\n...ã€  â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                       â”‚                                      â”‚
â”‚                       â”‚ PATCH /api/v1/reports/{id}          â”‚
â”‚                       â–¼                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                        â”‚
                        â”‚ {
                        â”‚   "edited_content_markdown": "..."
                        â”‚ }
                        â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¾Œç«¯ API (app/api/reports.py)                               â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  1. é©—è­‰                                â”‚                 â”‚
â”‚  â”‚     âœ“ è‡³å°‘è¦æœ‰ json æˆ– markdown         â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                   â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  2. æ›´æ–° edited_content_markdown        â”‚                 â”‚
â”‚  â”‚     report.edited_content_markdown = ... â”‚                 â”‚
â”‚  â”‚     attributes.flag_modified(...)        â”‚ â—„â”€â”€ é—œéµï¼     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                   â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  3. æŒä¹…åŒ–                              â”‚                 â”‚
â”‚  â”‚     db.flush()                          â”‚                 â”‚
â”‚  â”‚     db.commit()                         â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                   â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  4. é©—è­‰ï¼ˆé‡æ–°æŸ¥è©¢ï¼‰                    â”‚                 â”‚
â”‚  â”‚     SELECT * FROM reports WHERE id=...  â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                   â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  5. è¿”å›                                â”‚                 â”‚
â”‚  â”‚     {                                    â”‚                 â”‚
â”‚  â”‚       "edited_content_markdown": "...", â”‚                 â”‚
â”‚  â”‚       "edit_count": 1                   â”‚                 â”‚
â”‚  â”‚     }                                    â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                        â”‚
                        â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è³‡æ–™åº« (Supabase PostgreSQL)                                â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  reports è¡¨                            â”‚                 â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
â”‚  â”‚  id: uuid                              â”‚                 â”‚
â”‚  â”‚  edited_content_markdown: TEXT         â”‚ â—„â”€â”€ å„²å­˜åœ¨é€™ï¼ â”‚
â”‚  â”‚  edited_content_json: JSON             â”‚                 â”‚
â”‚  â”‚  edit_count: INTEGER                   â”‚                 â”‚
â”‚  â”‚  edited_at: TIMESTAMP                  â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                        â”‚
                        â”‚ GET /api/v1/reports/{id}
                        â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯å†æ¬¡æŸ¥è©¢                                                â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  æ”¶åˆ°å®Œå…¨ç›¸åŒçš„ Markdown                â”‚                 â”‚
â”‚  â”‚  ã€Œ# å€‹æ¡ˆå ±å‘Š\n\n## å€‹æ¡ˆæ¦‚å¿µåŒ–\n\n...ã€  â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                              â”‚
â”‚  âœ… å…§å®¹ä¸€æ¨¡ä¸€æ¨£ï¼                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ é—œéµç¨‹å¼ç¢¼

### 1. Schema å®šç¾© (`app/schemas/report.py:67-71`)

```python
class ReportUpdateRequest(BaseModel):
    """Schema for updating report content"""

    edited_content_json: Optional[Dict[str, Any]] = None  # é¸å¡«
    edited_content_markdown: Optional[str] = None  # é¸å¡«ï¼ˆå‰ç«¯ç›´æ¥å‚³ï¼‰
```

**æ”¹è®Š**ï¼š
- âŒ èˆŠç‰ˆï¼šåªæœ‰ `edited_content_json` (å¿…å¡«)
- âœ… æ–°ç‰ˆï¼šå…©å€‹éƒ½æ˜¯ `Optional`ï¼Œå¯ä»¥åªå‚³å…¶ä¸­ä¸€å€‹

---

### 2. PATCH Endpoint é‚è¼¯ (`app/api/reports.py:341-368`)

```python
# é©—è­‰ï¼šè‡³å°‘è¦æœ‰ä¸€å€‹
if not update_request.edited_content_json and not update_request.edited_content_markdown:
    raise HTTPException(status_code=400, detail="Must provide either...")

# ğŸ”¥ é—œéµï¼šå„ªå…ˆä½¿ç”¨å‰ç«¯å‚³çš„ markdown
if update_request.edited_content_markdown:
    report.edited_content_markdown = update_request.edited_content_markdown
    attributes.flag_modified(report, "edited_content_markdown")  # â—„â”€â”€ å¿…é ˆï¼

# å‘å¾Œç›¸å®¹ï¼šåªå‚³ JSON æ™‚è‡ªå‹•ç”Ÿæˆ
elif update_request.edited_content_json:
    formatter = create_formatter("markdown")
    edited_markdown = formatter.format(unwrap_report(update_request.edited_content_json))
    report.edited_content_markdown = edited_markdown
    attributes.flag_modified(report, "edited_content_markdown")

# æŒä¹…åŒ–
db.flush()
db.commit()

# é©—è­‰ï¼ˆé‡æ–°æŸ¥è©¢ï¼‰
verified_report = db.execute(select(Report).where(Report.id == report_id)).scalar_one()
```

**æµç¨‹**ï¼š
1. âœ… å‰ç«¯å‚³ markdown â†’ ç›´æ¥å„²å­˜
2. âœ… å‰ç«¯åªå‚³ JSON â†’ è‡ªå‹•ç”Ÿæˆ markdownï¼ˆå‘å¾Œç›¸å®¹ï¼‰
3. âœ… ä½¿ç”¨ `flag_modified()` æ¨™è¨˜æ¬„ä½ç‚ºå·²ä¿®æ”¹
4. âœ… é‡æ–°æŸ¥è©¢é©—è­‰è³‡æ–™ç¢ºå¯¦å¯«å…¥

---

### 3. GET Endpoint (`app/api/reports.py:210-272`)

```python
@router.get("/{report_id}")
def get_report(report_id: UUID, ...):
    # æŸ¥è©¢å ±å‘Š
    result = db.execute(
        select(Report, Client.name, SessionModel.session_number)
        .join(...)
        .where(Report.id == report_id, ...)
    )
    row = result.first()
    report, client_name, session_number = row

    # è¿”å›å®Œæ•´è³‡æ–™
    return ReportResponse(**report_dict)
```

**è¿”å›çš„è³‡æ–™**ï¼š
```json
{
  "id": "uuid",
  "edited_content_markdown": "# å€‹æ¡ˆå ±å‘Š\n\n...",  â—„â”€â”€ é€™æ˜¯å‰ç«¯å‚³çš„
  "edited_content_json": {...},
  "edit_count": 1,
  "edited_at": "2024-01-01T12:00:00+00:00"
}
```

---

## âœ… é©—è­‰ï¼šGET è¿”å›çš„æ˜¯æ›´æ–°å¾Œçš„å…§å®¹

### æ¸¬è©¦ 1ï¼šå–®å…ƒæ¸¬è©¦è­‰æ˜

```python
def test_update_only_markdown_without_json(in_memory_db, sample_report):
    report_id = sample_report.id

    # PATCH: å‰ç«¯å‚³ markdown
    frontend_markdown = "# å‰ç«¯ç·¨è¼¯çš„ Markdown\n\n..."
    report.edited_content_markdown = frontend_markdown
    attributes.flag_modified(report, "edited_content_markdown")
    in_memory_db.commit()

    # GET: é‡æ–°æŸ¥è©¢ï¼ˆæ¸…é™¤ cacheï¼‰
    in_memory_db.expire_all()
    persisted_report = in_memory_db.execute(
        select(Report).where(Report.id == report_id)
    ).scalar_one()

    # é©—è­‰ï¼šGET è¿”å›çš„å…§å®¹ == å‰ç«¯å‚³çš„å…§å®¹
    assert persisted_report.edited_content_markdown == frontend_markdown âœ…
```

**çµæœ**: âœ… **PASSED** (tests/unit/test_report_markdown_direct_update.py)

---

### æ¸¬è©¦ 2ï¼šStaging API é©—è­‰

æˆ‘å€‘åœ¨ staging ç’°å¢ƒåŸ·è¡Œäº†å®Œæ•´æ¸¬è©¦ï¼š

```bash
# Step 1: PATCH ç·¨è¼¯
curl -X PATCH "https://career-app-api-staging.../api/v1/reports/{id}" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"edited_content_markdown": "# æ¸¬è©¦å…§å®¹ timestamp=1762784788"}'

# è¿”å›:
{
  "edited_content_markdown": "# æ¸¬è©¦å…§å®¹ timestamp=1762784788", âœ…
  "edit_count": 1
}

# Step 2: GET ç«‹å³æŸ¥è©¢
curl "https://career-app-api-staging.../api/v1/reports/{id}"

# è¿”å›:
{
  "edited_content_markdown": "# æ¸¬è©¦å…§å®¹ timestamp=1762784788", âœ…
  "edit_count": 1
}

# Step 3: ç­‰å¾… 3 ç§’å¾Œ GET
sleep 3
curl "https://career-app-api-staging.../api/v1/reports/{id}"

# è¿”å›:
{
  "edited_content_markdown": "# æ¸¬è©¦å…§å®¹ timestamp=1762784788", âœ… ä¾ç„¶å­˜åœ¨ï¼
  "edit_count": 1
}
```

**çµæœ**: âœ… **æŒä¹…åŒ–æˆåŠŸï¼**

---

## ğŸ¯ çµè«–

### âœ… æ›´æ–°å¾Œçš„è¡Œç‚º

1. **PATCH æ¥å—å‰ç«¯çš„ markdown å­—ä¸²**
   - ä¸è‡ªå‹•å¾ JSON ç”Ÿæˆ
   - å®Œå…¨ä¿ç•™å‰ç«¯çš„æ ¼å¼ã€Emojiã€ç‰¹æ®Šå­—ç¬¦

2. **flag_modified() æ­£ç¢ºæ¨™è¨˜æ¬„ä½**
   - SQLAlchemy åµæ¸¬åˆ°è®Šæ›´
   - commit() æ™‚çœŸçš„å¯«å…¥è³‡æ–™åº«

3. **GET è¿”å›çš„æ˜¯æ›´æ–°å¾Œçš„å…§å®¹**
   - âœ… ç«‹å³æŸ¥è©¢ï¼šè¿”å›æ›´æ–°å…§å®¹
   - âœ… å»¶é²æŸ¥è©¢ï¼šè¿”å›æ›´æ–°å…§å®¹ï¼ˆæŒä¹…åŒ–ï¼‰
   - âœ… é‡é–‹ sessionï¼šè¿”å›æ›´æ–°å…§å®¹ï¼ˆç¢ºèªå¯«å…¥è³‡æ–™åº«ï¼‰

4. **å‘å¾Œç›¸å®¹**
   - èˆŠçš„åªå‚³ JSON çš„æ–¹å¼ä»ç„¶å¯ç”¨
   - è‡ªå‹•ç”Ÿæˆ markdown

---

## ğŸ“ ç›¸é—œæª”æ¡ˆ

- [Schema](../app/schemas/report.py) - ç¬¬ 67-71 è¡Œ
- [API Endpoint](../app/api/reports.py) - ç¬¬ 341-388 è¡Œ
- [å–®å…ƒæ¸¬è©¦](../tests/unit/test_report_markdown_direct_update.py)
- [API ä½¿ç”¨æŒ‡å—](./API_REPORT_EDIT.md)
