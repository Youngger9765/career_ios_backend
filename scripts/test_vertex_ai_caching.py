#!/usr/bin/env python3
"""
æ¸¬è©¦ Vertex AI Context Caching æ˜¯å¦çœŸçš„èƒ½çœ 50% æ™‚é–“
ä½¿ç”¨ Gemini 3 Flash Preview
"""

import asyncio
import os
import sys
import time
from datetime import timedelta

sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

import vertexai  # noqa: E402
from vertexai.generative_models import GenerationConfig, GenerativeModel  # noqa: E402
from vertexai.preview import caching  # noqa: E402

from app.core.config import settings  # noqa: E402


async def test_without_caching():
    """æ¸¬è©¦ï¼šæ²’æœ‰ä½¿ç”¨ Cachingï¼ˆåŸºæº–ç·šï¼‰"""
    print("\n" + "=" * 60)
    print("ğŸ§ª æ¸¬è©¦ 1: æ²’æœ‰ä½¿ç”¨ Context Cachingï¼ˆåŸºæº–ç·šï¼‰")
    print("=" * 60)

    # åˆå§‹åŒ– Vertex AI
    vertexai.init(project=settings.GEMINI_PROJECT_ID, location=settings.GEMINI_LOCATION)

    # æ¨¡æ“¬å®Œæ•´çš„ contextï¼ˆ8 å¤§æµæ´¾ç†è«– + å®Œæ•´å°è©±ï¼‰
    full_context = """ä½ æ˜¯å°ˆæ¥­è¦ªå­æ•™é¤Šé¡§å•ï¼Œç²¾é€š 8 å¤§æµæ´¾ï¼š
1. é˜¿å¾·å‹’æ­£å‘æ•™é¤Š - æº«å’Œä¸”å …å®šï¼Œå°Šé‡å­©å­ï¼Œä½¿ç”¨è‡ªç„¶å¾Œæœ
2. è–©æçˆ¾æ¨¡å¼ - å†°å±±ç†è«–ï¼Œæ¢ç´¢æ„Ÿå—ã€è§€é»ã€æœŸå¾…å’Œæ¸´æœ›
3. è¡Œç‚ºåˆ†æå­¸æ´¾ (ABA) - ABC æ¨¡å¼ï¼šå‰å› ã€è¡Œç‚ºã€å¾Œæœ
4. äººéš›ç¥ç¶“ç”Ÿç‰©å­¸ (Dan Siegel) - å…¨è…¦æ•™é¤Šï¼Œä¸Šå±¤è…¦ vs ä¸‹å±¤è…¦
5. æƒ…ç·’è¼”å° (John Gottman) - æƒ…ç·’æ•™ç·´ï¼Œå…ˆè™•ç†æƒ…ç·’å†è™•ç†è¡Œç‚º
6. å”ä½œè§£æ±ºå•é¡Œ (Ross Greene, CPS) - å­©å­æ¬ ç¼ºçš„æ˜¯æŠ€èƒ½ä¸æ˜¯å‹•æ©Ÿ
7. ç¾ä»£ä¾é™„èˆ‡å…§åœ¨è§€é» (Dr. Becky Kennedy) - å…·é«”è©±è¡“ï¼ŒåŒç†é€£çµ
8. ç¤¾æœƒæ„è­˜èˆ‡åƒ¹å€¼è§€æ•™é¤Š - æ€§åˆ¥å¹³æ¬Šã€èº«é«”è‡ªä¸»æ¬Šã€å¤šå…ƒæ–‡åŒ–

å®Œæ•´å°è©±é€å­—ç¨¿ï¼ˆç´„ 800 tokensï¼‰ï¼š
å®¶é•·ï¼šä½ ä»Šå¤©åœ¨å­¸æ ¡éå¾—æ€éº¼æ¨£ï¼Ÿ
å­©å­ï¼šé‚„å¥½å•Š
å®¶é•·ï¼šæœ‰ä»€éº¼é–‹å¿ƒçš„äº‹å—ï¼Ÿ
å­©å­ï¼šæ²’æœ‰
å®¶é•·ï¼šé‚£æœ‰ä»€éº¼ä¸é–‹å¿ƒçš„äº‹å—ï¼Ÿ
å­©å­ï¼šä¹Ÿæ²’æœ‰
å®¶é•·ï¼šä½ ç¢ºå®šå—ï¼Ÿæ„Ÿè¦ºä½ å¥½åƒæœ‰é»ä¸é–‹å¿ƒï¼Ÿ
å­©å­ï¼šå°±é‚„å¥½å•Šï¼Œæ²’ä»€éº¼ç‰¹åˆ¥çš„
å®¶é•·ï¼šæ˜¯ä¸æ˜¯è·ŸåŒå­¸æœ‰ä»€éº¼äº‹ï¼Ÿ
å­©å­ï¼šæ²’æœ‰å•¦
å®¶é•·ï¼šé‚£æ˜¯åŠŸèª²å¤ªå¤šå—ï¼Ÿ
å­©å­ï¼šä¹Ÿä¸æ˜¯
å®¶é•·ï¼šä½ åˆ°åº•æ€éº¼äº†ï¼Ÿå¯ä»¥è·Ÿåª½åª½èªªå—ï¼Ÿ
å­©å­ï¼šæˆ‘åªæ˜¯æœ‰é»ç´¯
ï¼ˆä»¥ä¸‹çœç•¥ç´„ 500 å­—çš„å®Œæ•´å°è©±...ï¼‰
"""

    times = []

    for i in range(3):
        print(f"\n   ğŸ”„ ç¬¬ {i+1} æ¬¡è«‹æ±‚:")

        # å®Œæ•´ promptï¼ˆæ¯æ¬¡éƒ½åŒ…å«å®Œæ•´ contextï¼‰
        prompt = f"""{full_context}

æœ€è¿‘å°è©±ï¼ˆç”¨æ–¼åˆ†æï¼‰ï¼š
å®¶é•·ï¼šä½ ç¢ºå®šå—ï¼Ÿæ„Ÿè¦ºä½ å¥½åƒæœ‰é»ä¸é–‹å¿ƒï¼Ÿ
å­©å­ï¼šå°±é‚„å¥½å•Šï¼Œæ²’ä»€éº¼ç‰¹åˆ¥çš„

è«‹åˆ†æä¸¦è¿”å› JSONï¼š
{{"safety_level": "green|yellow|red", "severity": 1-3, "display_text": "çµ¦å®¶é•·çš„æç¤º"}}
"""

        start = time.time()

        model = GenerativeModel(settings.GEMINI_CHAT_MODEL)
        response = model.generate_content(
            prompt,
            generation_config=GenerationConfig(
                temperature=0.3,
                max_output_tokens=200,
                response_mime_type="application/json",
            ),
        )

        elapsed = time.time() - start
        times.append(elapsed)

        # ç²å– token ä½¿ç”¨é‡
        if hasattr(response, "usage_metadata"):
            usage = response.usage_metadata
            prompt_tokens = getattr(usage, "prompt_token_count", 0)
            total_tokens = getattr(usage, "total_token_count", 0)
            print(f"      è€—æ™‚: {elapsed*1000:.0f} ms ({elapsed:.2f}s)")
            print(f"      Token: prompt={prompt_tokens}, total={total_tokens}")
        else:
            print(f"      è€—æ™‚: {elapsed*1000:.0f} ms ({elapsed:.2f}s)")

        # ç­‰å¾…é¿å… rate limiting
        if i < 2:
            await asyncio.sleep(2)

    avg = sum(times) / len(times)
    print(f"\n   ğŸ“Š å¹³å‡è€—æ™‚: {avg:.2f}s ({avg*1000:.0f} ms)")
    return avg


async def test_with_caching():
    """æ¸¬è©¦ï¼šä½¿ç”¨ Context Caching"""
    print("\n" + "=" * 60)
    print("ğŸ§ª æ¸¬è©¦ 2: ä½¿ç”¨ Context Caching")
    print("=" * 60)

    # åˆå§‹åŒ– Vertex AI
    vertexai.init(project=settings.GEMINI_PROJECT_ID, location=settings.GEMINI_LOCATION)

    # ä¸è®Šçš„ system instruction
    system_instruction = """ä½ æ˜¯å°ˆæ¥­è¦ªå­æ•™é¤Šé¡§å•ï¼Œç²¾é€š 8 å¤§æµæ´¾ï¼š
1. é˜¿å¾·å‹’æ­£å‘æ•™é¤Š - æº«å’Œä¸”å …å®šï¼Œå°Šé‡å­©å­ï¼Œä½¿ç”¨è‡ªç„¶å¾Œæœ
2. è–©æçˆ¾æ¨¡å¼ - å†°å±±ç†è«–ï¼Œæ¢ç´¢æ„Ÿå—ã€è§€é»ã€æœŸå¾…å’Œæ¸´æœ›
3. è¡Œç‚ºåˆ†æå­¸æ´¾ (ABA) - ABC æ¨¡å¼ï¼šå‰å› ã€è¡Œç‚ºã€å¾Œæœ
4. äººéš›ç¥ç¶“ç”Ÿç‰©å­¸ (Dan Siegel) - å…¨è…¦æ•™é¤Šï¼Œä¸Šå±¤è…¦ vs ä¸‹å±¤è…¦
5. æƒ…ç·’è¼”å° (John Gottman) - æƒ…ç·’æ•™ç·´ï¼Œå…ˆè™•ç†æƒ…ç·’å†è™•ç†è¡Œç‚º
6. å”ä½œè§£æ±ºå•é¡Œ (Ross Greene, CPS) - å­©å­æ¬ ç¼ºçš„æ˜¯æŠ€èƒ½ä¸æ˜¯å‹•æ©Ÿ
7. ç¾ä»£ä¾é™„èˆ‡å…§åœ¨è§€é» (Dr. Becky Kennedy) - å…·é«”è©±è¡“ï¼ŒåŒç†é€£çµ
8. ç¤¾æœƒæ„è­˜èˆ‡åƒ¹å€¼è§€æ•™é¤Š - æ€§åˆ¥å¹³æ¬Šã€èº«é«”è‡ªä¸»æ¬Šã€å¤šå…ƒæ–‡åŒ–
"""

    # ä¸è®Šçš„ contextï¼ˆå®Œæ•´å°è©±é€å­—ç¨¿ - æ¨¡æ“¬çœŸå¯¦çš„ 20 åˆ†é˜å°è©±ï¼Œç´„ 2000+ tokensï¼‰
    cached_context = """å®Œæ•´å°è©±é€å­—ç¨¿ï¼š

ã€ç¬¬ 1-5 åˆ†é˜ã€‘
å®¶é•·ï¼šæ¬¸å¯¶è²ï¼Œä½ ä»Šå¤©åœ¨å­¸æ ¡éå¾—æ€éº¼æ¨£ï¼Ÿ
å­©å­ï¼šé‚„å¥½å•Š
å®¶é•·ï¼šæœ‰ä»€éº¼é–‹å¿ƒçš„äº‹å—ï¼Ÿè·ŸåŒå­¸ç©å¾—é–‹å¿ƒå—ï¼Ÿ
å­©å­ï¼šæ²’æœ‰
å®¶é•·ï¼šé‚£æœ‰ä»€éº¼ä¸é–‹å¿ƒçš„äº‹å—ï¼Ÿ
å­©å­ï¼šä¹Ÿæ²’æœ‰
å®¶é•·ï¼šä½ ç¢ºå®šå—ï¼Ÿæ„Ÿè¦ºä½ å¥½åƒæœ‰é»ä¸é–‹å¿ƒï¼Ÿè‡‰è‡­è‡­çš„
å­©å­ï¼šå°±é‚„å¥½å•Šï¼Œæ²’ä»€éº¼ç‰¹åˆ¥çš„
å®¶é•·ï¼šæ˜¯ä¸æ˜¯è·ŸåŒå­¸æœ‰ä»€éº¼äº‹ï¼Ÿå°æ˜ä»Šå¤©æœ‰ä¾†ä¸Šèª²å—ï¼Ÿ
å­©å­ï¼šæ²’æœ‰å•¦ï¼Œä½ å¾ˆç…©è€¶
å®¶é•·ï¼šä»€éº¼å«æˆ‘å¾ˆç…©ï¼Ÿæˆ‘æ˜¯é—œå¿ƒä½ è€¶ï¼
å­©å­ï¼šï¼ˆä¸èªªè©±ï¼‰
å®¶é•·ï¼šæ¬¸ä½ ä¸è¦ä¸ç†æˆ‘ï¼Œåª½åª½å•ä½ è©±ï¼
å­©å­ï¼šæˆ‘ä¸æƒ³èªª
å®¶é•·ï¼šç‚ºä»€éº¼ä¸æƒ³èªªï¼Ÿæ˜¯ä¸æ˜¯åœ¨å­¸æ ¡è¢«æ¬ºè² äº†ï¼Ÿ
å­©å­ï¼šæ²’æœ‰å•¦ï¼å°±æ²’æœ‰ï¼
å®¶é•·ï¼šé‚£åŠŸèª²å¤šå—ï¼Ÿè€å¸«ä»Šå¤©æœ‰å‡ºä½œæ¥­å—ï¼Ÿ
å­©å­ï¼šæœ‰
å®¶é•·ï¼šå‡ºä»€éº¼ï¼Ÿæ•¸å­¸å—ï¼Ÿ
å­©å­ï¼šæ•¸å­¸ã€åœ‹èªã€è‡ªç„¶
å®¶é•·ï¼šå“‡é€™éº¼å¤šï¼é‚£ä½ å¯«å®Œäº†å—ï¼Ÿ
å­©å­ï¼šé‚„æ²’
å®¶é•·ï¼šé‚£ä½ è¦è¶•å¿«å¯«å•Šï¼ä¸è¦ä¸€ç›´ç©æ‰‹æ©Ÿ
å­©å­ï¼šæˆ‘çŸ¥é“å•¦
å®¶é•·ï¼šä½ çŸ¥é“ä»€éº¼ï¼Ÿæ¯æ¬¡éƒ½èªªçŸ¥é“çŸ¥é“ï¼Œçµæœé‚„ä¸æ˜¯æ‹–åˆ°æœ€å¾Œä¸€åˆ»
å­©å­ï¼šï¼ˆæ²‰é»˜ï¼‰
å®¶é•·ï¼šä½ åˆ°åº•æ€éº¼äº†ï¼Ÿå¯ä»¥è·Ÿåª½åª½èªªå—ï¼Ÿ
å­©å­ï¼šæˆ‘åªæ˜¯æœ‰é»ç´¯
å®¶é•·ï¼šç´¯ä»€éº¼ç´¯ï¼Ÿä½ åˆæ²’åšä»€éº¼äº‹ï¼Œä¸€æ•´å¤©ååœ¨æ•™å®¤è£¡èƒ½æœ‰å¤šç´¯ï¼Ÿ
å­©å­ï¼šä½ ä¸æ‡‚å•¦
å®¶é•·ï¼šæˆ‘ä¸æ‡‚ï¼Ÿæˆ‘ä¸æ‡‚ä»€éº¼ï¼Ÿä½ å€’æ˜¯èªªå•Šï¼
å­©å­ï¼šç®—äº†ï¼Œä¸æƒ³è¬›äº†
å®¶é•·ï¼šä¸æƒ³è¬›æ˜¯ä»€éº¼æ„æ€ï¼Ÿä½ é€™å­©å­æ€éº¼é€™éº¼é›£æºé€šï¼Ÿ

ã€ç¬¬ 6-10 åˆ†é˜ã€‘
å®¶é•·ï¼šå¥½å•¦å¥½å•¦ï¼Œåª½åª½ä¸é€¼ä½ äº†ã€‚ä½ å…ˆå»æ´—æ¾¡ï¼Œç­‰ä¸€ä¸‹åƒé£¯
å­©å­ï¼šæˆ‘ä¸æƒ³æ´—
å®¶é•·ï¼šç‚ºä»€éº¼ä¸æƒ³æ´—ï¼Ÿä½ çœ‹ä½ é ­é«®æ²¹æ²¹çš„ï¼Œèº«ä¸Šéƒ½æ˜¯æ±—å‘³
å­©å­ï¼šç­‰ä¸€ä¸‹å†æ´—
å®¶é•·ï¼šç­‰ä¸€ä¸‹åˆèªªç´¯ä¸æƒ³æ´—ï¼Œç¾åœ¨å°±å»æ´—ï¼
å­©å­ï¼šæˆ‘èªªç­‰ä¸€ä¸‹å°±ç­‰ä¸€ä¸‹ï¼ä½ å¾ˆç…©è€¶ï¼
å®¶é•·ï¼šä½ èªªèª°ç…©ï¼Ÿä½ æ€éº¼å¯ä»¥é€™æ¨£è·Ÿåª½åª½è¬›è©±ï¼Ÿ
å­©å­ï¼šæœ¬ä¾†å°±å¾ˆç…©å•Šï¼ä¸€ç›´å”¸ä¸€ç›´å”¸ï¼
å®¶é•·ï¼šæˆ‘å”¸ä½ é‚„ä¸æ˜¯ç‚ºäº†ä½ å¥½ï¼Ÿä½ ä»¥ç‚ºæˆ‘æƒ³å”¸ä½ å•Šï¼Ÿ
å­©å­ï¼šé‚£ä½ ä¸è¦å”¸æˆ‘å•Šï¼
å®¶é•·ï¼šä½ é€™å­©å­çœŸçš„å¾ˆä¸æ‡‚äº‹ï¼çˆ¸çˆ¸åª½åª½é€™éº¼è¾›è‹¦è³ºéŒ¢é¤Šä½ ï¼Œä½ å°±æ˜¯é€™æ¨£å›å ±æˆ‘å€‘çš„ï¼Ÿ
å­©å­ï¼šæˆ‘åˆæ²’æœ‰å«ä½ å€‘ç”Ÿæˆ‘ï¼
å®¶é•·ï¼šä½ ...ä½ èªªä»€éº¼ï¼Ÿä½ å†èªªä¸€éï¼Ÿ
å­©å­ï¼šï¼ˆé–‹å§‹å“­ï¼‰æˆ‘å°±æ˜¯ä¸æƒ³æ´»äº†ï¼
å®¶é•·ï¼šï¼ˆé©šï¼‰ä½ ...ä½ åˆ¥åš‡åª½åª½...ä½ æ€éº¼æœƒé€™æ¨£æƒ³ï¼Ÿ
å­©å­ï¼šï¼ˆå¤§å“­ï¼‰ä½ å€‘éƒ½ä¸æ‡‚æˆ‘ï¼éƒ½åªæœƒç½µæˆ‘ï¼
å®¶é•·ï¼šåª½åª½...åª½åª½æ²’æœ‰è¦ç½µä½ ...åª½åª½åªæ˜¯...
å­©å­ï¼šä½ å°±æ˜¯ä¸€ç›´ç½µï¼ä¸€ç›´ç½µï¼æˆ‘åšä»€éº¼ä½ éƒ½ä¸æ»¿æ„ï¼
å®¶é•·ï¼šï¼ˆæ…Œå¼µï¼‰ä¸æ˜¯é€™æ¨£çš„...å¯¶è²...åª½åª½æ²’æœ‰ä¸æ»¿æ„ä½ ...
å­©å­ï¼šï¼ˆå“­å¾—æ›´å¤§è²ï¼‰ä½ æ¯æ¬¡éƒ½èªªæˆ‘é€™å€‹ä¸å°é‚£å€‹ä¸å°ï¼
å®¶é•·ï¼šåª½åª½...åª½åª½åªæ˜¯å¸Œæœ›ä½ æ›´å¥½...
å­©å­ï¼šæˆ‘ä¸è¦æ›´å¥½ï¼æˆ‘åªæƒ³è¦ä½ å€‘ä¸è¦ä¸€ç›´å”¸æˆ‘ï¼
å®¶é•·ï¼šï¼ˆé–‹å§‹å†·éœï¼‰å¥½...å¥½...åª½åª½çŸ¥é“äº†...åª½åª½ä»¥å¾Œä¸å”¸äº†...
å­©å­ï¼šï¼ˆæŠ½æ³£ï¼‰
å®¶é•·ï¼šä¾†...å…ˆæ·±å‘¼å¸...å¸æ°£...åæ°£...
å­©å­ï¼šï¼ˆç…§åšï¼‰
å®¶é•·ï¼šå¾ˆå¥½...å†ä¸€æ¬¡...å¸æ°£...åæ°£...
å­©å­ï¼šï¼ˆæƒ…ç·’ç¨å¾®ç·©å’Œï¼‰

ã€ç¬¬ 11-15 åˆ†é˜ã€‘
å®¶é•·ï¼šå¯¶è²...å°ä¸èµ·...æ˜¯åª½åª½ä¸å¥½...
å­©å­ï¼šï¼ˆé‚„åœ¨æŠ½æ³£ï¼‰
å®¶é•·ï¼šåª½åª½å‰›æ‰å¤ªæ€¥äº†...ä¸æ‡‰è©²ä¸€ç›´å‚¬ä½ ...
å­©å­ï¼šä½ æ¯æ¬¡éƒ½é€™æ¨£...
å®¶é•·ï¼šåª½åª½çŸ¥é“...åª½åª½æœƒæ”¹...ä½ å¯ä»¥å‘Šè¨´åª½åª½ï¼Œä½ ä»Šå¤©åˆ°åº•ç™¼ç”Ÿä»€éº¼äº‹äº†å—ï¼Ÿ
å­©å­ï¼š...
å®¶é•·ï¼šæ²’é—œä¿‚ï¼Œä½ æ…¢æ…¢èªªï¼Œåª½åª½ä¸æœƒç½µä½ 
å­©å­ï¼š...ä»Šå¤©æ•¸å­¸å°è€ƒ...
å®¶é•·ï¼šå—¯ï¼Ÿç„¶å¾Œå‘¢ï¼Ÿ
å­©å­ï¼šæˆ‘è€ƒå¾—å¾ˆçˆ›...åªæœ‰ 65 åˆ†...
å®¶é•·ï¼šï¼ˆæ·±å‘¼å¸ï¼‰å“¦...æ˜¯é€™æ¨£å•Š...
å­©å­ï¼šè€å¸«èªªè¦çµ¦å®¶é•·ç°½å...æˆ‘ä¸æ•¢æ‹¿çµ¦ä½ ...
å®¶é•·ï¼šæ‰€ä»¥ä½ ä¸€ç›´æ‚¶æ‚¶ä¸æ¨‚æ˜¯å› ç‚ºé€™å€‹ï¼Ÿ
å­©å­ï¼šï¼ˆé»é ­ï¼‰å°ä¸èµ·...
å®¶é•·ï¼šå¯¶è²...ä½ ä¸ç”¨èªªå°ä¸èµ·...
å­©å­ï¼šå¯æ˜¯æˆ‘è€ƒå¾—å¾ˆçˆ›...
å®¶é•·ï¼šä¸€æ¬¡æ²’è€ƒå¥½æ²’é—œä¿‚å•Šï¼Œä¸‹æ¬¡å†åŠªåŠ›å°±å¥½äº†
å­©å­ï¼šçœŸçš„å—ï¼Ÿä½ ä¸æœƒç½µæˆ‘ï¼Ÿ
å®¶é•·ï¼šï¼ˆç¬‘ï¼‰åª½åª½å‰›æ‰å·²ç¶“ç½µå¤ªå¤šäº†ï¼Œä¸èƒ½å†ç½µäº†
å­©å­ï¼šï¼ˆä¹Ÿç¬‘äº†ä¸€ä¸‹ï¼‰
å®¶é•·ï¼šä½ çœ‹ï¼Œä½ çµ‚æ–¼ç¬‘äº†ï¼
å­©å­ï¼šåª½...
å®¶é•·ï¼šæ€éº¼äº†ï¼Ÿ
å­©å­ï¼šæˆ‘è¦ºå¾—æ•¸å­¸å¾ˆé›£...æˆ‘éƒ½è½ä¸æ‡‚...
å®¶é•·ï¼šå“ªå€‹éƒ¨åˆ†è½ä¸æ‡‚ï¼Ÿ
å­©å­ï¼šåˆ†æ•¸çš„åŠ æ¸›æ³•...æˆ‘ä¸€ç›´ç®—éŒ¯...
å®¶é•·ï¼šé€™æ¨£å•Š...é‚£è¦ä¸è¦åª½åª½æ•™ä½ ï¼Ÿæˆ–æ˜¯æˆ‘å€‘æ‰¾è€å¸«å¹«å¿™ï¼Ÿ
å­©å­ï¼šå¯ä»¥å—ï¼Ÿ
å®¶é•·ï¼šç•¶ç„¶å¯ä»¥ï¼åª½åª½å°±æ˜¯å¸Œæœ›å¯ä»¥å¹«åˆ°ä½ å•Š
å­©å­ï¼šè¬è¬åª½...
å®¶é•·ï¼šä¸å®¢æ°£ã€‚ä»¥å¾Œæœ‰ä»€éº¼äº‹éƒ½å¯ä»¥è·Ÿåª½åª½èªªï¼Œä¸è¦è‡ªå·±æ†‹è‘—ï¼Œå¥½å—ï¼Ÿ
å­©å­ï¼šå¥½...

ã€ç¬¬ 16-20 åˆ†é˜ã€‘
å®¶é•·ï¼šé‚£ç¾åœ¨æ„Ÿè¦ºå¥½ä¸€é»äº†å—ï¼Ÿ
å­©å­ï¼šå—¯ï¼Œå¥½å¤šäº†
å®¶é•·ï¼šé‚£æˆ‘å€‘ä¸€èµ·ä¾†çœ‹çœ‹é€™æ¬¡çš„è€ƒå·ï¼Œçœ‹çœ‹å“ªè£¡ä¸æœƒï¼Ÿ
å­©å­ï¼šå¥½
å®¶é•·ï¼šï¼ˆçœ‹è€ƒå·ï¼‰å“¦æˆ‘çœ‹åˆ°äº†ï¼Œé€™é¡Œæ˜¯é€šåˆ†çš„éƒ¨åˆ†å°ä¸å°ï¼Ÿ
å­©å­ï¼šå°ï¼Œæˆ‘ä¸çŸ¥é“æ€éº¼é€šåˆ†
å®¶é•·ï¼šä¾†ï¼Œåª½åª½æ•™ä½ ä¸€å€‹æ–¹æ³•ã€‚ä½ çœ‹ï¼Œ1/2 å’Œ 1/3 è¦ç›¸åŠ ï¼Œé¦–å…ˆè¦æ‰¾å…¬åˆ†æ¯
å­©å­ï¼šä»€éº¼æ˜¯å…¬åˆ†æ¯ï¼Ÿ
å®¶é•·ï¼šå°±æ˜¯å…©å€‹åˆ†æ¯éƒ½å¯ä»¥æ•´é™¤çš„æ•¸å­—ã€‚2 å’Œ 3 çš„å…¬åˆ†æ¯æ˜¯å¤šå°‘ï¼Ÿ
å­©å­ï¼šå—¯...6ï¼Ÿ
å®¶é•·ï¼šå°ï¼å¾ˆè°æ˜ï¼é‚£ 1/2 ç­‰æ–¼å¹¾åˆ†ä¹‹å¹¾ï¼Ÿ
å­©å­ï¼šç­‰æ–¼...3/6ï¼Ÿ
å®¶é•·ï¼šç­”å°äº†ï¼é‚£ 1/3 å‘¢ï¼Ÿ
å­©å­ï¼š2/6ï¼
å®¶é•·ï¼šå¾ˆå¥½ï¼é‚£ 3/6 åŠ  2/6 ç­‰æ–¼ï¼Ÿ
å­©å­ï¼š5/6ï¼
å®¶é•·ï¼šä½ çœ‹ï¼Œä½ å…¶å¯¦æœƒçš„å˜›ï¼
å­©å­ï¼šåŸä¾†é€™éº¼ç°¡å–®ï¼
å®¶é•·ï¼šå°å•Šï¼Œåªè¦ç†è§£æ–¹æ³•å°±ä¸é›£äº†ã€‚ä½ è¦ä¸è¦å†è©¦è©¦çœ‹ä¸‹ä¸€é¡Œï¼Ÿ
å­©å­ï¼šå¥½ï¼ï¼ˆé–‹å§‹å¯«ï¼‰
å®¶é•·ï¼šï¼ˆç­‰å¾…ï¼‰
å­©å­ï¼šåª½ï¼Œé€™æ¨£å°å—ï¼Ÿ
å®¶é•·ï¼šï¼ˆçœ‹ï¼‰å°çš„ï¼ä½ çœ‹ï¼Œä½ å®Œå…¨å¯ä»¥çš„ï¼
å­©å­ï¼šï¼ˆé–‹å¿ƒï¼‰å¤ªå¥½äº†ï¼
å®¶é•·ï¼šæ‰€ä»¥ä½ çœ‹ï¼Œæ²’è€ƒå¥½ä¸ä»£è¡¨ä½ ä¸è¡Œï¼Œåªæ˜¯éœ€è¦å¤šç·´ç¿’è€Œå·²
å­©å­ï¼šæˆ‘çŸ¥é“äº†ï¼
å®¶é•·ï¼šå¾ˆå¥½ã€‚é‚£ä½ ä»Šå¤©é‚„æœ‰å…¶ä»–ä½œæ¥­å—ï¼Ÿ
å­©å­ï¼šé‚„æœ‰åœ‹èªç”Ÿå­—å’Œè‡ªç„¶ä½œæ¥­
å®¶é•·ï¼šå—¯ï¼Œé‚£ä½ å…ˆå»æ´—æ¾¡ï¼Œæ´—å®Œæ¾¡æˆ‘å€‘ä¸€èµ·åƒé£¯ï¼Œåƒå®Œé£¯å†å¯«ä½œæ¥­ï¼Œå¥½å—ï¼Ÿ
å­©å­ï¼šå¥½ï¼ï¼ˆè·‘å»æµ´å®¤ï¼‰
å®¶é•·ï¼šï¼ˆé¬†äº†ä¸€å£æ°£ï¼‰
"""

    times = []
    cache_obj = None

    for i in range(3):
        print(f"\n   ğŸ”„ ç¬¬ {i+1} æ¬¡è«‹æ±‚:")

        start = time.time()

        if i == 0:
            # ç¬¬ä¸€æ¬¡ï¼šå»ºç«‹ç·©å­˜
            print("      å»ºç«‹ç·©å­˜...")
            try:
                cache_obj = caching.CachedContent.create(
                    model_name=settings.GEMINI_CHAT_MODEL,
                    system_instruction=system_instruction,
                    contents=[cached_context],
                    ttl=timedelta(minutes=60),
                    display_name="parenting_context_cache",
                )
                print("      âœ… ç·©å­˜å»ºç«‹æˆåŠŸ")
                print(f"         Name: {cache_obj.name}")
                print(f"         Expire: {cache_obj.expire_time}")
            except Exception as e:
                print(f"      âŒ ç·©å­˜å»ºç«‹å¤±æ•—: {e}")
                import traceback

                traceback.print_exc()
                return None
        else:
            # ç¬¬ 2-3 æ¬¡ï¼šä½¿ç”¨ç·©å­˜
            print(f"      ä½¿ç”¨ç·©å­˜: {cache_obj.display_name}")

        # ä½¿ç”¨ç·©å­˜çš„æ¨¡å‹
        try:
            model = GenerativeModel.from_cached_content(cache_obj)
        except Exception as e:
            print(f"      âŒ ç„¡æ³•å»ºç«‹æ¨¡å‹: {e}")
            return None

        # åªéœ€è¦å‚³æ–°çš„å°è©±ç‰‡æ®µ
        prompt = """æœ€è¿‘å°è©±ï¼ˆç”¨æ–¼åˆ†æï¼‰ï¼š
å®¶é•·ï¼šä½ ç¢ºå®šå—ï¼Ÿæ„Ÿè¦ºä½ å¥½åƒæœ‰é»ä¸é–‹å¿ƒï¼Ÿ
å­©å­ï¼šå°±é‚„å¥½å•Šï¼Œæ²’ä»€éº¼ç‰¹åˆ¥çš„

è«‹åˆ†æä¸¦è¿”å› JSONï¼š
{"safety_level": "green|yellow|red", "severity": 1-3, "display_text": "çµ¦å®¶é•·çš„æç¤º"}
"""

        try:
            response = model.generate_content(
                prompt,
                generation_config=GenerationConfig(
                    temperature=0.3,
                    max_output_tokens=200,
                    response_mime_type="application/json",
                ),
            )

            elapsed = time.time() - start
            times.append(elapsed)

            # é¡¯ç¤º token ä½¿ç”¨é‡
            if hasattr(response, "usage_metadata"):
                usage = response.usage_metadata
                cached_tokens = getattr(usage, "cached_content_token_count", 0)
                prompt_tokens = getattr(usage, "prompt_token_count", 0)
                total_tokens = getattr(usage, "total_token_count", 0)
                print(f"      è€—æ™‚: {elapsed*1000:.0f} ms ({elapsed:.2f}s)")
                print(
                    f"      Token: prompt={prompt_tokens}, cached={cached_tokens}, total={total_tokens}"
                )
            else:
                print(f"      è€—æ™‚: {elapsed*1000:.0f} ms ({elapsed:.2f}s)")

        except Exception as e:
            print(f"      âŒ è«‹æ±‚å¤±æ•—: {e}")
            import traceback

            traceback.print_exc()
            return None

        # ç­‰å¾…é¿å… rate limiting
        if i < 2:
            await asyncio.sleep(2)

    # æ¸…ç†ç·©å­˜
    if cache_obj:
        try:
            cache_obj.delete()
            print("\n   ğŸ—‘ï¸  ç·©å­˜å·²åˆªé™¤")
        except Exception as e:
            print(f"\n   âš ï¸  ç·©å­˜åˆªé™¤å¤±æ•—: {e}")

    avg = sum(times) / len(times)
    first_call = times[0]
    subsequent_avg = sum(times[1:]) / len(times[1:]) if len(times) > 1 else times[0]

    print(f"\n   ğŸ“Š ç¬¬ä¸€æ¬¡ï¼ˆå»ºç«‹ç·©å­˜ï¼‰: {first_call:.2f}s ({first_call*1000:.0f} ms)")
    print(
        f"   ğŸ“Š å¾ŒçºŒå¹³å‡ï¼ˆä½¿ç”¨ç·©å­˜ï¼‰: {subsequent_avg:.2f}s ({subsequent_avg*1000:.0f} ms)"
    )
    print(f"   ğŸ“Š ç¸½å¹³å‡: {avg:.2f}s ({avg*1000:.0f} ms)")

    return {"first": first_call, "subsequent": subsequent_avg, "average": avg}


async def main():
    """ä¸»æ¸¬è©¦æµç¨‹"""

    print("=" * 60)
    # Get actual model from settings
    model_name = settings.GEMINI_CHAT_MODEL
    print("ğŸš€ Vertex AI Context Caching çœŸå¯¦æ¸¬è©¦")
    print(f"   Model: {model_name}")
    print("=" * 60)
    print()
    print("ç›®çš„ï¼šé©—è­‰ Context Caching æ˜¯å¦çœŸçš„èƒ½çœ 50% æ™‚é–“")
    print()

    # æ¸¬è©¦ 1: æ²’æœ‰ cachingï¼ˆåŸºæº–ç·šï¼‰
    baseline = await test_without_caching()

    # æ¸¬è©¦ 2: ä½¿ç”¨ caching
    caching_result = await test_with_caching()

    # æ¯”è¼ƒçµæœ
    if baseline and caching_result:
        print("\n" + "=" * 60)
        print("ğŸ“Š æ¸¬è©¦çµæœæ¯”è¼ƒ")
        print("=" * 60)
        print()

        print("æ²’æœ‰ Cachingï¼ˆåŸºæº–ç·šï¼‰:")
        print(f"   å¹³å‡è€—æ™‚: {baseline:.2f}s ({baseline*1000:.0f} ms)")
        print()

        print("ä½¿ç”¨ Caching:")
        print(
            f"   ç¬¬ä¸€æ¬¡ï¼ˆå»ºç«‹ç·©å­˜ï¼‰: {caching_result['first']:.2f}s ({caching_result['first']*1000:.0f} ms)"
        )
        print(
            f"   å¾ŒçºŒè«‹æ±‚ï¼ˆä½¿ç”¨ç·©å­˜ï¼‰: {caching_result['subsequent']:.2f}s ({caching_result['subsequent']*1000:.0f} ms)"
        )
        print()

        # è¨ˆç®—ç¯€çœç™¾åˆ†æ¯”
        savings = (baseline - caching_result["subsequent"]) / baseline * 100
        speedup = baseline / caching_result["subsequent"]

        print("ğŸ¯ é—œéµçµè«–:")
        print(f"   åŸºæº–ç·š: {baseline:.2f}s")
        print(f"   ä½¿ç”¨ç·©å­˜: {caching_result['subsequent']:.2f}s")
        print(f"   ç¯€çœæ™‚é–“: {baseline - caching_result['subsequent']:.2f}s")
        print(f"   ç¯€çœæ¯”ä¾‹: {savings:.1f}%")
        print(f"   åŠ é€Ÿå€æ•¸: {speedup:.2f}x")
        print()

        # åˆ¤æ–·æ˜¯å¦é”åˆ°é æœŸ
        if savings >= 40:
            print(f"âœ… é©—è­‰æˆåŠŸï¼Context Caching ç¢ºå¯¦èƒ½çœ {savings:.0f}% æ™‚é–“ï¼")
        elif savings >= 20:
            print(f"ğŸŸ¡ éƒ¨åˆ†æœ‰æ•ˆï¼šçœäº† {savings:.1f}%ï¼Œä½†æ²’é”åˆ° 50% ç›®æ¨™")
        else:
            print(f"âŒ æ•ˆæœä¸ä½³ï¼šåªçœäº† {savings:.1f}%ï¼Œå¯èƒ½ä¸å€¼å¾—å¯¦ä½œ")

        # å¯¦éš›æ‡‰ç”¨å ´æ™¯ä¼°ç®—
        print()
        print("ğŸ’¡ å¯¦éš›æ‡‰ç”¨å ´æ™¯ä¼°ç®—ï¼ˆ1 å°æ™‚æœƒè«‡ï¼Œ60 æ¬¡åˆ†æï¼‰:")
        print(
            f"   ç•¶å‰ï¼ˆç„¡ç·©å­˜ï¼‰: {baseline:.2f}s Ã— 60 æ¬¡ = {baseline*60:.0f}s ({baseline*60/60:.1f} åˆ†é˜)"
        )
        print("   å„ªåŒ–å¾Œï¼ˆæœ‰ç·©å­˜ï¼‰:")
        print(f"      ç¬¬ 1 æ¬¡: {caching_result['first']:.2f}s")
        print(
            f"      ç¬¬ 2-60 æ¬¡: {caching_result['subsequent']:.2f}s Ã— 59 = {caching_result['subsequent']*59:.0f}s"
        )
        total_with_cache = caching_result["first"] + caching_result["subsequent"] * 59
        print(f"      ç¸½è¨ˆ: {total_with_cache:.0f}s ({total_with_cache/60:.1f} åˆ†é˜)")
        saved_time = baseline * 60 - total_with_cache
        print(
            f"   ç¯€çœ: {saved_time:.0f}s ({saved_time/60:.1f} åˆ†é˜ï¼Œ{saved_time/(baseline*60)*100:.0f}%)"
        )


if __name__ == "__main__":
    asyncio.run(main())
